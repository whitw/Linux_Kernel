cscope 15 $HOME/Î∞îÌÉïÌôîÎ©¥/Linux_Kernel/pxt4               0001336946
	@acl.c

8 
	~<löux/quŸa›s.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4.h
"

11 
	~"x©å.h
"

12 
	~"a˛.h
"

17 
posix_a˛
 *

18 
	$pxt4_a˛_‰om_disk
(c⁄° *
vÆue
, 
size_t
 
size
)

20 c⁄° *
íd
 = (*)
vÆue
 + 
size
;

21 
n
, 
cou¡
;

22 
posix_a˛
 *
a˛
;

24 i‡(!
vÆue
)

25  
NULL
;

26 i‡(
size
 < (
pxt4_a˛_hódî
))

27  
	`ERR_PTR
(-
EINVAL
);

28 i‡(((
pxt4_a˛_hódî
 *)
vÆue
)->
a_vîsi⁄
 !=

29 
	`˝u_to_À32
(
PXT4_ACL_VERSION
))

30  
	`ERR_PTR
(-
EINVAL
);

31 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_hódî
);

32 
cou¡
 = 
	`pxt4_a˛_cou¡
(
size
);

33 i‡(
cou¡
 < 0)

34  
	`ERR_PTR
(-
EINVAL
);

35 i‡(
cou¡
 == 0)

36  
NULL
;

37 
a˛
 = 
	`posix_a˛_Æloc
(
cou¡
, 
GFP_NOFS
);

38 i‡(!
a˛
)

39  
	`ERR_PTR
(-
ENOMEM
);

40 
n
 = 0;Ç < 
cou¡
;Ç++) {

41 
pxt4_a˛_íåy
 *
íåy
 =

42 (
pxt4_a˛_íåy
 *)
vÆue
;

43 i‡((*)
vÆue
 + (
pxt4_a˛_íåy_sh‹t
Ë> 
íd
)

44 
Áû
;

45 
a˛
->
a_íåõs
[
n
].
e_èg
 = 
	`À16_to_˝u
(
íåy
->e_tag);

46 
a˛
->
a_íåõs
[
n
].
e_≥rm
 = 
	`À16_to_˝u
(
íåy
->e_perm);

48 
a˛
->
a_íåõs
[
n
].
e_èg
) {

49 
ACL_USER_OBJ
:

50 
ACL_GROUP_OBJ
:

51 
ACL_MASK
:

52 
ACL_OTHER
:

53 
vÆue
 = (*)value +

54 (
pxt4_a˛_íåy_sh‹t
);

57 
ACL_USER
:

58 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

59 i‡((*)
vÆue
 > 
íd
)

60 
Áû
;

61 
a˛
->
a_íåõs
[
n
].
e_uid
 =

62 
	`make_kuid
(&
öô_u£r_ns
,

63 
	`À32_to_˝u
(
íåy
->
e_id
));

65 
ACL_GROUP
:

66 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

67 i‡((*)
vÆue
 > 
íd
)

68 
Áû
;

69 
a˛
->
a_íåõs
[
n
].
e_gid
 =

70 
	`make_kgid
(&
öô_u£r_ns
,

71 
	`À32_to_˝u
(
íåy
->
e_id
));

75 
Áû
;

78 i‡(
vÆue
 !
íd
)

79 
Áû
;

80  
a˛
;

82 
Áû
:

83 
	`posix_a˛_ªÀa£
(
a˛
);

84  
	`ERR_PTR
(-
EINVAL
);

85 
	}
}

91 
	$pxt4_a˛_to_disk
(c⁄° 
posix_a˛
 *
a˛
, 
size_t
 *
size
)

93 
pxt4_a˛_hódî
 *
ext_a˛
;

94 *
e
;

95 
size_t
 
n
;

97 *
size
 = 
	`pxt4_a˛_size
(
a˛
->
a_cou¡
);

98 
ext_a˛
 = 
	`kmÆloc
((
pxt4_a˛_hódî
Ë+ 
a˛
->
a_cou¡
 *

99 (
pxt4_a˛_íåy
), 
GFP_NOFS
);

100 i‡(!
ext_a˛
)

101  
	`ERR_PTR
(-
ENOMEM
);

102 
ext_a˛
->
a_vîsi⁄
 = 
	`˝u_to_À32
(
PXT4_ACL_VERSION
);

103 
e
 = (*)
ext_a˛
 + (
pxt4_a˛_hódî
);

104 
n
 = 0;Ç < 
a˛
->
a_cou¡
;Ç++) {

105 c⁄° 
posix_a˛_íåy
 *
a˛_e
 = &
a˛
->
a_íåõs
[
n
];

106 
pxt4_a˛_íåy
 *
íåy
 = (pxt4_a˛_íåy *)
e
;

107 
íåy
->
e_èg
 = 
	`˝u_to_À16
(
a˛_e
->e_tag);

108 
íåy
->
e_≥rm
 = 
	`˝u_to_À16
(
a˛_e
->e_perm);

109 
a˛_e
->
e_èg
) {

110 
ACL_USER
:

111 
íåy
->
e_id
 = 
	`˝u_to_À32
(

112 
	`‰om_kuid
(&
öô_u£r_ns
, 
a˛_e
->
e_uid
));

113 
e
 +(
pxt4_a˛_íåy
);

115 
ACL_GROUP
:

116 
íåy
->
e_id
 = 
	`˝u_to_À32
(

117 
	`‰om_kgid
(&
öô_u£r_ns
, 
a˛_e
->
e_gid
));

118 
e
 +(
pxt4_a˛_íåy
);

121 
ACL_USER_OBJ
:

122 
ACL_GROUP_OBJ
:

123 
ACL_MASK
:

124 
ACL_OTHER
:

125 
e
 +(
pxt4_a˛_íåy_sh‹t
);

129 
Áû
;

132  (*)
ext_a˛
;

134 
Áû
:

135 
	`k‰ì
(
ext_a˛
);

136  
	`ERR_PTR
(-
EINVAL
);

137 
	}
}

144 
posix_a˛
 *

145 
	$pxt4_gë_a˛
(
öode
 *öode, 
ty≥
)

147 
«me_ödex
;

148 *
vÆue
 = 
NULL
;

149 
posix_a˛
 *
a˛
;

150 
ªtvÆ
;

152 
ty≥
) {

153 
ACL_TYPE_ACCESS
:

154 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

156 
ACL_TYPE_DEFAULT
:

157 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

160 
	`BUG
();

162 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
NULL
, 0);

163 i‡(
ªtvÆ
 > 0) {

164 
vÆue
 = 
	`kmÆloc
(
ªtvÆ
, 
GFP_NOFS
);

165 i‡(!
vÆue
)

166  
	`ERR_PTR
(-
ENOMEM
);

167 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
vÆue
,Ñetval);

169 i‡(
ªtvÆ
 > 0)

170 
a˛
 = 
	`pxt4_a˛_‰om_disk
(
vÆue
, 
ªtvÆ
);

171 i‡(
ªtvÆ
 =-
ENODATA
 ||ÑëvÆ =-
ENOSYS
)

172 
a˛
 = 
NULL
;

174 
a˛
 = 
	`ERR_PTR
(
ªtvÆ
);

175 
	`k‰ì
(
vÆue
);

177  
a˛
;

178 
	}
}

186 
	$__pxt4_£t_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
ty≥
,

187 
posix_a˛
 *
a˛
, 
x©å_Êags
)

189 
«me_ödex
;

190 *
vÆue
 = 
NULL
;

191 
size_t
 
size
 = 0;

192 
îr‹
;

194 
ty≥
) {

195 
ACL_TYPE_ACCESS
:

196 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

199 
ACL_TYPE_DEFAULT
:

200 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

201 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

202  
a˛
 ? -
EACCES
 : 0;

206  -
EINVAL
;

208 i‡(
a˛
) {

209 
vÆue
 = 
	`pxt4_a˛_to_disk
(
a˛
, &
size
);

210 i‡(
	`IS_ERR
(
vÆue
))

211  ()
	`PTR_ERR
(
vÆue
);

214 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, "",

215 
vÆue
, 
size
, 
x©å_Êags
);

217 
	`k‰ì
(
vÆue
);

218 i‡(!
îr‹
) {

219 
	`£t_ˇched_a˛
(
öode
, 
ty≥
, 
a˛
);

222  
îr‹
;

223 
	}
}

226 
	$pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
)

228 
h™dÀ_t
 *
h™dÀ
;

229 
îr‹
, 
¸edôs
, 
ªåõs
 = 0;

230 
size_t
 
a˛_size
 = 
a˛
 ? 
	`pxt4_a˛_size
◊˛->
a_cou¡
) : 0;

231 
umode_t
 
mode
 = 
öode
->
i_mode
;

232 
upd©e_mode
 = 0;

234 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

235 i‡(
îr‹
)

236  
îr‹
;

237 
ªåy
:

238 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
a˛_size
, 
Ál£
 ,

239 &
¸edôs
);

240 i‡(
îr‹
)

241  
îr‹
;

243 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

244 i‡(
	`IS_ERR
(
h™dÀ
))

245  
	`PTR_ERR
(
h™dÀ
);

247 i‡((
ty≥
 =
ACL_TYPE_ACCESS
Ë&& 
a˛
) {

248 
îr‹
 = 
	`posix_a˛_upd©e_mode
(
öode
, &
mode
, &
a˛
);

249 i‡(
îr‹
)

250 
out_°›
;

251 i‡(
mode
 !
öode
->
i_mode
)

252 
upd©e_mode
 = 1;

255 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ty≥
, 
a˛
, 0 );

256 i‡(!
îr‹
 && 
upd©e_mode
) {

257 
öode
->
i_mode
 = 
mode
;

258 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

259 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

261 
out_°›
:

262 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

263 i‡(
îr‹
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

264 
ªåy
;

265  
îr‹
;

266 
	}
}

275 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

277 
posix_a˛
 *
deÁu…_a˛
, *
a˛
;

278 
îr‹
;

280 
îr‹
 = 
	`posix_a˛_¸óã
(
dú
, &
öode
->
i_mode
, &
deÁu…_a˛
, &
a˛
);

281 i‡(
îr‹
)

282  
îr‹
;

284 i‡(
deÁu…_a˛
) {

285 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_DEFAULT
,

286 
deÁu…_a˛
, 
XATTR_CREATE
);

287 
	`posix_a˛_ªÀa£
(
deÁu…_a˛
);

289 
öode
->
i_deÁu…_a˛
 = 
NULL
;

291 i‡(
a˛
) {

292 i‡(!
îr‹
)

293 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_ACCESS
,

294 
a˛
, 
XATTR_CREATE
);

295 
	`posix_a˛_ªÀa£
(
a˛
);

297 
öode
->
i_a˛
 = 
NULL
;

299  
îr‹
;

300 
	}
}

	@acl.h

8 
	~<löux/posix_a˛_x©å.h
>

10 
	#PXT4_ACL_VERSION
 0x0001

	)

13 
__À16
 
	me_èg
;

14 
__À16
 
	me_≥rm
;

15 
__À32
 
	me_id
;

16 } 
	tpxt4_a˛_íåy
;

19 
__À16
 
	me_èg
;

20 
__À16
 
	me_≥rm
;

21 } 
	tpxt4_a˛_íåy_sh‹t
;

24 
__À32
 
	ma_vîsi⁄
;

25 } 
	tpxt4_a˛_hódî
;

27 
ölöe
 
size_t
 
	$pxt4_a˛_size
(
cou¡
)

29 i‡(
cou¡
 <= 4) {

30  (
pxt4_a˛_hódî
) +

31 
cou¡
 * (
pxt4_a˛_íåy_sh‹t
);

33  (
pxt4_a˛_hódî
) +

34 4 * (
pxt4_a˛_íåy_sh‹t
) +

35 (
cou¡
 - 4Ë* (
pxt4_a˛_íåy
);

37 
	}
}

39 
ölöe
 
	$pxt4_a˛_cou¡
(
size_t
 
size
)

41 
ssize_t
 
s
;

42 
size
 -(
pxt4_a˛_hódî
);

43 
s
 = 
size
 - 4 * (
pxt4_a˛_íåy_sh‹t
);

44 i‡(
s
 < 0) {

45 i‡(
size
 % (
pxt4_a˛_íåy_sh‹t
))

47  
size
 / (
pxt4_a˛_íåy_sh‹t
);

49 i‡(
s
 % (
pxt4_a˛_íåy
))

51  
s
 / (
pxt4_a˛_íåy
) + 4;

53 
	}
}

55 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


58 
posix_a˛
 *
pxt4_gë_a˛
(
öode
 *öode, 
ty≥
);

59 
pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
);

60 
pxt4_öô_a˛
(
h™dÀ_t
 *, 
öode
 *, inode *);

63 
	~<löux/sched.h
>

64 
	#pxt4_gë_a˛
 
NULL


	)

65 
	#pxt4_£t_a˛
 
NULL


	)

67 
ölöe
 

68 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

71 
	}
}

	@balloc.c

15 
	~<löux/time.h
>

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/quŸa›s.h
>

19 
	~<löux/buf„r_hód.h
>

20 
	~"pxt4.h
"

21 
	~"pxt4_jbd3.h
"

22 
	~"mbÆloc.h
"

24 
	~<åa˚/evíts/pxt4.h
>

26 
pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

27 
pxt4_group_t
 
block_group
);

35 
pxt4_group_t
 
	$pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

36 
pxt4_fsblk_t
 
block
)

38 
pxt4_group_t
 
group
;

40 i‡(
	`ã°_›t2
(
sb
, 
STD_GROUP_SIZE
))

41 
group
 = (
block
 -

42 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) >>

43 (
	`PXT4_BLOCK_SIZE_BITS
(
sb
Ë+ 
	`PXT4_CLUSTER_BITS
(sb) + 3);

45 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
group
, 
NULL
);

46  
group
;

47 
	}
}

53 
	$pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
blockƒ
,

54 
pxt4_group_t
 *
blockgΩp
, 
pxt4_gΩblk_t
 *
off£ç
)

56 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

57 
pxt4_gΩblk_t
 
off£t
;

59 
blockƒ
 = blockƒ - 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

60 
off£t
 = 
	`do_div
(
blockƒ
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) >>

61 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

62 i‡(
off£ç
)

63 *
off£ç
 = 
off£t
;

64 i‡(
blockgΩp
)

65 *
blockgΩp
 = 
blockƒ
;

67 
	}
}

73 
ölöe
 
	$pxt4_block_ö_group
(
su≥r_block
 *
sb
,

74 
pxt4_fsblk_t
 
block
,

75 
pxt4_group_t
 
block_group
)

77 
pxt4_group_t
 
a˘uÆ_group
;

79 
a˘uÆ_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
block
);

80  (
a˘uÆ_group
 =
block_group
) ? 1 : 0;

81 
	}
}

86 
	$pxt4_num_ovîhód_˛u°îs
(
su≥r_block
 *
sb
,

87 
pxt4_group_t
 
block_group
,

88 
pxt4_group_desc
 *
gdp
)

90 
num_˛u°îs
;

91 
block_˛u°î
 = -1, 
öode_˛u°î
 = -1, 
ôbl_˛u°î
 = -1, 
i
, 
c
;

92 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

93 
pxt4_fsblk_t
 
ôbl_blk
;

94 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

99 
num_˛u°îs
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

113 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_block_bôm≠
(sb, 
gdp
), 
block_group
)) {

114 
block_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

115 
	`pxt4_block_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

116 i‡(
block_˛u°î
 < 
num_˛u°îs
)

117 
block_˛u°î
 = -1;

118 i‡(
block_˛u°î
 =
num_˛u°îs
) {

119 
num_˛u°îs
++;

120 
block_˛u°î
 = -1;

124 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
), 
block_group
)) {

125 
öode_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

126 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

127 i‡(
öode_˛u°î
 < 
num_˛u°îs
)

128 
öode_˛u°î
 = -1;

129 i‡(
öode_˛u°î
 =
num_˛u°îs
) {

130 
num_˛u°îs
++;

131 
öode_˛u°î
 = -1;

135 
ôbl_blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

136 
i
 = 0; i < 
sbi
->
s_ôb_≥r_group
; i++) {

137 i‡(
	`pxt4_block_ö_group
(
sb
, 
ôbl_blk
 + 
i
, 
block_group
)) {

138 
c
 = 
	`PXT4_B2C
(
sbi
, 
ôbl_blk
 + 
i
 - 
°¨t
);

139 i‡((
c
 < 
num_˛u°îs
Ë|| (¯=
öode_˛u°î
) ||

140 (
c
 =
block_˛u°î
Ë|| (¯=
ôbl_˛u°î
))

142 i‡(
c
 =
num_˛u°îs
) {

143 
num_˛u°îs
++;

146 
num_˛u°îs
++;

147 
ôbl_˛u°î
 = 
c
;

151 i‡(
block_˛u°î
 != -1)

152 
num_˛u°îs
++;

153 i‡(
öode_˛u°î
 != -1)

154 
num_˛u°îs
++;

156  
num_˛u°îs
;

157 
	}
}

159 
	$num_˛u°îs_ö_group
(
su≥r_block
 *
sb
,

160 
pxt4_group_t
 
block_group
)

162 
blocks
;

164 i‡(
block_group
 =
	`pxt4_gë_groups_cou¡
(
sb
) - 1) {

171 
blocks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
) -

172 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

174 
blocks
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

175  
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
blocks
);

176 
	}
}

179 
	$pxt4_öô_block_bôm≠
(
su≥r_block
 *
sb
,

180 
buf„r_hód
 *
bh
,

181 
pxt4_group_t
 
block_group
,

182 
pxt4_group_desc
 *
gdp
)

184 
bô
, 
bô_max
;

185 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

186 
pxt4_fsblk_t
 
°¨t
, 
tmp
;

188 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_locked
(bh));

192 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
block_group
, 
gdp
)) {

193 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

194 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
 |

195 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

196  -
EFSBADCRC
;

198 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

200 
bô_max
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

201 i‡((
bô_max
 >> 3Ë>
bh
->
b_size
)

202  -
EFSCORRUPTED
;

204 
bô
 = 0; bô < 
bô_max
; bit++)

205 
	`pxt4_£t_bô
(
bô
, 
bh
->
b_d©a
);

207 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

210 
tmp
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

211 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

212 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

214 
tmp
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

215 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

216 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

218 
tmp
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

219 ; 
tmp
 < 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
) +

220 
sbi
->
s_ôb_≥r_group
; 
tmp
++) {

221 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

222 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

230 
	`pxt4_m¨k_bôm≠_íd
(
	`num_˛u°îs_ö_group
(
sb
, 
block_group
),

231 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

233 
	}
}

238 
	$pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

239 
pxt4_group_t
 
block_group
,

240 
pxt4_group_desc
 *
gdp
)

242  
	`num_˛u°îs_ö_group
(
sb
, 
block_group
) -

243 
	`pxt4_num_ovîhód_˛u°îs
(
sb
, 
block_group
, 
gdp
);

244 
	}
}

264 
pxt4_group_desc
 * 
	$pxt4_gë_group_desc
(
su≥r_block
 *
sb
,

265 
pxt4_group_t
 
block_group
,

266 
buf„r_hód
 **
bh
)

268 
group_desc
;

269 
off£t
;

270 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

271 
pxt4_group_desc
 *
desc
;

272 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

273 
buf„r_hód
 *
bh_p
;

275 i‡(
block_group
 >
ngroups
) {

276 
	`pxt4_îr‹
(
sb
, "block_group >= groups_count - block_group = %u,"

277 " groups_cou¡ = %u", 
block_group
, 
ngroups
);

279  
NULL
;

282 
group_desc
 = 
block_group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

283 
off£t
 = 
block_group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

284 
bh_p
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
, 
group_desc
);

291 i‡(!
bh_p
) {

292 
	`pxt4_îr‹
(
sb
, "Group descriptorÇotÜoaded - "

294 
block_group
, 
group_desc
, 
off£t
);

295  
NULL
;

298 
desc
 = (
pxt4_group_desc
 *)(

299 (
__u8
 *)
bh_p
->
b_d©a
 +

300 
off£t
 * 
	`PXT4_DESC_SIZE
(
sb
));

301 i‡(
bh
)

302 *
bh
 = 
bh_p
;

303  
desc
;

304 
	}
}

310 
pxt4_fsblk_t
 
	$pxt4_vÆid_block_bôm≠
(
su≥r_block
 *
sb
,

311 
pxt4_group_desc
 *
desc
,

312 
pxt4_group_t
 
block_group
,

313 
buf„r_hód
 *
bh
)

315 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

316 
pxt4_gΩblk_t
 
off£t
;

317 
pxt4_gΩblk_t
 
√xt_zîo_bô
;

318 
pxt4_gΩblk_t
 
max_bô
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

319 
pxt4_fsblk_t
 
blk
;

320 
pxt4_fsblk_t
 
group_fú°_block
;

322 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
)) {

331 
group_fú°_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

334 
blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

335 
off£t
 = 
blk
 - 
group_fú°_block
;

336 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

337 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

339  
blk
;

342 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

343 
off£t
 = 
blk
 - 
group_fú°_block
;

344 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

345 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

347  
blk
;

350 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
desc
);

351 
off£t
 = 
blk
 - 
group_fú°_block
;

352 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

353 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
Ë>
max_bô
)

354  
blk
;

355 
√xt_zîo_bô
 = 
	`pxt4_föd_√xt_zîo_bô
(
bh
->
b_d©a
,

356 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
),

357 
	`PXT4_B2C
(
sbi
, 
off£t
));

358 i‡(
√xt_zîo_bô
 <

359 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
))

361  
blk
;

363 
	}
}

365 
	$pxt4_vÆid©e_block_bôm≠
(
su≥r_block
 *
sb
,

366 
pxt4_group_desc
 *
desc
,

367 
pxt4_group_t
 
block_group
,

368 
buf„r_hód
 *
bh
)

370 
pxt4_fsblk_t
 
blk
;

371 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

373 i‡(
	`buf„r_vîifõd
(
bh
))

375 i‡(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
))

376  -
EFSCORRUPTED
;

378 
	`pxt4_lock_group
(
sb
, 
block_group
);

379 i‡(
	`buf„r_vîifõd
(
bh
))

380 
vîifõd
;

381 i‡(
	`u∆ikñy
(!
	`pxt4_block_bôm≠_csum_vîify
(
sb
, 
block_group
,

382 
desc
, 
bh
))) {

383 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

384 
	`pxt4_îr‹
(
sb
, "bg %u: bad block bôm≠ checksum", 
block_group
);

385 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

386 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

387  -
EFSBADCRC
;

389 
blk
 = 
	`pxt4_vÆid_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

390 i‡(
	`u∆ikñy
(
blk
 != 0)) {

391 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

392 
	`pxt4_îr‹
(
sb
, "bg %u: block %llu: invalid block bitmap",

393 
block_group
, 
blk
);

394 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

395 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

396  -
EFSCORRUPTED
;

398 
	`£t_buf„r_vîifõd
(
bh
);

399 
vîifõd
:

400 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

402 
	}
}

414 
buf„r_hód
 *

415 
	$pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

417 
pxt4_group_desc
 *
desc
;

418 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

419 
buf„r_hód
 *
bh
;

420 
pxt4_fsblk_t
 
bôm≠_blk
;

421 
îr
;

423 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

424 i‡(!
desc
)

425  
	`ERR_PTR
(-
EFSCORRUPTED
);

426 
bôm≠_blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

427 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

428 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

429 
	`pxt4_îr‹
(
sb
, "Invalid block bitmap block %llu in "

430 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

431 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

432 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

433  
	`ERR_PTR
(-
EFSCORRUPTED
);

435 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

436 i‡(
	`u∆ikñy
(!
bh
)) {

437 
	`pxt4_w¨nög
(
sb
, "Cannot get buffer for block bitmap - "

439 
block_group
, 
bôm≠_blk
);

440  
	`ERR_PTR
(-
ENOMEM
);

443 i‡(
	`bôm≠_u±od©e
(
bh
))

444 
vîify
;

446 
	`lock_buf„r
(
bh
);

447 i‡(
	`bôm≠_u±od©e
(
bh
)) {

448 
	`u∆ock_buf„r
(
bh
);

449 
vîify
;

451 
	`pxt4_lock_group
(
sb
, 
block_group
);

452 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

453 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

454 i‡(
block_group
 == 0) {

455 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

456 
	`u∆ock_buf„r
(
bh
);

457 
	`pxt4_îr‹
(
sb
, "Block bitmap for bg 0 marked "

459 
îr
 = -
EFSCORRUPTED
;

460 
out
;

462 
îr
 = 
	`pxt4_öô_block_bôm≠
(
sb
, 
bh
, 
block_group
, 
desc
);

463 
	`£t_bôm≠_u±od©e
(
bh
);

464 
	`£t_buf„r_u±od©e
(
bh
);

465 
	`£t_buf„r_vîifõd
(
bh
);

466 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

467 
	`u∆ock_buf„r
(
bh
);

468 i‡(
îr
) {

469 
	`pxt4_îr‹
(
sb
, "FailedÅo init block bitmap for group "

470 "%u: %d", 
block_group
, 
îr
);

471 
out
;

473 
vîify
;

475 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

476 i‡(
	`buf„r_u±od©e
(
bh
)) {

481 
	`£t_bôm≠_u±od©e
(
bh
);

482 
	`u∆ock_buf„r
(
bh
);

483 
vîify
;

488 
	`£t_buf„r_√w
(
bh
);

489 
	`åa˚_pxt4_ªad_block_bôm≠_lﬂd
(
sb
, 
block_group
);

490 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

491 
	`gë_bh
(
bh
);

492 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

493  
bh
;

494 
vîify
:

495 
îr
 = 
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

496 i‡(
îr
)

497 
out
;

498  
bh
;

499 
out
:

500 
	`put_bh
(
bh
);

501  
	`ERR_PTR
(
îr
);

502 
	}
}

505 
	$pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
,

506 
buf„r_hód
 *
bh
)

508 
pxt4_group_desc
 *
desc
;

510 i‡(!
	`buf„r_√w
(
bh
))

512 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

513 i‡(!
desc
)

514  -
EFSCORRUPTED
;

515 
	`waô_⁄_buf„r
(
bh
);

516 i‡(!
	`buf„r_u±od©e
(
bh
)) {

517 
	`pxt4_îr‹
(
sb
, "CannotÑead block bitmap - "

519 
block_group
, (Ë
bh
->
b_blockƒ
);

520 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

521 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

522  -
EIO
;

524 
	`˛ór_buf„r_√w
(
bh
);

526  
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

527 
	}
}

529 
buf„r_hód
 *

530 
	$pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

532 
buf„r_hód
 *
bh
;

533 
îr
;

535 
bh
 = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
block_group
);

536 i‡(
	`IS_ERR
(
bh
))

537  
bh
;

538 
îr
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
block_group
, 
bh
);

539 i‡(
îr
) {

540 
	`put_bh
(
bh
);

541  
	`ERR_PTR
(
îr
);

543  
bh
;

544 
	}
}

555 
	$pxt4_has_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

556 
s64
 
n˛u°îs
, 
Êags
)

558 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
, 
rsv
, 
ªsv_˛u°îs
;

559 
≥r˝u_cou¡î
 *
fcc
 = &
sbi
->
s_‰ì˛u°îs_cou¡î
;

560 
≥r˝u_cou¡î
 *
dcc
 = &
sbi
->
s_dúty˛u°îs_cou¡î
;

562 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
fcc
);

563 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
dcc
);

564 
ªsv_˛u°îs
 = 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
);

570 
rsv
 = (
	`pxt4_r_blocks_cou¡
(
sbi
->
s_es
Ë>> sbi->
s_˛u°î_bôs
) +

571 
ªsv_˛u°îs
;

573 i‡(
‰ì_˛u°îs
 - (
n˛u°îs
 + 
rsv
 + 
dúty_˛u°îs
) <

574 
PXT4_FREECLUSTERS_WATERMARK
) {

575 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
fcc
);

576 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
dcc
);

581 i‡(
‰ì_˛u°îs
 >(
rsv
 + 
n˛u°îs
 + 
dúty_˛u°îs
))

585 i‡(
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`cuºít_fsuid
()) ||

586 (!
	`gid_eq
(
sbi
->
s_ªsgid
, 
GLOBAL_ROOT_GID
Ë&& 
	`ö_group_p
(sbi->s_resgid)) ||

587 
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
) ||

588 (
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
)) {

590 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
 +

591 
ªsv_˛u°îs
))

595 i‡(
Êags
 & 
PXT4_MB_USE_RESERVED
) {

596 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
))

601 
	}
}

603 
	$pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

604 
s64
 
n˛u°îs
, 
Êags
)

606 i‡(
	`pxt4_has_‰ì_˛u°îs
(
sbi
, 
n˛u°îs
, 
Êags
)) {

607 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
n˛u°îs
);

610  -
ENOSPC
;

611 
	}
}

623 
	$pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
)

625 i‡(!
	`pxt4_has_‰ì_˛u°îs
(
	`PXT4_SB
(
sb
), 1, 0) ||

626 (*
ªåõs
)++ > 1 ||

627 !
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

630 
	`smp_mb
();

631 i‡(
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 == 0)

634 
	`jbd_debug
(1, "%s:Ñëryög o≥øti⁄á·î ENOSPC\n", 
sb
->
s_id
);

635 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

637 
	}
}

651 
pxt4_fsblk_t
 
	$pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

652 
pxt4_fsblk_t
 
gﬂl
, 
Êags
,

653 *
cou¡
, *
îΩ
)

655 
pxt4_Æloˇti⁄_ªque°
 
¨
;

656 
pxt4_fsblk_t
 
ªt
;

658 
	`mem£t
(&
¨
, 0, (ar));

660 
¨
.
öode
 = inode;

661 
¨
.
gﬂl
 = goal;

662 
¨
.
Àn
 = 
cou¡
 ? *count : 1;

663 
¨
.
Êags
 = flags;

665 
ªt
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, 
îΩ
);

666 i‡(
cou¡
)

667 *
cou¡
 = 
¨
.
Àn
;

672 i‡(!(*
îΩ
Ë&& (
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
)) {

673 
	`dquŸ_Æloc_block_noÁû
(
öode
,

674 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
), 
¨
.
Àn
));

676  
ªt
;

677 
	}
}

685 
pxt4_fsblk_t
 
	$pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *
sb
)

687 
pxt4_fsblk_t
 
desc_cou¡
;

688 
pxt4_group_desc
 *
gdp
;

689 
pxt4_group_t
 
i
;

690 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

691 
pxt4_group_öfo
 *
gΩ
;

692 #ifde‡
PXT4FS_DEBUG


693 
pxt4_su≥r_block
 *
es
;

694 
pxt4_fsblk_t
 
bôm≠_cou¡
;

695 
x
;

696 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

698 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

699 
desc_cou¡
 = 0;

700 
bôm≠_cou¡
 = 0;

701 
gdp
 = 
NULL
;

703 
i
 = 0; i < 
ngroups
; i++) {

704 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

705 i‡(!
gdp
)

707 
gΩ
 = 
NULL
;

708 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

709 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

710 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

711 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

712 
	`bªl£
(
bôm≠_bh
);

713 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
i
);

714 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

715 
bôm≠_bh
 = 
NULL
;

719 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

720 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

721 
	`¥ötk
(
KERN_DEBUG
 "group %u: stored = %d, counted = %u\n",

722 
i
, 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
), 
x
);

723 
bôm≠_cou¡
 +
x
;

725 
	`bªl£
(
bôm≠_bh
);

726 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_clusters: stored = %llu"

728 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
	`pxt4_‰ì_blocks_cou¡
(
es
)),

729 
desc_cou¡
, 
bôm≠_cou¡
);

730  
bôm≠_cou¡
;

732 
desc_cou¡
 = 0;

733 
i
 = 0; i < 
ngroups
; i++) {

734 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

735 i‡(!
gdp
)

737 
gΩ
 = 
NULL
;

738 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

739 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

740 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

741 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

744  
desc_cou¡
;

746 
	}
}

748 
ölöe
 
	$ã°_roŸ
(
pxt4_group_t
 
a
, 
b
)

751 i‡(
a
 < 
b
)

753 i‡(
a
 =
b
)

755 i‡((
a
 % 
b
) != 0)

757 
a
 =á / 
b
;

759 
	}
}

769 
	$pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

771 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

773 i‡(
group
 == 0)

775 i‡(
	`pxt4_has_„©uª_•¨£_su≥r2
(
sb
)) {

776 i‡(
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[0]) ||

777 
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[1]))

781 i‡((
group
 <1Ë|| !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
))

783 i‡(!(
group
 & 1))

785 i‡(
	`ã°_roŸ
(
group
, 3) || (test_root(group, 5)) ||

786 
	`ã°_roŸ
(
group
, 7))

790 
	}
}

792 
	$pxt4_bg_num_gdb_mëa
(
su≥r_block
 *
sb
,

793 
pxt4_group_t
 
group
)

795 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

796 
pxt4_group_t
 
fú°
 = 
mëagroup
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

797 
pxt4_group_t
 
œ°
 = 
fú°
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1;

799 i‡(
group
 =
fú°
 || grou∞=fú° + 1 || grou∞=
œ°
)

802 
	}
}

804 
	$pxt4_bg_num_gdb_nomëa
(
su≥r_block
 *
sb
,

805 
pxt4_group_t
 
group
)

807 i‡(!
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

810 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
))

811  
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

813  
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
;

814 
	}
}

825 
	$pxt4_bg_num_gdb
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

827 
fú°_mëa_bg
 =

828 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

829 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

831 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
)

832  
	`pxt4_bg_num_gdb_nomëa
(
sb
, 
group
);

834  
	`pxt4_bg_num_gdb_mëa
(
sb
,
group
);

836 
	}
}

842 
	$pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

843 
pxt4_group_t
 
block_group
)

845 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

846 
num
;

849 
num
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
block_group
);

851 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
) ||

852 
block_group
 < 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
) *

853 
sbi
->
s_desc_≥r_block
) {

854 i‡(
num
) {

855 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

856 
num
 +
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

859 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

861  
	`PXT4_NUM_B2C
(
sbi
, 
num
);

862 
	}
}

870 
pxt4_fsblk_t
 
	$pxt4_öode_to_gﬂl_block
(
öode
 *inode)

872 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

873 
pxt4_group_t
 
block_group
;

874 
pxt4_gΩblk_t
 
cﬁour
;

875 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
öode
->
i_sb
));

876 
pxt4_fsblk_t
 
bg_°¨t
;

877 
pxt4_fsblk_t
 
œ°_block
;

879 
block_group
 = 
ei
->
i_block_group
;

880 i‡(
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) {

889 
block_group
 &~(
Êex_size
-1);

890 i‡(
	`S_ISREG
(
öode
->
i_mode
))

891 
block_group
++;

893 
bg_°¨t
 = 
	`pxt4_group_fú°_block_no
(
öode
->
i_sb
, 
block_group
);

894 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
) - 1;

900 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

901  
bg_°¨t
;

903 i‡(
bg_°¨t
 + 
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
Ë<
œ°_block
)

904 
cﬁour
 = (
cuºít
->
pid
 % 16) *

905 (
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
) / 16);

907 
cﬁour
 = (
cuºít
->
pid
 % 16Ë* ((
œ°_block
 - 
bg_°¨t
) / 16);

908  
bg_°¨t
 + 
cﬁour
;

909 
	}
}

	@bitmap.c

11 
	~<löux/buf„r_hód.h
>

12 
	~"pxt4.h
"

14 
	$pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
)

16  
numch¨s
 * 
BITS_PER_BYTE
 - 
	`memweight
(
bôm≠
,Çumchars);

17 
	}
}

19 
	$pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

20 
pxt4_group_desc
 *
gdp
,

21 
buf„r_hód
 *
bh
, 
sz
)

23 
__u32
 
hi
;

24 
__u32
 
¥ovided
, 
ˇlcuœãd
;

25 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

27 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

30 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_lo
);

31 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

32 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
) {

33 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_hi
);

34 
¥ovided
 |(
hi
 << 16);

36 
ˇlcuœãd
 &= 0xFFFF;

38  
¥ovided
 =
ˇlcuœãd
;

39 
	}
}

41 
	$pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

42 
pxt4_group_desc
 *
gdp
,

43 
buf„r_hód
 *
bh
, 
sz
)

45 
__u32
 
csum
;

46 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

48 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

51 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

52 
gdp
->
bg_öode_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

53 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
)

54 
gdp
->
bg_öode_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

55 
	}
}

57 
	$pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

58 
pxt4_group_desc
 *
gdp
,

59 
buf„r_hód
 *
bh
)

61 
__u32
 
hi
;

62 
__u32
 
¥ovided
, 
ˇlcuœãd
;

63 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

64 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

66 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

69 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_lo
);

70 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

71 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
) {

72 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_hi
);

73 
¥ovided
 |(
hi
 << 16);

75 
ˇlcuœãd
 &= 0xFFFF;

77 i‡(
¥ovided
 =
ˇlcuœãd
)

81 
	}
}

83 
	$pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

84 
pxt4_group_desc
 *
gdp
,

85 
buf„r_hód
 *
bh
)

87 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

88 
__u32
 
csum
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

91 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

94 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

95 
gdp
->
bg_block_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

96 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
)

97 
gdp
->
bg_block_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

98 
	}
}

	@block_validity.c

12 
	~<löux/time.h
>

13 
	~<löux/fs.h
>

14 
	~<löux/«mei.h
>

15 
	~<löux/quŸa›s.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/blkdev.h
>

20 
	~<löux/¶ab.h
>

21 
	~"pxt4.h
"

23 
	spxt4_sy°em_z⁄e
 {

24 
rb_node
 
	mnode
;

25 
pxt4_fsblk_t
 
	m°¨t_blk
;

26 
	mcou¡
;

29 
kmem_ˇche
 *
	gpxt4_sy°em_z⁄e_ˇchï
;

31 
__öô
 
	$pxt4_öô_sy°em_z⁄e
()

33 
pxt4_sy°em_z⁄e_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_sy°em_z⁄e
, 0);

34 i‡(
pxt4_sy°em_z⁄e_ˇchï
 =
NULL
)

35  -
ENOMEM
;

37 
	}
}

39 
	$pxt4_exô_sy°em_z⁄e
()

41 
	`rcu_b¨rõr
();

42 
	`kmem_ˇche_de°roy
(
pxt4_sy°em_z⁄e_ˇchï
);

43 
	}
}

45 
ölöe
 
	$ˇn_mîge
(
pxt4_sy°em_z⁄e
 *
íåy1
,

46 
pxt4_sy°em_z⁄e
 *
íåy2
)

48 i‡((
íåy1
->
°¨t_blk
 +É¡ry1->
cou¡
Ë=
íåy2
->start_blk)

51 
	}
}

53 
	$ªÀa£_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
)

55 
pxt4_sy°em_z⁄e
 *
íåy
, *
n
;

57 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
íåy
, 
n
,

58 &
sy°em_blks
->
roŸ
, 
node
)

59 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

60 
	}
}

67 
	$add_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
,

68 
pxt4_fsblk_t
 
°¨t_blk
,

69 
cou¡
)

71 
pxt4_sy°em_z⁄e
 *
√w_íåy
, *
íåy
;

72 
rb_node
 **
n
 = &
sy°em_blks
->
roŸ
.rb_node, *
node
;

73 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
 = NULL;

75 *
n
) {

76 
∑ª¡
 = *
n
;

77 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_sy°em_z⁄e
, 
node
);

78 i‡(
°¨t_blk
 < 
íåy
->start_blk)

79 
n
 = &(*n)->
rb_À·
;

80 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

81 
n
 = &(*n)->
rb_right
;

83  -
EFSCORRUPTED
;

86 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_sy°em_z⁄e_ˇchï
,

87 
GFP_KERNEL
);

88 i‡(!
√w_íåy
)

89  -
ENOMEM
;

90 
√w_íåy
->
°¨t_blk
 = start_blk;

91 
√w_íåy
->
cou¡
 = count;

92 
√w_node
 = &
√w_íåy
->
node
;

94 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

95 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
sy°em_blks
->
roŸ
);

98 
node
 = 
	`rb_¥ev
(
√w_node
);

99 i‡(
node
) {

100 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

101 i‡(
	`ˇn_mîge
(
íåy
, 
√w_íåy
)) {

102 
√w_íåy
->
°¨t_blk
 = 
íåy
->start_blk;

103 
√w_íåy
->
cou¡
 +
íåy
->count;

104 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

105 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

110 
node
 = 
	`rb_√xt
(
√w_node
);

111 i‡(
node
) {

112 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

113 i‡(
	`ˇn_mîge
(
√w_íåy
, 
íåy
)) {

114 
√w_íåy
->
cou¡
 +
íåy
->count;

115 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

116 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

120 
	}
}

122 
	$debug_¥öt_åì
(
pxt4_sb_öfo
 *
sbi
)

124 
rb_node
 *
node
;

125 
pxt4_sy°em_z⁄e
 *
íåy
;

126 
fú°
 = 1;

128 
	`¥ötk
(
KERN_INFO
 "System zones: ");

129 
node
 = 
	`rb_fú°
(&
sbi
->
sy°em_blks
->
roŸ
);

130 
node
) {

131 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

132 
	`¥ötk
(
KERN_CONT
 "%s%Œu-%Œu", 
fú°
 ? "" : ", ",

133 
íåy
->
°¨t_blk
,É¡ry->°¨t_blk +É¡ry->
cou¡
 - 1);

134 
fú°
 = 0;

135 
node
 = 
	`rb_√xt
(node);

137 
	`¥ötk
(
KERN_CONT
 "\n");

138 
	}
}

145 
	$pxt4_d©a_block_vÆid_rcu
(
pxt4_sb_öfo
 *
sbi
,

146 
pxt4_sy°em_blocks
 *
sy°em_blks
,

147 
pxt4_fsblk_t
 
°¨t_blk
,

148 
cou¡
)

150 
pxt4_sy°em_z⁄e
 *
íåy
;

151 
rb_node
 *
n
;

153 i‡((
°¨t_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

154 (
°¨t_blk
 + 
cou¡
 < start_blk) ||

155 (
°¨t_blk
 + 
cou¡
 > 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

156 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

160 i‡(
sy°em_blks
 =
NULL
)

163 
n
 = 
sy°em_blks
->
roŸ
.
rb_node
;

164 
n
) {

165 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_sy°em_z⁄e
, 
node
);

166 i‡(
°¨t_blk
 + 
cou¡
 - 1 < 
íåy
->start_blk)

167 
n
 =Ç->
rb_À·
;

168 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

169 
n
 =Ç->
rb_right
;

171 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

176 
	}
}

178 
	$pxt4_¥Ÿe˘_ª£rved_öode
(
su≥r_block
 *
sb
,

179 
pxt4_sy°em_blocks
 *
sy°em_blks
,

180 
u32
 
öo
)

182 
öode
 *inode;

183 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

184 
pxt4_m≠_blocks
 
m≠
;

185 
u32
 
i
 = 0, 
num
;

186 
îr
 = 0, 
n
;

188 i‡((
öo
 < 
PXT4_ROOT_INO
) ||

189 (
öo
 > 
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)))

190  -
EINVAL
;

191 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_SPECIAL
);

192 i‡(
	`IS_ERR
(
öode
))

193  
	`PTR_ERR
(
öode
);

194 
num
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

195 
i
 < 
num
) {

196 
	`c⁄d_ªsched
();

197 
m≠
.
m_lblk
 = 
i
;

198 
m≠
.
m_Àn
 = 
num
 - 
i
;

199 
n
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

200 i‡(
n
 < 0) {

201 
îr
 = 
n
;

204 i‡(
n
 == 0) {

205 
i
++;

207 i‡(!
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
,

208 
m≠
.
m_pblk
, 
n
)) {

209 
	`pxt4_îr‹
(
sb
, "blocks %llu-%llu from inode %u "

210 "ovîœ∞sy°em z⁄e", 
m≠
.
m_pblk
,

211 
m≠
.
m_pblk
 + m≠.
m_Àn
 - 1, 
öo
);

212 
îr
 = -
EFSCORRUPTED
;

215 
îr
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
, 
m≠
.
m_pblk
, 
n
);

216 i‡(
îr
 < 0)

218 
i
 +
n
;

221 
	`ùut
(
öode
);

222  
îr
;

223 
	}
}

225 
	$pxt4_de°roy_sy°em_z⁄e
(
rcu_hód
 *
rcu
)

227 
pxt4_sy°em_blocks
 *
sy°em_blks
;

229 
sy°em_blks
 = 
	`c⁄èöî_of
(
rcu
, 
pxt4_sy°em_blocks
,Ñcu);

230 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

231 
	`k‰ì
(
sy°em_blks
);

232 
	}
}

243 
	$pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
)

245 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

246 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

247 
pxt4_sy°em_blocks
 *
sy°em_blks
;

248 
pxt4_group_desc
 *
gdp
;

249 
pxt4_group_t
 
i
;

250 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

251 
ªt
;

253 
sy°em_blks
 = 
	`kzÆloc
((*sy°em_blks), 
GFP_KERNEL
);

254 i‡(!
sy°em_blks
)

255  -
ENOMEM
;

257 
i
=0; i < 
ngroups
; i++) {

258 
	`c⁄d_ªsched
();

259 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
i
) &&

260 ((
i
 < 5Ë|| ((ò% 
Êex_size
) == 0)))

261 
	`add_sy°em_z⁄e
(
sy°em_blks
,

262 
	`pxt4_group_fú°_block_no
(
sb
, 
i
),

263 
	`pxt4_bg_num_gdb
(
sb
, 
i
) + 1);

264 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

265 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

266 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1);

267 i‡(
ªt
)

268 
îr
;

269 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

270 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1);

271 i‡(
ªt
)

272 
îr
;

273 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

274 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

275 
sbi
->
s_ôb_≥r_group
);

276 i‡(
ªt
)

277 
îr
;

279 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& 
sbi
->
s_es
->
s_jou∫Æ_öum
) {

280 
ªt
 = 
	`pxt4_¥Ÿe˘_ª£rved_öode
(
sb
, 
sy°em_blks
,

281 
	`À32_to_˝u
(
sbi
->
s_es
->
s_jou∫Æ_öum
));

282 i‡(
ªt
)

283 
îr
;

291 
	`rcu_assign_poöãr
(
sbi
->
sy°em_blks
, system_blks);

293 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

294 
	`debug_¥öt_åì
(
sbi
);

296 
îr
:

297 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

298 
	`k‰ì
(
sy°em_blks
);

299  
ªt
;

300 
	}
}

312 
	$pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
)

314 
pxt4_sy°em_blocks
 *
sy°em_blks
;

316 
sy°em_blks
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
	`PXT4_SB
(
sb
)->system_blks,

317 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

318 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
sy°em_blks
, 
NULL
);

320 i‡(
sy°em_blks
)

321 
	`ˇŒ_rcu
(&
sy°em_blks
->
rcu
, 
pxt4_de°roy_sy°em_z⁄e
);

322 
	}
}

324 
	$pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
, 
pxt4_fsblk_t
 
°¨t_blk
,

325 
cou¡
)

327 
pxt4_sy°em_blocks
 *
sy°em_blks
;

328 
ªt
;

335 
	`rcu_ªad_lock
();

336 
sy°em_blks
 = 
	`rcu_dîe„ªn˚
(
sbi
->system_blks);

337 
ªt
 = 
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
, 
°¨t_blk
,

338 
cou¡
);

339 
	`rcu_ªad_u∆ock
();

340  
ªt
;

341 
	}
}

343 
	$pxt4_check_blockªf
(c⁄° *
fun˘i⁄
, 
löe
,

344 
öode
 *öode, 
__À32
 *
p
, 
max
)

346 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

347 
__À32
 *
bªf
 = 
p
;

348 
blk
;

350 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

351 (
öode
->
i_öo
 ==

352 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

355 
bªf
 < 
p
+
max
) {

356 
blk
 = 
	`À32_to_˝u
(*
bªf
++);

357 i‡(
blk
 &&

358 
	`u∆ikñy
(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

359 
blk
, 1))) {

360 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
blk
);

361 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 
blk
,

363  -
EFSCORRUPTED
;

367 
	}
}

	@dir.c

25 
	~<löux/fs.h
>

26 
	~<löux/buf„r_hód.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/ivîsi⁄.h
>

29 
	~<löux/unicode.h
>

30 
	~"pxt4.h
"

31 
	~"x©å.h
"

33 
pxt4_dx_ªaddú
(
fûe
 *, 
dú_c⁄ãxt
 *);

45 
	$is_dx_dú
(
öode
 *inode)

47 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

49 i‡(
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
) &&

50 ((
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) ||

51 ((
öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
) == 1) ||

52 
	`pxt4_has_ölöe_d©a
(
öode
)))

56 
	}
}

66 
	$__pxt4_check_dú_íåy
(c⁄° *
fun˘i⁄
, 
löe
,

67 
öode
 *
dú
, 
fûe
 *
fûp
,

68 
pxt4_dú_íåy_2
 *
de
,

69 
buf„r_hód
 *
bh
, *
buf
, 
size
,

70 
off£t
)

72 c⁄° *
îr‹_msg
 = 
NULL
;

73 c⁄° 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

74 
dú
->
i_sb
->
s_blocksize
);

76 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(1)))

77 
îr‹_msg
 = "rec_len is smallerÅhan minimal";

78 i‡(
	`u∆ikñy
(
æí
 % 4 != 0))

79 
îr‹_msg
 = "rec_len % 4 != 0";

80 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
)))

81 
îr‹_msg
 = "rec_len isÅoo small forÇame_len";

82 i‡(
	`u∆ikñy
(((*Ë
de
 - 
buf
Ë+ 
æí
 > 
size
))

83 
îr‹_msg
 = "directoryÉntry overrun";

84 i‡(
	`u∆ikñy
(((*Ë
de
 - 
buf
Ë+ 
æí
 >

85 
size
 - 
	`PXT4_DIR_REC_LEN
(1) &&

86 ((*Ë
de
 - 
buf
Ë+ 
æí
 !
size
)) {

87 
îr‹_msg
 = "directoryÉntryÅoo closeÅo blockÉnd";

89 i‡(
	`u∆ikñy
(
	`À32_to_˝u
(
de
->
öode
) >

90 
	`À32_to_˝u
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_es
->
s_öodes_cou¡
)))

91 
îr‹_msg
 = "inode out of bounds";

95 i‡(
fûp
)

96 
	`pxt4_îr‹_fûe
(
fûp
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

99 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

100 
æí
, 
de
->
«me_Àn
, 
size
);

102 
	`pxt4_îr‹_öode
(
dú
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

105 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

106 
æí
, 
de
->
«me_Àn
, 
size
);

109 
	}
}

111 
	$pxt4_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

113 
off£t
;

114 
i
;

115 
pxt4_dú_íåy_2
 *
de
;

116 
îr
;

117 
öode
 *öodê
	`fûe_öode
(
fûe
);

118 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

119 
buf„r_hód
 *
bh
 = 
NULL
;

120 
fs¸y±_°r
 
f°r
 = 
	`FSTR_INIT
(
NULL
, 0);

122 i‡(
	`IS_ENCRYPTED
(
öode
)) {

123 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
);

124 i‡(
îr
 &&Éº !-
ENOKEY
)

125  
îr
;

128 i‡(
	`is_dx_dú
(
öode
)) {

129 
îr
 = 
	`pxt4_dx_ªaddú
(
fûe
, 
˘x
);

130 i‡(
îr
 !
ERR_BAD_DX_DIR
) {

131  
îr
;

134 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
)) {

139 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

143 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

144 
has_ölöe_d©a
 = 1;

145 
îr
 = 
	`pxt4_ªad_ölöe_dú
(
fûe
, 
˘x
,

146 &
has_ölöe_d©a
);

147 i‡(
has_ölöe_d©a
)

148  
îr
;

151 i‡(
	`IS_ENCRYPTED
(
öode
)) {

152 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
öode
, 
PXT4_NAME_LEN
, &
f°r
);

153 i‡(
îr
 < 0)

154  
îr
;

157 
˘x
->
pos
 < 
öode
->
i_size
) {

158 
pxt4_m≠_blocks
 
m≠
;

160 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

161 
îr
 = -
ERESTARTSYS
;

162 
îrout
;

164 
	`c⁄d_ªsched
();

165 
off£t
 = 
˘x
->
pos
 & (
sb
->
s_blocksize
 - 1);

166 
m≠
.
m_lblk
 = 
˘x
->
pos
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

167 
m≠
.
m_Àn
 = 1;

168 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

169 i‡(
îr
 == 0) {

172 i‡(
m≠
.
m_Àn
 == 0)

173 
m≠
.
m_Àn
 = 1;

174 
˘x
->
pos
 +
m≠
.
m_Àn
 * 
sb
->
s_blocksize
;

177 i‡(
îr
 > 0) {

178 
pgoff_t
 
ödex
 = 
m≠
.
m_pblk
 >>

179 (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

180 i‡(!
	`ø_has_ödex
(&
fûe
->
f_ø
, 
ödex
))

181 
	`∑ge_ˇche_sync_ªadahód
(

182 
sb
->
s_bdev
->
bd_öode
->
i_m≠pög
,

183 &
fûe
->
f_ø
, file,

184 
ödex
, 1);

185 
fûe
->
f_ø
.
¥ev_pos
 = (
loff_t
)
ödex
 << 
PAGE_SHIFT
;

186 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
m≠
.
m_lblk
, 0);

187 i‡(
	`IS_ERR
(
bh
)) {

188 
îr
 = 
	`PTR_ERR
(
bh
);

189 
bh
 = 
NULL
;

190 
îrout
;

194 i‡(!
bh
) {

196 i‡(
˘x
->
pos
 > 
öode
->
i_blocks
 << 9)

198 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

203 i‡(!
	`buf„r_vîifõd
(
bh
) &&

204 !
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
)) {

205 
	`PXT4_ERROR_FILE
(
fûe
, 0, "directory fails checksum "

207 ()
˘x
->
pos
);

208 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

209 
	`bªl£
(
bh
);

210 
bh
 = 
NULL
;

213 
	`£t_buf„r_vîifõd
(
bh
);

219 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

220 
i
 = 0; i < 
sb
->
s_blocksize
 && i < 
off£t
; ) {

221 
de
 = (
pxt4_dú_íåy_2
 *)

222 (
bh
->
b_d©a
 + 
i
);

229 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

230 
sb
->
s_blocksize
Ë< 
	`PXT4_DIR_REC_LEN
(1))

232 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

233 
sb
->
s_blocksize
);

235 
off£t
 = 
i
;

236 
˘x
->
pos
 = (˘x->po†& ~(
sb
->
s_blocksize
 - 1))

237 | 
off£t
;

238 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

241 
˘x
->
pos
 < 
öode
->
i_size


242 && 
off£t
 < 
sb
->
s_blocksize
) {

243 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 + 
off£t
);

244 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
bh
,

245 
bh
->
b_d©a
, bh->
b_size
,

246 
off£t
)) {

250 
˘x
->
pos
 = (ctx->pos |

251 (
sb
->
s_blocksize
 - 1)) + 1;

254 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

255 
sb
->
s_blocksize
);

256 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

257 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

258 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
,

259 
de
->
«me_Àn
,

260 
	`À32_to_˝u
(
de
->
öode
),

261 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

262 
d⁄e
;

264 
ßve_Àn
 = 
f°r
.
Àn
;

265 
fs¸y±_°r
 
de_«me
 =

266 
	`FSTR_INIT
(
de
->
«me
,

267 
de
->
«me_Àn
);

270 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
öode
,

271 0, 0, &
de_«me
, &
f°r
);

272 
de_«me
 = 
f°r
;

273 
f°r
.
Àn
 = 
ßve_Àn
;

274 i‡(
îr
)

275 
îrout
;

276 i‡(!
	`dú_emô
(
˘x
,

277 
de_«me
.
«me
, de_«me.
Àn
,

278 
	`À32_to_˝u
(
de
->
öode
),

279 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

280 
d⁄e
;

283 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

284 
sb
->
s_blocksize
);

286 i‡((
˘x
->
pos
 < 
öode
->
i_size
Ë&& !
	`dú_ªœx_sh¨ed
(inode))

287 
d⁄e
;

288 
	`bªl£
(
bh
);

289 
bh
 = 
NULL
;

290 
off£t
 = 0;

292 
d⁄e
:

293 
îr
 = 0;

294 
îrout
:

295 
	`fs¸y±_‚ame_‰ì_buf„r
(&
f°r
);

296 
	`bªl£
(
bh
);

297  
îr
;

298 
	}
}

300 
ölöe
 
	$is_32bô_≠i
()

302 #ifde‡
CONFIG_COMPAT


303  
	`ö_com∑t_sysˇŒ
();

305  (
BITS_PER_LONG
 == 32);

307 
	}
}

318 
ölöe
 
loff_t
 
	$hash2pos
(
fûe
 *
fûp
, 
__u32
 
maj‹
, __u32 
mö‹
)

320 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

321 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

322  
maj‹
 >> 1;

324  ((
__u64
)(
maj‹
 >> 1Ë<< 32Ë| (__u64)
mö‹
;

325 
	}
}

327 
ölöe
 
__u32
 
	$pos2maj_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

329 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

330 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

331  (
pos
 << 1) & 0xffffffff;

333  ((
pos
 >> 32) << 1) & 0xffffffff;

334 
	}
}

336 
ölöe
 
__u32
 
	$pos2mö_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

338 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

339 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

342  
pos
 & 0xffffffff;

343 
	}
}

348 
ölöe
 
loff_t
 
	$pxt4_gë_håì_eof
(
fûe
 *
fûp
)

350 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

351 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

352  
PXT4_HTREE_EOF_32BIT
;

354  
PXT4_HTREE_EOF_64BIT
;

355 
	}
}

369 
loff_t
 
	$pxt4_dú_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

371 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

372 
dx_dú
 = 
	`is_dx_dú
(
öode
);

373 
loff_t
 
ªt
, 
håì_max
 = 
	`pxt4_gë_håì_eof
(
fûe
);

375 i‡(
	`likñy
(
dx_dú
))

376 
ªt
 = 
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

377 
håì_max
, htree_max);

379 
ªt
 = 
	`pxt4_Œ£ek
(
fûe
, 
off£t
, 
whí˚
);

380 
fûe
->
f_vîsi⁄
 = 
	`öode_≥ek_ivîsi⁄
(
öode
) - 1;

381  
ªt
;

382 
	}
}

388 
	s‚ame
 {

389 
__u32
 
	mhash
;

390 
__u32
 
	mmö‹_hash
;

391 
rb_node
 
	mrb_hash
;

392 
‚ame
 *
	m√xt
;

393 
__u32
 
	möode
;

394 
__u8
 
	m«me_Àn
;

395 
__u8
 
	mfûe_ty≥
;

396 
	m«me
[0];

403 
	$‰ì_rb_åì_‚ame
(
rb_roŸ
 *
roŸ
)

405 
‚ame
 *‚ame, *
√xt
;

407 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
‚ame
, 
√xt
, 
roŸ
, 
rb_hash
)

408 
‚ame
) {

409 
‚ame
 *
ﬁd
 = fname;

410 
‚ame
 = f«me->
√xt
;

411 
	`k‰ì
(
ﬁd
);

414 *
roŸ
 = 
RB_ROOT
;

415 
	}
}

418 
dú_¥iv©e_öfo
 *
	$pxt4_håì_¸óã_dú_öfo
(
fûe
 *
fûp
,

419 
loff_t
 
pos
)

421 
dú_¥iv©e_öfo
 *
p
;

423 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

424 i‡(!
p
)

425  
NULL
;

426 
p
->
cuº_hash
 = 
	`pos2maj_hash
(
fûp
, 
pos
);

427 
p
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûp
, 
pos
);

428  
p
;

429 
	}
}

431 
	$pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
)

433 
	`‰ì_rb_åì_‚ame
(&
p
->
roŸ
);

434 
	`k‰ì
(
p
);

435 
	}
}

444 
	$pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

445 
__u32
 
mö‹_hash
,

446 
pxt4_dú_íåy_2
 *
dúít
,

447 
fs¸y±_°r
 *
ít_«me
)

449 
rb_node
 **
p
, *
∑ª¡
 = 
NULL
;

450 
‚ame
 *‚ame, *
√w_‚
;

451 
dú_¥iv©e_öfo
 *
öfo
;

452 
Àn
;

454 
öfo
 = 
dú_fûe
->
¥iv©e_d©a
;

455 
p
 = &
öfo
->
roŸ
.
rb_node
;

458 
Àn
 = (
‚ame
Ë+ 
ít_«me
->len + 1;

459 
√w_‚
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

460 i‡(!
√w_‚
)

461  -
ENOMEM
;

462 
√w_‚
->
hash
 = hash;

463 
√w_‚
->
mö‹_hash
 = minor_hash;

464 
√w_‚
->
öode
 = 
	`À32_to_˝u
(
dúít
->inode);

465 
√w_‚
->
«me_Àn
 = 
ít_«me
->
Àn
;

466 
√w_‚
->
fûe_ty≥
 = 
dúít
->file_type;

467 
	`mem˝y
(
√w_‚
->
«me
, 
ít_«me
->«me,É¡_«me->
Àn
);

468 
√w_‚
->
«me
[
ít_«me
->
Àn
] = 0;

470 *
p
) {

471 
∑ª¡
 = *
p
;

472 
‚ame
 = 
	`rb_íåy
(
∑ª¡
, ‚ame, 
rb_hash
);

478 i‡((
√w_‚
->
hash
 =
‚ame
->hash) &&

479 (
√w_‚
->
mö‹_hash
 =
‚ame
->minor_hash)) {

480 
√w_‚
->
√xt
 = 
‚ame
->next;

481 
‚ame
->
√xt
 = 
√w_‚
;

485 i‡(
√w_‚
->
hash
 < 
‚ame
->hash)

486 
p
 = &(*p)->
rb_À·
;

487 i‡(
√w_‚
->
hash
 > 
‚ame
->hash)

488 
p
 = &(*p)->
rb_right
;

489 i‡(
√w_‚
->
mö‹_hash
 < 
‚ame
->minor_hash)

490 
p
 = &(*p)->
rb_À·
;

492 
p
 = &(*p)->
rb_right
;

495 
	`rb_lök_node
(&
√w_‚
->
rb_hash
, 
∑ª¡
, 
p
);

496 
	`rb_ö£π_cﬁ‹
(&
√w_‚
->
rb_hash
, &
öfo
->
roŸ
);

498 
	}
}

507 
	$ˇŒ_fûldú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
,

508 
‚ame
 *fname)

510 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

511 
öode
 *öodê
	`fûe_öode
(
fûe
);

512 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

514 i‡(!
‚ame
) {

515 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: comm %s: "

516 "ˇŒed wôhÇuŒ f«me?!?", 
__func__
, 
__LINE__
,

517 
öode
->
i_öo
, 
cuºít
->
comm
);

520 
˘x
->
pos
 = 
	`hash2pos
(
fûe
, 
‚ame
->
hash
, f«me->
mö‹_hash
);

521 
‚ame
) {

522 i‡(!
	`dú_emô
(
˘x
, 
‚ame
->
«me
,

523 
‚ame
->
«me_Àn
,

524 
‚ame
->
öode
,

525 
	`gë_dty≥
(
sb
, 
‚ame
->
fûe_ty≥
))) {

526 
öfo
->
exåa_‚ame
 = 
‚ame
;

529 
‚ame
 = f«me->
√xt
;

532 
	}
}

534 
	$pxt4_dx_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

536 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

537 
öode
 *öodê
	`fûe_öode
(
fûe
);

538 
‚ame
 *fname;

539 
ªt
;

541 i‡(!
öfo
) {

542 
öfo
 = 
	`pxt4_håì_¸óã_dú_öfo
(
fûe
, 
˘x
->
pos
);

543 i‡(!
öfo
)

544  -
ENOMEM
;

545 
fûe
->
¥iv©e_d©a
 = 
öfo
;

548 i‡(
˘x
->
pos
 =
	`pxt4_gë_håì_eof
(
fûe
))

552 i‡(
öfo
->
œ°_pos
 !
˘x
->
pos
) {

553 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

554 
öfo
->
cuº_node
 = 
NULL
;

555 
öfo
->
exåa_‚ame
 = 
NULL
;

556 
öfo
->
cuº_hash
 = 
	`pos2maj_hash
(
fûe
, 
˘x
->
pos
);

557 
öfo
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûe
, 
˘x
->
pos
);

564 i‡(
öfo
->
exåa_‚ame
) {

565 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
öfo
->
exåa_‚ame
))

566 
föished
;

567 
öfo
->
exåa_‚ame
 = 
NULL
;

568 
√xt_node
;

569 } i‡(!
öfo
->
cuº_node
)

570 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

578 i‡((!
öfo
->
cuº_node
) ||

579 !
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

580 
öfo
->
cuº_node
 = 
NULL
;

581 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

582 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

583 
ªt
 = 
	`pxt4_håì_fûl_åì
(
fûe
, 
öfo
->
cuº_hash
,

584 
öfo
->
cuº_mö‹_hash
,

585 &
öfo
->
√xt_hash
);

586 i‡(
ªt
 < 0)

587  
ªt
;

588 i‡(
ªt
 == 0) {

589 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

592 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

595 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, ‚ame, 
rb_hash
);

596 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

597 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

598 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
‚ame
))

600 
√xt_node
:

601 
öfo
->
cuº_node
 = 
	`rb_√xt
(info->curr_node);

602 i‡(
öfo
->
cuº_node
) {

603 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, fname,

604 
rb_hash
);

605 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

606 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

608 i‡(
öfo
->
√xt_hash
 == ~0) {

609 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

612 
öfo
->
cuº_hash
 = info->
√xt_hash
;

613 
öfo
->
cuº_mö‹_hash
 = 0;

616 
föished
:

617 
öfo
->
œ°_pos
 = 
˘x
->
pos
;

619 
	}
}

621 
	$pxt4_dú_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

623 i‡(
	`IS_ENCRYPTED
(
öode
))

624  
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
Ë? -
EACCES
 : 0;

626 
	}
}

628 
	$pxt4_ªÀa£_dú
(
öode
 *öode, 
fûe
 *
fûp
)

630 i‡(
fûp
->
¥iv©e_d©a
)

631 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

634 
	}
}

636 
	$pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
, *
buf
,

637 
buf_size
)

639 
pxt4_dú_íåy_2
 *
de
;

640 
æí
;

641 
off£t
 = 0;

642 *
t›
;

644 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

645 
t›
 = 
buf
 + 
buf_size
;

646 (*Ë
de
 < 
t›
) {

647 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

648 
buf
, 
buf_size
, 
off£t
))

649  -
EFSCORRUPTED
;

650 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

651 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

652 
off£t
 +
æí
;

654 i‡((*Ë
de
 > 
t›
)

655  -
EFSCORRUPTED
;

658 
	}
}

660 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_dú_›î©i⁄s
 = {

661 .
Œ£ek
 = 
pxt4_dú_Œ£ek
,

662 .
	gªad
 = 
gíîic_ªad_dú
,

663 .
	gôî©e_sh¨ed
 = 
pxt4_ªaddú
,

664 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

665 #ifde‡
CONFIG_COMPAT


666 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

668 .
	gfsync
 = 
pxt4_sync_fûe
,

669 .
	g›í
 = 
pxt4_dú_›í
,

670 .
	gªÀa£
 = 
pxt4_ªÀa£_dú
,

673 #ifde‡
CONFIG_UNICODE


674 
	$pxt4_d_com∑ª
(c⁄° 
díåy
 *díåy, 
Àn
,

675 c⁄° *
°r
, c⁄° 
q°r
 *
«me
)

677 
q°r
 q°∏{.
«me
 = 
°r
, .
Àn
 =Üen };

678 c⁄° 
díåy
 *
∑ª¡
 = 
	`READ_ONCE
(díåy->
d_∑ª¡
);

679 c⁄° 
öode
 *öodê
	`READ_ONCE
(
∑ª¡
->
d_öode
);

680 
°rbuf
[
DNAME_INLINE_LEN
];

682 i‡(!
öode
 || !
	`IS_CASEFOLDED
(inode) ||

683 !
	`PXT4_SB
(
öode
->
i_sb
)->
s_ícodög
) {

684 i‡(
Àn
 !
«me
->len)

686  
	`memcmp
(
°r
, 
«me
->«me, 
Àn
);

696 i‡(
Àn
 <
DNAME_INLINE_LEN
 - 1) {

697 
	`mem˝y
(
°rbuf
, 
°r
, 
Àn
);

698 
°rbuf
[
Àn
] = 0;

699 
q°r
.
«me
 = 
°rbuf
;

701 
	`b¨rõr
();

704  
	`pxt4_ci_com∑ª
(
öode
, 
«me
, &
q°r
, 
Ál£
);

705 
	}
}

707 
	$pxt4_d_hash
(c⁄° 
díåy
 *díåy, 
q°r
 *
°r
)

709 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
díåy
->
d_sb
);

710 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

711 c⁄° 
öode
 *öodê
	`READ_ONCE
(
díåy
->
d_öode
);

712 *
n‹m
;

713 
Àn
, 
ªt
 = 0;

715 i‡(!
öode
 || !
	`IS_CASEFOLDED
(öodeË|| !
um
)

718 
n‹m
 = 
	`kmÆloc
(
PATH_MAX
, 
GFP_ATOMIC
);

719 i‡(!
n‹m
)

720  -
ENOMEM
;

722 
Àn
 = 
	`utf8_ˇ£fﬁd
(
um
, 
°r
, 
n‹m
, 
PATH_MAX
);

723 i‡(
Àn
 < 0) {

724 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

725 
ªt
 = -
EINVAL
;

726 
out
;

728 
°r
->
hash
 = 
	`fuŒ_«me_hash
(
díåy
, 
n‹m
, 
Àn
);

729 
out
:

730 
	`k‰ì
(
n‹m
);

731  
ªt
;

732 
	}
}

734 c⁄° 
díåy_›î©i⁄s
 
	gpxt4_díåy_›s
 = {

735 .
d_hash
 = 
pxt4_d_hash
,

736 .
	gd_com∑ª
 = 
pxt4_d_com∑ª
,

	@ext4.h

17 #i‚de‡
_PXT4_H


18 
	#_PXT4_H


	)

20 
	~<löux/ty≥s.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/magic.h
>

23 
	~<löux/jbd3.h
>

24 
	~<löux/quŸa.h
>

25 
	~<löux/rw£m.h
>

26 
	~<löux/rbåì.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/muãx.h
>

29 
	~<löux/timî.h
>

30 
	~<löux/vîsi⁄.h
>

31 
	~<löux/waô.h
>

32 
	~<löux/sched/sig«l.h
>

33 
	~<löux/blockgroup_lock.h
>

34 
	~<löux/≥r˝u_cou¡î.h
>

35 
	~<löux/øãlimô.h
>

36 
	~<¸y±o/hash.h
>

37 
	~<löux/ÁŒoc.h
>

38 
	~<löux/≥r˝u-rw£m.h
>

39 #ifde‡
__KERNEL__


40 
	~<löux/com∑t.h
>

43 
	~<löux/fs¸y±.h
>

44 
	~<löux/fsvîôy.h
>

46 
	~<löux/compûî.h
>

56 
	#AGGRESSIVE_CHECK__


	)

62 
	#DOUBLE_CHECK__


	)

67 #unde‡
PXT4FS_DEBUG


72 #ifde‡
PXT4FS_DEBUG


73 
	#pxt4_debug
(
f
, 
a
...) \

75 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs DEBUG (%s, %d): %s:", \

76 
__FILE__
, 
__LINE__
, 
__func__
); \

77 
	`¥ötk
(
KERN_DEBUG
 
f
, ## 
a
); \

78 } 0)

	)

80 
	#pxt4_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

86 
	#EXT_DEBUG__


	)

87 #ifde‡
EXT_DEBUG


88 
	#ext_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

90 
	#ext_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

94 
	tpxt4_gΩblk_t
;

97 
	tpxt4_fsblk_t
;

100 
__u32
 
	tpxt4_lblk_t
;

103 
	tpxt4_group_t
;

105 
	eSHIFT_DIRECTION
 {

106 
	mSHIFT_LEFT
 = 0,

107 
	mSHIFT_RIGHT
,

118 
	#PXT4_MB_HINT_MERGE
 0x0001

	)

120 
	#PXT4_MB_HINT_RESERVED
 0x0002

	)

122 
	#PXT4_MB_HINT_METADATA
 0x0004

	)

124 
	#PXT4_MB_HINT_FIRST
 0x0008

	)

126 
	#PXT4_MB_HINT_BEST
 0x0010

	)

128 
	#PXT4_MB_HINT_DATA
 0x0020

	)

130 
	#PXT4_MB_HINT_NOPREALLOC
 0x0040

	)

132 
	#PXT4_MB_HINT_GROUP_ALLOC
 0x0080

	)

134 
	#PXT4_MB_HINT_GOAL_ONLY
 0x0100

	)

136 
	#PXT4_MB_HINT_TRY_GOAL
 0x0200

	)

138 
	#PXT4_MB_DELALLOC_RESERVED
 0x0400

	)

140 
	#PXT4_MB_STREAM_ALLOC
 0x0800

	)

142 
	#PXT4_MB_USE_ROOT_BLOCKS
 0x1000

	)

144 
	#PXT4_MB_USE_RESERVED
 0x2000

	)

146 
	spxt4_Æloˇti⁄_ªque°
 {

148 
öode
 *
	möode
;

150 
	mÀn
;

152 
pxt4_lblk_t
 
	mlogiˇl
;

154 
pxt4_lblk_t
 
	mŒe·
;

156 
pxt4_lblk_t
 
	mÃight
;

158 
pxt4_fsblk_t
 
	mgﬂl
;

160 
pxt4_fsblk_t
 
	m∂e·
;

162 
pxt4_fsblk_t
 
	m¥ight
;

164 
	mÊags
;

174 
	#PXT4_MAP_NEW
 (1 << 
BH_New
)

	)

175 
	#PXT4_MAP_MAPPED
 (1 << 
BH_M≠≥d
)

	)

176 
	#PXT4_MAP_UNWRITTEN
 (1 << 
BH_Unwrôãn
)

	)

177 
	#PXT4_MAP_BOUNDARY
 (1 << 
BH_Bound¨y
)

	)

178 
	#PXT4_MAP_FLAGS
 (
PXT4_MAP_NEW
 | 
PXT4_MAP_MAPPED
 |\

179 
PXT4_MAP_UNWRITTEN
 | 
PXT4_MAP_BOUNDARY
)

	)

181 
	spxt4_m≠_blocks
 {

182 
pxt4_fsblk_t
 
	mm_pblk
;

183 
pxt4_lblk_t
 
	mm_lblk
;

184 
	mm_Àn
;

185 
	mm_Êags
;

191 
	spxt4_sy°em_blocks
 {

192 
rb_roŸ
 
	mroŸ
;

193 
rcu_hód
 
	mrcu
;

199 
	#PXT4_IO_END_UNWRITTEN
 0x0001

	)

205 
	spxt4_io_íd
 {

206 
li°_hód
 
	mli°
;

207 
h™dÀ_t
 *
	mh™dÀ
;

209 
öode
 *
	möode
;

210 
bio
 *
	mbio
;

212 
	mÊag
;

213 
©omic_t
 
	mcou¡
;

214 
loff_t
 
	moff£t
;

215 
ssize_t
 
	msize
;

216 } 
	tpxt4_io_íd_t
;

218 
	spxt4_io_submô
 {

219 
wrôeback_c⁄åﬁ
 *
	mio_wbc
;

220 
bio
 *
	mio_bio
;

221 
pxt4_io_íd_t
 *
	mio_íd
;

222 
£˘‹_t
 
	mio_√xt_block
;

228 
	#PXT4_BAD_INO
 1

	)

229 
	#PXT4_ROOT_INO
 2

	)

230 
	#PXT4_USR_QUOTA_INO
 3

	)

231 
	#PXT4_GRP_QUOTA_INO
 4

	)

232 
	#PXT4_BOOT_LOADER_INO
 5

	)

233 
	#PXT4_UNDEL_DIR_INO
 6

	)

234 
	#PXT4_RESIZE_INO
 7

	)

235 
	#PXT4_JOURNAL_INO
 8

	)

238 
	#PXT4_GOOD_OLD_FIRST_INO
 11

	)

243 
	#PXT4_LINK_MAX
 65000

	)

248 
	#PXT4_MIN_BLOCK_SIZE
 1024

	)

249 
	#PXT4_MAX_BLOCK_SIZE
 65536

	)

250 
	#PXT4_MIN_BLOCK_LOG_SIZE
 10

	)

251 
	#PXT4_MAX_BLOCK_LOG_SIZE
 16

	)

252 
	#PXT4_MAX_CLUSTER_LOG_SIZE
 30

	)

253 #ifde‡
__KERNEL__


254 
	#PXT4_BLOCK_SIZE
(
s
Ë((s)->
s_blocksize
)

	)

256 
	#PXT4_BLOCK_SIZE
(
s
Ë(
PXT4_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

258 
	#PXT4_ADDR_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ (
__u32
))

	)

259 
	#PXT4_CLUSTER_SIZE
(
s
Ë(
	`PXT4_BLOCK_SIZE
(s) << \

260 
	`PXT4_SB
(
s
)->
s_˛u°î_bôs
)

	)

261 #ifde‡
__KERNEL__


262 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_blocksize_bôs
)

	)

263 
	#PXT4_CLUSTER_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°î_bôs
)

	)

265 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_log_block_size
 + 10)

	)

267 #ifde‡
__KERNEL__


268 
	#PXT4_ADDR_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_addr_≥r_block_bôs
)

	)

269 
	#PXT4_INODE_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_öode_size
)

	)

270 
	#PXT4_FIRST_INO
(
s
Ë(
	`PXT4_SB
(s)->
s_fú°_öo
)

	)

272 
	#PXT4_INODE_SIZE
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

273 
PXT4_GOOD_OLD_INODE_SIZE
 : \

274 (
s
)->
s_öode_size
)

	)

275 
	#PXT4_FIRST_INO
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

276 
PXT4_GOOD_OLD_FIRST_INO
 : \

277 (
s
)->
s_fú°_öo
)

	)

279 
	#PXT4_BLOCK_ALIGN
(
size
, 
blkbôs
Ë
	`ALIGN
((size), (1 << (blkbôs)))

	)

280 
	#PXT4_MAX_BLOCKS
(
size
, 
off£t
, 
blkbôs
) \

281 ((
	`PXT4_BLOCK_ALIGN
(
size
 + 
off£t
, 
blkbôs
) >> blkbits) - (offset >> \

282 
blkbôs
))

	)

285 
	#PXT4_B2C
(
sbi
, 
blk
Ë((blkË>> (sbi)->
s_˛u°î_bôs
)

	)

287 
	#PXT4_C2B
(
sbi
, 
˛u°î
Ë((˛u°îË<< (sbi)->
s_˛u°î_bôs
)

	)

289 
	#PXT4_NUM_B2C
(
sbi
, 
blks
Ë(((blksË+ (sbi)->
s_˛u°î_øtio
 - 1) >> \

290 (
sbi
)->
s_˛u°î_bôs
)

	)

292 
	#PXT4_PBLK_CMASK
(
s
, 
pblk
) ((pblk) & \

293 ~((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

294 
	#PXT4_LBLK_CMASK
(
s
, 
lblk
) ((lblk) & \

295 ~((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

297 
	#PXT4_LBLK_CFILL
(
sbi
, 
lblk
) ((lblk) | \

298 ((
pxt4_lblk_t
Ë(
sbi
)->
s_˛u°î_øtio
 - 1))

	)

300 
	#PXT4_PBLK_COFF
(
s
, 
pblk
) ((pblk) & \

301 ((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

302 
	#PXT4_LBLK_COFF
(
s
, 
lblk
) ((lblk) & \

303 ((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

308 
	spxt4_group_desc


310 
__À32
 
	mbg_block_bôm≠_lo
;

311 
__À32
 
	mbg_öode_bôm≠_lo
;

312 
__À32
 
	mbg_öode_èbÀ_lo
;

313 
__À16
 
	mbg_‰ì_blocks_cou¡_lo
;

314 
__À16
 
	mbg_‰ì_öodes_cou¡_lo
;

315 
__À16
 
	mbg_u£d_dús_cou¡_lo
;

316 
__À16
 
	mbg_Êags
;

317 
__À32
 
	mbg_ex˛ude_bôm≠_lo
;

318 
__À16
 
	mbg_block_bôm≠_csum_lo
;

319 
__À16
 
	mbg_öode_bôm≠_csum_lo
;

320 
__À16
 
	mbg_ôabÀ_unu£d_lo
;

321 
__À16
 
	mbg_checksum
;

322 
__À32
 
	mbg_block_bôm≠_hi
;

323 
__À32
 
	mbg_öode_bôm≠_hi
;

324 
__À32
 
	mbg_öode_èbÀ_hi
;

325 
__À16
 
	mbg_‰ì_blocks_cou¡_hi
;

326 
__À16
 
	mbg_‰ì_öodes_cou¡_hi
;

327 
__À16
 
	mbg_u£d_dús_cou¡_hi
;

328 
__À16
 
	mbg_ôabÀ_unu£d_hi
;

329 
__À32
 
	mbg_ex˛ude_bôm≠_hi
;

330 
__À16
 
	mbg_block_bôm≠_csum_hi
;

331 
__À16
 
	mbg_öode_bôm≠_csum_hi
;

332 
__u32
 
	mbg_ª£rved
;

335 
	#PXT4_BG_INODE_BITMAP_CSUM_HI_END
 \

336 (
	`off£tof
(
pxt4_group_desc
, 
bg_öode_bôm≠_csum_hi
) + \

337 (
__À16
))

	)

338 
	#PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
 \

339 (
	`off£tof
(
pxt4_group_desc
, 
bg_block_bôm≠_csum_hi
) + \

340 (
__À16
))

	)

346 
	sÊex_groups
 {

347 
©omic64_t
 
	m‰ì_˛u°îs
;

348 
©omic_t
 
	m‰ì_öodes
;

349 
©omic_t
 
	mu£d_dús
;

352 
	#PXT4_BG_INODE_UNINIT
 0x0001

	)

353 
	#PXT4_BG_BLOCK_UNINIT
 0x0002

	)

354 
	#PXT4_BG_INODE_ZEROED
 0x0004

	)

359 
	#PXT4_MIN_DESC_SIZE
 32

	)

360 
	#PXT4_MIN_DESC_SIZE_64BIT
 64

	)

361 
	#PXT4_MAX_DESC_SIZE
 
PXT4_MIN_BLOCK_SIZE


	)

362 
	#PXT4_DESC_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_size
)

	)

363 #ifde‡
__KERNEL__


364 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_blocks_≥r_group
)

	)

365 
	#PXT4_CLUSTERS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°îs_≥r_group
)

	)

366 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block
)

	)

367 
	#PXT4_INODES_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_öodes_≥r_group
)

	)

368 
	#PXT4_DESC_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block_bôs
)

	)

370 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë((s)->
s_blocks_≥r_group
)

	)

371 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ 
	`PXT4_DESC_SIZE
(s))

	)

372 
	#PXT4_INODES_PER_GROUP
(
s
Ë((s)->
s_öodes_≥r_group
)

	)

378 
	#PXT4_NDIR_BLOCKS
 12

	)

379 
	#PXT4_IND_BLOCK
 
PXT4_NDIR_BLOCKS


	)

380 
	#PXT4_DIND_BLOCK
 (
PXT4_IND_BLOCK
 + 1)

	)

381 
	#PXT4_TIND_BLOCK
 (
PXT4_DIND_BLOCK
 + 1)

	)

382 
	#PXT4_N_BLOCKS
 (
PXT4_TIND_BLOCK
 + 1)

	)

387 
	#PXT4_SECRM_FL
 0x00000001

	)

388 
	#PXT4_UNRM_FL
 0x00000002

	)

389 
	#PXT4_COMPR_FL
 0x00000004

	)

390 
	#PXT4_SYNC_FL
 0x00000008

	)

391 
	#PXT4_IMMUTABLE_FL
 0x00000010

	)

392 
	#PXT4_APPEND_FL
 0x00000020

	)

393 
	#PXT4_NODUMP_FL
 0x00000040

	)

394 
	#PXT4_NOATIME_FL
 0x00000080

	)

396 
	#PXT4_DIRTY_FL
 0x00000100

	)

397 
	#PXT4_COMPRBLK_FL
 0x00000200

	)

398 
	#PXT4_NOCOMPR_FL
 0x00000400

	)

400 
	#PXT4_ENCRYPT_FL
 0x00000800

	)

402 
	#PXT4_INDEX_FL
 0x00001000

	)

403 
	#PXT4_IMAGIC_FL
 0x00002000

	)

404 
	#PXT4_JOURNAL_DATA_FL
 0x00004000

	)

405 
	#PXT4_NOTAIL_FL
 0x00008000

	)

406 
	#PXT4_DIRSYNC_FL
 0x00010000

	)

407 
	#PXT4_TOPDIR_FL
 0x00020000

	)

408 
	#PXT4_HUGE_FILE_FL
 0x00040000

	)

409 
	#PXT4_EXTENTS_FL
 0x00080000

	)

410 
	#PXT4_VERITY_FL
 0x00100000

	)

411 
	#PXT4_EA_INODE_FL
 0x00200000

	)

412 
	#PXT4_EOFBLOCKS_FL
 0x00400000

	)

413 
	#PXT4_INLINE_DATA_FL
 0x10000000

	)

414 
	#PXT4_PROJINHERIT_FL
 0x20000000

	)

415 
	#PXT4_CASEFOLD_FL
 0x40000000

	)

416 
	#PXT4_RESERVED_FL
 0x80000000

	)

418 
	#PXT4_FL_USER_VISIBLE
 0x705BDFFF

	)

419 
	#PXT4_FL_USER_MODIFIABLE
 0x604BC0FF

	)

422 
	#PXT4_FL_XFLAG_VISIBLE
 (
PXT4_SYNC_FL
 | \

423 
PXT4_IMMUTABLE_FL
 | \

424 
PXT4_APPEND_FL
 | \

425 
PXT4_NODUMP_FL
 | \

426 
PXT4_NOATIME_FL
 | \

427 
PXT4_PROJINHERIT_FL
)

	)

430 
	#PXT4_FL_INHERITED
 (
PXT4_SECRM_FL
 | 
PXT4_UNRM_FL
 | 
PXT4_COMPR_FL
 |\

431 
PXT4_SYNC_FL
 | 
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
 |\

432 
PXT4_NOCOMPR_FL
 | 
PXT4_JOURNAL_DATA_FL
 |\

433 
PXT4_NOTAIL_FL
 | 
PXT4_DIRSYNC_FL
 |\

434 
PXT4_PROJINHERIT_FL
 | 
PXT4_CASEFOLD_FL
)

	)

437 
	#PXT4_REG_FLMASK
 (~(
PXT4_DIRSYNC_FL
 | 
PXT4_TOPDIR_FL
 | 
PXT4_CASEFOLD_FL
 |\

438 
PXT4_PROJINHERIT_FL
))

	)

441 
	#PXT4_OTHER_FLMASK
 (
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
)

	)

444 
	#PXT4_FL_SHOULD_SWAP
 (
PXT4_HUGE_FILE_FL
 | 
PXT4_EXTENTS_FL
)

	)

447 
ölöe
 
__u32
 
	$pxt4_mask_Êags
(
umode_t
 
mode
, 
__u32
 
Êags
)

449 i‡(
	`S_ISDIR
(
mode
))

450  
Êags
;

451 i‡(
	`S_ISREG
(
mode
))

452  
Êags
 & 
PXT4_REG_FLMASK
;

454  
Êags
 & 
PXT4_OTHER_FLMASK
;

455 
	}
}

461 
	mPXT4_INODE_SECRM
 = 0,

462 
	mPXT4_INODE_UNRM
 = 1,

463 
	mPXT4_INODE_COMPR
 = 2,

464 
	mPXT4_INODE_SYNC
 = 3,

465 
	mPXT4_INODE_IMMUTABLE
 = 4,

466 
	mPXT4_INODE_APPEND
 = 5,

467 
	mPXT4_INODE_NODUMP
 = 6,

468 
	mPXT4_INODE_NOATIME
 = 7,

470 
	mPXT4_INODE_DIRTY
 = 8,

471 
	mPXT4_INODE_COMPRBLK
 = 9,

472 
	mPXT4_INODE_NOCOMPR
 = 10,

473 
	mPXT4_INODE_ENCRYPT
 = 11,

475 
	mPXT4_INODE_INDEX
 = 12,

476 
	mPXT4_INODE_IMAGIC
 = 13,

477 
	mPXT4_INODE_JOURNAL_DATA
 = 14,

478 
	mPXT4_INODE_NOTAIL
 = 15,

479 
	mPXT4_INODE_DIRSYNC
 = 16,

480 
	mPXT4_INODE_TOPDIR
 = 17,

481 
	mPXT4_INODE_HUGE_FILE
 = 18,

482 
	mPXT4_INODE_EXTENTS
 = 19,

483 
	mPXT4_INODE_VERITY
 = 20,

484 
	mPXT4_INODE_EA_INODE
 = 21,

485 
	mPXT4_INODE_EOFBLOCKS
 = 22,

486 
	mPXT4_INODE_INLINE_DATA
 = 28,

487 
	mPXT4_INODE_PROJINHERIT
 = 29,

488 
	mPXT4_INODE_RESERVED
 = 31,

504 
	#TEST_FLAG_VALUE
(
FLAG
Ë(
PXT4_
##FLAG##
_FL
 =(1 << 
PXT4_INODE_
##FLAG))

	)

505 
	#CHECK_FLAG_VALUE
(
FLAG
Ë
	`BUILD_BUG_ON
(!
	`TEST_FLAG_VALUE
(FLAG))

	)

507 
ölöe
 
	$pxt4_check_Êag_vÆues
()

509 
	`CHECK_FLAG_VALUE
(
SECRM
);

510 
	`CHECK_FLAG_VALUE
(
UNRM
);

511 
	`CHECK_FLAG_VALUE
(
COMPR
);

512 
	`CHECK_FLAG_VALUE
(
SYNC
);

513 
	`CHECK_FLAG_VALUE
(
IMMUTABLE
);

514 
	`CHECK_FLAG_VALUE
(
APPEND
);

515 
	`CHECK_FLAG_VALUE
(
NODUMP
);

516 
	`CHECK_FLAG_VALUE
(
NOATIME
);

517 
	`CHECK_FLAG_VALUE
(
DIRTY
);

518 
	`CHECK_FLAG_VALUE
(
COMPRBLK
);

519 
	`CHECK_FLAG_VALUE
(
NOCOMPR
);

520 
	`CHECK_FLAG_VALUE
(
ENCRYPT
);

521 
	`CHECK_FLAG_VALUE
(
INDEX
);

522 
	`CHECK_FLAG_VALUE
(
IMAGIC
);

523 
	`CHECK_FLAG_VALUE
(
JOURNAL_DATA
);

524 
	`CHECK_FLAG_VALUE
(
NOTAIL
);

525 
	`CHECK_FLAG_VALUE
(
DIRSYNC
);

526 
	`CHECK_FLAG_VALUE
(
TOPDIR
);

527 
	`CHECK_FLAG_VALUE
(
HUGE_FILE
);

528 
	`CHECK_FLAG_VALUE
(
EXTENTS
);

529 
	`CHECK_FLAG_VALUE
(
VERITY
);

530 
	`CHECK_FLAG_VALUE
(
EA_INODE
);

531 
	`CHECK_FLAG_VALUE
(
EOFBLOCKS
);

532 
	`CHECK_FLAG_VALUE
(
INLINE_DATA
);

533 
	`CHECK_FLAG_VALUE
(
PROJINHERIT
);

534 
	`CHECK_FLAG_VALUE
(
RESERVED
);

535 
	}
}

538 
	spxt4_√w_group_öput
 {

539 
__u32
 
	mgroup
;

540 
__u64
 
	mblock_bôm≠
;

541 
__u64
 
	möode_bôm≠
;

542 
__u64
 
	möode_èbÀ
;

543 
__u32
 
	mblocks_cou¡
;

544 
__u16
 
	mª£rved_blocks
;

545 
__u16
 
	munu£d
;

548 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

549 
	scom∑t_pxt4_√w_group_öput
 {

550 
u32
 
	mgroup
;

551 
com∑t_u64
 
	mblock_bôm≠
;

552 
com∑t_u64
 
	möode_bôm≠
;

553 
com∑t_u64
 
	möode_èbÀ
;

554 
u32
 
	mblocks_cou¡
;

555 
u16
 
	mª£rved_blocks
;

556 
u16
 
	munu£d
;

561 
	spxt4_√w_group_d©a
 {

562 
__u32
 
	mgroup
;

563 
__u64
 
	mblock_bôm≠
;

564 
__u64
 
	möode_bôm≠
;

565 
__u64
 
	möode_èbÀ
;

566 
__u32
 
	mblocks_cou¡
;

567 
__u16
 
	mª£rved_blocks
;

568 
__u16
 
	mmd©a_blocks
;

569 
__u32
 
	m‰ì_˛u°îs_cou¡
;

574 
	mBLOCK_BITMAP
 = 0,

575 
	mINODE_BITMAP
,

576 
	mINODE_TABLE
,

577 
	mGROUP_TABLE_COUNT
,

585 
	#PXT4_GET_BLOCKS_CREATE
 0x0001

	)

587 
	#PXT4_GET_BLOCKS_UNWRIT_EXT
 0x0002

	)

588 
	#PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
 (
PXT4_GET_BLOCKS_UNWRIT_EXT
|\

589 
PXT4_GET_BLOCKS_CREATE
)

	)

592 
	#PXT4_GET_BLOCKS_DELALLOC_RESERVE
 0x0004

	)

596 
	#PXT4_GET_BLOCKS_PRE_IO
 0x0008

	)

597 
	#PXT4_GET_BLOCKS_CONVERT
 0x0010

	)

598 
	#PXT4_GET_BLOCKS_IO_CREATE_EXT
 (
PXT4_GET_BLOCKS_PRE_IO
|\

599 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

601 
	#PXT4_GET_BLOCKS_IO_CONVERT_EXT
 (
PXT4_GET_BLOCKS_CONVERT
|\

602 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

605 
	#PXT4_GET_BLOCKS_METADATA_NOFAIL
 0x0020

	)

607 
	#PXT4_GET_BLOCKS_NO_NORMALIZE
 0x0040

	)

609 
	#PXT4_GET_BLOCKS_KEEP_SIZE
 0x0080

	)

611 
	#PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 0x0100

	)

613 
	#PXT4_GET_BLOCKS_ZERO
 0x0200

	)

614 
	#PXT4_GET_BLOCKS_CREATE_ZERO
 (
PXT4_GET_BLOCKS_CREATE
 |\

615 
PXT4_GET_BLOCKS_ZERO
)

	)

618 
	#PXT4_GET_BLOCKS_IO_SUBMIT
 0x0400

	)

629 
	#PXT4_EX_NOCACHE
 0x40000000

	)

630 
	#PXT4_EX_FORCE_CACHE
 0x20000000

	)

635 
	#PXT4_FREE_BLOCKS_METADATA
 0x0001

	)

636 
	#PXT4_FREE_BLOCKS_FORGET
 0x0002

	)

637 
	#PXT4_FREE_BLOCKS_VALIDATED
 0x0004

	)

638 
	#PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 0x0008

	)

639 
	#PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
 0x0010

	)

640 
	#PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
 0x0020

	)

641 
	#PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
 0x0040

	)

646 
	#PXT4_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

647 
	#PXT4_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

648 
	#PXT4_IOC_GETVERSION
 
	`_IOR
('f', 3, )

	)

649 
	#PXT4_IOC_SETVERSION
 
	`_IOW
('f', 4, )

	)

650 
	#PXT4_IOC_GETVERSION_OLD
 
FS_IOC_GETVERSION


	)

651 
	#PXT4_IOC_SETVERSION_OLD
 
FS_IOC_SETVERSION


	)

652 
	#PXT4_IOC_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

653 
	#PXT4_IOC_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

654 
	#PXT4_IOC_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

655 
	#PXT4_IOC_GROUP_ADD
 
	`_IOW
('f', 8, 
pxt4_√w_group_öput
)

	)

656 
	#PXT4_IOC_MIGRATE
 
	`_IO
('f', 9)

	)

659 
	#PXT4_IOC_ALLOC_DA_BLKS
 
	`_IO
('f', 12)

	)

660 
	#PXT4_IOC_MOVE_EXT
 
	`_IOWR
('f', 15, 
move_exã¡
)

	)

661 
	#PXT4_IOC_RESIZE_FS
 
	`_IOW
('f', 16, 
__u64
)

	)

662 
	#PXT4_IOC_SWAP_BOOT
 
	`_IO
('f', 17)

	)

663 
	#PXT4_IOC_PRECACHE_EXTENTS
 
	`_IO
('f', 18)

	)

664 
	#PXT4_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

665 
	#PXT4_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

666 
	#PXT4_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

668 
	#PXT4_IOC_CLEAR_ES_CACHE
 
	`_IO
('f', 40)

	)

669 
	#PXT4_IOC_GETSTATE
 
	`_IOW
('f', 41, 
__u32
)

	)

670 
	#PXT4_IOC_GET_ES_CACHE
 
	`_IOWR
('f', 42, 
fõm≠
)

	)

672 
	#PXT4_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

673 
	#PXT4_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

675 
	#PXT4_IOC_SHUTDOWN
 
	`_IOR
 ('X', 125, 
__u32
)

	)

680 
	#PXT4_GOING_FLAGS_DEFAULT
 0x0

	)

681 
	#PXT4_GOING_FLAGS_LOGFLUSH
 0x1

	)

682 
	#PXT4_GOING_FLAGS_NOLOGFLUSH
 0x2

	)

690 
	#PXT4_STATE_FLAG_EXT_PRECACHED
 0x00000001

	)

691 
	#PXT4_STATE_FLAG_NEW
 0x00000002

	)

692 
	#PXT4_STATE_FLAG_NEWENTRY
 0x00000004

	)

693 
	#PXT4_STATE_FLAG_DA_ALLOC_CLOSE
 0x00000008

	)

695 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

699 
	#PXT4_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

700 
	#PXT4_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

701 
	#PXT4_IOC32_GETVERSION
 
	`_IOR
('f', 3, )

	)

702 
	#PXT4_IOC32_SETVERSION
 
	`_IOW
('f', 4, )

	)

703 
	#PXT4_IOC32_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

704 
	#PXT4_IOC32_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

705 
	#PXT4_IOC32_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

706 
	#PXT4_IOC32_GROUP_ADD
 
	`_IOW
('f', 8, 
com∑t_pxt4_√w_group_öput
)

	)

707 
	#PXT4_IOC32_GETVERSION_OLD
 
FS_IOC32_GETVERSION


	)

708 
	#PXT4_IOC32_SETVERSION_OLD
 
FS_IOC32_SETVERSION


	)

715 
	#PXT4_FIEMAP_EXTENT_HOLE
 0x08000000

	)

718 
	#PXT4_MAX_BLOCK_FILE_PHYS
 0xFFFFFFFF

	)

721 
	#PXT4_MAX_LOGICAL_BLOCK
 0xFFFFFFFF

	)

726 
	spxt4_öode
 {

727 
__À16
 
	mi_mode
;

728 
__À16
 
	mi_uid
;

729 
__À32
 
	mi_size_lo
;

730 
__À32
 
	mi_©ime
;

731 
__À32
 
	mi_˘ime
;

732 
__À32
 
	mi_mtime
;

733 
__À32
 
	mi_dtime
;

734 
__À16
 
	mi_gid
;

735 
__À16
 
	mi_löks_cou¡
;

736 
__À32
 
	mi_blocks_lo
;

737 
__À32
 
	mi_Êags
;

740 
__À32
 
	ml_i_vîsi⁄
;

741 } 
	mlöux1
;

743 
__u32
 
	mh_i_å™¶©‹
;

744 } 
	mhurd1
;

746 
__u32
 
	mm_i_ª£rved1
;

747 } 
	mmasix1
;

748 } 
	mosd1
;

749 
__À32
 
	mi_block
[
PXT4_N_BLOCKS
];

750 
__À32
 
	mi_gíî©i⁄
;

751 
__À32
 
	mi_fûe_a˛_lo
;

752 
__À32
 
	mi_size_high
;

753 
__À32
 
	mi_obso_Áddr
;

756 
__À16
 
	ml_i_blocks_high
;

757 
__À16
 
	ml_i_fûe_a˛_high
;

758 
__À16
 
	ml_i_uid_high
;

759 
__À16
 
	ml_i_gid_high
;

760 
__À16
 
	ml_i_checksum_lo
;

761 
__À16
 
	ml_i_ª£rved
;

762 } 
	mlöux2
;

764 
__À16
 
	mh_i_ª£rved1
;

765 
__u16
 
	mh_i_mode_high
;

766 
__u16
 
	mh_i_uid_high
;

767 
__u16
 
	mh_i_gid_high
;

768 
__u32
 
	mh_i_auth‹
;

769 } 
	mhurd2
;

771 
__À16
 
	mh_i_ª£rved1
;

772 
__À16
 
	mm_i_fûe_a˛_high
;

773 
__u32
 
	mm_i_ª£rved2
[2];

774 } 
	mmasix2
;

775 } 
	mosd2
;

776 
__À16
 
	mi_exåa_isize
;

777 
__À16
 
	mi_checksum_hi
;

778 
__À32
 
	mi_˘ime_exåa
;

779 
__À32
 
	mi_mtime_exåa
;

780 
__À32
 
	mi_©ime_exåa
;

781 
__À32
 
	mi_¸time
;

782 
__À32
 
	mi_¸time_exåa
;

783 
__À32
 
	mi_vîsi⁄_hi
;

784 
__À32
 
	mi_¥ojid
;

787 
	smove_exã¡
 {

788 
__u32
 
	mª£rved
;

789 
__u32
 
	md⁄‹_fd
;

790 
__u64
 
	m‹ig_°¨t
;

791 
__u64
 
	md⁄‹_°¨t
;

792 
__u64
 
	mÀn
;

793 
__u64
 
	mmoved_Àn
;

796 
	#PXT4_EPOCH_BITS
 2

	)

797 
	#PXT4_EPOCH_MASK
 ((1 << 
PXT4_EPOCH_BITS
Ë- 1)

	)

798 
	#PXT4_NSEC_MASK
 (~0UL << 
PXT4_EPOCH_BITS
)

	)

810 
	#PXT4_FITS_IN_INODE
(
pxt4_öode
, 
eöode
, 
fõld
) \

811 ((
	`off£tof
(
	`ty≥of
(*
pxt4_öode
), 
fõld
) + \

812 ((
pxt4_öode
)->
fõld
)) \

813 <(
PXT4_GOOD_OLD_INODE_SIZE
 + \

814 (
eöode
)->
i_exåa_isize
)) \

815 

	)

837 
ölöe
 
__À32
 
	$pxt4_ícode_exåa_time
(
time•ec64
 *
time
)

839 
u32
 
exåa
 =((
time
->
tv_£c
 - (
s32
Èime->tv_£cË>> 32Ë& 
PXT4_EPOCH_MASK
;

840  
	`˝u_to_À32
(
exåa
 | (
time
->
tv_n£c
 << 
PXT4_EPOCH_BITS
));

841 
	}
}

843 
ölöe
 
	$pxt4_decode_exåa_time
(
time•ec64
 *
time
,

844 
__À32
 
exåa
)

846 i‡(
	`u∆ikñy
(
exåa
 & 
	`˝u_to_À32
(
PXT4_EPOCH_MASK
)))

847 
time
->
tv_£c
 +(
u64
)(
	`À32_to_˝u
(
exåa
Ë& 
PXT4_EPOCH_MASK
) << 32;

848 
time
->
tv_n£c
 = (
	`À32_to_˝u
(
exåa
Ë& 
PXT4_NSEC_MASK
Ë>> 
PXT4_EPOCH_BITS
;

849 
	}
}

851 
	#PXT4_INODE_SET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

853 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) {\

854 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
öode
)->xtime.
tv_£c
); \

855 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

856 
	`pxt4_ícode_exåa_time
(&(
öode
)->
xtime
); \

859 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
(
	`˛amp_t
(
öt32_t
, (
öode
)->xtime.
tv_£c
, 
S32_MIN
, 
S32_MAX
)); \

860 } 0)

	)

862 
	#PXT4_EINODE_SET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

864 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

865 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
eöode
)->xtime.
tv_£c
); \

866 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

867 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

868 
	`pxt4_ícode_exåa_time
(&(
eöode
)->
xtime
); \

869 } 0)

	)

871 
	#PXT4_INODE_GET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

873 (
öode
)->
xtime
.
tv_£c
 = (sig√d)
	`À32_to_˝u
((
øw_öode
)->xtime); \

874 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) { \

875 
	`pxt4_decode_exåa_time
(&(
öode
)->
xtime
, \

876 
øw_öode
->
xtime
 ## 
_exåa
); \

879 (
öode
)->
xtime
.
tv_n£c
 = 0; \

880 } 0)

	)

883 
	#PXT4_EINODE_GET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

885 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

886 (
eöode
)->
xtime
.
tv_£c
 = \

887 (sig√d)
	`À32_to_˝u
((
øw_öode
)->
xtime
); \

889 (
eöode
)->
xtime
.
tv_£c
 = 0; \

890 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

891 
	`pxt4_decode_exåa_time
(&(
eöode
)->
xtime
, \

892 
øw_öode
->
xtime
 ## 
_exåa
); \

894 (
eöode
)->
xtime
.
tv_n£c
 = 0; \

895 } 0)

	)

897 
	#i_disk_vîsi⁄
 
osd1
.
löux1
.
l_i_vîsi⁄


	)

899 #i‡
deföed
(
__KERNEL__
Ë|| deföed(
__löux__
)

900 
	#i_ª£rved1
 
osd1
.
löux1
.
l_i_ª£rved1


	)

901 
	#i_fûe_a˛_high
 
osd2
.
löux2
.
l_i_fûe_a˛_high


	)

902 
	#i_blocks_high
 
osd2
.
löux2
.
l_i_blocks_high


	)

903 
	#i_uid_low
 
i_uid


	)

904 
	#i_gid_low
 
i_gid


	)

905 
	#i_uid_high
 
osd2
.
löux2
.
l_i_uid_high


	)

906 
	#i_gid_high
 
osd2
.
löux2
.
l_i_gid_high


	)

907 
	#i_checksum_lo
 
osd2
.
löux2
.
l_i_checksum_lo


	)

909 #ñi‡
deföed
(
__GNU__
)

911 
	#i_å™¶©‹
 
osd1
.
hurd1
.
h_i_å™¶©‹


	)

912 
	#i_uid_high
 
osd2
.
hurd2
.
h_i_uid_high


	)

913 
	#i_gid_high
 
osd2
.
hurd2
.
h_i_gid_high


	)

914 
	#i_auth‹
 
osd2
.
hurd2
.
h_i_auth‹


	)

916 #ñi‡
deföed
(
__masix__
)

918 
	#i_ª£rved1
 
osd1
.
masix1
.
m_i_ª£rved1


	)

919 
	#i_fûe_a˛_high
 
osd2
.
masix2
.
m_i_fûe_a˛_high


	)

920 
	#i_ª£rved2
 
osd2
.
masix2
.
m_i_ª£rved2


	)

924 
	~"exã¡s_°©us.h
"

943 
	mI_DATA_SEM_NORMAL
 = 0,

944 
	mI_DATA_SEM_OTHER
,

945 
	mI_DATA_SEM_QUOTA
,

952 
	spxt4_öode_öfo
 {

953 
__À32
 
	mi_d©a
[15];

954 
__u32
 
	mi_dtime
;

955 
pxt4_fsblk_t
 
	mi_fûe_a˛
;

964 
pxt4_group_t
 
	mi_block_group
;

965 
pxt4_lblk_t
 
	mi_dú_°¨t_lookup
;

966 #i‡(
BITS_PER_LONG
 < 64)

967 
	mi_°©e_Êags
;

969 
	mi_Êags
;

978 
rw_£m≠h‹e
 
	mx©å_£m
;

980 
li°_hód
 
	mi_‹ph™
;

997 
loff_t
 
	mi_disksize
;

1009 
rw_£m≠h‹e
 
	mi_d©a_£m
;

1018 
rw_£m≠h‹e
 
	mi_mm≠_£m
;

1019 
öode
 
	mvfs_öode
;

1020 
jbd3_öode
 *
	mjöode
;

1022 
•ölock_t
 
	mi_øw_lock
;

1028 
time•ec64
 
	mi_¸time
;

1031 
li°_hód
 
	mi_¥óŒoc_li°
;

1032 
•ölock_t
 
	mi_¥óŒoc_lock
;

1035 
pxt4_es_åì
 
	mi_es_åì
;

1036 
rwlock_t
 
	mi_es_lock
;

1037 
li°_hód
 
	mi_es_li°
;

1038 
	mi_es_Æl_ƒ
;

1039 
	mi_es_shk_ƒ
;

1040 
pxt4_lblk_t
 
	mi_es_shrök_lblk
;

1045 
pxt4_group_t
 
	mi_œ°_Æloc_group
;

1049 
	mi_ª£rved_d©a_blocks
;

1050 
pxt4_lblk_t
 
	mi_da_mëad©a_ˇlc_œ°_lblock
;

1051 
	mi_da_mëad©a_ˇlc_Àn
;

1054 
pxt4_≥ndög_åì
 
	mi_≥ndög_åì
;

1057 
__u16
 
	mi_exåa_isize
;

1060 
u16
 
	mi_ölöe_off
;

1061 
u16
 
	mi_ölöe_size
;

1063 #ifde‡
CONFIG_QUOTA


1065 
qsize_t
 
	mi_ª£rved_quŸa
;

1069 
•ölock_t
 
	mi_com∂ëed_io_lock
;

1074 
li°_hód
 
	mi_rsv_c⁄vîsi⁄_li°
;

1075 
w‹k_°ru˘
 
	mi_rsv_c⁄vîsi⁄_w‹k
;

1076 
©omic_t
 
	mi_unwrôãn
;

1078 
•ölock_t
 
	mi_block_ª£rv©i⁄_lock
;

1084 
tid_t
 
	mi_sync_tid
;

1085 
tid_t
 
	mi_d©async_tid
;

1087 #ifde‡
CONFIG_QUOTA


1088 
dquŸ
 *
	mi_dquŸ
[
MAXQUOTAS
];

1092 
__u32
 
	mi_csum_£ed
;

1094 
k¥ojid_t
 
	mi_¥ojid
;

1100 
	#PXT4_VALID_FS
 0x0001

	)

1101 
	#PXT4_ERROR_FS
 0x0002

	)

1102 
	#PXT4_ORPHAN_FS
 0x0004

	)

1107 
	#PXT2_FLAGS_SIGNED_HASH
 0x0001

	)

1108 
	#PXT2_FLAGS_UNSIGNED_HASH
 0x0002

	)

1109 
	#PXT2_FLAGS_TEST_FILESYS
 0x0004

	)

1114 
	#PXT4_MOUNT_NO_MBCACHE
 0x00001

	)

1115 
	#PXT4_MOUNT_GRPID
 0x00004

	)

1116 
	#PXT4_MOUNT_DEBUG
 0x00008

	)

1117 
	#PXT4_MOUNT_ERRORS_CONT
 0x00010

	)

1118 
	#PXT4_MOUNT_ERRORS_RO
 0x00020

	)

1119 
	#PXT4_MOUNT_ERRORS_PANIC
 0x00040

	)

1120 
	#PXT4_MOUNT_ERRORS_MASK
 0x00070

	)

1121 
	#PXT4_MOUNT_MINIX_DF
 0x00080

	)

1122 
	#PXT4_MOUNT_NOLOAD
 0x00100

	)

1123 #ifde‡
CONFIG_FS_DAX


1124 
	#PXT4_MOUNT_DAX
 0x00200

	)

1126 
	#PXT4_MOUNT_DAX
 0

	)

1128 
	#PXT4_MOUNT_DATA_FLAGS
 0x00C00

	)

1129 
	#PXT4_MOUNT_JOURNAL_DATA
 0x00400

	)

1130 
	#PXT4_MOUNT_ORDERED_DATA
 0x00800

	)

1131 
	#PXT4_MOUNT_WRITEBACK_DATA
 0x00C00

	)

1132 
	#PXT4_MOUNT_UPDATE_JOURNAL
 0x01000

	)

1133 
	#PXT4_MOUNT_NO_UID32
 0x02000

	)

1134 
	#PXT4_MOUNT_XATTR_USER
 0x04000

	)

1135 
	#PXT4_MOUNT_POSIX_ACL
 0x08000

	)

1136 
	#PXT4_MOUNT_NO_AUTO_DA_ALLOC
 0x10000

	)

1137 
	#PXT4_MOUNT_BARRIER
 0x20000

	)

1138 
	#PXT4_MOUNT_QUOTA
 0x40000

	)

1139 
	#PXT4_MOUNT_USRQUOTA
 0x80000

	)

1142 
	#PXT4_MOUNT_GRPQUOTA
 0x100000

	)

1145 
	#PXT4_MOUNT_PRJQUOTA
 0x200000

	)

1147 
	#PXT4_MOUNT_DIOREAD_NOLOCK
 0x400000

	)

1148 
	#PXT4_MOUNT_JOURNAL_CHECKSUM
 0x800000

	)

1149 
	#PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 0x1000000

	)

1150 
	#PXT4_MOUNT_WARN_ON_ERROR
 0x2000000

	)

1151 
	#PXT4_MOUNT_DELALLOC
 0x8000000

	)

1152 
	#PXT4_MOUNT_DATA_ERR_ABORT
 0x10000000

	)

1153 
	#PXT4_MOUNT_BLOCK_VALIDITY
 0x20000000

	)

1154 
	#PXT4_MOUNT_DISCARD
 0x40000000

	)

1155 
	#PXT4_MOUNT_INIT_INODE_TABLE
 0x80000000

	)

1162 
	#PXT4_MOUNT2_EXPLICIT_DELALLOC
 0x00000001

	)

1164 
	#PXT4_MOUNT2_STD_GROUP_SIZE
 0x00000002

	)

1167 
	#PXT4_MOUNT2_HURD_COMPAT
 0x00000004

	)

1170 
	#PXT4_MOUNT2_EXPLICIT_JOURNAL_CHECKSUM
 0x00000008

	)

1173 
	#˛ór_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 &= \

1174 ~
PXT4_MOUNT_
##
›t


	)

1175 
	#£t_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 |= \

1176 
PXT4_MOUNT_
##
›t


	)

1177 
	#ã°_›t
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t
 & \

1178 
PXT4_MOUNT_
##
›t
)

	)

1180 
	#˛ór_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 &= \

1181 ~
PXT4_MOUNT2_
##
›t


	)

1182 
	#£t_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 |= \

1183 
PXT4_MOUNT2_
##
›t


	)

1184 
	#ã°_›t2
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t2
 & \

1185 
PXT4_MOUNT2_
##
›t
)

	)

1187 
	#pxt4_ã°_™d_£t_bô
 
__ã°_™d_£t_bô_À


	)

1188 
	#pxt4_£t_bô
 
__£t_bô_À


	)

1189 
	#pxt4_£t_bô_©omic
 
pxt2_£t_bô_©omic


	)

1190 
	#pxt4_ã°_™d_˛ór_bô
 
__ã°_™d_˛ór_bô_À


	)

1191 
	#pxt4_˛ór_bô
 
__˛ór_bô_À


	)

1192 
	#pxt4_˛ór_bô_©omic
 
pxt2_˛ór_bô_©omic


	)

1193 
	#pxt4_ã°_bô
 
ã°_bô_À


	)

1194 
	#pxt4_föd_√xt_zîo_bô
 
föd_√xt_zîo_bô_À


	)

1195 
	#pxt4_föd_√xt_bô
 
föd_√xt_bô_À


	)

1197 
pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
);

1202 
	#PXT4_DFL_MAX_MNT_COUNT
 20

	)

1203 
	#PXT4_DFL_CHECKINTERVAL
 0

	)

1208 
	#PXT4_ERRORS_CONTINUE
 1

	)

1209 
	#PXT4_ERRORS_RO
 2

	)

1210 
	#PXT4_ERRORS_PANIC
 3

	)

1211 
	#PXT4_ERRORS_DEFAULT
 
PXT4_ERRORS_CONTINUE


	)

1214 
	#PXT4_CRC32C_CHKSUM
 1

	)

1219 
	spxt4_su≥r_block
 {

1220  
__À32
 
	ms_öodes_cou¡
;

1221 
__À32
 
	ms_blocks_cou¡_lo
;

1222 
__À32
 
	ms_r_blocks_cou¡_lo
;

1223 
__À32
 
	ms_‰ì_blocks_cou¡_lo
;

1224  
__À32
 
	ms_‰ì_öodes_cou¡
;

1225 
__À32
 
	ms_fú°_d©a_block
;

1226 
__À32
 
	ms_log_block_size
;

1227 
__À32
 
	ms_log_˛u°î_size
;

1228  
__À32
 
	ms_blocks_≥r_group
;

1229 
__À32
 
	ms_˛u°îs_≥r_group
;

1230 
__À32
 
	ms_öodes_≥r_group
;

1231 
__À32
 
	ms_mtime
;

1232  
__À32
 
	ms_wtime
;

1233 
__À16
 
	ms_m¡_cou¡
;

1234 
__À16
 
	ms_max_m¡_cou¡
;

1235 
__À16
 
	ms_magic
;

1236 
__À16
 
	ms_°©e
;

1237 
__À16
 
	ms_îr‹s
;

1238 
__À16
 
	ms_mö‹_ªv_Àvñ
;

1239  
__À32
 
	ms_œ°check
;

1240 
__À32
 
	ms_checköãrvÆ
;

1241 
__À32
 
	ms_¸ót‹_os
;

1242 
__À32
 
	ms_ªv_Àvñ
;

1243  
__À16
 
	ms_def_ªsuid
;

1244 
__À16
 
	ms_def_ªsgid
;

1258 
__À32
 
	ms_fú°_öo
;

1259 
__À16
 
	ms_öode_size
;

1260 
__À16
 
	ms_block_group_ƒ
;

1261 
__À32
 
	ms_„©uª_com∑t
;

1262  
__À32
 
	ms_„©uª_öcom∑t
;

1263 
__À32
 
	ms_„©uª_ro_com∑t
;

1264  
__u8
 
	ms_uuid
[16];

1265  
	ms_vﬁume_«me
[16];

1266  
	ms_œ°_mou¡ed
[64] 
	m__n⁄°rög
;

1267  
__À32
 
	ms_Æg‹ôhm_ußge_bôm≠
;

1272 
__u8
 
	ms_¥óŒoc_blocks
;

1273 
__u8
 
	ms_¥óŒoc_dú_blocks
;

1274 
__À16
 
	ms_ª£rved_gdt_blocks
;

1278  
__u8
 
	ms_jou∫Æ_uuid
[16];

1279  
__À32
 
	ms_jou∫Æ_öum
;

1280 
__À32
 
	ms_jou∫Æ_dev
;

1281 
__À32
 
	ms_œ°_‹ph™
;

1282 
__À32
 
	ms_hash_£ed
[4];

1283 
__u8
 
	ms_def_hash_vîsi⁄
;

1284 
__u8
 
	ms_j∆_backup_ty≥
;

1285 
__À16
 
	ms_desc_size
;

1286  
__À32
 
	ms_deÁu…_mou¡_›ts
;

1287 
__À32
 
	ms_fú°_mëa_bg
;

1288 
__À32
 
	ms_mkfs_time
;

1289 
__À32
 
	ms_j∆_blocks
[17];

1291  
__À32
 
	ms_blocks_cou¡_hi
;

1292 
__À32
 
	ms_r_blocks_cou¡_hi
;

1293 
__À32
 
	ms_‰ì_blocks_cou¡_hi
;

1294 
__À16
 
	ms_mö_exåa_isize
;

1295 
__À16
 
	ms_w™t_exåa_isize
;

1296 
__À32
 
	ms_Êags
;

1297 
__À16
 
	ms_øid_°ride
;

1298 
__À16
 
	ms_mmp_upd©e_öãrvÆ
;

1299 
__À64
 
	ms_mmp_block
;

1300 
__À32
 
	ms_øid_°rùe_width
;

1301 
__u8
 
	ms_log_groups_≥r_Êex
;

1302 
__u8
 
	ms_checksum_ty≥
;

1303 
__u8
 
	ms_í¸y±i⁄_Àvñ
;

1304 
__u8
 
	ms_ª£rved_∑d
;

1305 
__À64
 
	ms_kbyãs_wrôãn
;

1306 
__À32
 
	ms_¢≠shŸ_öum
;

1307 
__À32
 
	ms_¢≠shŸ_id
;

1308 
__À64
 
	ms_¢≠shŸ_r_blocks_cou¡
;

1310 
__À32
 
	ms_¢≠shŸ_li°
;

1312 
	#PXT4_S_ERR_START
 
	`off£tof
(
pxt4_su≥r_block
, 
s_îr‹_cou¡
)

	)

1313 
__À32
 
	ms_îr‹_cou¡
;

1314 
__À32
 
	ms_fú°_îr‹_time
;

1315 
__À32
 
	ms_fú°_îr‹_öo
;

1316 
__À64
 
	ms_fú°_îr‹_block
;

1317 
__u8
 
	ms_fú°_îr‹_func
[32] 
	m__n⁄°rög
;

1318 
__À32
 
	ms_fú°_îr‹_löe
;

1319 
__À32
 
	ms_œ°_îr‹_time
;

1320 
__À32
 
	ms_œ°_îr‹_öo
;

1321 
__À32
 
	ms_œ°_îr‹_löe
;

1322 
__À64
 
	ms_œ°_îr‹_block
;

1323 
__u8
 
	ms_œ°_îr‹_func
[32] 
	m__n⁄°rög
;

1324 
	#PXT4_S_ERR_END
 
	`off£tof
(
pxt4_su≥r_block
, 
s_mou¡_›ts
)

	)

1325 
__u8
 
	ms_mou¡_›ts
[64];

1326 
__À32
 
	ms_u§_quŸa_öum
;

1327 
__À32
 
	ms_gΩ_quŸa_öum
;

1328 
__À32
 
	ms_ovîhód_˛u°îs
;

1329 
__À32
 
	ms_backup_bgs
[2];

1330 
__u8
 
	ms_í¸y±_Ægos
[4];

1331 
__u8
 
	ms_í¸y±_pw_ß…
[16];

1332 
__À32
 
	ms_Õf_öo
;

1333 
__À32
 
	ms_¥j_quŸa_öum
;

1334 
__À32
 
	ms_checksum_£ed
;

1335 
__u8
 
	ms_wtime_hi
;

1336 
__u8
 
	ms_mtime_hi
;

1337 
__u8
 
	ms_mkfs_time_hi
;

1338 
__u8
 
	ms_œ°check_hi
;

1339 
__u8
 
	ms_fú°_îr‹_time_hi
;

1340 
__u8
 
	ms_œ°_îr‹_time_hi
;

1341 
__u8
 
	ms_∑d
[2];

1342 
__À16
 
	ms_ícodög
;

1343 
__À16
 
	ms_ícodög_Êags
;

1344 
__À32
 
	ms_ª£rved
[95];

1345 
__À32
 
	ms_checksum
;

1348 
	#PXT4_S_ERR_LEN
 (
PXT4_S_ERR_END
 - 
PXT4_S_ERR_START
)

	)

1350 #ifde‡
__KERNEL__


1355 
	#PXT4_MF_MNTDIR_SAMPLED
 0x0001

	)

1356 
	#PXT4_MF_FS_ABORTED
 0x0002

	)

1357 
	#PXT4_MF_TEST_DUMMY_ENCRYPTION
 0x0004

	)

1359 #ifde‡
CONFIG_FS_ENCRYPTION


1360 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(
	`u∆ikñy
((sbi)->
s_mou¡_Êags
 & \

1361 
PXT4_MF_TEST_DUMMY_ENCRYPTION
))

	)

1363 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(0)

	)

1367 
	#PXT4_MAXQUOTAS
 3

	)

1369 
	#PXT4_ENC_UTF8_12_1
 1

	)

1374 
	#PXT4_ENC_STRICT_MODE_FL
 (1 << 0)

	)

1376 
	#pxt4_has_°ri˘_mode
(
sbi
) \

1377 (
sbi
->
s_ícodög_Êags
 & 
PXT4_ENC_STRICT_MODE_FL
)

	)

1382 
	spxt4_sb_öfo
 {

1383 
	ms_desc_size
;

1384 
	ms_öodes_≥r_block
;

1385 
	ms_blocks_≥r_group
;

1386 
	ms_˛u°îs_≥r_group
;

1387 
	ms_öodes_≥r_group
;

1388 
	ms_ôb_≥r_group
;

1389 
	ms_gdb_cou¡
;

1390 
	ms_desc_≥r_block
;

1391 
pxt4_group_t
 
	ms_groups_cou¡
;

1392 
pxt4_group_t
 
	ms_blockfûe_groups
;

1393 
	ms_ovîhód
;

1394 
	ms_˛u°î_øtio
;

1395 
	ms_˛u°î_bôs
;

1396 
loff_t
 
	ms_bôm≠_maxbyãs
;

1397 
buf„r_hód
 * 
	ms_sbh
;

1398 
pxt4_su≥r_block
 *
	ms_es
;

1399 
buf„r_hód
 * 
__rcu
 *
	ms_group_desc
;

1400 
	ms_mou¡_›t
;

1401 
	ms_mou¡_›t2
;

1402 
	ms_mou¡_Êags
;

1403 
	ms_def_mou¡_›t
;

1404 
pxt4_fsblk_t
 
	ms_sb_block
;

1405 
©omic64_t
 
	ms_ªsv_˛u°îs
;

1406 
kuid_t
 
	ms_ªsuid
;

1407 
kgid_t
 
	ms_ªsgid
;

1408 
	ms_mou¡_°©e
;

1409 
	ms_∑d
;

1410 
	ms_addr_≥r_block_bôs
;

1411 
	ms_desc_≥r_block_bôs
;

1412 
	ms_öode_size
;

1413 
	ms_fú°_öo
;

1414 
	ms_öode_ªadahód_blks
;

1415 
	ms_öode_gﬂl
;

1416 
u32
 
	ms_hash_£ed
[4];

1417 
	ms_def_hash_vîsi⁄
;

1418 
	ms_hash_unsig√d
;

1419 
≥r˝u_cou¡î
 
	ms_‰ì˛u°îs_cou¡î
;

1420 
≥r˝u_cou¡î
 
	ms_‰ìöodes_cou¡î
;

1421 
≥r˝u_cou¡î
 
	ms_dús_cou¡î
;

1422 
≥r˝u_cou¡î
 
	ms_dúty˛u°îs_cou¡î
;

1423 
blockgroup_lock
 *
	ms_blockgroup_lock
;

1424 
¥oc_dú_íåy
 *
	ms_¥oc
;

1425 
kobje˘
 
	ms_kobj
;

1426 
com∂ëi⁄
 
	ms_kobj_uƒegi°î
;

1427 
su≥r_block
 *
	ms_sb
;

1428 #ifde‡
CONFIG_UNICODE


1429 
unicode_m≠
 *
	ms_ícodög
;

1430 
__u16
 
	ms_ícodög_Êags
;

1434 
jou∫Æ_s
 *
	ms_jou∫Æ
;

1435 
li°_hód
 
	ms_‹ph™
;

1436 
muãx
 
	ms_‹ph™_lock
;

1437 
	ms_pxt4_Êags
;

1438 
	ms_commô_öãrvÆ
;

1439 
u32
 
	ms_max_b©ch_time
;

1440 
u32
 
	ms_mö_b©ch_time
;

1441 
block_devi˚
 *
	mjou∫Æ_bdev
;

1442 #ifde‡
CONFIG_QUOTA


1444 
__rcu
 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

1445 
	ms_jquŸa_fmt
;

1447 
	ms_w™t_exåa_isize
;

1448 
pxt4_sy°em_blocks
 
__rcu
 *
	msy°em_blks
;

1450 #ifde‡
EXTENTS_STATS


1452 
	ms_ext_mö
;

1453 
	ms_ext_max
;

1454 
	ms_dïth_max
;

1455 
•ölock_t
 
	ms_ext_°©s_lock
;

1456 
	ms_ext_blocks
;

1457 
	ms_ext_exã¡s
;

1461 
pxt4_group_öfo
 ** 
__rcu
 *
	ms_group_öfo
;

1462 
öode
 *
	ms_buddy_ˇche
;

1463 
•ölock_t
 
	ms_md_lock
;

1464 *
	ms_mb_off£ts
;

1465 *
	ms_mb_maxs
;

1466 
	ms_group_öfo_size
;

1467 
	ms_mb_‰ì_≥ndög
;

1468 
li°_hód
 
	ms_‰ìd_d©a_li°
;

1472 
	ms_°rùe
;

1473 
	ms_mb_°ªam_ªque°
;

1474 
	ms_mb_max_to_sˇn
;

1475 
	ms_mb_mö_to_sˇn
;

1476 
	ms_mb_°©s
;

1477 
	ms_mb_‹dî2_ªqs
;

1478 
	ms_mb_group_¥óŒoc
;

1479 
	ms_max_dú_size_kb
;

1481 
	ms_mb_œ°_group
;

1482 
	ms_mb_œ°_°¨t
;

1485 
©omic_t
 
	ms_bÆ_ªqs
;

1486 
©omic_t
 
	ms_bÆ_suc˚ss
;

1487 
©omic_t
 
	ms_bÆ_Æloˇãd
;

1488 
©omic_t
 
	ms_bÆ_ex_sˇ¬ed
;

1489 
©omic_t
 
	ms_bÆ_gﬂls
;

1490 
©omic_t
 
	ms_bÆ_bªaks
;

1491 
©omic_t
 
	ms_bÆ_2‹dîs
;

1492 
•ölock_t
 
	ms_bÆ_lock
;

1493 
	ms_mb_buddõs_gíî©ed
;

1494 
	ms_mb_gíî©i⁄_time
;

1495 
©omic_t
 
	ms_mb_lo°_chunks
;

1496 
©omic_t
 
	ms_mb_¥óŒoˇãd
;

1497 
©omic_t
 
	ms_mb_disˇrded
;

1498 
©omic_t
 
	ms_lock_busy
;

1501 
pxt4_loˇlôy_group
 
__≥r˝u
 *
	ms_loˇlôy_groups
;

1504 
	ms_£˘‹s_wrôãn_°¨t
;

1505 
u64
 
	ms_kbyãs_wrôãn
;

1508 
	ms_exã¡_max_zîoout_kb
;

1510 
	ms_log_groups_≥r_Êex
;

1511 
Êex_groups
 * 
__rcu
 *
	ms_Êex_groups
;

1512 
pxt4_group_t
 
	ms_Êex_groups_Æloˇãd
;

1515 
w‹kqueue_°ru˘
 *
	mrsv_c⁄vîsi⁄_wq
;

1518 
timî_li°
 
	ms_îr_ªp‹t
;

1521 
pxt4_li_ªque°
 *
	ms_li_ªque°
;

1523 
	ms_li_waô_mu…
;

1526 
èsk_°ru˘
 *
	ms_mmp_tsk
;

1529 
©omic_t
 
	ms_œ°_åim_möblks
;

1532 
¸y±o_shash
 *
	ms_chksum_drivî
;

1535 
__u32
 
	ms_csum_£ed
;

1538 
shrökî
 
	ms_es_shrökî
;

1539 
li°_hód
 
	ms_es_li°
;

1540 
	ms_es_ƒ_öode
;

1541 
pxt4_es_°©s
 
	ms_es_°©s
;

1542 
mb_ˇche
 *
	ms_ó_block_ˇche
;

1543 
mb_ˇche
 *
	ms_ó_öode_ˇche
;

1544 
•ölock_t
 
s_es_lock
 
	m____ˇchñöe_Æig√d_ö_smp
;

1547 
øãlimô_°©e
 
	ms_îr_øãlimô_°©e
;

1548 
øãlimô_°©e
 
	ms_w¨nög_øãlimô_°©e
;

1549 
øãlimô_°©e
 
	ms_msg_øãlimô_°©e
;

1555 
≥r˝u_rw_£m≠h‹e
 
	ms_wrôïages_rw£m
;

1556 
dax_devi˚
 *
	ms_daxdev
;

1559 
ölöe
 
pxt4_sb_öfo
 *
	$PXT4_SB
(
su≥r_block
 *
sb
)

1561  
sb
->
s_fs_öfo
;

1562 
	}
}

1563 
ölöe
 
pxt4_öode_öfo
 *
	$PXT4_I
(
öode
 *inode)

1565  
	`c⁄èöî_of
(
öode
, 
pxt4_öode_öfo
, 
vfs_öode
);

1566 
	}
}

1568 
ölöe
 
	$pxt4_vÆid_öum
(
su≥r_block
 *
sb
, 
öo
)

1570  
öo
 =
PXT4_ROOT_INO
 ||

1571 (
öo
 >
	`PXT4_FIRST_INO
(
sb
) &&

1572 
öo
 <
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
));

1573 
	}
}

1583 
	#sbi_¨øy_rcu_dîef
(
sbi
, 
fõld
, 
ödex
) \

1585 
	`ty≥of
(*((
sbi
)->
fõld
)Ë
_v
; \

1586 
	`rcu_ªad_lock
(); \

1587 
_v
 = ((
	`ty≥of
(_v)*)
	`rcu_dîe„ªn˚
((
sbi
)->
fõld
))[
ödex
]; \

1588 
	`rcu_ªad_u∆ock
(); \

1589 
_v
; \

1590 })

	)

1596 
	mPXT4_STATE_JDATA
,

1597 
	mPXT4_STATE_NEW
,

1598 
	mPXT4_STATE_XATTR
,

1599 
	mPXT4_STATE_NO_EXPAND
,

1600 
	mPXT4_STATE_DA_ALLOC_CLOSE
,

1601 
	mPXT4_STATE_EXT_MIGRATE
,

1602 
	mPXT4_STATE_DIO_UNWRITTEN
,

1603 
	mPXT4_STATE_NEWENTRY
,

1604 
	mPXT4_STATE_MAY_INLINE_DATA
,

1605 
	mPXT4_STATE_EXT_PRECACHED
,

1606 
	mPXT4_STATE_LUSTRE_EA_INODE
,

1607 
	mPXT4_STATE_VERITY_IN_PROGRESS
,

1610 
	#PXT4_INODE_BIT_FNS
(
«me
, 
fõld
, 
off£t
) \

1611 
ölöe
 
pxt4_ã°_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1613  
	`ã°_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1615 
ölöe
 
pxt4_£t_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1617 
	`£t_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1619 
ölöe
 
pxt4_˛ór_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1621 
	`˛ór_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1622 }

	)

1626 
ölöe
 
pxt4_ã°_öode_Êag
(
öode
 *öode, 
bô
);

1627 
ölöe
 
pxt4_£t_öode_Êag
(
öode
 *öode, 
bô
);

1628 
ölöe
 
pxt4_˛ór_öode_Êag
(
öode
 *öode, 
bô
);

1629 
	$PXT4_INODE_BIT_FNS
(
Êag
, 
Êags
, 0)

1633 
ölöe
 
	`pxt4_ã°_öode_°©e
(
öode
 *öode, 
bô
);

1634 
ölöe
 
	`pxt4_£t_öode_°©e
(
öode
 *öode, 
bô
);

1635 
ölöe
 
	`pxt4_˛ór_öode_°©e
(
öode
 *öode, 
bô
);

1636 #i‡(
BITS_PER_LONG
 < 64)

1637 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
°©e_Êags
, 0)

1639 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1641 (
ei
)->
i_°©e_Êags
 = 0;

1642 
	}
}

1644 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
Êags
, 32)

1646 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1649 
	}
}

1655 
	#PXT4_SB
(
sb
Ë(sb)

	)

1658 
ölöe
 
boﬁ
 
	$pxt4_vîôy_ö_¥ogªss
(
öode
 *inode)

1660  
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

1661 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

1662 
	}
}

1664 
	#NEXT_ORPHAN
(
öode
Ë
	`PXT4_I
(öode)->
i_dtime


	)

1669 
	#PXT4_OS_LINUX
 0

	)

1670 
	#PXT4_OS_HURD
 1

	)

1671 
	#PXT4_OS_MASIX
 2

	)

1672 
	#PXT4_OS_FREEBSD
 3

	)

1673 
	#PXT4_OS_LITES
 4

	)

1678 
	#PXT4_GOOD_OLD_REV
 0

	)

1679 
	#PXT4_DYNAMIC_REV
 1

	)

1681 
	#PXT4_CURRENT_REV
 
PXT4_GOOD_OLD_REV


	)

1682 
	#PXT4_MAX_SUPP_REV
 
PXT4_DYNAMIC_REV


	)

1684 
	#PXT4_GOOD_OLD_INODE_SIZE
 128

	)

1686 
	#PXT4_EXTRA_TIMESTAMP_MAX
 (((
s64
)1 << 34Ë- 1 + 
S32_MIN
)

	)

1687 
	#PXT4_NON_EXTRA_TIMESTAMP_MAX
 
S32_MAX


	)

1688 
	#PXT4_TIMESTAMP_MIN
 
S32_MIN


	)

1694 
	#PXT4_FEATURE_COMPAT_DIR_PREALLOC
 0x0001

	)

1695 
	#PXT4_FEATURE_COMPAT_IMAGIC_INODES
 0x0002

	)

1696 
	#PXT4_FEATURE_COMPAT_HAS_JOURNAL
 0x0004

	)

1697 
	#PXT4_FEATURE_COMPAT_EXT_ATTR
 0x0008

	)

1698 
	#PXT4_FEATURE_COMPAT_RESIZE_INODE
 0x0010

	)

1699 
	#PXT4_FEATURE_COMPAT_DIR_INDEX
 0x0020

	)

1700 
	#PXT4_FEATURE_COMPAT_SPARSE_SUPER2
 0x0200

	)

1702 
	#PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
 0x0001

	)

1703 
	#PXT4_FEATURE_RO_COMPAT_LARGE_FILE
 0x0002

	)

1704 
	#PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 0x0004

	)

1705 
	#PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 0x0008

	)

1706 
	#PXT4_FEATURE_RO_COMPAT_GDT_CSUM
 0x0010

	)

1707 
	#PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 0x0020

	)

1708 
	#PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 0x0040

	)

1709 
	#PXT4_FEATURE_RO_COMPAT_QUOTA
 0x0100

	)

1710 
	#PXT4_FEATURE_RO_COMPAT_BIGALLOC
 0x0200

	)

1717 
	#PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
 0x0400

	)

1718 
	#PXT4_FEATURE_RO_COMPAT_READONLY
 0x1000

	)

1719 
	#PXT4_FEATURE_RO_COMPAT_PROJECT
 0x2000

	)

1720 
	#PXT4_FEATURE_RO_COMPAT_VERITY
 0x8000

	)

1722 
	#PXT4_FEATURE_INCOMPAT_COMPRESSION
 0x0001

	)

1723 
	#PXT4_FEATURE_INCOMPAT_FILETYPE
 0x0002

	)

1724 
	#PXT4_FEATURE_INCOMPAT_RECOVER
 0x0004

	)

1725 
	#PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
 0x0008

	)

1726 
	#PXT4_FEATURE_INCOMPAT_META_BG
 0x0010

	)

1727 
	#PXT4_FEATURE_INCOMPAT_EXTENTS
 0x0040

	)

1728 
	#PXT4_FEATURE_INCOMPAT_64BIT
 0x0080

	)

1729 
	#PXT4_FEATURE_INCOMPAT_MMP
 0x0100

	)

1730 
	#PXT4_FEATURE_INCOMPAT_FLEX_BG
 0x0200

	)

1731 
	#PXT4_FEATURE_INCOMPAT_EA_INODE
 0x0400

	)

1732 
	#PXT4_FEATURE_INCOMPAT_DIRDATA
 0x1000

	)

1733 
	#PXT4_FEATURE_INCOMPAT_CSUM_SEED
 0x2000

	)

1734 
	#PXT4_FEATURE_INCOMPAT_LARGEDIR
 0x4000

	)

1735 
	#PXT4_FEATURE_INCOMPAT_INLINE_DATA
 0x8000

	)

1736 
	#PXT4_FEATURE_INCOMPAT_ENCRYPT
 0x10000

	)

1737 
	#PXT4_FEATURE_INCOMPAT_CASEFOLD
 0x20000

	)

1739 
pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
);

1741 
	#PXT4_FEATURE_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1742 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1744  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1745 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
)) != 0); \

1747 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1749 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1750 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 |= \

1751 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1753 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1755 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 &= \

1756 ~
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1757 }

	)

1759 
	#PXT4_FEATURE_RO_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1760 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1762  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1763 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
)) != 0); \

1765 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1767 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1768 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 |= \

1769 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1771 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1773 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 &= \

1774 ~
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1775 }

	)

1777 
	#PXT4_FEATURE_INCOMPAT_FUNCS
(
«me
, 
Êag«me
) \

1778 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1780  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1781 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
)) != 0); \

1783 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1785 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1786 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 |= \

1787 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1789 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1791 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 &= \

1792 ~
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1793 }

	)

1795 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_¥óŒoc
, 
DIR_PREALLOC
)

1796 
	$PXT4_FEATURE_COMPAT_FUNCS
(
imagic_öodes
, 
IMAGIC_INODES
)

1797 
	$PXT4_FEATURE_COMPAT_FUNCS
(
jou∫Æ
, 
HAS_JOURNAL
)

1798 
	$PXT4_FEATURE_COMPAT_FUNCS
(
x©å
, 
EXT_ATTR
)

1799 
	$PXT4_FEATURE_COMPAT_FUNCS
(
ªsize_öode
, 
RESIZE_INODE
)

1800 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_ödex
, 
DIR_INDEX
)

1801 
	$PXT4_FEATURE_COMPAT_FUNCS
(
•¨£_su≥r2
, 
SPARSE_SUPER2
)

1803 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
•¨£_su≥r
, 
SPARSE_SUPER
)

1804 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
œrge_fûe
, 
LARGE_FILE
)

1805 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
båì_dú
, 
BTREE_DIR
)

1806 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
huge_fûe
, 
HUGE_FILE
)

1807 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
gdt_csum
, 
GDT_CSUM
)

1808 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
dú_∆ök
, 
DIR_NLINK
)

1809 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
exåa_isize
, 
EXTRA_ISIZE
)

1810 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
quŸa
, 
QUOTA
)

1811 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
bigÆloc
, 
BIGALLOC
)

1812 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
mëad©a_csum
, 
METADATA_CSUM
)

1813 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
ªad⁄ly
, 
READONLY
)

1814 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
¥oje˘
, 
PROJECT
)

1815 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
vîôy
, 
VERITY
)

1817 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
com¥essi⁄
, 
COMPRESSION
)

1818 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
fûëy≥
, 
FILETYPE
)

1819 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_√eds_ªcovîy
, 
RECOVER
)

1820 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_dev
, 
JOURNAL_DEV
)

1821 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mëa_bg
, 
META_BG
)

1822 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
exã¡s
, 
EXTENTS
)

1823 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(64b
ô
, 64B
IT
)

1824 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mmp
, 
MMP
)

1825 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
Êex_bg
, 
FLEX_BG
)

1826 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ó_öode
, 
EA_INODE
)

1827 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
dúd©a
, 
DIRDATA
)

1828 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
csum_£ed
, 
CSUM_SEED
)

1829 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
œrgedú
, 
LARGEDIR
)

1830 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ölöe_d©a
, 
INLINE_DATA
)

1831 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
í¸y±
, 
ENCRYPT
)

1832 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ˇ£fﬁd
, 
CASEFOLD
)

1834 
	#PXT2_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1835 
	#PXT2_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1836 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1837 
	#PXT2_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1838 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1839 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1841 
	#EXT3_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1842 
	#EXT3_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1843 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1844 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1845 
	#EXT3_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1846 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1847 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1849 
	#PXT4_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1850 
	#PXT4_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1851 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1852 
PXT4_FEATURE_INCOMPAT_META_BG
| \

1853 
PXT4_FEATURE_INCOMPAT_EXTENTS
| \

1854 
PXT4_FEATURE_INCOMPAT_64BIT
| \

1855 
PXT4_FEATURE_INCOMPAT_FLEX_BG
| \

1856 
PXT4_FEATURE_INCOMPAT_EA_INODE
| \

1857 
PXT4_FEATURE_INCOMPAT_MMP
 | \

1858 
PXT4_FEATURE_INCOMPAT_INLINE_DATA
 | \

1859 
PXT4_FEATURE_INCOMPAT_ENCRYPT
 | \

1860 
PXT4_FEATURE_INCOMPAT_CASEFOLD
 | \

1861 
PXT4_FEATURE_INCOMPAT_CSUM_SEED
 | \

1862 
PXT4_FEATURE_INCOMPAT_LARGEDIR
)

	)

1863 
	#PXT4_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1864 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1865 
PXT4_FEATURE_RO_COMPAT_GDT_CSUM
| \

1866 
PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 | \

1867 
PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 | \

1868 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 |\

1869 
PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 |\

1870 
PXT4_FEATURE_RO_COMPAT_BIGALLOC
 |\

1871 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
|\

1872 
PXT4_FEATURE_RO_COMPAT_QUOTA
 |\

1873 
PXT4_FEATURE_RO_COMPAT_PROJECT
 |\

1874 
PXT4_FEATURE_RO_COMPAT_VERITY
)

	)

1876 
	#EXTN_FEATURE_FUNCS
(
vî
) \

1877 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1879  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1880 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_COMPAT_SUPP
)) != 0); \

1881 
	}
} \

1882 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1884  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1885 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_RO_COMPAT_SUPP
)) != 0); \

1887 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_öcom∑t_„©uªs
(
su≥r_block
 *
sb
) \

1889  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1890 
	`˝u_to_À32
(~
EXT
##
vî
##
_FEATURE_INCOMPAT_SUPP
)) != 0); \

1891 }

	)

1893 
	$EXTN_FEATURE_FUNCS
(2)

1894 
	$EXTN_FEATURE_FUNCS
(3)

1895 
	$EXTN_FEATURE_FUNCS
(4)

1897 
ölöe
 
boﬁ
 
	$pxt4_has_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1899  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 != 0);

1900 
	}
}

1901 
ölöe
 
boﬁ
 
	$pxt4_has_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1903  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 != 0);

1904 
	}
}

1905 
ölöe
 
boﬁ
 
	$pxt4_has_öcom∑t_„©uªs
(
su≥r_block
 *
sb
)

1907  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 != 0);

1908 
	}
}

1913 
	#PXT4_FLAGS_RESIZING
 0

	)

1914 
	#PXT4_FLAGS_SHUTDOWN
 1

	)

1916 
ölöe
 
	$pxt4_f‹˚d_shutdown
(
pxt4_sb_öfo
 *
sbi
)

1918  
	`ã°_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

1919 
	}
}

1925 
	#PXT4_DEF_RESUID
 0

	)

1926 
	#PXT4_DEF_RESGID
 0

	)

1931 
	#PXT4_DEF_PROJID
 0

	)

1933 
	#PXT4_DEF_INODE_READAHEAD_BLKS
 32

	)

1938 
	#PXT4_DEFM_DEBUG
 0x0001

	)

1939 
	#PXT4_DEFM_BSDGROUPS
 0x0002

	)

1940 
	#PXT4_DEFM_XATTR_USER
 0x0004

	)

1941 
	#PXT4_DEFM_ACL
 0x0008

	)

1942 
	#PXT4_DEFM_UID16
 0x0010

	)

1943 
	#PXT4_DEFM_JMODE
 0x0060

	)

1944 
	#PXT4_DEFM_JMODE_DATA
 0x0020

	)

1945 
	#PXT4_DEFM_JMODE_ORDERED
 0x0040

	)

1946 
	#PXT4_DEFM_JMODE_WBACK
 0x0060

	)

1947 
	#PXT4_DEFM_NOBARRIER
 0x0100

	)

1948 
	#PXT4_DEFM_BLOCK_VALIDITY
 0x0200

	)

1949 
	#PXT4_DEFM_DISCARD
 0x0400

	)

1950 
	#PXT4_DEFM_NODELALLOC
 0x0800

	)

1955 
	#PXT4_DEF_MIN_BATCH_TIME
 0

	)

1956 
	#PXT4_DEF_MAX_BATCH_TIME
 15000

	)

1962 
	#PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
 4

	)

1967 
	#PXT4_NAME_LEN
 255

	)

1969 
	spxt4_dú_íåy
 {

1970 
__À32
 
	möode
;

1971 
__À16
 
	mªc_Àn
;

1972 
__À16
 
	m«me_Àn
;

1973 
	m«me
[
PXT4_NAME_LEN
];

1982 
	spxt4_dú_íåy_2
 {

1983 
__À32
 
	möode
;

1984 
__À16
 
	mªc_Àn
;

1985 
__u8
 
	m«me_Àn
;

1986 
__u8
 
	mfûe_ty≥
;

1987 
	m«me
[
PXT4_NAME_LEN
];

1994 
	spxt4_dú_íåy_èû
 {

1995 
__À32
 
	mdë_ª£rved_zîo1
;

1996 
__À16
 
	mdë_ªc_Àn
;

1997 
__u8
 
	mdë_ª£rved_zîo2
;

1998 
__u8
 
	mdë_ª£rved_·
;

1999 
__À32
 
	mdë_checksum
;

2002 
	#PXT4_DIRENT_TAIL
(
block
, 
blocksize
) \

2003 ((
pxt4_dú_íåy_èû
 *)(((*)(
block
)) + \

2004 ((
blocksize
) - \

2005 (
pxt4_dú_íåy_èû
))))

	)

2011 
	#PXT4_FT_UNKNOWN
 0

	)

2012 
	#PXT4_FT_REG_FILE
 1

	)

2013 
	#PXT4_FT_DIR
 2

	)

2014 
	#PXT4_FT_CHRDEV
 3

	)

2015 
	#PXT4_FT_BLKDEV
 4

	)

2016 
	#PXT4_FT_FIFO
 5

	)

2017 
	#PXT4_FT_SOCK
 6

	)

2018 
	#PXT4_FT_SYMLINK
 7

	)

2020 
	#PXT4_FT_MAX
 8

	)

2022 
	#PXT4_FT_DIR_CSUM
 0xDE

	)

2029 
	#PXT4_DIR_PAD
 4

	)

2030 
	#PXT4_DIR_ROUND
 (
PXT4_DIR_PAD
 - 1)

	)

2031 
	#PXT4_DIR_REC_LEN
(
«me_Àn
Ë((“ame_ÀnË+ 8 + 
PXT4_DIR_ROUND
) & \

2032 ~
PXT4_DIR_ROUND
)

	)

2033 
	#PXT4_MAX_REC_LEN
 ((1<<16)-1)

	)

2039 
ölöe
 

2040 
	$pxt4_ªc_Àn_‰om_disk
(
__À16
 
dÀn
, 
blocksize
)

2042 
Àn
 = 
	`À16_to_˝u
(
dÀn
);

2044 #i‡(
PAGE_SIZE
 >= 65536)

2045 i‡(
Àn
 =
PXT4_MAX_REC_LEN
 ||Üen == 0)

2046  
blocksize
;

2047  (
Àn
 & 65532) | ((len & 3) << 16);

2049  
Àn
;

2051 
	}
}

2053 
ölöe
 
__À16
 
	$pxt4_ªc_Àn_to_disk
(
Àn
, 
blocksize
)

2055 i‡((
Àn
 > 
blocksize
) || (blocksize > (1 << 18)) || (len & 3))

2056 
	`BUG
();

2057 #i‡(
PAGE_SIZE
 >= 65536)

2058 i‡(
Àn
 < 65536)

2059  
	`˝u_to_À16
(
Àn
);

2060 i‡(
Àn
 =
blocksize
) {

2061 i‡(
blocksize
 == 65536)

2062  
	`˝u_to_À16
(
PXT4_MAX_REC_LEN
);

2064  
	`˝u_to_À16
(0);

2066  
	`˝u_to_À16
((
Àn
 & 65532) | ((len >> 16) & 3));

2068  
	`˝u_to_À16
(
Àn
);

2070 
	}
}

2077 
	#is_dx
(
dú
Ë(
	`pxt4_has_„©uª_dú_ödex
((dú)->
i_sb
) && \

2078 
	`pxt4_ã°_öode_Êag
((
dú
), 
PXT4_INODE_INDEX
))

	)

2079 
	#PXT4_DIR_LINK_MAX
(
dú
Ë
	`u∆ikñy
((dú)->
i_∆ök
 >
PXT4_LINK_MAX
 && \

2080 !(
	`pxt4_has_„©uª_dú_∆ök
((
dú
)->
i_sb
Ë&& 
	`is_dx
(dú)))

	)

2081 
	#PXT4_DIR_LINK_EMPTY
(
dú
Ë((dú)->
i_∆ök
 =2 || (dú)->i_∆ök =1)

	)

2085 
	#DX_HASH_LEGACY
 0

	)

2086 
	#DX_HASH_HALF_MD4
 1

	)

2087 
	#DX_HASH_TEA
 2

	)

2088 
	#DX_HASH_LEGACY_UNSIGNED
 3

	)

2089 
	#DX_HASH_HALF_MD4_UNSIGNED
 4

	)

2090 
	#DX_HASH_TEA_UNSIGNED
 5

	)

2092 
ölöe
 
u32
 
	$pxt4_chksum
(
pxt4_sb_öfo
 *
sbi
, 
u32
 
¸c
,

2093 c⁄° *
addªss
, 
Àngth
)

2096 
shash_desc
 
shash
;

2097 
˘x
[4];

2098 } 
desc
;

2100 
	`BUG_ON
(
	`¸y±o_shash_descsize
(
sbi
->
s_chksum_drivî
)!=(
desc
.
˘x
));

2102 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_drivî
;

2103 *(
u32
 *)
desc
.
˘x
 = 
¸c
;

2105 
	`BUG_ON
(
	`¸y±o_shash_upd©e
(&
desc
.
shash
, 
addªss
, 
Àngth
));

2107  *(
u32
 *)
desc
.
˘x
;

2108 
	}
}

2110 #ifde‡
__KERNEL__


2113 
	sdx_hash_öfo


2115 
u32
 
	mhash
;

2116 
u32
 
	mmö‹_hash
;

2117 
	mhash_vîsi⁄
;

2118 
u32
 *
	m£ed
;

2123 
	#PXT4_HTREE_EOF_32BIT
 ((1UL << (32 - 1)Ë- 1)

	)

2124 
	#PXT4_HTREE_EOF_64BIT
 ((1ULL << (64 - 1)Ë- 1)

	)

2130 
	#HASH_NB_ALWAYS
 1

	)

2132 
	spxt4_fûíame
 {

2133 c⁄° 
q°r
 *
	mu§_‚ame
;

2134 
fs¸y±_°r
 
	mdisk_«me
;

2135 
dx_hash_öfo
 
	mhöfo
;

2136 #ifde‡
CONFIG_FS_ENCRYPTION


2137 
fs¸y±_°r
 
	m¸y±o_buf
;

2139 #ifde‡
CONFIG_UNICODE


2140 
fs¸y±_°r
 
	mcf_«me
;

2144 
	#‚ame_«me
(
p
Ë(’)->
disk_«me
.
«me
)

	)

2145 
	#‚ame_Àn
(
p
Ë(’)->
disk_«me
.
Àn
)

	)

2150 
	spxt4_ûoc


2152 
buf„r_hód
 *
	mbh
;

2153 
	moff£t
;

2154 
pxt4_group_t
 
	mblock_group
;

2157 
ölöe
 
pxt4_öode
 *
	$pxt4_øw_öode
(
pxt4_ûoc
 *
ûoc
)

2159  (
pxt4_öode
 *Ë(
ûoc
->
bh
->
b_d©a
 + iloc->
off£t
);

2160 
	}
}

2162 
ölöe
 
boﬁ
 
	$pxt4_is_quŸa_fûe
(
öode
 *inode)

2164  
	`IS_NOQUOTA
(
öode
) &&

2165 !(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
);

2166 
	}
}

2173 
	sdú_¥iv©e_öfo
 {

2174 
rb_roŸ
 
	mroŸ
;

2175 
rb_node
 *
	mcuº_node
;

2176 
‚ame
 *
	mexåa_‚ame
;

2177 
loff_t
 
	mœ°_pos
;

2178 
__u32
 
	mcuº_hash
;

2179 
__u32
 
	mcuº_mö‹_hash
;

2180 
__u32
 
	m√xt_hash
;

2184 
ölöe
 
pxt4_fsblk_t


2185 
	$pxt4_group_fú°_block_no
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group_no
)

2187  
group_no
 * (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

2188 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

2189 
	}
}

2194 
	#ERR_BAD_DX_DIR
 (-(
MAX_ERRNO
 - 1))

	)

2197 
	#PXT4_HTREE_LEVEL_COMPAT
 2

	)

2198 
	#PXT4_HTREE_LEVEL
 3

	)

2200 
ölöe
 
	$pxt4_dú_håì_Àvñ
(
su≥r_block
 *
sb
)

2202  
	`pxt4_has_„©uª_œrgedú
(
sb
) ?

2203 
PXT4_HTREE_LEVEL
 : 
PXT4_HTREE_LEVEL_COMPAT
;

2204 
	}
}

2209 
	#PXT4_DEF_LI_WAIT_MULT
 10

	)

2210 
	#PXT4_DEF_LI_MAX_START_DELAY
 5

	)

2211 
	#PXT4_LAZYINIT_QUIT
 0x0001

	)

2212 
	#PXT4_LAZYINIT_RUNNING
 0x0002

	)

2217 
	spxt4_œzy_öô
 {

2218 
	mli_°©e
;

2219 
li°_hód
 
	mli_ªque°_li°
;

2220 
muãx
 
	mli_li°_mtx
;

2223 
	spxt4_li_ªque°
 {

2224 
su≥r_block
 *
	mÃ_su≥r
;

2225 
pxt4_sb_öfo
 *
	mÃ_sbi
;

2226 
pxt4_group_t
 
	mÃ_√xt_group
;

2227 
li°_hód
 
	mÃ_ªque°
;

2228 
	mÃ_√xt_sched
;

2229 
	mÃ_timeout
;

2232 
	spxt4_„©uªs
 {

2233 
kobje˘
 
	mf_kobj
;

2234 
com∂ëi⁄
 
	mf_kobj_uƒegi°î
;

2244 
	#PXT4_MMP_MAGIC
 0x004D4D50U

	)

2245 
	#PXT4_MMP_SEQ_CLEAN
 0xFF4D4D50U

	)

2246 
	#PXT4_MMP_SEQ_FSCK
 0xE24D4D50U

	)

2247 
	#PXT4_MMP_SEQ_MAX
 0xE24D4D4FU

	)

2249 
	smmp_°ru˘
 {

2250 
__À32
 
	mmmp_magic
;

2251 
__À32
 
	mmmp_£q
;

2257 
__À64
 
	mmmp_time
;

2258 
	mmmp_nodíame
[64];

2259 
	mmmp_bdev«me
[32];

2266 
__À16
 
	mmmp_check_öãrvÆ
;

2268 
__À16
 
	mmmp_∑d1
;

2269 
__À32
 
	mmmp_∑d2
[226];

2270 
__À32
 
	mmmp_checksum
;

2274 
	smmpd_d©a
 {

2275 
buf„r_hód
 *
	mbh
;

2276 
su≥r_block
 *
	msb
;

2287 
	#PXT4_MMP_CHECK_MULT
 2UL

	)

2292 
	#PXT4_MMP_MIN_CHECK_INTERVAL
 5UL

	)

2297 
	#PXT4_MMP_MAX_CHECK_INTERVAL
 300UL

	)

2307 
	#NORET_TYPE


	)

2308 
	#ATTRIB_NORET
 
	`__©åibuã__
((
n‹ëu∫
))

	)

2309 
	#NORET_AND
 
n‹ëu∫
,

	)

2312 
pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
);

2313 
pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2314 
pxt4_group_desc
 *
gdp
,

2315 
buf„r_hód
 *
bh
, 
sz
);

2316 
pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2317 
pxt4_group_desc
 *
gdp
,

2318 
buf„r_hód
 *
bh
, 
sz
);

2319 
pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2320 
pxt4_group_desc
 *
gdp
,

2321 
buf„r_hód
 *
bh
);

2322 
pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2323 
pxt4_group_desc
 *
gdp
,

2324 
buf„r_hód
 *
bh
);

2327 
pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
,

2328 
pxt4_fsblk_t
 
blockƒ
,

2329 
pxt4_group_t
 *
blockgΩp
,

2330 
pxt4_gΩblk_t
 *
off£ç
);

2331 
pxt4_group_t
 
pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

2332 
pxt4_fsblk_t
 
block
);

2334 
pxt4_block_group
(
su≥r_block
 *
sb
,

2335 
pxt4_fsblk_t
 
blockƒ
);

2336 
pxt4_gΩblk_t
 
pxt4_block_group_off£t
(
su≥r_block
 *
sb
,

2337 
pxt4_fsblk_t
 
blockƒ
);

2338 
pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
);

2339 
pxt4_bg_num_gdb
(
su≥r_block
 *
sb
,

2340 
pxt4_group_t
 
group
);

2341 
pxt4_fsblk_t
 
pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2342 
pxt4_fsblk_t
 
gﬂl
,

2343 
Êags
,

2344 *
cou¡
,

2345 *
îΩ
);

2346 
pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

2347 
s64
 
n˛u°îs
, 
Êags
);

2348 
pxt4_fsblk_t
 
pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *);

2349 
pxt4_check_blocks_bôm≠
(
su≥r_block
 *);

2350 
pxt4_group_desc
 * 
pxt4_gë_group_desc
(
su≥r_block
 * 
sb
,

2351 
pxt4_group_t
 
block_group
,

2352 
buf„r_hód
 ** 
bh
);

2353 
pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
);

2355 
buf„r_hód
 *
pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
,

2356 
pxt4_group_t
 
block_group
);

2357 
pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
,

2358 
pxt4_group_t
 
block_group
,

2359 
buf„r_hód
 *
bh
);

2360 
buf„r_hód
 *
pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
,

2361 
pxt4_group_t
 
block_group
);

2362 
pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

2363 
pxt4_group_t
 
block_group
,

2364 
pxt4_group_desc
 *
gdp
);

2365 
pxt4_fsblk_t
 
pxt4_öode_to_gﬂl_block
(
öode
 *);

2367 #ifde‡
CONFIG_UNICODE


2368 
pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
,

2369 c⁄° 
q°r
 *
öame
,

2370 
fs¸y±_°r
 *
‚ame
);

2373 #ifde‡
CONFIG_FS_ENCRYPTION


2374 
ölöe
 
	$pxt4_‚ame_‰om_fs¸y±_«me
(
pxt4_fûíame
 *
d°
,

2375 c⁄° 
fs¸y±_«me
 *
§c
)

2377 
	`mem£t
(
d°
, 0, (*dst));

2379 
d°
->
u§_‚ame
 = 
§c
->usr_fname;

2380 
d°
->
disk_«me
 = 
§c
->disk_name;

2381 
d°
->
höfo
.
hash
 = 
§c
->hash;

2382 
d°
->
höfo
.
mö‹_hash
 = 
§c
->minor_hash;

2383 
d°
->
¸y±o_buf
 = 
§c
->crypto_buf;

2384 
	}
}

2386 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2387 c⁄° 
q°r
 *
öame
,

2388 
lookup
,

2389 
pxt4_fûíame
 *
‚ame
)

2391 
fs¸y±_«me
 
«me
;

2392 
îr
;

2394 
îr
 = 
	`fs¸y±_£tup_fûíame
(
dú
, 
öame
, 
lookup
, &
«me
);

2395 i‡(
îr
)

2396  
îr
;

2398 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2400 #ifde‡
CONFIG_UNICODE


2401 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2404 
	}
}

2406 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2407 
díåy
 *dentry,

2408 
pxt4_fûíame
 *
‚ame
)

2410 
fs¸y±_«me
 
«me
;

2411 
îr
;

2413 
îr
 = 
	`fs¸y±_¥ï¨e_lookup
(
dú
, 
díåy
, &
«me
);

2414 i‡(
îr
)

2415  
îr
;

2417 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2419 #ifde‡
CONFIG_UNICODE


2420 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, &
díåy
->
d_«me
, &
‚ame
->
cf_«me
);

2423 
	}
}

2425 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2427 
fs¸y±_«me
 
«me
;

2429 
«me
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

2430 
	`fs¸y±_‰ì_fûíame
(&
«me
);

2432 
‚ame
->
¸y±o_buf
.
«me
 = 
NULL
;

2433 
‚ame
->
u§_‚ame
 = 
NULL
;

2434 
‚ame
->
disk_«me
.
«me
 = 
NULL
;

2436 #ifde‡
CONFIG_UNICODE


2437 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2438 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2440 
	}
}

2442 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2443 c⁄° 
q°r
 *
öame
,

2444 
lookup
,

2445 
pxt4_fûíame
 *
‚ame
)

2447 
‚ame
->
u§_‚ame
 = 
öame
;

2448 
‚ame
->
disk_«me
.
«me
 = (*Ë
öame
->name;

2449 
‚ame
->
disk_«me
.
Àn
 = 
öame
->len;

2451 #ifde‡
CONFIG_UNICODE


2452 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2456 
	}
}

2458 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2459 
díåy
 *dentry,

2460 
pxt4_fûíame
 *
‚ame
)

2462  
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 1, 
‚ame
);

2463 
	}
}

2465 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2467 #ifde‡
CONFIG_UNICODE


2468 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2469 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2471 
	}
}

2475 
__pxt4_check_dú_íåy
(c⁄° *, , 
öode
 *,

2476 
fûe
 *,

2477 
pxt4_dú_íåy_2
 *,

2478 
buf„r_hód
 *, *, ,

2480 
	#pxt4_check_dú_íåy
(
dú
, 
fûp
, 
de
, 
bh
, 
buf
, 
size
, 
off£t
) \

2481 
	`u∆ikñy
(
	`__pxt4_check_dú_íåy
(
__func__
, 
__LINE__
, (
dú
), (
fûp
), \

2482 (
de
), (
bh
), (
buf
), (
size
), (
off£t
)))

	)

2483 
pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

2484 
__u32
 
mö‹_hash
,

2485 
pxt4_dú_íåy_2
 *
dúít
,

2486 
fs¸y±_°r
 *
ít_«me
);

2487 
pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
);

2488 
pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

2489 
buf„r_hód
 *
bh
,

2490 *
buf
, 
buf_size
,

2491 
pxt4_fûíame
 *
‚ame
,

2492 
pxt4_dú_íåy_2
 **
de°_de
);

2493 
pxt4_ö£π_díåy
(
öode
 *inode,

2494 
pxt4_dú_íåy_2
 *
de
,

2495 
buf_size
,

2496 
pxt4_fûíame
 *
‚ame
);

2497 
ölöe
 
	$pxt4_upd©e_dx_Êag
(
öode
 *inode)

2499 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
)) {

2501 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
öode
->
i_sb
));

2502 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

2504 
	}
}

2505 c⁄° 
	gpxt4_fûëy≥_èbÀ
[] = {

2506 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


2509 
ölöe
 
	$gë_dty≥
(
su≥r_block
 *
sb
, 
fûëy≥
)

2511 i‡(!
	`pxt4_has_„©uª_fûëy≥
(
sb
Ë|| 
fûëy≥
 >
PXT4_FT_MAX
)

2512  
DT_UNKNOWN
;

2514  
pxt4_fûëy≥_èbÀ
[
fûëy≥
];

2515 
	}
}

2516 
pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

2517 *
buf
, 
buf_size
);

2520 
pxt4_sync_fûe
(
fûe
 *, 
loff_t
,Üoff_t, );

2523 
pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

2524 
dx_hash_öfo
 *
höfo
);

2527 
öode
 *
__pxt4_√w_öode
(
h™dÀ_t
 *, öodê*, 
umode_t
,

2528 c⁄° 
q°r
 *q°r, 
__u32
 
gﬂl
,

2529 
uid_t
 *
ow√r
, 
__u32
 
i_Êags
,

2530 
h™dÀ_ty≥
, 
löe_no
,

2531 
nblocks
);

2533 
	#pxt4_√w_öode
(
h™dÀ
, 
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, 
i_Êags
) \

2534 
	`__pxt4_√w_öode
((
h™dÀ
), (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2535 
i_Êags
, 0, 0, 0)

	)

2536 
	#pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, \

2537 
ty≥
, 
nblocks
) \

2538 
	`__pxt4_√w_öode
(
NULL
, (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2539 0, (
ty≥
), 
__LINE__
, (
nblocks
))

	)

2542 
pxt4_‰ì_öode
(
h™dÀ_t
 *, 
öode
 *);

2543 
öode
 * 
pxt4_‹ph™_gë
(
su≥r_block
 *, );

2544 
pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *);

2545 
pxt4_cou¡_dús
(
su≥r_block
 *);

2546 
pxt4_check_öodes_bôm≠
(
su≥r_block
 *);

2547 
pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
);

2548 
pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
,

2549 
pxt4_group_t
 
group
, 
b¨rõr
);

2550 
pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
);

2553 c⁄° 
£q_›î©i⁄s
 
pxt4_mb_£q_groups_›s
;

2554 
pxt4_mb_°©s
;

2555 
pxt4_mb_max_to_sˇn
;

2556 
pxt4_mb_öô
(
su≥r_block
 *);

2557 
pxt4_mb_ªÀa£
(
su≥r_block
 *);

2558 
pxt4_fsblk_t
 
pxt4_mb_√w_blocks
(
h™dÀ_t
 *,

2559 
pxt4_Æloˇti⁄_ªque°
 *, *);

2560 
pxt4_mb_ª£rve_blocks
(
su≥r_block
 *, );

2561 
pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *);

2562 
__öô
 
pxt4_öô_mbÆloc
();

2563 
pxt4_exô_mbÆloc
();

2564 
pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2565 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

2566 
cou¡
, 
Êags
);

2567 
pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
,

2568 
pxt4_group_t
 
ngroups
);

2569 
pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
,

2570 
pxt4_group_t
 
i
, 
pxt4_group_desc
 *
desc
);

2571 
pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2572 
pxt4_fsblk_t
 
block
, 
cou¡
);

2573 
pxt4_åim_fs
(
su≥r_block
 *, 
f°rim_ønge
 *);

2574 
pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
);

2577 
pxt4_öode_is_Á°_symlök
(
öode
 *inode);

2578 
buf„r_hód
 *
pxt4_gëblk
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2579 
buf„r_hód
 *
pxt4_bªad
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2580 
pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

2581 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
);

2582 
pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2583 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2584 
pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2585 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2586 
pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2587 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2588 
pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2589 
buf„r_hód
 *
bh
, 
¸óã
);

2590 
pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

2591 
buf„r_hód
 *
hód
,

2592 
‰om
,

2593 
to
,

2594 *
∑πül
,

2595 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

2596 
buf„r_hód
 *
bh
));

2597 
	`do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

2598 
buf„r_hód
 *
bh
);

2599 
	#FALL_BACK_TO_NONDELALLOC
 1

	)

2600 
	#CONVERT_INLINE_DATA
 2

	)

2603 
PXT4_IGET_NORMAL
 = 0,

2604 
PXT4_IGET_SPECIAL
 = 0x0001,

2605 
PXT4_IGET_HANDLE
 = 0x0002

2606 } 
	tpxt4_igë_Êags
;

2608 
öode
 *
	`__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

2609 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

2610 
löe
);

2612 
	#pxt4_igë
(
sb
, 
öo
, 
Êags
) \

2613 
	`__pxt4_igë
((
sb
), (
öo
), (
Êags
), 
__func__
, 
__LINE__
)

	)

2615 
	`pxt4_wrôe_öode
(
öode
 *, 
wrôeback_c⁄åﬁ
 *);

2616 
	`pxt4_£èâr
(
díåy
 *, 
üâr
 *);

2617 
	`pxt4_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2618 
	`pxt4_evi˘_öode
(
öode
 *);

2619 
	`pxt4_˛ór_öode
(
öode
 *);

2620 
	`pxt4_fûe_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2621 
	`pxt4_sync_öode
(
h™dÀ_t
 *, 
öode
 *);

2622 
	`pxt4_dúty_öode
(
öode
 *, );

2623 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *, );

2624 
	`pxt4_gë_öode_loc
(
öode
 *, 
pxt4_ûoc
 *);

2625 
	`pxt4_öode_©èch_jöode
(
öode
 *inode);

2626 
	`pxt4_ˇn_åunˇã
(
öode
 *inode);

2627 
	`pxt4_åunˇã
(
öode
 *);

2628 
	`pxt4_bªak_œyouts
(
öode
 *);

2629 
	`pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
);

2630 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *, 
öode
 *, 
nblocks
);

2631 
	`pxt4_£t_öode_Êags
(
öode
 *);

2632 
	`pxt4_Æloc_da_blocks
(
öode
 *inode);

2633 
	`pxt4_£t_a›s
(
öode
 *inode);

2634 
	`pxt4_wrôïage_å™s_blocks
(
öode
 *);

2635 
	`pxt4_chunk_å™s_blocks
(
öode
 *, 
ƒblocks
);

2636 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2637 
loff_t
 
l°¨t
,Üoff_à
Ànd
);

2638 
vm_Áu…_t
 
	`pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
);

2639 
vm_Áu…_t
 
	`pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
);

2640 
qsize_t
 *
	`pxt4_gë_ª£rved_•a˚
(
öode
 *inode);

2641 
	`pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
);

2642 
	`pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
);

2643 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

2644 
u£d
, 
quŸa_˛aim
);

2645 
	`pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2646 
pxt4_fsblk_t
 
pblk
, 
pxt4_lblk_t
 
Àn
);

2649 
	`pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2650 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

2651 
	`pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
);

2652 
	`pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
);

2653 
	`pxt4_öd_åunˇã
(
h™dÀ_t
 *, 
öode
 *inode);

2654 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2655 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
);

2658 
	`pxt4_io˘l
(
fûe
 *, , );

2659 
	`pxt4_com∑t_io˘l
(
fûe
 *, , );

2662 
	`pxt4_ext_migøã
(
öode
 *);

2663 
	`pxt4_öd_migøã
(
öode
 *inode);

2666 
	`pxt4_dúblock_csum_vîify
(
öode
 *inode,

2667 
buf„r_hód
 *
bh
);

2668 
	`pxt4_‹ph™_add
(
h™dÀ_t
 *, 
öode
 *);

2669 
	`pxt4_‹ph™_dñ
(
h™dÀ_t
 *, 
öode
 *);

2670 
	`pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

2671 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
);

2672 
	`pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
,

2673 *
£¨ch_buf
,

2674 
buf_size
,

2675 
öode
 *
dú
,

2676 
pxt4_fûíame
 *
‚ame
,

2677 
off£t
,

2678 
pxt4_dú_íåy_2
 **
ªs_dú
);

2679 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2680 
öode
 *
dú
,

2681 
pxt4_dú_íåy_2
 *
de_dñ
,

2682 
buf„r_hód
 *
bh
,

2683 *
íåy_buf
,

2684 
buf_size
,

2685 
csum_size
);

2686 
boﬁ
 
	`pxt4_em±y_dú
(
öode
 *inode);

2689 
	`pxt4_kv‰ì_¨øy_rcu
(*
to_‰ì
);

2690 
	`pxt4_group_add
(
su≥r_block
 *
sb
,

2691 
pxt4_√w_group_d©a
 *
öput
);

2692 
	`pxt4_group_exãnd
(
su≥r_block
 *
sb
,

2693 
pxt4_su≥r_block
 *
es
,

2694 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2695 
	`pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2698 
buf„r_hód
 *
	`pxt4_sb_bªad
(
su≥r_block
 *
sb
,

2699 
£˘‹_t
 
block
, 
›_Êags
);

2700 
	`pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
);

2701 
	`pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
);

2702 
	`pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
);

2703 *
	`pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2704 *
	`pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2705 
	`pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
,

2706 
pxt4_group_t
 
ngroup
);

2707 c⁄° *
	`pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

2708 
nbuf
[16]);

2709 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

2710 
pxt4_group_t
 
block_group
,

2711 
Êags
);

2713 
	$__¥ötf
(4, 5)

2714 
	`__pxt4_îr‹
(
su≥r_block
 *, const *, ,

2716 
	$__¥ötf
(5, 6)

2717 
	`__pxt4_îr‹_öode
(
öode
 *, c⁄° *, , 
pxt4_fsblk_t
,

2719 
	$__¥ötf
(5, 6)

2720 
	`__pxt4_îr‹_fûe
(
fûe
 *, c⁄° *, , 
pxt4_fsblk_t
,

2722 
	`__pxt4_°d_îr‹
(
su≥r_block
 *, const *,

2724 
	$__¥ötf
(4, 5)

2725 
	`__pxt4_ab‹t
(
su≥r_block
 *, const *, ,

2727 
	$__¥ötf
(4, 5)

2728 
	`__pxt4_w¨nög
(
su≥r_block
 *, const *, ,

2730 
	$__¥ötf
(4, 5)

2731 
	`__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

2732 
löe
, c⁄° *
fmt
, ...);

2733 
	$__¥ötf
(3, 4)

2734 
	`__pxt4_msg
(
su≥r_block
 *, const *, const *, ...);

2735 
	`__dump_mmp_msg
(
su≥r_block
 *, 
mmp_°ru˘
 *
mmp
,

2737 
	$__¥ötf
(7, 8)

2738 
	`__pxt4_gΩ_locked_îr‹
(const *, ,

2739 
su≥r_block
 *, 
pxt4_group_t
,

2740 , 
pxt4_fsblk_t
,

2743 
	#PXT4_ERROR_INODE
(
öode
, 
fmt
, 
a
...) \

2744 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, 0, (
fmt
), ## 
a
)

	)

2746 
	#PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
, 
fmt
, 
a
...) \

2747 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2749 
	#PXT4_ERROR_FILE
(
fûe
, 
block
, 
fmt
, 
a
...) \

2750 
	`pxt4_îr‹_fûe
((
fûe
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2752 #ifde‡
CONFIG_PRINTK


2754 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2755 
	`__pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2756 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2757 
	`__pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2758 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2759 
	`__pxt4_îr‹
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2760 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2761 
	`__pxt4_ab‹t
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2762 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2763 
	`__pxt4_w¨nög
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2764 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2765 
	`__pxt4_w¨nög_öode
(
öode
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2766 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2767 
	`__pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ##
__VA_ARGS__
)

	)

2768 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2769 
	`__dump_mmp_msg
(
sb
, 
mmp
, 
__func__
, 
__LINE__
, 
msg
)

	)

2770 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2771 
	`__pxt4_gΩ_locked_îr‹
(
__func__
, 
__LINE__
, 
sb
, 
gΩ
, 
öo
, 
block
, \

2772 
fmt
, ##
__VA_ARGS__
)

	)

2776 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2778 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2779 
	`__pxt4_îr‹_öode
(
öode
, "", 0, 
block
, " "); \

2780 
	}
} 0)

	)

2781 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2783 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2784 
	`__pxt4_îr‹_fûe
(
fûe
, "", 0, 
block
, " "); \

2785 } 0)

	)

2786 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2788 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2789 
	`__pxt4_îr‹
(
sb
, "", 0, " "); \

2790 } 0)

	)

2791 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2793 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2794 
	`__pxt4_ab‹t
(
sb
, "", 0, " "); \

2795 } 0)

	)

2796 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2798 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2799 
	`__pxt4_w¨nög
(
sb
, "", 0, " "); \

2800 } 0)

	)

2801 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2803 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2804 
	`__pxt4_w¨nög_öode
(
öode
, "", 0, " "); \

2805 } 0)

	)

2806 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2808 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2809 
	`__pxt4_msg
(
sb
, "", " "); \

2810 } 0)

	)

2811 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2812 
	`__dump_mmp_msg
(
sb
, 
mmp
, "", 0, "")

	)

2813 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2815 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2816 
	`__pxt4_gΩ_locked_îr‹
("", 0, 
sb
, 
gΩ
, 
öo
, 
block
, " "); \

2817 } 0)

	)

2821 
pxt4_upd©e_com∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2822 
__u32
 
com∑t
);

2823 
pxt4_upd©e_rocom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2824 
su≥r_block
 *
sb
, 
__u32
 
rocom∑t
);

2825 
pxt4_upd©e_öcom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2826 
su≥r_block
 *
sb
, 
__u32
 
öcom∑t
);

2827 
pxt4_fsblk_t
 
pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

2828 
pxt4_group_desc
 *
bg
);

2829 
pxt4_fsblk_t
 
pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

2830 
pxt4_group_desc
 *
bg
);

2831 
pxt4_fsblk_t
 
pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

2832 
pxt4_group_desc
 *
bg
);

2833 
__u32
 
pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

2834 
pxt4_group_desc
 *
bg
);

2835 
__u32
 
pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

2836 
pxt4_group_desc
 *
bg
);

2837 
__u32
 
pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

2838 
pxt4_group_desc
 *
bg
);

2839 
__u32
 
pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

2840 
pxt4_group_desc
 *
bg
);

2841 
pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

2842 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2843 
pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

2844 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2845 
pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

2846 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2847 
pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

2848 
pxt4_group_desc
 *
bg
,

2849 
__u32
 
cou¡
);

2850 
pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

2851 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2852 
pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

2853 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2854 
pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

2855 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2856 
pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2857 
pxt4_group_desc
 *
gdp
);

2858 
pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2859 
pxt4_group_desc
 *
gdp
);

2860 
pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

2861 
pxt4_group_t
 
fú°_nŸ_zî€d
);

2863 
ölöe
 
	$pxt4_has_mëad©a_csum
(
su≥r_block
 *
sb
)

2865 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2866 !
	`PXT4_SB
(
sb
)->
s_chksum_drivî
);

2868  
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2869 (
	`PXT4_SB
(
sb
)->
s_chksum_drivî
 !
NULL
);

2870 
	}
}

2872 
ölöe
 
	$pxt4_has_group_desc_csum
(
su≥r_block
 *
sb
)

2874  
	`pxt4_has_„©uª_gdt_csum
(
sb
Ë|| 
	`pxt4_has_mëad©a_csum
(sb);

2875 
	}
}

2877 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2879  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_blocks_cou¡_hi
) << 32) |

2880 
	`À32_to_˝u
(
es
->
s_blocks_cou¡_lo
);

2881 
	}
}

2883 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_r_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2885  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_hi
) << 32) |

2886 
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_lo
);

2887 
	}
}

2889 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_‰ì_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2891  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_hi
) << 32) |

2892 
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_lo
);

2893 
	}
}

2895 
ölöe
 
	$pxt4_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2896 
pxt4_fsblk_t
 
blk
)

2898 
es
->
s_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2899 
es
->
s_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2900 
	}
}

2902 
ölöe
 
	$pxt4_‰ì_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2903 
pxt4_fsblk_t
 
blk
)

2905 
es
->
s_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2906 
es
->
s_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2907 
	}
}

2909 
ölöe
 
	$pxt4_r_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2910 
pxt4_fsblk_t
 
blk
)

2912 
es
->
s_r_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2913 
es
->
s_r_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2914 
	}
}

2916 
ölöe
 
loff_t
 
	$pxt4_isize
(
su≥r_block
 *
sb
,

2917 
pxt4_öode
 *
øw_öode
)

2919 i‡(
	`pxt4_has_„©uª_œrgedú
(
sb
) ||

2920 
	`S_ISREG
(
	`À16_to_˝u
(
øw_öode
->
i_mode
)))

2921  ((
loff_t
)
	`À32_to_˝u
(
øw_öode
->
i_size_high
) << 32) |

2922 
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2924  (
loff_t
Ë
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2925 
	}
}

2927 
ölöe
 
	$pxt4_isize_£t
(
pxt4_öode
 *
øw_öode
, 
loff_t
 
i_size
)

2929 
øw_öode
->
i_size_lo
 = 
	`˝u_to_À32
(
i_size
);

2930 
øw_öode
->
i_size_high
 = 
	`˝u_to_À32
(
i_size
 >> 32);

2931 
	}
}

2933 
ölöe


2934 
pxt4_group_öfo
 *
	$pxt4_gë_group_öfo
(
su≥r_block
 *
sb
,

2935 
pxt4_group_t
 
group
)

2937 
pxt4_group_öfo
 **
gΩ_öfo
;

2938 
ödexv
, 
ödexh
;

2939 
	`BUG_ON
(
group
 >
	`PXT4_SB
(
sb
)->
s_groups_cou¡
);

2940 
ödexv
 = 
group
 >> (
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
));

2941 
ödexh
 = 
group
 & ((
	`PXT4_DESC_PER_BLOCK
(
sb
)) - 1);

2942 
gΩ_öfo
 = 
	`sbi_¨øy_rcu_dîef
(
	`PXT4_SB
(
sb
), 
s_group_öfo
, 
ödexv
);

2943  
gΩ_öfo
[
ödexh
];

2944 
	}
}

2951 
ölöe
 
pxt4_group_t
 
	$pxt4_gë_groups_cou¡
(
su≥r_block
 *
sb
)

2953 
pxt4_group_t
 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

2955 
	`smp_rmb
();

2956  
ngroups
;

2957 
	}
}

2959 
ölöe
 
pxt4_group_t
 
	$pxt4_Êex_group
(
pxt4_sb_öfo
 *
sbi
,

2960 
pxt4_group_t
 
block_group
)

2962  
block_group
 >> 
sbi
->
s_log_groups_≥r_Êex
;

2963 
	}
}

2965 
ölöe
 
	$pxt4_Êex_bg_size
(
pxt4_sb_öfo
 *
sbi
)

2967  1 << 
sbi
->
s_log_groups_≥r_Êex
;

2968 
	}
}

2970 
	#pxt4_°d_îr‹
(
sb
, 
î∫o
) \

2972 i‡((
î∫o
)) \

2973 
	`__pxt4_°d_îr‹
((
sb
), 
__func__
, 
__LINE__
, (
î∫o
)); \

2974 } 0)

	)

2976 #ifde‡
CONFIG_SMP


2981 
	#PXT4_FREECLUSTERS_WATERMARK
 (4 * (
≥r˝u_cou¡î_b©ch
 * 
ƒ_˝u_ids
))

	)

2983 
	#PXT4_FREECLUSTERS_WATERMARK
 0

	)

2987 
ölöe
 
	$pxt4_upd©e_i_disksize
(
öode
 *öode, 
loff_t
 
√wsize
)

2989 
	`WARN_ON_ONCE
(
	`S_ISREG
(
öode
->
i_mode
) &&

2990 !
	`öode_is_locked
(
öode
));

2991 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2992 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2993 
	`WRITE_ONCE
(
	`PXT4_I
(
öode
)->
i_disksize
, 
√wsize
);

2994 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2995 
	}
}

2998 
ölöe
 
	$pxt4_upd©e_öode_size
(
öode
 *öode, 
loff_t
 
√wsize
)

3000 
ch™ged
 = 0;

3002 i‡(
√wsize
 > 
öode
->
i_size
) {

3003 
	`i_size_wrôe
(
öode
, 
√wsize
);

3004 
ch™ged
 = 1;

3006 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3007 
	`pxt4_upd©e_i_disksize
(
öode
, 
√wsize
);

3008 
ch™ged
 |= 2;

3010  
ch™ged
;

3011 
	}
}

3013 
pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

3014 
loff_t
 
Àn
);

3016 
	spxt4_group_öfo
 {

3017 
	mbb_°©e
;

3018 
rb_roŸ
 
	mbb_‰ì_roŸ
;

3019 
pxt4_gΩblk_t
 
	mbb_fú°_‰ì
;

3020 
pxt4_gΩblk_t
 
	mbb_‰ì
;

3021 
pxt4_gΩblk_t
 
	mbb_‰agmíts
;

3022 
pxt4_gΩblk_t
 
	mbb_œrge°_‰ì_‹dî
;

3023 
li°_hód
 
	mbb_¥óŒoc_li°
;

3024 #ifde‡
DOUBLE_CHECK


3025 *
	mbb_bôm≠
;

3027 
rw_£m≠h‹e
 
	mÆloc_£m
;

3028 
pxt4_gΩblk_t
 
	mbb_cou¡îs
[];

3034 
	#PXT4_GROUP_INFO_NEED_INIT_BIT
 0

	)

3035 
	#PXT4_GROUP_INFO_WAS_TRIMMED_BIT
 1

	)

3036 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
 2

	)

3037 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
 3

	)

3038 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT
 \

3039 (1 << 
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
)

	)

3040 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT
 \

3041 (1 << 
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
)

	)

3043 
	#PXT4_MB_GRP_NEED_INIT
(
gΩ
) \

3044 (
	`ã°_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3045 
	#PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
) \

3046 (
	`ã°_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3047 
	#PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) \

3048 (
	`ã°_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3050 
	#PXT4_MB_GRP_WAS_TRIMMED
(
gΩ
) \

3051 (
	`ã°_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3052 
	#PXT4_MB_GRP_SET_TRIMMED
(
gΩ
) \

3053 (
	`£t_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3054 
	#PXT4_MB_GRP_CLEAR_TRIMMED
(
gΩ
) \

3055 (
	`˛ór_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3057 
	#PXT4_MAX_CONTENTION
 8

	)

3058 
	#PXT4_CONTENTION_THRESHOLD
 2

	)

3060 
ölöe
 
•ölock_t
 *
	$pxt4_group_lock_±r
(
su≥r_block
 *
sb
,

3061 
pxt4_group_t
 
group
)

3063  
	`bgl_lock_±r
(
	`PXT4_SB
(
sb
)->
s_blockgroup_lock
, 
group
);

3064 
	}
}

3070 
ölöe
 
	$pxt4_fs_is_busy
(
pxt4_sb_öfo
 *
sbi
)

3072  (
	`©omic_ªad
(&
sbi
->
s_lock_busy
Ë> 
PXT4_CONTENTION_THRESHOLD
);

3073 
	}
}

3075 
ölöe
 
	$pxt4_lock_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

3077 
•ölock_t
 *
lock
 = 
	`pxt4_group_lock_±r
(
sb
, 
group
);

3078 i‡(
	`•ö_åylock
(
lock
))

3083 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, -1, 0);

3089 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, 1,

3090 
PXT4_MAX_CONTENTION
);

3091 
	`•ö_lock
(
lock
);

3093 
	}
}

3095 
ölöe
 
	$pxt4_u∆ock_group
(
su≥r_block
 *
sb
,

3096 
pxt4_group_t
 
group
)

3098 
	`•ö_u∆ock
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

3099 
	}
}

3104 
	#pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
) \

3105 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3106 (
__À32
 *)(
bh
)->
b_d©a
, \

3107 
	`PXT4_ADDR_PER_BLOCK
((
öode
)->
i_sb
))

	)

3109 
	#pxt4_öd_check_öode
(
öode
) \

3110 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3111 
	`PXT4_I
(
öode
)->
i_d©a
, \

3112 
PXT4_NDIR_BLOCKS
)

	)

3119 c⁄° 
fûe_›î©i⁄s
 
pxt4_dú_›î©i⁄s
;

3121 #ifde‡
CONFIG_UNICODE


3122 c⁄° 
díåy_›î©i⁄s
 
pxt4_díåy_›s
;

3126 c⁄° 
öode_›î©i⁄s
 
pxt4_fûe_öode_›î©i⁄s
;

3127 c⁄° 
fûe_›î©i⁄s
 
pxt4_fûe_›î©i⁄s
;

3128 
loff_t
 
pxt4_Œ£ek
(
fûe
 *fûe,Üoff_à
off£t
, 
‹igö
);

3131 
pxt4_gë_max_ölöe_size
(
öode
 *inode);

3132 
pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode);

3133 
pxt4_öô_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3134 
Àn
);

3135 
pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

3137 
pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page);

3138 
pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

3139 
öode
 *inode,

3140 
loff_t
 
pos
, 
Àn
,

3141 
Êags
,

3142 
∑ge
 **
∑gï
);

3143 
pxt4_wrôe_ölöe_d©a_íd
(
öode
 *inode,

3144 
loff_t
 
pos
, 
Àn
,

3145 
c›õd
,

3146 
∑ge
 *page);

3147 
buf„r_hód
 *

3148 
pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

3149 
Àn
,

3150 
∑ge
 *page);

3151 
pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

3152 
öode
 *inode,

3153 
loff_t
 
pos
, 
Àn
,

3154 
Êags
,

3155 
∑ge
 **
∑gï
,

3156 **
fsd©a
);

3157 
pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

3158 
Àn
, 
c›õd
,

3159 
∑ge
 *page);

3160 
pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3161 
pxt4_fûíame
 *
‚ame
,

3162 
öode
 *
dú
, inode *inode);

3163 
pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

3164 
öode
 *
∑ª¡
,

3165 
öode
 *inode);

3166 
pxt4_ªad_ölöe_dú
(
fûe
 *
fûp
,

3167 
dú_c⁄ãxt
 *
˘x
,

3168 *
has_ölöe_d©a
);

3169 
pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

3170 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

3171 
dx_hash_öfo
 *
höfo
,

3172 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

3173 *
has_ölöe_d©a
);

3174 
buf„r_hód
 *
pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

3175 
pxt4_fûíame
 *
‚ame
,

3176 
pxt4_dú_íåy_2
 **
ªs_dú
,

3177 *
has_ölöe_d©a
);

3178 
pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3179 
öode
 *
dú
,

3180 
pxt4_dú_íåy_2
 *
de_dñ
,

3181 
buf„r_hód
 *
bh
,

3182 *
has_ölöe_d©a
);

3183 
boﬁ
 
em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
);

3184 
buf„r_hód
 *
pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

3185 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3186 *
ªtvÆ
);

3187 
pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

3188 
fõm≠_exã¡_öfo
 *
fõöfo
,

3189 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
);

3191 
	giom≠
;

3192 
pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap);

3194 
pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
);

3196 
pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode);

3198 
ölöe
 
	$pxt4_has_ölöe_d©a
(
öode
 *inode)

3200  
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
) &&

3201 
	`PXT4_I
(
öode
)->
i_ölöe_off
;

3202 
	}
}

3205 c⁄° 
öode_›î©i⁄s
 
pxt4_dú_öode_›î©i⁄s
;

3206 c⁄° 
öode_›î©i⁄s
 
pxt4_•ecül_öode_›î©i⁄s
;

3207 
díåy
 *
pxt4_gë_∑ª¡
(díåy *
chûd
);

3208 
pxt4_dú_íåy_2
 *
pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

3209 
pxt4_dú_íåy_2
 *
de
,

3210 
blocksize
, 
csum_size
,

3211 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
);

3212 
pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

3213 
blocksize
);

3214 
pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3215 
buf„r_hód
 *
bh
);

3216 
pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
,

3217 c⁄° 
q°r
 *
‚ame
,

3218 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
);

3220 
	#S_SHIFT
 12

	)

3221 c⁄° 
	gpxt4_ty≥_by_mode
[(
S_IFMT
 >> 
S_SHIFT
) + 1] = {

3222 [
S_IFREG
 >> 
S_SHIFT
] = 
PXT4_FT_REG_FILE
,

3223 [
S_IFDIR
 >> 
S_SHIFT
] = 
PXT4_FT_DIR
,

3224 [
S_IFCHR
 >> 
S_SHIFT
] = 
PXT4_FT_CHRDEV
,

3225 [
S_IFBLK
 >> 
S_SHIFT
] = 
PXT4_FT_BLKDEV
,

3226 [
S_IFIFO
 >> 
S_SHIFT
] = 
PXT4_FT_FIFO
,

3227 [
S_IFSOCK
 >> 
S_SHIFT
] = 
PXT4_FT_SOCK
,

3228 [
S_IFLNK
 >> 
S_SHIFT
] = 
PXT4_FT_SYMLINK
,

3231 
ölöe
 
	$pxt4_£t_de_ty≥
(
su≥r_block
 *
sb
,

3232 
pxt4_dú_íåy_2
 *
de
,

3233 
umode_t
 
mode
) {

3234 i‡(
	`pxt4_has_„©uª_fûëy≥
(
sb
))

3235 
de
->
fûe_ty≥
 = 
pxt4_ty≥_by_mode
[(
mode
 & 
S_IFMT
)>>
S_SHIFT
];

3236 
	}
}

3239 
pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

3240 
li°_hód
 *
∑ges
, 
∑ge
 *page,

3241 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
);

3242 
__öô
 
pxt4_öô_po°_ªad_¥o˚ssög
();

3243 
pxt4_exô_po°_ªad_¥o˚ssög
();

3246 c⁄° 
öode_›î©i⁄s
 
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3247 c⁄° 
öode_›î©i⁄s
 
pxt4_symlök_öode_›î©i⁄s
;

3248 c⁄° 
öode_›î©i⁄s
 
pxt4_Á°_symlök_öode_›î©i⁄s
;

3251 
pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
);

3252 
pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
);

3253 
__öô
 
pxt4_öô_sysfs
();

3254 
pxt4_exô_sysfs
();

3257 
pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3258 
pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3259 
__öô
 
pxt4_öô_sy°em_z⁄e
();

3260 
pxt4_exô_sy°em_z⁄e
();

3261 
pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
,

3262 
pxt4_fsblk_t
 
°¨t_blk
,

3263 
cou¡
);

3264 
pxt4_check_blockªf
(const *, ,

3265 
öode
 *, 
__À32
 *, );

3268 
	gpxt4_ext_∑th
;

3269 
	gpxt4_exã¡
;

3275 
	#EXT_MAX_BLOCKS
 0xffffffff

	)

3277 
pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *);

3278 
pxt4_ext_wrôïage_å™s_blocks
(
öode
 *, );

3279 
pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
);

3280 
pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3281 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3282 
pxt4_ext_åunˇã
(
h™dÀ_t
 *, 
öode
 *);

3283 
pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

3284 
pxt4_lblk_t
 
íd
);

3285 
pxt4_ext_öô
(
su≥r_block
 *);

3286 
pxt4_ext_ªÀa£
(
su≥r_block
 *);

3287 
pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,

3288 
loff_t
 
Àn
);

3289 
pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3290 
loff_t
 
off£t
, 
ssize_t
 
Àn
);

3291 
pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3292 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3293 
pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *inode,

3294 
pxt4_lblk_t
 
lblocks
);

3295 
pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *inode,

3296 
num
,

3297 
pxt4_ext_∑th
 *
∑th
);

3298 
pxt4_ˇn_exã¡s_be_mîged
(
öode
 *inode,

3299 
pxt4_exã¡
 *
ex1
,

3300 
pxt4_exã¡
 *
ex2
);

3301 
pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *, 
öode
 *,

3302 
pxt4_ext_∑th
 **,

3303 
pxt4_exã¡
 *, );

3304 
pxt4_ext_∑th
 *
pxt4_föd_exã¡
(
öode
 *, 
pxt4_lblk_t
,

3305 
pxt4_ext_∑th
 **,

3306 
Êags
);

3307 
pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *);

3308 
pxt4_ext_check_öode
(
öode
 *inode);

3309 
pxt4_lblk_t
 
pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
);

3310 
pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

3311 
__u64
 
°¨t
, __u64 
Àn
);

3312 
pxt4_gë_es_ˇche
(
öode
 *inode,

3313 
fõm≠_exã¡_öfo
 *
fõöfo
,

3314 
__u64
 
°¨t
, __u64 
Àn
);

3315 
pxt4_ext_¥eˇche
(
öode
 *inode);

3316 
pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3317 
pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3318 
pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

3319 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,

3320 
pxt4_lblk_t
 
lblk2
,Öxt4_lblk_à
cou¡
,

3321 
m¨k_unwrôãn
,*
îr
);

3322 
pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
);

3325 
pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
,

3326 
öode
 *
£c⁄d
);

3327 
pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

3328 
öode
 *
d⁄‹_öode
);

3329 
pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
,

3330 
__u64
 
°¨t_‹ig
, __u64 
°¨t_d⁄‹
,

3331 
__u64
 
Àn
, __u64 *
moved_Àn
);

3334 
__öô
 
pxt4_öô_∑geio
();

3335 
pxt4_exô_∑geio
();

3336 
pxt4_io_íd_t
 *
pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
);

3337 
pxt4_io_íd_t
 *
pxt4_gë_io_íd
’xt4_io_íd_à*
io_íd
);

3338 
pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
);

3339 
pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
);

3340 
pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

3341 
wrôeback_c⁄åﬁ
 *
wbc
);

3342 
pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
);

3343 
pxt4_io_submô
(pxt4_io_submô *
io
);

3344 
pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

3345 
∑ge
 *page,

3346 
Àn
,

3347 
wrôeback_c⁄åﬁ
 *
wbc
,

3348 
boﬁ
 
kìp_towrôe
);

3351 
pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *, 
pxt4_fsblk_t
);

3354 c⁄° 
fsvîôy_›î©i⁄s
 
pxt4_vîôy›s
;

3361 
	#BH_BITMAP_UPTODATE
 
BH_JBDPriv©eSèπ


	)

3363 
ölöe
 
	$bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3365  (
	`buf„r_u±od©e
(
bh
) &&

3366 
	`ã°_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
));

3367 
	}
}

3368 
ölöe
 
	$£t_bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3370 
	`£t_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
);

3371 
	}
}

3373 
	#ö_ønge
(
b
, 
fú°
, 
Àn
Ë((bË>(fú°Ë&& (bË<(fú°Ë+ (ÀnË- 1)

	)

3376 
	#PXT4_WQ_HASH_SZ
 37

	)

3377 
	#pxt4_i€nd_wq
(
v
Ë(&
pxt4__i€nd_wq
[(()(v)) %\

3378 
PXT4_WQ_HASH_SZ
])

	)

3379 
waô_queue_hód_t
 
pxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

3381 
pxt4_ªsize_begö
(
su≥r_block
 *
sb
);

3382 
pxt4_ªsize_íd
(
su≥r_block
 *
sb
);

3384 
ölöe
 
	$pxt4_£t_io_unwrôãn_Êag
(
öode
 *inode,

3385 
pxt4_io_íd
 *
io_íd
)

3387 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
)) {

3388 
io_íd
->
Êag
 |
PXT4_IO_END_UNWRITTEN
;

3389 
	`©omic_öc
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
);

3391 
	}
}

3393 
ölöe
 
	$pxt4_˛ór_io_unwrôãn_Êag
(
pxt4_io_íd_t
 *
io_íd
)

3395 
öode
 *öodê
io_íd
->inode;

3397 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

3398 
io_íd
->
Êag
 &~
PXT4_IO_END_UNWRITTEN
;

3400 i‡(
	`©omic_dec_™d_ã°
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
))

3401 
	`wake_up_Æl
(
	`pxt4_i€nd_wq
(
öode
));

3403 
	}
}

3405 c⁄° 
iom≠_›s
 
pxt4_iom≠_›s
;

3407 
ölöe
 
	$pxt4_buf„r_u±od©e
(
buf„r_hód
 *
bh
)

3415 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& 
	`buf„r_wrôe_io_îr‹
(bh))

3416 
	`£t_buf„r_u±od©e
(
bh
);

3417  
	`buf„r_u±od©e
(
bh
);

3418 
	}
}

3422 
	#EFSBADCRC
 
EBADMSG


	)

3423 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@ext4_extents.h

7 #i‚de‡
_PXT4_EXTENTS


8 
	#_PXT4_EXTENTS


	)

10 
	~"pxt4.h
"

18 
	#AGGRESSIVE_TEST_


	)

25 
	#EXTENTS_STATS__


	)

31 
	#CHECK_BINSEARCH__


	)

37 
	#EXT_STATS_


	)

55 
	spxt4_exã¡_èû
 {

56 
__À32
 
	më_checksum
;

63 
	spxt4_exã¡
 {

64 
__À32
 
	mì_block
;

65 
__À16
 
	mì_Àn
;

66 
__À16
 
	mì_°¨t_hi
;

67 
__À32
 
	mì_°¨t_lo
;

74 
	spxt4_exã¡_idx
 {

75 
__À32
 
	mei_block
;

76 
__À32
 
	mei_Àaf_lo
;

78 
__À16
 
	mei_Àaf_hi
;

79 
__u16
 
	mei_unu£d
;

85 
	spxt4_exã¡_hódî
 {

86 
__À16
 
	meh_magic
;

87 
__À16
 
	meh_íåõs
;

88 
__À16
 
	meh_max
;

89 
__À16
 
	meh_dïth
;

90 
__À32
 
	meh_gíî©i⁄
;

93 
	#PXT4_EXT_MAGIC
 
	`˝u_to_À16
(0xf30a)

	)

94 
	#PXT4_MAX_EXTENT_DEPTH
 5

	)

96 
	#PXT4_EXTENT_TAIL_OFFSET
(
hdr
) \

97 ((
pxt4_exã¡_hódî
) + \

98 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
((
hdr
)->
eh_max
)))

	)

100 
ölöe
 
pxt4_exã¡_èû
 *

101 
	$föd_pxt4_exã¡_èû
(
pxt4_exã¡_hódî
 *
eh
)

103  (
pxt4_exã¡_èû
 *)(((*)
eh
) +

104 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

105 
	}
}

112 
	spxt4_ext_∑th
 {

113 
pxt4_fsblk_t
 
	mp_block
;

114 
__u16
 
	mp_dïth
;

115 
__u16
 
	mp_maxdïth
;

116 
pxt4_exã¡
 *
	mp_ext
;

117 
pxt4_exã¡_idx
 *
	mp_idx
;

118 
pxt4_exã¡_hódî
 *
	mp_hdr
;

119 
buf„r_hód
 *
	mp_bh
;

129 
	s∑πül_˛u°î
 {

130 
pxt4_fsblk_t
 
	mp˛u
;

131 
pxt4_lblk_t
 
	mlblk
;

132 íum {
	möôül
, 
	mto‰ì
, 
	mno‰ì
} 
	m°©e
;

156 
	#EXT_INIT_MAX_LEN
 (1UL << 15)

	)

157 
	#EXT_UNWRITTEN_MAX_LEN
 (
EXT_INIT_MAX_LEN
 - 1)

	)

160 
	#EXT_FIRST_EXTENT
(
__hdr__
) \

161 ((
pxt4_exã¡
 *Ë(((*Ë(
__hdr__
)) + \

162 (
pxt4_exã¡_hódî
)))

	)

163 
	#EXT_FIRST_INDEX
(
__hdr__
) \

164 ((
pxt4_exã¡_idx
 *Ë(((*Ë(
__hdr__
)) + \

165 (
pxt4_exã¡_hódî
)))

	)

166 
	#EXT_HAS_FREE_INDEX
(
__∑th__
) \

167 (
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_íåõs
) \

168 < 
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_max
))

	)

169 
	#EXT_LAST_EXTENT
(
__hdr__
) \

170 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

171 
	#EXT_LAST_INDEX
(
__hdr__
) \

172 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

173 
	#EXT_MAX_EXTENT
(
__hdr__
) \

174 ((
	`À16_to_˝u
((
__hdr__
)->
eh_max
)) ? \

175 ((
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
) - 1)) \

176 : 0)

	)

177 
	#EXT_MAX_INDEX
(
__hdr__
) \

178 ((
	`À16_to_˝u
((
__hdr__
)->
eh_max
)) ? \

179 ((
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)Ë: 0)

	)

181 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_öode_hdr
(
öode
 *inode)

183  (
pxt4_exã¡_hódî
 *Ë
	`PXT4_I
(
öode
)->
i_d©a
;

184 
	}
}

186 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_block_hdr
(
buf„r_hód
 *
bh
)

188  (
pxt4_exã¡_hódî
 *Ë
bh
->
b_d©a
;

189 
	}
}

191 
ölöe
 
	$ext_dïth
(
öode
 *inode)

193  
	`À16_to_˝u
(
	`ext_öode_hdr
(
öode
)->
eh_dïth
);

194 
	}
}

196 
ölöe
 
	$pxt4_ext_m¨k_unwrôãn
(
pxt4_exã¡
 *
ext
)

199 
	`BUG_ON
((
	`À16_to_˝u
(
ext
->
ì_Àn
Ë& ~
EXT_INIT_MAX_LEN
) == 0);

200 
ext
->
ì_Àn
 |
	`˝u_to_À16
(
EXT_INIT_MAX_LEN
);

201 
	}
}

203 
ölöe
 
	$pxt4_ext_is_unwrôãn
(
pxt4_exã¡
 *
ext
)

206  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë> 
EXT_INIT_MAX_LEN
);

207 
	}
}

209 
ölöe
 
	$pxt4_ext_gë_a˘uÆ_Àn
(
pxt4_exã¡
 *
ext
)

211  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë<
EXT_INIT_MAX_LEN
 ?

212 
	`À16_to_˝u
(
ext
->
ì_Àn
) :

213 (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë- 
EXT_INIT_MAX_LEN
));

214 
	}
}

216 
ölöe
 
	$pxt4_ext_m¨k_öôülized
(
pxt4_exã¡
 *
ext
)

218 
ext
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ext));

219 
	}
}

225 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_ext_pblock
(
pxt4_exã¡
 *
ex
)

227 
pxt4_fsblk_t
 
block
;

229 
block
 = 
	`À32_to_˝u
(
ex
->
ì_°¨t_lo
);

230 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ex
->
ì_°¨t_hi
) << 31) << 1;

231  
block
;

232 
	}
}

238 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_idx_pblock
(
pxt4_exã¡_idx
 *
ix
)

240 
pxt4_fsblk_t
 
block
;

242 
block
 = 
	`À32_to_˝u
(
ix
->
ei_Àaf_lo
);

243 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ix
->
ei_Àaf_hi
) << 31) << 1;

244  
block
;

245 
	}
}

252 
ölöe
 
	$pxt4_ext_°‹e_pblock
(
pxt4_exã¡
 *
ex
,

253 
pxt4_fsblk_t
 
pb
)

255 
ex
->
ì_°¨t_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

256 
ex
->
ì_°¨t_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

258 
	}
}

265 
ölöe
 
	$pxt4_idx_°‹e_pblock
(
pxt4_exã¡_idx
 *
ix
,

266 
pxt4_fsblk_t
 
pb
)

268 
ix
->
ei_Àaf_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

269 
ix
->
ei_Àaf_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

271 
	}
}

273 
	#pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
) \

274 
	`__pxt4_ext_dúty
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), (
∑th
))

	)

275 
__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

276 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
);

	@ext4_jbd2.c

6 
	~"pxt4_jbd3.h
"

8 
	~<åa˚/evíts/pxt4.h
>

11 
h™dÀ_t
 *
	$pxt4_gë_nojou∫Æ
()

13 
h™dÀ_t
 *
h™dÀ
 = 
cuºít
->
jou∫Æ_öfo
;

14 
ªf_˙t
 = ()
h™dÀ
;

16 
	`BUG_ON
(
ªf_˙t
 >
PXT4_NOJOURNAL_MAX_REF_COUNT
);

18 
ªf_˙t
++;

19 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

21 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

22  
h™dÀ
;

23 
	}
}

27 
	$pxt4_put_nojou∫Æ
(
h™dÀ_t
 *
h™dÀ
)

29 
ªf_˙t
 = ()
h™dÀ
;

31 
	`BUG_ON
(
ªf_˙t
 == 0);

33 
ªf_˙t
--;

34 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

36 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

37 
	}
}

42 
	$pxt4_jou∫Æ_check_°¨t
(
su≥r_block
 *
sb
)

44 
jou∫Æ_t
 *
jou∫Æ
;

46 
	`might_¶ìp
();

48 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

49  -
EIO
;

51 i‡(
	`sb_rd⁄ly
(
sb
))

52  -
EROFS
;

53 
	`WARN_ON
(
sb
->
s_wrôîs
.
‰ozí
 =
SB_FREEZE_COMPLETE
);

54 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

60 i‡(
jou∫Æ
 && 
	`is_jou∫Æ_ab‹ãd
(journal)) {

61 
	`pxt4_ab‹t
(
sb
, "Detectedáborted journal");

62  -
EROFS
;

65 
	}
}

67 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

68 
ty≥
, 
blocks
, 
rsv_blocks
)

70 
jou∫Æ_t
 *
jou∫Æ
;

71 
îr
;

73 
	`åa˚_pxt4_jou∫Æ_°¨t
(
sb
, 
blocks
, 
rsv_blocks
, 
_RET_IP_
);

74 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

75 i‡(
îr
 < 0)

76  
	`ERR_PTR
(
îr
);

78 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

79 i‡(!
jou∫Æ
)

80  
	`pxt4_gë_nojou∫Æ
();

81  
	`jbd3__jou∫Æ_°¨t
(
jou∫Æ
, 
blocks
, 
rsv_blocks
, 
GFP_NOFS
,

82 
ty≥
, 
löe
);

83 
	}
}

85 
	$__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
)

87 
su≥r_block
 *
sb
;

88 
îr
;

89 
rc
;

91 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

92 
	`pxt4_put_nojou∫Æ
(
h™dÀ
);

96 
îr
 = 
h™dÀ
->
h_îr
;

97 i‡(!
h™dÀ
->
h_å™ß˘i⁄
) {

98 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

99  
îr
 ?Éº : 
rc
;

102 
sb
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
;

103 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

105 i‡(!
îr
)

106 
îr
 = 
rc
;

107 i‡(
îr
)

108 
	`__pxt4_°d_îr‹
(
sb
, 
whîe
, 
löe
, 
îr
);

109  
îr
;

110 
	}
}

112 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ_t
 *
h™dÀ
, 
löe
,

113 
ty≥
)

115 
su≥r_block
 *
sb
;

116 
îr
;

118 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

119  
	`pxt4_gë_nojou∫Æ
();

121 
sb
 = 
h™dÀ
->
h_jou∫Æ
->
j_¥iv©e
;

122 
	`åa˚_pxt4_jou∫Æ_°¨t_ª£rved
(
sb
, 
h™dÀ
->
h_buf„r_¸edôs
,

123 
_RET_IP_
);

124 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

125 i‡(
îr
 < 0) {

126 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

127  
	`ERR_PTR
(
îr
);

130 
îr
 = 
	`jbd3_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
, 
löe
);

131 i‡(
îr
 < 0)

132  
	`ERR_PTR
(
îr
);

133  
h™dÀ
;

134 
	}
}

136 
	$pxt4_jou∫Æ_ab‹t_h™dÀ
(c⁄° *
ˇŒî
, 
löe
,

137 c⁄° *
îr_‚
,

138 
buf„r_hód
 *
bh
,

139 
h™dÀ_t
 *
h™dÀ
, 
îr
)

141 
nbuf
[16];

142 c⁄° *
îr°r
 = 
	`pxt4_decode_îr‹
(
NULL
, 
îr
, 
nbuf
);

144 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

146 i‡(
bh
)

147 
	`BUFFER_TRACE
(
bh
, "abort");

149 i‡(!
h™dÀ
->
h_îr
)

150 
h™dÀ
->
h_îr
 = 
îr
;

152 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

155 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d:ábortingÅransaction: %s in %s\n",

156 
ˇŒî
, 
löe
, 
îr°r
, 
îr_‚
);

158 
	`jbd3_jou∫Æ_ab‹t_h™dÀ
(
h™dÀ
);

159 
	}
}

161 
	$__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

162 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

164 
îr
 = 0;

166 
	`might_¶ìp
();

168 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

169 
îr
 = 
	`jbd3_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

170 i‡(
îr
)

171 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

172 
h™dÀ
, 
îr
);

174  
îr
;

175 
	}
}

189 
	$__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

190 
is_mëad©a
, 
öode
 *inode,

191 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
)

193 
îr
;

195 
	`might_¶ìp
();

197 
	`åa˚_pxt4_f‹gë
(
öode
, 
is_mëad©a
, 
blockƒ
);

198 
	`BUFFER_TRACE
(
bh
, "enter");

200 
	`jbd_debug
(4, "forgetting bh %p: is_metadata = %d, mode %o, "

202 
bh
, 
is_mëad©a
, 
öode
->
i_mode
,

203 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
));

206 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

207 
	`bf‹gë
(
bh
);

216 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

217 (!
is_mëad©a
 && !
	`pxt4_should_jou∫Æ_d©a
(
öode
))) {

218 i‡(
bh
) {

219 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_forget");

220 
îr
 = 
	`jbd3_jou∫Æ_f‹gë
(
h™dÀ
, 
bh
);

221 i‡(
îr
)

222 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

223 
bh
, 
h™dÀ
, 
îr
);

224  
îr
;

232 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_revoke");

233 
îr
 = 
	`jbd3_jou∫Æ_ªvoke
(
h™dÀ
, 
blockƒ
, 
bh
);

234 i‡(
îr
) {

235 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

236 
bh
, 
h™dÀ
, 
îr
);

237 
	`__pxt4_ab‹t
(
öode
->
i_sb
, 
whîe
, 
löe
,

238 "îr‹ %d whíáâem±ögÑevoke", 
îr
);

240 
	`BUFFER_TRACE
(
bh
, "exit");

241  
îr
;

242 
	}
}

244 
	$__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

245 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

247 
îr
 = 0;

249 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

250 
îr
 = 
	`jbd3_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

251 i‡(
îr
)

252 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

253 
bh
, 
h™dÀ
, 
îr
);

255  
îr
;

256 
	}
}

258 
	$__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

259 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

260 
buf„r_hód
 *
bh
)

262 
îr
 = 0;

264 
	`might_¶ìp
();

266 
	`£t_buf„r_mëa
(
bh
);

267 
	`£t_buf„r_¥io
(
bh
);

268 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

269 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

271 i‡(!
	`is_h™dÀ_ab‹ãd
(
h™dÀ
Ë&& 
	`WARN_ON_ONCE
(
îr
)) {

272 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

273 
h™dÀ
, 
îr
);

274 i‡(
öode
 =
NULL
) {

275 
	`¥_îr
("PXT4: jbd3_journal_dirty_metadata "

278 
h™dÀ
->
h_ty≥
,

279 
h™dÀ
->
h_löe_no
,

280 
h™dÀ
->
h_ªque°ed_¸edôs
,

281 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

282  
îr
;

284 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

285 
bh
->
b_blockƒ
,

289 
h™dÀ
->
h_ty≥
,

290 
h™dÀ
->
h_löe_no
,

291 
h™dÀ
->
h_ªque°ed_¸edôs
,

292 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

295 i‡(
öode
)

296 
	`m¨k_buf„r_dúty_öode
(
bh
, 
öode
);

298 
	`m¨k_buf„r_dúty
(
bh
);

299 i‡(
öode
 && 
	`öode_√eds_sync
(inode)) {

300 
	`sync_dúty_buf„r
(
bh
);

301 i‡(
	`buf„r_ªq
(
bh
Ë&& !
	`buf„r_u±od©e
(bh)) {

302 
pxt4_su≥r_block
 *
es
;

304 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

305 
es
->
s_œ°_îr‹_block
 =

306 
	`˝u_to_À64
(
bh
->
b_blockƒ
);

307 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

308 
bh
->
b_blockƒ
,

310 
îr
 = -
EIO
;

314  
îr
;

315 
	}
}

317 
	$__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

318 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
)

320 
buf„r_hód
 *
bh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

321 
îr
 = 0;

323 
	`pxt4_su≥rblock_csum_£t
(
sb
);

324 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

325 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

326 i‡(
îr
)

327 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

328 
bh
, 
h™dÀ
, 
îr
);

330 
	`m¨k_buf„r_dúty
(
bh
);

331  
îr
;

332 
	}
}

	@ext4_jbd2.h

12 #i‚de‡
_PXT4_JBD3_H


13 
	#_PXT4_JBD3_H


	)

15 
	~<löux/fs.h
>

16 
	~<löux/jbd3.h
>

17 
	~"pxt4.h
"

19 
	#PXT4_JOURNAL
(
öode
Ë(
	`PXT4_SB
((öode)->
i_sb
)->
s_jou∫Æ
)

	)

33 
	#PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
) \

34 (
	`pxt4_has_„©uª_exã¡s
(
sb
Ë? 20U : 8U)

	)

40 
	#PXT4_XATTR_TRANS_BLOCKS
 6U

	)

48 
	#PXT4_DATA_TRANS_BLOCKS
(
sb
Ë(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(sb) + \

49 
PXT4_XATTR_TRANS_BLOCKS
 - 2 + \

50 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

57 
	#PXT4_META_TRANS_BLOCKS
(
sb
Ë(
PXT4_XATTR_TRANS_BLOCKS
 + \

58 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

66 
	#PXT4_MAX_TRANS_DATA
 64U

	)

75 
	#PXT4_RESERVE_TRANS_BLOCKS
 12U

	)

84 
	#PXT4_INDEX_EXTRA_TRANS_BLOCKS
 12U

	)

86 #ifde‡
CONFIG_QUOTA


89 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

90 
	`pxt4_has_„©uª_quŸa
(
sb
)Ë? 1 : 0)

	)

93 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

94 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

95 (
DQUOT_INIT_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

96 +3+
DQUOT_INIT_REWRITE
Ë: 0)

	)

98 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

99 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

100 (
DQUOT_DEL_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

101 +3+
DQUOT_DEL_REWRITE
Ë: 0)

	)

103 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë0

	)

104 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë0

	)

105 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë0

	)

107 
	#PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_TRANS_BLOCKS
(sb))

	)

108 
	#PXT4_MAXQUOTAS_INIT_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_INIT_BLOCKS
(sb))

	)

109 
	#PXT4_MAXQUOTAS_DEL_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_DEL_BLOCKS
(sb))

	)

114 
	#PXT4_HT_MISC
 0

	)

115 
	#PXT4_HT_INODE
 1

	)

116 
	#PXT4_HT_WRITE_PAGE
 2

	)

117 
	#PXT4_HT_MAP_BLOCKS
 3

	)

118 
	#PXT4_HT_DIR
 4

	)

119 
	#PXT4_HT_TRUNCATE
 5

	)

120 
	#PXT4_HT_QUOTA
 6

	)

121 
	#PXT4_HT_RESIZE
 7

	)

122 
	#PXT4_HT_MIGRATE
 8

	)

123 
	#PXT4_HT_MOVE_EXTENTS
 9

	)

124 
	#PXT4_HT_XATTR
 10

	)

125 
	#PXT4_HT_EXT_CONVERT
 11

	)

126 
	#PXT4_HT_MAX
 12

	)

136 
	spxt4_jou∫Æ_cb_íåy
 {

138 
li°_hód
 
	mj˚_li°
;

141 (*
	mj˚_func
)(
su≥r_block
 *
	msb
,

142 
pxt4_jou∫Æ_cb_íåy
 *
	mj˚
, 
	mîr‹
);

168 
ölöe
 
	$_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

169 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

172 
	`li°_add_èû
(&
j˚
->
j˚_li°
, &
h™dÀ
->
h_å™ß˘i⁄
->
t_¥iv©e_li°
);

173 
	}
}

175 
ölöe
 
	$pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

176 (*
func
)(
su≥r_block
 *
sb
,

177 
pxt4_jou∫Æ_cb_íåy
 *
j˚
,

178 
rc
),

179 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

181 
pxt4_sb_öfo
 *
sbi
 =

182 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

185 
j˚
->
j˚_func
 = 
func
;

186 
	`•ö_lock
(&
sbi
->
s_md_lock
);

187 
	`_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ
, 
j˚
);

188 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

189 
	}
}

198 
ölöe
 
boﬁ
 
	$pxt4_jou∫Æ_ˇŒback_åy_dñ
(
h™dÀ_t
 *
h™dÀ
,

199 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

201 
boﬁ
 
dñëed
;

202 
pxt4_sb_öfo
 *
sbi
 =

203 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

205 
	`•ö_lock
(&
sbi
->
s_md_lock
);

206 
dñëed
 = !
	`li°_em±y
(&
j˚
->
j˚_li°
);

207 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

208 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

209  
dñëed
;

210 
	}
}

213 
pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

214 
öode
 *inode,

215 
pxt4_ûoc
 *
ûoc
);

222 
pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

223 
pxt4_ûoc
 *
ûoc
);

225 
pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

227 
pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

228 
√w_exåa_isize
,

229 
pxt4_ûoc
 *
ûoc
);

233 
__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

234 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

236 
__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

237 
is_mëad©a
, 
öode
 *inode,

238 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
);

240 
__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

241 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

243 
__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

244 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

245 
buf„r_hód
 *
bh
);

247 
__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

248 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
);

250 
	#pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
) \

251 
	`__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

252 
	#pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block_ƒ
) \

253 
	`__pxt4_f‹gë
(
__func__
, 
__LINE__
, (
h™dÀ
), (
is_mëad©a
), (
öode
), \

254 (
bh
), (
block_ƒ
))

	)

255 
	#pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
) \

256 
	`__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

257 
	#pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
) \

258 
	`__pxt4_h™dÀ_dúty_mëad©a
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), \

259 (
bh
))

	)

260 
	#pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
) \

261 
	`__pxt4_h™dÀ_dúty_su≥r
(
__func__
, 
__LINE__
, (
h™dÀ
), (
sb
))

	)

263 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

264 
ty≥
, 
blocks
, 
rsv_blocks
);

265 
__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
);

267 
	#PXT4_NOJOURNAL_MAX_REF_COUNT
 ((Ë4096)

	)

271 
ölöe
 
	$pxt4_h™dÀ_vÆid
(
h™dÀ_t
 *
h™dÀ
)

273 i‡(()
h™dÀ
 < 
PXT4_NOJOURNAL_MAX_REF_COUNT
)

276 
	}
}

278 
ölöe
 
	$pxt4_h™dÀ_sync
(
h™dÀ_t
 *
h™dÀ
)

280 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

281 
h™dÀ
->
h_sync
 = 1;

282 
	}
}

284 
ölöe
 
	$pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ_t
 *
h™dÀ
)

286 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

287  
	`is_h™dÀ_ab‹ãd
(
h™dÀ
);

289 
	}
}

291 
ölöe
 
	$pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
√eded
)

293 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& h™dÀ->
h_buf„r_¸edôs
 < 
√eded
)

296 
	}
}

298 
	#pxt4_jou∫Æ_°¨t_sb
(
sb
, 
ty≥
, 
nblocks
) \

299 
	`__pxt4_jou∫Æ_°¨t_sb
((
sb
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

301 
	#pxt4_jou∫Æ_°¨t
(
öode
, 
ty≥
, 
nblocks
) \

302 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

304 
	#pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
, 
ty≥
, 
blocks
, 
rsv_blocks
) \

305 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
blocks
), (
rsv_blocks
))

	)

307 
ölöe
 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t
(
öode
 *inode,

308 
löe
, 
ty≥
,

309 
blocks
, 
rsv_blocks
)

311  
	`__pxt4_jou∫Æ_°¨t_sb
(
öode
->
i_sb
, 
löe
, 
ty≥
, 
blocks
,

312 
rsv_blocks
);

313 
	}
}

315 
	#pxt4_jou∫Æ_°›
(
h™dÀ
) \

316 
	`__pxt4_jou∫Æ_°›
(
__func__
, 
__LINE__
, (
h™dÀ
))

	)

318 
	#pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
) \

319 
	`__pxt4_jou∫Æ_°¨t_ª£rved
((
h™dÀ
), 
__LINE__
, (
ty≥
))

	)

321 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_ª£rved
(h™dÀ_à*
h™dÀ
, 
löe
,

322 
ty≥
);

324 
ölöe
 
	$pxt4_jou∫Æ_‰ì_ª£rved
(
h™dÀ_t
 *
h™dÀ
)

326 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

327 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

328 
	}
}

330 
ölöe
 
h™dÀ_t
 *
	$pxt4_jou∫Æ_cuºít_h™dÀ
()

332  
	`jou∫Æ_cuºít_h™dÀ
();

333 
	}
}

335 
ölöe
 
	$pxt4_jou∫Æ_exãnd
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

337 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

338  
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
, 
nblocks
);

340 
	}
}

342 
ölöe
 
	$pxt4_jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

344 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

345  
	`jbd3_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

347 
	}
}

349 
ölöe
 
	$pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
 *inode)

351 i‡(
	`PXT4_JOURNAL
(
öode
Ë!
NULL
)

352  
	`jbd3_jou∫Æ_blocks_≥r_∑ge
(
öode
);

354 
	}
}

356 
ölöe
 
	$pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

358 i‡(
jou∫Æ
)

359  
	`jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

361 
	}
}

363 
ölöe
 
	$pxt4_jbd3_öode_add_wrôe
(
h™dÀ_t
 *
h™dÀ
,

364 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

366 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

367  
	`jbd3_jou∫Æ_öode_ønged_wrôe
(
h™dÀ
,

368 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

370 
	}
}

372 
ölöe
 
	$pxt4_jbd3_öode_add_waô
(
h™dÀ_t
 *
h™dÀ
,

373 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

375 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

376  
	`jbd3_jou∫Æ_öode_ønged_waô
(
h™dÀ
,

377 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

379 
	}
}

381 
ölöe
 
	$pxt4_upd©e_öode_fsync_å™s
(
h™dÀ_t
 *
h™dÀ
,

382 
öode
 *inode,

383 
d©async
)

385 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

387 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& !
	`is_h™dÀ_ab‹ãd
(handle)) {

388 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

389 i‡(
d©async
)

390 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

392 
	}
}

395 
pxt4_f‹˚_commô
(
su≥r_block
 *
sb
);

400 
	#PXT4_INODE_JOURNAL_DATA_MODE
 0x01

	)

401 
	#PXT4_INODE_ORDERED_DATA_MODE
 0x02

	)

402 
	#PXT4_INODE_WRITEBACK_DATA_MODE
 0x04

	)

404 
ölöe
 
	$pxt4_öode_jou∫Æ_mode
(
öode
 *inode)

406 i‡(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
)

407  
PXT4_INODE_WRITEBACK_DATA_MODE
;

409 i‡(!
	`S_ISREG
(
öode
->
i_mode
) ||

410 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

411 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
) &&

412 !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))) {

414 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode))

415  
PXT4_INODE_ORDERED_DATA_MODE
;

416  
PXT4_INODE_JOURNAL_DATA_MODE
;

418 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

419  
PXT4_INODE_ORDERED_DATA_MODE
;

420 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

421  
PXT4_INODE_WRITEBACK_DATA_MODE
;

422 
	`BUG
();

423 
	}
}

425 
ölöe
 
	$pxt4_should_jou∫Æ_d©a
(
öode
 *inode)

427  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_JOURNAL_DATA_MODE
;

428 
	}
}

430 
ölöe
 
	$pxt4_should_‹dî_d©a
(
öode
 *inode)

432  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_ORDERED_DATA_MODE
;

433 
	}
}

435 
ölöe
 
	$pxt4_should_wrôeback_d©a
(
öode
 *inode)

437  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_WRITEBACK_DATA_MODE
;

438 
	}
}

449 
ölöe
 
	$pxt4_should_di‹ód_nﬁock
(
öode
 *inode)

451 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DIOREAD_NOLOCK
))

453 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

455 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

457 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

460 
	}
}

	@extents.c

20 
	~<löux/fs.h
>

21 
	~<löux/time.h
>

22 
	~<löux/jbd3.h
>

23 
	~<löux/highuid.h
>

24 
	~<löux/∑gem≠.h
>

25 
	~<löux/quŸa›s.h
>

26 
	~<löux/°rög.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/uac˚ss.h
>

29 
	~<löux/fõm≠.h
>

30 
	~<löux/backög-dev.h
>

31 
	~"pxt4_jbd3.h
"

32 
	~"pxt4_exã¡s.h
"

33 
	~"x©å.h
"

35 
	~<åa˚/evíts/pxt4.h
>

40 
	#PXT4_EXT_MAY_ZEROOUT
 0x1

	)

42 
	#PXT4_EXT_MARK_UNWRIT1
 0x2

	)

43 
	#PXT4_EXT_MARK_UNWRIT2
 0x4

	)

45 
	#PXT4_EXT_DATA_VALID1
 0x8

	)

46 
	#PXT4_EXT_DATA_VALID2
 0x10

	)

48 
__À32
 
	$pxt4_exã¡_block_csum
(
öode
 *inode,

49 
pxt4_exã¡_hódî
 *
eh
)

51 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

52 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

53 
__u32
 
csum
;

55 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
eh
,

56 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

57  
	`˝u_to_À32
(
csum
);

58 
	}
}

60 
	$pxt4_exã¡_block_csum_vîify
(
öode
 *inode,

61 
pxt4_exã¡_hódî
 *
eh
)

63 
pxt4_exã¡_èû
 *
ë
;

65 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

68 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

69 i‡(
ë
->
ë_checksum
 !
	`pxt4_exã¡_block_csum
(
öode
, 
eh
))

72 
	}
}

74 
	$pxt4_exã¡_block_csum_£t
(
öode
 *inode,

75 
pxt4_exã¡_hódî
 *
eh
)

77 
pxt4_exã¡_èû
 *
ë
;

79 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

82 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

83 
ë
->
ë_checksum
 = 
	`pxt4_exã¡_block_csum
(
öode
, 
eh
);

84 
	}
}

86 
pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

87 
öode
 *inode,

88 
pxt4_ext_∑th
 **
µ©h
,

89 
pxt4_m≠_blocks
 *
m≠
,

90 
•lô_Êag
,

91 
Êags
);

93 
pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

94 
öode
 *inode,

95 
pxt4_ext_∑th
 **
µ©h
,

96 
pxt4_lblk_t
 
•lô
,

97 
•lô_Êag
,

98 
Êags
);

100 
pxt4_föd_dñayed_exã¡
(
öode
 *inode,

101 
exã¡_°©us
 *
√wes
);

103 
	$pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ_t
 *
h™dÀ
,

104 
öode
 *inode,

105 
√eded
)

107 
îr
;

109 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

111 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
√eded
)

117 
√eded
 += 3;

118 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
 - h™dÀ->
h_buf„r_¸edôs
);

119 i‡(
îr
 <= 0)

120  
îr
;

121 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
, 
√eded
);

122 i‡(
îr
 == 0)

123 
îr
 = -
EAGAIN
;

125  
îr
;

126 
	}
}

133 
	$pxt4_ext_gë_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

134 
pxt4_ext_∑th
 *
∑th
)

136 i‡(
∑th
->
p_bh
) {

138 
	`BUFFER_TRACE
(
∑th
->
p_bh
, "get_write_access");

139  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
∑th
->
p_bh
);

144 
	}
}

152 
	$__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

153 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

155 
îr
;

157 
	`WARN_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

158 i‡(
∑th
->
p_bh
) {

159 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
	`ext_block_hdr
(
∑th
->
p_bh
));

161 
îr
 = 
	`__pxt4_h™dÀ_dúty_mëad©a
(
whîe
, 
löe
, 
h™dÀ
,

162 
öode
, 
∑th
->
p_bh
);

165 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

167  
îr
;

168 
	}
}

170 
pxt4_fsblk_t
 
	$pxt4_ext_föd_gﬂl
(
öode
 *inode,

171 
pxt4_ext_∑th
 *
∑th
,

172 
pxt4_lblk_t
 
block
)

174 i‡(
∑th
) {

175 
dïth
 = 
∑th
->
p_dïth
;

176 
pxt4_exã¡
 *
ex
;

195 
ex
 = 
∑th
[
dïth
].
p_ext
;

196 i‡(
ex
) {

197 
pxt4_fsblk_t
 
ext_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

198 
pxt4_lblk_t
 
ext_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

200 i‡(
block
 > 
ext_block
)

201  
ext_pblk
 + (
block
 - 
ext_block
);

203  
ext_pblk
 - (
ext_block
 - 
block
);

208 i‡(
∑th
[
dïth
].
p_bh
)

209  
∑th
[
dïth
].
p_bh
->
b_blockƒ
;

213  
	`pxt4_öode_to_gﬂl_block
(
öode
);

214 
	}
}

219 
pxt4_fsblk_t


220 
	$pxt4_ext_√w_mëa_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

221 
pxt4_ext_∑th
 *
∑th
,

222 
pxt4_exã¡
 *
ex
, *
îr
, 
Êags
)

224 
pxt4_fsblk_t
 
gﬂl
, 
√wblock
;

226 
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
	`À32_to_˝u
(
ex
->
ì_block
));

227 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

228 
NULL
, 
îr
);

229  
√wblock
;

230 
	}
}

232 
ölöe
 
	$pxt4_ext_•a˚_block
(
öode
 *öode, 
check
)

234 
size
;

236 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

237 / (
pxt4_exã¡
);

238 #ifde‡
AGGRESSIVE_TEST


239 i‡(!
check
 && 
size
 > 6)

240 
size
 = 6;

242  
size
;

243 
	}
}

245 
ölöe
 
	$pxt4_ext_•a˚_block_idx
(
öode
 *öode, 
check
)

247 
size
;

249 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

250 / (
pxt4_exã¡_idx
);

251 #ifde‡
AGGRESSIVE_TEST


252 i‡(!
check
 && 
size
 > 5)

253 
size
 = 5;

255  
size
;

256 
	}
}

258 
ölöe
 
	$pxt4_ext_•a˚_roŸ
(
öode
 *öode, 
check
)

260 
size
;

262 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

263 
size
 -(
pxt4_exã¡_hódî
);

264 
size
 /(
pxt4_exã¡
);

265 #ifde‡
AGGRESSIVE_TEST


266 i‡(!
check
 && 
size
 > 3)

267 
size
 = 3;

269  
size
;

270 
	}
}

272 
ölöe
 
	$pxt4_ext_•a˚_roŸ_idx
(
öode
 *öode, 
check
)

274 
size
;

276 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

277 
size
 -(
pxt4_exã¡_hódî
);

278 
size
 /(
pxt4_exã¡_idx
);

279 #ifde‡
AGGRESSIVE_TEST


280 i‡(!
check
 && 
size
 > 4)

281 
size
 = 4;

283  
size
;

284 
	}
}

286 
ölöe
 

287 
	$pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

288 
pxt4_ext_∑th
 **
µ©h
, 
pxt4_lblk_t
 
lblk
,

289 
noÁû
)

291 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

292 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
∑th
[∑th->
p_dïth
].
p_ext
);

294  
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
, 
lblk
, 
unwrôãn
 ?

295 
PXT4_EXT_MARK_UNWRIT1
|
PXT4_EXT_MARK_UNWRIT2
 : 0,

296 
PXT4_EX_NOCACHE
 | 
PXT4_GET_BLOCKS_PRE_IO
 |

297 (
noÁû
 ? 
PXT4_GET_BLOCKS_METADATA_NOFAIL
:0));

298 
	}
}

305 
	$pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
)

307 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

308 
idxs
;

310 
idxs
 = ((
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

311 / (
pxt4_exã¡_idx
));

321 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

322 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
+1 =
lblock
) {

323 
num
 = 0;

325 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % 
idxs
) == 0)

326 
num
++;

327 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs)) == 0)

328 
num
++;

329 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs*idxs)) == 0) {

330 
num
++;

331 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

333 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

334 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
++;

335  
num
;

342 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

343 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
;

344  
	`ext_dïth
(
öode
) + 1;

345 
	}
}

348 
	$pxt4_ext_max_íåõs
(
öode
 *öode, 
dïth
)

350 
max
;

352 i‡(
dïth
 =
	`ext_dïth
(
öode
)) {

353 i‡(
dïth
 == 0)

354 
max
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 1);

356 
max
 = 
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 1);

358 i‡(
dïth
 == 0)

359 
max
 = 
	`pxt4_ext_•a˚_block
(
öode
, 1);

361 
max
 = 
	`pxt4_ext_•a˚_block_idx
(
öode
, 1);

364  
max
;

365 
	}
}

367 
	$pxt4_vÆid_exã¡
(
öode
 *öode, 
pxt4_exã¡
 *
ext
)

369 
pxt4_fsblk_t
 
block
 = 
	`pxt4_ext_pblock
(
ext
);

370 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

371 
pxt4_lblk_t
 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

378 i‡(
lblock
 + 
Àn
 <=Üblock)

380  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 
Àn
);

381 
	}
}

383 
	$pxt4_vÆid_exã¡_idx
(
öode
 *inode,

384 
pxt4_exã¡_idx
 *
ext_idx
)

386 
pxt4_fsblk_t
 
block
 = 
	`pxt4_idx_pblock
(
ext_idx
);

388  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 1);

389 
	}
}

391 
	$pxt4_vÆid_exã¡_íåõs
(
öode
 *inode,

392 
pxt4_exã¡_hódî
 *
eh
,

393 
dïth
)

395 
íåõs
;

396 i‡(
eh
->
eh_íåõs
 == 0)

399 
íåõs
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
);

401 i‡(
dïth
 == 0) {

403 
pxt4_exã¡
 *
ext
 = 
	`EXT_FIRST_EXTENT
(
eh
);

404 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

405 
pxt4_fsblk_t
 
pblock
 = 0;

406 
pxt4_lblk_t
 
lblock
 = 0;

407 
pxt4_lblk_t
 
¥ev
 = 0;

408 
Àn
 = 0;

409 
íåõs
) {

410 i‡(!
	`pxt4_vÆid_exã¡
(
öode
, 
ext
))

414 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

415 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

416 i‡((
lblock
 <
¥ev
) &&Örev) {

417 
pblock
 = 
	`pxt4_ext_pblock
(
ext
);

418 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
pblock
);

421 
ext
++;

422 
íåõs
--;

423 
¥ev
 = 
lblock
 + 
Àn
 - 1;

426 
pxt4_exã¡_idx
 *
ext_idx
 = 
	`EXT_FIRST_INDEX
(
eh
);

427 
íåõs
) {

428 i‡(!
	`pxt4_vÆid_exã¡_idx
(
öode
, 
ext_idx
))

430 
ext_idx
++;

431 
íåõs
--;

435 
	}
}

437 
	$__pxt4_ext_check
(c⁄° *
fun˘i⁄
, 
löe
,

438 
öode
 *öode, 
pxt4_exã¡_hódî
 *
eh
,

439 
dïth
, 
pxt4_fsblk_t
 
pblk
)

441 c⁄° *
îr‹_msg
;

442 
max
 = 0, 
îr
 = -
EFSCORRUPTED
;

444 i‡(
	`u∆ikñy
(
eh
->
eh_magic
 !
PXT4_EXT_MAGIC
)) {

445 
îr‹_msg
 = "invalid magic";

446 
c‹ru±ed
;

448 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_dïth
Ë!
dïth
)) {

449 
îr‹_msg
 = "unexpectedÉh_depth";

450 
c‹ru±ed
;

452 i‡(
	`u∆ikñy
(
eh
->
eh_max
 == 0)) {

453 
îr‹_msg
 = "invalidÉh_max";

454 
c‹ru±ed
;

456 
max
 = 
	`pxt4_ext_max_íåõs
(
öode
, 
dïth
);

457 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_max
Ë> 
max
)) {

458 
îr‹_msg
 = "tooÜargeÉh_max";

459 
c‹ru±ed
;

461 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë>Üe16_to_˝u”h->
eh_max
))) {

462 
îr‹_msg
 = "invalidÉh_entries";

463 
c‹ru±ed
;

465 i‡(!
	`pxt4_vÆid_exã¡_íåõs
(
öode
, 
eh
, 
dïth
)) {

466 
îr‹_msg
 = "invalidÉxtentÉntries";

467 
c‹ru±ed
;

469 i‡(
	`u∆ikñy
(
dïth
 > 32)) {

470 
îr‹_msg
 = "tooÜargeÉh_depth";

471 
c‹ru±ed
;

474 i‡(
	`ext_dïth
(
öode
Ë!
dïth
 &&

475 !
	`pxt4_exã¡_block_csum_vîify
(
öode
, 
eh
)) {

476 
îr‹_msg
 = "extentÅree corrupted";

477 
îr
 = -
EFSBADCRC
;

478 
c‹ru±ed
;

482 
c‹ru±ed
:

483 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

486 (Ë
pblk
, 
îr‹_msg
,

487 
	`À16_to_˝u
(
eh
->
eh_magic
),

488 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
),

489 
max
, 
	`À16_to_˝u
(
eh
->
eh_dïth
), 
dïth
);

490  
îr
;

491 
	}
}

493 
	#pxt4_ext_check
(
öode
, 
eh
, 
dïth
, 
pblk
) \

494 
	`__pxt4_ext_check
(
__func__
, 
__LINE__
, (
öode
), (
eh
), (
dïth
), (
pblk
))

	)

496 
	$pxt4_ext_check_öode
(
öode
 *inode)

498  
	`pxt4_ext_check
(
öode
, 
	`ext_öode_hdr
(öode), 
	`ext_dïth
(inode), 0);

499 
	}
}

501 
	$pxt4_ˇche_exã¡s
(
öode
 *inode,

502 
pxt4_exã¡_hódî
 *
eh
)

504 
pxt4_exã¡
 *
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

505 
pxt4_lblk_t
 
¥ev
 = 0;

506 
i
;

508 
i
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i > 0; i--, 
ex
++) {

509 
°©us
 = 
EXTENT_STATUS_WRITTEN
;

510 
pxt4_lblk_t
 
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

511 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

513 i‡(
¥ev
 && (¥ev !
lblk
))

514 
	`pxt4_es_ˇche_exã¡
(
öode
, 
¥ev
, 
lblk
 -Örev, ~0,

515 
EXTENT_STATUS_HOLE
);

517 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

518 
°©us
 = 
EXTENT_STATUS_UNWRITTEN
;

519 
	`pxt4_es_ˇche_exã¡
(
öode
, 
lblk
, 
Àn
,

520 
	`pxt4_ext_pblock
(
ex
), 
°©us
);

521 
¥ev
 = 
lblk
 + 
Àn
;

523 
	}
}

525 
buf„r_hód
 *

526 
	$__ªad_exã¡_åì_block
(c⁄° *
fun˘i⁄
, 
löe
,

527 
öode
 *öode, 
pxt4_fsblk_t
 
pblk
, 
dïth
,

528 
Êags
)

530 
buf„r_hód
 *
bh
;

531 
îr
;

533 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
pblk
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

534 i‡(
	`u∆ikñy
(!
bh
))

535  
	`ERR_PTR
(-
ENOMEM
);

537 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

538 
	`åa˚_pxt4_ext_lﬂd_exã¡
(
öode
, 
pblk
, 
_RET_IP_
);

539 
îr
 = 
	`bh_submô_ªad
(
bh
);

540 i‡(
îr
 < 0)

541 
îrout
;

543 i‡(
	`buf„r_vîifõd
(
bh
Ë&& !(
Êags
 & 
PXT4_EX_FORCE_CACHE
))

544  
bh
;

545 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) ||

546 (
öode
->
i_öo
 !=

547 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
))) {

548 
îr
 = 
	`__pxt4_ext_check
(
fun˘i⁄
, 
löe
, 
öode
,

549 
	`ext_block_hdr
(
bh
), 
dïth
, 
pblk
);

550 i‡(
îr
)

551 
îrout
;

553 
	`£t_buf„r_vîifõd
(
bh
);

557 i‡(!(
Êags
 & 
PXT4_EX_NOCACHE
Ë&& 
dïth
 == 0) {

558 
pxt4_exã¡_hódî
 *
eh
 = 
	`ext_block_hdr
(
bh
);

559 
	`pxt4_ˇche_exã¡s
(
öode
, 
eh
);

561  
bh
;

562 
îrout
:

563 
	`put_bh
(
bh
);

564  
	`ERR_PTR
(
îr
);

566 
	}
}

568 
	#ªad_exã¡_åì_block
(
öode
, 
pblk
, 
dïth
, 
Êags
) \

569 
	`__ªad_exã¡_åì_block
(
__func__
, 
__LINE__
, (
öode
), (
pblk
), \

570 (
dïth
), (
Êags
))

	)

576 
	$pxt4_ext_¥eˇche
(
öode
 *inode)

578 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

579 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

580 
buf„r_hód
 *
bh
;

581 
i
 = 0, 
dïth
, 
ªt
 = 0;

583 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

586 
	`down_ªad
(&
ei
->
i_d©a_£m
);

587 
dïth
 = 
	`ext_dïth
(
öode
);

589 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

590 
GFP_NOFS
);

591 i‡(
∑th
 =
NULL
) {

592 
	`up_ªad
(&
ei
->
i_d©a_£m
);

593  -
ENOMEM
;

597 i‡(
dïth
 == 0)

598 
out
;

599 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

600 
ªt
 = 
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0);

601 i‡(
ªt
)

602 
out
;

603 
∑th
[0].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[0].
p_hdr
);

604 
i
 >= 0) {

609 i‡((
i
 =
dïth
) ||

610 
∑th
[
i
].
p_idx
 > 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
)) {

611 
	`bªl£
(
∑th
[
i
].
p_bh
);

612 
∑th
[
i
].
p_bh
 = 
NULL
;

613 
i
--;

616 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

617 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
++),

618 
dïth
 - 
i
 - 1,

619 
PXT4_EX_FORCE_CACHE
);

620 i‡(
	`IS_ERR
(
bh
)) {

621 
ªt
 = 
	`PTR_ERR
(
bh
);

624 
i
++;

625 
∑th
[
i
].
p_bh
 = 
bh
;

626 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
(
bh
);

627 
∑th
[
i
].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[i].
p_hdr
);

629 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

630 
out
:

631 
	`up_ªad
(&
ei
->
i_d©a_£m
);

632 
	`pxt4_ext_dr›_ªfs
(
∑th
);

633 
	`k‰ì
(
∑th
);

634  
ªt
;

635 
	}
}

637 #ifde‡
EXT_DEBUG


638 
	$pxt4_ext_show_∑th
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

640 
k
, 
l
 = 
∑th
->
p_dïth
;

642 
	`ext_debug
("path:");

643 
k
 = 0; k <
l
; k++, 
∑th
++) {

644 i‡(
∑th
->
p_idx
) {

645 
	`ext_debug
(" %d->%Œu", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

646 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

647 } i‡(
∑th
->
p_ext
) {

648 
	`ext_debug
(" %d:[%d]%d:%llu ",

649 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

650 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

651 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
),

652 
	`pxt4_ext_pblock
(
∑th
->
p_ext
));

654 
	`ext_debug
(" []");

656 
	`ext_debug
("\n");

657 
	}
}

659 
	$pxt4_ext_show_Àaf
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

661 
dïth
 = 
	`ext_dïth
(
öode
);

662 
pxt4_exã¡_hódî
 *
eh
;

663 
pxt4_exã¡
 *
ex
;

664 
i
;

666 i‡(!
∑th
)

669 
eh
 = 
∑th
[
dïth
].
p_hdr
;

670 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

672 
	`ext_debug
("Di•œyögÜó‡exã¡†f‹ inodê%lu\n", 
öode
->
i_öo
);

674 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ex
++) {

675 
	`ext_debug
("%d:[%d]%d:%Œu ", 
	`À32_to_˝u
(
ex
->
ì_block
),

676 
	`pxt4_ext_is_unwrôãn
(
ex
),

677 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
), 
	`pxt4_ext_pblock
(ex));

679 
	`ext_debug
("\n");

680 
	}
}

682 
	$pxt4_ext_show_move
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
,

683 
pxt4_fsblk_t
 
√wblock
, 
Àvñ
)

685 
dïth
 = 
	`ext_dïth
(
öode
);

686 
pxt4_exã¡
 *
ex
;

688 i‡(
dïth
 !
Àvñ
) {

689 
pxt4_exã¡_idx
 *
idx
;

690 
idx
 = 
∑th
[
Àvñ
].
p_idx
;

691 
idx
 <
	`EXT_MAX_INDEX
(
∑th
[
Àvñ
].
p_hdr
)) {

692 
	`ext_debug
("%d: movê%d:%Œu i¿√w index %Œu\n", 
Àvñ
,

693 
	`À32_to_˝u
(
idx
->
ei_block
),

694 
	`pxt4_idx_pblock
(
idx
),

695 
√wblock
);

696 
idx
++;

702 
ex
 = 
∑th
[
dïth
].
p_ext
;

703 
ex
 <
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

704 
	`ext_debug
("move %d:%llu:[%d]%d inÇewÜeaf %llu\n",

705 
	`À32_to_˝u
(
ex
->
ì_block
),

706 
	`pxt4_ext_pblock
(
ex
),

707 
	`pxt4_ext_is_unwrôãn
(
ex
),

708 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

709 
√wblock
);

710 
ex
++;

712 
	}
}

715 
	#pxt4_ext_show_∑th
(
öode
, 
∑th
)

	)

716 
	#pxt4_ext_show_Àaf
(
öode
, 
∑th
)

	)

717 
	#pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
Àvñ
)

	)

720 
	$pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *
∑th
)

722 
dïth
, 
i
;

724 i‡(!
∑th
)

726 
dïth
 = 
∑th
->
p_dïth
;

727 
i
 = 0; i <
dïth
; i++, 
∑th
++)

728 i‡(
∑th
->
p_bh
) {

729 
	`bªl£
(
∑th
->
p_bh
);

730 
∑th
->
p_bh
 = 
NULL
;

732 
	}
}

740 
	$pxt4_ext_bö£¨ch_idx
(
öode
 *inode,

741 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

743 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

744 
pxt4_exã¡_idx
 *
r
, *
l
, *
m
;

747 
	`ext_debug
("bö£¨ch f‹ %u(idx): ", 
block
);

749 
l
 = 
	`EXT_FIRST_INDEX
(
eh
) + 1;

750 
r
 = 
	`EXT_LAST_INDEX
(
eh
);

751 
l
 <
r
) {

752 
m
 = 
l
 + (
r
 -Ü) / 2;

753 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ei_block
))

754 
r
 = 
m
 - 1;

756 
l
 = 
m
 + 1;

757 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ei_block
),

758 
m
, 
	`À32_to_˝u
(m->
ei_block
),

759 
r
, 
	`À32_to_˝u
‘->
ei_block
));

762 
∑th
->
p_idx
 = 
l
 - 1;

763 
	`ext_debug
(" -> %u->%Œd ", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

764 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

766 #ifde‡
CHECK_BINSEARCH


768 
pxt4_exã¡_idx
 *
chix
, *
ix
;

769 
k
;

771 
chix
 = 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

772 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ix
++) {

773 i‡(
k
 != 0 &&

774 
	`À32_to_˝u
(
ix
->
ei_block
) <=Üe32_to_cpu(ix[-1].ei_block)) {

775 
	`¥ötk
(
KERN_DEBUG
 "k=%d, ix=0x%p, "

776 "fú°=0x%p\n", 
k
,

777 
ix
, 
	`EXT_FIRST_INDEX
(
eh
));

778 
	`¥ötk
(
KERN_DEBUG
 "%u <= %u\n",

779 
	`À32_to_˝u
(
ix
->
ei_block
),

780 
	`À32_to_˝u
(
ix
[-1].
ei_block
));

782 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ix
->
ei_block
)

783 <
	`À32_to_˝u
(
ix
[-1].
ei_block
));

784 i‡(
block
 < 
	`À32_to_˝u
(
ix
->
ei_block
))

786 
chix
 = 
ix
;

788 
	`BUG_ON
(
chix
 !
∑th
->
p_idx
);

792 
	}
}

800 
	$pxt4_ext_bö£¨ch
(
öode
 *inode,

801 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

803 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

804 
pxt4_exã¡
 *
r
, *
l
, *
m
;

806 i‡(
eh
->
eh_íåõs
 == 0) {

814 
	`ext_debug
("bö£¨ch f‹ %u: ", 
block
);

816 
l
 = 
	`EXT_FIRST_EXTENT
(
eh
) + 1;

817 
r
 = 
	`EXT_LAST_EXTENT
(
eh
);

819 
l
 <
r
) {

820 
m
 = 
l
 + (
r
 -Ü) / 2;

821 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ì_block
))

822 
r
 = 
m
 - 1;

824 
l
 = 
m
 + 1;

825 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ì_block
),

826 
m
, 
	`À32_to_˝u
(m->
ì_block
),

827 
r
, 
	`À32_to_˝u
‘->
ì_block
));

830 
∑th
->
p_ext
 = 
l
 - 1;

831 
	`ext_debug
(" -> %d:%llu:[%d]%d ",

832 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

833 
	`pxt4_ext_pblock
(
∑th
->
p_ext
),

834 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

835 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
));

837 #ifde‡
CHECK_BINSEARCH


839 
pxt4_exã¡
 *
chex
, *
ex
;

840 
k
;

842 
chex
 = 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

843 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ex
++) {

844 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ex
->
ì_block
)

845 <
	`À32_to_˝u
(
ex
[-1].
ì_block
));

846 i‡(
block
 < 
	`À32_to_˝u
(
ex
->
ì_block
))

848 
chex
 = 
ex
;

850 
	`BUG_ON
(
chex
 !
∑th
->
p_ext
);

854 
	}
}

856 
	$pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

858 
pxt4_exã¡_hódî
 *
eh
;

860 
eh
 = 
	`ext_öode_hdr
(
öode
);

861 
eh
->
eh_dïth
 = 0;

862 
eh
->
eh_íåõs
 = 0;

863 
eh
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

864 
eh
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

865 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

867 
	}
}

869 
pxt4_ext_∑th
 *

870 
	$pxt4_föd_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

871 
pxt4_ext_∑th
 **
‹ig_∑th
, 
Êags
)

873 
pxt4_exã¡_hódî
 *
eh
;

874 
buf„r_hód
 *
bh
;

875 
pxt4_ext_∑th
 *
∑th
 = 
‹ig_∑th
 ? *‹ig_∑th : 
NULL
;

876 
dïth
, 
i
, 
µos
 = 0;

877 
ªt
;

879 
eh
 = 
	`ext_öode_hdr
(
öode
);

880 
dïth
 = 
	`ext_dïth
(
öode
);

881 i‡(
dïth
 < 0 || dïth > 
PXT4_MAX_EXTENT_DEPTH
) {

882 
	`PXT4_ERROR_INODE
(
öode
, "inode has invalidÉxtent depth: %d",

883 
dïth
);

884 
ªt
 = -
EFSCORRUPTED
;

885 
îr
;

888 i‡(
∑th
) {

889 
	`pxt4_ext_dr›_ªfs
(
∑th
);

890 i‡(
dïth
 > 
∑th
[0].
p_maxdïth
) {

891 
	`k‰ì
(
∑th
);

892 *
‹ig_∑th
 = 
∑th
 = 
NULL
;

895 i‡(!
∑th
) {

897 
∑th
 = 
	`kˇŒoc
(
dïth
 + 2, (
pxt4_ext_∑th
),

898 
GFP_NOFS
);

899 i‡(
	`u∆ikñy
(!
∑th
))

900  
	`ERR_PTR
(-
ENOMEM
);

901 
∑th
[0].
p_maxdïth
 = 
dïth
 + 1;

903 
∑th
[0].
p_hdr
 = 
eh
;

904 
∑th
[0].
p_bh
 = 
NULL
;

906 
i
 = 
dïth
;

907 i‡(!(
Êags
 & 
PXT4_EX_NOCACHE
Ë&& 
dïth
 == 0)

908 
	`pxt4_ˇche_exã¡s
(
öode
, 
eh
);

910 
i
) {

911 
	`ext_debug
("depth %d:Çum %d, max %d\n",

912 
µos
, 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

914 
	`pxt4_ext_bö£¨ch_idx
(
öode
, 
∑th
 + 
µos
, 
block
);

915 
∑th
[
µos
].
p_block
 = 
	`pxt4_idx_pblock
’©h[µos].
p_idx
);

916 
∑th
[
µos
].
p_dïth
 = 
i
;

917 
∑th
[
µos
].
p_ext
 = 
NULL
;

919 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
∑th
[
µos
].
p_block
, --
i
,

920 
Êags
);

921 i‡(
	`IS_ERR
(
bh
)) {

922 
ªt
 = 
	`PTR_ERR
(
bh
);

923 
îr
;

926 
eh
 = 
	`ext_block_hdr
(
bh
);

927 
µos
++;

928 
∑th
[
µos
].
p_bh
 = 
bh
;

929 
∑th
[
µos
].
p_hdr
 = 
eh
;

932 
∑th
[
µos
].
p_dïth
 = 
i
;

933 
∑th
[
µos
].
p_ext
 = 
NULL
;

934 
∑th
[
µos
].
p_idx
 = 
NULL
;

937 
	`pxt4_ext_bö£¨ch
(
öode
, 
∑th
 + 
µos
, 
block
);

939 i‡(
∑th
[
µos
].
p_ext
)

940 
∑th
[
µos
].
p_block
 = 
	`pxt4_ext_pblock
’©h[µos].
p_ext
);

942 
	`pxt4_ext_show_∑th
(
öode
, 
∑th
);

944  
∑th
;

946 
îr
:

947 
	`pxt4_ext_dr›_ªfs
(
∑th
);

948 
	`k‰ì
(
∑th
);

949 i‡(
‹ig_∑th
)

950 *
‹ig_∑th
 = 
NULL
;

951  
	`ERR_PTR
(
ªt
);

952 
	}
}

959 
	$pxt4_ext_ö£π_ödex
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

960 
pxt4_ext_∑th
 *
cuΩ
,

961 
logiˇl
, 
pxt4_fsblk_t
 
±r
)

963 
pxt4_exã¡_idx
 *
ix
;

964 
Àn
, 
îr
;

966 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
cuΩ
);

967 i‡(
îr
)

968  
îr
;

970 i‡(
	`u∆ikñy
(
logiˇl
 =
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
))) {

971 
	`PXT4_ERROR_INODE
(
öode
,

973 
logiˇl
, 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
));

974  -
EFSCORRUPTED
;

977 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
)

978 >
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
))) {

979 
	`PXT4_ERROR_INODE
(
öode
,

981 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
),

982 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
));

983  -
EFSCORRUPTED
;

986 i‡(
logiˇl
 > 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
)) {

988 
	`ext_debug
("ö£πÇew index %dá·î: %Œu\n", 
logiˇl
, 
±r
);

989 
ix
 = 
cuΩ
->
p_idx
 + 1;

992 
	`ext_debug
("ö£πÇew index %d bef‹e: %Œu\n", 
logiˇl
, 
±r
);

993 
ix
 = 
cuΩ
->
p_idx
;

996 
Àn
 = 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
Ë- 
ix
 + 1;

997 
	`BUG_ON
(
Àn
 < 0);

998 i‡(
Àn
 > 0) {

999 
	`ext_debug
("insertÇew index %d: "

1001 
logiˇl
, 
Àn
, 
ix
, ix + 1);

1002 
	`memmove
(
ix
 + 1, ix, 
Àn
 * (
pxt4_exã¡_idx
));

1005 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_MAX_INDEX
(
cuΩ
->
p_hdr
))) {

1006 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_MAX_INDEX!");

1007  -
EFSCORRUPTED
;

1010 
ix
->
ei_block
 = 
	`˝u_to_À32
(
logiˇl
);

1011 
	`pxt4_idx_°‹e_pblock
(
ix
, 
±r
);

1012 
	`À16_add_˝u
(&
cuΩ
->
p_hdr
->
eh_íåõs
, 1);

1014 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
))) {

1015 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_LAST_INDEX!");

1016  -
EFSCORRUPTED
;

1019 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
cuΩ
);

1020 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

1022  
îr
;

1023 
	}
}

1035 
	$pxt4_ext_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1036 
Êags
,

1037 
pxt4_ext_∑th
 *
∑th
,

1038 
pxt4_exã¡
 *
√wext
, 
©
)

1040 
buf„r_hód
 *
bh
 = 
NULL
;

1041 
dïth
 = 
	`ext_dïth
(
öode
);

1042 
pxt4_exã¡_hódî
 *
√h
;

1043 
pxt4_exã¡_idx
 *
fidx
;

1044 
i
 = 
©
, 
k
, 
m
, 
a
;

1045 
pxt4_fsblk_t
 
√wblock
, 
ﬁdblock
;

1046 
__À32
 
b‹dî
;

1047 
pxt4_fsblk_t
 *
ablocks
 = 
NULL
;

1048 
îr
 = 0;

1049 
size_t
 
ext_size
 = 0;

1056 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 > 
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
))) {

1057 
	`PXT4_ERROR_INODE
(
öode
, "p_ext > EXT_MAX_EXTENT!");

1058  -
EFSCORRUPTED
;

1060 i‡(
∑th
[
dïth
].
p_ext
 !
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
)) {

1061 
b‹dî
 = 
∑th
[
dïth
].
p_ext
[1].
ì_block
;

1062 
	`ext_debug
("leaf will be split."

1064 
	`À32_to_˝u
(
b‹dî
));

1066 
b‹dî
 = 
√wext
->
ì_block
;

1067 
	`ext_debug
("leaf will beádded."

1069 
	`À32_to_˝u
(
b‹dî
));

1084 
ablocks
 = 
	`kˇŒoc
(
dïth
, (
pxt4_fsblk_t
), 
GFP_NOFS
);

1085 i‡(!
ablocks
)

1086  -
ENOMEM
;

1089 
	`ext_debug
("Æloˇã %d block†f‹ indexes/Àaf\n", 
dïth
 - 
©
);

1090 
a
 = 0;á < 
dïth
 - 
©
;á++) {

1091 
√wblock
 = 
	`pxt4_ext_√w_mëa_block
(
h™dÀ
, 
öode
, 
∑th
,

1092 
√wext
, &
îr
, 
Êags
);

1093 i‡(
√wblock
 == 0)

1094 
˛ónup
;

1095 
ablocks
[
a
] = 
√wblock
;

1099 
√wblock
 = 
ablocks
[--
a
];

1100 i‡(
	`u∆ikñy
(
√wblock
 == 0)) {

1101 
	`PXT4_ERROR_INODE
(
öode
, "newblock == 0!");

1102 
îr
 = -
EFSCORRUPTED
;

1103 
˛ónup
;

1105 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1106 i‡(
	`u∆ikñy
(!
bh
)) {

1107 
îr
 = -
ENOMEM
;

1108 
˛ónup
;

1110 
	`lock_buf„r
(
bh
);

1112 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1113 i‡(
îr
)

1114 
˛ónup
;

1116 
√h
 = 
	`ext_block_hdr
(
bh
);

1117 
√h
->
eh_íåõs
 = 0;

1118 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1119 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1120 
√h
->
eh_dïth
 = 0;

1123 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 !=

1124 
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

1125 
	`PXT4_ERROR_INODE
(
öode
, "eh_entries %d !=Éh_max %d!",

1126 
∑th
[
dïth
].
p_hdr
->
eh_íåõs
,

1127 
∑th
[
dïth
].
p_hdr
->
eh_max
);

1128 
îr
 = -
EFSCORRUPTED
;

1129 
˛ónup
;

1132 
m
 = 
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë-Ö©h[dïth].
p_ext
++;

1133 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
dïth
);

1134 i‡(
m
) {

1135 
pxt4_exã¡
 *
ex
;

1136 
ex
 = 
	`EXT_FIRST_EXTENT
(
√h
);

1137 
	`memmove
(
ex
, 
∑th
[
dïth
].
p_ext
, (
pxt4_exã¡
Ë* 
m
);

1138 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1142 
ext_size
 = (
pxt4_exã¡_hódî
) +

1143 (
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
);

1144 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1145 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1146 
	`£t_buf„r_u±od©e
(
bh
);

1147 
	`u∆ock_buf„r
(
bh
);

1149 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1150 i‡(
îr
)

1151 
˛ónup
;

1152 
	`bªl£
(
bh
);

1153 
bh
 = 
NULL
;

1156 i‡(
m
) {

1157 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1158 i‡(
îr
)

1159 
˛ónup
;

1160 
	`À16_add_˝u
(&
∑th
[
dïth
].
p_hdr
->
eh_íåõs
, -
m
);

1161 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1162 i‡(
îr
)

1163 
˛ónup
;

1168 
k
 = 
dïth
 - 
©
 - 1;

1169 i‡(
	`u∆ikñy
(
k
 < 0)) {

1170 
	`PXT4_ERROR_INODE
(
öode
, "k %d < 0!", 
k
);

1171 
îr
 = -
EFSCORRUPTED
;

1172 
˛ónup
;

1174 i‡(
k
)

1175 
	`ext_debug
("¸óã %d i¡îmedüã indi˚s\n", 
k
);

1178 
i
 = 
dïth
 - 1;

1179 
k
--) {

1180 
ﬁdblock
 = 
√wblock
;

1181 
√wblock
 = 
ablocks
[--
a
];

1182 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
√wblock
);

1183 i‡(
	`u∆ikñy
(!
bh
)) {

1184 
îr
 = -
ENOMEM
;

1185 
˛ónup
;

1187 
	`lock_buf„r
(
bh
);

1189 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1190 i‡(
îr
)

1191 
˛ónup
;

1193 
√h
 = 
	`ext_block_hdr
(
bh
);

1194 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1195 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1196 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1197 
√h
->
eh_dïth
 = 
	`˝u_to_À16
(
dïth
 - 
i
);

1198 
fidx
 = 
	`EXT_FIRST_INDEX
(
√h
);

1199 
fidx
->
ei_block
 = 
b‹dî
;

1200 
	`pxt4_idx_°‹e_pblock
(
fidx
, 
ﬁdblock
);

1202 
	`ext_debug
("int.indexát %d (block %llu): %u -> %llu\n",

1203 
i
, 
√wblock
, 
	`À32_to_˝u
(
b‹dî
), 
ﬁdblock
);

1206 i‡(
	`u∆ikñy
(
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
) !=

1207 
	`EXT_LAST_INDEX
(
∑th
[
i
].
p_hdr
))) {

1208 
	`PXT4_ERROR_INODE
(
öode
,

1210 
	`À32_to_˝u
(
∑th
[
i
].
p_ext
->
ì_block
));

1211 
îr
 = -
EFSCORRUPTED
;

1212 
˛ónup
;

1215 
m
 = 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
Ë-Ö©h[i].
p_idx
++;

1216 
	`ext_debug
("cu∏0x%p,Üa° 0x%p\n", 
∑th
[
i
].
p_idx
,

1217 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
));

1218 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
i
);

1219 i‡(
m
) {

1220 
	`memmove
(++
fidx
, 
∑th
[
i
].
p_idx
,

1221 (
pxt4_exã¡_idx
Ë* 
m
);

1222 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1225 
ext_size
 = (
pxt4_exã¡_hódî
) +

1226 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
));

1227 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0,

1228 
öode
->
i_sb
->
s_blocksize
 - 
ext_size
);

1229 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1230 
	`£t_buf„r_u±od©e
(
bh
);

1231 
	`u∆ock_buf„r
(
bh
);

1233 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1234 i‡(
îr
)

1235 
˛ónup
;

1236 
	`bªl£
(
bh
);

1237 
bh
 = 
NULL
;

1240 i‡(
m
) {

1241 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1242 i‡(
îr
)

1243 
˛ónup
;

1244 
	`À16_add_˝u
(&
∑th
[
i
].
p_hdr
->
eh_íåõs
, -
m
);

1245 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1246 i‡(
îr
)

1247 
˛ónup
;

1250 
i
--;

1254 
îr
 = 
	`pxt4_ext_ö£π_ödex
(
h™dÀ
, 
öode
, 
∑th
 + 
©
,

1255 
	`À32_to_˝u
(
b‹dî
), 
√wblock
);

1257 
˛ónup
:

1258 i‡(
bh
) {

1259 i‡(
	`buf„r_locked
(
bh
))

1260 
	`u∆ock_buf„r
(
bh
);

1261 
	`bªl£
(
bh
);

1264 i‡(
îr
) {

1266 
i
 = 0; i < 
dïth
; i++) {

1267 i‡(!
ablocks
[
i
])

1269 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ablocks
[
i
], 1,

1270 
PXT4_FREE_BLOCKS_METADATA
);

1273 
	`k‰ì
(
ablocks
);

1275  
îr
;

1276 
	}
}

1286 
	$pxt4_ext_grow_ödïth
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1287 
Êags
)

1289 
pxt4_exã¡_hódî
 *
√h
;

1290 
buf„r_hód
 *
bh
;

1291 
pxt4_fsblk_t
 
√wblock
, 
gﬂl
 = 0;

1292 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

1293 
îr
 = 0;

1294 
size_t
 
ext_size
 = 0;

1297 i‡(
	`ext_dïth
(
öode
))

1298 
gﬂl
 = 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
	`ext_öode_hdr
(
öode
)));

1299 i‡(
gﬂl
 > 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
)) {

1300 
Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

1301 
gﬂl
--;

1303 
gﬂl
 = 
	`pxt4_öode_to_gﬂl_block
(
öode
);

1304 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

1305 
NULL
, &
îr
);

1306 i‡(
√wblock
 == 0)

1307  
îr
;

1309 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1310 i‡(
	`u∆ikñy
(!
bh
))

1311  -
ENOMEM
;

1312 
	`lock_buf„r
(
bh
);

1314 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1315 i‡(
îr
) {

1316 
	`u∆ock_buf„r
(
bh
);

1317 
out
;

1320 
ext_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

1322 
	`memmove
(
bh
->
b_d©a
, 
	`PXT4_I
(
öode
)->
i_d©a
, 
ext_size
);

1324 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1327 
√h
 = 
	`ext_block_hdr
(
bh
);

1330 i‡(
	`ext_dïth
(
öode
))

1331 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1333 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1334 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1335 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1336 
	`£t_buf„r_u±od©e
(
bh
);

1337 
	`u∆ock_buf„r
(
bh
);

1339 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1340 i‡(
îr
)

1341 
out
;

1344 
√h
 = 
	`ext_öode_hdr
(
öode
);

1345 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1346 
	`pxt4_idx_°‹e_pblock
(
	`EXT_FIRST_INDEX
(
√h
), 
√wblock
);

1347 i‡(
√h
->
eh_dïth
 == 0) {

1349 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 0));

1350 
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
 =

1351 
	`EXT_FIRST_EXTENT
(
√h
)->
ì_block
;

1353 
	`ext_debug
("newÑoot:Çum %d(%d),Üblock %d,Ötr %llu\n",

1354 
	`À16_to_˝u
(
√h
->
eh_íåõs
),Üe16_to_˝u“eh->
eh_max
),

1355 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
),

1356 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
√h
)));

1358 
	`À16_add_˝u
(&
√h
->
eh_dïth
, 1);

1359 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1360 
out
:

1361 
	`bªl£
(
bh
);

1363  
îr
;

1364 
	}
}

1371 
	$pxt4_ext_¸óã_√w_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1372 
mb_Êags
,

1373 
gb_Êags
,

1374 
pxt4_ext_∑th
 **
µ©h
,

1375 
pxt4_exã¡
 *
√wext
)

1377 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1378 
pxt4_ext_∑th
 *
cuΩ
;

1379 
dïth
, 
i
, 
îr
 = 0;

1381 
ª≥©
:

1382 
i
 = 
dïth
 = 
	`ext_dïth
(
öode
);

1385 
cuΩ
 = 
∑th
 + 
dïth
;

1386 
i
 > 0 && !
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1387 
i
--;

1388 
cuΩ
--;

1393 i‡(
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1396 
îr
 = 
	`pxt4_ext_•lô
(
h™dÀ
, 
öode
, 
mb_Êags
, 
∑th
, 
√wext
, 
i
);

1397 i‡(
îr
)

1398 
out
;

1401 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1402 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1403 
µ©h
, 
gb_Êags
);

1404 i‡(
	`IS_ERR
(
∑th
))

1405 
îr
 = 
	`PTR_ERR
(
∑th
);

1408 
îr
 = 
	`pxt4_ext_grow_ödïth
(
h™dÀ
, 
öode
, 
mb_Êags
);

1409 i‡(
îr
)

1410 
out
;

1413 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1414 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1415 
µ©h
, 
gb_Êags
);

1416 i‡(
	`IS_ERR
(
∑th
)) {

1417 
îr
 = 
	`PTR_ERR
(
∑th
);

1418 
out
;

1425 
dïth
 = 
	`ext_dïth
(
öode
);

1426 i‡(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 =∑th[dïth].p_hdr->
eh_max
) {

1428 
ª≥©
;

1432 
out
:

1433  
îr
;

1434 
	}
}

1443 
	$pxt4_ext_£¨ch_À·
(
öode
 *inode,

1444 
pxt4_ext_∑th
 *
∑th
,

1445 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
)

1447 
pxt4_exã¡_idx
 *
ix
;

1448 
pxt4_exã¡
 *
ex
;

1449 
dïth
, 
ì_Àn
;

1451 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1452 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1453  -
EFSCORRUPTED
;

1455 
dïth
 = 
∑th
->
p_dïth
;

1456 *
phys
 = 0;

1458 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1465 
ex
 = 
∑th
[
dïth
].
p_ext
;

1466 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1467 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1468 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1469 
	`PXT4_ERROR_INODE
(
öode
,

1471 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
));

1472  -
EFSCORRUPTED
;

1474 --
dïth
 >= 0) {

1475 
ix
 = 
∑th
[
dïth
].
p_idx
;

1476 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1477 
	`PXT4_ERROR_INODE
(
öode
,

1479 
ix
 !
NULL
 ? 
	`À32_to_˝u
(ix->
ei_block
) : 0,

1480 
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
Ë!
NULL
 ?

1481 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
)->
ei_block
) : 0,

1482 
dïth
);

1483  -
EFSCORRUPTED
;

1489 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1490 
	`PXT4_ERROR_INODE
(
öode
,

1492 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1493  -
EFSCORRUPTED
;

1496 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1;

1497 *
phys
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

1499 
	}
}

1508 
	$pxt4_ext_£¨ch_right
(
öode
 *inode,

1509 
pxt4_ext_∑th
 *
∑th
,

1510 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
,

1511 
pxt4_exã¡
 **
ªt_ex
)

1513 
buf„r_hód
 *
bh
 = 
NULL
;

1514 
pxt4_exã¡_hódî
 *
eh
;

1515 
pxt4_exã¡_idx
 *
ix
;

1516 
pxt4_exã¡
 *
ex
;

1517 
pxt4_fsblk_t
 
block
;

1518 
dïth
;

1519 
ì_Àn
;

1521 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1522 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1523  -
EFSCORRUPTED
;

1525 
dïth
 = 
∑th
->
p_dïth
;

1526 *
phys
 = 0;

1528 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1535 
ex
 = 
∑th
[
dïth
].
p_ext
;

1536 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1537 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1538 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1539 
	`PXT4_ERROR_INODE
(
öode
,

1541 
dïth
);

1542  -
EFSCORRUPTED
;

1544 --
dïth
 >= 0) {

1545 
ix
 = 
∑th
[
dïth
].
p_idx
;

1546 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1547 
	`PXT4_ERROR_INODE
(
öode
,

1549 *
logiˇl
);

1550  -
EFSCORRUPTED
;

1553 
found_exã¡
;

1556 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1557 
	`PXT4_ERROR_INODE
(
öode
,

1559 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1560  -
EFSCORRUPTED
;

1563 i‡(
ex
 !
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

1565 
ex
++;

1566 
found_exã¡
;

1570 --
dïth
 >= 0) {

1571 
ix
 = 
∑th
[
dïth
].
p_idx
;

1572 i‡(
ix
 !
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1573 
gŸ_ödex
;

1579 
gŸ_ödex
:

1583 
ix
++;

1584 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1585 ++
dïth
 < 
∑th
->
p_dïth
) {

1587 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
,

1588 
∑th
->
p_dïth
 - 
dïth
, 0);

1589 i‡(
	`IS_ERR
(
bh
))

1590  
	`PTR_ERR
(
bh
);

1591 
eh
 = 
	`ext_block_hdr
(
bh
);

1592 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

1593 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1594 
	`put_bh
(
bh
);

1597 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
, 
∑th
->
p_dïth
 - 
dïth
, 0);

1598 i‡(
	`IS_ERR
(
bh
))

1599  
	`PTR_ERR
(
bh
);

1600 
eh
 = 
	`ext_block_hdr
(
bh
);

1601 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

1602 
found_exã¡
:

1603 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

1604 *
phys
 = 
	`pxt4_ext_pblock
(
ex
);

1605 *
ªt_ex
 = 
ex
;

1606 i‡(
bh
)

1607 
	`put_bh
(
bh
);

1609 
	}
}

1618 
pxt4_lblk_t


1619 
	$pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
)

1621 
dïth
;

1623 
	`BUG_ON
(
∑th
 =
NULL
);

1624 
dïth
 = 
∑th
->
p_dïth
;

1626 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1627  
EXT_MAX_BLOCKS
;

1629 
dïth
 >= 0) {

1630 i‡(
dïth
 =
∑th
->
p_dïth
) {

1632 i‡(
∑th
[
dïth
].
p_ext
 &&

1633 
∑th
[
dïth
].
p_ext
 !=

1634 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

1635  
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
[1].
ì_block
);

1638 i‡(
∑th
[
dïth
].
p_idx
 !=

1639 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1640  
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1642 
dïth
--;

1645  
EXT_MAX_BLOCKS
;

1646 
	}
}

1652 
pxt4_lblk_t
 
	$pxt4_ext_√xt_Àaf_block
(
pxt4_ext_∑th
 *
∑th
)

1654 
dïth
;

1656 
	`BUG_ON
(
∑th
 =
NULL
);

1657 
dïth
 = 
∑th
->
p_dïth
;

1660 i‡(
dïth
 == 0)

1661  
EXT_MAX_BLOCKS
;

1664 
dïth
--;

1666 
dïth
 >= 0) {

1667 i‡(
∑th
[
dïth
].
p_idx
 !=

1668 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1669  (
pxt4_lblk_t
)

1670 
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1671 
dïth
--;

1674  
EXT_MAX_BLOCKS
;

1675 
	}
}

1683 
	$pxt4_ext_c‹ª˘_ödexes
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1684 
pxt4_ext_∑th
 *
∑th
)

1686 
pxt4_exã¡_hódî
 *
eh
;

1687 
dïth
 = 
	`ext_dïth
(
öode
);

1688 
pxt4_exã¡
 *
ex
;

1689 
__À32
 
b‹dî
;

1690 
k
, 
îr
 = 0;

1692 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1693 
ex
 = 
∑th
[
dïth
].
p_ext
;

1695 i‡(
	`u∆ikñy
(
ex
 =
NULL
 || 
eh
 == NULL)) {

1696 
	`PXT4_ERROR_INODE
(
öode
,

1697 "ex %∞=NULL o∏eh %∞=NULL", 
ex
, 
eh
);

1698  -
EFSCORRUPTED
;

1701 i‡(
dïth
 == 0) {

1706 i‡(
ex
 !
	`EXT_FIRST_EXTENT
(
eh
)) {

1714 
k
 = 
dïth
 - 1;

1715 
b‹dî
 = 
∑th
[
dïth
].
p_ext
->
ì_block
;

1716 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1717 i‡(
îr
)

1718  
îr
;

1719 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1720 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1721 i‡(
îr
)

1722  
îr
;

1724 
k
--) {

1726 i‡(
∑th
[
k
+1].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[k+1].
p_hdr
))

1728 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1729 i‡(
îr
)

1731 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1732 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1733 i‡(
îr
)

1737  
îr
;

1738 
	}
}

1741 
	$pxt4_ˇn_exã¡s_be_mîged
(
öode
 *öode, 
pxt4_exã¡
 *
ex1
,

1742 
pxt4_exã¡
 *
ex2
)

1744 
ext1_ì_Àn
, 
pxt2_ì_Àn
;

1746 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
Ë!pxt4_ext_is_unwrôãn(
ex2
))

1749 
ext1_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

1750 
pxt2_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

1752 i‡(
	`À32_to_˝u
(
ex1
->
ì_block
Ë+ 
ext1_ì_Àn
 !=

1753 
	`À32_to_˝u
(
ex2
->
ì_block
))

1761 i‡(
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_INIT_MAX_LEN
)

1769 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
) &&

1770 (
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
) ||

1771 
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) ||

1772 (
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)))

1774 #ifde‡
AGGRESSIVE_TEST


1775 i‡(
ext1_ì_Àn
 >= 4)

1779 i‡(
	`pxt4_ext_pblock
(
ex1
Ë+ 
ext1_ì_Àn
 =pxt4_ext_pblock(
ex2
))

1782 
	}
}

1791 
	$pxt4_ext_åy_to_mîge_right
(
öode
 *inode,

1792 
pxt4_ext_∑th
 *
∑th
,

1793 
pxt4_exã¡
 *
ex
)

1795 
pxt4_exã¡_hódî
 *
eh
;

1796 
dïth
, 
Àn
;

1797 
mîge_d⁄e
 = 0, 
unwrôãn
;

1799 
dïth
 = 
	`ext_dïth
(
öode
);

1800 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1801 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1803 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1804 i‡(!
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
,Éx + 1))

1807 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

1808 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

1809 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
 + 1));

1810 i‡(
unwrôãn
)

1811 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

1813 i‡(
ex
 + 1 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1814 
Àn
 = (
	`EXT_LAST_EXTENT
(
eh
Ë- 
ex
 - 1)

1815 * (
pxt4_exã¡
);

1816 
	`memmove
(
ex
 + 1,Éx + 2, 
Àn
);

1818 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

1819 
mîge_d⁄e
 = 1;

1820 
	`WARN_ON
(
eh
->
eh_íåõs
 == 0);

1821 i‡(!
eh
->
eh_íåõs
)

1822 
	`PXT4_ERROR_INODE
(
öode
, "eh->eh_entries = 0!");

1825  
mîge_d⁄e
;

1826 
	}
}

1832 
	$pxt4_ext_åy_to_mîge_up
(
h™dÀ_t
 *
h™dÀ
,

1833 
öode
 *inode,

1834 
pxt4_ext_∑th
 *
∑th
)

1836 
size_t
 
s
;

1837 
max_roŸ
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 0);

1838 
pxt4_fsblk_t
 
blk
;

1840 i‡((
∑th
[0].
p_dïth
 != 1) ||

1841 (
	`À16_to_˝u
(
∑th
[0].
p_hdr
->
eh_íåõs
) != 1) ||

1842 (
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
Ë> 
max_roŸ
))

1850 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 2))

1856 
blk
 = 
	`pxt4_idx_pblock
(
∑th
[0].
p_idx
);

1857 
s
 = 
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
) *

1858 (
pxt4_exã¡_idx
);

1859 
s
 +(
pxt4_exã¡_hódî
);

1861 
∑th
[1].
p_maxdïth
 =Öath[0].p_maxdepth;

1862 
	`mem˝y
(
∑th
[0].
p_hdr
,Ö©h[1].p_hdr, 
s
);

1863 
∑th
[0].
p_dïth
 = 0;

1864 
∑th
[0].
p_ext
 = 
	`EXT_FIRST_EXTENT
’©h[0].
p_hdr
) +

1865 (
∑th
[1].
p_ext
 - 
	`EXT_FIRST_EXTENT
’©h[1].
p_hdr
));

1866 
∑th
[0].
p_hdr
->
eh_max
 = 
	`˝u_to_À16
(
max_roŸ
);

1868 
	`bªl£
(
∑th
[1].
p_bh
);

1869 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
blk
, 1,

1870 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

1871 
	}
}

1877 
	$pxt4_ext_åy_to_mîge
(
h™dÀ_t
 *
h™dÀ
,

1878 
öode
 *inode,

1879 
pxt4_ext_∑th
 *
∑th
,

1880 
pxt4_exã¡
 *
ex
) {

1881 
pxt4_exã¡_hódî
 *
eh
;

1882 
dïth
;

1883 
mîge_d⁄e
 = 0;

1885 
dïth
 = 
	`ext_dïth
(
öode
);

1886 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1887 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1889 i‡(
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))

1890 
mîge_d⁄e
 = 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
 - 1);

1892 i‡(!
mîge_d⁄e
)

1893 (Ë
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
);

1895 
	`pxt4_ext_åy_to_mîge_up
(
h™dÀ
, 
öode
, 
∑th
);

1896 
	}
}

1906 
	$pxt4_ext_check_ovîœp
(
pxt4_sb_öfo
 *
sbi
,

1907 
öode
 *inode,

1908 
pxt4_exã¡
 *
√wext
,

1909 
pxt4_ext_∑th
 *
∑th
)

1911 
pxt4_lblk_t
 
b1
, 
b2
;

1912 
dïth
, 
Àn1
;

1913 
ªt
 = 0;

1915 
b1
 = 
	`À32_to_˝u
(
√wext
->
ì_block
);

1916 
Àn1
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
);

1917 
dïth
 = 
	`ext_dïth
(
öode
);

1918 i‡(!
∑th
[
dïth
].
p_ext
)

1919 
out
;

1920 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
->
ì_block
));

1926 i‡(
b2
 < 
b1
) {

1927 
b2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

1928 i‡(
b2
 =
EXT_MAX_BLOCKS
)

1929 
out
;

1930 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, b2);

1934 i‡(
b1
 + 
Àn1
 < b1) {

1935 
Àn1
 = 
EXT_MAX_BLOCKS
 - 
b1
;

1936 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
Àn1
);

1937 
ªt
 = 1;

1941 i‡(
b1
 + 
Àn1
 > 
b2
) {

1942 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
b2
 - 
b1
);

1943 
ªt
 = 1;

1945 
out
:

1946  
ªt
;

1947 
	}
}

1955 
	$pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1956 
pxt4_ext_∑th
 **
µ©h
,

1957 
pxt4_exã¡
 *
√wext
, 
gb_Êags
)

1959 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1960 
pxt4_exã¡_hódî
 *
eh
;

1961 
pxt4_exã¡
 *
ex
, *
„x
;

1962 
pxt4_exã¡
 *
√¨ex
;

1963 
pxt4_ext_∑th
 *
≈©h
 = 
NULL
;

1964 
dïth
, 
Àn
, 
îr
;

1965 
pxt4_lblk_t
 
√xt
;

1966 
mb_Êags
 = 0, 
unwrôãn
;

1968 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

1969 
mb_Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

1970 i‡(
	`u∆ikñy
(
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) == 0)) {

1971 
	`PXT4_ERROR_INODE
(
öode
, "pxt4_ext_get_actual_len(newext) == 0");

1972  -
EFSCORRUPTED
;

1974 
dïth
 = 
	`ext_dïth
(
öode
);

1975 
ex
 = 
∑th
[
dïth
].
p_ext
;

1976 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1977 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

1978 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

1979  -
EFSCORRUPTED
;

1983 i‡(
ex
 && !(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
)) {

1992 i‡(
ex
 < 
	`EXT_LAST_EXTENT
(
eh
) &&

1993 (
	`À32_to_˝u
(
ex
->
ì_block
) +

1994 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) <

1995 
	`À32_to_˝u
(
√wext
->
ì_block
))) {

1996 
ex
 += 1;

1997 
¥ïíd
;

1998 } i‡((
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
)) &&

1999 (
	`À32_to_˝u
(
√wext
->
ì_block
) +

2000 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) <

2001 
	`À32_to_˝u
(
ex
->
ì_block
)))

2002 
ex
 -= 1;

2005 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
, 
√wext
)) {

2006 
	`ext_debug
("append [%d]%d blockÅo %u:[%d]%d"

2008 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2009 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2010 
	`À32_to_˝u
(
ex
->
ì_block
),

2011 
	`pxt4_ext_is_unwrôãn
(
ex
),

2012 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2013 
	`pxt4_ext_pblock
(
ex
));

2014 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2015 
∑th
 + 
dïth
);

2016 i‡(
îr
)

2017  
îr
;

2018 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2019 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2020 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2021 i‡(
unwrôãn
)

2022 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2023 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2024 
√¨ex
 = 
ex
;

2025 
mîge
;

2028 
¥ïíd
:

2030 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
√wext
, 
ex
)) {

2031 
	`ext_debug
("prepend %u[%d]%d blockÅo %u:[%d]%d"

2033 
	`À32_to_˝u
(
√wext
->
ì_block
),

2034 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2035 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2036 
	`À32_to_˝u
(
ex
->
ì_block
),

2037 
	`pxt4_ext_is_unwrôãn
(
ex
),

2038 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2039 
	`pxt4_ext_pblock
(
ex
));

2040 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2041 
∑th
 + 
dïth
);

2042 i‡(
îr
)

2043  
îr
;

2045 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2046 
ex
->
ì_block
 = 
√wext
->ee_block;

2047 
	`pxt4_ext_°‹e_pblock
(
ex
, 
	`pxt4_ext_pblock
(
√wext
));

2048 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2049 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2050 i‡(
unwrôãn
)

2051 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2052 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2053 
√¨ex
 = 
ex
;

2054 
mîge
;

2058 
dïth
 = 
	`ext_dïth
(
öode
);

2059 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2060 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
))

2061 
has_•a˚
;

2064 
„x
 = 
	`EXT_LAST_EXTENT
(
eh
);

2065 
√xt
 = 
EXT_MAX_BLOCKS
;

2066 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
Ë>Üe32_to_˝u(
„x
->ee_block))

2067 
√xt
 = 
	`pxt4_ext_√xt_Àaf_block
(
∑th
);

2068 i‡(
√xt
 !
EXT_MAX_BLOCKS
) {

2069 
	`ext_debug
("√xàÀa‡block - %u\n", 
√xt
);

2070 
	`BUG_ON
(
≈©h
 !
NULL
);

2071 
≈©h
 = 
	`pxt4_föd_exã¡
(
öode
, 
√xt
, 
NULL
, 0);

2072 i‡(
	`IS_ERR
(
≈©h
))

2073  
	`PTR_ERR
(
≈©h
);

2074 
	`BUG_ON
(
≈©h
->
p_dïth
 !
∑th
->p_depth);

2075 
eh
 = 
≈©h
[
dïth
].
p_hdr
;

2076 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
)) {

2077 
	`ext_debug
("nextÜeaf isn't full(%d)\n",

2078 
	`À16_to_˝u
(
eh
->
eh_íåõs
));

2079 
∑th
 = 
≈©h
;

2080 
has_•a˚
;

2082 
	`ext_debug
("nextÜeaf hasÇo free space(%d,%d)\n",

2083 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

2090 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

2091 
mb_Êags
 |
PXT4_MB_USE_RESERVED
;

2092 
îr
 = 
	`pxt4_ext_¸óã_√w_Àaf
(
h™dÀ
, 
öode
, 
mb_Êags
, 
gb_Êags
,

2093 
µ©h
, 
√wext
);

2094 i‡(
îr
)

2095 
˛ónup
;

2096 
dïth
 = 
	`ext_dïth
(
öode
);

2097 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2099 
has_•a˚
:

2100 
√¨ex
 = 
∑th
[
dïth
].
p_ext
;

2102 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2103 i‡(
îr
)

2104 
˛ónup
;

2106 i‡(!
√¨ex
) {

2108 
	`ext_debug
("firstÉxtent inÅheÜeaf: %u:%llu:[%d]%d\n",

2109 
	`À32_to_˝u
(
√wext
->
ì_block
),

2110 
	`pxt4_ext_pblock
(
√wext
),

2111 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2112 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2113 
√¨ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

2115 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
)

2116 > 
	`À32_to_˝u
(
√¨ex
->
ì_block
)) {

2118 
	`ext_debug
("insert %u:%llu:[%d]%d before: "

2120 
	`À32_to_˝u
(
√wext
->
ì_block
),

2121 
	`pxt4_ext_pblock
(
√wext
),

2122 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2123 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2124 
√¨ex
);

2125 
√¨ex
++;

2128 
	`BUG_ON
(
√wext
->
ì_block
 =
√¨ex
->ee_block);

2129 
	`ext_debug
("insert %u:%llu:[%d]%dáfter: "

2131 
	`À32_to_˝u
(
√wext
->
ì_block
),

2132 
	`pxt4_ext_pblock
(
√wext
),

2133 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2134 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2135 
√¨ex
);

2137 
Àn
 = 
	`EXT_LAST_EXTENT
(
eh
Ë- 
√¨ex
 + 1;

2138 i‡(
Àn
 > 0) {

2139 
	`ext_debug
("insert %u:%llu:[%d]%d: "

2141 
	`À32_to_˝u
(
√wext
->
ì_block
),

2142 
	`pxt4_ext_pblock
(
√wext
),

2143 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2144 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2145 
Àn
, 
√¨ex
,Çearex + 1);

2146 
	`memmove
(
√¨ex
 + 1,Çearex,

2147 
Àn
 * (
pxt4_exã¡
));

2151 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, 1);

2152 
∑th
[
dïth
].
p_ext
 = 
√¨ex
;

2153 
√¨ex
->
ì_block
 = 
√wext
->ee_block;

2154 
	`pxt4_ext_°‹e_pblock
(
√¨ex
, 
	`pxt4_ext_pblock
(
√wext
));

2155 
√¨ex
->
ì_Àn
 = 
√wext
->ee_len;

2157 
mîge
:

2159 i‡(!(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

2160 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
√¨ex
);

2164 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2165 i‡(
îr
)

2166 
˛ónup
;

2168 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

2170 
˛ónup
:

2171 
	`pxt4_ext_dr›_ªfs
(
≈©h
);

2172 
	`k‰ì
(
≈©h
);

2173  
îr
;

2174 
	}
}

2176 
	$pxt4_fûl_fõm≠_exã¡s
(
öode
 *inode,

2177 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2178 
fõm≠_exã¡_öfo
 *
fõöfo
)

2180 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2181 
pxt4_exã¡
 *
ex
;

2182 
exã¡_°©us
 
es
;

2183 
pxt4_lblk_t
 
√xt
, 
√xt_dñ
, 
°¨t
 = 0, 
íd
 = 0;

2184 
pxt4_lblk_t
 
œ°
 = 
block
 + 
num
;

2185 
exi°s
, 
dïth
 = 0, 
îr
 = 0;

2186 
Êags
 = 0;

2187 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2189 
block
 < 
œ°
 && block !
EXT_MAX_BLOCKS
) {

2190 
num
 = 
œ°
 - 
block
;

2192 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2194 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
block
, &path, 0);

2195 i‡(
	`IS_ERR
(
∑th
)) {

2196 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2197 
îr
 = 
	`PTR_ERR
(
∑th
);

2198 
∑th
 = 
NULL
;

2202 
dïth
 = 
	`ext_dïth
(
öode
);

2203 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2204 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2205 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2206 
îr
 = -
EFSCORRUPTED
;

2209 
ex
 = 
∑th
[
dïth
].
p_ext
;

2210 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2212 
Êags
 = 0;

2213 
exi°s
 = 0;

2214 i‡(!
ex
) {

2217 
°¨t
 = 
block
;

2218 
íd
 = 
block
 + 
num
;

2219 } i‡(
	`À32_to_˝u
(
ex
->
ì_block
Ë> 
block
) {

2221 
°¨t
 = 
block
;

2222 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2223 i‡(
block
 + 
num
 < 
íd
)

2224 
íd
 = 
block
 + 
num
;

2225 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2226 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2228 
°¨t
 = 
block
;

2229 
íd
 = 
block
 + 
num
;

2230 i‡(
íd
 >
√xt
)

2231 
íd
 = 
√xt
;

2232 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)) {

2237 
°¨t
 = 
block
;

2238 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
)

2239 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2240 i‡(
block
 + 
num
 < 
íd
)

2241 
íd
 = 
block
 + 
num
;

2242 
exi°s
 = 1;

2244 
	`BUG
();

2246 
	`BUG_ON
(
íd
 <
°¨t
);

2248 i‡(!
exi°s
) {

2249 
es
.
es_lblk
 = 
°¨t
;

2250 
es
.
es_Àn
 = 
íd
 - 
°¨t
;

2251 
es
.
es_pblk
 = 0;

2253 
es
.
es_lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2254 
es
.
es_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2255 
es
.
es_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2256 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2257 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2265 
√xt_dñ
 = 
	`pxt4_föd_dñayed_exã¡
(
öode
, &
es
);

2266 i‡(!
exi°s
 && 
√xt_dñ
) {

2267 
exi°s
 = 1;

2268 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2269 
FIEMAP_EXTENT_UNKNOWN
);

2271 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2273 i‡(
	`u∆ikñy
(
es
.
es_Àn
 == 0)) {

2274 
	`PXT4_ERROR_INODE
(
öode
, "es.es_len == 0");

2275 
îr
 = -
EFSCORRUPTED
;

2290 i‡(
√xt
 =
√xt_dñ
 &&Çexà=
EXT_MAX_BLOCKS
) {

2291 
Êags
 |
FIEMAP_EXTENT_LAST
;

2292 i‡(
	`u∆ikñy
(
√xt_dñ
 !
EXT_MAX_BLOCKS
 ||

2293 
√xt
 !
EXT_MAX_BLOCKS
)) {

2294 
	`PXT4_ERROR_INODE
(
öode
,

2297 
√xt
, 
√xt_dñ
);

2298 
îr
 = -
EFSCORRUPTED
;

2303 i‡(
exi°s
) {

2304 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2305 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2306 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2307 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2308 
Êags
);

2309 i‡(
îr
 < 0)

2311 i‡(
îr
 == 1) {

2312 
îr
 = 0;

2317 
block
 = 
es
.
es_lblk
 +És.
es_Àn
;

2320 
	`pxt4_ext_dr›_ªfs
(
∑th
);

2321 
	`k‰ì
(
∑th
);

2322  
îr
;

2323 
	}
}

2325 
	$pxt4_fûl_es_ˇche_öfo
(
öode
 *inode,

2326 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2327 
fõm≠_exã¡_öfo
 *
fõöfo
)

2329 
pxt4_lblk_t
 
√xt
, 
íd
 = 
block
 + 
num
 - 1;

2330 
exã¡_°©us
 
es
;

2331 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2332 
Êags
;

2333 
îr
;

2335 
block
 <
íd
) {

2336 
√xt
 = 0;

2337 
Êags
 = 0;

2338 i‡(!
	`pxt4_es_lookup_exã¡
(
öode
, 
block
, &
√xt
, &
es
))

2340 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

2341 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2342 i‡(
	`pxt4_es_is_dñayed
(&
es
))

2343 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2344 
FIEMAP_EXTENT_UNKNOWN
);

2345 i‡(
	`pxt4_es_is_hﬁe
(&
es
))

2346 
Êags
 |
PXT4_FIEMAP_EXTENT_HOLE
;

2347 i‡(
√xt
 == 0)

2348 
Êags
 |
FIEMAP_EXTENT_LAST
;

2349 i‡(
Êags
 & (
FIEMAP_EXTENT_DELALLOC
|

2350 
PXT4_FIEMAP_EXTENT_HOLE
))

2351 
es
.
es_pblk
 = 0;

2353 
es
.
es_pblk
 = 
	`pxt4_es_pblock
(&es);

2354 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2355 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2356 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2357 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2358 
Êags
);

2359 i‡(
√xt
 == 0)

2361 
block
 = 
√xt
;

2362 i‡(
îr
 < 0)

2363  
îr
;

2364 i‡(
îr
 == 1)

2368 
	}
}

2384 
pxt4_lblk_t
 
	$pxt4_ext_dëîmöe_hﬁe
(
öode
 *inode,

2385 
pxt4_ext_∑th
 *
∑th
,

2386 
pxt4_lblk_t
 *
lblk
)

2388 
dïth
 = 
	`ext_dïth
(
öode
);

2389 
pxt4_exã¡
 *
ex
;

2390 
pxt4_lblk_t
 
Àn
;

2392 
ex
 = 
∑th
[
dïth
].
p_ext
;

2393 i‡(
ex
 =
NULL
) {

2395 *
lblk
 = 0;

2396 
Àn
 = 
EXT_MAX_BLOCKS
;

2397 } i‡(*
lblk
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

2398 
Àn
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë- *
lblk
;

2399 } i‡(*
lblk
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2400 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2401 
pxt4_lblk_t
 
√xt
;

2403 *
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
	`pxt4_ext_gë_a˘uÆ_Àn
(ex);

2404 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2405 
	`BUG_ON
(
√xt
 =*
lblk
);

2406 
Àn
 = 
√xt
 - *
lblk
;

2408 
	`BUG
();

2410  
Àn
;

2411 
	}
}

2419 
	$pxt4_ext_put_g≠_ö_ˇche
(
öode
 *öode, 
pxt4_lblk_t
 
hﬁe_°¨t
,

2420 
pxt4_lblk_t
 
hﬁe_Àn
)

2422 
exã¡_°©us
 
es
;

2424 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
hﬁe_°¨t
,

2425 
hﬁe_°¨t
 + 
hﬁe_Àn
 - 1, &
es
);

2426 i‡(
es
.
es_Àn
) {

2428 i‡(
es
.
es_lblk
 <
hﬁe_°¨t
)

2430 
hﬁe_Àn
 = 
	`mö
(
es
.
es_lblk
 - 
hﬁe_°¨t
, hole_len);

2432 
	`ext_debug
(" -> %u:%u\n", 
hﬁe_°¨t
, 
hﬁe_Àn
);

2433 
	`pxt4_es_ö£π_exã¡
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
, ~0,

2434 
EXTENT_STATUS_HOLE
);

2435 
	}
}

2441 
	$pxt4_ext_rm_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2442 
pxt4_ext_∑th
 *
∑th
, 
dïth
)

2444 
îr
;

2445 
pxt4_fsblk_t
 
Àaf
;

2448 
dïth
--;

2449 
∑th
 =Ö©h + 
dïth
;

2450 
Àaf
 = 
	`pxt4_idx_pblock
(
∑th
->
p_idx
);

2451 i‡(
	`u∆ikñy
(
∑th
->
p_hdr
->
eh_íåõs
 == 0)) {

2452 
	`PXT4_ERROR_INODE
(
öode
, "path->p_hdr->eh_entries == 0");

2453  -
EFSCORRUPTED
;

2455 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2456 i‡(
îr
)

2457  
îr
;

2459 i‡(
∑th
->
p_idx
 !
	`EXT_LAST_INDEX
’©h->
p_hdr
)) {

2460 
Àn
 = 
	`EXT_LAST_INDEX
(
∑th
->
p_hdr
Ë-Ö©h->
p_idx
;

2461 
Àn
 *(
pxt4_exã¡_idx
);

2462 
	`memmove
(
∑th
->
p_idx
,Ö©h->p_idx + 1, 
Àn
);

2465 
	`À16_add_˝u
(&
∑th
->
p_hdr
->
eh_íåõs
, -1);

2466 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2467 i‡(
îr
)

2468  
îr
;

2469 
	`ext_debug
("ödex i†em±y,Ñemovêô, fªêblock %Œu\n", 
Àaf
);

2470 
	`åa˚_pxt4_ext_rm_idx
(
öode
, 
Àaf
);

2472 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
Àaf
, 1,

2473 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

2475 --
dïth
 >= 0) {

2476 i‡(
∑th
->
p_idx
 !
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2478 
∑th
--;

2479 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2480 i‡(
îr
)

2482 
∑th
->
p_idx
->
ei_block
 = (path+1)->p_idx->ei_block;

2483 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2484 i‡(
îr
)

2487  
îr
;

2488 
	}
}

2497 
	$pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *öode, 
ƒblocks
,

2498 
pxt4_ext_∑th
 *
∑th
)

2500 i‡(
∑th
) {

2501 
dïth
 = 
	`ext_dïth
(
öode
);

2502 
ªt
 = 0;

2505 i‡(
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
)

2506 < 
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

2517 
ªt
 = 2 + 
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

2518  
ªt
;

2522  
	`pxt4_chunk_å™s_blocks
(
öode
, 
ƒblocks
);

2523 
	}
}

2534 
	$pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
)

2536 
ödex
;

2537 
dïth
;

2540 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2543 
dïth
 = 
	`ext_dïth
(
öode
);

2545 i‡(
exã¡s
 <= 1)

2546 
ödex
 = 
dïth
 * 2;

2548 
ödex
 = 
dïth
 * 3;

2550  
ödex
;

2551 
	}
}

2553 
ölöe
 
	$gë_deÁu…_‰ì_blocks_Êags
(
öode
 *inode)

2555 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

2556 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

2557  
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
;

2558 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2559  
PXT4_FREE_BLOCKS_FORGET
;

2561 
	}
}

2578 
	$pxt4_ªª£rve_˛u°î
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

2580 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2581 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2583 
	`dquŸ_ª˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

2585 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2586 
ei
->
i_ª£rved_d©a_blocks
++;

2587 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 1);

2588 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2590 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 1);

2591 
	`pxt4_ªmove_≥ndög
(
öode
, 
lblk
);

2592 
	}
}

2594 
	$pxt4_ªmove_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2595 
pxt4_exã¡
 *
ex
,

2596 
∑πül_˛u°î
 *
∑πül
,

2597 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
to
)

2599 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2600 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2601 
pxt4_fsblk_t
 
œ°_pblk
, 
pblk
;

2602 
pxt4_lblk_t
 
num
;

2603 
Êags
;

2606 i‡(
‰om
 < 
	`À32_to_˝u
(
ex
->
ì_block
) ||

2607 
to
 !
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1) {

2608 
	`pxt4_îr‹
(
sbi
->
s_sb
,

2610 
‰om
, 
to
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

2614 #ifde‡
EXTENTS_STATS


2615 
	`•ö_lock
(&
sbi
->
s_ext_°©s_lock
);

2616 
sbi
->
s_ext_blocks
 +
ì_Àn
;

2617 
sbi
->
s_ext_exã¡s
++;

2618 i‡(
ì_Àn
 < 
sbi
->
s_ext_mö
)

2619 
sbi
->
s_ext_mö
 = 
ì_Àn
;

2620 i‡(
ì_Àn
 > 
sbi
->
s_ext_max
)

2621 
sbi
->
s_ext_max
 = 
ì_Àn
;

2622 i‡(
	`ext_dïth
(
öode
Ë> 
sbi
->
s_dïth_max
)

2623 
sbi
->
s_dïth_max
 = 
	`ext_dïth
(
öode
);

2624 
	`•ö_u∆ock
(&
sbi
->
s_ext_°©s_lock
);

2627 
	`åa˚_pxt4_ªmove_blocks
(
öode
, 
ex
, 
‰om
, 
to
, 
∑πül
);

2633 
œ°_pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

2635 i‡(
∑πül
->
°©e
 !
öôül
 &&

2636 
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
œ°_pblk
)) {

2637 i‡(
∑πül
->
°©e
 =
to‰ì
) {

2638 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2639 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2640 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2641 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2642 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2643 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2644 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2645 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2647 
∑πül
->
°©e
 = 
öôül
;

2650 
num
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 
‰om
;

2651 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 
num
;

2659 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2662 i‡((
	`PXT4_LBLK_COFF
(
sbi
, 
to
Ë!sbi->
s_˛u°î_øtio
 - 1) &&

2663 (
	`PXT4_LBLK_CMASK
(
sbi
, 
to
Ë>
‰om
) &&

2664 (
∑πül
->
°©e
 !
no‰ì
)) {

2665 i‡(
	`pxt4_is_≥ndög
(
öode
, 
to
))

2666 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2667 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2668 
	`PXT4_PBLK_CMASK
(
sbi
, 
œ°_pblk
),

2669 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2670 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2671 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
to
);

2672 
∑πül
->
°©e
 = 
öôül
;

2673 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2676 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
;

2684 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
;

2685 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
pblk
, 
num
, 
Êags
);

2688 i‡(
∑πül
->
°©e
 !
öôül
 &&Ö¨tül->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
))

2689 
∑πül
->
°©e
 = 
öôül
;

2701 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
‰om
Ë&& 
num
 =
ì_Àn
) {

2702 i‡(
∑πül
->
°©e
 =
öôül
) {

2703 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2704 
∑πül
->
lblk
 = 
‰om
;

2705 
∑πül
->
°©e
 = 
to‰ì
;

2708 
∑πül
->
°©e
 = 
öôül
;

2712 
	}
}

2730 
	$pxt4_ext_rm_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2731 
pxt4_ext_∑th
 *
∑th
,

2732 
∑πül_˛u°î
 *
∑πül
,

2733 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

2735 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2736 
îr
 = 0, 
c‹ª˘_ödex
 = 0;

2737 
dïth
 = 
	`ext_dïth
(
öode
), 
¸edôs
;

2738 
pxt4_exã¡_hódî
 *
eh
;

2739 
pxt4_lblk_t
 
a
, 
b
;

2740 
num
;

2741 
pxt4_lblk_t
 
ex_ì_block
;

2742 
ex_ì_Àn
;

2743 
unwrôãn
 = 0;

2744 
pxt4_exã¡
 *
ex
;

2745 
pxt4_fsblk_t
 
pblk
;

2748 
	`ext_debug
("åunˇã sö˚ %u i¿Àa‡tÿ%u\n", 
°¨t
, 
íd
);

2749 i‡(!
∑th
[
dïth
].
p_hdr
)

2750 
∑th
[
dïth
].
p_hdr
 = 
	`ext_block_hdr
’©h[dïth].
p_bh
);

2751 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2752 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2753 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2754  -
EFSCORRUPTED
;

2757 
ex
 = 
∑th
[
dïth
].
p_ext
;

2758 i‡(!
ex
)

2759 
ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

2761 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2762 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2764 
	`åa˚_pxt4_ext_rm_Àaf
(
öode
, 
°¨t
, 
ex
, 
∑πül
);

2766 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
) &&

2767 
ex_ì_block
 + 
ex_ì_Àn
 > 
°¨t
) {

2769 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2770 
unwrôãn
 = 1;

2772 
unwrôãn
 = 0;

2774 
	`ext_debug
("ªmovêexà%u:[%d]%d\n", 
ex_ì_block
,

2775 
unwrôãn
, 
ex_ì_Àn
);

2776 
∑th
[
dïth
].
p_ext
 = 
ex
;

2778 
a
 = 
ex_ì_block
 > 
°¨t
 ?Éx_ee_block : start;

2779 
b
 = 
ex_ì_block
+
ex_ì_Àn
 - 1 < 
íd
 ?

2780 
ex_ì_block
+
ex_ì_Àn
 - 1 : 
íd
;

2782 
	`ext_debug
(" b‹dî %u:%u\n", 
a
, 
b
);

2785 i‡(
íd
 < 
ex_ì_block
) {

2793 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

2794 
pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2795 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2796 
∑πül
->
°©e
 = 
no‰ì
;

2798 
ex
--;

2799 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2800 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2802 } i‡(
b
 !
ex_ì_block
 + 
ex_ì_Àn
 - 1) {

2803 
	`PXT4_ERROR_INODE
(
öode
,

2806 
°¨t
, 
íd
, 
ex_ì_block
,

2807 
ex_ì_block
 + 
ex_ì_Àn
 - 1);

2808 
îr
 = -
EFSCORRUPTED
;

2809 
out
;

2810 } i‡(
a
 !
ex_ì_block
) {

2812 
num
 = 
a
 - 
ex_ì_block
;

2815 
num
 = 0;

2823 
¸edôs
 = 7 + 2*(
ex_ì_Àn
/
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
));

2824 i‡(
ex
 =
	`EXT_FIRST_EXTENT
(
eh
)) {

2825 
c‹ª˘_ödex
 = 1;

2826 
¸edôs
 +(
	`ext_dïth
(
öode
)) + 1;

2828 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

2830 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

2831 i‡(
îr
)

2832 
out
;

2834 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2835 i‡(
îr
)

2836 
out
;

2838 
îr
 = 
	`pxt4_ªmove_blocks
(
h™dÀ
, 
öode
, 
ex
, 
∑πül
, 
a
, 
b
);

2839 i‡(
îr
)

2840 
out
;

2842 i‡(
num
 == 0)

2844 
	`pxt4_ext_°‹e_pblock
(
ex
, 0);

2846 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
num
);

2851 i‡(
unwrôãn
 && 
num
)

2852 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2857 i‡(
num
 == 0) {

2858 i‡(
íd
 !
EXT_MAX_BLOCKS
 - 1) {

2864 
	`memmove
(
ex
,Éx+1, (
	`EXT_LAST_EXTENT
(
eh
) -Éx) *

2865 (
pxt4_exã¡
));

2868 
	`mem£t
(
	`EXT_LAST_EXTENT
(
eh
), 0,

2869 (
pxt4_exã¡
));

2871 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

2874 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2875 i‡(
îr
)

2876 
out
;

2878 
	`ext_debug
("√wÉxã¡: %u:%u:%Œu\n", 
ex_ì_block
, 
num
,

2879 
	`pxt4_ext_pblock
(
ex
));

2880 
ex
--;

2881 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2882 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2885 i‡(
c‹ª˘_ödex
 && 
eh
->
eh_íåõs
)

2886 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2895 i‡(
∑πül
->
°©e
 =
to‰ì
 && 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
)) {

2896 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ex_ì_Àn
 - 1;

2897 i‡(
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
)) {

2898 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2900 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2901 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2902 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2903 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2904 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2905 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2906 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2908 
∑πül
->
°©e
 = 
öôül
;

2913 i‡(
îr
 =0 && 
eh
->
eh_íåõs
 =0 && 
∑th
[
dïth
].
p_bh
 !
NULL
)

2914 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
dïth
);

2916 
out
:

2917  
îr
;

2918 
	}
}

2925 
	$pxt4_ext_m‹e_to_rm
(
pxt4_ext_∑th
 *
∑th
)

2927 
	`BUG_ON
(
∑th
->
p_idx
 =
NULL
);

2929 i‡(
∑th
->
p_idx
 < 
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2936 i‡(
	`À16_to_˝u
(
∑th
->
p_hdr
->
eh_íåõs
Ë=∑th->
p_block
)

2939 
	}
}

2941 
	$pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2942 
pxt4_lblk_t
 
íd
)

2944 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2945 
dïth
 = 
	`ext_dïth
(
öode
);

2946 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2947 
∑πül_˛u°î
 
∑πül
;

2948 
h™dÀ_t
 *
h™dÀ
;

2949 
i
 = 0, 
îr
 = 0;

2951 
∑πül
.
p˛u
 = 0;

2952 
∑πül
.
lblk
 = 0;

2953 
∑πül
.
°©e
 = 
öôül
;

2955 
	`ext_debug
("åunˇã sö˚ %uÅÿ%u\n", 
°¨t
, 
íd
);

2958 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
dïth
 + 1);

2959 i‡(
	`IS_ERR
(
h™dÀ
))

2960  
	`PTR_ERR
(
h™dÀ
);

2962 
agaö
:

2963 
	`åa˚_pxt4_ext_ªmove_•a˚
(
öode
, 
°¨t
, 
íd
, 
dïth
);

2972 i‡(
íd
 < 
EXT_MAX_BLOCKS
 - 1) {

2973 
pxt4_exã¡
 *
ex
;

2974 
pxt4_lblk_t
 
ì_block
, 
ex_íd
, 
lblk
;

2975 
pxt4_fsblk_t
 
pblk
;

2978 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
íd
, 
NULL
, 
PXT4_EX_NOCACHE
);

2979 i‡(
	`IS_ERR
(
∑th
)) {

2980 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2981  
	`PTR_ERR
(
∑th
);

2983 
dïth
 = 
	`ext_dïth
(
öode
);

2985 
ex
 = 
∑th
[
dïth
].
p_ext
;

2986 i‡(!
ex
) {

2987 i‡(
dïth
) {

2988 
	`PXT4_ERROR_INODE
(
öode
,

2990 
dïth
);

2991 
îr
 = -
EFSCORRUPTED
;

2993 
out
;

2996 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

2997 
ex_íd
 = 
ì_block
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) - 1;

3005 i‡(
íd
 >
ì_block
 &&Énd < 
ex_íd
) {

3012 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

3013 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
íd
 - 
ì_block
 + 1;

3014 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3015 
∑πül
.
°©e
 = 
no‰ì
;

3024 
îr
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

3025 
íd
 + 1, 1);

3026 i‡(
îr
 < 0)

3027 
out
;

3029 } i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
íd
 >
ex_íd
 &&

3030 
∑πül
.
°©e
 =
öôül
) {

3041 
lblk
 = 
ex_íd
 + 1;

3042 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
lblk
, &
pblk
,

3043 &
ex
);

3044 i‡(
îr
)

3045 
out
;

3046 i‡(
pblk
) {

3047 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3048 
∑πül
.
°©e
 = 
no‰ì
;

3056 
dïth
 = 
	`ext_dïth
(
öode
);

3057 i‡(
∑th
) {

3058 
k
 = 
i
 = 
dïth
;

3059 --
k
 > 0)

3060 
∑th
[
k
].
p_block
 =

3061 
	`À16_to_˝u
(
∑th
[
k
].
p_hdr
->
eh_íåõs
)+1;

3063 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

3064 
GFP_NOFS
);

3065 i‡(
∑th
 =
NULL
) {

3066 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3067  -
ENOMEM
;

3069 
∑th
[0].
p_maxdïth
 =Ö©h[0].
p_dïth
 = 
dïth
;

3070 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

3071 
i
 = 0;

3073 i‡(
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0)) {

3074 
îr
 = -
EFSCORRUPTED
;

3075 
out
;

3078 
îr
 = 0;

3080 
i
 >0 && 
îr
 == 0) {

3081 i‡(
i
 =
dïth
) {

3083 
îr
 = 
	`pxt4_ext_rm_Àaf
(
h™dÀ
, 
öode
, 
∑th
,

3084 &
∑πül
, 
°¨t
, 
íd
);

3086 
	`bªl£
(
∑th
[
i
].
p_bh
);

3087 
∑th
[
i
].
p_bh
 = 
NULL
;

3088 
i
--;

3093 i‡(!
∑th
[
i
].
p_hdr
) {

3094 
	`ext_debug
("initialize header\n");

3095 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
’©h[i].
p_bh
);

3098 i‡(!
∑th
[
i
].
p_idx
) {

3100 
∑th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
);

3101 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
)+1;

3102 
	`ext_debug
("init indexÖtr: hdr 0x%p,Çum %d\n",

3103 
∑th
[
i
].
p_hdr
,

3104 
	`À16_to_˝u
(
∑th
[
i
].
p_hdr
->
eh_íåõs
));

3107 
∑th
[
i
].
p_idx
--;

3110 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

3111 
i
, 
	`EXT_FIRST_INDEX
(
∑th
[i].
p_hdr
),

3112 
∑th
[
i
].
p_idx
);

3113 i‡(
	`pxt4_ext_m‹e_to_rm
(
∑th
 + 
i
)) {

3114 
buf„r_hód
 *
bh
;

3116 
	`ext_debug
("moveÅoÜevel %d (block %llu)\n",

3117 
i
 + 1, 
	`pxt4_idx_pblock
(
∑th
[i].
p_idx
));

3118 
	`mem£t
(
∑th
 + 
i
 + 1, 0, (*path));

3119 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

3120 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
), 
dïth
 - i - 1,

3121 
PXT4_EX_NOCACHE
);

3122 i‡(
	`IS_ERR
(
bh
)) {

3124 
îr
 = 
	`PTR_ERR
(
bh
);

3129 
	`c⁄d_ªsched
();

3130 i‡(
	`WARN_ON
(
i
 + 1 > 
dïth
)) {

3131 
îr
 = -
EFSCORRUPTED
;

3134 
∑th
[
i
 + 1].
p_bh
 = 
bh
;

3138 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
);

3139 
i
++;

3142 i‡(
∑th
[
i
].
p_hdr
->
eh_íåõs
 == 0 && i > 0) {

3146 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
i
);

3149 
	`bªl£
(
∑th
[
i
].
p_bh
);

3150 
∑th
[
i
].
p_bh
 = 
NULL
;

3151 
i
--;

3152 
	`ext_debug
("ªtu∫ÅÿÀvñ %d\n", 
i
);

3156 
	`åa˚_pxt4_ext_ªmove_•a˚_d⁄e
(
öode
, 
°¨t
, 
íd
, 
dïth
, &
∑πül
,

3157 
∑th
->
p_hdr
->
eh_íåõs
);

3163 i‡(
∑πül
.
°©e
 =
to‰ì
 && 
îr
 == 0) {

3164 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

3166 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
.
lblk
))

3167 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

3168 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

3169 
	`PXT4_C2B
(
sbi
, 
∑πül
.
p˛u
),

3170 
sbi
->
s_˛u°î_øtio
, 
Êags
);

3171 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

3172 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
.
lblk
);

3173 
∑πül
.
°©e
 = 
öôül
;

3177 i‡(
∑th
->
p_hdr
->
eh_íåõs
 == 0) {

3182 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

3183 i‡(
îr
 == 0) {

3184 
	`ext_öode_hdr
(
öode
)->
eh_dïth
 = 0;

3185 
	`ext_öode_hdr
(
öode
)->
eh_max
 =

3186 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

3187 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

3190 
out
:

3191 
	`pxt4_ext_dr›_ªfs
(
∑th
);

3192 
	`k‰ì
(
∑th
);

3193 
∑th
 = 
NULL
;

3194 i‡(
îr
 =-
EAGAIN
)

3195 
agaö
;

3196 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3198  
îr
;

3199 
	}
}

3204 
	$pxt4_ext_öô
(
su≥r_block
 *
sb
)

3210 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

3211 #i‡
	`deföed
(
AGGRESSIVE_TEST
Ë|| deföed(
CHECK_BINSEARCH
Ë|| deföed(
EXTENTS_STATS
)

3212 
	`¥ötk
(
KERN_INFO
 "PXT4-fs: fileÉxtentsÉnabled"

3213 #ifde‡
AGGRESSIVE_TEST


3216 #ifde‡
CHECK_BINSEARCH


3219 #ifde‡
EXTENTS_STATS


3224 #ifde‡
EXTENTS_STATS


3225 
	`•ö_lock_öô
(&
	`PXT4_SB
(
sb
)->
s_ext_°©s_lock
);

3226 
	`PXT4_SB
(
sb
)->
s_ext_mö
 = 1 << 30;

3227 
	`PXT4_SB
(
sb
)->
s_ext_max
 = 0;

3230 
	}
}

3235 
	$pxt4_ext_ªÀa£
(
su≥r_block
 *
sb
)

3237 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3240 #ifde‡
EXTENTS_STATS


3241 i‡(
	`PXT4_SB
(
sb
)->
s_ext_blocks
 && PXT4_SB(sb)->
s_ext_exã¡s
) {

3242 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3243 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %lu blocks in %luÉxtents (%luáve)\n",

3244 
sbi
->
s_ext_blocks
, sbi->
s_ext_exã¡s
,

3245 
sbi
->
s_ext_blocks
 / sbi->
s_ext_exã¡s
);

3246 
	`¥ötk
(
KERN_ERR
 "PXT4-fs:Éxtents: %lu min, %lu max, max depth %lu\n",

3247 
sbi
->
s_ext_mö
, sbi->
s_ext_max
, sbi->
s_dïth_max
);

3250 
	}
}

3252 
	$pxt4_zîoout_es
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3254 
pxt4_lblk_t
 
ì_block
;

3255 
pxt4_fsblk_t
 
ì_pblock
;

3256 
ì_Àn
;

3258 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3259 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3260 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3262 i‡(
ì_Àn
 == 0)

3265  
	`pxt4_es_ö£π_exã¡
(
öode
, 
ì_block
, 
ì_Àn
, 
ì_pblock
,

3266 
EXTENT_STATUS_WRITTEN
);

3267 
	}
}

3270 
	$pxt4_ext_zîoout
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3272 
pxt4_fsblk_t
 
ì_pblock
;

3273 
ì_Àn
;

3275 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3276 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3277  
	`pxt4_issue_zîoout
(
öode
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_pblock
,

3278 
ì_Àn
);

3279 
	}
}

3302 
	$pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

3303 
öode
 *inode,

3304 
pxt4_ext_∑th
 **
µ©h
,

3305 
pxt4_lblk_t
 
•lô
,

3306 
•lô_Êag
,

3307 
Êags
)

3309 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3310 
pxt4_fsblk_t
 
√wblock
;

3311 
pxt4_lblk_t
 
ì_block
;

3312 
pxt4_exã¡
 *
ex
, 
√wex
, 
‹ig_ex
, 
zîo_ex
;

3313 
pxt4_exã¡
 *
ex2
 = 
NULL
;

3314 
ì_Àn
, 
dïth
;

3315 
îr
 = 0;

3317 
	`BUG_ON
((
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
)) ==

3318 (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
));

3320 
	`ext_debug
("pxt4_split_extents_at: inode %lu,Üogical"

3321 "block %Œu\n", 
öode
->
i_öo
, ()
•lô
);

3323 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3325 
dïth
 = 
	`ext_dïth
(
öode
);

3326 
ex
 = 
∑th
[
dïth
].
p_ext
;

3327 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3328 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3329 
√wblock
 = 
•lô
 - 
ì_block
 + 
	`pxt4_ext_pblock
(
ex
);

3331 
	`BUG_ON
(
•lô
 < 
ì_block
 || s∂ô >”e_block + 
ì_Àn
));

3332 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
) &&

3333 
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3334 
PXT4_EXT_MARK_UNWRIT1
 |

3335 
PXT4_EXT_MARK_UNWRIT2
));

3337 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3338 i‡(
îr
)

3339 
out
;

3341 i‡(
•lô
 =
ì_block
) {

3347 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3348 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3350 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3352 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

3353 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3355 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3356 
out
;

3360 
	`mem˝y
(&
‹ig_ex
, 
ex
, (orig_ex));

3361 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
•lô
 - 
ì_block
);

3362 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT1
)

3363 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3369 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3370 i‡(
îr
)

3371 
fix_exã¡_Àn
;

3373 
ex2
 = &
√wex
;

3374 
ex2
->
ì_block
 = 
	`˝u_to_À32
(
•lô
);

3375 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- (
•lô
 - 
ì_block
));

3376 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
√wblock
);

3377 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3378 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

3380 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
√wex
, 
Êags
);

3381 i‡(
îr
 =-
ENOSPC
 && (
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)) {

3382 i‡(
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
|
PXT4_EXT_DATA_VALID2
)) {

3383 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID1
) {

3384 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex2
);

3385 
zîo_ex
.
ì_block
 = 
ex2
->ee_block;

3386 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3387 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
));

3388 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3389 
	`pxt4_ext_pblock
(
ex2
));

3391 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex
);

3392 
zîo_ex
.
ì_block
 = 
ex
->ee_block;

3393 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3394 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
));

3395 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3396 
	`pxt4_ext_pblock
(
ex
));

3399 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
‹ig_ex
);

3400 
zîo_ex
.
ì_block
 = 
‹ig_ex
.ee_block;

3401 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3402 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
‹ig_ex
));

3403 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3404 
	`pxt4_ext_pblock
(&
‹ig_ex
));

3407 i‡(
îr
)

3408 
fix_exã¡_Àn
;

3410 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(ee_len);

3411 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3412 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3413 i‡(
îr
)

3414 
fix_exã¡_Àn
;

3417 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex
);

3419 
out
;

3420 } i‡(
îr
)

3421 
fix_exã¡_Àn
;

3423 
out
:

3424 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3425  
îr
;

3427 
fix_exã¡_Àn
:

3428 
ex
->
ì_Àn
 = 
‹ig_ex
.ee_len;

3429 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3430  
îr
;

3431 
	}
}

3444 
	$pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

3445 
öode
 *inode,

3446 
pxt4_ext_∑th
 **
µ©h
,

3447 
pxt4_m≠_blocks
 *
m≠
,

3448 
•lô_Êag
,

3449 
Êags
)

3451 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3452 
pxt4_lblk_t
 
ì_block
;

3453 
pxt4_exã¡
 *
ex
;

3454 
ì_Àn
, 
dïth
;

3455 
îr
 = 0;

3456 
unwrôãn
;

3457 
•lô_Êag1
, 
Êags1
;

3458 
Æloˇãd
 = 
m≠
->
m_Àn
;

3460 
dïth
 = 
	`ext_dïth
(
öode
);

3461 
ex
 = 
∑th
[
dïth
].
p_ext
;

3462 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3463 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3464 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3466 i‡(
m≠
->
m_lblk
 + m≠->
m_Àn
 < 
ì_block
 + 
ì_Àn
) {

3467 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_MAY_ZEROOUT
;

3468 
Êags1
 = 
Êags
 | 
PXT4_GET_BLOCKS_PRE_IO
;

3469 i‡(
unwrôãn
)

3470 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
 |

3471 
PXT4_EXT_MARK_UNWRIT2
;

3472 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
)

3473 
•lô_Êag1
 |
PXT4_EXT_DATA_VALID1
;

3474 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3475 
m≠
->
m_lblk
 + m≠->
m_Àn
, 
•lô_Êag1
, 
Êags1
);

3476 i‡(
îr
)

3477 
out
;

3479 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3485 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3486 i‡(
	`IS_ERR
(
∑th
))

3487  
	`PTR_ERR
(
∑th
);

3488 
dïth
 = 
	`ext_dïth
(
öode
);

3489 
ex
 = 
∑th
[
dïth
].
p_ext
;

3490 i‡(!
ex
) {

3491 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3492 (Ë
m≠
->
m_lblk
);

3493  -
EFSCORRUPTED
;

3495 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3496 
•lô_Êag1
 = 0;

3498 i‡(
m≠
->
m_lblk
 >
ì_block
) {

3499 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
;

3500 i‡(
unwrôãn
) {

3501 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
;

3502 
•lô_Êag1
 |
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3503 
PXT4_EXT_MARK_UNWRIT2
);

3505 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3506 
m≠
->
m_lblk
, 
•lô_Êag1
, 
Êags
);

3507 i‡(
îr
)

3508 
out
;

3511 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3512 
out
:

3513  
îr
 ?Éº : 
Æloˇãd
;

3514 
	}
}

3536 
	$pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ_t
 *
h™dÀ
,

3537 
öode
 *inode,

3538 
pxt4_m≠_blocks
 *
m≠
,

3539 
pxt4_ext_∑th
 **
µ©h
,

3540 
Êags
)

3542 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3543 
pxt4_sb_öfo
 *
sbi
;

3544 
pxt4_exã¡_hódî
 *
eh
;

3545 
pxt4_m≠_blocks
 
•lô_m≠
;

3546 
pxt4_exã¡
 
zîo_ex1
, 
zîo_ex2
;

3547 
pxt4_exã¡
 *
ex
, *
abut_ex
;

3548 
pxt4_lblk_t
 
ì_block
, 
eof_block
;

3549 
ì_Àn
, 
dïth
, 
m≠_Àn
 = 
m≠
->
m_Àn
;

3550 
Æloˇãd
 = 0, 
max_zîoout
 = 0;

3551 
îr
 = 0;

3552 
•lô_Êag
 = 
PXT4_EXT_DATA_VALID2
;

3554 
	`ext_debug
("pxt4_ext_convert_to_initialized: inode %lu,Üogical"

3555 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3556 ()
m≠
->
m_lblk
, 
m≠_Àn
);

3558 
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3559 
eof_block
 = (
	`PXT4_I
(
öode
)->
i_disksize
 + inode->
i_sb
->
s_blocksize
 - 1)

3560 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

3561 i‡(
eof_block
 < 
m≠
->
m_lblk
 + 
m≠_Àn
)

3562 
eof_block
 = 
m≠
->
m_lblk
 + 
m≠_Àn
;

3564 
dïth
 = 
	`ext_dïth
(
öode
);

3565 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3566 
ex
 = 
∑th
[
dïth
].
p_ext
;

3567 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3568 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3569 
zîo_ex1
.
ì_Àn
 = 0;

3570 
zîo_ex2
.
ì_Àn
 = 0;

3572 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_íãr
(
öode
, 
m≠
, 
ex
);

3575 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
));

3576 
	`BUG_ON
(!
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
));

3593 i‡((
m≠
->
m_lblk
 =
ì_block
) &&

3595 (
m≠_Àn
 < 
ì_Àn
) &&

3596 (
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))) {

3597 
pxt4_lblk_t
 
¥ev_lblk
;

3598 
pxt4_fsblk_t
 
¥ev_pblk
, 
ì_pblk
;

3599 
¥ev_Àn
;

3601 
abut_ex
 = 
ex
 - 1;

3602 
¥ev_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3603 
¥ev_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3604 
¥ev_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3605 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3616 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3617 ((
¥ev_lblk
 + 
¥ev_Àn
Ë=
ì_block
) &&

3618 ((
¥ev_pblk
 + 
¥ev_Àn
Ë=
ì_pblk
) &&

3619 (
¥ev_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3620 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3621 i‡(
îr
)

3622 
out
;

3624 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3625 
m≠
, 
ex
, 
abut_ex
);

3628 
ex
->
ì_block
 = 
	`˝u_to_À32
”e_block + 
m≠_Àn
);

3629 
	`pxt4_ext_°‹e_pblock
(
ex
, 
ì_pblk
 + 
m≠_Àn
);

3630 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3631 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3634 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
¥ev_Àn
 + 
m≠_Àn
);

3637 
Æloˇãd
 = 
m≠_Àn
;

3639 } i‡(((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=(
ì_block
 + 
ì_Àn
)) &&

3640 (
m≠_Àn
 < 
ì_Àn
) &&

3641 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

3643 
pxt4_lblk_t
 
√xt_lblk
;

3644 
pxt4_fsblk_t
 
√xt_pblk
, 
ì_pblk
;

3645 
√xt_Àn
;

3647 
abut_ex
 = 
ex
 + 1;

3648 
√xt_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3649 
√xt_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3650 
√xt_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3651 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3662 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3663 ((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=
√xt_lblk
) &&

3664 ((
ì_pblk
 + 
ì_Àn
Ë=
√xt_pblk
) &&

3665 (
√xt_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3666 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3667 i‡(
îr
)

3668 
out
;

3670 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3671 
m≠
, 
ex
, 
abut_ex
);

3674 
abut_ex
->
ì_block
 = 
	`˝u_to_À32
(
√xt_lblk
 - 
m≠_Àn
);

3675 
	`pxt4_ext_°‹e_pblock
(
abut_ex
, 
√xt_pblk
 - 
m≠_Àn
);

3676 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3677 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3680 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
√xt_Àn
 + 
m≠_Àn
);

3683 
Æloˇãd
 = 
m≠_Àn
;

3686 i‡(
Æloˇãd
) {

3688 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3691 
∑th
[
dïth
].
p_ext
 = 
abut_ex
;

3692 
out
;

3694 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3696 
	`WARN_ON
(
m≠
->
m_lblk
 < 
ì_block
);

3701 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ? 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3703 i‡(
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)

3704 
max_zîoout
 = 
sbi
->
s_exã¡_max_zîoout_kb
 >>

3705 (
öode
->
i_sb
->
s_blocksize_bôs
 - 10);

3707 i‡(
	`IS_ENCRYPTED
(
öode
))

3708 
max_zîoout
 = 0;

3721 
•lô_m≠
.
m_lblk
 = 
m≠
->m_lblk;

3722 
•lô_m≠
.
m_Àn
 = 
m≠
->m_len;

3724 i‡(
max_zîoout
 && (
Æloˇãd
 > 
•lô_m≠
.
m_Àn
)) {

3725 i‡(
Æloˇãd
 <
max_zîoout
) {

3727 
zîo_ex1
.
ì_block
 =

3728 
	`˝u_to_À32
(
•lô_m≠
.
m_lblk
 +

3729 
•lô_m≠
.
m_Àn
);

3730 
zîo_ex1
.
ì_Àn
 =

3731 
	`˝u_to_À16
(
Æloˇãd
 - 
•lô_m≠
.
m_Àn
);

3732 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex1
,

3733 
	`pxt4_ext_pblock
(
ex
Ë+ 
•lô_m≠
.
m_lblk
 +

3734 
•lô_m≠
.
m_Àn
 - 
ì_block
);

3735 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex1
);

3736 i‡(
îr
)

3737 
out
;

3738 
•lô_m≠
.
m_Àn
 = 
Æloˇãd
;

3740 i‡(
•lô_m≠
.
m_lblk
 - 
ì_block
 + s∂ô_m≠.
m_Àn
 <

3741 
max_zîoout
) {

3743 i‡(
•lô_m≠
.
m_lblk
 !
ì_block
) {

3744 
zîo_ex2
.
ì_block
 = 
ex
->ee_block;

3745 
zîo_ex2
.
ì_Àn
 = 
	`˝u_to_À16
(
•lô_m≠
.
m_lblk
 -

3746 
ì_block
);

3747 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex2
,

3748 
	`pxt4_ext_pblock
(
ex
));

3749 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex2
);

3750 i‡(
îr
)

3751 
out
;

3754 
•lô_m≠
.
m_Àn
 +•lô_m≠.
m_lblk
 - 
ì_block
;

3755 
•lô_m≠
.
m_lblk
 = 
ì_block
;

3756 
Æloˇãd
 = 
m≠
->
m_Àn
;

3760 
îr
 = 
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
•lô_m≠
, 
•lô_Êag
,

3761 
Êags
);

3762 i‡(
îr
 > 0)

3763 
îr
 = 0;

3764 
out
:

3766 i‡(!
îr
) {

3767 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex1
);

3768 i‡(!
îr
)

3769 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex2
);

3771  
îr
 ?Éº : 
Æloˇãd
;

3772 
	}
}

3798 
	$pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ_t
 *
h™dÀ
,

3799 
öode
 *inode,

3800 
pxt4_m≠_blocks
 *
m≠
,

3801 
pxt4_ext_∑th
 **
µ©h
,

3802 
Êags
)

3804 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3805 
pxt4_lblk_t
 
eof_block
;

3806 
pxt4_lblk_t
 
ì_block
;

3807 
pxt4_exã¡
 *
ex
;

3808 
ì_Àn
;

3809 
•lô_Êag
 = 0, 
dïth
;

3811 
	`ext_debug
("%s: inode %lu,Üogical block %llu, max_blocks %u\n",

3812 
__func__
, 
öode
->
i_öo
,

3813 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3815 
eof_block
 = (
	`PXT4_I
(
öode
)->
i_disksize
 + inode->
i_sb
->
s_blocksize
 - 1)

3816 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

3817 i‡(
eof_block
 < 
m≠
->
m_lblk
 + m≠->
m_Àn
)

3818 
eof_block
 = 
m≠
->
m_lblk
 + m≠->
m_Àn
;

3823 
dïth
 = 
	`ext_dïth
(
öode
);

3824 
ex
 = 
∑th
[
dïth
].
p_ext
;

3825 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3826 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3829 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
) {

3830 
•lô_Êag
 |
PXT4_EXT_DATA_VALID1
;

3832 } i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

3833 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ?

3834 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3835 
•lô_Êag
 |(
PXT4_EXT_MARK_UNWRIT2
 | 
PXT4_EXT_DATA_VALID2
);

3837 
Êags
 |
PXT4_GET_BLOCKS_PRE_IO
;

3838  
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, 
m≠
, 
•lô_Êag
, 
Êags
);

3839 
	}
}

3841 
	$pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ_t
 *
h™dÀ
,

3842 
öode
 *inode,

3843 
pxt4_m≠_blocks
 *
m≠
,

3844 
pxt4_ext_∑th
 **
µ©h
)

3846 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3847 
pxt4_exã¡
 *
ex
;

3848 
pxt4_lblk_t
 
ì_block
;

3849 
ì_Àn
;

3850 
dïth
;

3851 
îr
 = 0;

3853 
dïth
 = 
	`ext_dïth
(
öode
);

3854 
ex
 = 
∑th
[
dïth
].
p_ext
;

3855 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3856 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3858 
	`ext_debug
("pxt4_convert_unwritten_extents_endio: inode %lu,Üogical"

3859 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3860 ()
ì_block
, 
ì_Àn
);

3868 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3869 #ifde‡
CONFIG_PXT4_DEBUG


3870 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Inode (%ld) finished:ÉxtentÜogical block %llu,"

3872 
öode
->
i_öo
, ()
ì_block
, 
ì_Àn
,

3873 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3875 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3876 
PXT4_GET_BLOCKS_CONVERT
);

3877 i‡(
îr
 < 0)

3878  
îr
;

3879 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3880 i‡(
	`IS_ERR
(
∑th
))

3881  
	`PTR_ERR
(
∑th
);

3882 
dïth
 = 
	`ext_dïth
(
öode
);

3883 
ex
 = 
∑th
[
dïth
].
p_ext
;

3886 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3887 i‡(
îr
)

3888 
out
;

3890 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3895 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3898 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3899 
out
:

3900 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3901  
îr
;

3902 
	}
}

3907 
	$check_eofblocks_Ê
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3908 
pxt4_lblk_t
 
lblk
,

3909 
pxt4_ext_∑th
 *
∑th
,

3910 
Àn
)

3912 
i
, 
dïth
;

3913 
pxt4_exã¡_hódî
 *
eh
;

3914 
pxt4_exã¡
 *
œ°_ex
;

3916 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
))

3919 
dïth
 = 
	`ext_dïth
(
öode
);

3920 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3927 i‡(
	`u∆ikñy
(!
eh
->
eh_íåõs
))

3928 
out
;

3929 
œ°_ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

3939 i‡(
lblk
 + 
Àn
 < 
	`À32_to_˝u
(
œ°_ex
->
ì_block
) +

3940 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_ex
))

3949 
i
 = 
dïth
-1; i >= 0; i--)

3950 i‡(
∑th
[
i
].
p_idx
 !
	`EXT_LAST_INDEX
’©h[i].
p_hdr
))

3952 
out
:

3953 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

3954  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3955 
	}
}

3958 
	$c⁄vît_öôülized_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3959 
pxt4_m≠_blocks
 *
m≠
,

3960 
pxt4_ext_∑th
 **
µ©h
,

3961 
Æloˇãd
)

3963 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3964 
pxt4_exã¡
 *
ex
;

3965 
pxt4_lblk_t
 
ì_block
;

3966 
ì_Àn
;

3967 
dïth
;

3968 
îr
 = 0;

3974 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)

3975 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
 / 2;

3977 
dïth
 = 
	`ext_dïth
(
öode
);

3978 
ex
 = 
∑th
[
dïth
].
p_ext
;

3979 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3980 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3982 
	`ext_debug
("%s: inode %lu,Üogical"

3983 "block %Œu, max_block†%u\n", 
__func__
, 
öode
->
i_öo
,

3984 ()
ì_block
, 
ì_Àn
);

3986 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3987 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3988 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
);

3989 i‡(
îr
 < 0)

3990  
îr
;

3991 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3992 i‡(
	`IS_ERR
(
∑th
))

3993  
	`PTR_ERR
(
∑th
);

3994 
dïth
 = 
	`ext_dïth
(
öode
);

3995 
ex
 = 
∑th
[
dïth
].
p_ext
;

3996 i‡(!
ex
) {

3997 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3998 (Ë
m≠
->
m_lblk
);

3999  -
EFSCORRUPTED
;

4003 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

4004 i‡(
îr
)

4005  
îr
;

4007 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

4012 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

4015 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

4016 i‡(
îr
)

4017  
îr
;

4018 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4020 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4021 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
, m≠->
m_Àn
);

4022 i‡(
îr
)

4023  
îr
;

4024 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4025 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4026 
Æloˇãd
 = 
m≠
->
m_Àn
;

4027 
m≠
->
m_Àn
 = 
Æloˇãd
;

4028  
Æloˇãd
;

4029 
	}
}

4032 
	$pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4033 
pxt4_m≠_blocks
 *
m≠
,

4034 
pxt4_ext_∑th
 **
µ©h
, 
Êags
,

4035 
Æloˇãd
, 
pxt4_fsblk_t
 
√wblock
)

4037 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

4038 
ªt
 = 0;

4039 
îr
 = 0;

4041 
	`ext_debug
("pxt4_ext_handle_unwritten_extents: inode %lu,Üogical "

4043 
öode
->
i_öo
, ()
m≠
->
m_lblk
, m≠->
m_Àn
,

4044 
Êags
, 
Æloˇãd
);

4045 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4051 
Êags
 |
PXT4_GET_BLOCKS_METADATA_NOFAIL
;

4053 
	`åa˚_pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
öode
, 
m≠
, 
Êags
,

4054 
Æloˇãd
, 
√wblock
);

4057 i‡(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) {

4058 
ªt
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

4059 
Êags
 | 
PXT4_GET_BLOCKS_CONVERT
);

4060 i‡(
ªt
 <= 0)

4061 
out
;

4062 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4063 
out
;

4066 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

4067 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) {

4068 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4069 
Æloˇãd
 = 
m≠
->
m_Àn
;

4070 
îr
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
, 
√wblock
,

4071 
Æloˇãd
);

4072 i‡(
îr
 < 0)

4073 
out2
;

4075 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ
, 
öode
, 
m≠
,

4076 
µ©h
);

4077 i‡(
ªt
 >= 0) {

4078 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4079 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4080 
∑th
, 
m≠
->
m_Àn
);

4082 
îr
 = 
ªt
;

4083 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4084 
m≠
->
m_pblk
 = 
√wblock
;

4085 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4086 
Æloˇãd
 = 
m≠
->
m_Àn
;

4087 
m≠
->
m_Àn
 = 
Æloˇãd
;

4088 
out2
;

4095 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) {

4096 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4097 
m≠_out
;

4101 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4109 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4110 
out1
;

4114 
ªt
 = 
	`pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
, 
Êags
);

4115 i‡(
ªt
 >= 0)

4116 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4117 
out
:

4118 i‡(
ªt
 <= 0) {

4119 
îr
 = 
ªt
;

4120 
out2
;

4122 
Æloˇãd
 = 
ªt
;

4123 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4124 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4125 
Æloˇãd
 = 
m≠
->
m_Àn
;

4126 
m≠
->
m_Àn
 = 
Æloˇãd
;

4128 
m≠_out
:

4129 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4130 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0) {

4131 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
,

4132 
m≠
->
m_Àn
);

4133 i‡(
îr
 < 0)

4134 
out2
;

4136 
out1
:

4137 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4138 
Æloˇãd
 = 
m≠
->
m_Àn
;

4139 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4140 
m≠
->
m_pblk
 = 
√wblock
;

4141 
m≠
->
m_Àn
 = 
Æloˇãd
;

4142 
out2
:

4143  
îr
 ?Éº : 
Æloˇãd
;

4144 
	}
}

4187 
	$gë_im∂õd_˛u°î_Æloc
(
su≥r_block
 *
sb
,

4188 
pxt4_m≠_blocks
 *
m≠
,

4189 
pxt4_exã¡
 *
ex
,

4190 
pxt4_ext_∑th
 *
∑th
)

4192 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4193 
pxt4_lblk_t
 
c_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4194 
pxt4_lblk_t
 
ex_˛u°î_°¨t
, 
ex_˛u°î_íd
;

4195 
pxt4_lblk_t
 
º_˛u°î_°¨t
;

4196 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4197 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4198 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4201 
ex_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
);

4202 
ex_˛u°î_íd
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
 + 
ì_Àn
 - 1);

4205 
º_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
m≠
->
m_lblk
);

4207 i‡((
º_˛u°î_°¨t
 =
ex_˛u°î_íd
) ||

4208 (
º_˛u°î_°¨t
 =
ex_˛u°î_°¨t
)) {

4209 i‡(
º_˛u°î_°¨t
 =
ex_˛u°î_íd
)

4210 
ì_°¨t
 +
ì_Àn
 - 1;

4211 
m≠
->
m_pblk
 = 
	`PXT4_PBLK_CMASK
(
sbi
, 
ì_°¨t
Ë+ 
c_off£t
;

4212 
m≠
->
m_Àn
 = 
	`mö
(map->m_len,

4213 (Ë
sbi
->
s_˛u°î_øtio
 - 
c_off£t
);

4223 i‡(
m≠
->
m_lblk
 < 
ì_block
)

4224 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
ì_block
 - m≠->
m_lblk
);

4235 i‡(
m≠
->
m_lblk
 > 
ì_block
) {

4236 
pxt4_lblk_t
 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

4237 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
√xt
 - m≠->
m_lblk
);

4240 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 1);

4244 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 0);

4246 
	}
}

4267 
	$pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4268 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

4270 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

4271 
pxt4_exã¡
 
√wex
, *
ex
, *
ex2
;

4272 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4273 
pxt4_fsblk_t
 
√wblock
 = 0;

4274 
‰ì_⁄_îr
 = 0, 
îr
 = 0, 
dïth
, 
ªt
;

4275 
Æloˇãd
 = 0, 
off£t
 = 0;

4276 
Æloˇãd_˛u°îs
 = 0;

4277 
pxt4_Æloˇti⁄_ªque°
 
¨
;

4278 
pxt4_lblk_t
 
˛u°î_off£t
;

4279 
boﬁ
 
m≠_‰om_˛u°î
 = 
Ál£
;

4281 
	`ext_debug
("blocks %u/%uÑequested for inode %lu\n",

4282 
m≠
->
m_lblk
, m≠->
m_Àn
, 
öode
->
i_öo
);

4283 
	`åa˚_pxt4_ext_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

4286 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, 0);

4287 i‡(
	`IS_ERR
(
∑th
)) {

4288 
îr
 = 
	`PTR_ERR
(
∑th
);

4289 
∑th
 = 
NULL
;

4290 
out2
;

4293 
dïth
 = 
	`ext_dïth
(
öode
);

4300 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

4301 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtentáddress "

4303 (Ë
m≠
->
m_lblk
, 
dïth
,

4304 
∑th
[
dïth
].
p_block
);

4305 
îr
 = -
EFSCORRUPTED
;

4306 
out2
;

4309 
ex
 = 
∑th
[
dïth
].
p_ext
;

4310 i‡(
ex
) {

4311 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4312 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4313 
ì_Àn
;

4320 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4322 
	`åa˚_pxt4_ext_show_exã¡
(
öode
, 
ì_block
, 
ì_°¨t
, 
ì_Àn
);

4325 i‡(
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
)) {

4326 
√wblock
 = 
m≠
->
m_lblk
 - 
ì_block
 + 
ì_°¨t
;

4328 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

4329 
	`ext_debug
("%u fô i¡ÿ%u:%d -> %Œu\n", 
m≠
->
m_lblk
,

4330 
ì_block
, 
ì_Àn
, 
√wblock
);

4336 i‡((!
	`pxt4_ext_is_unwrôãn
(
ex
)) &&

4337 (
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
)) {

4338 
Æloˇãd
 = 
	`c⁄vît_öôülized_exã¡
(

4339 
h™dÀ
, 
öode
, 
m≠
, &
∑th
,

4340 
Æloˇãd
);

4341 
out2
;

4342 } i‡(!
	`pxt4_ext_is_unwrôãn
(
ex
))

4343 
out
;

4345 
ªt
 = 
	`pxt4_ext_h™dÀ_unwrôãn_exã¡s
(

4346 
h™dÀ
, 
öode
, 
m≠
, &
∑th
, 
Êags
,

4347 
Æloˇãd
, 
√wblock
);

4348 i‡(
ªt
 < 0)

4349 
îr
 = 
ªt
;

4351 
Æloˇãd
 = 
ªt
;

4352 
out2
;

4360 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4361 
pxt4_lblk_t
 
hﬁe_°¨t
, 
hﬁe_Àn
;

4363 
hﬁe_°¨t
 = 
m≠
->
m_lblk
;

4364 
hﬁe_Àn
 = 
	`pxt4_ext_dëîmöe_hﬁe
(
öode
, 
∑th
, &
hﬁe_°¨t
);

4369 
	`pxt4_ext_put_g≠_ö_ˇche
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
);

4372 i‡(
hﬁe_°¨t
 !
m≠
->
m_lblk
)

4373 
hﬁe_Àn
 -
m≠
->
m_lblk
 - 
hﬁe_°¨t
;

4374 
m≠
->
m_pblk
 = 0;

4375 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
hﬁe_Àn
);

4377 
out2
;

4383 
√wex
.
ì_block
 = 
	`˝u_to_À32
(
m≠
->
m_lblk
);

4384 
˛u°î_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4390 i‡(
˛u°î_off£t
 && 
ex
 &&

4391 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex
, 
∑th
)) {

4392 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4393 
√wblock
 = 
m≠
->
m_pblk
;

4394 
m≠_‰om_˛u°î
 = 
åue
;

4395 
gŸ_Æloˇãd_blocks
;

4399 
¨
.
Œe·
 = 
m≠
->
m_lblk
;

4400 
îr
 = 
	`pxt4_ext_£¨ch_À·
(
öode
, 
∑th
, &
¨
.
Œe·
, &¨.
∂e·
);

4401 i‡(
îr
)

4402 
out2
;

4403 
¨
.
Ãight
 = 
m≠
->
m_lblk
;

4404 
ex2
 = 
NULL
;

4405 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
¨
.
Ãight
, &¨.
¥ight
, &
ex2
);

4406 i‡(
îr
)

4407 
out2
;

4411 i‡((
sbi
->
s_˛u°î_øtio
 > 1Ë&& 
ex2
 &&

4412 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex2
, 
∑th
)) {

4413 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4414 
√wblock
 = 
m≠
->
m_pblk
;

4415 
m≠_‰om_˛u°î
 = 
åue
;

4416 
gŸ_Æloˇãd_blocks
;

4425 i‡(
m≠
->
m_Àn
 > 
EXT_INIT_MAX_LEN
 &&

4426 !(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4427 
m≠
->
m_Àn
 = 
EXT_INIT_MAX_LEN
;

4428 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

4429 (
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4430 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
;

4433 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
m≠
->
m_Àn
);

4434 
îr
 = 
	`pxt4_ext_check_ovîœp
(
sbi
, 
öode
, &
√wex
, 
∑th
);

4435 i‡(
îr
)

4436 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4438 
Æloˇãd
 = 
m≠
->
m_Àn
;

4441 
¨
.
öode
 = inode;

4442 
¨
.
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
m≠
->
m_lblk
);

4443 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

4452 
off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4453 
¨
.
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
off£t
+
Æloˇãd
);

4454 
¨
.
gﬂl
 -
off£t
;

4455 
¨
.
logiˇl
 -
off£t
;

4456 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4457 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

4460 
¨
.
Êags
 = 0;

4461 i‡(
Êags
 & 
PXT4_GET_BLOCKS_NO_NORMALIZE
)

4462 
¨
.
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4463 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

4464 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

4465 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

4466 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

4467 
√wblock
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, &
îr
);

4468 i‡(!
√wblock
)

4469 
out2
;

4470 
	`ext_debug
("allocateÇew block: goal %llu, found %llu/%u\n",

4471 
¨
.
gﬂl
, 
√wblock
, 
Æloˇãd
);

4472 
‰ì_⁄_îr
 = 1;

4473 
Æloˇãd_˛u°îs
 = 
¨
.
Àn
;

4474 
¨
.
Àn
 = 
	`PXT4_C2B
(
sbi
,ár.ÀnË- 
off£t
;

4475 i‡(
¨
.
Àn
 > 
Æloˇãd
)

4476 
¨
.
Àn
 = 
Æloˇãd
;

4478 
gŸ_Æloˇãd_blocks
:

4480 
	`pxt4_ext_°‹e_pblock
(&
√wex
, 
√wblock
 + 
off£t
);

4481 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
¨
.
Àn
);

4483 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
){

4484 
	`pxt4_ext_m¨k_unwrôãn
(&
√wex
);

4485 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4488 
îr
 = 0;

4489 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0)

4490 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4491 
∑th
, 
¨
.
Àn
);

4492 i‡(!
îr
)

4493 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
,

4494 &
√wex
, 
Êags
);

4496 i‡(
îr
 && 
‰ì_⁄_îr
) {

4497 
fb_Êags
 = 
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

4498 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

4502 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4503 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
√wblock
,

4504 
	`PXT4_C2B
(
sbi
, 
Æloˇãd_˛u°îs
), 
fb_Êags
);

4505 
out2
;

4509 
√wblock
 = 
	`pxt4_ext_pblock
(&
√wex
);

4510 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4511 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4512 
Æloˇãd
 = 
m≠
->
m_Àn
;

4513 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4521 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
Ë&& !
m≠_‰om_˛u°î
) {

4522 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4527 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
Æloˇãd_˛u°îs
,

4530 
pxt4_lblk_t
 
lblk
, 
Àn
;

4531 
n
;

4544 
lblk
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
m≠
->
m_lblk
);

4545 
Àn
 = 
Æloˇãd_˛u°îs
 << 
sbi
->
s_˛u°î_bôs
;

4546 
n
 = 
	`pxt4_es_dñayed_˛u
(
öode
, 
lblk
, 
Àn
);

4547 i‡(
n
 > 0)

4548 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, (Ë
n
, 0);

4556 i‡((
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

4557 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4559 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 0);

4560 
out
:

4561 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4562 
Æloˇãd
 = 
m≠
->
m_Àn
;

4563 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4564 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4565 
m≠
->
m_pblk
 = 
√wblock
;

4566 
m≠
->
m_Àn
 = 
Æloˇãd
;

4567 
out2
:

4568 
	`pxt4_ext_dr›_ªfs
(
∑th
);

4569 
	`k‰ì
(
∑th
);

4571 
	`åa˚_pxt4_ext_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
,

4572 
îr
 ?Éº : 
Æloˇãd
);

4573  
îr
 ?Éº : 
Æloˇãd
;

4574 
	}
}

4576 
	$pxt4_ext_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

4578 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4579 
pxt4_lblk_t
 
œ°_block
;

4580 
îr
 = 0;

4589 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

4590 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4591 i‡(
îr
)

4592  
îr
;

4594 
œ°_block
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1)

4595 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4596 
ªåy
:

4597 
îr
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
,

4598 
EXT_MAX_BLOCKS
 - 
œ°_block
);

4599 i‡(
îr
 =-
ENOMEM
) {

4600 
	`c⁄d_ªsched
();

4601 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

4602 
ªåy
;

4604 i‡(
îr
)

4605  
îr
;

4606  
	`pxt4_ext_ªmove_•a˚
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 - 1);

4607 
	}
}

4609 
	$pxt4_Æloc_fûe_blocks
(
fûe
 *fûe, 
pxt4_lblk_t
 
off£t
,

4610 
pxt4_lblk_t
 
Àn
, 
loff_t
 
√w_size
,

4611 
Êags
)

4613 
öode
 *öodê
	`fûe_öode
(
fûe
);

4614 
h™dÀ_t
 *
h™dÀ
;

4615 
ªt
 = 0;

4616 
ªt2
 = 0;

4617 
ªåõs
 = 0;

4618 
dïth
 = 0;

4619 
pxt4_m≠_blocks
 
m≠
;

4620 
¸edôs
;

4621 
loff_t
 
ïos
;

4623 
	`BUG_ON
(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
));

4624 
m≠
.
m_lblk
 = 
off£t
;

4625 
m≠
.
m_Àn
 = 
Àn
;

4631 i‡(
Àn
 <
EXT_UNWRITTEN_MAX_LEN
)

4632 
Êags
 |
PXT4_GET_BLOCKS_NO_NORMALIZE
;

4637 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4638 
dïth
 = 
	`ext_dïth
(
öode
);

4640 
ªåy
:

4641 
ªt
 >0 && 
Àn
) {

4645 i‡(
dïth
 !
	`ext_dïth
(
öode
)) {

4646 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4647 
dïth
 = 
	`ext_dïth
(
öode
);

4650 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4651 
¸edôs
);

4652 i‡(
	`IS_ERR
(
h™dÀ
)) {

4653 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4656 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
Êags
);

4657 i‡(
ªt
 <= 0) {

4658 
	`pxt4_debug
("inode #%lu: block %u:Üen %u: "

4660 
öode
->
i_öo
, 
m≠
.
m_lblk
,

4661 
m≠
.
m_Àn
, 
ªt
);

4662 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4663 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4666 
m≠
.
m_lblk
 +
ªt
;

4667 
m≠
.
m_Àn
 = 
Àn
 =Üí - 
ªt
;

4668 
ïos
 = (
loff_t
)
m≠
.
m_lblk
 << 
öode
->
i_blkbôs
;

4669 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

4670 i‡(
√w_size
) {

4671 i‡(
ïos
 > 
√w_size
)

4672 
ïos
 = 
√w_size
;

4673 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
ïos
) & 0x1)

4674 
öode
->
i_mtime
 = inode->
i_˘ime
;

4676 i‡(
ïos
 > 
öode
->
i_size
)

4677 
	`pxt4_£t_öode_Êag
(
öode
,

4678 
PXT4_INODE_EOFBLOCKS
);

4680 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4681 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4682 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4683 i‡(
ªt2
)

4686 i‡(
ªt
 =-
ENOSPC
 &&

4687 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
)) {

4688 
ªt
 = 0;

4689 
ªåy
;

4692  
ªt
 > 0 ? 
ªt2
 :Ñet;

4693 
	}
}

4695 
	$pxt4_zîo_ønge
(
fûe
 *fûe, 
loff_t
 
off£t
,

4696 
loff_t
 
Àn
, 
mode
)

4698 
öode
 *öodê
	`fûe_öode
(
fûe
);

4699 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

4700 
max_blocks
;

4701 
loff_t
 
√w_size
 = 0;

4702 
ªt
 = 0;

4703 
Êags
;

4704 
¸edôs
;

4705 
∑πül_begö
, 
∑πül_íd
;

4706 
loff_t
 
°¨t
, 
íd
;

4707 
pxt4_lblk_t
 
lblk
;

4708 
blkbôs
 = 
öode
->
i_blkbôs
;

4710 
	`åa˚_pxt4_zîo_ønge
(
öode
, 
off£t
, 
Àn
, 
mode
);

4712 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4713  -
EINVAL
;

4716 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4717 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

4718 i‡(
ªt
)

4719  
ªt
;

4728 
°¨t
 = 
	`round_up
(
off£t
, 1 << 
blkbôs
);

4729 
íd
 = 
	`round_down
((
off£t
 + 
Àn
), 1 << 
blkbôs
);

4731 i‡(
°¨t
 < 
off£t
 || 
íd
 > off£à+ 
Àn
)

4732  -
EINVAL
;

4733 
∑πül_begö
 = 
off£t
 & ((1 << 
blkbôs
) - 1);

4734 
∑πül_íd
 = (
off£t
 + 
Àn
Ë& ((1 << 
blkbôs
) - 1);

4736 
lblk
 = 
°¨t
 >> 
blkbôs
;

4737 
max_blocks
 = (
íd
 >> 
blkbôs
);

4738 i‡(
max_blocks
 < 
lblk
)

4739 
max_blocks
 = 0;

4741 
max_blocks
 -
lblk
;

4743 
	`öode_lock
(
öode
);

4748 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4749 
ªt
 = -
EOPNOTSUPP
;

4750 
out_muãx
;

4753 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4754 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4755 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4756 
√w_size
 = 
off£t
 + 
Àn
;

4757 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4758 i‡(
ªt
)

4759 
out_muãx
;

4762 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4763 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4764 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4767 
	`öode_dio_waô
(
öode
);

4770 i‡(
∑πül_begö
 || 
∑πül_íd
) {

4771 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
,

4772 
	`round_down
(
off£t
, 1 << 
blkbôs
) >> blkbits,

4773 (
	`round_up
((
off£t
 + 
Àn
), 1 << 
blkbôs
) -

4774 
	`round_down
(
off£t
, 1 << 
blkbôs
)) >> blkbits,

4775 
√w_size
, 
Êags
);

4776 i‡(
ªt
)

4777 
out_muãx
;

4782 i‡(
max_blocks
 > 0) {

4783 
Êags
 |(
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 |

4784 
PXT4_EX_NOCACHE
);

4790 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4792 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4793 i‡(
ªt
) {

4794 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4795 
out_muãx
;

4798 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àn
);

4799 i‡(
ªt
) {

4800 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4801 
out_muãx
;

4804 
	`åunˇã_∑geˇche_ønge
(
öode
, 
°¨t
, 
íd
 - 1);

4805 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4807 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
,

4808 
Êags
);

4809 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4810 i‡(
ªt
)

4811 
out_muãx
;

4813 i‡(!
∑πül_begö
 && !
∑πül_íd
)

4814 
out_muãx
;

4820 
¸edôs
 = (2 * 
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 2)) + 1;

4821 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4822 
¸edôs
 += 2;

4823 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

4824 i‡(
	`IS_ERR
(
h™dÀ
)) {

4825 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4826 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

4827 
out_muãx
;

4830 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4831 i‡(
√w_size
) {

4832 
	`pxt4_upd©e_öode_size
(
öode
, 
√w_size
);

4838 i‡((
off£t
 + 
Àn
Ë> 
	`i_size_ªad
(
öode
))

4839 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4841 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4844 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
, 
Àn
);

4845 i‡(
ªt
 >= 0)

4846 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4848 i‡(
fûe
->
f_Êags
 & 
O_SYNC
)

4849 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4851 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4852 
out_muãx
:

4853 
	`öode_u∆ock
(
öode
);

4854  
ªt
;

4855 
	}
}

4864 
	$pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,Üoff_à
Àn
)

4866 
öode
 *öodê
	`fûe_öode
(
fûe
);

4867 
loff_t
 
√w_size
 = 0;

4868 
max_blocks
;

4869 
ªt
 = 0;

4870 
Êags
;

4871 
pxt4_lblk_t
 
lblk
;

4872 
blkbôs
 = 
öode
->
i_blkbôs
;

4884 i‡(
	`IS_ENCRYPTED
(
öode
) &&

4885 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

4886 
FALLOC_FL_ZERO_RANGE
)))

4887  -
EOPNOTSUPP
;

4890 i‡(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

4891 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

4892 
FALLOC_FL_INSERT_RANGE
))

4893  -
EOPNOTSUPP
;

4895 i‡(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

4896  
	`pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àn
);

4898 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4899 i‡(
ªt
)

4900  
ªt
;

4902 i‡(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

4903  
	`pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

4905 i‡(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

4906  
	`pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

4908 i‡(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

4909  
	`pxt4_zîo_ønge
(
fûe
, 
off£t
, 
Àn
, 
mode
);

4911 
	`åa˚_pxt4_ÁŒoˇã_íãr
(
öode
, 
off£t
, 
Àn
, 
mode
);

4912 
lblk
 = 
off£t
 >> 
blkbôs
;

4914 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4915 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4916 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4917 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4919 
	`öode_lock
(
öode
);

4924 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4925 
ªt
 = -
EOPNOTSUPP
;

4926 
out
;

4929 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4930 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4931 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4932 
√w_size
 = 
off£t
 + 
Àn
;

4933 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4934 i‡(
ªt
)

4935 
out
;

4939 
	`öode_dio_waô
(
öode
);

4941 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
, 
Êags
);

4942 i‡(
ªt
)

4943 
out
;

4945 i‡(
fûe
->
f_Êags
 & 
O_SYNC
 && 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

4946 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

4947 
	`PXT4_I
(
öode
)->
i_sync_tid
);

4949 
out
:

4950 
	`öode_u∆ock
(
öode
);

4951 
	`åa˚_pxt4_ÁŒoˇã_exô
(
öode
, 
off£t
, 
max_blocks
, 
ªt
);

4952  
ªt
;

4953 
	}
}

4965 
	$pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4966 
loff_t
 
off£t
, 
ssize_t
 
Àn
)

4968 
max_blocks
;

4969 
ªt
 = 0;

4970 
ªt2
 = 0;

4971 
pxt4_m≠_blocks
 
m≠
;

4972 
¸edôs
, 
blkbôs
 = 
öode
->
i_blkbôs
;

4974 
m≠
.
m_lblk
 = 
off£t
 >> 
blkbôs
;

4975 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4982 i‡(
h™dÀ
) {

4983 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_ª£rved
(handle,

4984 
PXT4_HT_EXT_CONVERT
);

4985 i‡(
	`IS_ERR
(
h™dÀ
))

4986  
	`PTR_ERR
(
h™dÀ
);

4987 
¸edôs
 = 0;

4992 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
max_blocks
);

4994 
ªt
 >0 &&Ñë < 
max_blocks
) {

4995 
m≠
.
m_lblk
 +
ªt
;

4996 
m≠
.
m_Àn
 = (
max_blocks
 -
ªt
);

4997 i‡(
¸edôs
) {

4998 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4999 
¸edôs
);

5000 i‡(
	`IS_ERR
(
h™dÀ
)) {

5001 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5005 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

5006 
PXT4_GET_BLOCKS_IO_CONVERT_EXT
);

5007 i‡(
ªt
 <= 0)

5008 
	`pxt4_w¨nög
(
öode
->
i_sb
,

5011 
öode
->
i_öo
, 
m≠
.
m_lblk
,

5012 
m≠
.
m_Àn
, 
ªt
);

5013 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5014 i‡(
¸edôs
)

5015 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5016 i‡(
ªt
 <0 || 
ªt2
)

5019 i‡(!
¸edôs
)

5020 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5021  
ªt
 > 0 ? 
ªt2
 :Ñet;

5022 
	}
}

5033 
	$pxt4_föd_dñayed_exã¡
(
öode
 *inode,

5034 
exã¡_°©us
 *
√wes
)

5036 
exã¡_°©us
 
es
;

5037 
pxt4_lblk_t
 
block
, 
√xt_dñ
;

5039 i‡(
√wes
->
es_pblk
 == 0) {

5040 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

5041 
√wes
->
es_lblk
,

5042 
√wes
->
es_lblk
 +Çewes->
es_Àn
 - 1,

5043 &
es
);

5049 i‡(
es
.
es_Àn
 == 0)

5053 i‡(
es
.
es_lblk
 > 
√wes
->es_lblk) {

5055 
√wes
->
es_Àn
 = 
	`mö
(
es
.
es_lblk
 -Çewes->es_lblk,

5056 
√wes
->
es_Àn
);

5060 
√wes
->
es_Àn
 = 
es
.
es_lblk
 +És.es_len -Çewes->es_lblk;

5063 
block
 = 
√wes
->
es_lblk
 +Çewes->
es_Àn
;

5064 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
block
,

5065 
EXT_MAX_BLOCKS
, &
es
);

5066 i‡(
es
.
es_Àn
 == 0)

5067 
√xt_dñ
 = 
EXT_MAX_BLOCKS
;

5069 
√xt_dñ
 = 
es
.
es_lblk
;

5071  
√xt_dñ
;

5072 
	}
}

5074 
	$pxt4_x©å_fõm≠
(
öode
 *inode,

5075 
fõm≠_exã¡_öfo
 *
fõöfo
)

5077 
__u64
 
physiˇl
 = 0;

5078 
__u64
 
Àngth
;

5079 
__u32
 
Êags
 = 
FIEMAP_EXTENT_LAST
;

5080 
blockbôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

5081 
îr‹
 = 0;

5084 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

5085 
pxt4_ûoc
 
ûoc
;

5086 
off£t
;

5088 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

5089 i‡(
îr‹
)

5090  
îr‹
;

5091 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
blockbôs
;

5092 
off£t
 = 
PXT4_GOOD_OLD_INODE_SIZE
 +

5093 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

5094 
physiˇl
 +
off£t
;

5095 
Àngth
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 - 
off£t
;

5096 
Êags
 |
FIEMAP_EXTENT_DATA_INLINE
;

5097 
	`bªl£
(
ûoc
.
bh
);

5099 
physiˇl
 = (
__u64
)
	`PXT4_I
(
öode
)->
i_fûe_a˛
 << 
blockbôs
;

5100 
Àngth
 = 
öode
->
i_sb
->
s_blocksize
;

5103 i‡(
physiˇl
)

5104 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 0, 
physiˇl
,

5105 
Àngth
, 
Êags
);

5106  (
îr‹
 < 0 ?Érror : 0);

5107 
	}
}

5109 
	$_pxt4_fõm≠
(
öode
 *inode,

5110 
fõm≠_exã¡_öfo
 *
fõöfo
,

5111 
__u64
 
°¨t
, __u64 
Àn
,

5112 (*
fûl
)(
öode
 *, 
pxt4_lblk_t
,

5113 
pxt4_lblk_t
,

5114 
fõm≠_exã¡_öfo
 *))

5116 
pxt4_lblk_t
 
°¨t_blk
;

5117 
u32
 
pxt4_fõm≠_Êags
 = 
FIEMAP_FLAG_SYNC
|
FIEMAP_FLAG_XATTR
;

5119 
îr‹
 = 0;

5121 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5122 
has_ölöe
 = 1;

5124 
îr‹
 = 
	`pxt4_ölöe_d©a_fõm≠
(
öode
, 
fõöfo
, &
has_ölöe
,

5125 
°¨t
, 
Àn
);

5127 i‡(
has_ölöe
)

5128  
îr‹
;

5131 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_CACHE
) {

5132 
îr‹
 = 
	`pxt4_ext_¥eˇche
(
öode
);

5133 i‡(
îr‹
)

5134  
îr‹
;

5135 
fõöfo
->
fi_Êags
 &~
FIEMAP_FLAG_CACHE
;

5139 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) &&

5140 
fûl
 =
pxt4_fûl_fõm≠_exã¡s
)

5141  
	`gíîic_block_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5142 
pxt4_gë_block
);

5144 i‡(
fûl
 =
pxt4_fûl_es_ˇche_öfo
)

5145 
pxt4_fõm≠_Êags
 &
FIEMAP_FLAG_XATTR
;

5146 i‡(
	`fõm≠_check_Êags
(
fõöfo
, 
pxt4_fõm≠_Êags
))

5147  -
EBADR
;

5149 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_XATTR
) {

5150 
îr‹
 = 
	`pxt4_x©å_fõm≠
(
öode
, 
fõöfo
);

5152 
pxt4_lblk_t
 
Àn_blks
;

5153 
__u64
 
œ°_blk
;

5155 
°¨t_blk
 = 
°¨t
 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

5156 
œ°_blk
 = (
°¨t
 + 
Àn
 - 1Ë>> 
öode
->
i_sb
->
s_blocksize_bôs
;

5157 i‡(
œ°_blk
 >
EXT_MAX_BLOCKS
)

5158 
œ°_blk
 = 
EXT_MAX_BLOCKS
-1;

5159 
Àn_blks
 = ((
pxt4_lblk_t
Ë
œ°_blk
Ë- 
°¨t_blk
 + 1;

5165 
îr‹
 = 
	`fûl
(
öode
, 
°¨t_blk
, 
Àn_blks
, 
fõöfo
);

5167  
îr‹
;

5168 
	}
}

5170 
	$pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5171 
__u64
 
°¨t
, __u64 
Àn
)

5173  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5174 
pxt4_fûl_fõm≠_exã¡s
);

5175 
	}
}

5177 
	$pxt4_gë_es_ˇche
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5178 
__u64
 
°¨t
, __u64 
Àn
)

5180 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5181 
has_ölöe
;

5183 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5184 
has_ölöe
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

5185 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5186 i‡(
has_ölöe
)

5190  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5191 
pxt4_fûl_es_ˇche_öfo
);

5192 
	}
}

5202 
	$pxt4_ac˚ss_∑th
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5203 
pxt4_ext_∑th
 *
∑th
)

5205 
¸edôs
, 
îr
;

5207 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

5216 i‡(
h™dÀ
->
h_buf„r_¸edôs
 < 7) {

5217 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5218 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

5220 i‡(
îr
 &&Éº !-
EAGAIN
)

5221  
îr
;

5224 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

5225  
îr
;

5226 
	}
}

5235 
	$pxt4_ext_shi·_∑th_exã¡s
(
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
shi·
,

5236 
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5237 
SHIFT_DIRECTION
 
SHIFT
)

5239 
dïth
, 
îr
 = 0;

5240 
pxt4_exã¡
 *
ex_°¨t
, *
ex_œ°
;

5241 
boﬁ
 
upd©e
 = 0;

5242 
dïth
 = 
∑th
->
p_dïth
;

5244 
dïth
 >= 0) {

5245 i‡(
dïth
 =
∑th
->
p_dïth
) {

5246 
ex_°¨t
 = 
∑th
[
dïth
].
p_ext
;

5247 i‡(!
ex_°¨t
)

5248  -
EFSCORRUPTED
;

5250 
ex_œ°
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5252 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5253 i‡(
îr
)

5254 
out
;

5256 i‡(
ex_°¨t
 =
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5257 
upd©e
 = 1;

5259 
ex_°¨t
 <
ex_œ°
) {

5260 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5261 
	`À32_add_˝u
(&
ex_°¨t
->
ì_block
,

5262 -
shi·
);

5264 i‡((
ex_°¨t
 >

5265 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5267 
	`pxt4_ext_åy_to_mîge_right
(
öode
,

5268 
∑th
, 
ex_°¨t
 - 1))

5269 
ex_œ°
--;

5271 
ex_°¨t
++;

5273 
	`À32_add_˝u
(&
ex_œ°
->
ì_block
, 
shi·
);

5274 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
,

5275 
ex_œ°
);

5276 
ex_œ°
--;

5279 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5280 i‡(
îr
)

5281 
out
;

5283 i‡(--
dïth
 < 0 || !
upd©e
)

5288 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5289 i‡(
îr
)

5290 
out
;

5292 i‡(
SHIFT
 =
SHIFT_LEFT
)

5293 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, -
shi·
);

5295 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, 
shi·
);

5296 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5297 i‡(
îr
)

5298 
out
;

5301 i‡(
∑th
[
dïth
].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[dïth].
p_hdr
))

5304 
dïth
--;

5307 
out
:

5308  
îr
;

5309 
	}
}

5319 
	$pxt4_ext_shi·_exã¡s
(
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5320 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
shi·
,

5321 
SHIFT_DIRECTION
 
SHIFT
)

5323 
pxt4_ext_∑th
 *
∑th
;

5324 
ªt
 = 0, 
dïth
;

5325 
pxt4_exã¡
 *
exã¡
;

5326 
pxt4_lblk_t
 
°›
, *
ôî©‹
, 
ex_°¨t
, 
ex_íd
;

5329 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
,

5330 
PXT4_EX_NOCACHE
);

5331 i‡(
	`IS_ERR
(
∑th
))

5332  
	`PTR_ERR
(
∑th
);

5334 
dïth
 = 
∑th
->
p_dïth
;

5335 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5336 i‡(!
exã¡
)

5337 
out
;

5339 
°›
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5346 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5347 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
°¨t
 - 1, &path,

5348 
PXT4_EX_NOCACHE
);

5349 i‡(
	`IS_ERR
(
∑th
))

5350  
	`PTR_ERR
(
∑th
);

5351 
dïth
 = 
∑th
->
p_dïth
;

5352 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5353 i‡(
exã¡
) {

5354 
ex_°¨t
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5355 
ex_íd
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5356 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5358 
ex_°¨t
 = 0;

5359 
ex_íd
 = 0;

5362 i‡((
°¨t
 =
ex_°¨t
 && 
shi·
 >Éx_start) ||

5363 (
shi·
 > 
°¨t
 - 
ex_íd
)) {

5364 
ªt
 = -
EINVAL
;

5365 
out
;

5368 i‡(
shi·
 > 
EXT_MAX_BLOCKS
 -

5369 (
°›
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
))) {

5370 
ªt
 = -
EINVAL
;

5371 
out
;

5380 i‡(
SHIFT
 =
SHIFT_LEFT
)

5381 
ôî©‹
 = &
°¨t
;

5383 
ôî©‹
 = &
°›
;

5390 
ôî©‹
 && 
°¨t
 <
°›
) {

5391 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, *
ôî©‹
, &path,

5392 
PXT4_EX_NOCACHE
);

5393 i‡(
	`IS_ERR
(
∑th
))

5394  
	`PTR_ERR
(
∑th
);

5395 
dïth
 = 
∑th
->
p_dïth
;

5396 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5397 i‡(!
exã¡
) {

5398 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

5399 (Ë*
ôî©‹
);

5400  -
EFSCORRUPTED
;

5402 i‡(
SHIFT
 =
SHIFT_LEFT
 && *
ôî©‹
 >

5403 
	`À32_to_˝u
(
exã¡
->
ì_block
)) {

5405 i‡(
exã¡
 < 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

5406 
∑th
[
dïth
].
p_ext
++;

5408 *
ôî©‹
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

5413 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5414 
exã¡
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5415 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5416 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5418 
exã¡
 = 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5419 i‡(
	`À32_to_˝u
(
exã¡
->
ì_block
) > 0)

5420 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) - 1;

5423 
ôî©‹
 = 
NULL
;

5425 
	`À32_to_˝u
(
exã¡
->
ì_block
Ë< 
°¨t
)

5426 
exã¡
++;

5427 
∑th
[
dïth
].
p_ext
 = 
exã¡
;

5429 
ªt
 = 
	`pxt4_ext_shi·_∑th_exã¡s
(
∑th
, 
shi·
, 
öode
,

5430 
h™dÀ
, 
SHIFT
);

5431 i‡(
ªt
)

5434 
out
:

5435 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5436 
	`k‰ì
(
∑th
);

5437  
ªt
;

5438 
	}
}

5445 
	$pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5447 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5448 
pxt4_lblk_t
 
punch_°¨t
, 
punch_°›
;

5449 
h™dÀ_t
 *
h™dÀ
;

5450 
¸edôs
;

5451 
loff_t
 
√w_size
, 
ioff£t
;

5452 
ªt
;

5459 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5460  -
EOPNOTSUPP
;

5463 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5464 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5465  -
EINVAL
;

5467 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5468  -
EINVAL
;

5470 
	`åa˚_pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

5472 
punch_°¨t
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5473 
punch_°›
 = (
off£t
 + 
Àn
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5476 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5477 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5478 i‡(
ªt
)

5479  
ªt
;

5482 
	`öode_lock
(
öode
);

5487 i‡(
off£t
 + 
Àn
 >
	`i_size_ªad
(
öode
)) {

5488 
ªt
 = -
EINVAL
;

5489 
out_muãx
;

5493 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5494 
ªt
 = -
EOPNOTSUPP
;

5495 
out_muãx
;

5499 
	`öode_dio_waô
(
öode
);

5505 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5507 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5508 i‡(
ªt
)

5509 
out_mm≠
;

5515 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5520 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
, 
off£t
);

5521 i‡(
ªt
)

5522 
out_mm≠
;

5528 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
off£t
 + 
Àn
,

5529 
LLONG_MAX
);

5530 i‡(
ªt
)

5531 
out_mm≠
;

5532 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5534 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5535 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5536 i‡(
	`IS_ERR
(
h™dÀ
)) {

5537 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5538 
out_mm≠
;

5541 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5542 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5544 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
punch_°¨t
,

5545 
EXT_MAX_BLOCKS
 - 
punch_°¨t
);

5546 i‡(
ªt
) {

5547 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5548 
out_°›
;

5551 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
punch_°¨t
, 
punch_°›
 - 1);

5552 i‡(
ªt
) {

5553 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5554 
out_°›
;

5556 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5558 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
, 
punch_°›
,

5559 
punch_°›
 - 
punch_°¨t
, 
SHIFT_LEFT
);

5560 i‡(
ªt
) {

5561 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5562 
out_°›
;

5565 
√w_size
 = 
	`i_size_ªad
(
öode
Ë- 
Àn
;

5566 
	`i_size_wrôe
(
öode
, 
√w_size
);

5567 
	`PXT4_I
(
öode
)->
i_disksize
 = 
√w_size
;

5569 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5570 i‡(
	`IS_SYNC
(
öode
))

5571 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5572 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5573 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5574 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5576 
out_°›
:

5577 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5578 
out_mm≠
:

5579 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5580 
out_muãx
:

5581 
	`öode_u∆ock
(
öode
);

5582  
ªt
;

5583 
	}
}

5593 
	$pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5595 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5596 
h™dÀ_t
 *
h™dÀ
;

5597 
pxt4_ext_∑th
 *
∑th
;

5598 
pxt4_exã¡
 *
exã¡
;

5599 
pxt4_lblk_t
 
off£t_lblk
, 
Àn_lblk
, 
ì_°¨t_lblk
 = 0;

5600 
¸edôs
, 
ì_Àn
;

5601 
ªt
 = 0, 
dïth
, 
•lô_Êag
 = 0;

5602 
loff_t
 
ioff£t
;

5609 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5610  -
EOPNOTSUPP
;

5613 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5614 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5615  -
EINVAL
;

5617 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5618  -
EOPNOTSUPP
;

5620 
	`åa˚_pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

5622 
off£t_lblk
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5623 
Àn_lblk
 = 
Àn
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5626 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5627 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5628 i‡(
ªt
)

5629  
ªt
;

5632 
	`öode_lock
(
öode
);

5634 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5635 
ªt
 = -
EOPNOTSUPP
;

5636 
out_muãx
;

5640 i‡(
öode
->
i_size
 + 
Àn
 > inode->
i_sb
->
s_maxbyãs
) {

5641 
ªt
 = -
EFBIG
;

5642 
out_muãx
;

5646 i‡(
off£t
 >
	`i_size_ªad
(
öode
)) {

5647 
ªt
 = -
EINVAL
;

5648 
out_muãx
;

5652 
	`öode_dio_waô
(
öode
);

5658 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5660 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5661 i‡(
ªt
)

5662 
out_mm≠
;

5668 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5670 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
,

5671 
LLONG_MAX
);

5672 i‡(
ªt
)

5673 
out_mm≠
;

5674 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5676 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5677 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5678 i‡(
	`IS_ERR
(
h™dÀ
)) {

5679 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5680 
out_mm≠
;

5684 
öode
->
i_size
 +
Àn
;

5685 
	`PXT4_I
(
öode
)->
i_disksize
 +
Àn
;

5686 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5687 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5688 i‡(
ªt
)

5689 
out_°›
;

5691 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5692 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5694 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
off£t_lblk
, 
NULL
, 0);

5695 i‡(
	`IS_ERR
(
∑th
)) {

5696 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5697 
out_°›
;

5700 
dïth
 = 
	`ext_dïth
(
öode
);

5701 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5702 i‡(
exã¡
) {

5703 
ì_°¨t_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5704 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5710 i‡((
off£t_lblk
 > 
ì_°¨t_lblk
) &&

5711 (
off£t_lblk
 < (
ì_°¨t_lblk
 + 
ì_Àn
))) {

5712 i‡(
	`pxt4_ext_is_unwrôãn
(
exã¡
))

5713 
•lô_Êag
 = 
PXT4_EXT_MARK_UNWRIT1
 |

5714 
PXT4_EXT_MARK_UNWRIT2
;

5715 
ªt
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

5716 
off£t_lblk
, 
•lô_Êag
,

5717 
PXT4_EX_NOCACHE
 |

5718 
PXT4_GET_BLOCKS_PRE_IO
 |

5719 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

5722 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5723 
	`k‰ì
(
∑th
);

5724 i‡(
ªt
 < 0) {

5725 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5726 
out_°›
;

5729 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5730 
	`k‰ì
(
∑th
);

5733 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
off£t_lblk
,

5734 
EXT_MAX_BLOCKS
 - 
off£t_lblk
);

5735 i‡(
ªt
) {

5736 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5737 
out_°›
;

5744 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
,

5745 
ì_°¨t_lblk
 > 
off£t_lblk
 ?Ée_start_lblk : offset_lblk,

5746 
Àn_lblk
, 
SHIFT_RIGHT
);

5748 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5749 i‡(
	`IS_SYNC
(
öode
))

5750 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5751 i‡(
ªt
 >= 0)

5752 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5754 
out_°›
:

5755 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5756 
out_mm≠
:

5757 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5758 
out_muãx
:

5759 
	`öode_u∆ock
(
öode
);

5760  
ªt
;

5761 
	}
}

5784 
	$pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

5785 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,Öxt4_lblk_à
lblk2
,

5786 
pxt4_lblk_t
 
cou¡
, 
unwrôãn
, *
îp
)

5788 
pxt4_ext_∑th
 *
∑th1
 = 
NULL
;

5789 
pxt4_ext_∑th
 *
∑th2
 = 
NULL
;

5790 
ª∂a˚d_cou¡
 = 0;

5792 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode1
)->
i_d©a_£m
));

5793 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode2
)->
i_d©a_£m
));

5794 
	`BUG_ON
(!
	`öode_is_locked
(
öode1
));

5795 
	`BUG_ON
(!
	`öode_is_locked
(
öode2
));

5797 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode1
, 
lblk1
, 
cou¡
);

5798 i‡(
	`u∆ikñy
(*
îp
))

5800 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode2
, 
lblk2
, 
cou¡
);

5801 i‡(
	`u∆ikñy
(*
îp
))

5804 
cou¡
) {

5805 
pxt4_exã¡
 *
ex1
, *
ex2
, 
tmp_ex
;

5806 
pxt4_lblk_t
 
e1_blk
, 
e2_blk
;

5807 
e1_Àn
, 
e2_Àn
, 
Àn
;

5808 
•lô
 = 0;

5810 
∑th1
 = 
	`pxt4_föd_exã¡
(
öode1
, 
lblk1
, 
NULL
, 
PXT4_EX_NOCACHE
);

5811 i‡(
	`IS_ERR
(
∑th1
)) {

5812 *
îp
 = 
	`PTR_ERR
(
∑th1
);

5813 
∑th1
 = 
NULL
;

5814 
föish
:

5815 
cou¡
 = 0;

5816 
ª≥©
;

5818 
∑th2
 = 
	`pxt4_föd_exã¡
(
öode2
, 
lblk2
, 
NULL
, 
PXT4_EX_NOCACHE
);

5819 i‡(
	`IS_ERR
(
∑th2
)) {

5820 *
îp
 = 
	`PTR_ERR
(
∑th2
);

5821 
∑th2
 = 
NULL
;

5822 
föish
;

5824 
ex1
 = 
∑th1
[∑th1->
p_dïth
].
p_ext
;

5825 
ex2
 = 
∑th2
[∑th2->
p_dïth
].
p_ext
;

5827 i‡(
	`u∆ikñy
(!
ex2
 || !
ex1
))

5828 
föish
;

5830 
e1_blk
 = 
	`À32_to_˝u
(
ex1
->
ì_block
);

5831 
e2_blk
 = 
	`À32_to_˝u
(
ex2
->
ì_block
);

5832 
e1_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

5833 
e2_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

5836 i‡(!
	`ö_ønge
(
lblk1
, 
e1_blk
, 
e1_Àn
) ||

5837 !
	`ö_ønge
(
lblk2
, 
e2_blk
, 
e2_Àn
)) {

5838 
pxt4_lblk_t
 
√xt1
, 
≈xt2
;

5841 
√xt1
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th1
);

5842 
≈xt2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th2
);

5844 i‡(
e1_blk
 > 
lblk1
)

5845 
√xt1
 = 
e1_blk
;

5846 i‡(
e2_blk
 > 
lblk2
)

5847 
≈xt2
 = 
e2_blk
;

5849 i‡(
√xt1
 =
EXT_MAX_BLOCKS
 || 
≈xt2
 == EXT_MAX_BLOCKS)

5850 
föish
;

5852 
Àn
 = 
√xt1
 - 
lblk1
;

5853 i‡(
Àn
 < 
≈xt2
 - 
lblk2
)

5854 
Àn
 = 
≈xt2
 - 
lblk2
;

5855 i‡(
Àn
 > 
cou¡
)

5856 
Àn
 = 
cou¡
;

5857 
lblk1
 +
Àn
;

5858 
lblk2
 +
Àn
;

5859 
cou¡
 -
Àn
;

5860 
ª≥©
;

5864 i‡(
e1_blk
 < 
lblk1
) {

5865 
•lô
 = 1;

5866 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5867 &
∑th1
, 
lblk1
, 0);

5868 i‡(
	`u∆ikñy
(*
îp
))

5869 
föish
;

5871 i‡(
e2_blk
 < 
lblk2
) {

5872 
•lô
 = 1;

5873 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5874 &
∑th2
, 
lblk2
, 0);

5875 i‡(
	`u∆ikñy
(*
îp
))

5876 
föish
;

5880 i‡(
•lô
)

5881 
ª≥©
;

5884 
Àn
 = 
cou¡
;

5885 i‡(
Àn
 > 
e1_blk
 + 
e1_Àn
 - 
lblk1
)

5886 
Àn
 = 
e1_blk
 + 
e1_Àn
 - 
lblk1
;

5887 i‡(
Àn
 > 
e2_blk
 + 
e2_Àn
 - 
lblk2
)

5888 
Àn
 = 
e2_blk
 + 
e2_Àn
 - 
lblk2
;

5890 i‡(
Àn
 !
e1_Àn
) {

5891 
•lô
 = 1;

5892 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5893 &
∑th1
, 
lblk1
 + 
Àn
, 0);

5894 i‡(
	`u∆ikñy
(*
îp
))

5895 
föish
;

5897 i‡(
Àn
 !
e2_Àn
) {

5898 
•lô
 = 1;

5899 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5900 &
∑th2
, 
lblk2
 + 
Àn
, 0);

5901 i‡(*
îp
)

5902 
föish
;

5906 i‡(
•lô
)

5907 
ª≥©
;

5909 
	`BUG_ON
(
e2_Àn
 !
e1_Àn
);

5910 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode1
, 
∑th1
 +Ö©h1->
p_dïth
);

5911 i‡(
	`u∆ikñy
(*
îp
))

5912 
föish
;

5913 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode2
, 
∑th2
 +Ö©h2->
p_dïth
);

5914 i‡(
	`u∆ikñy
(*
îp
))

5915 
föish
;

5918 
tmp_ex
 = *
ex1
;

5919 
	`pxt4_ext_°‹e_pblock
(
ex1
, 
	`pxt4_ext_pblock
(
ex2
));

5920 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
	`pxt4_ext_pblock
(&
tmp_ex
));

5921 
ex1
->
ì_Àn
 = 
	`˝u_to_À16
(
e2_Àn
);

5922 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
(
e1_Àn
);

5923 i‡(
unwrôãn
)

5924 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

5925 i‡(
	`pxt4_ext_is_unwrôãn
(&
tmp_ex
))

5926 
	`pxt4_ext_m¨k_unwrôãn
(
ex1
);

5928 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode2
, 
∑th2
, 
ex2
);

5929 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode1
, 
∑th1
, 
ex1
);

5930 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode2
, 
∑th2
 +

5931 
∑th2
->
p_dïth
);

5932 i‡(
	`u∆ikñy
(*
îp
))

5933 
föish
;

5934 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode1
, 
∑th1
 +

5935 
∑th1
->
p_dïth
);

5942 i‡(
	`u∆ikñy
(*
îp
))

5943 
föish
;

5944 
lblk1
 +
Àn
;

5945 
lblk2
 +
Àn
;

5946 
ª∂a˚d_cou¡
 +
Àn
;

5947 
cou¡
 -
Àn
;

5949 
ª≥©
:

5950 
	`pxt4_ext_dr›_ªfs
(
∑th1
);

5951 
	`k‰ì
(
∑th1
);

5952 
	`pxt4_ext_dr›_ªfs
(
∑th2
);

5953 
	`k‰ì
(
∑th2
);

5954 
∑th1
 = 
∑th2
 = 
NULL
;

5956  
ª∂a˚d_cou¡
;

5957 
	}
}

5971 
	$pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
)

5973 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5974 
pxt4_ext_∑th
 *
∑th
;

5975 
dïth
, 
m≠≥d
 = 0, 
îr
 = 0;

5976 
pxt4_exã¡
 *
exã¡
;

5977 
pxt4_lblk_t
 
fú°_lblk
, 
fú°_l˛u
, 
œ°_l˛u
;

5980 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
	`PXT4_C2B
(
sbi
, 
l˛u
), 
NULL
, 0);

5981 i‡(
	`IS_ERR
(
∑th
)) {

5982 
îr
 = 
	`PTR_ERR
(
∑th
);

5983 
∑th
 = 
NULL
;

5984 
out
;

5987 
dïth
 = 
	`ext_dïth
(
öode
);

5994 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

5995 
	`PXT4_ERROR_INODE
(
öode
,

5997 (Ë
	`PXT4_C2B
(
sbi
, 
l˛u
),

5998 
dïth
, 
∑th
[dïth].
p_block
);

5999 
îr
 = -
EFSCORRUPTED
;

6000 
out
;

6003 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

6006 i‡(
exã¡
 =
NULL
)

6007 
out
;

6009 
fú°_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

6010 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6018 i‡(
l˛u
 >
fú°_l˛u
) {

6019 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
 +

6020 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
) - 1);

6021 i‡(
l˛u
 <
œ°_l˛u
) {

6022 
m≠≥d
 = 1;

6024 
fú°_lblk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

6025 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6026 i‡(
l˛u
 =
fú°_l˛u
)

6027 
m≠≥d
 = 1;

6031 
out
:

6032 
	`pxt4_ext_dr›_ªfs
(
∑th
);

6033 
	`k‰ì
(
∑th
);

6035  
îr
 ?Éº : 
m≠≥d
;

6036 
	}
}

	@extents_status.c

13 
	~<löux/li°_s‹t.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/£q_fûe.h
>

16 
	~"pxt4.h
"

18 
	~<åa˚/evíts/pxt4.h
>

144 
kmem_ˇche
 *
	gpxt4_es_ˇchï
;

145 
kmem_ˇche
 *
	gpxt4_≥ndög_ˇchï
;

147 
__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
);

148 
__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

149 
pxt4_lblk_t
 
íd
, *
ª£rved
);

150 
es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
);

151 
__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

152 
pxt4_öode_öfo
 *
locked_ei
);

153 
__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

154 
pxt4_lblk_t
 
Àn
);

156 
__öô
 
	$pxt4_öô_es
()

158 
pxt4_es_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_extent_status",

159 (
exã¡_°©us
),

160 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

161 i‡(
pxt4_es_ˇchï
 =
NULL
)

162  -
ENOMEM
;

164 
	}
}

166 
	$pxt4_exô_es
()

168 
	`kmem_ˇche_de°roy
(
pxt4_es_ˇchï
);

169 
	}
}

171 
	$pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
)

173 
åì
->
roŸ
 = 
RB_ROOT
;

174 
åì
->
ˇche_es
 = 
NULL
;

175 
	}
}

177 #ifde‡
ES_DEBUG__


178 
	$pxt4_es_¥öt_åì
(
öode
 *inode)

180 
pxt4_es_åì
 *
åì
;

181 
rb_node
 *
node
;

183 
	`¥ötk
(
KERN_DEBUG
 "°©u†exã¡†f‹ inodê%lu:", 
öode
->
i_öo
);

184 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

185 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

186 
node
) {

187 
exã¡_°©us
 *
es
;

188 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

189 
	`¥ötk
(
KERN_DEBUG
 " [%u/%u) %llu %x",

190 
es
->
es_lblk
,És->
es_Àn
,

191 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

192 
node
 = 
	`rb_√xt
(node);

194 
	`¥ötk
(
KERN_DEBUG
 "\n");

195 
	}
}

197 
	#pxt4_es_¥öt_åì
(
öode
)

	)

200 
ölöe
 
pxt4_lblk_t
 
	$pxt4_es_íd
(
exã¡_°©us
 *
es
)

202 
	`BUG_ON
(
es
->
es_lblk
 +És->
es_Àn
 <És->es_lblk);

203  
es
->
es_lblk
 +És->
es_Àn
 - 1;

204 
	}
}

210 
exã¡_°©us
 *
	$__es_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

211 
pxt4_lblk_t
 
lblk
)

213 
rb_node
 *
node
 = 
roŸ
->rb_node;

214 
exã¡_°©us
 *
es
 = 
NULL
;

216 
node
) {

217 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

218 i‡(
lblk
 < 
es
->
es_lblk
)

219 
node
 =Çode->
rb_À·
;

220 i‡(
lblk
 > 
	`pxt4_es_íd
(
es
))

221 
node
 =Çode->
rb_right
;

223  
es
;

226 i‡(
es
 && 
lblk
 <És->
es_lblk
)

227  
es
;

229 i‡(
es
 && 
lblk
 > 
	`pxt4_es_íd
(es)) {

230 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

231  
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
, 
rb_node
) :

232 
NULL
;

235  
NULL
;

236 
	}
}

256 
	$__es_föd_exã¡_ønge
(
öode
 *inode,

257 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

258 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

259 
exã¡_°©us
 *
es
)

261 
pxt4_es_åì
 *
åì
 = 
NULL
;

262 
exã¡_°©us
 *
es1
 = 
NULL
;

263 
rb_node
 *
node
;

265 
	`WARN_ON
(
es
 =
NULL
);

266 
	`WARN_ON
(
íd
 < 
lblk
);

268 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

271 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

272 i‡(
åì
->
ˇche_es
) {

273 
es1
 = 
åì
->
ˇche_es
;

274 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

275 
	`es_debug
("%u cached by [%u/%u) %llu %x\n",

276 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
,

277 
	`pxt4_es_pblock
(
es1
), 
	`pxt4_es_°©us
(es1));

278 
out
;

282 
es1
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

284 
out
:

285 i‡(
es1
 && !
	`m©chög_‚
(es1)) {

286 (
node
 = 
	`rb_√xt
(&
es1
->
rb_node
)Ë!
NULL
) {

287 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

288 i‡(
es1
->
es_lblk
 > 
íd
) {

289 
es1
 = 
NULL
;

292 i‡(
	`m©chög_‚
(
es1
))

297 i‡(
es1
 && 
	`m©chög_‚
(es1)) {

298 
åì
->
ˇche_es
 = 
es1
;

299 
es
->
es_lblk
 = 
es1
->es_lblk;

300 
es
->
es_Àn
 = 
es1
->es_len;

301 
es
->
es_pblk
 = 
es1
->es_pblk;

304 
	}
}

309 
	$pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

310 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

311 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

312 
exã¡_°©us
 *
es
)

314 
	`åa˚_pxt4_es_föd_exã¡_ønge_íãr
(
öode
, 
lblk
);

316 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

317 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
, 
es
);

318 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

320 
	`åa˚_pxt4_es_föd_exã¡_ønge_exô
(
öode
, 
es
);

321 
	}
}

338 
boﬁ
 
	$__es_sˇn_ønge
(
öode
 *inode,

339 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

340 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

342 
exã¡_°©us
 
es
;

344 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
°¨t
, 
íd
, &
es
);

345 i‡(
es
.
es_Àn
 == 0)

346  
Ál£
;

347 i‡(
es
.
es_lblk
 <
°¨t
 &&

348 
°¨t
 < 
es
.
es_lblk
 +És.
es_Àn
)

349  
åue
;

350 i‡(
°¨t
 <
es
.
es_lblk
 &&És.es_lblk <
íd
)

351  
åue
;

353  
Ál£
;

354 
	}
}

358 
boﬁ
 
	$pxt4_es_sˇn_ønge
(
öode
 *inode,

359 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

360 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
)

362 
boﬁ
 
ªt
;

364 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

365 
ªt
 = 
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
);

366 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

368  
ªt
;

369 
	}
}

385 
boﬁ
 
	$__es_sˇn_˛u
(
öode
 *inode,

386 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

387 
pxt4_lblk_t
 
lblk
)

389 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

390 
pxt4_lblk_t
 
lblk_°¨t
, 
lblk_íd
;

392 
lblk_°¨t
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

393 
lblk_íd
 = 
lblk_°¨t
 + 
sbi
->
s_˛u°î_øtio
 - 1;

395  
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk_°¨t
, 
lblk_íd
);

396 
	}
}

401 
boﬁ
 
	$pxt4_es_sˇn_˛u
(
öode
 *inode,

402 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

403 
pxt4_lblk_t
 
lblk
)

405 
boﬁ
 
ªt
;

407 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

408 
ªt
 = 
	`__es_sˇn_˛u
(
öode
, 
m©chög_‚
, 
lblk
);

409 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

411  
ªt
;

412 
	}
}

414 
	$pxt4_es_li°_add
(
öode
 *inode)

416 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

417 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

419 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
))

422 
	`•ö_lock
(&
sbi
->
s_es_lock
);

423 i‡(
	`li°_em±y
(&
ei
->
i_es_li°
)) {

424 
	`li°_add_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

425 
sbi
->
s_es_ƒ_öode
++;

427 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

428 
	}
}

430 
	$pxt4_es_li°_dñ
(
öode
 *inode)

432 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

433 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

435 
	`•ö_lock
(&
sbi
->
s_es_lock
);

436 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
)) {

437 
	`li°_dñ_öô
(&
ei
->
i_es_li°
);

438 
sbi
->
s_es_ƒ_öode
--;

439 
	`WARN_ON_ONCE
(
sbi
->
s_es_ƒ_öode
 < 0);

441 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

442 
	}
}

444 
exã¡_°©us
 *

445 
	$pxt4_es_Æloc_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
Àn
,

446 
pxt4_fsblk_t
 
pblk
)

448 
exã¡_°©us
 *
es
;

449 
es
 = 
	`kmem_ˇche_Æloc
(
pxt4_es_ˇchï
, 
GFP_ATOMIC
);

450 i‡(
es
 =
NULL
)

451  
NULL
;

452 
es
->
es_lblk
 = 
lblk
;

453 
es
->
es_Àn
 = 
Àn
;

454 
es
->
es_pblk
 = 
pblk
;

459 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

460 i‡(!
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
++)

461 
	`pxt4_es_li°_add
(
öode
);

462 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->

463 
s_es_°©s
.
es_°©s_shk_˙t
);

466 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
++;

467 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

469  
es
;

470 
	}
}

472 
	$pxt4_es_‰ì_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
es
)

474 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
--;

475 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

478 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

479 
	`BUG_ON
(
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
 == 0);

480 i‡(!--
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
)

481 
	`pxt4_es_li°_dñ
(
öode
);

482 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->

483 
s_es_°©s
.
es_°©s_shk_˙t
);

486 
	`kmem_ˇche_‰ì
(
pxt4_es_ˇchï
, 
es
);

487 
	}
}

496 
	$pxt4_es_ˇn_be_mîged
(
exã¡_°©us
 *
es1
,

497 
exã¡_°©us
 *
es2
)

499 i‡(
	`pxt4_es_ty≥
(
es1
Ë!pxt4_es_ty≥(
es2
))

502 i‡(((
__u64
Ë
es1
->
es_Àn
Ë+ 
es2
->es_À¿> 
EXT_MAX_BLOCKS
) {

503 
	`¥_w¨n
("ESássertion failed when mergingÉxtents. "

506 
es1
->
es_Àn
, 
es2
->es_Àn, 
EXT_MAX_BLOCKS
);

507 
	`WARN_ON
(1);

511 i‡(((
__u64
Ë
es1
->
es_lblk
Ë+És1->
es_Àn
 !
es2
->es_lblk)

514 i‡((
	`pxt4_es_is_wrôãn
(
es1
Ë|| 
	`pxt4_es_is_unwrôãn
(es1)) &&

515 (
	`pxt4_es_pblock
(
es1
Ë+És1->
es_Àn
 =pxt4_es_pblock(
es2
)))

518 i‡(
	`pxt4_es_is_hﬁe
(
es1
))

522 i‡(
	`pxt4_es_is_dñayed
(
es1
Ë&& !
	`pxt4_es_is_unwrôãn
(es1))

526 
	}
}

528 
exã¡_°©us
 *

529 
	$pxt4_es_åy_to_mîge_À·
(
öode
 *öode, 
exã¡_°©us
 *
es
)

531 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

532 
exã¡_°©us
 *
es1
;

533 
rb_node
 *
node
;

535 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

536 i‡(!
node
)

537  
es
;

539 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

540 i‡(
	`pxt4_es_ˇn_be_mîged
(
es1
, 
es
)) {

541 
es1
->
es_Àn
 +
es
->es_len;

542 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
))

543 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

544 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

545 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

546 
es
 = 
es1
;

549  
es
;

550 
	}
}

552 
exã¡_°©us
 *

553 
	$pxt4_es_åy_to_mîge_right
(
öode
 *öode, 
exã¡_°©us
 *
es
)

555 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

556 
exã¡_°©us
 *
es1
;

557 
rb_node
 *
node
;

559 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

560 i‡(!
node
)

561  
es
;

563 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

564 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
es1
)) {

565 
es
->
es_Àn
 +
es1
->es_len;

566 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es1
))

567 
	`pxt4_es_£t_ª„ªn˚d
(
es
);

568 
	`rb_îa£
(
node
, &
åì
->
roŸ
);

569 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es1
);

572  
es
;

573 
	}
}

575 #ifde‡
ES_AGGRESSIVE_TEST


576 
	~"pxt4_exã¡s.h
"

578 
	$pxt4_es_ö£π_exã¡_ext_check
(
öode
 *inode,

579 
exã¡_°©us
 *
es
)

581 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

582 
pxt4_exã¡
 *
ex
;

583 
pxt4_lblk_t
 
ì_block
;

584 
pxt4_fsblk_t
 
ì_°¨t
;

585 
ì_Àn
;

586 
dïth
, 
ì_°©us
, 
es_°©us
;

588 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
es
->
es_lblk
, 
NULL
, 
PXT4_EX_NOCACHE
);

589 i‡(
	`IS_ERR
(
∑th
))

592 
dïth
 = 
	`ext_dïth
(
öode
);

593 
ex
 = 
∑th
[
dïth
].
p_ext
;

595 i‡(
ex
) {

597 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

598 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

599 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

601 
ì_°©us
 = 
	`pxt4_ext_is_unwrôãn
(
ex
) ? 1 : 0;

602 
es_°©us
 = 
	`pxt4_es_is_unwrôãn
(
es
) ? 1 : 0;

608 i‡(!
	`pxt4_es_is_wrôãn
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es)) {

609 i‡(
	`ö_ønge
(
es
->
es_lblk
, 
ì_block
, 
ì_Àn
)) {

610 
	`¥_w¨n
("ES insertássertion failed for "

615 
öode
->
i_öo
, 
ì_block
, 
ì_Àn
,

616 
ì_°¨t
, 
ì_°©us
 ? 'u' : 'w',

617 
es
->
es_lblk
,És->
es_Àn
,

618 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

620 
out
;

627 i‡(
es
->
es_lblk
 < 
ì_block
 ||

628 
	`pxt4_es_pblock
(
es
Ë!
ì_°¨t
 +És->
es_lblk
 - 
ì_block
) {

629 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

631 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

632 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

633 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

634 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

635 
out
;

638 i‡(
ì_°©us
 ^ 
es_°©us
) {

639 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

641 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

642 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

643 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

644 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

651 i‡(!
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_hﬁe
(es)) {

652 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

655 "[%d/%d/%Œu/%x]\n", 
öode
->
i_öo
,

656 
es
->
es_lblk
,És->es_lblk,És->
es_Àn
,

657 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

660 
out
:

661 
	`pxt4_ext_dr›_ªfs
(
∑th
);

662 
	`k‰ì
(
∑th
);

663 
	}
}

665 
	$pxt4_es_ö£π_exã¡_öd_check
(
öode
 *inode,

666 
exã¡_°©us
 *
es
)

668 
pxt4_m≠_blocks
 
m≠
;

669 
ªtvÆ
;

678 
m≠
.
m_lblk
 = 
es
->
es_lblk
;

679 
m≠
.
m_Àn
 = 
es
->
es_Àn
;

681 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

682 i‡(
ªtvÆ
 > 0) {

683 i‡(
	`pxt4_es_is_dñayed
(
es
Ë|| 
	`pxt4_es_is_hﬁe
(es)) {

688 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

691 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

692 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

694 } i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

695 i‡(
ªtvÆ
 !
es
->
es_Àn
) {

696 
	`¥_w¨n
("ES insertássertion failed for "

698 
öode
->
i_öo
, 
ªtvÆ
, 
es
->
es_Àn
);

701 i‡(
m≠
.
m_pblk
 !
	`pxt4_es_pblock
(
es
)) {

702 
	`¥_w¨n
("ES insertássertion failed for "

705 
öode
->
i_öo
, 
m≠
.
m_pblk
,

706 
	`pxt4_es_pblock
(
es
));

714 
	`BUG
();

716 } i‡(
ªtvÆ
 == 0) {

717 i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

718 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

721 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

722 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

726 
	}
}

728 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

729 
exã¡_°©us
 *
es
)

735 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

736 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

737 
	`pxt4_es_ö£π_exã¡_ext_check
(
öode
, 
es
);

739 
	`pxt4_es_ö£π_exã¡_öd_check
(
öode
, 
es
);

740 
	}
}

742 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

743 
exã¡_°©us
 *
es
)

745 
	}
}

748 
	$__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
)

750 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

751 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

752 
rb_node
 *
∑ª¡
 = 
NULL
;

753 
exã¡_°©us
 *
es
;

755 *
p
) {

756 
∑ª¡
 = *
p
;

757 
es
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_°©us
, 
rb_node
);

759 i‡(
√wes
->
es_lblk
 < 
es
->es_lblk) {

760 i‡(
	`pxt4_es_ˇn_be_mîged
(
√wes
, 
es
)) {

765 
es
->
es_lblk
 = 
√wes
->es_lblk;

766 
es
->
es_Àn
 +
√wes
->es_len;

767 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

768 
	`pxt4_es_is_unwrôãn
(
es
))

769 
	`pxt4_es_°‹e_pblock
(
es
,

770 
√wes
->
es_pblk
);

771 
es
 = 
	`pxt4_es_åy_to_mîge_À·
(
öode
,És);

772 
out
;

774 
p
 = &(*p)->
rb_À·
;

775 } i‡(
√wes
->
es_lblk
 > 
	`pxt4_es_íd
(
es
)) {

776 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
√wes
)) {

777 
es
->
es_Àn
 +
√wes
->es_len;

778 
es
 = 
	`pxt4_es_åy_to_mîge_right
(
öode
,És);

779 
out
;

781 
p
 = &(*p)->
rb_right
;

783 
	`BUG
();

784  -
EINVAL
;

788 
es
 = 
	`pxt4_es_Æloc_exã¡
(
öode
, 
√wes
->
es_lblk
,Çewes->
es_Àn
,

789 
√wes
->
es_pblk
);

790 i‡(!
es
)

791  -
ENOMEM
;

792 
	`rb_lök_node
(&
es
->
rb_node
, 
∑ª¡
, 
p
);

793 
	`rb_ö£π_cﬁ‹
(&
es
->
rb_node
, &
åì
->
roŸ
);

795 
out
:

796 
åì
->
ˇche_es
 = 
es
;

798 
	}
}

806 
	$pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

807 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

808 
°©us
)

810 
exã¡_°©us
 
√wes
;

811 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

812 
îr
 = 0;

813 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

815 
	`es_debug
("add [%u/%u) %llu %xÅoÉxtent statusÅree of inode %lu\n",

816 
lblk
, 
Àn
, 
pblk
, 
°©us
, 
öode
->
i_öo
);

818 i‡(!
Àn
)

821 
	`BUG_ON
(
íd
 < 
lblk
);

823 i‡((
°©us
 & 
EXTENT_STATUS_DELAYED
) &&

824 (
°©us
 & 
EXTENT_STATUS_WRITTEN
)) {

825 
	`pxt4_w¨nög
(
öode
->
i_sb
, "InsertingÉxtent [%u/%u]ás "

827 " cau£ d©®loss.", 
lblk
, 
Àn
);

828 
	`WARN_ON
(1);

831 
√wes
.
es_lblk
 = 
lblk
;

832 
√wes
.
es_Àn
 = 
Àn
;

833 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

834 
	`åa˚_pxt4_es_ö£π_exã¡
(
öode
, &
√wes
);

836 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

838 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

839 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, 
NULL
);

840 i‡(
îr
 != 0)

841 
îr‹
;

842 
ªåy
:

843 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

844 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

845 128, 
	`PXT4_I
(
öode
)))

846 
ªåy
;

847 i‡(
îr
 =-
ENOMEM
 && !
	`pxt4_es_is_dñayed
(&
√wes
))

848 
îr
 = 0;

850 i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

851 (
°©us
 & 
EXTENT_STATUS_WRITTEN
 ||

852 
°©us
 & 
EXTENT_STATUS_UNWRITTEN
))

853 
	`__ªvi£_≥ndög
(
öode
, 
lblk
, 
Àn
);

855 
îr‹
:

856 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

858 
	`pxt4_es_¥öt_åì
(
öode
);

860  
îr
;

861 
	}
}

868 
	$pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

869 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

870 
°©us
)

872 
exã¡_°©us
 *
es
;

873 
exã¡_°©us
 
√wes
;

874 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

876 
√wes
.
es_lblk
 = 
lblk
;

877 
√wes
.
es_Àn
 = 
Àn
;

878 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

879 
	`åa˚_pxt4_es_ˇche_exã¡
(
öode
, &
√wes
);

881 i‡(!
Àn
)

884 
	`BUG_ON
(
íd
 < 
lblk
);

886 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

888 
es
 = 
	`__es_åì_£¨ch
(&
	`PXT4_I
(
öode
)->
i_es_åì
.
roŸ
, 
lblk
);

889 i‡(!
es
 ||És->
es_lblk
 > 
íd
)

890 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

891 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

892 
	}
}

901 
	$pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

902 
pxt4_lblk_t
 *
√xt_lblk
,

903 
exã¡_°©us
 *
es
)

905 
pxt4_es_åì
 *
åì
;

906 
pxt4_es_°©s
 *
°©s
;

907 
exã¡_°©us
 *
es1
 = 
NULL
;

908 
rb_node
 *
node
;

909 
found
 = 0;

911 
	`åa˚_pxt4_es_lookup_exã¡_íãr
(
öode
, 
lblk
);

912 
	`es_debug
("looku∞exã¡ i¿block %u\n", 
lblk
);

914 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

915 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

918 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

919 i‡(
åì
->
ˇche_es
) {

920 
es1
 = 
åì
->
ˇche_es
;

921 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

922 
	`es_debug
("%u cached by [%u/%u)\n",

923 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
);

924 
found
 = 1;

925 
out
;

929 
node
 = 
åì
->
roŸ
.
rb_node
;

930 
node
) {

931 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

932 i‡(
lblk
 < 
es1
->
es_lblk
)

933 
node
 =Çode->
rb_À·
;

934 i‡(
lblk
 > 
	`pxt4_es_íd
(
es1
))

935 
node
 =Çode->
rb_right
;

937 
found
 = 1;

942 
out
:

943 
°©s
 = &
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
;

944 i‡(
found
) {

945 
	`BUG_ON
(!
es1
);

946 
es
->
es_lblk
 = 
es1
->es_lblk;

947 
es
->
es_Àn
 = 
es1
->es_len;

948 
es
->
es_pblk
 = 
es1
->es_pblk;

949 i‡(!
	`pxt4_es_is_ª„ªn˚d
(
es1
))

950 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

951 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_hôs
);

952 i‡(
√xt_lblk
) {

953 
node
 = 
	`rb_√xt
(&
es1
->
rb_node
);

954 i‡(
node
) {

955 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

956 
rb_node
);

957 *
√xt_lblk
 = 
es1
->
es_lblk
;

959 *
√xt_lblk
 = 0;

962 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_mis£s
);

965 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

967 
	`åa˚_pxt4_es_lookup_exã¡_exô
(
öode
, 
es
, 
found
);

968  
found
;

969 
	}
}

971 
	srsvd_cou¡
 {

972 
	mndñ⁄ly
;

973 
boﬁ
 
	mfú°_do_lblk_found
;

974 
pxt4_lblk_t
 
	mfú°_do_lblk
;

975 
pxt4_lblk_t
 
	mœ°_do_lblk
;

976 
exã¡_°©us
 *
	mÀ·_es
;

977 
boﬁ
 
	m∑πül
;

978 
pxt4_lblk_t
 
	ml˛u
;

992 
	$öô_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

993 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

995 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

996 
rb_node
 *
node
;

998 
rc
->
ndñ⁄ly
 = 0;

1006 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1007 
rc
->
fú°_do_lblk_found
 = 
Ál£
;

1008 i‡(
lblk
 > 
es
->
es_lblk
) {

1009 
rc
->
À·_es
 = 
es
;

1011 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1012 
rc
->
À·_es
 = 
node
 ? 
	`rb_íåy
(node,

1013 
exã¡_°©us
,

1014 
rb_node
Ë: 
NULL
;

1016 
rc
->
∑πül
 = 
Ál£
;

1018 
	}
}

1034 
	$cou¡_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
Àn
,

1035 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

1037 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1038 
pxt4_lblk_t
 
i
, 
íd
, 
n˛u
;

1040 i‡(!
	`pxt4_es_is_dñ⁄ly
(
es
))

1043 
	`WARN_ON
(
Àn
 <= 0);

1045 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1046 
rc
->
ndñ⁄ly
 +(Ë
Àn
;

1052 
i
 = (
lblk
 < 
es
->
es_lblk
) ?És->es_lblk :Üblk;

1053 
íd
 = 
lblk
 + (
pxt4_lblk_t
Ë
Àn
 - 1;

1054 
íd
 = (íd > 
	`pxt4_es_íd
(
es
)) ?Öxt4_es_end(es) :Énd;

1057 i‡(
rc
->
fú°_do_lblk_found
 =
Ál£
) {

1058 
rc
->
fú°_do_lblk
 = 
i
;

1059 
rc
->
fú°_do_lblk_found
 = 
åue
;

1063 
rc
->
œ°_do_lblk
 = 
íd
;

1069 i‡(
rc
->
∑πül
 && (rc->
l˛u
 !
	`PXT4_B2C
(
sbi
, 
i
))) {

1070 
rc
->
ndñ⁄ly
++;

1071 
rc
->
∑πül
 = 
Ál£
;

1078 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
i
) != 0) {

1079 i‡(
íd
 >
	`PXT4_LBLK_CFILL
(
sbi
, 
i
)) {

1080 
rc
->
ndñ⁄ly
++;

1081 
rc
->
∑πül
 = 
Ál£
;

1082 
i
 = 
	`PXT4_LBLK_CFILL
(
sbi
, i) + 1;

1090 i‡((
i
 + 
sbi
->
s_˛u°î_øtio
 - 1Ë<
íd
) {

1091 
n˛u
 = (
íd
 - 
i
 + 1Ë>> 
sbi
->
s_˛u°î_bôs
;

1092 
rc
->
ndñ⁄ly
 +
n˛u
;

1093 
i
 +
n˛u
 << 
sbi
->
s_˛u°î_bôs
;

1100 i‡(!
rc
->
∑πül
 && 
i
 <
íd
) {

1101 
rc
->
∑πül
 = 
åue
;

1102 
rc
->
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
i
);

1104 
	}
}

1116 
≥ndög_ª£rv©i⁄
 *
	$__¥_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

1117 
pxt4_lblk_t
 
l˛u
)

1119 
rb_node
 *
node
 = 
roŸ
->rb_node;

1120 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1122 
node
) {

1123 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1124 i‡(
l˛u
 < 
¥
->lclu)

1125 
node
 =Çode->
rb_À·
;

1126 i‡(
l˛u
 > 
¥
->lclu)

1127 
node
 =Çode->
rb_right
;

1129  
¥
;

1131 i‡(
¥
 && 
l˛u
 <Ör->lclu)

1132  
¥
;

1133 i‡(
¥
 && 
l˛u
 >Ör->lclu) {

1134 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1135  
node
 ? 
	`rb_íåy
“ode, 
≥ndög_ª£rv©i⁄
,

1136 
rb_node
Ë: 
NULL
;

1138  
NULL
;

1139 
	}
}

1157 
	$gë_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
íd
,

1158 
exã¡_°©us
 *
right_es
,

1159 
rsvd_cou¡
 *
rc
)

1161 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1162 
≥ndög_ª£rv©i⁄
 *
¥
;

1163 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1164 
rb_node
 *
node
;

1165 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

1166 
boﬁ
 
À·_dñ⁄ly
, 
right_dñ⁄ly
, 
cou¡_≥ndög
;

1167 
exã¡_°©us
 *
es
;

1169 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1171 i‡(
rc
->
∑πül
)

1172 
rc
->
ndñ⁄ly
++;

1174 i‡(
rc
->
ndñ⁄ly
 == 0)

1177 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
fú°_do_lblk
);

1178 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
œ°_do_lblk
);

1185 
À·_dñ⁄ly
 = 
right_dñ⁄ly
 = 
Ál£
;

1187 
es
 = 
rc
->
À·_es
;

1188 
es
 && 
	`pxt4_es_íd
(es) >=

1189 
	`PXT4_LBLK_CMASK
(
sbi
, 
rc
->
fú°_do_lblk
)) {

1190 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1191 
rc
->
ndñ⁄ly
--;

1192 
À·_dñ⁄ly
 = 
åue
;

1195 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1196 i‡(!
node
)

1198 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1200 i‡(
right_es
 && (!
À·_dñ⁄ly
 || 
fú°_l˛u
 !
œ°_l˛u
)) {

1201 i‡(
íd
 < 
	`pxt4_es_íd
(
right_es
)) {

1202 
es
 = 
right_es
;

1204 
node
 = 
	`rb_√xt
(&
right_es
->
rb_node
);

1205 
es
 = 
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
,

1206 
rb_node
Ë: 
NULL
;

1208 
es
 &&És->
es_lblk
 <=

1209 
	`PXT4_LBLK_CFILL
(
sbi
, 
rc
->
œ°_do_lblk
)) {

1210 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1211 
rc
->
ndñ⁄ly
--;

1212 
right_dñ⁄ly
 = 
åue
;

1215 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1216 i‡(!
node
)

1218 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

1219 
rb_node
);

1232 i‡(
fú°_l˛u
 =
œ°_l˛u
) {

1233 i‡(
À·_dñ⁄ly
 | 
right_dñ⁄ly
)

1234 
cou¡_≥ndög
 = 
Ál£
;

1236 
cou¡_≥ndög
 = 
åue
;

1238 i‡(
À·_dñ⁄ly
)

1239 
fú°_l˛u
++;

1240 i‡(
right_dñ⁄ly
)

1241 
œ°_l˛u
--;

1242 i‡(
fú°_l˛u
 <
œ°_l˛u
)

1243 
cou¡_≥ndög
 = 
åue
;

1245 
cou¡_≥ndög
 = 
Ál£
;

1254 i‡(
cou¡_≥ndög
) {

1255 
¥
 = 
	`__¥_åì_£¨ch
(&
åì
->
roŸ
, 
fú°_l˛u
);

1256 
¥
 &&Ör->
l˛u
 <
œ°_l˛u
) {

1257 
rc
->
ndñ⁄ly
--;

1258 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1259 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1260 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1261 i‡(!
node
)

1263 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
,

1264 
rb_node
);

1268  
rc
->
ndñ⁄ly
;

1269 
	}
}

1285 
	$__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1286 
pxt4_lblk_t
 
íd
, *
ª£rved
)

1288 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1289 
rb_node
 *
node
;

1290 
exã¡_°©us
 *
es
;

1291 
exã¡_°©us
 
‹ig_es
;

1292 
pxt4_lblk_t
 
Àn1
, 
Àn2
;

1293 
pxt4_fsblk_t
 
block
;

1294 
îr
;

1295 
boﬁ
 
cou¡_ª£rved
 = 
åue
;

1296 
rsvd_cou¡
 
rc
;

1298 i‡(
ª£rved
 =
NULL
 || !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

1299 
cou¡_ª£rved
 = 
Ál£
;

1300 
ªåy
:

1301 
îr
 = 0;

1303 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

1304 i‡(!
es
)

1305 
out
;

1306 i‡(
es
->
es_lblk
 > 
íd
)

1307 
out
;

1310 
åì
->
ˇche_es
 = 
NULL
;

1311 i‡(
cou¡_ª£rved
)

1312 
	`öô_rsvd
(
öode
, 
lblk
, 
es
, &
rc
);

1314 
‹ig_es
.
es_lblk
 = 
es
->es_lblk;

1315 
‹ig_es
.
es_Àn
 = 
es
->es_len;

1316 
‹ig_es
.
es_pblk
 = 
es
->es_pblk;

1318 
Àn1
 = 
lblk
 > 
es
->
es_lblk
 ?Üblk -És->es_lblk : 0;

1319 
Àn2
 = 
	`pxt4_es_íd
(
es
Ë> 
íd
 ?Öxt4_es_end(es) -Énd : 0;

1320 i‡(
Àn1
 > 0)

1321 
es
->
es_Àn
 = 
Àn1
;

1322 i‡(
Àn2
 > 0) {

1323 i‡(
Àn1
 > 0) {

1324 
exã¡_°©us
 
√wes
;

1326 
√wes
.
es_lblk
 = 
íd
 + 1;

1327 
√wes
.
es_Àn
 = 
Àn2
;

1328 
block
 = 0x7FDEADBEEFULL;

1329 i‡(
	`pxt4_es_is_wrôãn
(&
‹ig_es
) ||

1330 
	`pxt4_es_is_unwrôãn
(&
‹ig_es
))

1331 
block
 = 
	`pxt4_es_pblock
(&
‹ig_es
) +

1332 
‹ig_es
.
es_Àn
 - 
Àn2
;

1333 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
block
,

1334 
	`pxt4_es_°©us
(&
‹ig_es
));

1335 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1336 i‡(
îr
) {

1337 
es
->
es_lblk
 = 
‹ig_es
.es_lblk;

1338 
es
->
es_Àn
 = 
‹ig_es
.es_len;

1339 i‡((
îr
 =-
ENOMEM
) &&

1340 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1341 128, 
	`PXT4_I
(
öode
)))

1342 
ªåy
;

1343 
out
;

1346 
es
->
es_lblk
 = 
íd
 + 1;

1347 
es
->
es_Àn
 = 
Àn2
;

1348 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

1349 
	`pxt4_es_is_unwrôãn
(
es
)) {

1350 
block
 = 
‹ig_es
.
es_pblk
 + orig_es.
es_Àn
 - 
Àn2
;

1351 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1354 i‡(
cou¡_ª£rved
)

1355 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
 - 
Àn2
,

1356 &
‹ig_es
, &
rc
);

1357 
out
;

1360 i‡(
Àn1
 > 0) {

1361 i‡(
cou¡_ª£rved
)

1362 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
,

1363 &
‹ig_es
, &
rc
);

1364 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1365 i‡(
node
)

1366 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1368 
es
 = 
NULL
;

1371 
es
 && 
	`pxt4_es_íd
”sË<
íd
) {

1372 i‡(
cou¡_ª£rved
)

1373 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
,És->
es_Àn
,És, &
rc
);

1374 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1375 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1376 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1377 i‡(!
node
) {

1378 
es
 = 
NULL
;

1381 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1384 i‡(
es
 &&És->
es_lblk
 < 
íd
 + 1) {

1385 
pxt4_lblk_t
 
‹ig_Àn
 = 
es
->
es_Àn
;

1387 
Àn1
 = 
	`pxt4_es_íd
(
es
Ë- 
íd
;

1388 i‡(
cou¡_ª£rved
)

1389 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
, 
‹ig_Àn
 - 
Àn1
,

1390 
es
, &
rc
);

1391 
es
->
es_lblk
 = 
íd
 + 1;

1392 
es
->
es_Àn
 = 
Àn1
;

1393 i‡(
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es)) {

1394 
block
 = 
es
->
es_pblk
 + 
‹ig_Àn
 - 
Àn1
;

1395 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1399 i‡(
cou¡_ª£rved
)

1400 *
ª£rved
 = 
	`gë_rsvd
(
öode
, 
íd
, 
es
, &
rc
);

1401 
out
:

1402  
îr
;

1403 
	}
}

1415 
	$pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1416 
pxt4_lblk_t
 
Àn
)

1418 
pxt4_lblk_t
 
íd
;

1419 
îr
 = 0;

1420 
ª£rved
 = 0;

1422 
	`åa˚_pxt4_es_ªmove_exã¡
(
öode
, 
lblk
, 
Àn
);

1423 
	`es_debug
("remove [%u/%u) fromÉxtent statusÅree of inode %lu\n",

1424 
lblk
, 
Àn
, 
öode
->
i_öo
);

1426 i‡(!
Àn
)

1427  
îr
;

1429 
íd
 = 
lblk
 + 
Àn
 - 1;

1430 
	`BUG_ON
(
íd
 < 
lblk
);

1437 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1438 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, &
ª£rved
);

1439 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1440 
	`pxt4_es_¥öt_åì
(
öode
);

1441 
	`pxt4_da_ªÀa£_•a˚
(
öode
, 
ª£rved
);

1442  
îr
;

1443 
	}
}

1445 
	$__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

1446 
pxt4_öode_öfo
 *
locked_ei
)

1448 
pxt4_öode_öfo
 *
ei
;

1449 
pxt4_es_°©s
 *
es_°©s
;

1450 
ktime_t
 
°¨t_time
;

1451 
u64
 
sˇn_time
;

1452 
ƒ_to_wÆk
;

1453 
ƒ_shrunk
 = 0;

1454 
ªåõd
 = 0, 
ƒ_skù≥d
 = 0;

1456 
es_°©s
 = &
sbi
->
s_es_°©s
;

1457 
°¨t_time
 = 
	`ktime_gë
();

1459 
ªåy
:

1460 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1461 
ƒ_to_wÆk
 = 
sbi
->
s_es_ƒ_öode
;

1462 
ƒ_to_wÆk
-- > 0) {

1463 i‡(
	`li°_em±y
(&
sbi
->
s_es_li°
)) {

1464 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1465 
out
;

1467 
ei
 = 
	`li°_fú°_íåy
(&
sbi
->
s_es_li°
, 
pxt4_öode_öfo
,

1468 
i_es_li°
);

1470 
	`li°_move_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

1476 i‡(!
ªåõd
 && 
	`pxt4_ã°_öode_°©e
(&
ei
->
vfs_öode
,

1477 
PXT4_STATE_EXT_PRECACHED
)) {

1478 
ƒ_skù≥d
++;

1482 i‡(
ei
 =
locked_ei
 || !
	`wrôe_åylock
(&ei->
i_es_lock
)) {

1483 
ƒ_skù≥d
++;

1490 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1492 
ƒ_shrunk
 +
	`es_ª˛aim_exã¡s
(
ei
, &
ƒ_to_sˇn
);

1493 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1495 i‡(
ƒ_to_sˇn
 <= 0)

1496 
out
;

1497 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1499 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1505 i‡((
ƒ_shrunk
 =0Ë&& 
ƒ_skù≥d
 && !
ªåõd
) {

1506 
ªåõd
++;

1507 
ªåy
;

1510 i‡(
locked_ei
 && 
ƒ_shrunk
 == 0)

1511 
ƒ_shrunk
 = 
	`es_ª˛aim_exã¡s
(
locked_ei
, &
ƒ_to_sˇn
);

1513 
out
:

1514 
sˇn_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(), 
°¨t_time
));

1515 i‡(
	`likñy
(
es_°©s
->
es_°©s_sˇn_time
))

1516 
es_°©s
->
es_°©s_sˇn_time
 = (
sˇn_time
 +

1517 
es_°©s
->
es_°©s_sˇn_time
*3) / 4;

1519 
es_°©s
->
es_°©s_sˇn_time
 = 
sˇn_time
;

1520 i‡(
sˇn_time
 > 
es_°©s
->
es_°©s_max_sˇn_time
)

1521 
es_°©s
->
es_°©s_max_sˇn_time
 = 
sˇn_time
;

1522 i‡(
	`likñy
(
es_°©s
->
es_°©s_shrunk
))

1523 
es_°©s
->
es_°©s_shrunk
 = (
ƒ_shrunk
 +

1524 
es_°©s
->
es_°©s_shrunk
*3) / 4;

1526 
es_°©s
->
es_°©s_shrunk
 = 
ƒ_shrunk
;

1528 
	`åa˚_pxt4_es_shrök
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
sˇn_time
,

1529 
ƒ_skù≥d
, 
ªåõd
);

1530  
ƒ_shrunk
;

1531 
	}
}

1533 
	$pxt4_es_cou¡
(
shrökî
 *
shrök
,

1534 
shrök_c⁄åﬁ
 *
sc
)

1536 
ƒ
;

1537 
pxt4_sb_öfo
 *
sbi
;

1539 
sbi
 = 
	`c⁄èöî_of
(
shrök
, 
pxt4_sb_öfo
, 
s_es_shrökî
);

1540 
ƒ
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1541 
	`åa˚_pxt4_es_shrök_cou¡
(
sbi
->
s_sb
, 
sc
->
ƒ_to_sˇn
, 
ƒ
);

1542  
ƒ
;

1543 
	}
}

1545 
	$pxt4_es_sˇn
(
shrökî
 *
shrök
,

1546 
shrök_c⁄åﬁ
 *
sc
)

1548 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
shrök
,

1549 
pxt4_sb_öfo
, 
s_es_shrökî
);

1550 
ƒ_to_sˇn
 = 
sc
->nr_to_scan;

1551 
ªt
, 
ƒ_shrunk
;

1553 
ªt
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1554 
	`åa˚_pxt4_es_shrök_sˇn_íãr
(
sbi
->
s_sb
, 
ƒ_to_sˇn
, 
ªt
);

1556 i‡(!
ƒ_to_sˇn
)

1557  
ªt
;

1559 
ƒ_shrunk
 = 
	`__es_shrök
(
sbi
, 
ƒ_to_sˇn
, 
NULL
);

1561 
	`åa˚_pxt4_es_shrök_sˇn_exô
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
ªt
);

1562  
ƒ_shrunk
;

1563 
	}
}

1565 
	$pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
)

1567 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
((
su≥r_block
 *Ë
£q
->
¥iv©e
);

1568 
pxt4_es_°©s
 *
es_°©s
 = &
sbi
->
s_es_°©s
;

1569 
pxt4_öode_öfo
 *
ei
, *
max
 = 
NULL
;

1570 
öode_˙t
 = 0;

1572 i‡(
v
 !
SEQ_START_TOKEN
)

1576 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1577 
	`li°_f‹_óch_íåy
(
ei
, &
sbi
->
s_es_li°
, 
i_es_li°
) {

1578 
öode_˙t
++;

1579 i‡(
max
 && max->
i_es_Æl_ƒ
 < 
ei
->i_es_all_nr)

1580 
max
 = 
ei
;

1581 i‡(!
max
)

1582 
max
 = 
ei
;

1584 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1586 
	`£q_¥ötf
(
£q
, "stats:\n %lld objects\n %lldÑeclaimable objects\n",

1587 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_Æl_˙t
),

1588 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_shk_˙t
));

1589 
	`£q_¥ötf
(
£q
, " %lld/%lld cache hits/misses\n",

1590 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_hôs
),

1591 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_mis£s
));

1592 i‡(
öode_˙t
)

1593 
	`£q_¥ötf
(
£q
, " %d inode†⁄Üi°\n", 
öode_˙t
);

1595 
	`£q_¥ötf
(
£q
, "average:\n %llu us scanÅime\n",

1596 
	`div_u64
(
es_°©s
->
es_°©s_sˇn_time
, 1000));

1597 
	`£q_¥ötf
(
£q
, " %lu shrunk obje˘s\n", 
es_°©s
->
es_°©s_shrunk
);

1598 i‡(
öode_˙t
)

1599 
	`£q_¥ötf
(
£q
,

1602 
max
->
vfs_öode
.
i_öo
, max->
i_es_Æl_ƒ
, max->
i_es_shk_ƒ
,

1603 
	`div_u64
(
es_°©s
->
es_°©s_max_sˇn_time
, 1000));

1606 
	}
}

1608 
	$pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1610 
îr
;

1613 
	`BUILD_BUG_ON
(
ES_SHIFT
 < 48);

1614 
	`INIT_LIST_HEAD
(&
sbi
->
s_es_li°
);

1615 
sbi
->
s_es_ƒ_öode
 = 0;

1616 
	`•ö_lock_öô
(&
sbi
->
s_es_lock
);

1617 
sbi
->
s_es_°©s
.
es_°©s_shrunk
 = 0;

1618 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
, 0,

1619 
GFP_KERNEL
);

1620 i‡(
îr
)

1621  
îr
;

1622 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
, 0,

1623 
GFP_KERNEL
);

1624 i‡(
îr
)

1625 
îr1
;

1626 
sbi
->
s_es_°©s
.
es_°©s_sˇn_time
 = 0;

1627 
sbi
->
s_es_°©s
.
es_°©s_max_sˇn_time
 = 0;

1628 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
, 0, 
GFP_KERNEL
);

1629 i‡(
îr
)

1630 
îr2
;

1631 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
, 0, 
GFP_KERNEL
);

1632 i‡(
îr
)

1633 
îr3
;

1635 
sbi
->
s_es_shrökî
.
sˇn_obje˘s
 = 
pxt4_es_sˇn
;

1636 
sbi
->
s_es_shrökî
.
cou¡_obje˘s
 = 
pxt4_es_cou¡
;

1637 
sbi
->
s_es_shrökî
.
£eks
 = 
DEFAULT_SEEKS
;

1638 
îr
 = 
	`ªgi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1639 i‡(
îr
)

1640 
îr4
;

1643 
îr4
:

1644 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1645 
îr3
:

1646 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1647 
îr2
:

1648 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1649 
îr1
:

1650 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1651  
îr
;

1652 
	}
}

1654 
	$pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1656 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1657 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1658 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1659 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1660 
	`uƒegi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1661 
	}
}

1671 
	$es_do_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, 
pxt4_lblk_t
 
íd
,

1672 *
ƒ_to_sˇn
, *
ƒ_shrunk
)

1674 
öode
 *öodê&
ei
->
vfs_öode
;

1675 
pxt4_es_åì
 *
åì
 = &
ei
->
i_es_åì
;

1676 
exã¡_°©us
 *
es
;

1677 
rb_node
 *
node
;

1679 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
ei
->
i_es_shrök_lblk
);

1680 i‡(!
es
)

1681 
out_wøp
;

1683 *
ƒ_to_sˇn
 > 0) {

1684 i‡(
es
->
es_lblk
 > 
íd
) {

1685 
ei
->
i_es_shrök_lblk
 = 
íd
 + 1;

1689 (*
ƒ_to_sˇn
)--;

1690 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1695 i‡(
	`pxt4_es_is_dñayed
(
es
))

1696 
√xt
;

1697 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
)) {

1698 
	`pxt4_es_˛ór_ª„ªn˚d
(
es
);

1699 
√xt
;

1702 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1703 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1704 (*
ƒ_shrunk
)++;

1705 
√xt
:

1706 i‡(!
node
)

1707 
out_wøp
;

1708 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1710 
ei
->
i_es_shrök_lblk
 = 
es
->
es_lblk
;

1712 
out_wøp
:

1713 
ei
->
i_es_shrök_lblk
 = 0;

1715 
	}
}

1717 
	$es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
)

1719 
öode
 *öodê&
ei
->
vfs_öode
;

1720 
ƒ_shrunk
 = 0;

1721 
pxt4_lblk_t
 
°¨t
 = 
ei
->
i_es_shrök_lblk
;

1722 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1723 
DEFAULT_RATELIMIT_BURST
);

1725 i‡(
ei
->
i_es_shk_ƒ
 == 0)

1728 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
) &&

1729 
	`__øãlimô
(&
_rs
))

1730 
	`pxt4_w¨nög
(
öode
->
i_sb
, "forced shrink ofÖrecachedÉxtents");

1732 i‡(!
	`es_do_ª˛aim_exã¡s
(
ei
, 
EXT_MAX_BLOCKS
, 
ƒ_to_sˇn
, &
ƒ_shrunk
) &&

1733 
°¨t
 != 0)

1734 
	`es_do_ª˛aim_exã¡s
(
ei
, 
°¨t
 - 1, 
ƒ_to_sˇn
, &
ƒ_shrunk
);

1736 
ei
->
i_es_åì
.
ˇche_es
 = 
NULL
;

1737  
ƒ_shrunk
;

1738 
	}
}

1745 
	$pxt4_˛ór_öode_es
(
öode
 *inode)

1747 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1748 
exã¡_°©us
 *
es
;

1749 
pxt4_es_åì
 *
åì
;

1750 
rb_node
 *
node
;

1752 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1753 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1754 
åì
->
ˇche_es
 = 
NULL
;

1755 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1756 
node
) {

1757 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1758 
node
 = 
	`rb_√xt
(node);

1759 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

1760 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1761 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1764 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

1765 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1766 
	}
}

1768 #ifde‡
ES_DEBUG__


1769 
	$pxt4_¥öt_≥ndög_åì
(
öode
 *inode)

1771 
pxt4_≥ndög_åì
 *
åì
;

1772 
rb_node
 *
node
;

1773 
≥ndög_ª£rv©i⁄
 *
¥
;

1775 
	`¥ötk
(
KERN_DEBUG
 "≥ndögÑe£rv©i⁄†f‹ inodê%lu:", 
öode
->
i_öo
);

1776 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1777 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1778 
node
) {

1779 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1780 
	`¥ötk
(
KERN_DEBUG
 " %u", 
¥
->
l˛u
);

1781 
node
 = 
	`rb_√xt
(node);

1783 
	`¥ötk
(
KERN_DEBUG
 "\n");

1784 
	}
}

1786 
	#pxt4_¥öt_≥ndög_åì
(
öode
)

	)

1789 
__öô
 
	$pxt4_öô_≥ndög
()

1791 
pxt4_≥ndög_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_pending_reservation",

1792 (
≥ndög_ª£rv©i⁄
),

1793 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

1794 i‡(
pxt4_≥ndög_ˇchï
 =
NULL
)

1795  -
ENOMEM
;

1797 
	}
}

1799 
	$pxt4_exô_≥ndög
()

1801 
	`kmem_ˇche_de°roy
(
pxt4_≥ndög_ˇchï
);

1802 
	}
}

1804 
	$pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
)

1806 
åì
->
roŸ
 = 
RB_ROOT
;

1807 
	}
}

1818 
≥ndög_ª£rv©i⁄
 *
	$__gë_≥ndög
(
öode
 *inode,

1819 
pxt4_lblk_t
 
l˛u
)

1821 
pxt4_≥ndög_åì
 *
åì
;

1822 
rb_node
 *
node
;

1823 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1825 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1826 
node
 = (&
åì
->
roŸ
)->
rb_node
;

1828 
node
) {

1829 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1830 i‡(
l˛u
 < 
¥
->lclu)

1831 
node
 =Çode->
rb_À·
;

1832 i‡(
l˛u
 > 
¥
->lclu)

1833 
node
 =Çode->
rb_right
;

1834 i‡(
l˛u
 =
¥
->lclu)

1835  
¥
;

1837  
NULL
;

1838 
	}
}

1850 
	$__ö£π_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1852 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1853 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1854 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

1855 
rb_node
 *
∑ª¡
 = 
NULL
;

1856 
≥ndög_ª£rv©i⁄
 *
¥
;

1857 
pxt4_lblk_t
 
l˛u
;

1858 
ªt
 = 0;

1860 
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
lblk
);

1862 *
p
) {

1863 
∑ª¡
 = *
p
;

1864 
¥
 = 
	`rb_íåy
(
∑ª¡
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1866 i‡(
l˛u
 < 
¥
->lclu) {

1867 
p
 = &(*p)->
rb_À·
;

1868 } i‡(
l˛u
 > 
¥
->lclu) {

1869 
p
 = &(*p)->
rb_right
;

1872 
out
;

1876 
¥
 = 
	`kmem_ˇche_Æloc
(
pxt4_≥ndög_ˇchï
, 
GFP_ATOMIC
);

1877 i‡(
¥
 =
NULL
) {

1878 
ªt
 = -
ENOMEM
;

1879 
out
;

1881 
¥
->
l˛u
 =Üclu;

1883 
	`rb_lök_node
(&
¥
->
rb_node
, 
∑ª¡
, 
p
);

1884 
	`rb_ö£π_cﬁ‹
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1886 
out
:

1887  
ªt
;

1888 
	}
}

1899 
	$__ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1901 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1902 
≥ndög_ª£rv©i⁄
 *
¥
;

1903 
pxt4_≥ndög_åì
 *
åì
;

1905 
¥
 = 
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
));

1906 i‡(
¥
 !
NULL
) {

1907 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1908 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1909 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1911 
	}
}

1922 
	$pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1924 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1926 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1927 
	`__ªmove_≥ndög
(
öode
, 
lblk
);

1928 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1929 
	}
}

1941 
boﬁ
 
	$pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1943 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1944 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1945 
boﬁ
 
ªt
;

1947 
	`ªad_lock
(&
ei
->
i_es_lock
);

1948 
ªt
 = (
boﬁ
)(
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
)Ë!
NULL
);

1949 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

1951  
ªt
;

1952 
	}
}

1966 
	$pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1967 
boﬁ
 
Æloˇãd
)

1969 
exã¡_°©us
 
√wes
;

1970 
îr
 = 0;

1972 
	`es_debug
("add [%u/1) delayedÅoÉxtent statusÅree of inode %lu\n",

1973 
lblk
, 
öode
->
i_öo
);

1975 
√wes
.
es_lblk
 = 
lblk
;

1976 
√wes
.
es_Àn
 = 1;

1977 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, ~0, 
EXTENT_STATUS_DELAYED
);

1978 
	`åa˚_pxt4_es_ö£π_dñayed_block
(
öode
, &
√wes
, 
Æloˇãd
);

1980 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

1982 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1984 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
,Üblk, 
NULL
);

1985 i‡(
îr
 != 0)

1986 
îr‹
;

1987 
ªåy
:

1988 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1989 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1990 128, 
	`PXT4_I
(
öode
)))

1991 
ªåy
;

1992 i‡(
îr
 != 0)

1993 
îr‹
;

1995 i‡(
Æloˇãd
)

1996 
	`__ö£π_≥ndög
(
öode
, 
lblk
);

1998 
îr‹
:

1999 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

2001 
	`pxt4_es_¥öt_åì
(
öode
);

2002 
	`pxt4_¥öt_≥ndög_åì
(
öode
);

2004  
îr
;

2005 
	}
}

2020 
	$__es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2021 
pxt4_lblk_t
 
íd
)

2023 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

2024 
exã¡_°©us
 *
es
;

2025 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2026 
rb_node
 *
node
;

2027 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

2028 
œ°_cou¡ed_l˛u
;

2029 
n
 = 0;

2032 
œ°_cou¡ed_l˛u
 = ~0ULL;

2034 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
°¨t
);

2036 
es
 && (es->
es_lblk
 <
íd
)) {

2037 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

2038 i‡(
es
->
es_lblk
 <
°¨t
)

2039 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
°¨t
);

2041 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
es
->
es_lblk
);

2043 i‡(
	`pxt4_es_íd
(
es
Ë>
íd
)

2044 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
íd
);

2046 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_es_íd
(
es
));

2048 i‡(
fú°_l˛u
 =
œ°_cou¡ed_l˛u
)

2049 
n
 +
œ°_l˛u
 - 
fú°_l˛u
;

2051 
n
 +
œ°_l˛u
 - 
fú°_l˛u
 + 1;

2052 
œ°_cou¡ed_l˛u
 = 
œ°_l˛u
;

2054 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

2055 i‡(!
node
)

2057 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

2060  
n
;

2061 
	}
}

2073 
	$pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2074 
pxt4_lblk_t
 
Àn
)

2076 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2077 
pxt4_lblk_t
 
íd
;

2078 
n
;

2080 i‡(
Àn
 == 0)

2083 
íd
 = 
lblk
 + 
Àn
 - 1;

2084 
	`WARN_ON
(
íd
 < 
lblk
);

2086 
	`ªad_lock
(&
ei
->
i_es_lock
);

2088 
n
 = 
	`__es_dñayed_˛u
(
öode
, 
lblk
, 
íd
);

2090 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

2092  
n
;

2093 
	}
}

2110 
	$__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2111 
pxt4_lblk_t
 
Àn
)

2113 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2114 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

2115 
pxt4_lblk_t
 
fú°
, 
œ°
;

2116 
boﬁ
 
f_dñ
 = 
Ál£
, 
l_dñ
 = false;

2118 i‡(
Àn
 == 0)

2134 i‡(
	`PXT4_B2C
(
sbi
, 
lblk
Ë=PXT4_B2C(sbi, 
íd
)) {

2135 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2136 i‡(
fú°
 !
lblk
)

2137 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2138 
fú°
, 
lblk
 - 1);

2139 i‡(
f_dñ
) {

2140 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2142 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
) +

2143 
sbi
->
s_˛u°î_øtio
 - 1;

2144 i‡(
œ°
 !
íd
)

2145 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
,

2146 &
pxt4_es_is_dñ⁄ly
,

2147 
íd
 + 1, 
œ°
);

2148 i‡(
l_dñ
)

2149 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2151 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2154 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2155 i‡(
fú°
 !
lblk
)

2156 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2157 
fú°
, 
lblk
 - 1);

2158 i‡(
f_dñ
)

2159 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2161 
	`__ªmove_≥ndög
(
öode
, 
fú°
);

2163 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
Ë+ sbi->
s_˛u°î_øtio
 - 1;

2164 i‡(
œ°
 !
íd
)

2165 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2166 
íd
 + 1, 
œ°
);

2167 i‡(
l_dñ
)

2168 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2170 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2172 
	}
}

	@extents_status.h

12 #i‚de‡
_PXT4_EXTENTS_STATUS_H


13 
	#_PXT4_EXTENTS_STATUS_H


	)

18 #ifde‡
ES_DEBUG__


19 
	#es_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

21 
	#es_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

28 
	#ES_AGGRESSIVE_TEST__


	)

34 
	mES_WRITTEN_B
,

35 
	mES_UNWRITTEN_B
,

36 
	mES_DELAYED_B
,

37 
	mES_HOLE_B
,

38 
	mES_REFERENCED_B
,

39 
	mES_FLAGS


42 
	#ES_SHIFT
 ((
pxt4_fsblk_t
)*8 - 
ES_FLAGS
)

	)

43 
	#ES_MASK
 (~((
pxt4_fsblk_t
)0Ë<< 
ES_SHIFT
)

	)

45 
	#EXTENT_STATUS_WRITTEN
 (1 << 
ES_WRITTEN_B
)

	)

46 
	#EXTENT_STATUS_UNWRITTEN
 (1 << 
ES_UNWRITTEN_B
)

	)

47 
	#EXTENT_STATUS_DELAYED
 (1 << 
ES_DELAYED_B
)

	)

48 
	#EXTENT_STATUS_HOLE
 (1 << 
ES_HOLE_B
)

	)

49 
	#EXTENT_STATUS_REFERENCED
 (1 << 
ES_REFERENCED_B
)

	)

51 
	#ES_TYPE_MASK
 ((
pxt4_fsblk_t
)(
EXTENT_STATUS_WRITTEN
 | \

52 
EXTENT_STATUS_UNWRITTEN
 | \

53 
EXTENT_STATUS_DELAYED
 | \

54 
EXTENT_STATUS_HOLE
Ë<< 
ES_SHIFT
)

	)

56 
	gpxt4_sb_öfo
;

57 
	gpxt4_exã¡
;

59 
	sexã¡_°©us
 {

60 
rb_node
 
	mrb_node
;

61 
pxt4_lblk_t
 
	mes_lblk
;

62 
pxt4_lblk_t
 
	mes_Àn
;

63 
pxt4_fsblk_t
 
	mes_pblk
;

66 
	spxt4_es_åì
 {

67 
rb_roŸ
 
	mroŸ
;

68 
exã¡_°©us
 *
	mˇche_es
;

71 
	spxt4_es_°©s
 {

72 
	mes_°©s_shrunk
;

73 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_hôs
;

74 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_mis£s
;

75 
u64
 
	mes_°©s_sˇn_time
;

76 
u64
 
	mes_°©s_max_sˇn_time
;

77 
≥r˝u_cou¡î
 
	mes_°©s_Æl_˙t
;

78 
≥r˝u_cou¡î
 
	mes_°©s_shk_˙t
;

117 
	s≥ndög_ª£rv©i⁄
 {

118 
rb_node
 
	mrb_node
;

119 
pxt4_lblk_t
 
	ml˛u
;

122 
	spxt4_≥ndög_åì
 {

123 
rb_roŸ
 
	mroŸ
;

126 
__öô
 
pxt4_öô_es
();

127 
pxt4_exô_es
();

128 
pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
);

130 
pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

131 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

132 
°©us
);

133 
pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

134 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

135 
°©us
);

136 
pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

137 
pxt4_lblk_t
 
Àn
);

138 
pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

139 (*
m©ch_‚
)(
exã¡_°©us
 *
es
),

140 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

141 
exã¡_°©us
 *
es
);

142 
	`pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

143 
pxt4_lblk_t
 *
√xt_lblk
,

144 
exã¡_°©us
 *
es
);

145 
boﬁ
 
	`pxt4_es_sˇn_ønge
(
öode
 *inode,

146 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

147 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
);

148 
boﬁ
 
	`pxt4_es_sˇn_˛u
(
öode
 *inode,

149 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

150 
pxt4_lblk_t
 
lblk
);

152 
ölöe
 
	$pxt4_es_°©us
(
exã¡_°©us
 *
es
)

154  
es
->
es_pblk
 >> 
ES_SHIFT
;

155 
	}
}

157 
ölöe
 
	$pxt4_es_ty≥
(
exã¡_°©us
 *
es
)

159  (
es
->
es_pblk
 & 
ES_TYPE_MASK
Ë>> 
ES_SHIFT
;

160 
	}
}

162 
ölöe
 
	$pxt4_es_is_wrôãn
(
exã¡_°©us
 *
es
)

164  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_WRITTEN
) != 0;

165 
	}
}

167 
ölöe
 
	$pxt4_es_is_unwrôãn
(
exã¡_°©us
 *
es
)

169  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_UNWRITTEN
) != 0;

170 
	}
}

172 
ölöe
 
	$pxt4_es_is_dñayed
(
exã¡_°©us
 *
es
)

174  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_DELAYED
) != 0;

175 
	}
}

177 
ölöe
 
	$pxt4_es_is_hﬁe
(
exã¡_°©us
 *
es
)

179  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_HOLE
) != 0;

180 
	}
}

182 
ölöe
 
	$pxt4_es_is_m≠≥d
(
exã¡_°©us
 *
es
)

184  (
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es));

185 
	}
}

187 
ölöe
 
	$pxt4_es_is_dñ⁄ly
(
exã¡_°©us
 *
es
)

189  (
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es));

190 
	}
}

192 
ölöe
 
	$pxt4_es_£t_ª„ªn˚d
(
exã¡_°©us
 *
es
)

194 
es
->
es_pblk
 |((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
;

195 
	}
}

197 
ölöe
 
	$pxt4_es_˛ór_ª„ªn˚d
(
exã¡_°©us
 *
es
)

199 
es
->
es_pblk
 &~(((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
);

200 
	}
}

202 
ölöe
 
	$pxt4_es_is_ª„ªn˚d
(
exã¡_°©us
 *
es
)

204  (
	`pxt4_es_°©us
(
es
Ë& 
EXTENT_STATUS_REFERENCED
) != 0;

205 
	}
}

207 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_es_pblock
(
exã¡_°©us
 *
es
)

209  
es
->
es_pblk
 & ~
ES_MASK
;

210 
	}
}

212 
ölöe
 
	$pxt4_es_°‹e_pblock
(
exã¡_°©us
 *
es
,

213 
pxt4_fsblk_t
 
pb
)

215 
pxt4_fsblk_t
 
block
;

217 
block
 = (
pb
 & ~
ES_MASK
Ë| (
es
->
es_pblk
 & ES_MASK);

218 
es
->
es_pblk
 = 
block
;

219 
	}
}

221 
ölöe
 
	$pxt4_es_°‹e_°©us
(
exã¡_°©us
 *
es
,

222 
°©us
)

224 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

225 (
es
->
es_pblk
 & ~
ES_MASK
);

226 
	}
}

228 
ölöe
 
	$pxt4_es_°‹e_pblock_°©us
(
exã¡_°©us
 *
es
,

229 
pxt4_fsblk_t
 
pb
,

230 
°©us
)

232 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

233 (
pb
 & ~
ES_MASK
);

234 
	}
}

236 
pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

237 
pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

239 
pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
);

241 
__öô
 
pxt4_öô_≥ndög
();

242 
pxt4_exô_≥ndög
();

243 
pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
);

244 
pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

245 
boﬁ
 
pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

246 
pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

247 
boﬁ
 
Æloˇãd
);

248 
pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

249 
pxt4_lblk_t
 
Àn
);

250 
pxt4_˛ór_öode_es
(
öode
 *inode);

	@file.c

22 
	~<löux/time.h
>

23 
	~<löux/fs.h
>

24 
	~<löux/iom≠.h
>

25 
	~<löux/mou¡.h
>

26 
	~<löux/∑th.h
>

27 
	~<löux/dax.h
>

28 
	~<löux/quŸa›s.h
>

29 
	~<löux/∑gevec.h
>

30 
	~<löux/uio.h
>

31 
	~<löux/mm™.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

34 
	~"x©å.h
"

35 
	~"a˛.h
"

37 #ifde‡
CONFIG_FS_DAX


38 
ssize_t
 
	$pxt4_dax_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

40 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

41 
ssize_t
 
ªt
;

43 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

44 i‡(!
	`öode_åylock_sh¨ed
(
öode
))

45  -
EAGAIN
;

47 
	`öode_lock_sh¨ed
(
öode
);

53 i‡(!
	`IS_DAX
(
öode
)) {

54 
	`öode_u∆ock_sh¨ed
(
öode
);

56  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

58 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
to
, &
pxt4_iom≠_›s
);

59 
	`öode_u∆ock_sh¨ed
(
öode
);

61 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

62  
ªt
;

63 
	}
}

66 
ssize_t
 
	$pxt4_fûe_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

68 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
	`fûe_öode
(
iocb
->
ki_fûp
)->
i_sb
))))

69  -
EIO
;

71 i‡(!
	`iov_ôî_cou¡
(
to
))

74 #ifde‡
CONFIG_FS_DAX


75 i‡(
	`IS_DAX
(
	`fûe_öode
(
iocb
->
ki_fûp
)))

76  
	`pxt4_dax_ªad_ôî
(
iocb
, 
to
);

78  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

79 
	}
}

86 
	$pxt4_ªÀa£_fûe
(
öode
 *öode, 
fûe
 *
fûp
)

88 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
)) {

89 
	`pxt4_Æloc_da_blocks
(
öode
);

90 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

93 i‡((
fûp
->
f_mode
 & 
FMODE_WRITE
) &&

94 (
	`©omic_ªad
(&
öode
->
i_wrôecou¡
) == 1) &&

95 !
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

97 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

98 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

99 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

101 i‡(
	`is_dx
(
öode
Ë&& 
fûp
->
¥iv©e_d©a
)

102 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

105 
	}
}

107 
	$pxt4_unwrôãn_waô
(
öode
 *inode)

109 
waô_queue_hód_t
 *
wq
 = 
	`pxt4_i€nd_wq
(
öode
);

111 
	`waô_evít
(*
wq
, (
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) == 0));

112 
	}
}

124 
	$pxt4_u«lig√d_aio
(
öode
 *öode, 
iov_ôî
 *
‰om
, 
loff_t
 
pos
)

126 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

127 
blockmask
 = 
sb
->
s_blocksize
 - 1;

129 i‡(
pos
 >
	`ALIGN
(
	`i_size_ªad
(
öode
), 
sb
->
s_blocksize
))

132 i‡((
pos
 | 
	`iov_ôî_Æignmít
(
‰om
)Ë& 
blockmask
)

136 
	}
}

139 
boﬁ
 
	$pxt4_ovîwrôe_io
(
öode
 *öode, 
loff_t
 
pos
,Üoff_à
Àn
)

141 
pxt4_m≠_blocks
 
m≠
;

142 
blkbôs
 = 
öode
->
i_blkbôs
;

143 
îr
, 
blkÀn
;

145 i‡(
pos
 + 
Àn
 > 
	`i_size_ªad
(
öode
))

146  
Ál£
;

148 
m≠
.
m_lblk
 = 
pos
 >> 
blkbôs
;

149 
m≠
.
m_Àn
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
pos
, 
blkbôs
);

150 
blkÀn
 = 
m≠
.
m_Àn
;

152 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

158  
îr
 =
blkÀn
 && (
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
);

159 
	}
}

161 
ssize_t
 
	$pxt4_wrôe_checks
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

163 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

164 
ssize_t
 
ªt
;

166 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

167 i‡(
ªt
 <= 0)

168  
ªt
;

170 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

171  -
EPERM
;

177 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

178 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

180 i‡(
iocb
->
ki_pos
 >
sbi
->
s_bôm≠_maxbyãs
)

181  -
EFBIG
;

182 
	`iov_ôî_åunˇã
(
‰om
, 
sbi
->
s_bôm≠_maxbyãs
 - 
iocb
->
ki_pos
);

184  
	`iov_ôî_cou¡
(
‰om
);

185 
	}
}

187 #ifde‡
CONFIG_FS_DAX


188 
ssize_t


189 
	$pxt4_dax_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

191 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

192 
ssize_t
 
ªt
;

194 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

195 i‡(!
	`öode_åylock
(
öode
))

196  -
EAGAIN
;

198 
	`öode_lock
(
öode
);

200 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

201 i‡(
ªt
 <= 0)

202 
out
;

203 
ªt
 = 
	`fûe_ªmove_¥ivs
(
iocb
->
ki_fûp
);

204 i‡(
ªt
)

205 
out
;

206 
ªt
 = 
	`fûe_upd©e_time
(
iocb
->
ki_fûp
);

207 i‡(
ªt
)

208 
out
;

210 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
‰om
, &
pxt4_iom≠_›s
);

211 
out
:

212 
	`öode_u∆ock
(
öode
);

213 i‡(
ªt
 > 0)

214 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

215  
ªt
;

216 
	}
}

219 
ssize_t


220 
	$pxt4_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

222 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

223 
o_dúe˘
 = 
iocb
->
ki_Êags
 & 
IOCB_DIRECT
;

224 
u«lig√d_aio
 = 0;

225 
ovîwrôe
 = 0;

226 
ssize_t
 
ªt
;

228 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

229  -
EIO
;

231 #ifde‡
CONFIG_FS_DAX


232 i‡(
	`IS_DAX
(
öode
))

233  
	`pxt4_dax_wrôe_ôî
(
iocb
, 
‰om
);

236 i‡(!
	`öode_åylock
(
öode
)) {

237 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

238  -
EAGAIN
;

239 
	`öode_lock
(
öode
);

242 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

243 i‡(
ªt
 <= 0)

244 
out
;

251 i‡(
o_dúe˘
 && 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) &&

252 !
	`is_sync_kiocb
(
iocb
) &&

253 
	`pxt4_u«lig√d_aio
(
öode
, 
‰om
, 
iocb
->
ki_pos
)) {

254 
u«lig√d_aio
 = 1;

255 
	`pxt4_unwrôãn_waô
(
öode
);

258 
iocb
->
¥iv©e
 = &
ovîwrôe
;

260 i‡(
o_dúe˘
 && !
u«lig√d_aio
) {

261 i‡(
	`pxt4_ovîwrôe_io
(
öode
, 
iocb
->
ki_pos
, 
	`iov_ôî_cou¡
(
‰om
))) {

262 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

263 
ovîwrôe
 = 1;

264 } i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

265 
ªt
 = -
EAGAIN
;

266 
out
;

270 
ªt
 = 
	`__gíîic_fûe_wrôe_ôî
(
iocb
, 
‰om
);

276 i‡(
ªt
 =-
EIOCBQUEUED
 && 
u«lig√d_aio
)

277 
	`pxt4_unwrôãn_waô
(
öode
);

278 
	`öode_u∆ock
(
öode
);

280 i‡(
ªt
 > 0)

281 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

283  
ªt
;

285 
out
:

286 
	`öode_u∆ock
(
öode
);

287  
ªt
;

288 
	}
}

290 #ifde‡
CONFIG_FS_DAX


291 
vm_Áu…_t
 
	$pxt4_dax_huge_Áu…
(
vm_Áu…
 *
vmf
,

292 
∑ge_íåy_size
 
≥_size
)

294 
îr‹
 = 0;

295 
vm_Áu…_t
 
ªsu…
;

296 
ªåõs
 = 0;

297 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

298 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

299 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

312 
boﬁ
 
wrôe
 = (
vmf
->
Êags
 & 
FAULT_FLAG_WRITE
) &&

313 (
vmf
->
vma
->
vm_Êags
 & 
VM_SHARED
);

314 
p‚_t
 
p‚
;

316 i‡(
wrôe
) {

317 
	`sb_°¨t_∑geÁu…
(
sb
);

318 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

319 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

320 
ªåy
:

321 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_WRITE_PAGE
,

322 
	`PXT4_DATA_TRANS_BLOCKS
(
sb
));

323 i‡(
	`IS_ERR
(
h™dÀ
)) {

324 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

325 
	`sb_íd_∑geÁu…
(
sb
);

326  
VM_FAULT_SIGBUS
;

329 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

331 
ªsu…
 = 
	`dax_iom≠_Áu…
(
vmf
, 
≥_size
, &
p‚
, &
îr‹
, &
pxt4_iom≠_›s
);

332 i‡(
wrôe
) {

333 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

335 i‡((
ªsu…
 & 
VM_FAULT_ERROR
Ë&& 
îr‹
 =-
ENOSPC
 &&

336 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

337 
ªåy
;

339 i‡(
ªsu…
 & 
VM_FAULT_NEEDDSYNC
)

340 
ªsu…
 = 
	`dax_föish_sync_Áu…
(
vmf
, 
≥_size
, 
p‚
);

341 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

342 
	`sb_íd_∑geÁu…
(
sb
);

344 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

347  
ªsu…
;

348 
	}
}

350 
vm_Áu…_t
 
	$pxt4_dax_Áu…
(
vm_Áu…
 *
vmf
)

352  
	`pxt4_dax_huge_Áu…
(
vmf
, 
PE_SIZE_PTE
);

353 
	}
}

355 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_dax_vm_›s
 = {

356 .
Áu…
 = 
pxt4_dax_Áu…
,

357 .
	ghuge_Áu…
 = 
pxt4_dax_huge_Áu…
,

358 .
	g∑ge_mkwrôe
 = 
pxt4_dax_Áu…
,

359 .
	gp‚_mkwrôe
 = 
pxt4_dax_Áu…
,

362 
	#pxt4_dax_vm_›s
 
pxt4_fûe_vm_›s


	)

365 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_fûe_vm_›s
 = {

366 .
Áu…
 = 
pxt4_fûem≠_Áu…
,

367 .
	gm≠_∑ges
 = 
fûem≠_m≠_∑ges
,

368 .
	g∑ge_mkwrôe
 = 
pxt4_∑ge_mkwrôe
,

371 
	$pxt4_fûe_mm≠
(
fûe
 *fûe, 
vm_¨ó_°ru˘
 *
vma
)

373 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

374 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

375 
dax_devi˚
 *
dax_dev
 = 
sbi
->
s_daxdev
;

377 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

378  -
EIO
;

384 i‡(!
	`daxdev_m≠pög_suµ‹ãd
(
vma
, 
dax_dev
))

385  -
EOPNOTSUPP
;

387 
	`fûe_ac˚s£d
(
fûe
);

388 i‡(
	`IS_DAX
(
	`fûe_öode
(
fûe
))) {

389 
vma
->
vm_›s
 = &
pxt4_dax_vm_›s
;

390 
vma
->
vm_Êags
 |
VM_HUGEPAGE
;

392 
vma
->
vm_›s
 = &
pxt4_fûe_vm_›s
;

395 
	}
}

397 
	$pxt4_ßm∂e_œ°_mou¡ed
(
su≥r_block
 *
sb
,

398 
vfsmou¡
 *
m¡
)

400 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

401 
∑th
Öath;

402 
buf
[64], *
˝
;

403 
h™dÀ_t
 *
h™dÀ
;

404 
îr
;

406 i‡(
	`likñy
(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_MNTDIR_SAMPLED
))

409 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`sb_°¨t_ötwrôe_åylock
(sb))

412 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_MNTDIR_SAMPLED
;

419 
	`mem£t
(
buf
, 0, (buf));

420 
∑th
.
m¡
 = mnt;

421 
∑th
.
díåy
 = 
m¡
->
m¡_roŸ
;

422 
˝
 = 
	`d_∑th
(&
∑th
, 
buf
, (buf));

423 
îr
 = 0;

424 i‡(
	`IS_ERR
(
˝
))

425 
out
;

427 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

428 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

429 i‡(
	`IS_ERR
(
h™dÀ
))

430 
out
;

431 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

432 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

433 i‡(
îr
)

434 
out_jou∫Æ
;

435 
	`°æ˝y
(
sbi
->
s_es
->
s_œ°_mou¡ed
, 
˝
,

436 (
sbi
->
s_es
->
s_œ°_mou¡ed
));

437 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

438 
out_jou∫Æ
:

439 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

440 
out
:

441 
	`sb_íd_ötwrôe
(
sb
);

442  
îr
;

443 
	}
}

445 
	$pxt4_fûe_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

447 
ªt
;

449 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

450  -
EIO
;

452 
ªt
 = 
	`pxt4_ßm∂e_œ°_mou¡ed
(
öode
->
i_sb
, 
fûp
->
f_∑th
.
m¡
);

453 i‡(
ªt
)

454  
ªt
;

456 
ªt
 = 
	`fs¸y±_fûe_›í
(
öode
, 
fûp
);

457 i‡(
ªt
)

458  
ªt
;

460 
ªt
 = 
	`fsvîôy_fûe_›í
(
öode
, 
fûp
);

461 i‡(
ªt
)

462  
ªt
;

468 i‡(
fûp
->
f_mode
 & 
FMODE_WRITE
) {

469 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

470 i‡(
ªt
 < 0)

471  
ªt
;

474 
fûp
->
f_mode
 |
FMODE_NOWAIT
;

475  
	`dquŸ_fûe_›í
(
öode
, 
fûp
);

476 
	}
}

483 
loff_t
 
	$pxt4_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

485 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

486 
loff_t
 
maxbyãs
;

488 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

489 
maxbyãs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
;

491 
maxbyãs
 = 
öode
->
i_sb
->
s_maxbyãs
;

493 
whí˚
) {

495  
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

496 
maxbyãs
, 
	`i_size_ªad
(
öode
));

497 
SEEK_HOLE
:

498 
	`öode_lock_sh¨ed
(
öode
);

499 
off£t
 = 
	`iom≠_£ek_hﬁe
(
öode
, off£t, &
pxt4_iom≠_›s
);

500 
	`öode_u∆ock_sh¨ed
(
öode
);

502 
SEEK_DATA
:

503 
	`öode_lock_sh¨ed
(
öode
);

504 
off£t
 = 
	`iom≠_£ek_d©a
(
öode
, off£t, &
pxt4_iom≠_›s
);

505 
	`öode_u∆ock_sh¨ed
(
öode
);

509 i‡(
off£t
 < 0)

510  
off£t
;

511  
	`vfs_£ços
(
fûe
, 
off£t
, 
maxbyãs
);

512 
	}
}

514 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_fûe_›î©i⁄s
 = {

515 .
Œ£ek
 = 
pxt4_Œ£ek
,

516 .
	gªad_ôî
 = 
pxt4_fûe_ªad_ôî
,

517 .
	gwrôe_ôî
 = 
pxt4_fûe_wrôe_ôî
,

518 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

519 #ifde‡
CONFIG_COMPAT


520 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

522 .
	gmm≠
 = 
pxt4_fûe_mm≠
,

523 .
	gmm≠_suµ‹ãd_Êags
 = 
MAP_SYNC
,

524 .
	g›í
 = 
pxt4_fûe_›í
,

525 .
	gªÀa£
 = 
pxt4_ªÀa£_fûe
,

526 .
	gfsync
 = 
pxt4_sync_fûe
,

527 .
	ggë_unm≠≥d_¨ó
 = 
thp_gë_unm≠≥d_¨ó
,

528 .
	g•li˚_ªad
 = 
gíîic_fûe_•li˚_ªad
,

529 .
	g•li˚_wrôe
 = 
ôî_fûe_•li˚_wrôe
,

530 .
	gÁŒoˇã
 = 
pxt4_ÁŒoˇã
,

533 c⁄° 
öode_›î©i⁄s
 
	gpxt4_fûe_öode_›î©i⁄s
 = {

534 .
£èâr
 = 
pxt4_£èâr
,

535 .
	ggë©å
 = 
pxt4_fûe_gë©å
,

536 .
	gli°x©å
 = 
pxt4_li°x©å
,

537 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

538 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

539 .
	gfõm≠
 = 
pxt4_fõm≠
,

	@fsmap.c

7 
	~"pxt4.h
"

8 
	~<löux/fsm≠.h
>

9 
	~"fsm≠.h
"

10 
	~"mbÆloc.h
"

11 
	~<löux/s‹t.h
>

12 
	~<löux/li°_s‹t.h
>

13 
	~<åa˚/evíts/pxt4.h
>

16 
	$pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

17 
pxt4_fsm≠
 *
§c
)

19 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

20 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

21 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»<< 
sb
->
s_blocksize_bôs
;

22 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

23 
de°
->
fmr_off£t
 = 0;

24 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth << 
sb
->
s_blocksize_bôs
;

25 
de°
->
fmr_ª£rved
[0] = 0;

26 
de°
->
fmr_ª£rved
[1] = 0;

27 
de°
->
fmr_ª£rved
[2] = 0;

28 
	}
}

31 
	$pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

32 
fsm≠
 *
§c
)

34 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

35 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

36 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»>> 
sb
->
s_blocksize_bôs
;

37 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

38 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth >> 
sb
->
s_blocksize_bôs
;

39 
	}
}

42 
	spxt4_gëfsm≠_öfo
 {

43 
pxt4_fsm≠_hód
 *
	mgfi_hód
;

44 
pxt4_fsm≠_f‹m©_t
 
	mgfi_f‹m©ãr
;

45 *
	mgfi_f‹m©_¨g
;

46 
pxt4_fsblk_t
 
	mgfi_√xt_fsblk
;

47 
u32
 
	mgfi_dev
;

48 
pxt4_group_t
 
	mgfi_agno
;

49 
pxt4_fsm≠
 
	mgfi_low
;

50 
pxt4_fsm≠
 
	mgfi_high
;

51 
pxt4_fsm≠
 
	mgfi_œ°‰ì
;

52 
li°_hód
 
	mgfi_mëa_li°
;

53 
boﬁ
 
	mgfi_œ°
;

57 
	spxt4_gëfsm≠_dev
 {

58 (*
	mgfd_‚
)(
su≥r_block
 *
	msb
,

59 
pxt4_fsm≠
 *
	mkeys
,

60 
pxt4_gëfsm≠_öfo
 *
	möfo
);

61 
u32
 
	mgfd_dev
;

65 
	$pxt4_gëfsm≠_dev_com∑ª
(c⁄° *
p1
, c⁄° *
p2
)

67 c⁄° 
pxt4_gëfsm≠_dev
 *
d1
 = 
p1
;

68 c⁄° 
pxt4_gëfsm≠_dev
 *
d2
 = 
p2
;

70  
d1
->
gfd_dev
 - 
d2
->gfd_dev;

71 
	}
}

74 
boﬁ
 
	$pxt4_gëfsm≠_ªc_bef‹e_low_key
(
pxt4_gëfsm≠_öfo
 *
öfo
,

75 
pxt4_fsm≠
 *
ªc
)

77  
ªc
->
fmr_physiˇl
 < 
öfo
->
gfi_low
.fmr_physical;

78 
	}
}

84 
	$pxt4_gëfsm≠_hñ≥r
(
su≥r_block
 *
sb
,

85 
pxt4_gëfsm≠_öfo
 *
öfo
,

86 
pxt4_fsm≠
 *
ªc
)

88 
pxt4_fsm≠
 
fmr
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

90 
pxt4_fsblk_t
 
ªc_fsblk
 = 
ªc
->
fmr_physiˇl
;

91 
pxt4_group_t
 
agno
;

92 
pxt4_gΩblk_t
 
˙o
;

93 
îr‹
;

95 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

96  -
EINTR
;

102 i‡(
	`pxt4_gëfsm≠_ªc_bef‹e_low_key
(
öfo
, 
ªc
)) {

103 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

104 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

105 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

106  
PXT4_QUERY_RANGE_CONTINUE
;

110 i‡(
öfo
->
gfi_hód
->
fmh_cou¡
 == 0) {

111 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
)

112 
öfo
->
gfi_hód
->
fmh_íåõs
++;

114 i‡(
öfo
->
gfi_œ°
)

115  
PXT4_QUERY_RANGE_CONTINUE
;

117 
öfo
->
gfi_hód
->
fmh_íåõs
++;

119 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

120 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

121 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

122  
PXT4_QUERY_RANGE_CONTINUE
;

130 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
) {

131 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

132  
PXT4_QUERY_RANGE_ABORT
;

134 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
öfo
->
gfi_√xt_fsblk
,

135 &
agno
, &
˙o
);

136 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
,

137 
	`PXT4_C2B
(
sbi
, 
˙o
),

138 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
,

139 
PXT4_FMR_OWN_UNKNOWN
);

141 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

142 
fmr
.
fmr_physiˇl
 = 
öfo
->
gfi_√xt_fsblk
;

143 
fmr
.
fmr_ow√r
 = 
PXT4_FMR_OWN_UNKNOWN
;

144 
fmr
.
fmr_Àngth
 = 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
;

145 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

146 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

147 i‡(
îr‹
)

148  
îr‹
;

149 
öfo
->
gfi_hód
->
fmh_íåõs
++;

152 i‡(
öfo
->
gfi_œ°
)

153 
out
;

156 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

157  
PXT4_QUERY_RANGE_ABORT
;

159 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
ªc_fsblk
, &
agno
, &
˙o
);

160 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
, 
	`PXT4_C2B
(
sbi
, 
˙o
),

161 
ªc
->
fmr_Àngth
,Ñec->
fmr_ow√r
);

163 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

164 
fmr
.
fmr_physiˇl
 = 
ªc_fsblk
;

165 
fmr
.
fmr_ow√r
 = 
ªc
->fmr_owner;

166 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

167 
fmr
.
fmr_Àngth
 = 
ªc
->fmr_length;

168 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

169 i‡(
îr‹
)

170  
îr‹
;

171 
öfo
->
gfi_hód
->
fmh_íåõs
++;

173 
out
:

174 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

175 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

176 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

177  
PXT4_QUERY_RANGE_CONTINUE
;

178 
	}
}

180 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_fsm≠_√xt_pblk
(
pxt4_fsm≠
 *
fmr
)

182  
fmr
->
fmr_physiˇl
 + fmr->
fmr_Àngth
;

183 
	}
}

186 
	$pxt4_gëfsm≠_d©adev_hñ≥r
(
su≥r_block
 *
sb
,

187 
pxt4_group_t
 
agno
, 
pxt4_gΩblk_t
 
°¨t
,

188 
pxt4_gΩblk_t
 
Àn
, *
¥iv
)

190 
pxt4_fsm≠
 
úec
;

191 
pxt4_gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

192 
pxt4_fsm≠
 *
p
;

193 
pxt4_fsm≠
 *
tmp
;

194 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

195 
pxt4_fsblk_t
 
fsb
;

196 
pxt4_fsblk_t
 
f¶í
;

197 
îr‹
;

199 
fsb
 = (
	`PXT4_C2B
(
sbi
, 
°¨t
Ë+ 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
));

200 
f¶í
 = 
	`PXT4_C2B
(
sbi
, 
Àn
);

203 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

205 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
öfo
->
gfi_œ°‰ì
Ë=
fsb
) {

206 
öfo
->
gfi_œ°‰ì
.
fmr_Àngth
 +
f¶í
;

214 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

215 i‡(
îr‹
)

216  
îr‹
;

217 
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
 = 0;

221 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, &
öfo
->
gfi_mëa_li°
, 
fmr_li°
) {

222 i‡(
p
->
fmr_physiˇl
 +Ö->
fmr_Àngth
 <
öfo
->
gfi_√xt_fsblk
) {

223 
	`li°_dñ
(&
p
->
fmr_li°
);

224 
	`k‰ì
(
p
);

225 } i‡(
p
->
fmr_physiˇl
 < 
fsb
) {

226 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, 
p
);

227 i‡(
îr‹
)

228  
îr‹
;

230 
	`li°_dñ
(&
p
->
fmr_li°
);

231 
	`k‰ì
(
p
);

235 
úec
.
fmr_devi˚
 = 0;

236 
úec
.
fmr_physiˇl
 = 
fsb
;

237 
úec
.
fmr_Àngth
 = 
f¶í
;

238 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_FREE
;

239 
úec
.
fmr_Êags
 = 0;

242 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
úec
) ==

243 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
 + 1)) {

244 
öfo
->
gfi_œ°‰ì
 = 
úec
;

249  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

250 
	}
}

253 
	$pxt4_gëfsm≠_logdev
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
keys
,

254 
pxt4_gëfsm≠_öfo
 *
öfo
)

256 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

257 
pxt4_fsm≠
 
úec
;

260 
öfo
->
gfi_low
 = 
keys
[0];

261 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

263 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

265 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, 0,

266 
öfo
->
gfi_low
.
fmr_physiˇl
,

267 
öfo
->
gfi_low
.
fmr_Àngth
,

268 
öfo
->
gfi_low
.
fmr_ow√r
);

270 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, 0,

271 
öfo
->
gfi_high
.
fmr_physiˇl
,

272 
öfo
->
gfi_high
.
fmr_Àngth
,

273 
öfo
->
gfi_high
.
fmr_ow√r
);

275 i‡(
keys
[0].
fmr_physiˇl
 > 0)

279 
úec
.
fmr_physiˇl
 = 
jou∫Æ
->
j_blk_off£t
;

280 
úec
.
fmr_Àngth
 = 
jou∫Æ
->
j_maxÀn
;

281 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_LOG
;

282 
úec
.
fmr_Êags
 = 0;

284  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

285 
	}
}

288 
ölöe
 
	$pxt4_gëfsm≠_fûl
(
li°_hód
 *
mëa_li°
,

289 
pxt4_fsblk_t
 
fsb
,Öxt4_fsblk_à
Àn
,

290 
uöt64_t
 
ow√r
)

292 
pxt4_fsm≠
 *
fsm
;

294 
fsm
 = 
	`kmÆloc
((*fsm), 
GFP_NOFS
);

295 i‡(!
fsm
)

296  -
ENOMEM
;

297 
fsm
->
fmr_devi˚
 = 0;

298 
fsm
->
fmr_Êags
 = 0;

299 
fsm
->
fmr_physiˇl
 = 
fsb
;

300 
fsm
->
fmr_ow√r
 = 
ow√r
;

301 
fsm
->
fmr_Àngth
 = 
Àn
;

302 
	`li°_add_èû
(&
fsm
->
fmr_li°
, 
mëa_li°
);

305 
	}
}

311 
	$pxt4_gëfsm≠_föd_sb
(
su≥r_block
 *
sb
,

312 
pxt4_group_t
 
agno
,

313 
li°_hód
 *
mëa_li°
)

315 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

316 
pxt4_fsblk_t
 
fsb
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
);

317 
pxt4_fsblk_t
 
Àn
;

318 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

319 
mëagroup
 = 
agno
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

320 
îr‹
;

323 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
agno
)) {

324 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 1, 
PXT4_FMR_OWN_FS
);

325 i‡(
îr‹
)

326  
îr‹
;

327 
fsb
++;

331 
Àn
 = 
	`pxt4_bg_num_gdb
(
sb
, 
agno
);

332 i‡(!
Àn
)

334 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

335 
PXT4_FMR_OWN_GDT
);

336 i‡(
îr‹
)

337  
îr‹
;

338 
fsb
 +
Àn
;

341 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
) {

342 
Àn
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

343 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

344 
PXT4_FMR_OWN_RESV_GDT
);

345 i‡(
îr‹
)

346  
îr‹
;

350 
	}
}

353 
	$pxt4_gëfsm≠_com∑ª
(*
¥iv
,

354 
li°_hód
 *
a
,

355 
li°_hód
 *
b
)

357 
pxt4_fsm≠
 *
Á
;

358 
pxt4_fsm≠
 *
fb
;

360 
Á
 = 
	`c⁄èöî_of
(
a
, 
pxt4_fsm≠
, 
fmr_li°
);

361 
fb
 = 
	`c⁄èöî_of
(
b
, 
pxt4_fsm≠
, 
fmr_li°
);

362 i‡(
Á
->
fmr_physiˇl
 < 
fb
->fmr_physical)

364 i‡(
Á
->
fmr_physiˇl
 > 
fb
->fmr_physical)

367 
	}
}

370 
	$pxt4_gëfsm≠_mîge_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

372 
pxt4_fsm≠
 *
p
;

373 
pxt4_fsm≠
 *
¥ev
 = 
NULL
;

374 
pxt4_fsm≠
 *
tmp
;

376 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

377 i‡(!
¥ev
) {

378 
¥ev
 = 
p
;

382 i‡(
¥ev
->
fmr_ow√r
 =
p
->fmr_owner &&

383 
¥ev
->
fmr_physiˇl
 +Öªv->
fmr_Àngth
 =
p
->fmr_physical) {

384 
¥ev
->
fmr_Àngth
 +
p
->fmr_length;

385 
	`li°_dñ
(&
p
->
fmr_li°
);

386 
	`k‰ì
(
p
);

388 
¥ev
 = 
p
;

390 
	}
}

393 
	$pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

395 
pxt4_fsm≠
 *
p
;

396 
pxt4_fsm≠
 *
tmp
;

398 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

399 
	`li°_dñ
(&
p
->
fmr_li°
);

400 
	`k‰ì
(
p
);

402 
	}
}

405 
	$pxt4_gëfsm≠_föd_fixed_mëad©a
(
su≥r_block
 *
sb
,

406 
li°_hód
 *
mëa_li°
)

408 
pxt4_group_desc
 *
gdp
;

409 
pxt4_group_t
 
agno
;

410 
îr‹
;

412 
	`INIT_LIST_HEAD
(
mëa_li°
);

415 
agno
 = 0;ágnÿ< 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;ágno++) {

416 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
agno
, 
NULL
);

417 i‡(!
gdp
) {

418 
îr‹
 = -
EFSCORRUPTED
;

419 
îr
;

423 
îr‹
 = 
	`pxt4_gëfsm≠_föd_sb
(
sb
, 
agno
, 
mëa_li°
);

424 i‡(
îr‹
)

425 
îr
;

428 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

429 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1,

430 
PXT4_FMR_OWN_BLKBM
);

431 i‡(
îr‹
)

432 
îr
;

435 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

436 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1,

437 
PXT4_FMR_OWN_INOBM
);

438 i‡(
îr‹
)

439 
îr
;

442 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

443 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

444 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
,

445 
PXT4_FMR_OWN_INODES
);

446 i‡(
îr‹
)

447 
îr
;

451 
	`li°_s‹t
(
NULL
, 
mëa_li°
, 
pxt4_gëfsm≠_com∑ª
);

454 
	`pxt4_gëfsm≠_mîge_fixed_mëad©a
(
mëa_li°
);

457 
îr
:

458 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
mëa_li°
);

459  
îr‹
;

460 
	}
}

463 
	$pxt4_gëfsm≠_d©adev
(
su≥r_block
 *
sb
,

464 
pxt4_fsm≠
 *
keys
,

465 
pxt4_gëfsm≠_öfo
 *
öfo
)

467 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

468 
pxt4_fsblk_t
 
°¨t_fsb
;

469 
pxt4_fsblk_t
 
íd_fsb
;

470 
pxt4_fsblk_t
 
bofs
;

471 
pxt4_fsblk_t
 
eofs
;

472 
pxt4_group_t
 
°¨t_ag
;

473 
pxt4_group_t
 
íd_ag
;

474 
pxt4_gΩblk_t
 
fú°_˛u°î
;

475 
pxt4_gΩblk_t
 
œ°_˛u°î
;

476 
îr‹
 = 0;

478 
bofs
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

479 
eofs
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
);

480 i‡(
keys
[0].
fmr_physiˇl
 >
eofs
)

482 i‡(
keys
[0].
fmr_physiˇl
 < 
bofs
)

483 
keys
[0].
fmr_physiˇl
 = 
bofs
;

484 i‡(
keys
[1].
fmr_physiˇl
 >
eofs
)

485 
keys
[1].
fmr_physiˇl
 = 
eofs
 - 1;

486 
°¨t_fsb
 = 
keys
[0].
fmr_physiˇl
;

487 
íd_fsb
 = 
keys
[1].
fmr_physiˇl
;

490 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t_fsb
, &
°¨t_ag
, &
fú°_˛u°î
);

491 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
íd_fsb
, &
íd_ag
, &
œ°_˛u°î
);

498 
öfo
->
gfi_low
 = 
keys
[0];

499 
öfo
->
gfi_low
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
);

500 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

502 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

505 
îr‹
 = 
	`pxt4_gëfsm≠_föd_fixed_mëad©a
(
sb
, &
öfo
->
gfi_mëa_li°
);

506 i‡(
îr‹
)

507 
îr
;

510 
öfo
->
gfi_agno
 = 
°¨t_ag
;

511 
öfo
->
gfi_agno
 <
íd_ag
;

512 
öfo
->
gfi_agno
++) {

517 i‡(
öfo
->
gfi_agno
 =
íd_ag
) {

518 
öfo
->
gfi_high
 = 
keys
[1];

519 
öfo
->
gfi_high
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
,

520 
œ°_˛u°î
);

521 
öfo
->
gfi_high
.
fmr_Àngth
 = 0;

524 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

525 
öfo
->
gfi_low
.
fmr_physiˇl
,

526 
öfo
->
gfi_low
.
fmr_Àngth
,

527 
öfo
->
gfi_low
.
fmr_ow√r
);

529 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

530 
öfo
->
gfi_high
.
fmr_physiˇl
,

531 
öfo
->
gfi_high
.
fmr_Àngth
,

532 
öfo
->
gfi_high
.
fmr_ow√r
);

534 
îr‹
 = 
	`pxt4_mbÆloc_quîy_ønge
(
sb
, 
öfo
->
gfi_agno
,

535 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_low
.
fmr_physiˇl
),

536 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_high
.
fmr_physiˇl
),

537 
pxt4_gëfsm≠_d©adev_hñ≥r
, 
öfo
);

538 i‡(
îr‹
)

539 
îr
;

545 i‡(
öfo
->
gfi_agno
 =
°¨t_ag
)

546 
	`mem£t
(&
öfo
->
gfi_low
, 0, (info->gfi_low));

550 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

551 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

552 i‡(
îr‹
)

553 
îr
;

557 
öfo
->
gfi_œ°
 = 
åue
;

558 
îr‹
 = 
	`pxt4_gëfsm≠_d©adev_hñ≥r
(
sb
, 
íd_ag
, 
œ°_˛u°î
, 0, 
öfo
);

559 i‡(
îr‹
)

560 
îr
;

562 
îr
:

563 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(&
öfo
->
gfi_mëa_li°
);

564  
îr‹
;

565 
	}
}

568 
boﬁ
 
	$pxt4_gëfsm≠_is_vÆid_devi˚
(
su≥r_block
 *
sb
,

569 
pxt4_fsm≠
 *
fm
)

571 i‡(
fm
->
fmr_devi˚
 =0 || fm->fmr_devi˚ =
UINT_MAX
 ||

572 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
))

573  
åue
;

574 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 &&

575 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
))

576  
åue
;

577  
Ál£
;

578 
	}
}

581 
boﬁ
 
	$pxt4_gëfsm≠_check_keys
(
pxt4_fsm≠
 *
low_key
,

582 
pxt4_fsm≠
 *
high_key
)

584 i‡(
low_key
->
fmr_devi˚
 > 
high_key
->fmr_device)

585  
Ál£
;

586 i‡(
low_key
->
fmr_devi˚
 < 
high_key
->fmr_device)

587  
åue
;

589 i‡(
low_key
->
fmr_physiˇl
 > 
high_key
->fmr_physical)

590  
Ál£
;

591 i‡(
low_key
->
fmr_physiˇl
 < 
high_key
->fmr_physical)

592  
åue
;

594 i‡(
low_key
->
fmr_ow√r
 > 
high_key
->fmr_owner)

595  
Ál£
;

596 i‡(
low_key
->
fmr_ow√r
 < 
high_key
->fmr_owner)

597  
åue
;

599  
Ál£
;

600 
	}
}

602 
	#PXT4_GETFSMAP_DEVS
 2

	)

624 
	$pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

625 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
)

627 
pxt4_fsm≠
 
dkeys
[2];

628 
pxt4_gëfsm≠_dev
 
h™dÀrs
[
PXT4_GETFSMAP_DEVS
];

629 
pxt4_gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

630 
i
;

631 
îr‹
 = 0;

633 i‡(
hód
->
fmh_iÊags
 & ~
FMH_IF_VALID
)

634  -
EINVAL
;

635 i‡(!
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[0]) ||

636 !
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[1]))

637  -
EINVAL
;

639 
hód
->
fmh_íåõs
 = 0;

642 
	`mem£t
(
h™dÀrs
, 0, (handlers));

643 
h™dÀrs
[0].
gfd_dev
 = 
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
);

644 
h™dÀrs
[0].
gfd_‚
 = 
pxt4_gëfsm≠_d©adev
;

645 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
) {

646 
h™dÀrs
[1].
gfd_dev
 = 
	`√w_ícode_dev
(

647 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
);

648 
h™dÀrs
[1].
gfd_‚
 = 
pxt4_gëfsm≠_logdev
;

651 
	`s‹t
(
h™dÀrs
, 
PXT4_GETFSMAP_DEVS
, (
pxt4_gëfsm≠_dev
),

652 
pxt4_gëfsm≠_dev_com∑ª
, 
NULL
);

665 
dkeys
[0] = 
hód
->
fmh_keys
[0];

666 
dkeys
[0].
fmr_physiˇl
 +dkeys[0].
fmr_Àngth
;

667 
dkeys
[0].
fmr_ow√r
 = 0;

668 
dkeys
[0].
fmr_Àngth
 = 0;

669 
	`mem£t
(&
dkeys
[1], 0xFF, (
pxt4_fsm≠
));

671 i‡(!
	`pxt4_gëfsm≠_check_keys
(
dkeys
, &
hód
->
fmh_keys
[1]))

672  -
EINVAL
;

674 
öfo
.
gfi_√xt_fsblk
 = 
hód
->
fmh_keys
[0].
fmr_physiˇl
 +

675 
hód
->
fmh_keys
[0].
fmr_Àngth
;

676 
öfo
.
gfi_f‹m©ãr
 = 
f‹m©ãr
;

677 
öfo
.
gfi_f‹m©_¨g
 = 
¨g
;

678 
öfo
.
gfi_hód
 = 
hód
;

681 
i
 = 0; i < 
PXT4_GETFSMAP_DEVS
; i++) {

683 i‡(!
h™dÀrs
[
i
].
gfd_‚
)

685 i‡(
hód
->
fmh_keys
[0].
fmr_devi˚
 > 
h™dÀrs
[
i
].
gfd_dev
)

687 i‡(
hód
->
fmh_keys
[1].
fmr_devi˚
 < 
h™dÀrs
[
i
].
gfd_dev
)

697 i‡(
h™dÀrs
[
i
].
gfd_dev
 =
hód
->
fmh_keys
[1].
fmr_devi˚
)

698 
dkeys
[1] = 
hód
->
fmh_keys
[1];

699 i‡(
h™dÀrs
[
i
].
gfd_dev
 > 
hód
->
fmh_keys
[0].
fmr_devi˚
)

700 
	`mem£t
(&
dkeys
[0], 0, (
pxt4_fsm≠
));

702 
öfo
.
gfi_dev
 = 
h™dÀrs
[
i
].
gfd_dev
;

703 
öfo
.
gfi_œ°
 = 
Ál£
;

704 
öfo
.
gfi_agno
 = -1;

705 
îr‹
 = 
h™dÀrs
[
i
].
	`gfd_‚
(
sb
, 
dkeys
, &
öfo
);

706 i‡(
îr‹
)

708 
öfo
.
gfi_√xt_fsblk
 = 0;

711 
hód
->
fmh_oÊags
 = 
FMH_OF_DEV_T
;

712  
îr‹
;

713 
	}
}

	@fsmap.h

7 #i‚de‡
__PXT4_FSMAP_H__


8 
	#__PXT4_FSMAP_H__


	)

10 
	gfsm≠
;

13 
	spxt4_fsm≠
 {

14 
li°_hód
 
	mfmr_li°
;

15 
dev_t
 
	mfmr_devi˚
;

16 
uöt32_t
 
	mfmr_Êags
;

17 
uöt64_t
 
	mfmr_physiˇl
;

18 
uöt64_t
 
	mfmr_ow√r
;

19 
uöt64_t
 
	mfmr_Àngth
;

22 
	spxt4_fsm≠_hód
 {

23 
uöt32_t
 
	mfmh_iÊags
;

24 
uöt32_t
 
	mfmh_oÊags
;

25 
	mfmh_cou¡
;

26 
	mfmh_íåõs
;

28 
pxt4_fsm≠
 
	mfmh_keys
[2];

31 
pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

32 
pxt4_fsm≠
 *
§c
);

33 
pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

34 
fsm≠
 *
§c
);

37 (*
	tpxt4_fsm≠_f‹m©_t
)(
	tpxt4_fsm≠
 *, *);

39 
	`pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

40 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
);

42 
	#PXT4_QUERY_RANGE_ABORT
 1

	)

43 
	#PXT4_QUERY_RANGE_CONTINUE
 0

	)

46 
	#PXT4_FMR_OWN_FREE
 
FMR_OWN_FREE


	)

47 
	#PXT4_FMR_OWN_UNKNOWN
 
FMR_OWN_UNKNOWN


	)

48 
	#PXT4_FMR_OWN_FS
 
	`FMR_OWNER
('X', 1Ë

	)

49 
	#PXT4_FMR_OWN_LOG
 
	`FMR_OWNER
('X', 2Ë

	)

50 
	#PXT4_FMR_OWN_INODES
 
	`FMR_OWNER
('X', 5Ë

	)

51 
	#PXT4_FMR_OWN_GDT
 
	`FMR_OWNER
('f', 1Ë

	)

52 
	#PXT4_FMR_OWN_RESV_GDT
 
	`FMR_OWNER
('f', 2Ë

	)

53 
	#PXT4_FMR_OWN_BLKBM
 
	`FMR_OWNER
('f', 3Ë

	)

54 
	#PXT4_FMR_OWN_INOBM
 
	`FMR_OWNER
('f', 4Ë

	)

	@fsync.c

26 
	~<löux/time.h
>

27 
	~<löux/fs.h
>

28 
	~<löux/sched.h
>

29 
	~<löux/wrôeback.h
>

30 
	~<löux/blkdev.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

35 
	~<åa˚/evíts/pxt4.h
>

45 
	$pxt4_sync_∑ª¡
(
öode
 *inode)

47 
díåy
 *díåy, *
√xt
;

48 
ªt
 = 0;

50 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

52 
díåy
 = 
	`d_föd_™y_Æüs
(
öode
);

53 i‡(!
díåy
)

55 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
)) {

56 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

58 
√xt
 = 
	`dgë_∑ª¡
(
díåy
);

59 
	`dput
(
díåy
);

60 
díåy
 = 
√xt
;

61 
öode
 = 
díåy
->
d_öode
;

70 
ªt
 = 
	`sync_m≠pög_buf„rs
(
öode
->
i_m≠pög
);

71 i‡(
ªt
)

73 
ªt
 = 
	`sync_öode_mëad©a
(
öode
, 1);

74 i‡(
ªt
)

77 
	`dput
(
díåy
);

78  
ªt
;

79 
	}
}

93 
	$pxt4_sync_fûe
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

95 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

96 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

97 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

98 
ªt
 = 0, 
îr
;

99 
tid_t
 
commô_tid
;

100 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

102 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

103  -
EIO
;

105 
	`J_ASSERT
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
);

107 
	`åa˚_pxt4_sync_fûe_íãr
(
fûe
, 
d©async
);

109 i‡(
	`sb_rd⁄ly
(
öode
->
i_sb
)) {

111 
	`smp_rmb
();

112 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

113 
ªt
 = -
EROFS
;

114 
out
;

117 i‡(!
jou∫Æ
) {

118 
ªt
 = 
	`__gíîic_fûe_fsync
(
fûe
, 
°¨t
, 
íd
, 
d©async
);

119 i‡(!
ªt
)

120 
ªt
 = 
	`pxt4_sync_∑ª¡
(
öode
);

121 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
BARRIER
))

122 
issue_Êush
;

123 
out
;

126 
ªt
 = 
	`fûe_wrôe_™d_waô_ønge
(
fûe
, 
°¨t
, 
íd
);

127 i‡(
ªt
)

128  
ªt
;

143 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

144 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

145 
out
;

148 
commô_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :Éi->
i_sync_tid
;

149 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

150 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
jou∫Æ
, 
commô_tid
))

151 
√eds_b¨rõr
 = 
åue
;

152 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

153 i‡(
√eds_b¨rõr
) {

154 
issue_Êush
:

155 
îr
 = 
	`blkdev_issue_Êush
(
öode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

156 i‡(!
ªt
)

157 
ªt
 = 
îr
;

159 
out
:

160 
îr
 = 
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

161 i‡(
ªt
 == 0)

162 
ªt
 = 
îr
;

163 
	`åa˚_pxt4_sync_fûe_exô
(
öode
, 
ªt
);

164  
ªt
;

165 
	}
}

	@hash.c

8 
	~<löux/fs.h
>

9 
	~<löux/unicode.h
>

10 
	~<löux/compûî.h
>

11 
	~<löux/bô›s.h
>

12 
	~"pxt4.h
"

14 
	#DELTA
 0x9E3779B9

	)

16 
	$TEA_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[])

18 
__u32
 
sum
 = 0;

19 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

20 
__u32
 
a
 = 
ö
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

21 
n
 = 16;

24 
sum
 +
DELTA
;

25 
b0
 +((
b1
 << 4)+
a
Ë^ (b1+
sum
Ë^ ((b1 >> 5)+
b
);

26 
b1
 +((
b0
 << 4)+
c
Ë^ (b0+
sum
Ë^ ((b0 >> 5)+
d
);

27 } --
n
);

29 
buf
[0] +
b0
;

30 
buf
[1] +
b1
;

31 
	}
}

34 
	#F
(
x
, 
y
, 
z
Ë((zË^ ((xË& ((yË^ (z))))

	)

35 
	#G
(
x
, 
y
, 
z
Ë(((xË& (y)Ë+ (((xË^ (y)Ë& (z)))

	)

36 
	#H
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

44 
	#ROUND
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
s
) \

45 (
a
 +
	`f
(
b
, 
c
, 
d
Ë+ 
x
,á = 
	`rﬁ32
◊, 
s
))

	)

46 
	#K1
 0

	)

47 
	#K2
 013240474631UL

	)

48 
	#K3
 015666365641UL

	)

53 
__u32
 
	$hÆf_md4_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[8])

55 
__u32
 
a
 = 
buf
[0], 
b
 = buf[1], 
c
 = buf[2], 
d
 = buf[3];

58 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K1
, 3);

59 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[1] + 
K1
, 7);

60 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K1
, 11);

61 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[3] + 
K1
, 19);

62 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[4] + 
K1
, 3);

63 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K1
, 7);

64 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[6] + 
K1
, 11);

65 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K1
, 19);

68 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K2
, 3);

69 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[3] + 
K2
, 5);

70 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[5] + 
K2
, 9);

71 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K2
, 13);

72 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K2
, 3);

73 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[2] + 
K2
, 5);

74 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[4] + 
K2
, 9);

75 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K2
, 13);

78 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[3] + 
K3
, 3);

79 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[7] + 
K3
, 9);

80 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K3
, 11);

81 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K3
, 15);

82 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K3
, 3);

83 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K3
, 9);

84 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[0] + 
K3
, 11);

85 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[4] + 
K3
, 15);

87 
buf
[0] +
a
;

88 
buf
[1] +
b
;

89 
buf
[2] +
c
;

90 
buf
[3] +
d
;

92  
buf
[1];

93 
	}
}

94 #unde‡
ROUND


95 #unde‡
K1


96 #unde‡
K2


97 #unde‡
K3


98 #unde‡
F


99 #unde‡
G


100 #unde‡
H


103 
__u32
 
	$dx_hack_hash_unsig√d
(c⁄° *
«me
, 
Àn
)

105 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

106 c⁄° *
u˝
 = (c⁄° *Ë
«me
;

108 
Àn
--) {

109 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
u˝
++) * 7152373));

111 i‡(
hash
 & 0x80000000)

112 
hash
 -= 0x7fffffff;

113 
hash1
 = 
hash0
;

114 
hash0
 = 
hash
;

116  
hash0
 << 1;

117 
	}
}

119 
__u32
 
	$dx_hack_hash_sig√d
(c⁄° *
«me
, 
Àn
)

121 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

122 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
«me
;

124 
Àn
--) {

125 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
s˝
++) * 7152373));

127 i‡(
hash
 & 0x80000000)

128 
hash
 -= 0x7fffffff;

129 
hash1
 = 
hash0
;

130 
hash0
 = 
hash
;

132  
hash0
 << 1;

133 
	}
}

135 
	$°r2hashbuf_sig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

137 
__u32
 
∑d
, 
vÆ
;

138 
i
;

139 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
msg
;

141 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

142 
∑d
 |=Öad << 16;

144 
vÆ
 = 
∑d
;

145 i‡(
Àn
 > 
num
*4)

146 
Àn
 = 
num
 * 4;

147 
i
 = 0; i < 
Àn
; i++) {

148 
vÆ
 = ((Ë
s˝
[
i
]) + (val << 8);

149 i‡((
i
 % 4) == 3) {

150 *
buf
++ = 
vÆ
;

151 
vÆ
 = 
∑d
;

152 
num
--;

155 i‡(--
num
 >= 0)

156 *
buf
++ = 
vÆ
;

157 --
num
 >= 0)

158 *
buf
++ = 
∑d
;

159 
	}
}

161 
	$°r2hashbuf_unsig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

163 
__u32
 
∑d
, 
vÆ
;

164 
i
;

165 c⁄° *
u˝
 = (c⁄° *Ë
msg
;

167 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

168 
∑d
 |=Öad << 16;

170 
vÆ
 = 
∑d
;

171 i‡(
Àn
 > 
num
*4)

172 
Àn
 = 
num
 * 4;

173 
i
 = 0; i < 
Àn
; i++) {

174 
vÆ
 = ((Ë
u˝
[
i
]) + (val << 8);

175 i‡((
i
 % 4) == 3) {

176 *
buf
++ = 
vÆ
;

177 
vÆ
 = 
∑d
;

178 
num
--;

181 i‡(--
num
 >= 0)

182 *
buf
++ = 
vÆ
;

183 --
num
 >= 0)

184 *
buf
++ = 
∑d
;

185 
	}
}

200 
	$__pxt4fs_dúhash
(c⁄° *
«me
, 
Àn
,

201 
dx_hash_öfo
 *
höfo
)

203 
__u32
 
hash
;

204 
__u32
 
mö‹_hash
 = 0;

205 c⁄° *
p
;

206 
i
;

207 
__u32
 
ö
[8], 
buf
[4];

208 (*
°r2hashbuf
)(c⁄° *, , 
__u32
 *, ) =

209 
°r2hashbuf_sig√d
;

212 
buf
[0] = 0x67452301;

213 
buf
[1] = 0xefcdab89;

214 
buf
[2] = 0x98badcfe;

215 
buf
[3] = 0x10325476;

218 i‡(
höfo
->
£ed
) {

219 
i
 = 0; i < 4; i++) {

220 i‡(
höfo
->
£ed
[
i
]) {

221 
	`mem˝y
(
buf
, 
höfo
->
£ed
, (buf));

227 
höfo
->
hash_vîsi⁄
) {

228 
DX_HASH_LEGACY_UNSIGNED
:

229 
hash
 = 
	`dx_hack_hash_unsig√d
(
«me
, 
Àn
);

231 
DX_HASH_LEGACY
:

232 
hash
 = 
	`dx_hack_hash_sig√d
(
«me
, 
Àn
);

234 
DX_HASH_HALF_MD4_UNSIGNED
:

235 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

237 
DX_HASH_HALF_MD4
:

238 
p
 = 
«me
;

239 
Àn
 > 0) {

240 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 8);

241 
	`hÆf_md4_å™sf‹m
(
buf
, 
ö
);

242 
Àn
 -= 32;

243 
p
 += 32;

245 
mö‹_hash
 = 
buf
[2];

246 
hash
 = 
buf
[1];

248 
DX_HASH_TEA_UNSIGNED
:

249 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

251 
DX_HASH_TEA
:

252 
p
 = 
«me
;

253 
Àn
 > 0) {

254 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 4);

255 
	`TEA_å™sf‹m
(
buf
, 
ö
);

256 
Àn
 -= 16;

257 
p
 += 16;

259 
hash
 = 
buf
[0];

260 
mö‹_hash
 = 
buf
[1];

263 
höfo
->
hash
 = 0;

266 
hash
 = hash & ~1;

267 i‡(
hash
 =(
PXT4_HTREE_EOF_32BIT
 << 1))

268 
hash
 = (
PXT4_HTREE_EOF_32BIT
 - 1) << 1;

269 
höfo
->
hash
 = hash;

270 
höfo
->
mö‹_hash
 = minor_hash;

272 
	}
}

274 
	$pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

275 
dx_hash_öfo
 *
höfo
)

277 #ifde‡
CONFIG_UNICODE


278 c⁄° 
unicode_m≠
 *
um
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
;

279 
r
, 
dÀn
;

280 *
buff
;

281 
q°r
 q°∏{.
«me
 =Çame, .
Àn
 =Üen };

283 i‡(
Àn
 && 
	`IS_CASEFOLDED
(
dú
Ë&& 
um
) {

284 
buff
 = 
	`kzÆloc
((Ë* 
PATH_MAX
, 
GFP_KERNEL
);

285 i‡(!
buff
)

286  -
ENOMEM
;

288 
dÀn
 = 
	`utf8_ˇ£fﬁd
(
um
, &
q°r
, 
buff
, 
PATH_MAX
);

289 i‡(
dÀn
 < 0) {

290 
	`k‰ì
(
buff
);

291 
›aque_£q
;

294 
r
 = 
	`__pxt4fs_dúhash
(
buff
, 
dÀn
, 
höfo
);

296 
	`k‰ì
(
buff
);

297  
r
;

299 
›aque_£q
:

301  
	`__pxt4fs_dúhash
(
«me
, 
Àn
, 
höfo
);

302 
	}
}

	@ialloc.c

16 
	~<löux/time.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/°©.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/quŸa›s.h
>

21 
	~<löux/buf„r_hód.h
>

22 
	~<löux/øndom.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/blkdev.h
>

25 
	~<löux/¸ed.h
>

27 
	~<asm/byã‹dî.h
>

29 
	~"pxt4.h
"

30 
	~"pxt4_jbd3.h
"

31 
	~"x©å.h
"

32 
	~"a˛.h
"

34 
	~<åa˚/evíts/pxt4.h
>

55 
	$pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
)

57 
i
;

59 i‡(
°¨t_bô
 >
íd_bô
)

62 
	`pxt4_debug
("m¨kÉnd bô†+%dÅhrough +%d u£d\n", 
°¨t_bô
, 
íd_bô
);

63 
i
 = 
°¨t_bô
; i < ((start_bit + 7) & ~7UL); i++)

64 
	`pxt4_£t_bô
(
i
, 
bôm≠
);

65 i‡(
i
 < 
íd_bô
)

66 
	`mem£t
(
bôm≠
 + (
i
 >> 3), 0xff, (
íd_bô
 - i) >> 3);

67 
	}
}

69 
	$pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
)

71 i‡(
u±od©e
) {

72 
	`£t_buf„r_u±od©e
(
bh
);

73 
	`£t_bôm≠_u±od©e
(
bh
);

75 
	`u∆ock_buf„r
(
bh
);

76 
	`put_bh
(
bh
);

77 
	}
}

79 
	$pxt4_vÆid©e_öode_bôm≠
(
su≥r_block
 *
sb
,

80 
pxt4_group_desc
 *
desc
,

81 
pxt4_group_t
 
block_group
,

82 
buf„r_hód
 *
bh
)

84 
pxt4_fsblk_t
 
blk
;

85 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

87 i‡(
	`buf„r_vîifõd
(
bh
))

89 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

90  -
EFSCORRUPTED
;

92 
	`pxt4_lock_group
(
sb
, 
block_group
);

93 i‡(
	`buf„r_vîifõd
(
bh
))

94 
vîifõd
;

95 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

96 i‡(!
	`pxt4_öode_bôm≠_csum_vîify
(
sb
, 
block_group
, 
desc
, 
bh
,

97 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8)) {

98 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

99 
	`pxt4_îr‹
(
sb
, "Corrupt inode bitmap - block_group = %u, "

100 "öode_bôm≠ = %Œu", 
block_group
, 
blk
);

101 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

102 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

103  -
EFSBADCRC
;

105 
	`£t_buf„r_vîifõd
(
bh
);

106 
vîifõd
:

107 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

109 
	}
}

117 
buf„r_hód
 *

118 
	$pxt4_ªad_öode_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

120 
pxt4_group_desc
 *
desc
;

121 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

122 
buf„r_hód
 *
bh
 = 
NULL
;

123 
pxt4_fsblk_t
 
bôm≠_blk
;

124 
îr
;

126 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

127 i‡(!
desc
)

128  
	`ERR_PTR
(-
EFSCORRUPTED
);

130 
bôm≠_blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

131 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

132 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

133 
	`pxt4_îr‹
(
sb
, "Invalid inode bitmap blk %llu in "

134 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

135 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

136 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

137  
	`ERR_PTR
(-
EFSCORRUPTED
);

139 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

140 i‡(
	`u∆ikñy
(!
bh
)) {

141 
	`pxt4_w¨nög
(
sb
, "CannotÑead inode bitmap - "

143 
block_group
, 
bôm≠_blk
);

144  
	`ERR_PTR
(-
ENOMEM
);

146 i‡(
	`bôm≠_u±od©e
(
bh
))

147 
vîify
;

149 
	`lock_buf„r
(
bh
);

150 i‡(
	`bôm≠_u±od©e
(
bh
)) {

151 
	`u∆ock_buf„r
(
bh
);

152 
vîify
;

155 
	`pxt4_lock_group
(
sb
, 
block_group
);

156 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

157 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
))) {

158 i‡(
block_group
 == 0) {

159 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

160 
	`u∆ock_buf„r
(
bh
);

161 
	`pxt4_îr‹
(
sb
, "Inode bitmap for bg 0 marked "

163 
îr
 = -
EFSCORRUPTED
;

164 
out
;

166 
	`mem£t
(
bh
->
b_d©a
, 0, (
	`PXT4_INODES_PER_GROUP
(
sb
) + 7) / 8);

167 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

168 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

169 
	`£t_bôm≠_u±od©e
(
bh
);

170 
	`£t_buf„r_u±od©e
(
bh
);

171 
	`£t_buf„r_vîifõd
(
bh
);

172 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

173 
	`u∆ock_buf„r
(
bh
);

174  
bh
;

176 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

178 i‡(
	`buf„r_u±od©e
(
bh
)) {

183 
	`£t_bôm≠_u±od©e
(
bh
);

184 
	`u∆ock_buf„r
(
bh
);

185 
vîify
;

190 
	`åa˚_pxt4_lﬂd_öode_bôm≠
(
sb
, 
block_group
);

191 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

192 
	`gë_bh
(
bh
);

193 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

194 
	`waô_⁄_buf„r
(
bh
);

195 i‡(!
	`buf„r_u±od©e
(
bh
)) {

196 
	`put_bh
(
bh
);

197 
	`pxt4_îr‹
(
sb
, "CannotÑead inode bitmap - "

199 
block_group
, 
bôm≠_blk
);

200 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

201 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

202  
	`ERR_PTR
(-
EIO
);

205 
vîify
:

206 
îr
 = 
	`pxt4_vÆid©e_öode_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

207 i‡(
îr
)

208 
out
;

209  
bh
;

210 
out
:

211 
	`put_bh
(
bh
);

212  
	`ERR_PTR
(
îr
);

213 
	}
}

231 
	$pxt4_‰ì_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

233 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

234 
is_dúe˘‹y
;

235 
öo
;

236 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

237 
buf„r_hód
 *
bh2
;

238 
pxt4_group_t
 
block_group
;

239 
bô
;

240 
pxt4_group_desc
 *
gdp
;

241 
pxt4_su≥r_block
 *
es
;

242 
pxt4_sb_öfo
 *
sbi
;

243 
Áèl
 = 0, 
îr
, 
cou¡
, 
˛óªd
;

244 
pxt4_group_öfo
 *
gΩ
;

246 i‡(!
sb
) {

247 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d: inode on "

248 "n⁄exi°íàdevi˚\n", 
__func__
, 
__LINE__
);

251 i‡(
	`©omic_ªad
(&
öode
->
i_cou¡
) > 1) {

252 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: count=%d",

253 
__func__
, 
__LINE__
, 
öode
->
i_öo
,

254 
	`©omic_ªad
(&
öode
->
i_cou¡
));

257 i‡(
öode
->
i_∆ök
) {

258 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu:Çlink=%d\n",

259 
__func__
, 
__LINE__
, 
öode
->
i_öo
, inode->
i_∆ök
);

262 
sbi
 = 
	`PXT4_SB
(
sb
);

264 
öo
 = 
öode
->
i_öo
;

265 
	`pxt4_debug
("‰ìög inodê%lu\n", 
öo
);

266 
	`åa˚_pxt4_‰ì_öode
(
öode
);

268 
	`dquŸ_öôülize
(
öode
);

269 
	`dquŸ_‰ì_öode
(
öode
);

271 
is_dúe˘‹y
 = 
	`S_ISDIR
(
öode
->
i_mode
);

274 
	`pxt4_˛ór_öode
(
öode
);

276 
es
 = 
sbi
->
s_es
;

277 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

278 
	`pxt4_îr‹
(
sb
, "ª£rved o∏n⁄exi°íàöodê%lu", 
öo
);

279 
îr‹_ªtu∫
;

281 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

282 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

283 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

285 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

286 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

287 
Áèl
 = 
	`PTR_ERR
(
bôm≠_bh
);

288 
bôm≠_bh
 = 
NULL
;

289 
îr‹_ªtu∫
;

291 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))) {

292 
Áèl
 = -
EFSCORRUPTED
;

293 
îr‹_ªtu∫
;

296 
	`BUFFER_TRACE
(
bôm≠_bh
, "get_write_access");

297 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

298 i‡(
Áèl
)

299 
îr‹_ªtu∫
;

301 
Áèl
 = -
ESRCH
;

302 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
bh2
);

303 i‡(
gdp
) {

304 
	`BUFFER_TRACE
(
bh2
, "get_write_access");

305 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh2
);

307 
	`pxt4_lock_group
(
sb
, 
block_group
);

308 
˛óªd
 = 
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
bôm≠_bh
->
b_d©a
);

309 i‡(
Áèl
 || !
˛óªd
) {

310 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

311 
out
;

314 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) + 1;

315 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
cou¡
);

316 i‡(
is_dúe˘‹y
) {

317 
cou¡
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
) - 1;

318 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
cou¡
);

319 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_dús_cou¡î
);

321 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
,

322 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

323 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

324 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

326 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_‰ìöodes_cou¡î
);

327 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

328 
Êex_groups
 *
fg
;

330 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

331 
	`pxt4_Êex_group
(
sbi
, 
block_group
));

332 
	`©omic_öc
(&
fg
->
‰ì_öodes
);

333 i‡(
is_dúe˘‹y
)

334 
	`©omic_dec
(&
fg
->
u£d_dús
);

336 
	`BUFFER_TRACE
(
bh2
, "callÖxt4_handle_dirty_metadata");

337 
Áèl
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh2
);

338 
out
:

339 i‡(
˛óªd
) {

340 
	`BUFFER_TRACE
(
bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

341 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

342 i‡(!
Áèl
)

343 
Áèl
 = 
îr
;

345 
	`pxt4_îr‹
(
sb
, "bôáÃódy cÀ¨ed f‹ inodê%lu", 
öo
);

346 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

347 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

350 
îr‹_ªtu∫
:

351 
	`bªl£
(
bôm≠_bh
);

352 
	`pxt4_°d_îr‹
(
sb
, 
Áèl
);

353 
	}
}

355 
	s‹lov_°©s
 {

356 
__u64
 
	m‰ì_˛u°îs
;

357 
__u32
 
	m‰ì_öodes
;

358 
__u32
 
	mu£d_dús
;

366 
	$gë_‹lov_°©s
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
g
,

367 
Êex_size
, 
‹lov_°©s
 *
°©s
)

369 
pxt4_group_desc
 *
desc
;

371 i‡(
Êex_size
 > 1) {

372 
Êex_groups
 *
fg
 = 
	`sbi_¨øy_rcu_dîef
(
	`PXT4_SB
(
sb
),

373 
s_Êex_groups
, 
g
);

374 
°©s
->
‰ì_öodes
 = 
	`©omic_ªad
(&
fg
->free_inodes);

375 
°©s
->
‰ì_˛u°îs
 = 
	`©omic64_ªad
(&
fg
->free_clusters);

376 
°©s
->
u£d_dús
 = 
	`©omic_ªad
(&
fg
->used_dirs);

380 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

381 i‡(
desc
) {

382 
°©s
->
‰ì_öodes
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

383 
°©s
->
‰ì_˛u°îs
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

384 
°©s
->
u£d_dús
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
desc
);

386 
°©s
->
‰ì_öodes
 = 0;

387 
°©s
->
‰ì_˛u°îs
 = 0;

388 
°©s
->
u£d_dús
 = 0;

390 
	}
}

413 
	$föd_group_‹lov
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

414 
pxt4_group_t
 *
group
, 
umode_t
 
mode
,

415 c⁄° 
q°r
 *qstr)

417 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

418 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

419 
pxt4_group_t
 
ªÆ_ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

420 
öodes_≥r_group
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

421 
‰ìi
, 
ave‰ìi
, 
gΩ_‰ì
;

422 
pxt4_fsblk_t
 
‰ìb
, 
ave‰ìc
;

423 
ndús
;

424 
max_dús
, 
mö_öodes
;

425 
pxt4_gΩblk_t
 
mö_˛u°îs
;

426 
pxt4_group_t
 
i
, 
gΩ
, 
g
, 
ngroups
;

427 
pxt4_group_desc
 *
desc
;

428 
‹lov_°©s
 
°©s
;

429 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

430 
dx_hash_öfo
 
höfo
;

432 
ngroups
 = 
ªÆ_ngroups
;

433 i‡(
Êex_size
 > 1) {

434 
ngroups
 = (
ªÆ_ngroups
 + 
Êex_size
 - 1) >>

435 
sbi
->
s_log_groups_≥r_Êex
;

436 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

439 
‰ìi
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

440 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

441 
‰ìb
 = 
	`PXT4_C2B
(
sbi
,

442 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

443 
ave‰ìc
 = 
‰ìb
;

444 
	`do_div
(
ave‰ìc
, 
ngroups
);

445 
ndús
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dús_cou¡î
);

447 i‡(
	`S_ISDIR
(
mode
) &&

448 ((
∑ª¡
 =
	`d_öode
(
sb
->
s_roŸ
)) ||

449 (
	`pxt4_ã°_öode_Êag
(
∑ª¡
, 
PXT4_INODE_TOPDIR
)))) {

450 
be°_ndú
 = 
öodes_≥r_group
;

451 
ªt
 = -1;

453 i‡(
q°r
) {

454 
höfo
.
hash_vîsi⁄
 = 
DX_HASH_HALF_MD4
;

455 
höfo
.
£ed
 = 
sbi
->
s_hash_£ed
;

456 
	`pxt4fs_dúhash
(
∑ª¡
, 
q°r
->
«me
, q°r->
Àn
, &
höfo
);

457 
gΩ
 = 
höfo
.
hash
;

459 
gΩ
 = 
	`¥™dom_u32
();

460 
∑ª¡_group
 = ()
gΩ
 % 
ngroups
;

461 
i
 = 0; i < 
ngroups
; i++) {

462 
g
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

463 
	`gë_‹lov_°©s
(
sb
, 
g
, 
Êex_size
, &
°©s
);

464 i‡(!
°©s
.
‰ì_öodes
)

466 i‡(
°©s
.
u£d_dús
 >
be°_ndú
)

468 i‡(
°©s
.
‰ì_öodes
 < 
ave‰ìi
)

470 i‡(
°©s
.
‰ì_˛u°îs
 < 
ave‰ìc
)

472 
gΩ
 = 
g
;

473 
ªt
 = 0;

474 
be°_ndú
 = 
°©s
.
u£d_dús
;

476 i‡(
ªt
)

477 
ÁŒback
;

478 
found_Êex_bg
:

479 i‡(
Êex_size
 == 1) {

480 *
group
 = 
gΩ
;

491 
gΩ
 *
Êex_size
;

492 
i
 = 0; i < 
Êex_size
; i++) {

493 i‡(
gΩ
+
i
 >
ªÆ_ngroups
)

495 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
+
i
, 
NULL
);

496 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

497 *
group
 = 
gΩ
+
i
;

501 
ÁŒback
;

504 
max_dús
 = 
ndús
 / 
ngroups
 + 
öodes_≥r_group
 / 16;

505 
mö_öodes
 = 
ave‰ìi
 - 
öodes_≥r_group
*
Êex_size
 / 4;

506 i‡(
mö_öodes
 < 1)

507 
mö_öodes
 = 1;

508 
mö_˛u°îs
 = 
ave‰ìc
 - 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)*
Êex_size
 / 4;

514 i‡(
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

515 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

516 i‡(
Êex_size
 > 1)

517 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

520 
i
 = 0; i < 
ngroups
; i++) {

521 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

522 
	`gë_‹lov_°©s
(
sb
, 
gΩ
, 
Êex_size
, &
°©s
);

523 i‡(
°©s
.
u£d_dús
 >
max_dús
)

525 i‡(
°©s
.
‰ì_öodes
 < 
mö_öodes
)

527 i‡(
°©s
.
‰ì_˛u°îs
 < 
mö_˛u°îs
)

529 
found_Êex_bg
;

532 
ÁŒback
:

533 
ngroups
 = 
ªÆ_ngroups
;

534 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

535 
ÁŒback_ªåy
:

536 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

537 
i
 = 0; i < 
ngroups
; i++) {

538 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

539 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
, 
NULL
);

540 i‡(
desc
) {

541 
gΩ_‰ì
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

542 i‡(
gΩ_‰ì
 && gΩ_‰ì >
ave‰ìi
) {

543 *
group
 = 
gΩ
;

549 i‡(
ave‰ìi
) {

554 
ave‰ìi
 = 0;

555 
ÁŒback_ªåy
;

559 
	}
}

561 
	$föd_group_Ÿhî
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

562 
pxt4_group_t
 *
group
, 
umode_t
 
mode
)

564 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

565 
pxt4_group_t
 
i
, 
œ°
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

566 
pxt4_group_desc
 *
desc
;

567 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
sb
));

576 i‡(
Êex_size
 > 1) {

577 
ªåy
 = 0;

579 
åy_agaö
:

580 
∑ª¡_group
 &~(
Êex_size
-1);

581 
œ°
 = 
∑ª¡_group
 + 
Êex_size
;

582 i‡(
œ°
 > 
ngroups
)

583 
œ°
 = 
ngroups
;

584 
i
 = 
∑ª¡_group
; i < 
œ°
; i++) {

585 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

586 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

587 *
group
 = 
i
;

591 i‡(!
ªåy
 && 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

592 
ªåy
 = 1;

593 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

594 
åy_agaö
;

601 *
group
 = 
∑ª¡_group
 + 
Êex_size
;

602 i‡(*
group
 > 
ngroups
)

603 *
group
 = 0;

604  
	`föd_group_‹lov
(
sb
, 
∑ª¡
, 
group
, 
mode
, 
NULL
);

610 *
group
 = 
∑ª¡_group
;

611 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

612 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

613 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

625 *
group
 = (*grou∞+ 
∑ª¡
->
i_öo
Ë% 
ngroups
;

631 
i
 = 1; i < 
ngroups
; i <<= 1) {

632 *
group
 +
i
;

633 i‡(*
group
 >
ngroups
)

634 *
group
 -
ngroups
;

635 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

636 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

637 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

645 *
group
 = 
∑ª¡_group
;

646 
i
 = 0; i < 
ngroups
; i++) {

647 i‡(++*
group
 >
ngroups
)

648 *
group
 = 0;

649 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

650 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc))

655 
	}
}

663 
	#RECENTCY_MIN
 60

	)

664 
	#RECENTCY_DIRTY
 300

	)

666 
	$ª˚¡ly_dñëed
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
öo
)

668 
pxt4_group_desc
 *
gdp
;

669 
pxt4_öode
 *
øw_öode
;

670 
buf„r_hód
 *
bh
;

671 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

672 
off£t
, 
ªt
 = 0;

673 
ª˚¡cy
 = 
RECENTCY_MIN
;

674 
u32
 
dtime
, 
now
;

676 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

677 i‡(
	`u∆ikñy
(!
gdp
))

680 
bh
 = 
	`sb_föd_gë_block
(
sb
, 
	`pxt4_öode_èbÀ
(sb, 
gdp
) +

681 (
öo
 / 
öodes_≥r_block
));

682 i‡(!
bh
 || !
	`buf„r_u±od©e
(bh))

687 
out
;

689 
off£t
 = (
öo
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

690 
øw_öode
 = (
pxt4_öode
 *Ë(
bh
->
b_d©a
 + 
off£t
);

696 
dtime
 = 
	`À32_to_˝u
(
øw_öode
->
i_dtime
);

697 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

698 i‡(
	`buf„r_dúty
(
bh
))

699 
ª˚¡cy
 +
RECENTCY_DIRTY
;

701 i‡(
dtime
 && 
	`time_bef‹e32
(dtime, 
now
) &&

702 
	`time_bef‹e32
(
now
, 
dtime
 + 
ª˚¡cy
))

703 
ªt
 = 1;

704 
out
:

705 
	`bªl£
(
bh
);

706  
ªt
;

707 
	}
}

709 
	$föd_öode_bô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

710 
buf„r_hód
 *
bôm≠
, *
öo
)

712 
√xt
:

713 *
öo
 = 
	`pxt4_föd_√xt_zîo_bô
((*)

714 
bôm≠
->
b_d©a
,

715 
	`PXT4_INODES_PER_GROUP
(
sb
), *
öo
);

716 i‡(*
öo
 >
	`PXT4_INODES_PER_GROUP
(
sb
))

719 i‡((
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 =
NULL
) &&

720 
	`ª˚¡ly_dñëed
(
sb
, 
group
, *
öo
)) {

721 *
öo
 = *ino + 1;

722 i‡(*
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

723 
√xt
;

728 
	}
}

740 
öode
 *
	$__pxt4_√w_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

741 
umode_t
 
mode
, c⁄° 
q°r
 *qstr,

742 
__u32
 
gﬂl
, 
uid_t
 *
ow√r
, __u32 
i_Êags
,

743 
h™dÀ_ty≥
, 
löe_no
,

744 
nblocks
)

746 
su≥r_block
 *
sb
;

747 
buf„r_hód
 *
öode_bôm≠_bh
 = 
NULL
;

748 
buf„r_hód
 *
group_desc_bh
;

749 
pxt4_group_t
 
ngroups
, 
group
 = 0;

750 
öo
 = 0;

751 
öode
 *inode;

752 
pxt4_group_desc
 *
gdp
 = 
NULL
;

753 
pxt4_öode_öfo
 *
ei
;

754 
pxt4_sb_öfo
 *
sbi
;

755 
ªt2
, 
îr
;

756 
öode
 *
ªt
;

757 
pxt4_group_t
 
i
;

758 
pxt4_group_t
 
Êex_group
;

759 
pxt4_group_öfo
 *
gΩ
;

760 
í¸y±
 = 0;

763 i‡(!
dú
 || !dú->
i_∆ök
)

764  
	`ERR_PTR
(-
EPERM
);

766 
sb
 = 
dú
->
i_sb
;

767 
sbi
 = 
	`PXT4_SB
(
sb
);

769 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

770  
	`ERR_PTR
(-
EIO
);

772 i‡((
	`IS_ENCRYPTED
(
dú
Ë|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

773 (
	`S_ISREG
(
mode
Ë|| 
	`S_ISDIR
(modeË|| 
	`S_ISLNK
(mode)) &&

774 !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

775 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

776 i‡(
îr
)

777  
	`ERR_PTR
(
îr
);

778 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
))

779  
	`ERR_PTR
(-
ENOKEY
);

780 
í¸y±
 = 1;

783 i‡(!
h™dÀ
 && 
sbi
->
s_jou∫Æ
 && !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

784 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


785 
posix_a˛
 *
p
 = 
	`gë_a˛
(
dú
, 
ACL_TYPE_DEFAULT
);

787 i‡(
	`IS_ERR
(
p
))

788  
	`ERR_CAST
(
p
);

789 i‡(
p
) {

790 
a˛_size
 = 
p
->
a_cou¡
 * (
pxt4_a˛_íåy
);

792 
nblocks
 +(
	`S_ISDIR
(
mode
) ? 2 : 1) *

793 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

794 
NULL
 , 
a˛_size
,

795 
åue
 );

796 
	`posix_a˛_ªÀa£
(
p
);

800 #ifde‡
CONFIG_SECURITY


802 
num_£curôy_x©ås
 = 1;

804 #ifde‡
CONFIG_INTEGRITY


805 
num_£curôy_x©ås
++;

812 
nblocks
 +
num_£curôy_x©ås
 *

813 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

814 
NULL
 , 1024,

815 
åue
 );

818 i‡(
í¸y±
)

819 
nblocks
 +
	`__pxt4_x©å_£t_¸edôs
(
sb
,

820 
NULL
 , NULL ,

821 
FSCRYPT_SET_CONTEXT_MAX_SIZE
,

822 
åue
 );

825 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

826 
	`åa˚_pxt4_ªque°_öode
(
dú
, 
mode
);

827 
öode
 = 
	`√w_öode
(
sb
);

828 i‡(!
öode
)

829  
	`ERR_PTR
(-
ENOMEM
);

830 
ei
 = 
	`PXT4_I
(
öode
);

837 i‡(
ow√r
) {

838 
öode
->
i_mode
 = 
mode
;

839 
	`i_uid_wrôe
(
öode
, 
ow√r
[0]);

840 
	`i_gid_wrôe
(
öode
, 
ow√r
[1]);

841 } i‡(
	`ã°_›t
(
sb
, 
GRPID
)) {

842 
öode
->
i_mode
 = 
mode
;

843 
öode
->
i_uid
 = 
	`cuºít_fsuid
();

844 
öode
->
i_gid
 = 
dú
->i_gid;

846 
	`öode_öô_ow√r
(
öode
, 
dú
, 
mode
);

848 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

849 
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
))

850 
ei
->
i_¥ojid
 = 
	`PXT4_I
(
dú
)->i_projid;

852 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, 
PXT4_DEF_PROJID
);

854 
îr
 = 
	`dquŸ_öôülize
(
öode
);

855 i‡(
îr
)

856 
out
;

858 i‡(!
gﬂl
)

859 
gﬂl
 = 
sbi
->
s_öode_gﬂl
;

861 i‡(
gﬂl
 && gﬂ»<
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)) {

862 
group
 = (
gﬂl
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

863 
öo
 = (
gﬂl
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

864 
ªt2
 = 0;

865 
gŸ_group
;

868 i‡(
	`S_ISDIR
(
mode
))

869 
ªt2
 = 
	`föd_group_‹lov
(
sb
, 
dú
, &
group
, 
mode
, 
q°r
);

871 
ªt2
 = 
	`föd_group_Ÿhî
(
sb
, 
dú
, &
group
, 
mode
);

873 
gŸ_group
:

874 
	`PXT4_I
(
dú
)->
i_œ°_Æloc_group
 = 
group
;

875 
îr
 = -
ENOSPC
;

876 i‡(
ªt2
 == -1)

877 
out
;

884 
i
 = 0; i < 
ngroups
; i++, 
öo
 = 0) {

885 
îr
 = -
EIO
;

887 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

888 i‡(!
gdp
)

889 
out
;

894 i‡(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) == 0)

895 
√xt_group
;

897 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

899 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

900 
√xt_group
;

902 
	`bªl£
(
öode_bôm≠_bh
);

903 
öode_bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
group
);

905 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) ||

906 
	`IS_ERR
(
öode_bôm≠_bh
)) {

907 
öode_bôm≠_bh
 = 
NULL
;

908 
√xt_group
;

911 
ª≥©_ö_this_group
:

912 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

913 i‡(!
ªt2
)

914 
√xt_group
;

916 i‡(
group
 =0 && (
öo
 + 1Ë< 
	`PXT4_FIRST_INO
(
sb
)) {

917 
	`pxt4_îr‹
(
sb
, "reserved inode found cleared - "

918 "öode=%lu", 
öo
 + 1);

919 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

920 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

921 
√xt_group
;

924 i‡(!
h™dÀ
) {

925 
	`BUG_ON
(
nblocks
 <= 0);

926 
h™dÀ
 = 
	`__pxt4_jou∫Æ_°¨t_sb
(
dú
->
i_sb
, 
löe_no
,

927 
h™dÀ_ty≥
, 
nblocks
,

929 i‡(
	`IS_ERR
(
h™dÀ
)) {

930 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

931 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

932 
out
;

935 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "get_write_access");

936 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
öode_bôm≠_bh
);

937 i‡(
îr
) {

938 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

939 
out
;

941 
	`pxt4_lock_group
(
sb
, 
group
);

942 
ªt2
 = 
	`pxt4_ã°_™d_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

943 i‡(
ªt2
) {

947 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

948 i‡(
ªt2
) {

949 
	`pxt4_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

950 
ªt2
 = 0;

952 
ªt2
 = 1;

955 
	`pxt4_u∆ock_group
(
sb
, 
group
);

956 
öo
++;

957 i‡(!
ªt2
)

958 
gŸ
;

960 i‡(
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

961 
ª≥©_ö_this_group
;

962 
√xt_group
:

963 i‡(++
group
 =
ngroups
)

964 
group
 = 0;

966 
îr
 = -
ENOSPC
;

967 
out
;

969 
gŸ
:

970 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

971 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
öode_bôm≠_bh
);

972 i‡(
îr
) {

973 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

974 
out
;

977 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

978 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
group_desc_bh
);

979 i‡(
îr
) {

980 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

981 
out
;

985 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

986 
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
)) {

987 
buf„r_hód
 *
block_bôm≠_bh
;

989 
block_bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

990 i‡(
	`IS_ERR
(
block_bôm≠_bh
)) {

991 
îr
 = 
	`PTR_ERR
(
block_bôm≠_bh
);

992 
out
;

994 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "get block bitmapáccess");

995 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
block_bôm≠_bh
);

996 i‡(
îr
) {

997 
	`bªl£
(
block_bôm≠_bh
);

998 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

999 
out
;

1002 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "dirty block bitmap");

1003 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
block_bôm≠_bh
);

1006 
	`pxt4_lock_group
(
sb
, 
group
);

1007 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

1008 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

1009 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

1010 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1011 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
gdp
));

1012 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
,

1013 
block_bôm≠_bh
);

1014 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1016 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1017 
	`bªl£
(
block_bôm≠_bh
);

1019 i‡(
îr
) {

1020 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1021 
out
;

1026 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1027 
‰ì
;

1028 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1030 
	`down_ªad
(&
gΩ
->
Æloc_£m
);

1031 
	`pxt4_lock_group
(
sb
, 
group
);

1032 
‰ì
 = 
	`PXT4_INODES_PER_GROUP
(
sb
) -

1033 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

1034 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)) {

1035 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_INODE_UNINIT
);

1036 
‰ì
 = 0;

1043 i‡(
öo
 > 
‰ì
)

1044 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1045 (
	`PXT4_INODES_PER_GROUP
(
sb
Ë- 
öo
));

1046 
	`up_ªad
(&
gΩ
->
Æloc_£m
);

1048 
	`pxt4_lock_group
(
sb
, 
group
);

1051 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`pxt4_‰ì_öodes_cou¡
(sb, gdp) - 1);

1052 i‡(
	`S_ISDIR
(
mode
)) {

1053 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
	`pxt4_u£d_dús_cou¡
(sb, gdp) + 1);

1054 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1055 
pxt4_group_t
 
f
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1057 
	`©omic_öc
(&
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

1058 
f
)->
u£d_dús
);

1061 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1062 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
öode_bôm≠_bh
,

1063 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1064 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1066 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1068 
	`BUFFER_TRACE
(
group_desc_bh
, "callÖxt4_handle_dirty_metadata");

1069 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
group_desc_bh
);

1070 i‡(
îr
) {

1071 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1072 
out
;

1075 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_‰ìöodes_cou¡î
);

1076 i‡(
	`S_ISDIR
(
mode
))

1077 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_dús_cou¡î
);

1079 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1080 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1081 
	`©omic_dec
(&
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

1082 
Êex_group
)->
‰ì_öodes
);

1085 
öode
->
i_öo
 = 
öo
 + 
group
 * 
	`PXT4_INODES_PER_GROUP
(
sb
);

1087 
öode
->
i_blocks
 = 0;

1088 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1089 
ei
->
i_¸time
 = 
öode
->
i_mtime
;

1091 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

1092 
ei
->
i_dú_°¨t_lookup
 = 0;

1093 
ei
->
i_disksize
 = 0;

1096 
ei
->
i_Êags
 =

1097 
	`pxt4_mask_Êags
(
mode
, 
	`PXT4_I
(
dú
)->
i_Êags
 & 
PXT4_FL_INHERITED
);

1098 
ei
->
i_Êags
 |= i_flags;

1099 
ei
->
i_fûe_a˛
 = 0;

1100 
ei
->
i_dtime
 = 0;

1101 
ei
->
i_block_group
 = 
group
;

1102 
ei
->
i_œ°_Æloc_group
 = ~0;

1104 
	`pxt4_£t_öode_Êags
(
öode
);

1105 i‡(
	`IS_DIRSYNC
(
öode
))

1106 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1107 i‡(
	`ö£π_öode_locked
(
öode
) < 0) {

1112 
îr
 = -
EIO
;

1113 
	`pxt4_îr‹
(
sb
, "failedÅo insert inode %lu: doublyállocated?",

1114 
öode
->
i_öo
);

1115 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

1116 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

1117 
out
;

1119 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

1122 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

1123 
__u32
 
csum
;

1124 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

1125 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

1126 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

1127 (
öum
));

1128 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

1129 (
gí
));

1132 
	`pxt4_˛ór_°©e_Êags
(
ei
);

1133 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

1135 
ei
->
i_exåa_isize
 = 
sbi
->
s_w™t_exåa_isize
;

1136 
ei
->
i_ölöe_off
 = 0;

1137 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
))

1138 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1139 
ªt
 = 
öode
;

1140 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

1141 i‡(
îr
)

1142 
Áû_dr›
;

1149 i‡(
í¸y±
) {

1150 
îr
 = 
	`fs¸y±_öhîô_c⁄ãxt
(
dú
, 
öode
, 
h™dÀ
, 
åue
);

1151 i‡(
îr
)

1152 
Áû_‰ì_dr›
;

1155 i‡(!(
ei
->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

1156 
îr
 = 
	`pxt4_öô_a˛
(
h™dÀ
, 
öode
, 
dú
);

1157 i‡(
îr
)

1158 
Áû_‰ì_dr›
;

1160 
îr
 = 
	`pxt4_öô_£curôy
(
h™dÀ
, 
öode
, 
dú
, 
q°r
);

1161 i‡(
îr
)

1162 
Áû_‰ì_dr›
;

1165 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

1167 i‡(
	`S_ISDIR
(
mode
Ë|| 
	`S_ISREG
(modeË|| 
	`S_ISLNK
(mode)) {

1168 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

1169 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

1173 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

1174 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1175 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1178 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1179 i‡(
îr
) {

1180 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1181 
Áû_‰ì_dr›
;

1184 
	`pxt4_debug
("Æloˇtög inodê%lu\n", 
öode
->
i_öo
);

1185 
	`åa˚_pxt4_Æloˇã_öode
(
öode
, 
dú
, 
mode
);

1186 
	`bªl£
(
öode_bôm≠_bh
);

1187  
ªt
;

1189 
Áû_‰ì_dr›
:

1190 
	`dquŸ_‰ì_öode
(
öode
);

1191 
Áû_dr›
:

1192 
	`˛ór_∆ök
(
öode
);

1193 
	`u∆ock_√w_öode
(
öode
);

1194 
out
:

1195 
	`dquŸ_dr›
(
öode
);

1196 
öode
->
i_Êags
 |
S_NOQUOTA
;

1197 
	`ùut
(
öode
);

1198 
	`bªl£
(
öode_bôm≠_bh
);

1199  
	`ERR_PTR
(
îr
);

1200 
	}
}

1203 
öode
 *
	$pxt4_‹ph™_gë
(
su≥r_block
 *
sb
, 
öo
)

1205 
max_öo
 = 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
);

1206 
pxt4_group_t
 
block_group
;

1207 
bô
;

1208 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1209 
öode
 *öodê
NULL
;

1210 
îr
 = -
EFSCORRUPTED
;

1212 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
max_öo
)

1213 
bad_‹ph™
;

1215 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

1216 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

1217 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

1218 i‡(
	`IS_ERR
(
bôm≠_bh
))

1219  
	`ERR_CAST
(
bôm≠_bh
);

1225 i‡(!
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
))

1226 
bad_‹ph™
;

1228 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1229 i‡(
	`IS_ERR
(
öode
)) {

1230 
îr
 = 
	`PTR_ERR
(
öode
);

1231 
	`pxt4_îr‹
(
sb
, "couldn'tÑead orphan inode %lu (err %d)",

1232 
öo
, 
îr
);

1233  
öode
;

1242 i‡((
öode
->
i_∆ök
 && !
	`pxt4_ˇn_åunˇã
(inode)) ||

1243 
	`is_bad_öode
(
öode
))

1244 
bad_‹ph™
;

1246 i‡(
	`NEXT_ORPHAN
(
öode
Ë> 
max_öo
)

1247 
bad_‹ph™
;

1248 
	`bªl£
(
bôm≠_bh
);

1249  
öode
;

1251 
bad_‹ph™
:

1252 
	`pxt4_îr‹
(
sb
, "bad oΩh™ inodê%lu", 
öo
);

1253 i‡(
bôm≠_bh
)

1254 
	`¥ötk
(
KERN_ERR
 "pxt4_test_bit(bit=%d, block=%llu) = %d\n",

1255 
bô
, ()
bôm≠_bh
->
b_blockƒ
,

1256 
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
));

1257 i‡(
öode
) {

1258 
	`¥ötk
(
KERN_ERR
 "is_bad_inode(inode)=%d\n",

1259 
	`is_bad_öode
(
öode
));

1260 
	`¥ötk
(
KERN_ERR
 "NEXT_ORPHAN(inode)=%u\n",

1261 
	`NEXT_ORPHAN
(
öode
));

1262 
	`¥ötk
(
KERN_ERR
 "max_öo=%lu\n", 
max_öo
);

1263 
	`¥ötk
(
KERN_ERR
 "i_∆ök=%u\n", 
öode
->
i_∆ök
);

1265 i‡(
öode
->
i_∆ök
 == 0)

1266 
öode
->
i_blocks
 = 0;

1267 
	`ùut
(
öode
);

1269 
	`bªl£
(
bôm≠_bh
);

1270  
	`ERR_PTR
(
îr
);

1271 
	}
}

1273 
	$pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *
sb
)

1275 
desc_cou¡
;

1276 
pxt4_group_desc
 *
gdp
;

1277 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1278 #ifde‡
PXT4FS_DEBUG


1279 
pxt4_su≥r_block
 *
es
;

1280 
bôm≠_cou¡
, 
x
;

1281 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1283 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1284 
desc_cou¡
 = 0;

1285 
bôm≠_cou¡
 = 0;

1286 
gdp
 = 
NULL
;

1287 
i
 = 0; i < 
ngroups
; i++) {

1288 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1289 i‡(!
gdp
)

1291 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1292 
	`bªl£
(
bôm≠_bh
);

1293 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
i
);

1294 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

1295 
bôm≠_bh
 = 
NULL
;

1299 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

1300 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1301 
	`¥ötk
(
KERN_DEBUG
 "group %lu: stored = %d, counted = %lu\n",

1302 (Ë
i
, 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), 
x
);

1303 
bôm≠_cou¡
 +
x
;

1305 
	`bªl£
(
bôm≠_bh
);

1306 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_inodes: "

1308 
	`À32_to_˝u
(
es
->
s_‰ì_öodes_cou¡
), 
desc_cou¡
, 
bôm≠_cou¡
);

1309  
desc_cou¡
;

1311 
desc_cou¡
 = 0;

1312 
i
 = 0; i < 
ngroups
; i++) {

1313 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1314 i‡(!
gdp
)

1316 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1317 
	`c⁄d_ªsched
();

1319  
desc_cou¡
;

1321 
	}
}

1324 
	$pxt4_cou¡_dús
(
su≥r_block
 * 
sb
)

1326 
cou¡
 = 0;

1327 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1329 
i
 = 0; i < 
ngroups
; i++) {

1330 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1331 i‡(!
gdp
)

1333 
cou¡
 +
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
);

1335  
cou¡
;

1336 
	}
}

1346 
	$pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1347 
b¨rõr
)

1349 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1351 
pxt4_group_desc
 *
gdp
 = 
NULL
;

1352 
buf„r_hód
 *
group_desc_bh
;

1353 
h™dÀ_t
 *
h™dÀ
;

1354 
pxt4_fsblk_t
 
blk
;

1355 
num
, 
ªt
 = 0, 
u£d_blks
 = 0;

1358 i‡(
	`sb_rd⁄ly
(
sb
)) {

1359 
ªt
 = 1;

1360 
out
;

1363 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1364 i‡(!
gdp
)

1365 
out
;

1371 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
))

1372 
out
;

1374 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1375 i‡(
	`IS_ERR
(
h™dÀ
)) {

1376 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

1377 
out
;

1380 
	`down_wrôe
(&
gΩ
->
Æloc_£m
);

1386 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)))

1387 
u£d_blks
 = 
	`DIV_ROUND_UP
((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1388 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)),

1389 
sbi
->
s_öodes_≥r_block
);

1391 i‡((
u£d_blks
 < 0Ë|| (u£d_blk†> 
sbi
->
s_ôb_≥r_group
) ||

1392 ((
group
 =0Ë&& ((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1393 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)) <

1394 
	`PXT4_FIRST_INO
(
sb
)))) {

1395 
	`pxt4_îr‹
(
sb
, "Something is wrong with group %u: "

1398 
group
, 
u£d_blks
,

1399 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
));

1400 
ªt
 = 1;

1401 
îr_out
;

1404 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ 
u£d_blks
;

1405 
num
 = 
sbi
->
s_ôb_≥r_group
 - 
u£d_blks
;

1407 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1408 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1409 
group_desc_bh
);

1410 i‡(
ªt
)

1411 
îr_out
;

1418 i‡(
	`u∆ikñy
(
num
 == 0))

1419 
skù_zîoout
;

1421 
	`pxt4_debug
("goingÅo zero out inodeÅable in group %d\n",

1422 
group
);

1423 
ªt
 = 
	`sb_issue_zîoout
(
sb
, 
blk
, 
num
, 
GFP_NOFS
);

1424 i‡(
ªt
 < 0)

1425 
îr_out
;

1426 i‡(
b¨rõr
)

1427 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_NOFS
, 
NULL
);

1429 
skù_zîoout
:

1430 
	`pxt4_lock_group
(
sb
, 
group
);

1431 
gdp
->
bg_Êags
 |
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
);

1432 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1433 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1435 
	`BUFFER_TRACE
(
group_desc_bh
,

1437 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1438 
group_desc_bh
);

1440 
îr_out
:

1441 
	`up_wrôe
(&
gΩ
->
Æloc_£m
);

1442 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1443 
out
:

1444  
ªt
;

1445 
	}
}

	@indirect.c

24 
	~"pxt4_jbd3.h
"

25 
	~"åunˇã.h
"

26 
	~<löux/dax.h
>

27 
	~<löux/uio.h
>

29 
	~<åa˚/evíts/pxt4.h
>

32 
__À32
 *
	mp
;

33 
__À32
 
	mkey
;

34 
buf„r_hód
 *
	mbh
;

35 } 
	tIndúe˘
;

37 
ölöe
 
	$add_chaö
(
Indúe˘
 *
p
, 
buf„r_hód
 *
bh
, 
__À32
 *
v
)

39 
p
->
key
 = *’->∞
v
);

40 
p
->
bh
 = bh;

41 
	}
}

74 
	$pxt4_block_to_∑th
(
öode
 *inode,

75 
pxt4_lblk_t
 
i_block
,

76 
pxt4_lblk_t
 
off£ts
[4], *
bound¨y
)

78 
±rs
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

79 
±rs_bôs
 = 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
);

80 c⁄° 
dúe˘_blocks
 = 
PXT4_NDIR_BLOCKS
,

81 
ödúe˘_blocks
 = 
±rs
,

82 
doubÀ_blocks
 = (1 << (
±rs_bôs
 * 2));

83 
n
 = 0;

84 
föÆ
 = 0;

86 i‡(
i_block
 < 
dúe˘_blocks
) {

87 
off£ts
[
n
++] = 
i_block
;

88 
föÆ
 = 
dúe˘_blocks
;

89 } i‡((
i_block
 -
dúe˘_blocks
Ë< 
ödúe˘_blocks
) {

90 
off£ts
[
n
++] = 
PXT4_IND_BLOCK
;

91 
off£ts
[
n
++] = 
i_block
;

92 
föÆ
 = 
±rs
;

93 } i‡((
i_block
 -
ödúe˘_blocks
Ë< 
doubÀ_blocks
) {

94 
off£ts
[
n
++] = 
PXT4_DIND_BLOCK
;

95 
off£ts
[
n
++] = 
i_block
 >> 
±rs_bôs
;

96 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

97 
föÆ
 = 
±rs
;

98 } i‡(((
i_block
 -
doubÀ_blocks
Ë>> (
±rs_bôs
 * 2)Ë< 
±rs
) {

99 
off£ts
[
n
++] = 
PXT4_TIND_BLOCK
;

100 
off£ts
[
n
++] = 
i_block
 >> (
±rs_bôs
 * 2);

101 
off£ts
[
n
++] = (
i_block
 >> 
±rs_bôs
Ë& (
±rs
 - 1);

102 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

103 
föÆ
 = 
±rs
;

105 
	`pxt4_w¨nög
(
öode
->
i_sb
, "block %lu > max in inode %lu",

106 
i_block
 + 
dúe˘_blocks
 +

107 
ödúe˘_blocks
 + 
doubÀ_blocks
, 
öode
->
i_öo
);

109 i‡(
bound¨y
)

110 *
bound¨y
 = 
föÆ
 - 1 - (
i_block
 & (
±rs
 - 1));

111  
n
;

112 
	}
}

144 
Indúe˘
 *
	$pxt4_gë_bønch
(
öode
 *öode, 
dïth
,

145 
pxt4_lblk_t
 *
off£ts
,

146 
Indúe˘
 
chaö
[4], *
îr
)

148 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

149 
Indúe˘
 *
p
 = 
chaö
;

150 
buf„r_hód
 *
bh
;

151 
ªt
 = -
EIO
;

153 *
îr
 = 0;

155 
	`add_chaö
(
chaö
, 
NULL
, 
	`PXT4_I
(
öode
)->
i_d©a
 + *
off£ts
);

156 i‡(!
p
->
key
)

157 
no_block
;

158 --
dïth
) {

159 
bh
 = 
	`sb_gëblk
(
sb
, 
	`À32_to_˝u
(
p
->
key
));

160 i‡(
	`u∆ikñy
(!
bh
)) {

161 
ªt
 = -
ENOMEM
;

162 
Áûuª
;

165 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

166 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

167 
	`put_bh
(
bh
);

168 
Áûuª
;

171 i‡(
	`pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
)) {

172 
	`put_bh
(
bh
);

173 
Áûuª
;

177 
	`add_chaö
(++
p
, 
bh
, (
__À32
 *)bh->
b_d©a
 + *++
off£ts
);

179 i‡(!
p
->
key
)

180 
no_block
;

182  
NULL
;

184 
Áûuª
:

185 *
îr
 = 
ªt
;

186 
no_block
:

187  
p
;

188 
	}
}

210 
pxt4_fsblk_t
 
	$pxt4_föd_√¨
(
öode
 *öode, 
Indúe˘
 *
öd
)

212 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

213 
__À32
 *
°¨t
 = 
öd
->
bh
 ? (__À32 *Ëöd->bh->
b_d©a
 : 
ei
->
i_d©a
;

214 
__À32
 *
p
;

217 
p
 = 
öd
->∞- 1;Ö >
°¨t
;Ö--) {

218 i‡(*
p
)

219  
	`À32_to_˝u
(*
p
);

223 i‡(
öd
->
bh
)

224  
öd
->
bh
->
b_blockƒ
;

230  
	`pxt4_öode_to_gﬂl_block
(
öode
);

231 
	}
}

244 
pxt4_fsblk_t
 
	$pxt4_föd_gﬂl
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

245 
Indúe˘
 *
∑πül
)

247 
pxt4_fsblk_t
 
gﬂl
;

253 
gﬂl
 = 
	`pxt4_föd_√¨
(
öode
, 
∑πül
);

254 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

255  
gﬂl
;

256 
	}
}

270 
	$pxt4_blks_to_Æloˇã
(
Indúe˘
 *
bønch
, 
k
, 
blks
,

271 
blocks_to_bound¨y
)

273 
cou¡
 = 0;

279 i‡(
k
 > 0) {

281 i‡(
blks
 < 
blocks_to_bound¨y
 + 1)

282 
cou¡
 +
blks
;

284 
cou¡
 +
blocks_to_bound¨y
 + 1;

285  
cou¡
;

288 
cou¡
++;

289 
cou¡
 < 
blks
 && cou¡ <
blocks_to_bound¨y
 &&

290 
	`À32_to_˝u
(*(
bønch
[0].
p
 + 
cou¡
)) == 0) {

291 
cou¡
++;

293  
cou¡
;

294 
	}
}

321 
	$pxt4_Æloc_bønch
(
h™dÀ_t
 *
h™dÀ
,

322 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

323 
ödúe˘_blks
, 
pxt4_lblk_t
 *
off£ts
,

324 
Indúe˘
 *
bønch
)

326 
buf„r_hód
 * 
bh
;

327 
pxt4_fsblk_t
 
b
, 
√w_blocks
[4];

328 
__À32
 *
p
;

329 
i
, 
j
, 
îr
, 
Àn
 = 1;

331 
i
 = 0; i <
ödúe˘_blks
; i++) {

332 i‡(
i
 =
ödúe˘_blks
) {

333 
√w_blocks
[
i
] = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, 
¨
, &
îr
);

335 
¨
->
gﬂl
 = 
√w_blocks
[
i
] = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
,

336 
¨
->
öode
,ár->
gﬂl
,

337 
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
,

338 
NULL
, &
îr
);

339 i‡(
îr
) {

340 
i
--;

341 
Áûed
;

343 
bønch
[
i
].
key
 = 
	`˝u_to_À32
(
√w_blocks
[i]);

344 i‡(
i
 == 0)

347 
bh
 = 
bønch
[
i
].bh = 
	`sb_gëblk
(
¨
->
öode
->
i_sb
, 
√w_blocks
[i-1]);

348 i‡(
	`u∆ikñy
(!
bh
)) {

349 
îr
 = -
ENOMEM
;

350 
Áûed
;

352 
	`lock_buf„r
(
bh
);

353 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

354 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

355 i‡(
îr
) {

356 
	`u∆ock_buf„r
(
bh
);

357 
Áûed
;

360 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

361 
p
 = 
bønch
[
i
].∞(
__À32
 *Ë
bh
->
b_d©a
 + 
off£ts
[i];

362 
b
 = 
√w_blocks
[
i
];

364 i‡(
i
 =
ödúe˘_blks
)

365 
Àn
 = 
¨
->len;

366 
j
 = 0; j < 
Àn
; j++)

367 *
p
++ = 
	`˝u_to_À32
(
b
++);

369 
	`BUFFER_TRACE
(
bh
, "marking uptodate");

370 
	`£t_buf„r_u±od©e
(
bh
);

371 
	`u∆ock_buf„r
(
bh
);

373 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

374 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
bh
);

375 i‡(
îr
)

376 
Áûed
;

379 
Áûed
:

380 ; 
i
 >= 0; i--) {

387 i‡(
i
 > 0 && i !
ödúe˘_blks
 && 
bønch
[i].
bh
)

388 
	`pxt4_f‹gë
(
h™dÀ
, 1, 
¨
->
öode
, 
bønch
[
i
].
bh
,

389 
bønch
[
i
].
bh
->
b_blockƒ
);

390 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
√w_blocks
[
i
],

391 (
i
 =
ödúe˘_blks
Ë? 
¨
->
Àn
 : 1, 0);

393  
îr
;

394 
	}
}

407 
	$pxt4_•li˚_bønch
(
h™dÀ_t
 *
h™dÀ
,

408 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

409 
Indúe˘
 *
whîe
, 
num
)

411 
i
;

412 
îr
 = 0;

413 
pxt4_fsblk_t
 
cuºít_block
;

420 i‡(
whîe
->
bh
) {

421 
	`BUFFER_TRACE
(
whîe
->
bh
, "get_write_access");

422 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
whîe
->
bh
);

423 i‡(
îr
)

424 
îr_out
;

428 *
whîe
->
p
 = whîe->
key
;

434 i‡(
num
 =0 && 
¨
->
Àn
 > 1) {

435 
cuºít_block
 = 
	`À32_to_˝u
(
whîe
->
key
) + 1;

436 
i
 = 1; i < 
¨
->
Àn
; i++)

437 *(
whîe
->
p
 + 
i
Ë
	`˝u_to_À32
(
cuºít_block
++);

442 i‡(
whîe
->
bh
) {

451 
	`jbd_debug
(5, "splicing indirect only\n");

452 
	`BUFFER_TRACE
(
whîe
->
bh
, "callÖxt4_handle_dirty_metadata");

453 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
whîe
->
bh
);

454 i‡(
îr
)

455 
îr_out
;

460 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
¨
->
öode
);

461 
	`jbd_debug
(5, "splicing direct\n");

463  
îr
;

465 
îr_out
:

466 
i
 = 1; i <
num
; i++) {

472 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
whîe
[
i
].
bh
, 0, 1,

473 
PXT4_FREE_BLOCKS_FORGET
);

475 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
	`À32_to_˝u
(
whîe
[
num
].
key
),

476 
¨
->
Àn
, 0);

478  
îr
;

479 
	}
}

509 
	$pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

510 
pxt4_m≠_blocks
 *
m≠
,

511 
Êags
)

513 
pxt4_Æloˇti⁄_ªque°
 
¨
;

514 
îr
 = -
EIO
;

515 
pxt4_lblk_t
 
off£ts
[4];

516 
Indúe˘
 
chaö
[4];

517 
Indúe˘
 *
∑πül
;

518 
ödúe˘_blks
;

519 
blocks_to_bound¨y
 = 0;

520 
dïth
;

521 
cou¡
 = 0;

522 
pxt4_fsblk_t
 
fú°_block
 = 0;

524 
	`åa˚_pxt4_öd_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

525 
	`J_ASSERT
(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)));

526 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || (
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0);

527 
dïth
 = 
	`pxt4_block_to_∑th
(
öode
, 
m≠
->
m_lblk
, 
off£ts
,

528 &
blocks_to_bound¨y
);

530 i‡(
dïth
 == 0)

531 
out
;

533 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
dïth
, 
off£ts
, 
chaö
, &
îr
);

536 i‡(!
∑πül
) {

537 
fú°_block
 = 
	`À32_to_˝u
(
chaö
[
dïth
 - 1].
key
);

538 
cou¡
++;

540 
cou¡
 < 
m≠
->
m_Àn
 && cou¡ <
blocks_to_bound¨y
) {

541 
pxt4_fsblk_t
 
blk
;

543 
blk
 = 
	`À32_to_˝u
(*(
chaö
[
dïth
-1].
p
 + 
cou¡
));

545 i‡(
blk
 =
fú°_block
 + 
cou¡
)

546 
cou¡
++;

550 
gŸ_ô
;

554 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

555 
ïb
 = 
öode
->
i_sb
->
s_blocksize
 / (
u32
);

556 
i
;

564 
cou¡
 = 0;

565 
i
 = 
∑πül
 - 
chaö
 + 1; i < 
dïth
; i++)

566 
cou¡
 = cou¡ * 
ïb
 + (ïb - 
off£ts
[
i
] - 1);

567 
cou¡
++;

569 
m≠
->
m_pblk
 = 0;

570 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
cou¡
);

571 
˛ónup
;

575 i‡(
îr
 =-
EIO
)

576 
˛ónup
;

581 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
)) {

582 
	`PXT4_ERROR_INODE
(
öode
, "Can'tállocate blocks for "

584  -
EFSCORRUPTED
;

588 
	`mem£t
(&
¨
, 0, (ar));

589 
¨
.
öode
 = inode;

590 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

591 i‡(
	`S_ISREG
(
öode
->
i_mode
))

592 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

593 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

594 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

595 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

596 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

598 
¨
.
gﬂl
 = 
	`pxt4_föd_gﬂl
(
öode
, 
m≠
->
m_lblk
, 
∑πül
);

601 
ödúe˘_blks
 = (
chaö
 + 
dïth
Ë- 
∑πül
 - 1;

607 
¨
.
Àn
 = 
	`pxt4_blks_to_Æloˇã
(
∑πül
, 
ödúe˘_blks
,

608 
m≠
->
m_Àn
, 
blocks_to_bound¨y
);

613 
îr
 = 
	`pxt4_Æloc_bønch
(
h™dÀ
, &
¨
, 
ödúe˘_blks
,

614 
off£ts
 + (
∑πül
 - 
chaö
),Öartial);

623 i‡(!
îr
)

624 
îr
 = 
	`pxt4_•li˚_bønch
(
h™dÀ
, &
¨
, 
∑πül
, 
ödúe˘_blks
);

625 i‡(
îr
)

626 
˛ónup
;

628 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

630 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

631 
cou¡
 = 
¨
.
Àn
;

632 
gŸ_ô
:

633 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

634 
m≠
->
m_pblk
 = 
	`À32_to_˝u
(
chaö
[
dïth
-1].
key
);

635 
m≠
->
m_Àn
 = 
cou¡
;

636 i‡(
cou¡
 > 
blocks_to_bound¨y
)

637 
m≠
->
m_Êags
 |
PXT4_MAP_BOUNDARY
;

638 
îr
 = 
cou¡
;

640 
∑πül
 = 
chaö
 + 
dïth
 - 1;

641 
˛ónup
:

642 
∑πül
 > 
chaö
) {

643 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

644 
	`bªl£
(
∑πül
->
bh
);

645 
∑πül
--;

647 
out
:

648 
	`åa˚_pxt4_öd_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
, 
îr
);

649  
îr
;

650 
	}
}

656 
	$pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
)

658 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

659 
£˘‹_t
 
död_mask
 = ~((£˘‹_t)
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
) - 1);

660 
blk_bôs
;

662 i‡(
lblock
 < 
PXT4_NDIR_BLOCKS
)

665 
lblock
 -
PXT4_NDIR_BLOCKS
;

667 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

668 (
lblock
 & 
död_mask
Ë=
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
) {

669 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

672 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
 & 
död_mask
;

673 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

674 
blk_bôs
 = 
	`‹dî_ba£_2
(
lblock
);

675  (
blk_bôs
 / 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
)) + 1;

676 
	}
}

682 
	$pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

689  
	`DIV_ROUND_UP
(
ƒblocks
, 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
)) + 4;

690 
	}
}

704 
	$åy_to_exãnd_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

706 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

708 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

710 i‡(!
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
	`pxt4_blocks_f‹_åunˇã
(
öode
)))

713 
	}
}

720 
ölöe
 
	$Æl_zî€s
(
__À32
 *
p
, __À32 *
q
)

722 
p
 < 
q
)

723 i‡(*
p
++)

726 
	}
}

763 
Indúe˘
 *
	$pxt4_föd_sh¨ed
(
öode
 *öode, 
dïth
,

764 
pxt4_lblk_t
 
off£ts
[4], 
Indúe˘
 
chaö
[4],

765 
__À32
 *
t›
)

767 
Indúe˘
 *
∑πül
, *
p
;

768 
k
, 
îr
;

770 *
t›
 = 0;

772 
k
 = 
dïth
; k > 1 && !
off£ts
[k-1]; k--)

774 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
k
, 
off£ts
, 
chaö
, &
îr
);

776 i‡(!
∑πül
)

777 
∑πül
 = 
chaö
 + 
k
-1;

782 i‡(!
∑πül
->
key
 && *∑πül->
p
)

784 
no_t›
;

785 
p
 = 
∑πül
; (∞> 
chaö
Ë&& 
	`Æl_zî€s
((
__À32
 *Ëp->
bh
->
b_d©a
,Ö->p);Ö--)

793 i‡(
p
 =
chaö
 + 
k
 - 1 &&Ö > chain) {

794 
p
->p--;

796 *
t›
 = *
p
->p;

799 *
p
->p = 0;

804 
∑πül
 > 
p
) {

805 
	`bªl£
(
∑πül
->
bh
);

806 
∑πül
--;

808 
no_t›
:

809  
∑πül
;

810 
	}
}

823 
	$pxt4_˛ór_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

824 
buf„r_hód
 *
bh
,

825 
pxt4_fsblk_t
 
block_to_‰ì
,

826 
cou¡
, 
__À32
 *
fú°
,

827 
__À32
 *
œ°
)

829 
__À32
 *
p
;

830 
Êags
 = 
PXT4_FREE_BLOCKS_VALIDATED
;

831 
îr
;

833 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

834 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

835 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
 | 
PXT4_FREE_BLOCKS_METADATA
;

836 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

837 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
;

839 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block_to_‰ì
,

840 
cou¡
)) {

841 
	`PXT4_ERROR_INODE
(
öode
, "attemptÅo clear invalid "

843 (Ë
block_to_‰ì
, 
cou¡
);

847 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

848 i‡(
bh
) {

849 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

850 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

851 i‡(
	`u∆ikñy
(
îr
))

852 
out_îr
;

854 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

855 i‡(
	`u∆ikñy
(
îr
))

856 
out_îr
;

857 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

858 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

859 i‡(
	`u∆ikñy
(
îr
))

860 
out_îr
;

861 i‡(
bh
) {

862 
	`BUFFER_TRACE
(
bh
, "retaking writeáccess");

863 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

864 i‡(
	`u∆ikñy
(
îr
))

865 
out_îr
;

869 
p
 = 
fú°
;Ö < 
œ°
;Ö++)

870 *
p
 = 0;

872 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block_to_‰ì
, 
cou¡
, 
Êags
);

874 
out_îr
:

875 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

876  
îr
;

877 
	}
}

898 
	$pxt4_‰ì_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

899 
buf„r_hód
 *
this_bh
,

900 
__À32
 *
fú°
, __À32 *
œ°
)

902 
pxt4_fsblk_t
 
block_to_‰ì
 = 0;

903 
cou¡
 = 0;

904 
__À32
 *
block_to_‰ì_p
 = 
NULL
;

907 
pxt4_fsblk_t
 
ƒ
;

908 
__À32
 *
p
;

910 
îr
 = 0;

912 i‡(
this_bh
) {

913 
	`BUFFER_TRACE
(
this_bh
, "get_write_access");

914 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
this_bh
);

917 i‡(
îr
)

921 
p
 = 
fú°
;Ö < 
œ°
;Ö++) {

922 
ƒ
 = 
	`À32_to_˝u
(*
p
);

923 i‡(
ƒ
) {

925 i‡(
cou¡
 == 0) {

926 
block_to_‰ì
 = 
ƒ
;

927 
block_to_‰ì_p
 = 
p
;

928 
cou¡
 = 1;

929 } i‡(
ƒ
 =
block_to_‰ì
 + 
cou¡
) {

930 
cou¡
++;

932 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
,

933 
block_to_‰ì
, 
cou¡
,

934 
block_to_‰ì_p
, 
p
);

935 i‡(
îr
)

937 
block_to_‰ì
 = 
ƒ
;

938 
block_to_‰ì_p
 = 
p
;

939 
cou¡
 = 1;

944 i‡(!
îr
 && 
cou¡
 > 0)

945 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
, 
block_to_‰ì
,

946 
cou¡
, 
block_to_‰ì_p
, 
p
);

947 i‡(
îr
 < 0)

951 i‡(
this_bh
) {

952 
	`BUFFER_TRACE
(
this_bh
, "callÖxt4_handle_dirty_metadata");

960 i‡((
	`PXT4_JOURNAL
(
öode
Ë=
NULL
Ë|| 
	`bh2jh
(
this_bh
))

961 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
this_bh
);

963 
	`PXT4_ERROR_INODE
(
öode
,

966 (Ë
this_bh
->
b_blockƒ
);

968 
	}
}

983 
	$pxt4_‰ì_bønches
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

984 
buf„r_hód
 *
∑ª¡_bh
,

985 
__À32
 *
fú°
, __À32 *
œ°
, 
dïth
)

987 
pxt4_fsblk_t
 
ƒ
;

988 
__À32
 *
p
;

990 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

993 i‡(
dïth
--) {

994 
buf„r_hód
 *
bh
;

995 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

996 
p
 = 
œ°
;

997 --
p
 >
fú°
) {

998 
ƒ
 = 
	`À32_to_˝u
(*
p
);

999 i‡(!
ƒ
)

1002 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

1003 
ƒ
, 1)) {

1004 
	`PXT4_ERROR_INODE
(
öode
,

1007 (Ë
ƒ
, 
dïth
);

1012 
bh
 = 
	`sb_bªad
(
öode
->
i_sb
, 
ƒ
);

1018 i‡(!
bh
) {

1019 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ƒ
,

1025 
	`BUFFER_TRACE
(
bh
, "free child branches");

1026 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
bh
,

1027 (
__À32
 *Ë
bh
->
b_d©a
,

1028 (
__À32
 *Ë
bh
->
b_d©a
 + 
addr_≥r_block
,

1029 
dïth
);

1030 
	`bªl£
(
bh
);

1048 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

1050 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

1051 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1052 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

1053 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

1067 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1068 
PXT4_FREE_BLOCKS_METADATA
|

1069 
PXT4_FREE_BLOCKS_FORGET
);

1071 i‡(
∑ª¡_bh
) {

1076 
	`BUFFER_TRACE
(
∑ª¡_bh
, "get_write_access");

1077 i‡(!
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1078 
∑ª¡_bh
)){

1079 *
p
 = 0;

1080 
	`BUFFER_TRACE
(
∑ª¡_bh
,

1082 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1083 
öode
,

1084 
∑ª¡_bh
);

1090 
	`BUFFER_TRACE
(
∑ª¡_bh
, "free data blocks");

1091 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
∑ª¡_bh
, 
fú°
, 
œ°
);

1093 
	}
}

1095 
	$pxt4_öd_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1097 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1098 
__À32
 *
i_d©a
 = 
ei
->i_data;

1099 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1100 
pxt4_lblk_t
 
off£ts
[4];

1101 
Indúe˘
 
chaö
[4];

1102 
Indúe˘
 *
∑πül
;

1103 
__À32
 
ƒ
 = 0;

1104 
n
 = 0;

1105 
pxt4_lblk_t
 
œ°_block
, 
max_block
;

1106 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1108 
œ°_block
 = (
öode
->
i_size
 + 
blocksize
-1)

1109 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1110 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1111 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1113 i‡(
œ°_block
 !
max_block
) {

1114 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
œ°_block
, 
off£ts
, 
NULL
);

1115 i‡(
n
 == 0)

1119 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 -Üast_block);

1128 
ei
->
i_disksize
 = 
öode
->
i_size
;

1130 i‡(
œ°_block
 =
max_block
) {

1136 } i‡(
n
 == 1) {

1137 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
+
off£ts
[0],

1138 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1139 
do_ödúe˘s
;

1142 
∑πül
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1144 i‡(
ƒ
) {

1145 i‡(
∑πül
 =
chaö
) {

1147 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1148 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1149 *
∑πül
->
p
 = 0;

1156 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1157 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1158 
∑πül
->
p
,

1159 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1163 
∑πül
 > 
chaö
) {

1164 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,Ö¨tül->
p
 + 1,

1165 (
__À32
*)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1166 (
chaö
+
n
-1Ë- 
∑πül
);

1167 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

1168 
	`bªl£
(
∑πül
->
bh
);

1169 
∑πül
--;

1171 
do_ödúe˘s
:

1173 
off£ts
[0]) {

1175 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1176 i‡(
ƒ
) {

1177 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1178 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1181 
PXT4_IND_BLOCK
:

1182 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1183 i‡(
ƒ
) {

1184 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1185 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1188 
PXT4_DIND_BLOCK
:

1189 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1190 i‡(
ƒ
) {

1191 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1192 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1195 
PXT4_TIND_BLOCK
:

1198 
	}
}

1210 
	$pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1211 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

1213 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1214 
__À32
 *
i_d©a
 = 
ei
->i_data;

1215 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1216 
pxt4_lblk_t
 
off£ts
[4], 
off£ts2
[4];

1217 
Indúe˘
 
chaö
[4], 
chaö2
[4];

1218 
Indúe˘
 *
∑πül
, *
∑πül2
;

1219 
Indúe˘
 *
p
 = 
NULL
, *
p2
 = NULL;

1220 
pxt4_lblk_t
 
max_block
;

1221 
__À32
 
ƒ
 = 0, 
ƒ2
 = 0;

1222 
n
 = 0, 
n2
 = 0;

1223 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1225 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1226 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1227 i‡(
íd
 >
max_block
)

1228 
íd
 = 
max_block
;

1229 i‡((
°¨t
 >
íd
Ë|| (°¨à> 
max_block
))

1232 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
°¨t
, 
off£ts
, 
NULL
);

1233 
n2
 = 
	`pxt4_block_to_∑th
(
öode
, 
íd
, 
off£ts2
, 
NULL
);

1235 
	`BUG_ON
(
n
 > 
n2
);

1237 i‡((
n
 =1Ë&& (¿=
n2
)) {

1239 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1240 
i_d©a
 + 
off£ts2
[0]);

1242 } i‡(
n2
 > 
n
) {

1250 i‡(
n
 == 1) {

1255 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1256 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1257 
íd_ønge
;

1261 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1262 i‡(
ƒ
) {

1263 i‡(
∑πül
 =
chaö
) {

1265 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1266 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1267 *
∑πül
->
p
 = 0;

1270 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1271 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1272 
∑πül
->
p
,

1273 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1281 
∑πül
 > 
chaö
) {

1282 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1283 
∑πül
->
p
 + 1,

1284 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1285 (
chaö
+
n
-1Ë- 
∑πül
);

1286 
∑πül
--;

1289 
íd_ønge
:

1290 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1291 i‡(
ƒ2
) {

1292 i‡(
∑πül2
 =
chaö2
) {

1299 
do_ödúe˘s
;

1308 
∑πül2
->
p
++;

1315 
∑πül2
 > 
chaö2
) {

1316 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1317 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1318 
∑πül2
->
p
,

1319 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1320 
∑πül2
--;

1322 
do_ödúe˘s
;

1326 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1327 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1330 i‡(
ƒ
) {

1331 
Àvñ
 = 
	`mö
(
∑πül
 - 
chaö
, 
∑πül2
 - 
chaö2
);

1332 
i
;

1333 
subåì
 = 1;

1335 
i
 = 0; i <
Àvñ
; i++) {

1336 i‡(
off£ts
[
i
] !
off£ts2
[i]) {

1337 
subåì
 = 0;

1342 i‡(!
subåì
) {

1343 i‡(
∑πül
 =
chaö
) {

1345 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1346 &
ƒ
, &nr+1,

1347 (
chaö
+
n
-1Ë- 
∑πül
);

1348 *
∑πül
->
p
 = 0;

1351 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1352 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1353 
∑πül
->
p
,

1354 
∑πül
->
p
+1,

1355 (
chaö
+
n
-1Ë- 
∑πül
);

1360 i‡(!
ƒ2
) {

1367 
∑πül2
->
p
++;

1370 
∑πül
 > 
chaö
 || 
∑πül2
 > 
chaö2
) {

1371 
dïth
 = (
chaö
+
n
-1Ë- 
∑πül
;

1372 
dïth2
 = (
chaö2
+
n2
-1Ë- 
∑πül2
;

1374 i‡(
∑πül
 > 
chaö
 && 
∑πül2
 > 
chaö2
 &&

1375 
∑πül
->
bh
->
b_blockƒ
 =
∑πül2
->bh->b_blocknr) {

1380 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1381 
∑πül
->
p
 + 1,

1382 
∑πül2
->
p
,

1383 (
chaö
+
n
-1Ë- 
∑πül
);

1384 
˛ónup
;

1394 i‡(
∑πül
 > 
chaö
 && 
dïth
 <
dïth2
) {

1395 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1396 
∑πül
->
p
 + 1,

1397 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1398 (
chaö
+
n
-1Ë- 
∑πül
);

1399 
∑πül
--;

1401 i‡(
∑πül2
 > 
chaö2
 && 
dïth2
 <
dïth
) {

1402 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1403 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1404 
∑πül2
->
p
,

1405 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1406 
∑πül2
--;

1410 
˛ónup
:

1411 
p
 &&Ö > 
chaö
) {

1412 
	`BUFFER_TRACE
(
p
->
bh
, "call brelse");

1413 
	`bªl£
(
p
->
bh
);

1414 
p
--;

1416 
p2
 &&Ö2 > 
chaö2
) {

1417 
	`BUFFER_TRACE
(
p2
->
bh
, "call brelse");

1418 
	`bªl£
(
p2
->
bh
);

1419 
p2
--;

1423 
do_ödúe˘s
:

1425 
off£ts
[0]) {

1427 i‡(++
n
 >
n2
)

1429 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1430 i‡(
ƒ
) {

1431 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1432 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1435 
PXT4_IND_BLOCK
:

1436 i‡(++
n
 >
n2
)

1438 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1439 i‡(
ƒ
) {

1440 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1441 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1444 
PXT4_DIND_BLOCK
:

1445 i‡(++
n
 >
n2
)

1447 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1448 i‡(
ƒ
) {

1449 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1450 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1453 
PXT4_TIND_BLOCK
:

1456 
˛ónup
;

1457 
	}
}

	@inline.c

7 
	~<löux/iom≠.h
>

8 
	~<löux/fõm≠.h
>

9 
	~<löux/ivîsi⁄.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

14 
	~"åunˇã.h
"

16 
	#PXT4_XATTR_SYSTEM_DATA
 "d©a"

	)

17 
	#PXT4_MIN_INLINE_DATA_SIZE
 (((
__À32
Ë* 
PXT4_N_BLOCKS
))

	)

18 
	#PXT4_INLINE_DOTDOT_OFFSET
 2

	)

19 
	#PXT4_INLINE_DOTDOT_SIZE
 4

	)

21 
	$pxt4_gë_ölöe_size
(
öode
 *inode)

23 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
)

24  
	`PXT4_I
(
öode
)->
i_ölöe_size
;

27 
	}
}

29 
	$gë_max_ölöe_x©å_vÆue_size
(
öode
 *inode,

30 
pxt4_ûoc
 *
ûoc
)

32 
pxt4_x©å_ibody_hódî
 *
hódî
;

33 
pxt4_x©å_íåy
 *
íåy
;

34 
pxt4_öode
 *
øw_öode
;

35 
‰ì
, 
mö_offs
;

37 
mö_offs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 -

38 
PXT4_GOOD_OLD_INODE_SIZE
 -

39 
	`PXT4_I
(
öode
)->
i_exåa_isize
 -

40 (
pxt4_x©å_ibody_hódî
);

47 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

48  
	`PXT4_XATTR_SIZE
(
mö_offs
 -

49 
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
)) -

50 
PXT4_XATTR_ROUND
 - (
__u32
));

52 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

53 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

54 
íåy
 = 
	`IFIRST
(
hódî
);

57 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

58 i‡(!
íåy
->
e_vÆue_öum
 &&É¡ry->
e_vÆue_size
) {

59 
size_t
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

60 i‡(
offs
 < 
mö_offs
)

61 
mö_offs
 = 
offs
;

64 
‰ì
 = 
mö_offs
 -

65 ((*)
íåy
 - (*)
	`IFIRST
(
hódî
)Ë- (
__u32
);

67 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

68 
íåy
 = (
pxt4_x©å_íåy
 *)

69 ((*)
øw_öode
 + 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

71 
‰ì
 +
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

72 
out
;

75 
‰ì
 -
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
));

77 i‡(
‰ì
 > 
PXT4_XATTR_ROUND
)

78 
‰ì
 = 
	`PXT4_XATTR_SIZE
(‰ì - 
PXT4_XATTR_ROUND
);

80 
‰ì
 = 0;

82 
out
:

83  
‰ì
;

84 
	}
}

91 
	$pxt4_gë_max_ölöe_size
(
öode
 *inode)

93 
îr‹
, 
max_ölöe_size
;

94 
pxt4_ûoc
 
ûoc
;

96 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

99 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

100 i‡(
îr‹
) {

101 
	`pxt4_îr‹_öode
(
öode
, 
__func__
, 
__LINE__
, 0,

103 
öode
->
i_öo
);

107 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

108 
max_ölöe_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
öode
, &
ûoc
);

109 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

111 
	`bªl£
(
ûoc
.
bh
);

113 i‡(!
max_ölöe_size
)

116  
max_ölöe_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

117 
	}
}

124 
	$pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode)

126 
pxt4_x©å_ibody_föd
 
is
 = {

127 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

129 
pxt4_x©å_öfo
 
i
 = {

130 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

131 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

133 
îr‹
;

135 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

138 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

139 i‡(
îr‹
)

140  
îr‹
;

142 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

143 i‡(
îr‹
)

144 
out
;

146 i‡(!
is
.
s
.
nŸ_found
) {

147 i‡(
is
.
s
.
hîe
->
e_vÆue_öum
) {

148 
	`PXT4_ERROR_INODE
(
öode
, "inline data xattrÑefers "

150 
îr‹
 = -
EFSCORRUPTED
;

151 
out
;

153 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

154 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

155 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

156 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

159 
out
:

160 
	`bªl£
(
is
.
ûoc
.
bh
);

161  
îr‹
;

162 
	}
}

164 
	$pxt4_ªad_ölöe_d©a
(
öode
 *öode, *
buf„r
,

165 
Àn
,

166 
pxt4_ûoc
 *
ûoc
)

168 
pxt4_x©å_íåy
 *
íåy
;

169 
pxt4_x©å_ibody_hódî
 *
hódî
;

170 
˝_Àn
 = 0;

171 
pxt4_öode
 *
øw_öode
;

173 i‡(!
Àn
)

176 
	`BUG_ON
(
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

178 
˝_Àn
 = 
Àn
 < 
PXT4_MIN_INLINE_DATA_SIZE
 ?

179 
Àn
 : 
PXT4_MIN_INLINE_DATA_SIZE
;

181 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

182 
	`mem˝y
(
buf„r
, (*)(
øw_öode
->
i_block
), 
˝_Àn
);

184 
Àn
 -
˝_Àn
;

185 
buf„r
 +
˝_Àn
;

187 i‡(!
Àn
)

188 
out
;

190 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

191 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

192 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

193 
Àn
 = 
	`mö_t
(,Üen,

194 ()
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

196 
	`mem˝y
(
buf„r
,

197 (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
), 
Àn
);

198 
˝_Àn
 +
Àn
;

200 
out
:

201  
˝_Àn
;

202 
	}
}

210 
	$pxt4_wrôe_ölöe_d©a
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
,

211 *
buf„r
, 
loff_t
 
pos
, 
Àn
)

213 
pxt4_x©å_íåy
 *
íåy
;

214 
pxt4_x©å_ibody_hódî
 *
hódî
;

215 
pxt4_öode
 *
øw_öode
;

216 
˝_Àn
 = 0;

218 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

221 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

222 
	`BUG_ON
(
pos
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

224 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

225 
buf„r
 +
pos
;

227 i‡(
pos
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

228 
˝_Àn
 = 
pos
 + 
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

229 
PXT4_MIN_INLINE_DATA_SIZE
 - 
pos
 : 
Àn
;

230 
	`mem˝y
((*)
øw_öode
->
i_block
 + 
pos
, 
buf„r
, 
˝_Àn
);

232 
Àn
 -
˝_Àn
;

233 
buf„r
 +
˝_Àn
;

234 
pos
 +
˝_Àn
;

237 i‡(!
Àn
)

240 
pos
 -
PXT4_MIN_INLINE_DATA_SIZE
;

241 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

242 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

243 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

245 
	`mem˝y
((*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
Ë+ 
pos
,

246 
buf„r
, 
Àn
);

247 
	}
}

249 
	$pxt4_¸óã_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
Àn
)

252 
îr‹
;

253 *
vÆue
 = 
NULL
;

254 
pxt4_x©å_ibody_föd
 
is
 = {

255 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

257 
pxt4_x©å_öfo
 
i
 = {

258 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

259 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

262 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

263 i‡(
îr‹
)

264  
îr‹
;

266 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

267 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

268 i‡(
îr‹
)

269 
out
;

271 i‡(
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

272 
vÆue
 = 
PXT4_ZERO_XATTR_VALUE
;

273 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

275 
vÆue
 = "";

276 
Àn
 = 0;

280 
i
.
vÆue
 = value;

281 
i
.
vÆue_Àn
 = 
Àn
;

283 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

284 i‡(
îr‹
)

285 
out
;

287 
	`BUG_ON
(!
is
.
s
.
nŸ_found
);

289 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

290 i‡(
îr‹
) {

291 i‡(
îr‹
 =-
ENOSPC
)

292 
	`pxt4_˛ór_öode_°©e
(
öode
,

293 
PXT4_STATE_MAY_INLINE_DATA
);

294 
out
;

297 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

298 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

300 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

301 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

302 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
Àn
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

303 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

304 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

305 
	`gë_bh
(
is
.
ûoc
.
bh
);

306 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

308 
out
:

309 
	`bªl£
(
is
.
ûoc
.
bh
);

310  
îr‹
;

311 
	}
}

313 
	$pxt4_upd©e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

314 
Àn
)

316 
îr‹
;

317 *
vÆue
 = 
NULL
;

318 
pxt4_x©å_ibody_föd
 
is
 = {

319 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

321 
pxt4_x©å_öfo
 
i
 = {

322 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

323 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

327 i‡(
Àn
 <
	`PXT4_I
(
öode
)->
i_ölöe_size
)

330 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

331 i‡(
îr‹
)

332  
îr‹
;

334 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

335 i‡(
îr‹
)

336 
out
;

338 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

340 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

341 
vÆue
 = 
	`kzÆloc
(
Àn
, 
GFP_NOFS
);

342 i‡(!
vÆue
) {

343 
îr‹
 = -
ENOMEM
;

344 
out
;

347 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
, i.
«me
,

348 
vÆue
, 
Àn
);

349 i‡(
îr‹
 =-
ENODATA
)

350 
out
;

352 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

353 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

354 i‡(
îr‹
)

355 
out
;

358 
i
.
vÆue
 = value;

359 
i
.
vÆue_Àn
 = 
Àn
;

361 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

362 i‡(
îr‹
)

363 
out
;

365 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

366 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

367 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

368 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

369 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

370 
	`gë_bh
(
is
.
ûoc
.
bh
);

371 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

373 
out
:

374 
	`k‰ì
(
vÆue
);

375 
	`bªl£
(
is
.
ûoc
.
bh
);

376  
îr‹
;

377 
	}
}

379 
	$pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

380 
Àn
)

382 
ªt
, 
size
, 
no_ex∑nd
;

383 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

385 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
))

386  -
ENOSPC
;

388 
size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

389 i‡(
size
 < 
Àn
)

390  -
ENOSPC
;

392 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

394 i‡(
ei
->
i_ölöe_off
)

395 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

397 
ªt
 = 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

399 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

400  
ªt
;

401 
	}
}

403 
	$pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

404 
öode
 *inode)

406 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

407 
pxt4_x©å_ibody_föd
 
is
 = {

408 .
s
 = { .
nŸ_found
 = 0, },

410 
pxt4_x©å_öfo
 
i
 = {

411 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

412 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

413 .
vÆue
 = 
NULL
,

414 .
vÆue_Àn
 = 0,

416 
îr‹
;

418 i‡(!
ei
->
i_ölöe_off
)

421 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

422 i‡(
îr‹
)

423  
îr‹
;

425 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

426 i‡(
îr‹
)

427 
out
;

429 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

430 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

431 i‡(
îr‹
)

432 
out
;

434 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

435 i‡(
îr‹
)

436 
out
;

438 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

439 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

440 
	`mem£t
(
ei
->
i_d©a
, 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

442 i‡(
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
)) {

443 i‡(
	`S_ISDIR
(
öode
->
i_mode
) ||

444 
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) {

445 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

446 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

449 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

451 
	`gë_bh
(
is
.
ûoc
.
bh
);

452 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

454 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

455 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 0;

456 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

457 
out
:

458 
	`bªl£
(
is
.
ûoc
.
bh
);

459 i‡(
îr‹
 =-
ENODATA
)

460 
îr‹
 = 0;

461  
îr‹
;

462 
	}
}

464 
	$pxt4_ªad_ölöe_∑ge
(
öode
 *öode, 
∑ge
 *page)

466 *
kaddr
;

467 
ªt
 = 0;

468 
size_t
 
Àn
;

469 
pxt4_ûoc
 
ûoc
;

471 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

472 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

473 
	`BUG_ON
(
∑ge
->
ödex
);

475 i‡(!
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

476 
	`pxt4_w¨nög
(
öode
->
i_sb
, "inode %lu doesn't have inline data.",

477 
öode
->
i_öo
);

478 
out
;

481 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

482 i‡(
ªt
)

483 
out
;

485 
Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
), 
	`i_size_ªad
(inode));

486 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

487 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
kaddr
, 
Àn
, &
ûoc
);

488 
	`Êush_dˇche_∑ge
(
∑ge
);

489 
	`kunm≠_©omic
(
kaddr
);

490 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

491 
	`SëPageU±od©e
(
∑ge
);

492 
	`bªl£
(
ûoc
.
bh
);

494 
out
:

495  
ªt
;

496 
	}
}

498 
	$pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page)

500 
ªt
 = 0;

502 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

503 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

504 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

505  -
EAGAIN
;

512 i‡(!
∑ge
->
ödex
)

513 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

514 i‡(!
	`PageU±od©e
(
∑ge
)) {

515 
	`zîo_u£r_£gmít
(
∑ge
, 0, 
PAGE_SIZE
);

516 
	`SëPageU±od©e
(
∑ge
);

519 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

521 
	`u∆ock_∑ge
(
∑ge
);

522  
ªt
 >= 0 ? 0 :Ñet;

523 
	}
}

525 
	$pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

526 
öode
 *inode,

527 
Êags
)

529 
ªt
, 
√eded_blocks
, 
no_ex∑nd
;

530 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

531 
ªåõs
 = 0, 
£m_hñd
 = 0;

532 
∑ge
 *∑gê
NULL
;

533 
‰om
, 
to
;

534 
pxt4_ûoc
 
ûoc
;

536 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

541 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

545 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

547 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

548 i‡(
ªt
)

549  
ªt
;

551 
ªåy
:

552 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

553 i‡(
	`IS_ERR
(
h™dÀ
)) {

554 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

555 
h™dÀ
 = 
NULL
;

556 
out
;

561 
Êags
 |
AOP_FLAG_NOFS
;

563 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

564 i‡(!
∑ge
) {

565 
ªt
 = -
ENOMEM
;

566 
out
;

569 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

570 
£m_hñd
 = 1;

572 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

573 
ªt
 = 0;

574 
out
;

577 
‰om
 = 0;

578 
to
 = 
	`pxt4_gë_ölöe_size
(
öode
);

579 i‡(!
	`PageU±od©e
(
∑ge
)) {

580 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

581 i‡(
ªt
 < 0)

582 
out
;

585 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

586 i‡(
ªt
)

587 
out
;

589 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

590 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
,

591 
pxt4_gë_block_unwrôãn
);

593 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
, 
pxt4_gë_block
);

595 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

596 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

597 
‰om
, 
to
, 
NULL
,

598 
do_jou∫Æ_gë_wrôe_ac˚ss
);

601 i‡(
ªt
) {

602 
	`u∆ock_∑ge
(
∑ge
);

603 
	`put_∑ge
(
∑ge
);

604 
∑ge
 = 
NULL
;

605 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

606 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

607 
£m_hñd
 = 0;

608 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

609 
h™dÀ
 = 
NULL
;

610 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

617 i‡(
öode
->
i_∆ök
)

618 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

621 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

622 
ªåy
;

624 i‡(
∑ge
)

625 
	`block_commô_wrôe
(
∑ge
, 
‰om
, 
to
);

626 
out
:

627 i‡(
∑ge
) {

628 
	`u∆ock_∑ge
(
∑ge
);

629 
	`put_∑ge
(
∑ge
);

631 i‡(
£m_hñd
)

632 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

633 i‡(
h™dÀ
)

634 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

635 
	`bªl£
(
ûoc
.
bh
);

636  
ªt
;

637 
	}
}

645 
	$pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

646 
öode
 *inode,

647 
loff_t
 
pos
, 
Àn
,

648 
Êags
,

649 
∑ge
 **
∑gï
)

651 
ªt
;

652 
h™dÀ_t
 *
h™dÀ
;

653 
∑ge
 *page;

654 
pxt4_ûoc
 
ûoc
;

656 i‡(
pos
 + 
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
))

657 
c⁄vît
;

659 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

660 i‡(
ªt
)

661  
ªt
;

667 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

668 i‡(
	`IS_ERR
(
h™dÀ
)) {

669 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

670 
h™dÀ
 = 
NULL
;

671 
out
;

674 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

675 i‡(
ªt
 &&Ñë !-
ENOSPC
)

676 
out
;

679 i‡(
ªt
 =-
ENOSPC
) {

680 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

681 
	`bªl£
(
ûoc
.
bh
);

682 
c⁄vît
;

685 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

686 i‡(
ªt
)

687 
out
;

689 
Êags
 |
AOP_FLAG_NOFS
;

691 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

692 i‡(!
∑ge
) {

693 
ªt
 = -
ENOMEM
;

694 
out
;

697 *
∑gï
 = 
∑ge
;

698 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

699 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

700 
ªt
 = 0;

701 
	`u∆ock_∑ge
(
∑ge
);

702 
	`put_∑ge
(
∑ge
);

703 
out_up_ªad
;

706 i‡(!
	`PageU±od©e
(
∑ge
)) {

707 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

708 i‡(
ªt
 < 0) {

709 
	`u∆ock_∑ge
(
∑ge
);

710 
	`put_∑ge
(
∑ge
);

711 
out_up_ªad
;

715 
ªt
 = 1;

716 
h™dÀ
 = 
NULL
;

717 
out_up_ªad
:

718 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

719 
out
:

720 i‡(
h™dÀ
 && (
ªt
 != 1))

721 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

722 
	`bªl£
(
ûoc
.
bh
);

723  
ªt
;

724 
c⁄vît
:

725  
	`pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

726 
öode
, 
Êags
);

727 
	}
}

729 
	$pxt4_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
,

730 
c›õd
, 
∑ge
 *page)

732 
ªt
, 
no_ex∑nd
;

733 *
kaddr
;

734 
pxt4_ûoc
 
ûoc
;

736 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
)) {

737 i‡(!
	`PageU±od©e
(
∑ge
)) {

738 
c›õd
 = 0;

739 
out
;

743 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

744 i‡(
ªt
) {

745 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

746 
c›õd
 = 0;

747 
out
;

750 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

751 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

753 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

754 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 
pos
, 
Àn
);

755 
	`kunm≠_©omic
(
kaddr
);

756 
	`SëPageU±od©e
(
∑ge
);

758 
	`CÀ¨PageDúty
(
∑ge
);

760 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

761 
	`bªl£
(
ûoc
.
bh
);

762 
	`m¨k_öode_dúty
(
öode
);

763 
out
:

764  
c›õd
;

765 
	}
}

767 
buf„r_hód
 *

768 
	$pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

769 
Àn
,

770 
∑ge
 *page)

772 
ªt
, 
no_ex∑nd
;

773 *
kaddr
;

774 
pxt4_ûoc
 
ûoc
;

776 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

777 i‡(
ªt
) {

778 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

779  
NULL
;

782 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

783 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

784 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 0, 
Àn
);

785 
	`kunm≠_©omic
(
kaddr
);

786 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

788  
ûoc
.
bh
;

789 
	}
}

800 
	$pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

801 
öode
 *inode,

802 
Êags
,

803 **
fsd©a
)

805 
ªt
 = 0, 
ölöe_size
;

806 
∑ge
 *page;

808 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

809 i‡(!
∑ge
)

810  -
ENOMEM
;

812 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

813 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

814 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

815 
out
;

818 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

820 i‡(!
	`PageU±od©e
(
∑ge
)) {

821 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

822 i‡(
ªt
 < 0)

823 
out
;

826 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 0, 
ölöe_size
,

827 
pxt4_da_gë_block_¥ï
);

828 i‡(
ªt
) {

829 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

830 
	`u∆ock_∑ge
(
∑ge
);

831 
	`put_∑ge
(
∑ge
);

832 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

833  
ªt
;

836 
	`SëPageDúty
(
∑ge
);

837 
	`SëPageU±od©e
(
∑ge
);

838 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

839 *
fsd©a
 = (*)
CONVERT_INLINE_DATA
;

841 
out
:

842 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

843 i‡(
∑ge
) {

844 
	`u∆ock_∑ge
(
∑ge
);

845 
	`put_∑ge
(
∑ge
);

847  
ªt
;

848 
	}
}

858 
	$pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

859 
öode
 *inode,

860 
loff_t
 
pos
, 
Àn
,

861 
Êags
,

862 
∑ge
 **
∑gï
,

863 **
fsd©a
)

865 
ªt
, 
ölöe_size
;

866 
h™dÀ_t
 *
h™dÀ
;

867 
∑ge
 *page;

868 
pxt4_ûoc
 
ûoc
;

869 
ªåõs
 = 0;

871 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

872 i‡(
ªt
)

873  
ªt
;

875 
ªåy_jou∫Æ
:

876 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

877 i‡(
	`IS_ERR
(
h™dÀ
)) {

878 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

879 
out
;

882 
ölöe_size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

884 
ªt
 = -
ENOSPC
;

885 i‡(
ölöe_size
 >
pos
 + 
Àn
) {

886 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

887 i‡(
ªt
 &&Ñë !-
ENOSPC
)

888 
out_jou∫Æ
;

895 
Êags
 |
AOP_FLAG_NOFS
;

897 i‡(
ªt
 =-
ENOSPC
) {

898 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

899 
ªt
 = 
	`pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

900 
öode
,

901 
Êags
,

902 
fsd©a
);

903 i‡(
ªt
 =-
ENOSPC
 &&

904 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

905 
ªåy_jou∫Æ
;

906 
out
;

909 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

910 i‡(!
∑ge
) {

911 
ªt
 = -
ENOMEM
;

912 
out_jou∫Æ
;

915 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

916 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

917 
ªt
 = 0;

918 
out_ªÀa£_∑ge
;

921 i‡(!
	`PageU±od©e
(
∑ge
)) {

922 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

923 i‡(
ªt
 < 0)

924 
out_ªÀa£_∑ge
;

926 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

927 i‡(
ªt
)

928 
out_ªÀa£_∑ge
;

930 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

931 *
∑gï
 = 
∑ge
;

932 
	`bªl£
(
ûoc
.
bh
);

934 
out_ªÀa£_∑ge
:

935 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

936 
	`u∆ock_∑ge
(
∑ge
);

937 
	`put_∑ge
(
∑ge
);

938 
out_jou∫Æ
:

939 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

940 
out
:

941 
	`bªl£
(
ûoc
.
bh
);

942  
ªt
;

943 
	}
}

945 
	$pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

946 
Àn
, 
c›õd
,

947 
∑ge
 *page)

949 
ªt
;

951 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
, 
∑ge
);

952 i‡(
ªt
 < 0) {

953 
	`u∆ock_∑ge
(
∑ge
);

954 
	`put_∑ge
(
∑ge
);

955  
ªt
;

957 
c›õd
 = 
ªt
;

966 i‡(
pos
+
c›õd
 > 
öode
->
i_size
)

967 
	`i_size_wrôe
(
öode
, 
pos
+
c›õd
);

968 
	`u∆ock_∑ge
(
∑ge
);

969 
	`put_∑ge
(
∑ge
);

977 
	`m¨k_öode_dúty
(
öode
);

979  
c›õd
;

980 
	}
}

982 #ifde‡
INLINE_DIR_DEBUG


983 
	$pxt4_show_ölöe_dú
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

984 *
ölöe_°¨t
, 
ölöe_size
)

986 
off£t
;

987 
de_Àn
;

988 
pxt4_dú_íåy_2
 *
de
 = 
ölöe_°¨t
;

989 *
dlimô
 = 
ölöe_°¨t
 + 
ölöe_size
;

991 
	`åa˚_¥ötk
("öodê%lu\n", 
dú
->
i_öo
);

992 
off£t
 = 0;

993 (*)
de
 < 
dlimô
) {

994 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

995 
	`åa˚_¥ötk
("de: off %uÑlen %uÇame %.*sÇlen %u ino %u\n",

996 
off£t
, 
de_Àn
, 
de
->
«me_Àn
, de->
«me
,

997 
de
->
«me_Àn
, 
	`À32_to_˝u
(de->
öode
));

998 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

999 
ölöe_°¨t
, 
ölöe_size
, 
off£t
))

1000 
	`BUG
();

1002 
off£t
 +
de_Àn
;

1003 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1005 
	}
}

1007 
	#pxt4_show_ölöe_dú
(
dú
, 
bh
, 
ölöe_°¨t
, 
ölöe_size
)

	)

1015 
	$pxt4_add_dúít_to_ölöe
(
h™dÀ_t
 *
h™dÀ
,

1016 
pxt4_fûíame
 *
‚ame
,

1017 
öode
 *
dú
,

1018 
öode
 *inode,

1019 
pxt4_ûoc
 *
ûoc
,

1020 *
ölöe_°¨t
, 
ölöe_size
)

1022 
îr
;

1023 
pxt4_dú_íåy_2
 *
de
;

1025 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
ûoc
->
bh
, 
ölöe_°¨t
,

1026 
ölöe_size
, 
‚ame
, &
de
);

1027 i‡(
îr
)

1028  
îr
;

1030 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

1031 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

1032 i‡(
îr
)

1033  
îr
;

1034 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
ölöe_size
, 
‚ame
);

1036 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
->
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1049 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

1050 
	`pxt4_upd©e_dx_Êag
(
dú
);

1051 
	`öode_öc_ivîsi⁄
(
dú
);

1053 
	}
}

1055 *
	$pxt4_gë_ölöe_x©å_pos
(
öode
 *inode,

1056 
pxt4_ûoc
 *
ûoc
)

1058 
pxt4_x©å_íåy
 *
íåy
;

1059 
pxt4_x©å_ibody_hódî
 *
hódî
;

1061 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1063 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(
ûoc
));

1064 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
	`pxt4_øw_öode
(
ûoc
) +

1065 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1067  (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

1068 
	}
}

1071 
	$pxt4_upd©e_föÆ_de
(*
de_buf
, 
ﬁd_size
, 
√w_size
)

1073 
pxt4_dú_íåy_2
 *
de
, *
¥ev_de
;

1074 *
limô
;

1075 
de_Àn
;

1077 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1078 i‡(
ﬁd_size
) {

1079 
limô
 = 
de_buf
 + 
ﬁd_size
;

1081 
¥ev_de
 = 
de
;

1082 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ﬁd_size
);

1083 
de_buf
 +
de_Àn
;

1084 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1085 } 
de_buf
 < 
limô
);

1087 
¥ev_de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
de_Àn
 + 
√w_size
 -

1088 
ﬁd_size
, 
√w_size
);

1091 
de
->
öode
 = 0;

1092 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
√w_size
,Çew_size);

1094 
	}
}

1096 
	$pxt4_upd©e_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1097 
pxt4_ûoc
 *
ûoc
)

1099 
ªt
;

1100 
ﬁd_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
;

1101 
√w_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
dú
, 
ûoc
);

1103 i‡(
√w_size
 - 
ﬁd_size
 <
	`PXT4_DIR_REC_LEN
(1))

1104  -
ENOSPC
;

1106 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
dú
,

1107 
√w_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
);

1108 i‡(
ªt
)

1109  
ªt
;

1111 
	`pxt4_upd©e_föÆ_de
(
	`pxt4_gë_ölöe_x©å_pos
(
dú
, 
ûoc
), 
ﬁd_size
,

1112 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1113 
PXT4_MIN_INLINE_DATA_SIZE
);

1114 
dú
->
i_size
 = 
	`PXT4_I
(dú)->
i_disksize
 = PXT4_I(dú)->
i_ölöe_size
;

1116 
	}
}

1118 
	$pxt4_ª°‹e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1119 
pxt4_ûoc
 *
ûoc
,

1120 *
buf
, 
ölöe_size
)

1122 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1123 
	`pxt4_wrôe_ölöe_d©a
(
öode
, 
ûoc
, 
buf
, 0, 
ölöe_size
);

1124 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1125 
	}
}

1127 
	$pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

1128 
öode
 *inode,

1129 
buf„r_hód
 *
dú_block
,

1130 *
buf
,

1131 
ölöe_size
)

1133 
îr
, 
csum_size
 = 0, 
hódî_size
 = 0;

1134 
pxt4_dú_íåy_2
 *
de
;

1135 *
èrgë
 = 
dú_block
->
b_d©a
;

1141 
de
 = (
pxt4_dú_íåy_2
 *)
èrgë
;

1142 
de
 = 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, de,

1143 
öode
->
i_sb
->
s_blocksize
, 
csum_size
,

1144 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
buf
)->
öode
), 1);

1145 
hódî_size
 = (*)
de
 - 
èrgë
;

1147 
	`mem˝y
((*)
de
, 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1148 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1150 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1151 
csum_size
 = (
pxt4_dú_íåy_èû
);

1153 
öode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

1154 
	`i_size_wrôe
(
öode
, inode->
i_sb
->
s_blocksize
);

1155 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_sb
->
s_blocksize
;

1156 
	`pxt4_upd©e_föÆ_de
(
dú_block
->
b_d©a
,

1157 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
 + 
hódî_size
,

1158 
öode
->
i_sb
->
s_blocksize
 - 
csum_size
);

1160 i‡(
csum_size
)

1161 
	`pxt4_öôülize_dúít_èû
(
dú_block
,

1162 
öode
->
i_sb
->
s_blocksize
);

1163 
	`£t_buf„r_u±od©e
(
dú_block
);

1164 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

1165 i‡(
îr
)

1166  
îr
;

1167 
	`£t_buf„r_vîifõd
(
dú_block
);

1168  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1169 
	}
}

1171 
	$pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

1172 
öode
 *inode,

1173 
pxt4_ûoc
 *
ûoc
)

1175 
îr‹
;

1176 *
buf
 = 
NULL
;

1177 
buf„r_hód
 *
d©a_bh
 = 
NULL
;

1178 
pxt4_m≠_blocks
 
m≠
;

1179 
ölöe_size
;

1181 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1182 
buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1183 i‡(!
buf
) {

1184 
îr‹
 = -
ENOMEM
;

1185 
out
;

1188 
îr‹
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
buf
, 
ölöe_size
, 
ûoc
);

1189 i‡(
îr‹
 < 0)

1190 
out
;

1196 i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

1197 
îr‹
 = 
	`pxt4_check_Æl_de
(
öode
, 
ûoc
->
bh
,

1198 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1199 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1200 i‡(
îr‹
)

1201 
out
;

1204 
îr‹
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1205 i‡(
îr‹
)

1206 
out
;

1208 
m≠
.
m_lblk
 = 0;

1209 
m≠
.
m_Àn
 = 1;

1210 
m≠
.
m_Êags
 = 0;

1211 
îr‹
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
PXT4_GET_BLOCKS_CREATE
);

1212 i‡(
îr‹
 < 0)

1213 
out_ª°‹e
;

1214 i‡(!(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
)) {

1215 
îr‹
 = -
EIO
;

1216 
out_ª°‹e
;

1219 
d©a_bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

1220 i‡(!
d©a_bh
) {

1221 
îr‹
 = -
ENOMEM
;

1222 
out_ª°‹e
;

1225 
	`lock_buf„r
(
d©a_bh
);

1226 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
d©a_bh
);

1227 i‡(
îr‹
) {

1228 
	`u∆ock_buf„r
(
d©a_bh
);

1229 
îr‹
 = -
EIO
;

1230 
out_ª°‹e
;

1232 
	`mem£t
(
d©a_bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1234 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

1235 
	`mem˝y
(
d©a_bh
->
b_d©a
, 
buf
, 
ölöe_size
);

1236 
	`£t_buf„r_u±od©e
(
d©a_bh
);

1237 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1238 
öode
, 
d©a_bh
);

1240 
îr‹
 = 
	`pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ
, 
öode
, 
d©a_bh
,

1241 
buf
, 
ölöe_size
);

1244 
	`u∆ock_buf„r
(
d©a_bh
);

1245 
out_ª°‹e
:

1246 i‡(
îr‹
)

1247 
	`pxt4_ª°‹e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ûoc
, 
buf
, 
ölöe_size
);

1249 
out
:

1250 
	`bªl£
(
d©a_bh
);

1251 
	`k‰ì
(
buf
);

1252  
îr‹
;

1253 
	}
}

1260 
	$pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1261 
öode
 *
dú
, inode *inode)

1263 
ªt
, 
ölöe_size
, 
no_ex∑nd
;

1264 *
ölöe_°¨t
;

1265 
pxt4_ûoc
 
ûoc
;

1267 
ªt
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1268 i‡(
ªt
)

1269  
ªt
;

1271 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1272 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
))

1273 
out
;

1275 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1276 
PXT4_INLINE_DOTDOT_SIZE
;

1277 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1279 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, &
ûoc
,

1280 
ölöe_°¨t
, 
ölöe_size
);

1281 i‡(
ªt
 !-
ENOSPC
)

1282 
out
;

1285 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1286 
PXT4_MIN_INLINE_DATA_SIZE
;

1287 i‡(!
ölöe_size
) {

1289 
ªt
 = 
	`pxt4_upd©e_ölöe_dú
(
h™dÀ
, 
dú
, &
ûoc
);

1290 i‡(
ªt
 &&Ñë !-
ENOSPC
)

1291 
out
;

1293 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1294 
PXT4_MIN_INLINE_DATA_SIZE
;

1297 i‡(
ölöe_size
) {

1298 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1300 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
,

1301 
öode
, &
ûoc
, 
ölöe_°¨t
,

1302 
ölöe_size
);

1304 i‡(
ªt
 !-
ENOSPC
)

1305 
out
;

1313 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
dú
, &
ûoc
);

1315 
out
:

1316 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1317 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1318 
	`bªl£
(
ûoc
.
bh
);

1319  
ªt
;

1320 
	}
}

1327 
	$pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

1328 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1329 
dx_hash_öfo
 *
höfo
,

1330 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

1331 *
has_ölöe_d©a
)

1333 
îr
 = 0, 
cou¡
 = 0;

1334 
∑ª¡_öo
;

1335 
pos
;

1336 
pxt4_dú_íåy_2
 *
de
;

1337 
öode
 *öodê
	`fûe_öode
(
dú_fûe
);

1338 
ªt
, 
ölöe_size
 = 0;

1339 
pxt4_ûoc
 
ûoc
;

1340 *
dú_buf
 = 
NULL
;

1341 
pxt4_dú_íåy_2
 
Áke
;

1342 
fs¸y±_°r
 
tmp_°r
;

1344 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1345 i‡(
ªt
)

1346  
ªt
;

1348 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1349 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1350 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1351 *
has_ölöe_d©a
 = 0;

1352 
out
;

1355 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1356 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1357 i‡(!
dú_buf
) {

1358 
ªt
 = -
ENOMEM
;

1359 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1360 
out
;

1363 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1364 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1365 i‡(
ªt
 < 0)

1366 
out
;

1368 
pos
 = 0;

1369 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1370 
pos
 < 
ölöe_size
) {

1376 i‡(
pos
 == 0) {

1377 
Áke
.
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1378 
Áke
.
«me_Àn
 = 1;

1379 
	`°r˝y
(
Áke
.
«me
, ".");

1380 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1381 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1382 
ölöe_size
);

1383 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1384 
de
 = &
Áke
;

1385 
pos
 = 
PXT4_INLINE_DOTDOT_OFFSET
;

1386 } i‡(
pos
 =
PXT4_INLINE_DOTDOT_OFFSET
) {

1387 
Áke
.
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

1388 
Áke
.
«me_Àn
 = 2;

1389 
	`°r˝y
(
Áke
.
«me
, "..");

1390 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1391 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1392 
ölöe_size
);

1393 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1394 
de
 = &
Áke
;

1395 
pos
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1397 
de
 = (
pxt4_dú_íåy_2
 *)(
dú_buf
 + 
pos
);

1398 
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1399 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
dú_fûe
, 
de
,

1400 
ûoc
.
bh
, 
dú_buf
,

1401 
ölöe_size
, 
pos
)) {

1402 
ªt
 = 
cou¡
;

1403 
out
;

1407 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1408 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1409 ((
höfo
->
hash
 =
°¨t_hash
) &&

1410 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1412 i‡(
de
->
öode
 == 0)

1414 
tmp_°r
.
«me
 = 
de
->name;

1415 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1416 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 
höfo
->
hash
,

1417 
höfo
->
mö‹_hash
, 
de
, &
tmp_°r
);

1418 i‡(
îr
) {

1419 
ªt
 = 
îr
;

1420 
out
;

1422 
cou¡
++;

1424 
ªt
 = 
cou¡
;

1425 
out
:

1426 
	`k‰ì
(
dú_buf
);

1427 
	`bªl£
(
ûoc
.
bh
);

1428  
ªt
;

1429 
	}
}

1439 
	$pxt4_ªad_ölöe_dú
(
fûe
 *file,

1440 
dú_c⁄ãxt
 *
˘x
,

1441 *
has_ölöe_d©a
)

1443 
off£t
, 
∑ª¡_öo
;

1444 
i
;

1445 
pxt4_dú_íåy_2
 *
de
;

1446 
su≥r_block
 *
sb
;

1447 
öode
 *öodê
	`fûe_öode
(
fûe
);

1448 
ªt
, 
ölöe_size
 = 0;

1449 
pxt4_ûoc
 
ûoc
;

1450 *
dú_buf
 = 
NULL
;

1451 
dŸdŸ_off£t
, 
dŸdŸ_size
, 
exåa_off£t
, 
exåa_size
;

1453 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1454 i‡(
ªt
)

1455  
ªt
;

1457 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1458 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1459 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1460 *
has_ölöe_d©a
 = 0;

1461 
out
;

1464 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1465 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1466 i‡(!
dú_buf
) {

1467 
ªt
 = -
ENOMEM
;

1468 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1469 
out
;

1472 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1473 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1474 i‡(
ªt
 < 0)

1475 
out
;

1477 
ªt
 = 0;

1478 
sb
 = 
öode
->
i_sb
;

1479 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1480 
off£t
 = 
˘x
->
pos
;

1489 
dŸdŸ_off£t
 = 
	`PXT4_DIR_REC_LEN
(1);

1490 
dŸdŸ_size
 = 
dŸdŸ_off£t
 + 
	`PXT4_DIR_REC_LEN
(2);

1491 
exåa_off£t
 = 
dŸdŸ_size
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1492 
exåa_size
 = 
exåa_off£t
 + 
ölöe_size
;

1500 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

1501 
i
 = 0; i < 
exåa_size
 && i < 
off£t
;) {

1506 i‡(!
i
) {

1507 
i
 = 
dŸdŸ_off£t
;

1509 } i‡(
i
 =
dŸdŸ_off£t
) {

1510 
i
 = 
dŸdŸ_size
;

1516 
de
 = (
pxt4_dú_íåy_2
 *)

1517 (
dú_buf
 + 
i
 - 
exåa_off£t
);

1524 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
)

1525 < 
	`PXT4_DIR_REC_LEN
(1))

1527 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1528 
exåa_size
);

1530 
off£t
 = 
i
;

1531 
˘x
->
pos
 = 
off£t
;

1532 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

1535 
˘x
->
pos
 < 
exåa_size
) {

1536 i‡(
˘x
->
pos
 == 0) {

1537 i‡(!
	`dú_emô
(
˘x
, ".", 1, 
öode
->
i_öo
, 
DT_DIR
))

1538 
out
;

1539 
˘x
->
pos
 = 
dŸdŸ_off£t
;

1543 i‡(
˘x
->
pos
 =
dŸdŸ_off£t
) {

1544 i‡(!
	`dú_emô
(
˘x
, "..", 2, 
∑ª¡_öo
, 
DT_DIR
))

1545 
out
;

1546 
˘x
->
pos
 = 
dŸdŸ_size
;

1550 
de
 = (
pxt4_dú_íåy_2
 *)

1551 (
dú_buf
 + 
˘x
->
pos
 - 
exåa_off£t
);

1552 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
ûoc
.
bh
, 
dú_buf
,

1553 
exåa_size
, 
˘x
->
pos
))

1554 
out
;

1555 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1556 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
, de->
«me_Àn
,

1557 
	`À32_to_˝u
(
de
->
öode
),

1558 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

1559 
out
;

1561 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
);

1563 
out
:

1564 
	`k‰ì
(
dú_buf
);

1565 
	`bªl£
(
ûoc
.
bh
);

1566  
ªt
;

1567 
	}
}

1569 
buf„r_hód
 *
	$pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

1570 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

1571 *
ªtvÆ
)

1573 
pxt4_ûoc
 
ûoc
;

1575 *
ªtvÆ
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1576 i‡(*
ªtvÆ
)

1577  
NULL
;

1579 *
∑ª¡_de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1581  
ûoc
.
bh
;

1582 
	}
}

1589 
	$pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1590 
öode
 *inode)

1592 
ªt
, 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1593 
pxt4_ûoc
 
ûoc
;

1594 
pxt4_dú_íåy_2
 *
de
;

1596 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1597 i‡(
ªt
)

1598  
ªt
;

1600 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1601 i‡(
ªt
)

1602 
out
;

1608 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1609 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡
->
i_öo
);

1610 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
PXT4_INLINE_DOTDOT_SIZE
);

1611 
de
->
öode
 = 0;

1612 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1613 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
,

1614 
ölöe_size
);

1615 
	`£t_∆ök
(
öode
, 2);

1616 
öode
->
i_size
 = 
	`PXT4_I
(öode)->
i_disksize
 = 
ölöe_size
;

1617 
out
:

1618 
	`bªl£
(
ûoc
.
bh
);

1619  
ªt
;

1620 
	}
}

1622 
buf„r_hód
 *
	$pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

1623 
pxt4_fûíame
 *
‚ame
,

1624 
pxt4_dú_íåy_2
 **
ªs_dú
,

1625 *
has_ölöe_d©a
)

1627 
ªt
;

1628 
pxt4_ûoc
 
ûoc
;

1629 *
ölöe_°¨t
;

1630 
ölöe_size
;

1632 i‡(
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
))

1633  
NULL
;

1635 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1636 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1637 *
has_ölöe_d©a
 = 0;

1638 
out
;

1641 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1642 
PXT4_INLINE_DOTDOT_SIZE
;

1643 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1644 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1645 
dú
, 
‚ame
, 0, 
ªs_dú
);

1646 i‡(
ªt
 == 1)

1647 
out_föd
;

1648 i‡(
ªt
 < 0)

1649 
out
;

1651 i‡(
	`pxt4_gë_ölöe_size
(
dú
Ë=
PXT4_MIN_INLINE_DATA_SIZE
)

1652 
out
;

1654 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1655 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
Ë- 
PXT4_MIN_INLINE_DATA_SIZE
;

1657 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1658 
dú
, 
‚ame
, 0, 
ªs_dú
);

1659 i‡(
ªt
 == 1)

1660 
out_föd
;

1662 
out
:

1663 
	`bªl£
(
ûoc
.
bh
);

1664 
ûoc
.
bh
 = 
NULL
;

1665 
out_föd
:

1666 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1667  
ûoc
.
bh
;

1668 
	}
}

1670 
	$pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

1671 
öode
 *
dú
,

1672 
pxt4_dú_íåy_2
 *
de_dñ
,

1673 
buf„r_hód
 *
bh
,

1674 *
has_ölöe_d©a
)

1676 
îr
, 
ölöe_size
, 
no_ex∑nd
;

1677 
pxt4_ûoc
 
ûoc
;

1678 *
ölöe_°¨t
;

1680 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1681 i‡(
îr
)

1682  
îr
;

1684 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1685 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1686 *
has_ölöe_d©a
 = 0;

1687 
out
;

1690 i‡((*)
de_dñ
 - ((*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
) <

1691 
PXT4_MIN_INLINE_DATA_SIZE
) {

1692 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1693 
PXT4_INLINE_DOTDOT_SIZE
;

1694 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 -

1695 
PXT4_INLINE_DOTDOT_SIZE
;

1697 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1698 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
) -

1699 
PXT4_MIN_INLINE_DATA_SIZE
;

1702 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1703 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1704 i‡(
îr
)

1705 
out
;

1707 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

1708 
ölöe_°¨t
, 
ölöe_size
, 0);

1709 i‡(
îr
)

1710 
out
;

1712 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1713 
out
:

1714 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1715 i‡(
	`likñy
(
îr
 == 0))

1716 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1717 
	`bªl£
(
ûoc
.
bh
);

1718 i‡(
îr
 !-
ENOENT
)

1719 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1720  
îr
;

1721 
	}
}

1726 
ölöe
 
pxt4_dú_íåy_2
 *

1727 
	$pxt4_gë_ölöe_íåy
(
öode
 *inode,

1728 
pxt4_ûoc
 *
ûoc
,

1729 
off£t
,

1730 **
ölöe_°¨t
,

1731 *
ölöe_size
)

1733 *
ölöe_pos
;

1735 
	`BUG_ON
(
off£t
 > 
	`pxt4_gë_ölöe_size
(
öode
));

1737 i‡(
off£t
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1738 
ölöe_pos
 = (*)
	`pxt4_øw_öode
(
ûoc
)->
i_block
;

1739 *
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1741 
ölöe_pos
 = 
	`pxt4_gë_ölöe_x©å_pos
(
öode
, 
ûoc
);

1742 
off£t
 -
PXT4_MIN_INLINE_DATA_SIZE
;

1743 *
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
) -

1744 
PXT4_MIN_INLINE_DATA_SIZE
;

1747 i‡(
ölöe_°¨t
)

1748 *
ölöe_°¨t
 = 
ölöe_pos
;

1749  (
pxt4_dú_íåy_2
 *)(
ölöe_pos
 + 
off£t
);

1750 
	}
}

1752 
boﬁ
 
	$em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
)

1754 
îr
, 
ölöe_size
;

1755 
pxt4_ûoc
 
ûoc
;

1756 
size_t
 
ölöe_Àn
;

1757 *
ölöe_pos
;

1758 
off£t
;

1759 
pxt4_dú_íåy_2
 *
de
;

1760 
boﬁ
 
ªt
 = 
åue
;

1762 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1763 i‡(
îr
) {

1764 
	`PXT4_ERROR_INODE
(
dú
, "error %d getting inode %lu block",

1765 
îr
, 
dú
->
i_öo
);

1766  
åue
;

1769 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1770 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1771 *
has_ölöe_d©a
 = 0;

1772 
out
;

1775 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1776 i‡(!
	`À32_to_˝u
(
de
->
öode
)) {

1777 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1779 
dú
->
i_öo
);

1780 
ªt
 = 
åue
;

1781 
out
;

1784 
ölöe_Àn
 = 
	`pxt4_gë_ölöe_size
(
dú
);

1785 
off£t
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1786 
off£t
 < 
ölöe_Àn
) {

1787 
de
 = 
	`pxt4_gë_ölöe_íåy
(
dú
, &
ûoc
, 
off£t
,

1788 &
ölöe_pos
, &
ölöe_size
);

1789 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
,

1790 
ûoc
.
bh
, 
ölöe_pos
,

1791 
ölöe_size
, 
off£t
)) {

1792 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1796 
dú
->
i_öo
, 
	`À32_to_˝u
(
de
->
öode
),

1797 
	`À16_to_˝u
(
de
->
ªc_Àn
), de->
«me_Àn
,

1798 
ölöe_size
);

1799 
ªt
 = 
åue
;

1800 
out
;

1802 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1803 
ªt
 = 
Ál£
;

1804 
out
;

1806 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1809 
out
:

1810 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1811 
	`bªl£
(
ûoc
.
bh
);

1812  
ªt
;

1813 
	}
}

1815 
	$pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1817 
ªt
, 
no_ex∑nd
;

1819 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1820 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1821 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1823  
ªt
;

1824 
	}
}

1826 
	$pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap)

1828 
__u64
 
addr
;

1829 
îr‹
 = -
EAGAIN
;

1830 
pxt4_ûoc
 
ûoc
;

1832 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1833 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

1834 
out
;

1836 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1837 i‡(
îr‹
)

1838 
out
;

1840 
addr
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1841 
addr
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1842 
addr
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1844 
	`bªl£
(
ûoc
.
bh
);

1846 
iom≠
->
addr
 =áddr;

1847 
iom≠
->
off£t
 = 0;

1848 
iom≠
->
Àngth
 = 
	`mö_t
(
loff_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1849 
	`i_size_ªad
(
öode
));

1850 
iom≠
->
ty≥
 = 
IOMAP_INLINE
;

1851 
iom≠
->
Êags
 = 0;

1853 
out
:

1854 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1855  
îr‹
;

1856 
	}
}

1858 
	$pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

1859 
fõm≠_exã¡_öfo
 *
fõöfo
,

1860 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
)

1862 
__u64
 
physiˇl
 = 0;

1863 
__u64
 
ölöe_Àn
;

1864 
__u32
 
Êags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

1865 
FIEMAP_EXTENT_LAST
;

1866 
îr‹
 = 0;

1867 
pxt4_ûoc
 
ûoc
;

1869 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1870 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1871 *
has_ölöe
 = 0;

1872 
out
;

1874 
ölöe_Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1875 
	`i_size_ªad
(
öode
));

1876 i‡(
°¨t
 >
ölöe_Àn
)

1877 
out
;

1878 i‡(
°¨t
 + 
Àn
 < 
ölöe_Àn
)

1879 
ölöe_Àn
 = 
°¨t
 + 
Àn
;

1880 
ölöe_Àn
 -
°¨t
;

1882 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1883 i‡(
îr‹
)

1884 
out
;

1886 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1887 
physiˇl
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1888 
physiˇl
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1890 
	`bªl£
(
ûoc
.
bh
);

1891 
out
:

1892 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1893 i‡(
physiˇl
)

1894 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 
°¨t
, 
physiˇl
,

1895 
ölöe_Àn
, 
Êags
);

1896  (
îr‹
 < 0 ?Érror : 0);

1897 
	}
}

1899 
	$pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
)

1901 
h™dÀ_t
 *
h™dÀ
;

1902 
ölöe_size
, 
vÆue_Àn
, 
√eded_blocks
, 
no_ex∑nd
, 
îr
 = 0;

1903 
size_t
 
i_size
;

1904 *
vÆue
 = 
NULL
;

1905 
pxt4_x©å_ibody_föd
 
is
 = {

1906 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

1908 
pxt4_x©å_öfo
 
i
 = {

1909 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

1910 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

1914 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

1915 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
√eded_blocks
);

1916 i‡(
	`IS_ERR
(
h™dÀ
))

1917  
	`PTR_ERR
(
h™dÀ
);

1919 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1920 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1921 *
has_ölöe
 = 0;

1922 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1926 i‡((
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
)) != 0)

1927 
out
;

1929 i‡((
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
)) != 0)

1930 
out
;

1932 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1933 
i_size
 = 
öode
->i_size;

1934 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1935 
	`PXT4_I
(
öode
)->
i_disksize
 = 
i_size
;

1937 i‡(
i_size
 < 
ölöe_size
) {

1939 i‡(
ölöe_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

1940 i‡((
îr
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
)) != 0)

1941 
out_îr‹
;

1943 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

1945 
vÆue_Àn
 = 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

1946 
vÆue
 = 
	`kmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1947 i‡(!
vÆue
) {

1948 
îr
 = -
ENOMEM
;

1949 
out_îr‹
;

1952 
îr
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
,

1953 
i
.
«me
, 
vÆue
, 
vÆue_Àn
);

1954 i‡(
îr
 <= 0)

1955 
out_îr‹
;

1957 
i
.
vÆue
 = value;

1958 
i
.
vÆue_Àn
 = 
i_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1959 
i_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
 : 0;

1960 
îr
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
,

1961 &
i
, &
is
);

1962 i‡(
îr
)

1963 
out_îr‹
;

1967 i‡(
i_size
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1968 *
p
 = (*Ë
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
;

1969 
	`mem£t
(
p
 + 
i_size
, 0,

1970 
PXT4_MIN_INLINE_DATA_SIZE
 - 
i_size
);

1973 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
i_size
 <

1974 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1975 
PXT4_MIN_INLINE_DATA_SIZE
 : 
i_size
;

1978 
out_îr‹
:

1979 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1980 
out
:

1981 
	`bªl£
(
is
.
ûoc
.
bh
);

1982 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1983 
	`k‰ì
(
vÆue
);

1984 i‡(
öode
->
i_∆ök
)

1985 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

1987 i‡(
îr
 == 0) {

1988 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1989 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1990 i‡(
	`IS_SYNC
(
öode
))

1991 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1993 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1994  
îr
;

1995 
	}
}

1997 
	$pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode)

1999 
îr‹
, 
√eded_blocks
, 
no_ex∑nd
;

2000 
h™dÀ_t
 *
h™dÀ
;

2001 
pxt4_ûoc
 
ûoc
;

2003 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

2004 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

2008 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

2010 
ûoc
.
bh
 = 
NULL
;

2011 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2012 i‡(
îr‹
)

2013  
îr‹
;

2015 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

2016 i‡(
	`IS_ERR
(
h™dÀ
)) {

2017 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2018 
out_‰ì
;

2021 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2022 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2023 
îr‹
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
, &
ûoc
);

2024 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2025 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2026 
out_‰ì
:

2027 
	`bªl£
(
ûoc
.
bh
);

2028  
îr‹
;

2029 
	}
}

	@inode.c

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/highuid.h
>

25 
	~<löux/∑gem≠.h
>

26 
	~<löux/dax.h
>

27 
	~<löux/quŸa›s.h
>

28 
	~<löux/°rög.h
>

29 
	~<löux/buf„r_hód.h
>

30 
	~<löux/wrôeback.h
>

31 
	~<löux/∑gevec.h
>

32 
	~<löux/m∑ge.h
>

33 
	~<löux/«mei.h
>

34 
	~<löux/uio.h
>

35 
	~<löux/bio.h
>

36 
	~<löux/w‹kqueue.h
>

37 
	~<löux/kî√l.h
>

38 
	~<löux/¥ötk.h
>

39 
	~<löux/¶ab.h
>

40 
	~<löux/bô›s.h
>

41 
	~<löux/iom≠.h
>

42 
	~<löux/ivîsi⁄.h
>

44 
	~"pxt4_jbd3.h
"

45 
	~"x©å.h
"

46 
	~"a˛.h
"

47 
	~"åunˇã.h
"

49 
	~<åa˚/evíts/pxt4.h
>

51 
	#MPAGE_DA_EXTENT_TAIL
 0x01

	)

53 
__u32
 
	$pxt4_öode_csum
(
öode
 *öode, 
pxt4_öode
 *
øw
,

54 
pxt4_öode_öfo
 *
ei
)

56 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

57 
__u32
 
csum
;

58 
__u16
 
dummy_csum
 = 0;

59 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_lo
);

60 
csum_size
 = (
dummy_csum
);

62 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
øw
, 
off£t
);

63 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, 
csum_size
);

64 
off£t
 +
csum_size
;

65 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

66 
PXT4_GOOD_OLD_INODE_SIZE
 - 
off£t
);

68 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

69 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_hi
);

70 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 +

71 
PXT4_GOOD_OLD_INODE_SIZE
,

72 
off£t
 - 
PXT4_GOOD_OLD_INODE_SIZE
);

73 i‡(
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
)) {

74 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
,

75 
csum_size
);

76 
off£t
 +
csum_size
;

78 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

79 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

82  
csum
;

83 
	}
}

85 
	$pxt4_öode_csum_vîify
(
öode
 *öode, 
pxt4_öode
 *
øw
,

86 
pxt4_öode_öfo
 *
ei
)

88 
__u32
 
¥ovided
, 
ˇlcuœãd
;

90 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

91 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

92 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

95 
¥ovided
 = 
	`À16_to_˝u
(
øw
->
i_checksum_lo
);

96 
ˇlcuœãd
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

97 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

98 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

99 
¥ovided
 |((
__u32
)
	`À16_to_˝u
(
øw
->
i_checksum_hi
)) << 16;

101 
ˇlcuœãd
 &= 0xFFFF;

103  
¥ovided
 =
ˇlcuœãd
;

104 
	}
}

106 
	$pxt4_öode_csum_£t
(
öode
 *öode, 
pxt4_öode
 *
øw
,

107 
pxt4_öode_öfo
 *
ei
)

109 
__u32
 
csum
;

111 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

112 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

113 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

116 
csum
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

117 
øw
->
i_checksum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

118 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

119 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

120 
øw
->
i_checksum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

121 
	}
}

123 
ölöe
 
	$pxt4_begö_‹dîed_åunˇã
(
öode
 *inode,

124 
loff_t
 
√w_size
)

126 
	`åa˚_pxt4_begö_‹dîed_åunˇã
(
öode
, 
√w_size
);

133 i‡(!
	`PXT4_I
(
öode
)->
jöode
)

135  
	`jbd3_jou∫Æ_begö_‹dîed_åunˇã
(
	`PXT4_JOURNAL
(
öode
),

136 
	`PXT4_I
(
öode
)->
jöode
,

137 
√w_size
);

138 
	}
}

140 
pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

141 
Àngth
);

142 
__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *∑ge, 
Àn
);

143 
pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

144 
pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

145 
≥xã¡s
);

151 
	$pxt4_öode_is_Á°_symlök
(
öode
 *inode)

153 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

154 
ó_blocks
 = 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 ?

155 
	`PXT4_CLUSTER_SIZE
(
öode
->
i_sb
) >> 9 : 0;

157 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

160  (
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 - 
ó_blocks
 == 0);

162  
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_size
 &&

163 (
öode
->
i_size
 < 
PXT4_N_BLOCKS
 * 4);

164 
	}
}

171 
	$pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

172 
nblocks
)

174 
ªt
;

182 
	`BUG_ON
(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
);

183 
	`jbd_debug
(2, "ª°¨tög h™dÀ %p\n", 
h™dÀ
);

184 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

185 
ªt
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

186 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

187 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

189  
ªt
;

190 
	}
}

195 
	$pxt4_evi˘_öode
(
öode
 *inode)

197 
h™dÀ_t
 *
h™dÀ
;

198 
îr
;

204 
exåa_¸edôs
 = 6;

205 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

207 
	`åa˚_pxt4_evi˘_öode
(
öode
);

209 i‡(
öode
->
i_∆ök
) {

228 i‡(
öode
->
i_öo
 !
PXT4_JOURNAL_INO
 &&

229 
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

230 (
	`S_ISLNK
(
öode
->
i_mode
Ë|| 
	`S_ISREG
(inode->i_mode)) &&

231 
öode
->
i_d©a
.
ƒ∑ges
) {

232 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

233 
tid_t
 
commô_tid
 = 
	`PXT4_I
(
öode
)->
i_d©async_tid
;

235 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

236 
	`fûem≠_wrôe_™d_waô
(&
öode
->
i_d©a
);

238 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

240 
no_dñëe
;

243 i‡(
	`is_bad_öode
(
öode
))

244 
no_dñëe
;

245 
	`dquŸ_öôülize
(
öode
);

247 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

248 
	`pxt4_begö_‹dîed_åunˇã
(
öode
, 0);

249 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

255 
	`sb_°¨t_ötwrôe
(
öode
->
i_sb
);

257 i‡(!
	`IS_NOQUOTA
(
öode
))

258 
exåa_¸edôs
 +
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
);

264 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
,

265 
	`pxt4_blocks_f‹_åunˇã
(
öode
Ë+ 
exåa_¸edôs
 - 3);

266 i‡(
	`IS_ERR
(
h™dÀ
)) {

267 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
	`PTR_ERR
(
h™dÀ
));

273 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

274 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

275 
no_dñëe
;

278 i‡(
	`IS_SYNC
(
öode
))

279 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

288 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
))

289 
	`mem£t
(
	`PXT4_I
(
öode
)->
i_d©a
, 0, (PXT4_I(inode)->i_data));

290 
öode
->
i_size
 = 0;

291 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

292 i‡(
îr
) {

293 
	`pxt4_w¨nög
(
öode
->
i_sb
,

294 "couldn'àm¨k inodêdúty (î∏%d)", 
îr
);

295 
°›_h™dÀ
;

297 i‡(
öode
->
i_blocks
) {

298 
îr
 = 
	`pxt4_åunˇã
(
öode
);

299 i‡(
îr
) {

300 
	`pxt4_îr‹
(
öode
->
i_sb
,

302 
öode
->
i_öo
, 
îr
);

303 
°›_h™dÀ
;

308 
îr
 = 
	`pxt4_x©å_dñëe_öode
(
h™dÀ
, 
öode
, &
ó_öode_¨øy
,

309 
exåa_¸edôs
);

310 i‡(
îr
) {

311 
	`pxt4_w¨nög
(
öode
->
i_sb
, "x©å dñëê”º %d)", 
îr
);

312 
°›_h™dÀ
:

313 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

314 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

315 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

316 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

317 
no_dñëe
;

328 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

329 
	`PXT4_I
(
öode
)->
i_dtime
 = (
__u32
)
	`ktime_gë_ªÆ_£c⁄ds
();

338 i‡(
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
))

340 
	`pxt4_˛ór_öode
(
öode
);

342 
	`pxt4_‰ì_öode
(
h™dÀ
, 
öode
);

343 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

344 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

345 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

347 
no_dñëe
:

348 
	`pxt4_˛ór_öode
(
öode
);

349 
	}
}

351 #ifde‡
CONFIG_QUOTA


352 
qsize_t
 *
	$pxt4_gë_ª£rved_•a˚
(
öode
 *inode)

354  &
	`PXT4_I
(
öode
)->
i_ª£rved_quŸa
;

355 
	}
}

362 
	$pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

363 
u£d
, 
quŸa_˛aim
)

365 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

366 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

368 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

369 
	`åa˚_pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
u£d
, 
quŸa_˛aim
);

370 i‡(
	`u∆ikñy
(
u£d
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

371 
	`pxt4_w¨nög
(
öode
->
i_sb
, "%s: ino %lu, used %d "

373 
__func__
, 
öode
->
i_öo
, 
u£d
,

374 
ei
->
i_ª£rved_d©a_blocks
);

375 
	`WARN_ON
(1);

376 
u£d
 = 
ei
->
i_ª£rved_d©a_blocks
;

380 
ei
->
i_ª£rved_d©a_blocks
 -
u£d
;

381 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
u£d
);

383 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

386 i‡(
quŸa_˛aim
)

387 
	`dquŸ_˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

394 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

402 i‡((
ei
->
i_ª£rved_d©a_blocks
 == 0) &&

403 !
	`öode_is_›í_f‹_wrôe
(
öode
))

404 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

405 
	}
}

407 
	$__check_block_vÆidôy
(
öode
 *öode, c⁄° *
func
,

408 
löe
,

409 
pxt4_m≠_blocks
 *
m≠
)

411 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

412 (
öode
->
i_öo
 ==

413 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

415 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
m≠
->
m_pblk
,

416 
m≠
->
m_Àn
)) {

417 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
m≠
->
m_pblk
,

419 "÷ígth %d)", (Ë
m≠
->
m_lblk
,

420 
m≠
->
m_pblk
, m≠->
m_Àn
);

421  -
EFSCORRUPTED
;

424 
	}
}

426 
	$pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
pxt4_fsblk_t
 
pblk
,

427 
pxt4_lblk_t
 
Àn
)

429 
ªt
;

431 i‡(
	`IS_ENCRYPTED
(
öode
))

432  
	`fs¸y±_zîoout_ønge
(
öode
, 
lblk
, 
pblk
, 
Àn
);

434 
ªt
 = 
	`sb_issue_zîoout
(
öode
->
i_sb
, 
pblk
, 
Àn
, 
GFP_NOFS
);

435 i‡(
ªt
 > 0)

436 
ªt
 = 0;

438  
ªt
;

439 
	}
}

441 
	#check_block_vÆidôy
(
öode
, 
m≠
) \

442 
	`__check_block_vÆidôy
((
öode
), 
__func__
, 
__LINE__
, (
m≠
))

	)

444 #ifde‡
ES_AGGRESSIVE_TEST


445 
	$pxt4_m≠_blocks_es_ªcheck
(
h™dÀ_t
 *
h™dÀ
,

446 
öode
 *inode,

447 
pxt4_m≠_blocks
 *
es_m≠
,

448 
pxt4_m≠_blocks
 *
m≠
,

449 
Êags
)

451 
ªtvÆ
;

453 
m≠
->
m_Êags
 = 0;

461 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

462 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

463 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

464 
PXT4_GET_BLOCKS_KEEP_SIZE
);

466 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

467 
PXT4_GET_BLOCKS_KEEP_SIZE
);

469 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

475 i‡(
es_m≠
->
m_lblk
 !
m≠
->m_lblk ||

476 
es_m≠
->
m_Êags
 !
m≠
->m_flags ||

477 
es_m≠
->
m_pblk
 !
m≠
->m_pblk) {

478 
	`¥ötk
("ES cacheássertion failed for inode: %lu "

481 
öode
->
i_öo
, 
es_m≠
->
m_lblk
,És_m≠->
m_Àn
,

482 
es_m≠
->
m_pblk
,És_m≠->
m_Êags
, 
m≠
->
m_lblk
,

483 
m≠
->
m_Àn
, m≠->
m_pblk
, m≠->
m_Êags
,

484 
ªtvÆ
, 
Êags
);

486 
	}
}

511 
	$pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

512 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

514 
exã¡_°©us
 
es
;

515 
ªtvÆ
;

516 
ªt
 = 0;

517 #ifde‡
ES_AGGRESSIVE_TEST


518 
pxt4_m≠_blocks
 
‹ig_m≠
;

520 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

523 
m≠
->
m_Êags
 = 0;

524 
	`ext_debug
("pxt4_map_blocks(): inode %lu, flag %d, max_blocks %u,"

525 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
Êags
, 
m≠
->
m_Àn
,

526 (Ë
m≠
->
m_lblk
);

531 i‡(
	`u∆ikñy
(
m≠
->
m_Àn
 > 
INT_MAX
))

532 
m≠
->
m_Àn
 = 
INT_MAX
;

535 i‡(
	`u∆ikñy
(
m≠
->
m_lblk
 >
EXT_MAX_BLOCKS
))

536  -
EFSCORRUPTED
;

539 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

540 i‡(
	`pxt4_es_is_wrôãn
(&
es
Ë|| 
	`pxt4_es_is_unwrôãn
(&es)) {

541 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
) +

542 
m≠
->
m_lblk
 - 
es
.
es_lblk
;

543 
m≠
->
m_Êags
 |
	`pxt4_es_is_wrôãn
(&
es
) ?

544 
PXT4_MAP_MAPPED
 : 
PXT4_MAP_UNWRITTEN
;

545 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

546 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

547 
ªtvÆ
 = 
m≠
->
m_Àn
;

548 
m≠
->
m_Àn
 = 
ªtvÆ
;

549 } i‡(
	`pxt4_es_is_dñayed
(&
es
Ë|| 
	`pxt4_es_is_hﬁe
(&es)) {

550 
m≠
->
m_pblk
 = 0;

551 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

552 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

553 
ªtvÆ
 = 
m≠
->
m_Àn
;

554 
m≠
->
m_Àn
 = 
ªtvÆ
;

555 
ªtvÆ
 = 0;

557 
	`BUG
();

559 #ifde‡
ES_AGGRESSIVE_TEST


560 
	`pxt4_m≠_blocks_es_ªcheck
(
h™dÀ
, 
öode
, 
m≠
,

561 &
‹ig_m≠
, 
Êags
);

563 
found
;

570 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

571 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

572 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

573 
PXT4_GET_BLOCKS_KEEP_SIZE
);

575 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

576 
PXT4_GET_BLOCKS_KEEP_SIZE
);

578 i‡(
ªtvÆ
 > 0) {

579 
°©us
;

581 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

582 
	`pxt4_w¨nög
(
öode
->
i_sb
,

585 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

586 
	`WARN_ON
(1);

589 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

590 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

591 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

592 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

593 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

594 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

595 
°©us
 |
EXTENT_STATUS_DELAYED
;

596 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
,

597 
m≠
->
m_Àn
, m≠->
m_pblk
, 
°©us
);

598 i‡(
ªt
 < 0)

599 
ªtvÆ
 = 
ªt
;

601 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

603 
found
:

604 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

605 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

606 i‡(
ªt
 != 0)

607  
ªt
;

611 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0)

612  
ªtvÆ
;

621 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
)

627 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
))

628  
ªtvÆ
;

634 
m≠
->
m_Êags
 &~
PXT4_MAP_FLAGS
;

642 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

648 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

649 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

651 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

653 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

659 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

668 i‡((
ªtvÆ
 > 0) &&

669 (
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
))

670 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
ªtvÆ
, 1);

673 i‡(
ªtvÆ
 > 0) {

674 
°©us
;

676 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

677 
	`pxt4_w¨nög
(
öode
->
i_sb
,

680 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

681 
	`WARN_ON
(1);

691 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
 &&

692 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
 &&

693 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

694 
ªt
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
,

695 
m≠
->
m_pblk
, m≠->
m_Àn
);

696 i‡(
ªt
) {

697 
ªtvÆ
 = 
ªt
;

698 
out_£m
;

706 i‡((
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) &&

707 
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

708 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

709 
out_£m
;

711 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

712 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

713 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

714 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

715 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

716 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

717 
°©us
 |
EXTENT_STATUS_DELAYED
;

718 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

719 
m≠
->
m_pblk
, 
°©us
);

720 i‡(
ªt
 < 0) {

721 
ªtvÆ
 = 
ªt
;

722 
out_£m
;

726 
out_£m
:

727 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

728 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

729 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

730 i‡(
ªt
 != 0)

731  
ªt
;

738 i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
 &&

739 !(
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) &&

740 !(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) &&

741 !
	`pxt4_is_quŸa_fûe
(
öode
) &&

742 
	`pxt4_should_‹dî_d©a
(
öode
)) {

743 
loff_t
 
°¨t_byã
 =

744 (
loff_t
)
m≠
->
m_lblk
 << 
öode
->
i_blkbôs
;

745 
loff_t
 
Àngth
 = (loff_t)
m≠
->
m_Àn
 << 
öode
->
i_blkbôs
;

747 i‡(
Êags
 & 
PXT4_GET_BLOCKS_IO_SUBMIT
)

748 
ªt
 = 
	`pxt4_jbd3_öode_add_waô
(
h™dÀ
, 
öode
,

749 
°¨t_byã
, 
Àngth
);

751 
ªt
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
,

752 
°¨t_byã
, 
Àngth
);

753 i‡(
ªt
)

754  
ªt
;

757  
ªtvÆ
;

758 
	}
}

764 
	$pxt4_upd©e_bh_°©e
(
buf„r_hód
 *
bh
, 
Êags
)

766 
ﬁd_°©e
;

767 
√w_°©e
;

769 
Êags
 &
PXT4_MAP_FLAGS
;

772 i‡(!
bh
->
b_∑ge
) {

773 
bh
->
b_°©e
 = (bh->b_°©ê& ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

782 
ﬁd_°©e
 = 
	`READ_ONCE
(
bh
->
b_°©e
);

783 
√w_°©e
 = (
ﬁd_°©e
 & ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

784 } 
	`u∆ikñy
(

785 
	`cmpxchg
(&
bh
->
b_°©e
, 
ﬁd_°©e
, 
√w_°©e
) != old_state));

786 
	}
}

788 
	$_pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

789 
buf„r_hód
 *
bh
, 
Êags
)

791 
pxt4_m≠_blocks
 
m≠
;

792 
ªt
 = 0;

794 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

795  -
ERANGE
;

797 
m≠
.
m_lblk
 = 
iblock
;

798 
m≠
.
m_Àn
 = 
bh
->
b_size
 >> 
öode
->
i_blkbôs
;

800 
ªt
 = 
	`pxt4_m≠_blocks
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(), 
öode
, &
m≠
,

801 
Êags
);

802 i‡(
ªt
 > 0) {

803 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

804 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

805 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

806 
ªt
 = 0;

807 } i‡(
ªt
 == 0) {

809 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

811  
ªt
;

812 
	}
}

814 
	$pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

815 
buf„r_hód
 *
bh
, 
¸óã
)

817  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
,

818 
¸óã
 ? 
PXT4_GET_BLOCKS_CREATE
 : 0);

819 
	}
}

826 
	$pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

827 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

829 
	`pxt4_debug
("pxt4_get_block_unwritten: inode %lu, create flag %d\n",

830 
öode
->
i_öo
, 
¸óã
);

831  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
,

832 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

833 
	}
}

836 
	#DIO_MAX_BLOCKS
 4096

	)

843 
	$pxt4_gë_block_å™s
(
öode
 *öode, 
£˘‹_t
 
iblock
,

844 
buf„r_hód
 *
bh_ªsu…
, 
Êags
)

846 
dio_¸edôs
;

847 
h™dÀ_t
 *
h™dÀ
;

848 
ªåõs
 = 0;

849 
ªt
;

852 i‡(
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
 > 
DIO_MAX_BLOCKS
)

853 
bh_ªsu…
->
b_size
 = 
DIO_MAX_BLOCKS
 << 
öode
->
i_blkbôs
;

854 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
,

855 
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
);

856 
ªåy
:

857 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
, 
dio_¸edôs
);

858 i‡(
	`IS_ERR
(
h™dÀ
))

859  
	`PTR_ERR
(
h™dÀ
);

861 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 
Êags
);

862 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

864 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

865 
ªåy
;

866  
ªt
;

867 
	}
}

870 
	$pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

871 
buf„r_hód
 *
bh
, 
¸óã
)

874 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

876 i‡(!
¸óã
)

877  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

878  
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh
, 
PXT4_GET_BLOCKS_CREATE
);

879 
	}
}

886 
	$pxt4_dio_gë_block_unwrôãn_async
(
öode
 *inode,

887 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

889 
ªt
;

892 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

894 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

895 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

904 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
)) {

905 i‡(!
bh_ªsu…
->
b_¥iv©e
) {

906 
pxt4_io_íd_t
 *
io_íd
;

908 
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

909 i‡(!
io_íd
)

910  -
ENOMEM
;

911 
bh_ªsu…
->
b_¥iv©e
 = 
io_íd
;

912 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
io_íd
);

914 
	`£t_buf„r_de„r_com∂ëi⁄
(
bh_ªsu…
);

917  
ªt
;

918 
	}
}

925 
	$pxt4_dio_gë_block_unwrôãn_sync
(
öode
 *inode,

926 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

928 
ªt
;

931 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

933 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

934 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

941 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
))

942 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

944  
ªt
;

945 
	}
}

947 
	$pxt4_dio_gë_block_ovîwrôe
(
öode
 *öode, 
£˘‹_t
 
iblock
,

948 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

950 
ªt
;

952 
	`pxt4_debug
("pxt4_dio_get_block_overwrite: inode %lu, create flag %d\n",

953 
öode
->
i_öo
, 
¸óã
);

955 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

957 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 0);

962 
	`WARN_ON_ONCE
(!
	`buf„r_m≠≥d
(
bh_ªsu…
Ë|| 
	`buf„r_unwrôãn
(bh_result));

964  
ªt
;

965 
	}
}

971 
buf„r_hód
 *
	$pxt4_gëblk
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

972 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

974 
pxt4_m≠_blocks
 
m≠
;

975 
buf„r_hód
 *
bh
;

976 
¸óã
 = 
m≠_Êags
 & 
PXT4_GET_BLOCKS_CREATE
;

977 
îr
;

979 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || 
¸óã
 == 0);

981 
m≠
.
m_lblk
 = 
block
;

982 
m≠
.
m_Àn
 = 1;

983 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
m≠_Êags
);

985 i‡(
îr
 == 0)

986  
¸óã
 ? 
	`ERR_PTR
(-
ENOSPC
Ë: 
NULL
;

987 i‡(
îr
 < 0)

988  
	`ERR_PTR
(
îr
);

990 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

991 i‡(
	`u∆ikñy
(!
bh
))

992  
	`ERR_PTR
(-
ENOMEM
);

993 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
) {

994 
	`J_ASSERT
(
¸óã
 != 0);

995 
	`J_ASSERT
(
h™dÀ
 !
NULL
);

1004 
	`lock_buf„r
(
bh
);

1005 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

1006 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1007 i‡(
	`u∆ikñy
(
îr
)) {

1008 
	`u∆ock_buf„r
(
bh
);

1009 
îrout
;

1011 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1012 
	`mem£t
(
bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1013 
	`£t_buf„r_u±od©e
(
bh
);

1015 
	`u∆ock_buf„r
(
bh
);

1016 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

1017 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1018 i‡(
	`u∆ikñy
(
îr
))

1019 
îrout
;

1021 
	`BUFFER_TRACE
(
bh
, "notáÇew buffer");

1022  
bh
;

1023 
îrout
:

1024 
	`bªl£
(
bh
);

1025  
	`ERR_PTR
(
îr
);

1026 
	}
}

1028 
buf„r_hód
 *
	$pxt4_bªad
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1029 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

1031 
buf„r_hód
 *
bh
;

1033 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
öode
, 
block
, 
m≠_Êags
);

1034 i‡(
	`IS_ERR
(
bh
))

1035  
bh
;

1036 i‡(!
bh
 || 
	`pxt4_buf„r_u±od©e
(bh))

1037  
bh
;

1038 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
bh
);

1039 
	`waô_⁄_buf„r
(
bh
);

1040 i‡(
	`buf„r_u±od©e
(
bh
))

1041  
bh
;

1042 
	`put_bh
(
bh
);

1043  
	`ERR_PTR
(-
EIO
);

1044 
	}
}

1047 
	$pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

1048 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
)

1050 
i
, 
îr
;

1052 
i
 = 0; i < 
bh_cou¡
; i++) {

1053 
bhs
[
i
] = 
	`pxt4_gëblk
(
NULL
, 
öode
, 
block
 + i, 0 );

1054 i‡(
	`IS_ERR
(
bhs
[
i
])) {

1055 
îr
 = 
	`PTR_ERR
(
bhs
[
i
]);

1056 
bh_cou¡
 = 
i
;

1057 
out_bªl£
;

1061 
i
 = 0; i < 
bh_cou¡
; i++)

1063 i‡(
bhs
[
i
] && !
	`pxt4_buf„r_u±od©e
(bhs[i]))

1064 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1,

1065 &
bhs
[
i
]);

1067 i‡(!
waô
)

1070 
i
 = 0; i < 
bh_cou¡
; i++)

1071 i‡(
bhs
[
i
])

1072 
	`waô_⁄_buf„r
(
bhs
[
i
]);

1074 
i
 = 0; i < 
bh_cou¡
; i++) {

1075 i‡(
bhs
[
i
] && !
	`buf„r_u±od©e
(bhs[i])) {

1076 
îr
 = -
EIO
;

1077 
out_bªl£
;

1082 
out_bªl£
:

1083 
i
 = 0; i < 
bh_cou¡
; i++) {

1084 
	`bªl£
(
bhs
[
i
]);

1085 
bhs
[
i
] = 
NULL
;

1087  
îr
;

1088 
	}
}

1090 
	$pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1091 
buf„r_hód
 *
hód
,

1092 
‰om
,

1093 
to
,

1094 *
∑πül
,

1095 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

1096 
buf„r_hód
 *
bh
))

1098 
buf„r_hód
 *
bh
;

1099 
block_°¨t
, 
block_íd
;

1100 
blocksize
 = 
hód
->
b_size
;

1101 
îr
, 
ªt
 = 0;

1102 
buf„r_hód
 *
√xt
;

1104 
bh
 = 
hód
, 
block_°¨t
 = 0;

1105 
ªt
 =0 && (
bh
 !
hód
 || !
block_°¨t
);

1106 
block_°¨t
 = 
block_íd
, 
bh
 = 
√xt
) {

1107 
√xt
 = 
bh
->
b_this_∑ge
;

1108 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1109 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1110 i‡(
∑πül
 && !
	`buf„r_u±od©e
(
bh
))

1111 *
∑πül
 = 1;

1114 
îr
 = (*
‚
)(
h™dÀ
, 
bh
);

1115 i‡(!
ªt
)

1116 
ªt
 = 
îr
;

1118  
ªt
;

1119 
	}
}

1145 
	$do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

1146 
buf„r_hód
 *
bh
)

1148 
dúty
 = 
	`buf„r_dúty
(
bh
);

1149 
ªt
;

1151 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1161 i‡(
dúty
)

1162 
	`˛ór_buf„r_dúty
(
bh
);

1163 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

1164 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1165 i‡(!
ªt
 && 
dúty
)

1166 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1167  
ªt
;

1168 
	}
}

1170 #ifde‡
CONFIG_FS_ENCRYPTION


1171 
	$pxt4_block_wrôe_begö
(
∑ge
 *∑ge, 
loff_t
 
pos
, 
Àn
,

1172 
gë_block_t
 *
gë_block
)

1174 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1175 
to
 = 
‰om
 + 
Àn
;

1176 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1177 
block_°¨t
, 
block_íd
;

1178 
£˘‹_t
 
block
;

1179 
îr
 = 0;

1180 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1181 
bbôs
;

1182 
buf„r_hód
 *
bh
, *
hód
, *
waô
[2];

1183 
ƒ_waô
 = 0;

1184 
i
;

1186 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1187 
	`BUG_ON
(
‰om
 > 
PAGE_SIZE
);

1188 
	`BUG_ON
(
to
 > 
PAGE_SIZE
);

1189 
	`BUG_ON
(
‰om
 > 
to
);

1191 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1192 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

1193 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1194 
bbôs
 = 
	`ûog2
(
blocksize
);

1195 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
bbôs
);

1197 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

1198 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

1199 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1200 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1201 i‡(
	`PageU±od©e
(
∑ge
)) {

1202 i‡(!
	`buf„r_u±od©e
(
bh
))

1203 
	`£t_buf„r_u±od©e
(
bh
);

1207 i‡(
	`buf„r_√w
(
bh
))

1208 
	`˛ór_buf„r_√w
(
bh
);

1209 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

1210 
	`WARN_ON
(
bh
->
b_size
 !
blocksize
);

1211 
îr
 = 
	`gë_block
(
öode
, 
block
, 
bh
, 1);

1212 i‡(
îr
)

1214 i‡(
	`buf„r_√w
(
bh
)) {

1215 i‡(
	`PageU±od©e
(
∑ge
)) {

1216 
	`˛ór_buf„r_√w
(
bh
);

1217 
	`£t_buf„r_u±od©e
(
bh
);

1218 
	`m¨k_buf„r_dúty
(
bh
);

1221 i‡(
block_íd
 > 
to
 || 
block_°¨t
 < 
‰om
)

1222 
	`zîo_u£r_£gmíts
(
∑ge
, 
to
, 
block_íd
,

1223 
block_°¨t
, 
‰om
);

1227 i‡(
	`PageU±od©e
(
∑ge
)) {

1228 i‡(!
	`buf„r_u±od©e
(
bh
))

1229 
	`£t_buf„r_u±od©e
(
bh
);

1232 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& !
	`buf„r_dñay
(bh) &&

1233 !
	`buf„r_unwrôãn
(
bh
) &&

1234 (
block_°¨t
 < 
‰om
 || 
block_íd
 > 
to
)) {

1235 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1236 
waô
[
ƒ_waô
++] = 
bh
;

1242 
i
 = 0; i < 
ƒ_waô
; i++) {

1243 
	`waô_⁄_buf„r
(
waô
[
i
]);

1244 i‡(!
	`buf„r_u±od©e
(
waô
[
i
]))

1245 
îr
 = -
EIO
;

1247 i‡(
	`u∆ikñy
(
îr
)) {

1248 
	`∑ge_zîo_√w_buf„rs
(
∑ge
, 
‰om
, 
to
);

1249 } i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
)) {

1250 
i
 = 0; i < 
ƒ_waô
; i++) {

1251 
îr2
;

1253 
îr2
 = 
	`fs¸y±_de¸y±_∑geˇche_blocks
(
∑ge
, 
blocksize
,

1254 
	`bh_off£t
(
waô
[
i
]));

1255 i‡(
îr2
) {

1256 
	`˛ór_buf„r_u±od©e
(
waô
[
i
]);

1257 
îr
 = 
îr2
;

1262  
îr
;

1263 
	}
}

1266 
	$pxt4_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

1267 
loff_t
 
pos
, 
Àn
, 
Êags
,

1268 
∑ge
 **
∑gï
, **
fsd©a
)

1270 
öode
 *öodê
m≠pög
->
ho°
;

1271 
ªt
, 
√eded_blocks
;

1272 
h™dÀ_t
 *
h™dÀ
;

1273 
ªåõs
 = 0;

1274 
∑ge
 *page;

1275 
pgoff_t
 
ödex
;

1276 
‰om
, 
to
;

1278 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

1279  -
EIO
;

1281 
	`åa˚_pxt4_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

1286 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

1287 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

1288 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1289 
to
 = 
‰om
 + 
Àn
;

1291 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

1292 
ªt
 = 
	`pxt4_åy_to_wrôe_ölöe_d©a
(
m≠pög
, 
öode
, 
pos
, 
Àn
,

1293 
Êags
, 
∑gï
);

1294 i‡(
ªt
 < 0)

1295  
ªt
;

1296 i‡(
ªt
 == 1)

1307 
ªåy_gøb
:

1308 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

1309 i‡(!
∑ge
)

1310  -
ENOMEM
;

1311 
	`u∆ock_∑ge
(
∑ge
);

1313 
ªåy_jou∫Æ
:

1314 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

1315 i‡(
	`IS_ERR
(
h™dÀ
)) {

1316 
	`put_∑ge
(
∑ge
);

1317  
	`PTR_ERR
(
h™dÀ
);

1320 
	`lock_∑ge
(
∑ge
);

1321 i‡(
∑ge
->
m≠pög
 != mapping) {

1323 
	`u∆ock_∑ge
(
∑ge
);

1324 
	`put_∑ge
(
∑ge
);

1325 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1326 
ªåy_gøb
;

1329 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

1331 #ifde‡
CONFIG_FS_ENCRYPTION


1332 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1333 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1334 
pxt4_gë_block_unwrôãn
);

1336 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1337 
pxt4_gë_block
);

1339 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1340 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1341 
pxt4_gë_block_unwrôãn
);

1343 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_gë_block
);

1345 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

1346 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

1347 
‰om
, 
to
, 
NULL
,

1348 
do_jou∫Æ_gë_wrôe_ac˚ss
);

1351 i‡(
ªt
) {

1352 
boﬁ
 
exãnded
 = (
pos
 + 
Àn
 > 
öode
->
i_size
) &&

1353 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1355 
	`u∆ock_∑ge
(
∑ge
);

1364 i‡(
exãnded
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

1365 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1367 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1368 i‡(
exãnded
) {

1369 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1376 i‡(
öode
->
i_∆ök
)

1377 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1380 i‡(
ªt
 =-
ENOSPC
 &&

1381 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1382 
ªåy_jou∫Æ
;

1383 
	`put_∑ge
(
∑ge
);

1384  
ªt
;

1386 *
∑gï
 = 
∑ge
;

1387  
ªt
;

1388 
	}
}

1391 
	$wrôe_íd_‚
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1393 
ªt
;

1394 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1396 
	`£t_buf„r_u±od©e
(
bh
);

1397 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1398 
	`˛ór_buf„r_mëa
(
bh
);

1399 
	`˛ór_buf„r_¥io
(
bh
);

1400  
ªt
;

1401 
	}
}

1410 
	$pxt4_wrôe_íd
(
fûe
 *file,

1411 
addªss_•a˚
 *
m≠pög
,

1412 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1413 
∑ge
 *∑ge, *
fsd©a
)

1415 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1416 
öode
 *öodê
m≠pög
->
ho°
;

1417 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1418 
ªt
 = 0, 
ªt2
;

1419 
i_size_ch™ged
 = 0;

1420 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1421 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1423 
	`åa˚_pxt4_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1424 i‡(
ölöe_d©a
) {

1425 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1426 
c›õd
, 
∑ge
);

1427 i‡(
ªt
 < 0) {

1428 
	`u∆ock_∑ge
(
∑ge
);

1429 
	`put_∑ge
(
∑ge
);

1430 
îrout
;

1432 
c›õd
 = 
ªt
;

1434 
c›õd
 = 
	`block_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

1435 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

1443 i‡(!
vîôy
)

1444 
i_size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1445 
	`u∆ock_∑ge
(
∑ge
);

1446 
	`put_∑ge
(
∑ge
);

1448 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1449 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1456 i‡(
i_size_ch™ged
 || 
ölöe_d©a
)

1457 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1459 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1464 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1465 
îrout
:

1466 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1467 i‡(!
ªt
)

1468 
ªt
 = 
ªt2
;

1470 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1471 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1477 i‡(
öode
->
i_∆ök
)

1478 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1481  
ªt
 ?Ñë : 
c›õd
;

1482 
	}
}

1489 
	$pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1490 
∑ge
 *page,

1491 
‰om
, 
to
)

1493 
block_°¨t
 = 0, 
block_íd
;

1494 
buf„r_hód
 *
hód
, *
bh
;

1496 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1498 
block_íd
 = 
block_°¨t
 + 
bh
->
b_size
;

1499 i‡(
	`buf„r_√w
(
bh
)) {

1500 i‡(
block_íd
 > 
‰om
 && 
block_°¨t
 < 
to
) {

1501 i‡(!
	`PageU±od©e
(
∑ge
)) {

1502 
°¨t
, 
size
;

1504 
°¨t
 = 
	`max
(
‰om
, 
block_°¨t
);

1505 
size
 = 
	`mö
(
to
, 
block_íd
Ë- 
°¨t
;

1507 
	`zîo_u£r
(
∑ge
, 
°¨t
, 
size
);

1508 
	`wrôe_íd_‚
(
h™dÀ
, 
bh
);

1510 
	`˛ór_buf„r_√w
(
bh
);

1513 
block_°¨t
 = 
block_íd
;

1514 
bh
 = bh->
b_this_∑ge
;

1515 } 
bh
 !
hód
);

1516 
	}
}

1518 
	$pxt4_jou∫ÆÀd_wrôe_íd
(
fûe
 *file,

1519 
addªss_•a˚
 *
m≠pög
,

1520 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1521 
∑ge
 *∑ge, *
fsd©a
)

1523 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1524 
öode
 *öodê
m≠pög
->
ho°
;

1525 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1526 
ªt
 = 0, 
ªt2
;

1527 
∑πül
 = 0;

1528 
‰om
, 
to
;

1529 
size_ch™ged
 = 0;

1530 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1531 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1533 
	`åa˚_pxt4_jou∫ÆÀd_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1534 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1535 
to
 = 
‰om
 + 
Àn
;

1537 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

1539 i‡(
ölöe_d©a
) {

1540 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1541 
c›õd
, 
∑ge
);

1542 i‡(
ªt
 < 0) {

1543 
	`u∆ock_∑ge
(
∑ge
);

1544 
	`put_∑ge
(
∑ge
);

1545 
îrout
;

1547 
c›õd
 = 
ªt
;

1548 } i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
Ë&& !
	`PageU±od©e
(
∑ge
)) {

1549 
c›õd
 = 0;

1550 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
, 
‰om
, 
to
);

1552 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
))

1553 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
,

1554 
‰om
 + 
c›õd
, 
to
);

1555 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 
‰om
,

1556 
‰om
 + 
c›õd
, &
∑πül
,

1557 
wrôe_íd_‚
);

1558 i‡(!
∑πül
)

1559 
	`SëPageU±od©e
(
∑ge
);

1561 i‡(!
vîôy
)

1562 
size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1563 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

1564 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1565 
	`u∆ock_∑ge
(
∑ge
);

1566 
	`put_∑ge
(
∑ge
);

1568 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1569 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1571 i‡(
size_ch™ged
 || 
ölöe_d©a
) {

1572 
ªt2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1573 i‡(!
ªt
)

1574 
ªt
 = 
ªt2
;

1577 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1582 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1584 
îrout
:

1585 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1586 i‡(!
ªt
)

1587 
ªt
 = 
ªt2
;

1588 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1589 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1595 i‡(
öode
->
i_∆ök
)

1596 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1599  
ªt
 ?Ñë : 
c›õd
;

1600 
	}
}

1605 
	$pxt4_da_ª£rve_•a˚
(
öode
 *inode)

1607 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1608 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1609 
ªt
;

1616 
ªt
 = 
	`dquŸ_ª£rve_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1617 i‡(
ªt
)

1618  
ªt
;

1620 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1621 i‡(
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 1, 0)) {

1622 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1623 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1624  -
ENOSPC
;

1626 
ei
->
i_ª£rved_d©a_blocks
++;

1627 
	`åa˚_pxt4_da_ª£rve_•a˚
(
öode
);

1628 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1631 
	}
}

1633 
	$pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
)

1635 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1636 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1638 i‡(!
to_‰ì
)

1641 
	`•ö_lock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1643 
	`åa˚_pxt4_da_ªÀa£_•a˚
(
öode
, 
to_‰ì
);

1644 i‡(
	`u∆ikñy
(
to_‰ì
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

1651 
	`pxt4_w¨nög
(
öode
->
i_sb
, "pxt4_da_release_space: "

1653 "d©®blocks", 
öode
->
i_öo
, 
to_‰ì
,

1654 
ei
->
i_ª£rved_d©a_blocks
);

1655 
	`WARN_ON
(1);

1656 
to_‰ì
 = 
ei
->
i_ª£rved_d©a_blocks
;

1658 
ei
->
i_ª£rved_d©a_blocks
 -
to_‰ì
;

1661 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
to_‰ì
);

1663 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1665 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
to_‰ì
));

1666 
	}
}

1672 
	sm∑ge_da_d©a
 {

1673 
öode
 *
	möode
;

1674 
wrôeback_c⁄åﬁ
 *
	mwbc
;

1676 
pgoff_t
 
	mfú°_∑ge
;

1677 
pgoff_t
 
	m√xt_∑ge
;

1678 
pgoff_t
 
	mœ°_∑ge
;

1684 
pxt4_m≠_blocks
 
	mm≠
;

1685 
pxt4_io_submô
 
	mio_submô
;

1686 
	mdo_m≠
:1;

1689 
	$m∑ge_ªÀa£_unu£d_∑ges
(
m∑ge_da_d©a
 *
mpd
,

1690 
boﬁ
 
övÆid©e
)

1692 
ƒ_∑ges
, 
i
;

1693 
pgoff_t
 
ödex
, 
íd
;

1694 
∑gevec
 
pvec
;

1695 
öode
 *öodê
mpd
->inode;

1696 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

1699 i‡(
mpd
->
fú°_∑ge
 >mpd->
√xt_∑ge
)

1702 
ödex
 = 
mpd
->
fú°_∑ge
;

1703 
íd
 = 
mpd
->
√xt_∑ge
 - 1;

1704 i‡(
övÆid©e
) {

1705 
pxt4_lblk_t
 
°¨t
, 
œ°
;

1706 
°¨t
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1707 
œ°
 = 
íd
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1708 
	`pxt4_es_ªmove_exã¡
(
öode
, 
°¨t
, 
œ°
 - start + 1);

1711 
	`∑gevec_öô
(&
pvec
);

1712 
ödex
 <
íd
) {

1713 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
);

1714 i‡(
ƒ_∑ges
 == 0)

1716 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1717 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

1719 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1720 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

1721 i‡(
övÆid©e
) {

1722 i‡(
	`∑ge_m≠≥d
(
∑ge
))

1723 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

1724 
	`block_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

1725 
	`CÀ¨PageU±od©e
(
∑ge
);

1727 
	`u∆ock_∑ge
(
∑ge
);

1729 
	`∑gevec_ªÀa£
(&
pvec
);

1731 
	}
}

1733 
	$pxt4_¥öt_‰ì_blocks
(
öode
 *inode)

1735 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1736 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1737 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1739 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Total free blocks count %lld",

1740 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

1741 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
)));

1742 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Free/Dirty block details");

1743 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "free_blocks=%lld",

1744 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1745 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_‰ì˛u°îs_cou¡î
)));

1746 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "dirty_blocks=%lld",

1747 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1748 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

1749 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "BlockÑeservation details");

1750 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "i_reserved_data_blocks=%u",

1751 
ei
->
i_ª£rved_d©a_blocks
);

1753 
	}
}

1755 
	$pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1757  (
	`buf„r_dñay
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)Ë&& 
	`buf„r_dúty
(bh);

1758 
	}
}

1771 
	$pxt4_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1773 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1774 
ªt
;

1775 
boﬁ
 
Æloˇãd
 = 
Ál£
;

1788 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1789 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1790 i‡(
ªt
 != 0)

1791 
îrout
;

1793 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
, &
pxt4_es_is_dñ⁄ly
, 
lblk
)) {

1794 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
,

1795 &
pxt4_es_is_m≠≥d
, 
lblk
)) {

1796 
ªt
 = 
	`pxt4_˛u_m≠≥d
(
öode
,

1797 
	`PXT4_B2C
(
sbi
, 
lblk
));

1798 i‡(
ªt
 < 0)

1799 
îrout
;

1800 i‡(
ªt
 == 0) {

1801 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1802 i‡(
ªt
 != 0)

1803 
îrout
;

1805 
Æloˇãd
 = 
åue
;

1808 
Æloˇãd
 = 
åue
;

1813 
ªt
 = 
	`pxt4_es_ö£π_dñayed_block
(
öode
, 
lblk
, 
Æloˇãd
);

1815 
îrout
:

1816  
ªt
;

1817 
	}
}

1825 
	$pxt4_da_m≠_blocks
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1826 
pxt4_m≠_blocks
 *
m≠
,

1827 
buf„r_hód
 *
bh
)

1829 
exã¡_°©us
 
es
;

1830 
ªtvÆ
;

1831 
£˘‹_t
 
övÆid_block
 = ~((sector_t) 0xffff);

1832 #ifde‡
ES_AGGRESSIVE_TEST


1833 
pxt4_m≠_blocks
 
‹ig_m≠
;

1835 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

1838 i‡(
övÆid_block
 < 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
))

1839 
övÆid_block
 = ~0;

1841 
m≠
->
m_Êags
 = 0;

1842 
	`ext_debug
("pxt4_da_map_blocks(): inode %lu, max_blocks %u,"

1843 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
m≠
->
m_Àn
,

1844 (Ë
m≠
->
m_lblk
);

1847 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
iblock
, 
NULL
, &
es
)) {

1848 i‡(
	`pxt4_es_is_hﬁe
(&
es
)) {

1849 
ªtvÆ
 = 0;

1850 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1851 
add_dñayed
;

1858 i‡(
	`pxt4_es_is_dñayed
(&
es
Ë&& !
	`pxt4_es_is_unwrôãn
(&es)) {

1859 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1860 
	`£t_buf„r_√w
(
bh
);

1861 
	`£t_buf„r_dñay
(
bh
);

1865 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
Ë+ 
iblock
 -És.
es_lblk
;

1866 
ªtvÆ
 = 
es
.
es_Àn
 - (
iblock
 -És.
es_lblk
);

1867 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

1868 
ªtvÆ
 = 
m≠
->
m_Àn
;

1869 
m≠
->
m_Àn
 = 
ªtvÆ
;

1870 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

1871 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

1872 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

1873 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

1875 
	`BUG
();

1877 #ifde‡
ES_AGGRESSIVE_TEST


1878 
	`pxt4_m≠_blocks_es_ªcheck
(
NULL
, 
öode
, 
m≠
, &
‹ig_m≠
, 0);

1880  
ªtvÆ
;

1887 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1888 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

1889 
ªtvÆ
 = 0;

1890 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

1891 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1893 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1895 
add_dñayed
:

1896 i‡(
ªtvÆ
 == 0) {

1897 
ªt
;

1904 
ªt
 = 
	`pxt4_ö£π_dñayed_block
(
öode
, 
m≠
->
m_lblk
);

1905 i‡(
ªt
 != 0) {

1906 
ªtvÆ
 = 
ªt
;

1907 
out_u∆ock
;

1910 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1911 
	`£t_buf„r_√w
(
bh
);

1912 
	`£t_buf„r_dñay
(
bh
);

1913 } i‡(
ªtvÆ
 > 0) {

1914 
ªt
;

1915 
°©us
;

1917 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

1918 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1921 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

1922 
	`WARN_ON
(1);

1925 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

1926 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

1927 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

1928 
m≠
->
m_pblk
, 
°©us
);

1929 i‡(
ªt
 != 0)

1930 
ªtvÆ
 = 
ªt
;

1933 
out_u∆ock
:

1934 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

1936  
ªtvÆ
;

1937 
	}
}

1951 
	$pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1952 
buf„r_hód
 *
bh
, 
¸óã
)

1954 
pxt4_m≠_blocks
 
m≠
;

1955 
ªt
 = 0;

1957 
	`BUG_ON
(
¸óã
 == 0);

1958 
	`BUG_ON
(
bh
->
b_size
 !
öode
->
i_sb
->
s_blocksize
);

1960 
m≠
.
m_lblk
 = 
iblock
;

1961 
m≠
.
m_Àn
 = 1;

1968 
ªt
 = 
	`pxt4_da_m≠_blocks
(
öode
, 
iblock
, &
m≠
, 
bh
);

1969 i‡(
ªt
 <= 0)

1970  
ªt
;

1972 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

1973 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

1975 i‡(
	`buf„r_unwrôãn
(
bh
)) {

1982 
	`£t_buf„r_√w
(
bh
);

1983 
	`£t_buf„r_m≠≥d
(
bh
);

1986 
	}
}

1988 
	$bgë_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1990 
	`gë_bh
(
bh
);

1992 
	}
}

1994 
	$bput_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1996 
	`put_bh
(
bh
);

1998 
	}
}

2000 
	$__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *page,

2001 
Àn
)

2003 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

2004 
öode
 *öodê
m≠pög
->
ho°
;

2005 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

2006 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2007 
ªt
 = 0, 
îr
 = 0;

2008 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

2009 
buf„r_hód
 *
öode_bh
 = 
NULL
;

2011 
	`CÀ¨PageChecked
(
∑ge
);

2013 i‡(
ölöe_d©a
) {

2014 
	`BUG_ON
(
∑ge
->
ödex
 != 0);

2015 
	`BUG_ON
(
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
));

2016 
öode_bh
 = 
	`pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
, 
Àn
, 
∑ge
);

2017 i‡(
öode_bh
 =
NULL
)

2018 
out
;

2020 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2021 i‡(!
∑ge_bufs
) {

2022 
	`BUG
();

2023 
out
;

2025 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
,

2026 
NULL
, 
bgë_⁄e
);

2033 
	`gë_∑ge
(
∑ge
);

2034 
	`u∆ock_∑ge
(
∑ge
);

2036 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

2037 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

2038 i‡(
	`IS_ERR
(
h™dÀ
)) {

2039 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2040 
	`put_∑ge
(
∑ge
);

2041 
out_no_∑gñock
;

2043 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

2045 
	`lock_∑ge
(
∑ge
);

2046 
	`put_∑ge
(
∑ge
);

2047 i‡(
∑ge
->
m≠pög
 != mapping) {

2049 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2050 
ªt
 = 0;

2051 
out
;

2054 i‡(
ölöe_d©a
) {

2055 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2057 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2058 
do_jou∫Æ_gë_wrôe_ac˚ss
);

2060 
îr
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2061 
wrôe_íd_‚
);

2063 i‡(
ªt
 == 0)

2064 
ªt
 = 
îr
;

2065 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

2066 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2067 i‡(!
ªt
)

2068 
ªt
 = 
îr
;

2070 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

2071 
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
,

2072 
NULL
, 
bput_⁄e
);

2073 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

2074 
out
:

2075 
	`u∆ock_∑ge
(
∑ge
);

2076 
out_no_∑gñock
:

2077 
	`bªl£
(
öode_bh
);

2078  
ªt
;

2079 
	}
}

2122 
	$pxt4_wrôïage
(
∑ge
 *page,

2123 
wrôeback_c⁄åﬁ
 *
wbc
)

2125 
ªt
 = 0;

2126 
loff_t
 
size
;

2127 
Àn
;

2128 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

2129 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

2130 
pxt4_io_submô
 
io_submô
;

2131 
boﬁ
 
kìp_towrôe
 = 
Ál£
;

2133 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

2134 
öode
->
i_m≠pög
->
a_›s
->
	`övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

2135 
	`u∆ock_∑ge
(
∑ge
);

2136  -
EIO
;

2139 
	`åa˚_pxt4_wrôïage
(
∑ge
);

2140 
size
 = 
	`i_size_ªad
(
öode
);

2141 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

2142 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

2143 
Àn
 = 
size
 & ~
PAGE_MASK
;

2145 
Àn
 = 
PAGE_SIZE
;

2147 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2165 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
, NULL,

2166 
pxt4_bh_dñay_‹_unwrôãn
)) {

2167 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2168 i‡((
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

2169 (
öode
->
i_sb
->
s_blocksize
 =
PAGE_SIZE
)) {

2175 
	`WARN_ON_ONCE
((
cuºít
->
Êags
 & (
PF_MEMALLOC
|
PF_KSWAPD
))

2176 =
PF_MEMALLOC
);

2177 
	`u∆ock_∑ge
(
∑ge
);

2180 
kìp_towrôe
 = 
åue
;

2183 i‡(
	`PageChecked
(
∑ge
Ë&& 
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2188  
	`__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
, 
Àn
);

2190 
	`pxt4_io_submô_öô
(&
io_submô
, 
wbc
);

2191 
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_NOFS
);

2192 i‡(!
io_submô
.
io_íd
) {

2193 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2194 
	`u∆ock_∑ge
(
∑ge
);

2195  -
ENOMEM
;

2197 
ªt
 = 
	`pxt4_bio_wrôe_∑ge
(&
io_submô
, 
∑ge
, 
Àn
, 
wbc
, 
kìp_towrôe
);

2198 
	`pxt4_io_submô
(&
io_submô
);

2200 
	`pxt4_put_io_íd_de„r
(
io_submô
.
io_íd
);

2201  
ªt
;

2202 
	}
}

2204 
	$m∑ge_submô_∑ge
(
m∑ge_da_d©a
 *
mpd
, 
∑ge
 *page)

2206 
Àn
;

2207 
loff_t
 
size
;

2208 
îr
;

2210 
	`BUG_ON
(
∑ge
->
ödex
 !
mpd
->
fú°_∑ge
);

2211 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

2225 
size
 = 
	`i_size_ªad
(
mpd
->
öode
);

2226 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

2227 !
	`pxt4_vîôy_ö_¥ogªss
(
mpd
->
öode
))

2228 
Àn
 = 
size
 & ~
PAGE_MASK
;

2230 
Àn
 = 
PAGE_SIZE
;

2231 
îr
 = 
	`pxt4_bio_wrôe_∑ge
(&
mpd
->
io_submô
, 
∑ge
, 
Àn
, mpd->
wbc
, 
Ál£
);

2232 i‡(!
îr
)

2233 
mpd
->
wbc
->
ƒ_to_wrôe
--;

2234 
mpd
->
fú°_∑ge
++;

2236  
îr
;

2237 
	}
}

2239 
	#BH_FLAGS
 ((1 << 
BH_Unwrôãn
Ë| (1 << 
BH_Dñay
))

	)

2246 
	#MAX_WRITEPAGES_EXTENT_LEN
 2048

	)

2262 
boﬁ
 
	$m∑ge_add_bh_to_exã¡
(
m∑ge_da_d©a
 *
mpd
, 
pxt4_lblk_t
 
lblk
,

2263 
buf„r_hód
 *
bh
)

2265 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2268 i‡(!
	`buf„r_dúty
(
bh
Ë|| !
	`buf„r_m≠≥d
(bh) ||

2269 (!
	`buf„r_dñay
(
bh
Ë&& !
	`buf„r_unwrôãn
(bh))) {

2271 i‡(
m≠
->
m_Àn
 == 0)

2272  
åue
;

2273  
Ál£
;

2277 i‡(
m≠
->
m_Àn
 == 0) {

2279 i‡(!
mpd
->
do_m≠
)

2280  
Ál£
;

2281 
m≠
->
m_lblk
 = 
lblk
;

2282 
m≠
->
m_Àn
 = 1;

2283 
m≠
->
m_Êags
 = 
bh
->
b_°©e
 & 
BH_FLAGS
;

2284  
åue
;

2288 i‡(
m≠
->
m_Àn
 >
MAX_WRITEPAGES_EXTENT_LEN
)

2289  
Ál£
;

2292 i‡(
lblk
 =
m≠
->
m_lblk
 + m≠->
m_Àn
 &&

2293 (
bh
->
b_°©e
 & 
BH_FLAGS
Ë=
m≠
->
m_Êags
) {

2294 
m≠
->
m_Àn
++;

2295  
åue
;

2297  
Ál£
;

2298 
	}
}

2316 
	$m∑ge_¥o˚ss_∑ge_bufs
(
m∑ge_da_d©a
 *
mpd
,

2317 
buf„r_hód
 *
hód
,

2318 
buf„r_hód
 *
bh
,

2319 
pxt4_lblk_t
 
lblk
)

2321 
öode
 *öodê
mpd
->inode;

2322 
îr
;

2323 
pxt4_lblk_t
 
blocks
 = (
	`i_size_ªad
(
öode
Ë+ 
	`i_blocksize
(inode) - 1)

2324 >> 
öode
->
i_blkbôs
;

2326 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

2327 
blocks
 = 
EXT_MAX_BLOCKS
;

2330 
	`BUG_ON
(
	`buf„r_locked
(
bh
));

2332 i‡(
lblk
 >
blocks
 || !
	`m∑ge_add_bh_to_exã¡
(
mpd
,Üblk, 
bh
)) {

2334 i‡(
mpd
->
m≠
.
m_Àn
)

2337 i‡(!
mpd
->
do_m≠
)

2342 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2344 i‡(
mpd
->
m≠
.
m_Àn
 == 0) {

2345 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
hód
->
b_∑ge
);

2346 i‡(
îr
 < 0)

2347  
îr
;

2349  
lblk
 < 
blocks
;

2350 
	}
}

2366 
	$m∑ge_m≠_™d_submô_buf„rs
(
m∑ge_da_d©a
 *
mpd
)

2368 
∑gevec
 
pvec
;

2369 
ƒ_∑ges
, 
i
;

2370 
öode
 *öodê
mpd
->inode;

2371 
buf„r_hód
 *
hód
, *
bh
;

2372 
bµ_bôs
 = 
PAGE_SHIFT
 - 
öode
->
i_blkbôs
;

2373 
pgoff_t
 
°¨t
, 
íd
;

2374 
pxt4_lblk_t
 
lblk
;

2375 
£˘‹_t
 
pblock
;

2376 
îr
;

2378 
°¨t
 = 
mpd
->
m≠
.
m_lblk
 >> 
bµ_bôs
;

2379 
íd
 = (
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
 - 1Ë>> 
bµ_bôs
;

2380 
lblk
 = 
°¨t
 << 
bµ_bôs
;

2381 
pblock
 = 
mpd
->
m≠
.
m_pblk
;

2383 
	`∑gevec_öô
(&
pvec
);

2384 
°¨t
 <
íd
) {

2385 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
öode
->
i_m≠pög
,

2386 &
°¨t
, 
íd
);

2387 i‡(
ƒ_∑ges
 == 0)

2389 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2390 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2392 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2394 i‡(
lblk
 < 
mpd
->
m≠
.
m_lblk
)

2396 i‡(
lblk
 >
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
) {

2401 
mpd
->
m≠
.
m_Àn
 = 0;

2402 
mpd
->
m≠
.
m_Êags
 = 0;

2410 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
,

2411 
bh
, 
lblk
);

2412 
	`∑gevec_ªÀa£
(&
pvec
);

2413 i‡(
îr
 > 0)

2414 
îr
 = 0;

2415  
îr
;

2417 i‡(
	`buf„r_dñay
(
bh
)) {

2418 
	`˛ór_buf„r_dñay
(
bh
);

2419 
bh
->
b_blockƒ
 = 
pblock
++;

2421 
	`˛ór_buf„r_unwrôãn
(
bh
);

2422 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2429 
mpd
->
io_submô
.
io_íd
->
size
 +
PAGE_SIZE
;

2431 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
∑ge
);

2432 i‡(
îr
 < 0) {

2433 
	`∑gevec_ªÀa£
(&
pvec
);

2434  
îr
;

2437 
	`∑gevec_ªÀa£
(&
pvec
);

2440 
mpd
->
m≠
.
m_Àn
 = 0;

2441 
mpd
->
m≠
.
m_Êags
 = 0;

2443 
	}
}

2445 
	$m∑ge_m≠_⁄e_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
m∑ge_da_d©a
 *
mpd
)

2447 
öode
 *öodê
mpd
->inode;

2448 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2449 
gë_blocks_Êags
;

2450 
îr
, 
di‹ód_nﬁock
;

2452 
	`åa˚_pxt4_da_wrôe_∑ges_exã¡
(
öode
, 
m≠
);

2468 
gë_blocks_Êags
 = 
PXT4_GET_BLOCKS_CREATE
 |

2469 
PXT4_GET_BLOCKS_METADATA_NOFAIL
 |

2470 
PXT4_GET_BLOCKS_IO_SUBMIT
;

2471 
di‹ód_nﬁock
 = 
	`pxt4_should_di‹ód_nﬁock
(
öode
);

2472 i‡(
di‹ód_nﬁock
)

2473 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_IO_CREATE_EXT
;

2474 i‡(
m≠
->
m_Êags
 & (1 << 
BH_Dñay
))

2475 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_DELALLOC_RESERVE
;

2477 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
gë_blocks_Êags
);

2478 i‡(
îr
 < 0)

2479  
îr
;

2480 i‡(
di‹ód_nﬁock
 && (
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
)) {

2481 i‡(!
mpd
->
io_submô
.
io_íd
->
h™dÀ
 &&

2482 
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2483 
mpd
->
io_submô
.
io_íd
->
h™dÀ
 = h™dÀ->
h_rsv_h™dÀ
;

2484 
h™dÀ
->
h_rsv_h™dÀ
 = 
NULL
;

2486 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
mpd
->
io_submô
.
io_íd
);

2489 
	`BUG_ON
(
m≠
->
m_Àn
 == 0);

2491 
	}
}

2513 
	$m∑ge_m≠_™d_submô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

2514 
m∑ge_da_d©a
 *
mpd
,

2515 
boﬁ
 *
give_up_⁄_wrôe
)

2517 
öode
 *öodê
mpd
->inode;

2518 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2519 
îr
;

2520 
loff_t
 
disksize
;

2521 
¥ogªss
 = 0;

2523 
mpd
->
io_submô
.
io_íd
->
off£t
 =

2524 ((
loff_t
)
m≠
->
m_lblk
Ë<< 
öode
->
i_blkbôs
;

2526 
îr
 = 
	`m∑ge_m≠_⁄e_exã¡
(
h™dÀ
, 
mpd
);

2527 i‡(
îr
 < 0) {

2528 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2530 i‡(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
)) ||

2531 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

2532 
övÆid©e_dúty_∑ges
;

2538 i‡((
îr
 =-
ENOMEM
) ||

2539 (
îr
 =-
ENOSPC
 && 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
))) {

2540 i‡(
¥ogªss
)

2541 
upd©e_disksize
;

2542  
îr
;

2544 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2548 
öode
->
i_öo
,

2549 ()
m≠
->
m_lblk
,

2550 ()
m≠
->
m_Àn
, -
îr
);

2551 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2554 i‡(
îr
 =-
ENOSPC
)

2555 
	`pxt4_¥öt_‰ì_blocks
(
öode
);

2556 
övÆid©e_dúty_∑ges
:

2557 *
give_up_⁄_wrôe
 = 
åue
;

2558  
îr
;

2560 
¥ogªss
 = 1;

2565 
îr
 = 
	`m∑ge_m≠_™d_submô_buf„rs
(
mpd
);

2566 i‡(
îr
 < 0)

2567 
upd©e_disksize
;

2568 } 
m≠
->
m_Àn
);

2570 
upd©e_disksize
:

2575 
disksize
 = ((
loff_t
)
mpd
->
fú°_∑ge
Ë<< 
PAGE_SHIFT
;

2576 i‡(
disksize
 > 
	`READ_ONCE
(
	`PXT4_I
(
öode
)->
i_disksize
)) {

2577 
îr2
;

2578 
loff_t
 
i_size
;

2580 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2581 
i_size
 = 
	`i_size_ªad
(
öode
);

2582 i‡(
disksize
 > 
i_size
)

2583 
disksize
 = 
i_size
;

2584 i‡(
disksize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2585 
	`PXT4_I
(
öode
)->
i_disksize
 = 
disksize
;

2586 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2587 
îr2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2588 i‡(
îr2
)

2589 
	`pxt4_îr‹
(
öode
->
i_sb
,

2591 
öode
->
i_öo
);

2592 i‡(!
îr
)

2593 
îr
 = 
îr2
;

2595  
îr
;

2596 
	}
}

2605 
	$pxt4_da_wrôïages_å™s_blocks
(
öode
 *inode)

2607 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

2609  
	`pxt4_mëa_å™s_blocks
(
öode
,

2610 
MAX_WRITEPAGES_EXTENT_LEN
 + 
bµ
 - 1, bpp);

2611 
	}
}

2631 
	$m∑ge_¥ï¨e_exã¡_to_m≠
(
m∑ge_da_d©a
 *
mpd
)

2633 
addªss_•a˚
 *
m≠pög
 = 
mpd
->
öode
->
i_m≠pög
;

2634 
∑gevec
 
pvec
;

2635 
ƒ_∑ges
;

2636 
À·
 = 
mpd
->
wbc
->
ƒ_to_wrôe
;

2637 
pgoff_t
 
ödex
 = 
mpd
->
fú°_∑ge
;

2638 
pgoff_t
 
íd
 = 
mpd
->
œ°_∑ge
;

2639 
xa_m¨k_t
 
èg
;

2640 
i
, 
îr
 = 0;

2641 
blkbôs
 = 
mpd
->
öode
->
i_blkbôs
;

2642 
pxt4_lblk_t
 
lblk
;

2643 
buf„r_hód
 *
hód
;

2645 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || mpd->wbc->
ègged_wrôïages
)

2646 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

2648 
èg
 = 
PAGECACHE_TAG_DIRTY
;

2650 
	`∑gevec_öô
(&
pvec
);

2651 
mpd
->
m≠
.
m_Àn
 = 0;

2652 
mpd
->
√xt_∑ge
 = 
ödex
;

2653 
ödex
 <
íd
) {

2654 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge_èg
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
,

2655 
èg
);

2656 i‡(
ƒ_∑ges
 == 0)

2657 
out
;

2659 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2660 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2670 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
 && 
À·
 <= 0)

2671 
out
;

2674 i‡(
mpd
->
m≠
.
m_Àn
 > 0 && mpd->
√xt_∑ge
 !
∑ge
->
ödex
)

2675 
out
;

2677 
	`lock_∑ge
(
∑ge
);

2685 i‡(!
	`PageDúty
(
∑ge
) ||

2686 (
	`PageWrôeback
(
∑ge
) &&

2687 (
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
)) ||

2688 
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

2689 
	`u∆ock_∑ge
(
∑ge
);

2693 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2694 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

2696 i‡(
mpd
->
m≠
.
m_Àn
 == 0)

2697 
mpd
->
fú°_∑ge
 = 
∑ge
->
ödex
;

2698 
mpd
->
√xt_∑ge
 = 
∑ge
->
ödex
 + 1;

2700 
lblk
 = ((
pxt4_lblk_t
)
∑ge
->
ödex
) <<

2701 (
PAGE_SHIFT
 - 
blkbôs
);

2702 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2703 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
, hód, 
lblk
);

2704 i‡(
îr
 <= 0)

2705 
out
;

2706 
îr
 = 0;

2707 
À·
--;

2709 
	`∑gevec_ªÀa£
(&
pvec
);

2710 
	`c⁄d_ªsched
();

2713 
out
:

2714 
	`∑gevec_ªÀa£
(&
pvec
);

2715  
îr
;

2716 
	}
}

2718 
	$pxt4_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2719 
wrôeback_c⁄åﬁ
 *
wbc
)

2721 
pgoff_t
 
wrôeback_ödex
 = 0;

2722 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2723 
ønge_whﬁe
 = 0;

2724 
cy˛ed
 = 1;

2725 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2726 
m∑ge_da_d©a
 
mpd
;

2727 
öode
 *öodê
m≠pög
->
ho°
;

2728 
√eded_blocks
, 
rsv_blocks
 = 0, 
ªt
 = 0;

2729 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2730 
boﬁ
 
d⁄e
;

2731 
blk_∂ug
 
∂ug
;

2732 
boﬁ
 
give_up_⁄_wrôe
 = 
Ál£
;

2734 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2735  -
EIO
;

2737 
	`≥r˝u_down_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2738 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2745 i‡(!
m≠pög
->
ƒ∑ges
 || !
	`m≠pög_ègged
(m≠pög, 
PAGECACHE_TAG_DIRTY
))

2746 
out_wrôïages
;

2748 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

2749 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, 
wbc
);

2750 
out_wrôïages
;

2763 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
)) ||

2764 
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)) {

2765 
ªt
 = -
EROFS
;

2766 
out_wrôïages
;

2774 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2776 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

2777 i‡(
	`IS_ERR
(
h™dÀ
)) {

2778 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2779 
out_wrôïages
;

2781 
	`BUG_ON
(
	`pxt4_ã°_öode_°©e
(
öode
,

2782 
PXT4_STATE_MAY_INLINE_DATA
));

2783 
	`pxt4_de°roy_ölöe_d©a
(
h™dÀ
, 
öode
);

2784 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2787 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

2792 
rsv_blocks
 = 1 + 
	`pxt4_chunk_å™s_blocks
(
öode
,

2793 
PAGE_SIZE
 >> 
öode
->
i_blkbôs
);

2796 i‡(
wbc
->
ønge_°¨t
 =0 && wbc->
ønge_íd
 =
LLONG_MAX
)

2797 
ønge_whﬁe
 = 1;

2799 i‡(
wbc
->
ønge_cy˛ic
) {

2800 
wrôeback_ödex
 = 
m≠pög
->writeback_index;

2801 i‡(
wrôeback_ödex
)

2802 
cy˛ed
 = 0;

2803 
mpd
.
fú°_∑ge
 = 
wrôeback_ödex
;

2804 
mpd
.
œ°_∑ge
 = -1;

2806 
mpd
.
fú°_∑ge
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

2807 
mpd
.
œ°_∑ge
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

2810 
mpd
.
öode
 = inode;

2811 
mpd
.
wbc
 = wbc;

2812 
	`pxt4_io_submô_öô
(&
mpd
.
io_submô
, 
wbc
);

2813 
ªåy
:

2814 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2815 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
mpd
.
fú°_∑ge
, mpd.
œ°_∑ge
);

2816 
d⁄e
 = 
Ál£
;

2817 
	`blk_°¨t_∂ug
(&
∂ug
);

2825 
mpd
.
do_m≠
 = 0;

2826 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2827 i‡(!
mpd
.
io_submô
.
io_íd
) {

2828 
ªt
 = -
ENOMEM
;

2829 
u≈lug
;

2831 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2833 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
Ál£
);

2835 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2836 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2837 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2838 i‡(
ªt
 < 0)

2839 
u≈lug
;

2841 !
d⁄e
 && 
mpd
.
fú°_∑ge
 <mpd.
œ°_∑ge
) {

2843 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2844 i‡(!
mpd
.
io_submô
.
io_íd
) {

2845 
ªt
 = -
ENOMEM
;

2856 
	`BUG_ON
(
	`pxt4_should_jou∫Æ_d©a
(
öode
));

2857 
√eded_blocks
 = 
	`pxt4_da_wrôïages_å™s_blocks
(
öode
);

2860 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
,

2861 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
, 
rsv_blocks
);

2862 i‡(
	`IS_ERR
(
h™dÀ
)) {

2863 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2864 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_CRIT
, "%s: jbd3_start: "

2865 "%ldÖages, inÿ%lu;Éº %d", 
__func__
,

2866 
wbc
->
ƒ_to_wrôe
, 
öode
->
i_öo
, 
ªt
);

2868 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2869 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2872 
mpd
.
do_m≠
 = 1;

2874 
	`åa˚_pxt4_da_wrôe_∑ges
(
öode
, 
mpd
.
fú°_∑ge
, mpd.
wbc
);

2875 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2876 i‡(!
ªt
) {

2877 i‡(
mpd
.
m≠
.
m_Àn
)

2878 
ªt
 = 
	`m∑ge_m≠_™d_submô_exã¡
(
h™dÀ
, &
mpd
,

2879 &
give_up_⁄_wrôe
);

2887 
d⁄e
 = 
åue
;

2900 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë|| h™dÀ->
h_sync
 == 0) {

2901 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2902 
h™dÀ
 = 
NULL
;

2903 
mpd
.
do_m≠
 = 0;

2906 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
give_up_⁄_wrôe
);

2908 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2917 i‡(
h™dÀ
) {

2918 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2919 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2921 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2922 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2924 i‡(
ªt
 =-
ENOSPC
 && 
sbi
->
s_jou∫Æ
) {

2930 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
sbi
->
s_jou∫Æ
);

2931 
ªt
 = 0;

2935 i‡(
ªt
)

2938 
u≈lug
:

2939 
	`blk_föish_∂ug
(&
∂ug
);

2940 i‡(!
ªt
 && !
cy˛ed
 && 
wbc
->
ƒ_to_wrôe
 > 0) {

2941 
cy˛ed
 = 1;

2942 
mpd
.
œ°_∑ge
 = 
wrôeback_ödex
 - 1;

2943 
mpd
.
fú°_∑ge
 = 0;

2944 
ªåy
;

2948 i‡(
wbc
->
ønge_cy˛ic
 || (
ønge_whﬁe
 && wbc->
ƒ_to_wrôe
 > 0))

2953 
m≠pög
->
wrôeback_ödex
 = 
mpd
.
fú°_∑ge
;

2955 
out_wrôïages
:

2956 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2957 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2958 
	`≥r˝u_up_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2959  
ªt
;

2960 
	}
}

2962 
	$pxt4_dax_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2963 
wrôeback_c⁄åﬁ
 *
wbc
)

2965 
ªt
;

2966 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2967 
öode
 *öodê
m≠pög
->
ho°
;

2968 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2970 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2971  -
EIO
;

2973 
	`≥r˝u_down_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2974 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2976 
ªt
 = 
	`dax_wrôeback_m≠pög_ønge
(
m≠pög
, 
öode
->
i_sb
->
s_bdev
, 
wbc
);

2977 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2978 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2979 
	`≥r˝u_up_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2980  
ªt
;

2981 
	}
}

2983 
	$pxt4_n⁄da_swôch
(
su≥r_block
 *
sb
)

2985 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
;

2986 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2996 
‰ì_˛u°îs
 =

2997 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

2998 
dúty_˛u°îs
 =

2999 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

3003 i‡(
dúty_˛u°îs
 && (
‰ì_˛u°îs
 < 2 * dirty_clusters))

3004 
	`åy_to_wrôeback_öodes_sb
(
sb
, 
WB_REASON_FS_FREE_SPACE
);

3006 i‡(2 * 
‰ì_˛u°îs
 < 3 * 
dúty_˛u°îs
 ||

3007 
‰ì_˛u°îs
 < (
dúty_˛u°îs
 + 
PXT4_FREECLUSTERS_WATERMARK
)) {

3015 
	}
}

3018 
	$pxt4_da_wrôe_¸edôs
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
)

3020 i‡(
	`likñy
(
	`pxt4_has_„©uª_œrge_fûe
(
öode
->
i_sb
)))

3023 i‡(
pos
 + 
Àn
 <= 0x7fffffffULL)

3028 
	}
}

3030 
	$pxt4_da_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3031 
loff_t
 
pos
, 
Àn
, 
Êags
,

3032 
∑ge
 **
∑gï
, **
fsd©a
)

3034 
ªt
, 
ªåõs
 = 0;

3035 
∑ge
 *page;

3036 
pgoff_t
 
ödex
;

3037 
öode
 *öodê
m≠pög
->
ho°
;

3038 
h™dÀ_t
 *
h™dÀ
;

3040 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

3041  -
EIO
;

3043 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

3045 i‡(
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
Ë|| 
	`S_ISLNK
(öode->
i_mode
) ||

3046 
	`pxt4_vîôy_ö_¥ogªss
(
öode
)) {

3047 *
fsd©a
 = (*)
FALL_BACK_TO_NONDELALLOC
;

3048  
	`pxt4_wrôe_begö
(
fûe
, 
m≠pög
, 
pos
,

3049 
Àn
, 
Êags
, 
∑gï
, 
fsd©a
);

3051 *
fsd©a
 = (*)0;

3052 
	`åa˚_pxt4_da_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

3054 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

3055 
ªt
 = 
	`pxt4_da_wrôe_ölöe_d©a_begö
(
m≠pög
, 
öode
,

3056 
pos
, 
Àn
, 
Êags
,

3057 
∑gï
, 
fsd©a
);

3058 i‡(
ªt
 < 0)

3059  
ªt
;

3060 i‡(
ªt
 == 1)

3071 
ªåy_gøb
:

3072 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

3073 i‡(!
∑ge
)

3074  -
ENOMEM
;

3075 
	`u∆ock_∑ge
(
∑ge
);

3083 
ªåy_jou∫Æ
:

3084 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

3085 
	`pxt4_da_wrôe_¸edôs
(
öode
, 
pos
, 
Àn
));

3086 i‡(
	`IS_ERR
(
h™dÀ
)) {

3087 
	`put_∑ge
(
∑ge
);

3088  
	`PTR_ERR
(
h™dÀ
);

3091 
	`lock_∑ge
(
∑ge
);

3092 i‡(
∑ge
->
m≠pög
 != mapping) {

3094 
	`u∆ock_∑ge
(
∑ge
);

3095 
	`put_∑ge
(
∑ge
);

3096 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3097 
ªåy_gøb
;

3100 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

3102 #ifde‡
CONFIG_FS_ENCRYPTION


3103 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

3104 
pxt4_da_gë_block_¥ï
);

3106 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_da_gë_block_¥ï
);

3108 i‡(
ªt
 < 0) {

3109 
	`u∆ock_∑ge
(
∑ge
);

3110 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3116 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
)

3117 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3119 i‡(
ªt
 =-
ENOSPC
 &&

3120 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3121 
ªåy_jou∫Æ
;

3123 
	`put_∑ge
(
∑ge
);

3124  
ªt
;

3127 *
∑gï
 = 
∑ge
;

3128  
ªt
;

3129 
	}
}

3135 
	$pxt4_da_should_upd©e_i_disksize
(
∑ge
 *page,

3136 
off£t
)

3138 
buf„r_hód
 *
bh
;

3139 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3140 
idx
;

3141 
i
;

3143 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

3144 
idx
 = 
off£t
 >> 
öode
->
i_blkbôs
;

3146 
i
 = 0; i < 
idx
; i++)

3147 
bh
 = bh->
b_this_∑ge
;

3149 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| (
	`buf„r_dñay
(bh)Ë|| 
	`buf„r_unwrôãn
(bh))

3152 
	}
}

3154 
	$pxt4_da_wrôe_íd
(
fûe
 *file,

3155 
addªss_•a˚
 *
m≠pög
,

3156 
loff_t
 
pos
, 
Àn
, 
c›õd
,

3157 
∑ge
 *∑ge, *
fsd©a
)

3159 
öode
 *öodê
m≠pög
->
ho°
;

3160 
ªt
 = 0, 
ªt2
;

3161 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3162 
loff_t
 
√w_i_size
;

3163 
°¨t
, 
íd
;

3164 
wrôe_mode
 = ()()
fsd©a
;

3166 i‡(
wrôe_mode
 =
FALL_BACK_TO_NONDELALLOC
)

3167  
	`pxt4_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

3168 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

3170 
	`åa˚_pxt4_da_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

3171 
°¨t
 = 
pos
 & (
PAGE_SIZE
 - 1);

3172 
íd
 = 
°¨t
 + 
c›õd
 - 1;

3179 
√w_i_size
 = 
pos
 + 
c›õd
;

3180 i‡(
c›õd
 && 
√w_i_size
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3181 i‡(
	`pxt4_has_ölöe_d©a
(
öode
) ||

3182 
	`pxt4_da_should_upd©e_i_disksize
(
∑ge
, 
íd
)) {

3183 
	`pxt4_upd©e_i_disksize
(
öode
, 
√w_i_size
);

3188 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3192 i‡(
wrôe_mode
 !
CONVERT_INLINE_DATA
 &&

3193 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
) &&

3194 
	`pxt4_has_ölöe_d©a
(
öode
))

3195 
ªt2
 = 
	`pxt4_da_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
,

3196 
∑ge
);

3198 
ªt2
 = 
	`gíîic_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
c›õd
,

3199 
∑ge
, 
fsd©a
);

3201 
c›õd
 = 
ªt2
;

3202 i‡(
ªt2
 < 0)

3203 
ªt
 = 
ªt2
;

3204 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3205 i‡(!
ªt
)

3206 
ªt
 = 
ªt2
;

3208  
ªt
 ?Ñë : 
c›õd
;

3209 
	}
}

3214 
	$pxt4_Æloc_da_blocks
(
öode
 *inode)

3216 
	`åa˚_pxt4_Æloc_da_blocks
(
öode
);

3218 i‡(!
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

3252  
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

3253 
	}
}

3269 
£˘‹_t
 
	$pxt4_bm≠
(
addªss_•a˚
 *
m≠pög
, 
£˘‹_t
 
block
)

3271 
öode
 *öodê
m≠pög
->
ho°
;

3272 
jou∫Æ_t
 *
jou∫Æ
;

3273 
îr
;

3278 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3281 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
) &&

3282 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
)) {

3288 
	`fûem≠_wrôe_™d_waô
(
m≠pög
);

3291 i‡(
	`PXT4_JOURNAL
(
öode
) &&

3292 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
)) {

3311 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

3312 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

3313 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

3314 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

3315 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

3317 i‡(
îr
)

3321  
	`gíîic_block_bm≠
(
m≠pög
, 
block
, 
pxt4_gë_block
);

3322 
	}
}

3324 
	$pxt4_ªad∑ge
(
fûe
 *fûe, 
∑ge
 *page)

3326 
ªt
 = -
EAGAIN
;

3327 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3329 
	`åa˚_pxt4_ªad∑ge
(
∑ge
);

3331 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3332 
ªt
 = 
	`pxt4_ªad∑ge_ölöe
(
öode
, 
∑ge
);

3334 i‡(
ªt
 =-
EAGAIN
)

3335  
	`pxt4_m∑ge_ªad∑ges
(
∑ge
->
m≠pög
, 
NULL
,Öage, 1,

3336 
Ál£
);

3338  
ªt
;

3339 
	}
}

3342 
	$pxt4_ªad∑ges
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3343 
li°_hód
 *
∑ges
, 
ƒ_∑ges
)

3345 
öode
 *öodê
m≠pög
->
ho°
;

3348 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3351  
	`pxt4_m∑ge_ªad∑ges
(
m≠pög
, 
∑ges
, 
NULL
, 
ƒ_∑ges
, 
åue
);

3352 
	}
}

3354 
	$pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

3355 
Àngth
)

3357 
	`åa˚_pxt4_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3360 
	`WARN_ON
(
	`∑ge_has_buf„rs
(
∑ge
Ë&& 
	`buf„r_jbd
(
	`∑ge_buf„rs
(page)));

3362 
	`block_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3363 
	}
}

3365 
	$__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3366 
off£t
,

3367 
Àngth
)

3369 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3371 
	`åa˚_pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3376 i‡(
off£t
 =0 && 
Àngth
 =
PAGE_SIZE
)

3377 
	`CÀ¨PageChecked
(
∑ge
);

3379  
	`jbd3_jou∫Æ_övÆid©ïage
(
jou∫Æ
, 
∑ge
, 
off£t
, 
Àngth
);

3380 
	}
}

3383 
	$pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3384 
off£t
,

3385 
Àngth
)

3387 
	`WARN_ON
(
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
) < 0);

3388 
	}
}

3390 
	$pxt4_ªÀa£∑ge
(
∑ge
 *∑ge, 
gÂ_t
 
waô
)

3392 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3394 
	`åa˚_pxt4_ªÀa£∑ge
(
∑ge
);

3397 i‡(
	`PageChecked
(
∑ge
))

3399 i‡(
jou∫Æ
)

3400  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
, 
waô
);

3402  
	`åy_to_‰ì_buf„rs
(
∑ge
);

3403 
	}
}

3405 
boﬁ
 
	$pxt4_öode_d©async_dúty
(
öode
 *inode)

3407 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

3409 i‡(
jou∫Æ
)

3410  !
	`jbd3_å™ß˘i⁄_commôãd
(
jou∫Æ
,

3411 
	`PXT4_I
(
öode
)->
i_d©async_tid
);

3413 i‡(!
	`li°_em±y
(&
öode
->
i_m≠pög
->
¥iv©e_li°
))

3414  
åue
;

3415  
öode
->
i_°©e
 & 
I_DIRTY_DATASYNC
;

3416 
	}
}

3418 
	$pxt4_iom≠_begö
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3419 
Êags
, 
iom≠
 *iomap)

3421 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3422 
blkbôs
 = 
öode
->
i_blkbôs
;

3423 
fú°_block
, 
œ°_block
;

3424 
pxt4_m≠_blocks
 
m≠
;

3425 
boﬁ
 
dñÆloc
 = 
Ál£
;

3426 
ªt
;

3428 i‡((
off£t
 >> 
blkbôs
Ë> 
PXT4_MAX_LOGICAL_BLOCK
)

3429  -
EINVAL
;

3430 
fú°_block
 = 
off£t
 >> 
blkbôs
;

3431 
œ°_block
 = 
	`mö_t
(
loff_t
, (
off£t
 + 
Àngth
 - 1Ë>> 
blkbôs
,

3432 
PXT4_MAX_LOGICAL_BLOCK
);

3434 i‡(
Êags
 & 
IOMAP_REPORT
) {

3435 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

3436 
ªt
 = 
	`pxt4_ölöe_d©a_iom≠
(
öode
, 
iom≠
);

3437 i‡(
ªt
 !-
EAGAIN
) {

3438 i‡(
ªt
 =0 && 
off£t
 >
iom≠
->
Àngth
)

3439 
ªt
 = -
ENOENT
;

3440  
ªt
;

3444 i‡(
	`WARN_ON_ONCE
(
	`pxt4_has_ölöe_d©a
(
öode
)))

3445  -
ERANGE
;

3448 
m≠
.
m_lblk
 = 
fú°_block
;

3449 
m≠
.
m_Àn
 = 
œ°_block
 - 
fú°_block
 + 1;

3451 i‡(
Êags
 & 
IOMAP_REPORT
) {

3452 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3453 i‡(
ªt
 < 0)

3454  
ªt
;

3456 i‡(
ªt
 == 0) {

3457 
pxt4_lblk_t
 
íd
 = 
m≠
.
m_lblk
 + m≠.
m_Àn
 - 1;

3458 
exã¡_°©us
 
es
;

3460 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

3461 
m≠
.
m_lblk
, 
íd
, &
es
);

3463 i‡(!
es
.
es_Àn
 ||És.
es_lblk
 > 
íd
) {

3465 } i‡(
es
.
es_lblk
 > 
m≠
.
m_lblk
) {

3467 
m≠
.
m_Àn
 = 
es
.
es_lblk
 - m≠.
m_lblk
;

3469 
pxt4_lblk_t
 
offs
 = 0;

3471 i‡(
es
.
es_lblk
 < 
m≠
.
m_lblk
)

3472 
offs
 = 
m≠
.
m_lblk
 - 
es
.
es_lblk
;

3473 
m≠
.
m_lblk
 = 
es
.
es_lblk
 + 
offs
;

3474 
m≠
.
m_Àn
 = 
es
.
es_Àn
 - 
offs
;

3475 
dñÆloc
 = 
åue
;

3478 } i‡(
Êags
 & 
IOMAP_WRITE
) {

3479 
dio_¸edôs
;

3480 
h™dÀ_t
 *
h™dÀ
;

3481 
ªåõs
 = 0;

3484 i‡(
m≠
.
m_Àn
 > 
DIO_MAX_BLOCKS
)

3485 
m≠
.
m_Àn
 = 
DIO_MAX_BLOCKS
;

3486 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
m≠
.
m_Àn
);

3487 
ªåy
:

3494 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

3495 
dio_¸edôs
);

3496 i‡(
	`IS_ERR
(
h™dÀ
))

3497  
	`PTR_ERR
(
h™dÀ
);

3499 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

3500 
PXT4_GET_BLOCKS_CREATE_ZERO
);

3501 i‡(
ªt
 < 0) {

3502 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3503 i‡(
ªt
 =-
ENOSPC
 &&

3504 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3505 
ªåy
;

3506  
ªt
;

3518 i‡(!(
Êags
 & 
IOMAP_FAULT
Ë&& 
fú°_block
 + 
m≠
.
m_Àn
 >

3519 (
	`i_size_ªad
(
öode
Ë+ (1 << 
blkbôs
) - 1) >> blkbits) {

3520 
îr
;

3522 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3523 i‡(
îr
 < 0) {

3524 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3525  
îr
;

3528 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3530 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3531 i‡(
ªt
 < 0)

3532  
ªt
;

3540 
iom≠
->
Êags
 = 0;

3541 i‡(
	`pxt4_öode_d©async_dúty
(
öode
) ||

3542 
off£t
 + 
Àngth
 > 
	`i_size_ªad
(
öode
))

3543 
iom≠
->
Êags
 |
IOMAP_F_DIRTY
;

3544 
iom≠
->
bdev
 = 
öode
->
i_sb
->
s_bdev
;

3545 
iom≠
->
dax_dev
 = 
sbi
->
s_daxdev
;

3546 
iom≠
->
off£t
 = (
u64
)
fú°_block
 << 
blkbôs
;

3547 
iom≠
->
Àngth
 = (
u64
)
m≠
.
m_Àn
 << 
blkbôs
;

3549 i‡(
ªt
 == 0) {

3550 
iom≠
->
ty≥
 = 
dñÆloc
 ? 
IOMAP_DELALLOC
 : 
IOMAP_HOLE
;

3551 
iom≠
->
addr
 = 
IOMAP_NULL_ADDR
;

3553 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) {

3554 
iom≠
->
ty≥
 = 
IOMAP_MAPPED
;

3555 } i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) {

3556 
iom≠
->
ty≥
 = 
IOMAP_UNWRITTEN
;

3558 
	`WARN_ON_ONCE
(1);

3559  -
EIO
;

3561 
iom≠
->
addr
 = (
u64
)
m≠
.
m_pblk
 << 
blkbôs
;

3564 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
)

3565 
iom≠
->
Êags
 |
IOMAP_F_NEW
;

3568 
	}
}

3570 
	$pxt4_iom≠_íd
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3571 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap)

3573 
ªt
 = 0;

3574 
h™dÀ_t
 *
h™dÀ
;

3575 
blkbôs
 = 
öode
->
i_blkbôs
;

3576 
boﬁ
 
åunˇã
 = 
Ál£
;

3578 i‡(!(
Êags
 & 
IOMAP_WRITE
Ë|| (Êag†& 
IOMAP_FAULT
))

3581 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3582 i‡(
	`IS_ERR
(
h™dÀ
)) {

3583 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3584 
‹ph™_dñ
;

3586 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
off£t
 + 
wrôãn
))

3587 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3591 i‡(
iom≠
->
off£t
 + iom≠->
Àngth
 >

3592 
	`ALIGN
(
öode
->
i_size
, 1 << 
blkbôs
)) {

3593 
pxt4_lblk_t
 
wrôãn_blk
, 
íd_blk
;

3595 
wrôãn_blk
 = (
off£t
 + 
wrôãn
Ë>> 
blkbôs
;

3596 
íd_blk
 = (
off£t
 + 
Àngth
Ë>> 
blkbôs
;

3597 i‡(
wrôãn_blk
 < 
íd_blk
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

3598 
åunˇã
 = 
åue
;

3604 i‡(!
åunˇã
 && 
öode
->
i_∆ök
 &&

3605 !
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

3606 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3607 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3608 i‡(
åunˇã
) {

3609 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3610 
‹ph™_dñ
:

3616 i‡(
öode
->
i_∆ök
)

3617 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3619  
ªt
;

3620 
	}
}

3622 c⁄° 
iom≠_›s
 
	gpxt4_iom≠_›s
 = {

3623 .
iom≠_begö
 = 
pxt4_iom≠_begö
,

3624 .
	giom≠_íd
 = 
pxt4_iom≠_íd
,

3627 
	$pxt4_íd_io_dio
(
kiocb
 *
iocb
, 
loff_t
 
off£t
,

3628 
ssize_t
 
size
, *
¥iv©e
)

3630 
pxt4_io_íd_t
 *
io_íd
 = 
¥iv©e
;

3633 i‡(!
io_íd
)

3636 
	`ext_debug
("pxt4_end_io_dio(): io_end 0x%p "

3638 
io_íd
, io_íd->
öode
->
i_öo
, 
iocb
, 
off£t
, 
size
);

3644 i‡(
size
 <= 0) {

3645 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

3646 
size
 = 0;

3648 
io_íd
->
off£t
 = offset;

3649 
io_íd
->
size
 = size;

3650 
	`pxt4_put_io_íd
(
io_íd
);

3653 
	}
}

3676 
ssize_t
 
	$pxt4_dúe˘_IO_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3678 
fûe
 *fûê
iocb
->
ki_fûp
;

3679 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3680 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3681 
ssize_t
 
ªt
;

3682 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3683 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3684 
ovîwrôe
 = 0;

3685 
gë_block_t
 *
gë_block_func
 = 
NULL
;

3686 
dio_Êags
 = 0;

3687 
loff_t
 
föÆ_size
 = 
off£t
 + 
cou¡
;

3688 
‹ph™
 = 0;

3689 
h™dÀ_t
 *
h™dÀ
;

3691 i‡(
föÆ_size
 > 
öode
->
i_size
 || föÆ_sizê> 
ei
->
i_disksize
) {

3693 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3694 i‡(
	`IS_ERR
(
h™dÀ
)) {

3695 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3696 
out
;

3698 
ªt
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3699 i‡(
ªt
) {

3700 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3701 
out
;

3703 
‹ph™
 = 1;

3704 
	`pxt4_upd©e_i_disksize
(
öode
, inode->
i_size
);

3705 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3708 
	`BUG_ON
(
iocb
->
¥iv©e
 =
NULL
);

3715 
	`öode_dio_begö
(
öode
);

3718 
ovîwrôe
 = *((*)
iocb
->
¥iv©e
);

3720 i‡(
ovîwrôe
)

3721 
	`öode_u∆ock
(
öode
);

3743 
iocb
->
¥iv©e
 = 
NULL
;

3744 i‡(
ovîwrôe
)

3745 
gë_block_func
 = 
pxt4_dio_gë_block_ovîwrôe
;

3746 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) ||

3747 
	`round_down
(
off£t
, 
	`i_blocksize
(
öode
)Ë>öode->
i_size
) {

3748 
gë_block_func
 = 
pxt4_dio_gë_block
;

3749 
dio_Êags
 = 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
;

3750 } i‡(
	`is_sync_kiocb
(
iocb
)) {

3751 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_sync
;

3752 
dio_Êags
 = 
DIO_LOCKING
;

3754 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_async
;

3755 
dio_Êags
 = 
DIO_LOCKING
;

3757 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
, 
ôî
,

3758 
gë_block_func
, 
pxt4_íd_io_dio
, 
NULL
,

3759 
dio_Êags
);

3761 i‡(
ªt
 > 0 && !
ovîwrôe
 && 
	`pxt4_ã°_öode_°©e
(
öode
,

3762 
PXT4_STATE_DIO_UNWRITTEN
)) {

3763 
îr
;

3768 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
NULL
, 
öode
,

3769 
off£t
, 
ªt
);

3770 i‡(
îr
 < 0)

3771 
ªt
 = 
îr
;

3772 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

3775 
	`öode_dio_íd
(
öode
);

3777 i‡(
ovîwrôe
)

3778 
	`öode_lock
(
öode
);

3780 i‡(
ªt
 < 0 && 
föÆ_size
 > 
öode
->
i_size
)

3781 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3784 i‡(
‹ph™
) {

3785 
îr
;

3788 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3789 i‡(
	`IS_ERR
(
h™dÀ
)) {

3800 i‡(!
ªt
)

3801 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3802 i‡(
öode
->
i_∆ök
)

3803 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3805 
out
;

3807 i‡(
öode
->
i_∆ök
)

3808 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3809 i‡(
ªt
 > 0) {

3810 
loff_t
 
íd
 = 
off£t
 + 
ªt
;

3811 i‡(
íd
 > 
öode
->
i_size
 ||Énd > 
ei
->
i_disksize
) {

3812 
	`pxt4_upd©e_i_disksize
(
öode
, 
íd
);

3813 i‡(
íd
 > 
öode
->
i_size
)

3814 
	`i_size_wrôe
(
öode
, 
íd
);

3822 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3825 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3826 i‡(
ªt
 == 0)

3827 
ªt
 = 
îr
;

3829 
out
:

3830  
ªt
;

3831 
	}
}

3833 
ssize_t
 
	$pxt4_dúe˘_IO_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3835 
addªss_•a˚
 *
m≠pög
 = 
iocb
->
ki_fûp
->
f_m≠pög
;

3836 
öode
 *öodê
m≠pög
->
ho°
;

3837 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3838 
ssize_t
 
ªt
;

3839 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3840 
loff_t
 
size
 = 
	`i_size_ªad
(
öode
);

3842 i‡(
off£t
 >
size
)

3850 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

3851 i‡(!
	`öode_åylock_sh¨ed
(
öode
))

3852  -
EAGAIN
;

3854 
	`öode_lock_sh¨ed
(
öode
);

3857 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
iocb
->
ki_pos
,

3858 
iocb
->
ki_pos
 + 
cou¡
 - 1);

3859 i‡(
ªt
)

3860 
out_u∆ock
;

3861 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
,

3862 
ôî
, 
pxt4_dio_gë_block
, 
NULL
, NULL, 0);

3863 
out_u∆ock
:

3864 
	`öode_u∆ock_sh¨ed
(
öode
);

3865  
ªt
;

3866 
	}
}

3868 
ssize_t
 
	$pxt4_dúe˘_IO
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3870 
fûe
 *fûê
iocb
->
ki_fûp
;

3871 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3872 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3873 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3874 
ssize_t
 
ªt
;

3876 #ifde‡
CONFIG_FS_ENCRYPTION


3877 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

3880 i‡(
	`fsvîôy_a˘ive
(
öode
))

3886 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

3890 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3893 
	`åa˚_pxt4_dúe˘_IO_íãr
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
));

3894 i‡(
	`iov_ôî_rw
(
ôî
Ë=
READ
)

3895 
ªt
 = 
	`pxt4_dúe˘_IO_ªad
(
iocb
, 
ôî
);

3897 
ªt
 = 
	`pxt4_dúe˘_IO_wrôe
(
iocb
, 
ôî
);

3898 
	`åa˚_pxt4_dúe˘_IO_exô
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
), 
ªt
);

3899  
ªt
;

3900 
	}
}

3915 
	$pxt4_jou∫ÆÀd_£t_∑ge_dúty
(
∑ge
 *page)

3917 
	`SëPageChecked
(
∑ge
);

3918  
	`__£t_∑ge_dúty_nobuf„rs
(
∑ge
);

3919 
	}
}

3921 
	$pxt4_£t_∑ge_dúty
(
∑ge
 *page)

3923 
	`WARN_ON_ONCE
(!
	`PageLocked
(
∑ge
Ë&& !
	`PageDúty
(page));

3924 
	`WARN_ON_ONCE
(!
	`∑ge_has_buf„rs
(
∑ge
));

3925  
	`__£t_∑ge_dúty_buf„rs
(
∑ge
);

3926 
	}
}

3928 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_a›s
 = {

3929 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3930 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3931 .
	gwrôïage
 = 
pxt4_wrôïage
,

3932 .
	gwrôïages
 = 
pxt4_wrôïages
,

3933 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3934 .
	gwrôe_íd
 = 
pxt4_wrôe_íd
,

3935 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3936 .
	gbm≠
 = 
pxt4_bm≠
,

3937 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3938 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3939 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3940 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3941 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3942 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3945 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_jou∫ÆÀd_a›s
 = {

3946 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3947 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3948 .
	gwrôïage
 = 
pxt4_wrôïage
,

3949 .
	gwrôïages
 = 
pxt4_wrôïages
,

3950 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3951 .
	gwrôe_íd
 = 
pxt4_jou∫ÆÀd_wrôe_íd
,

3952 .
	g£t_∑ge_dúty
 = 
pxt4_jou∫ÆÀd_£t_∑ge_dúty
,

3953 .
	gbm≠
 = 
pxt4_bm≠
,

3954 .
	gövÆid©ïage
 = 
pxt4_jou∫ÆÀd_övÆid©ïage
,

3955 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3956 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3957 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3958 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3961 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_da_a›s
 = {

3962 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3963 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3964 .
	gwrôïage
 = 
pxt4_wrôïage
,

3965 .
	gwrôïages
 = 
pxt4_wrôïages
,

3966 .
	gwrôe_begö
 = 
pxt4_da_wrôe_begö
,

3967 .
	gwrôe_íd
 = 
pxt4_da_wrôe_íd
,

3968 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3969 .
	gbm≠
 = 
pxt4_bm≠
,

3970 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3971 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3972 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3973 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3974 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3975 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3978 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_dax_a›s
 = {

3979 .
wrôïages
 = 
pxt4_dax_wrôïages
,

3980 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3981 .
	g£t_∑ge_dúty
 = 
no›_£t_∑ge_dúty
,

3982 .
	gbm≠
 = 
pxt4_bm≠
,

3983 .
	gövÆid©ïage
 = 
no›_övÆid©ïage
,

3986 
	$pxt4_£t_a›s
(
öode
 *inode)

3988 
	`pxt4_öode_jou∫Æ_mode
(
öode
)) {

3989 
PXT4_INODE_ORDERED_DATA_MODE
:

3990 
PXT4_INODE_WRITEBACK_DATA_MODE
:

3992 
PXT4_INODE_JOURNAL_DATA_MODE
:

3993 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_jou∫ÆÀd_a›s
;

3996 
	`BUG
();

3998 i‡(
	`IS_DAX
(
öode
))

3999 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_dax_a›s
;

4000 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

4001 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_da_a›s
;

4003 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_a›s
;

4004 
	}
}

4006 
	$__pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

4007 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

4009 
pxt4_fsblk_t
 
ödex
 = 
‰om
 >> 
PAGE_SHIFT
;

4010 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4011 
blocksize
, 
pos
;

4012 
pxt4_lblk_t
 
iblock
;

4013 
öode
 *öodê
m≠pög
->
ho°
;

4014 
buf„r_hód
 *
bh
;

4015 
∑ge
 *page;

4016 
îr
 = 0;

4018 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
‰om
 >> 
PAGE_SHIFT
,

4019 
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
, ~
__GFP_FS
));

4020 i‡(!
∑ge
)

4021  -
ENOMEM
;

4023 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4025 
iblock
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_sb
->
s_blocksize_bôs
);

4027 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

4028 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

4031 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

4032 
pos
 = 
blocksize
;

4033 
off£t
 >
pos
) {

4034 
bh
 = bh->
b_this_∑ge
;

4035 
iblock
++;

4036 
pos
 +
blocksize
;

4038 i‡(
	`buf„r_‰ìd
(
bh
)) {

4039 
	`BUFFER_TRACE
(
bh
, "freed: skip");

4040 
u∆ock
;

4042 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4043 
	`BUFFER_TRACE
(
bh
, "unmapped");

4044 
	`pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

4046 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4047 
	`BUFFER_TRACE
(
bh
, "still unmapped");

4048 
u∆ock
;

4053 i‡(
	`PageU±od©e
(
∑ge
))

4054 
	`£t_buf„r_u±od©e
(
bh
);

4056 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4057 
îr
 = -
EIO
;

4058 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

4059 
	`waô_⁄_buf„r
(
bh
);

4061 i‡(!
	`buf„r_u±od©e
(
bh
))

4062 
u∆ock
;

4063 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode)) {

4065 
	`BUG_ON
(!
	`fs¸y±_has_í¸y±i⁄_key
(
öode
));

4066 
	`WARN_ON_ONCE
(
	`fs¸y±_de¸y±_∑geˇche_blocks
(

4067 
∑ge
, 
blocksize
, 
	`bh_off£t
(
bh
)));

4070 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4071 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

4072 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

4073 i‡(
îr
)

4074 
u∆ock
;

4076 
	`zîo_u£r
(
∑ge
, 
off£t
, 
Àngth
);

4077 
	`BUFFER_TRACE
(
bh
, "zeroedÉnd of block");

4079 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4080 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

4082 
îr
 = 0;

4083 
	`m¨k_buf„r_dúty
(
bh
);

4084 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

4085 
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
, 
‰om
,

4086 
Àngth
);

4089 
u∆ock
:

4090 
	`u∆ock_∑ge
(
∑ge
);

4091 
	`put_∑ge
(
∑ge
);

4092  
îr
;

4093 
	}
}

4102 
	$pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

4103 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

4105 
öode
 *öodê
m≠pög
->
ho°
;

4106 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4107 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4108 
max
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4114 i‡(
Àngth
 > 
max
 ||Üength < 0)

4115 
Àngth
 = 
max
;

4117 i‡(
	`IS_DAX
(
öode
)) {

4118  
	`iom≠_zîo_ønge
(
öode
, 
‰om
, 
Àngth
, 
NULL
,

4119 &
pxt4_iom≠_›s
);

4121  
	`__pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4122 
	}
}

4130 
	$pxt4_block_åunˇã_∑ge
(
h™dÀ_t
 *
h™dÀ
,

4131 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
)

4133 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4134 
Àngth
;

4135 
blocksize
;

4136 
öode
 *öodê
m≠pög
->
ho°
;

4139 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& !
	`fs¸y±_has_í¸y±i⁄_key
(inode))

4142 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4143 
Àngth
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4145  
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4146 
	}
}

4148 
	$pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4149 
loff_t
 
l°¨t
,Üoff_à
Àngth
)

4151 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4152 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4153 
∑πül_°¨t
, 
∑πül_íd
;

4154 
pxt4_fsblk_t
 
°¨t
, 
íd
;

4155 
loff_t
 
byã_íd
 = (
l°¨t
 + 
Àngth
 - 1);

4156 
îr
 = 0;

4158 
∑πül_°¨t
 = 
l°¨t
 & (
sb
->
s_blocksize
 - 1);

4159 
∑πül_íd
 = 
byã_íd
 & (
sb
->
s_blocksize
 - 1);

4161 
°¨t
 = 
l°¨t
 >> 
sb
->
s_blocksize_bôs
;

4162 
íd
 = 
byã_íd
 >> 
sb
->
s_blocksize_bôs
;

4165 i‡(
°¨t
 =
íd
 &&

4166 (
∑πül_°¨t
 || (
∑πül_íd
 !
sb
->
s_blocksize
 - 1))) {

4167 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4168 
l°¨t
, 
Àngth
);

4169  
îr
;

4172 i‡(
∑πül_°¨t
) {

4173 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4174 
l°¨t
, 
sb
->
s_blocksize
);

4175 i‡(
îr
)

4176  
îr
;

4179 i‡(
∑πül_íd
 !
sb
->
s_blocksize
 - 1)

4180 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4181 
byã_íd
 - 
∑πül_íd
,

4182 
∑πül_íd
 + 1);

4183  
îr
;

4184 
	}
}

4186 
	$pxt4_ˇn_åunˇã
(
öode
 *inode)

4188 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4190 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

4192 i‡(
	`S_ISLNK
(
öode
->
i_mode
))

4193  !
	`pxt4_öode_is_Á°_symlök
(
öode
);

4195 
	}
}

4203 
	$pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

4204 
loff_t
 
Àn
)

4206 
h™dÀ_t
 *
h™dÀ
;

4207 
loff_t
 
size
 = 
	`i_size_ªad
(
öode
);

4209 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4210 i‡(
off£t
 > 
size
 || off£à+ 
Àn
 < size)

4213 i‡(
	`PXT4_I
(
öode
)->
i_disksize
 >
size
)

4216 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 1);

4217 i‡(
	`IS_ERR
(
h™dÀ
))

4218  
	`PTR_ERR
(
h™dÀ
);

4219 
	`pxt4_upd©e_i_disksize
(
öode
, 
size
);

4220 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4221 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4224 
	}
}

4226 
	$pxt4_waô_dax_∑ge
(
pxt4_öode_öfo
 *
ei
)

4228 
	`up_wrôe
(&
ei
->
i_mm≠_£m
);

4229 
	`scheduÀ
();

4230 
	`down_wrôe
(&
ei
->
i_mm≠_£m
);

4231 
	}
}

4233 
	$pxt4_bªak_œyouts
(
öode
 *inode)

4235 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4236 
∑ge
 *page;

4237 
îr‹
;

4239 i‡(
	`WARN_ON_ONCE
(!
	`rw£m_is_locked
(&
ei
->
i_mm≠_£m
)))

4240  -
EINVAL
;

4243 
∑ge
 = 
	`dax_œyout_busy_∑ge
(
öode
->
i_m≠pög
);

4244 i‡(!
∑ge
)

4247 
îr‹
 = 
	`___waô_v¨_evít
(&
∑ge
->
_ªfcou¡
,

4248 
	`©omic_ªad
(&
∑ge
->
_ªfcou¡
) == 1,

4249 
TASK_INTERRUPTIBLE
, 0, 0,

4250 
	`pxt4_waô_dax_∑ge
(
ei
));

4251 } 
îr‹
 == 0);

4253  
îr‹
;

4254 
	}
}

4267 
	$pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
)

4269 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4270 
pxt4_lblk_t
 
fú°_block
, 
°›_block
;

4271 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4272 
loff_t
 
fú°_block_off£t
, 
œ°_block_off£t
;

4273 
h™dÀ_t
 *
h™dÀ
;

4274 
¸edôs
;

4275 
ªt
 = 0;

4277 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4278  -
EOPNOTSUPP
;

4280 
	`åa˚_pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àngth
, 0);

4282 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

4283 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4284 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4285 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4286 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4287 i‡(
ªt
)

4288  
ªt
;

4295 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
)) {

4296 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
off£t
,

4297 
off£t
 + 
Àngth
 - 1);

4298 i‡(
ªt
)

4299  
ªt
;

4302 
	`öode_lock
(
öode
);

4305 i‡(
off£t
 >
öode
->
i_size
)

4306 
out_muãx
;

4312 i‡(
off£t
 + 
Àngth
 > 
öode
->
i_size
) {

4313 
Àngth
 = 
öode
->
i_size
 +

4314 
PAGE_SIZE
 - (
öode
->
i_size
 & (PAGE_SIZE - 1)) -

4315 
off£t
;

4318 i‡(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

4319 (
off£t
 + 
Àngth
Ë& (
sb
->
s_blocksize
 - 1)) {

4324 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

4325 i‡(
ªt
 < 0)

4326 
out_muãx
;

4331 
	`öode_dio_waô
(
öode
);

4337 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4339 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4340 i‡(
ªt
)

4341 
out_dio
;

4343 
fú°_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

4344 
œ°_block_off£t
 = 
	`round_down
((
off£t
 + 
Àngth
), 
sb
->
s_blocksize
) - 1;

4347 i‡(
œ°_block_off£t
 > 
fú°_block_off£t
) {

4348 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àngth
);

4349 i‡(
ªt
)

4350 
out_dio
;

4351 
	`åunˇã_∑geˇche_ønge
(
öode
, 
fú°_block_off£t
,

4352 
œ°_block_off£t
);

4355 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4356 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4358 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4359 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4360 i‡(
	`IS_ERR
(
h™dÀ
)) {

4361 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4362 
	`pxt4_°d_îr‹
(
sb
, 
ªt
);

4363 
out_dio
;

4366 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
,

4367 
Àngth
);

4368 i‡(
ªt
)

4369 
out_°›
;

4371 
fú°_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4372 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4373 
°›_block
 = (
off£t
 + 
Àngth
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4376 i‡(
°›_block
 > 
fú°_block
) {

4378 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4379 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4381 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
fú°_block
,

4382 
°›_block
 - 
fú°_block
);

4383 i‡(
ªt
) {

4384 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4385 
out_°›
;

4388 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4389 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
fú°_block
,

4390 
°›_block
 - 1);

4392 
ªt
 = 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ
, 
öode
, 
fú°_block
,

4393 
°›_block
);

4395 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4397 i‡(
	`IS_SYNC
(
öode
))

4398 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4400 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4401 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4402 i‡(
ªt
 >= 0)

4403 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4404 
out_°›
:

4405 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4406 
out_dio
:

4407 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4408 
out_muãx
:

4409 
	`öode_u∆ock
(
öode
);

4410  
ªt
;

4411 
	}
}

4413 
	$pxt4_öode_©èch_jöode
(
öode
 *inode)

4415 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4416 
jbd3_öode
 *
jöode
;

4418 i‡(
ei
->
jöode
 || !
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

4421 
jöode
 = 
	`jbd3_Æloc_öode
(
GFP_KERNEL
);

4422 
	`•ö_lock
(&
öode
->
i_lock
);

4423 i‡(!
ei
->
jöode
) {

4424 i‡(!
jöode
) {

4425 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4426  -
ENOMEM
;

4428 
ei
->
jöode
 = jinode;

4429 
	`jbd3_jou∫Æ_öô_jbd_öode
(
ei
->
jöode
, 
öode
);

4430 
jöode
 = 
NULL
;

4432 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4433 i‡(
	`u∆ikñy
(
jöode
 !
NULL
))

4434 
	`jbd3_‰ì_öode
(
jöode
);

4436 
	}
}

4466 
	$pxt4_åunˇã
(
öode
 *inode)

4468 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4469 
¸edôs
;

4470 
îr
 = 0;

4471 
h™dÀ_t
 *
h™dÀ
;

4472 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4479 i‡(!(
öode
->
i_°©e
 & (
I_NEW
|
I_FREEING
)))

4480 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4481 
	`åa˚_pxt4_åunˇã_íãr
(
öode
);

4483 i‡(!
	`pxt4_ˇn_åunˇã
(
öode
))

4486 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4488 i‡(
öode
->
i_size
 =0 && !
	`ã°_›t
(öode->
i_sb
, 
NO_AUTO_DA_ALLOC
))

4489 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

4491 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4492 
has_ölöe
 = 1;

4494 
îr
 = 
	`pxt4_ölöe_d©a_åunˇã
(
öode
, &
has_ölöe
);

4495 i‡(
îr
)

4496  
îr
;

4497 i‡(
has_ölöe
)

4502 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1)) {

4503 i‡(
	`pxt4_öode_©èch_jöode
(
öode
) < 0)

4507 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4508 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4510 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4512 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4513 i‡(
	`IS_ERR
(
h™dÀ
))

4514  
	`PTR_ERR
(
h™dÀ
);

4516 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1))

4517 
	`pxt4_block_åunˇã_∑ge
(
h™dÀ
, 
m≠pög
, 
öode
->
i_size
);

4528 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

4529 i‡(
îr
)

4530 
out_°›
;

4532 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4534 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4536 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4537 
îr
 = 
	`pxt4_ext_åunˇã
(
h™dÀ
, 
öode
);

4539 
	`pxt4_öd_åunˇã
(
h™dÀ
, 
öode
);

4541 
	`up_wrôe
(&
ei
->
i_d©a_£m
);

4542 i‡(
îr
)

4543 
out_°›
;

4545 i‡(
	`IS_SYNC
(
öode
))

4546 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4548 
out_°›
:

4556 i‡(
öode
->
i_∆ök
)

4557 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

4559 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4560 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4561 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4563 
	`åa˚_pxt4_åunˇã_exô
(
öode
);

4564  
îr
;

4565 
	}
}

4573 
	$__pxt4_gë_öode_loc
(
öode
 *inode,

4574 
pxt4_ûoc
 *
ûoc
, 
ö_mem
)

4576 
pxt4_group_desc
 *
gdp
;

4577 
buf„r_hód
 *
bh
;

4578 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4579 
pxt4_fsblk_t
 
block
;

4580 
blk_∂ug
 
∂ug
;

4581 
öodes_≥r_block
, 
öode_off£t
;

4583 
ûoc
->
bh
 = 
NULL
;

4584 i‡(
öode
->
i_öo
 < 
PXT4_ROOT_INO
 ||

4585 
öode
->
i_öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))

4586  -
EFSCORRUPTED
;

4588 
ûoc
->
block_group
 = (
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

4589 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ûoc
->
block_group
, 
NULL
);

4590 i‡(!
gdp
)

4591  -
EIO
;

4596 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

4597 
öode_off£t
 = ((
öode
->
i_öo
 - 1) %

4598 
	`PXT4_INODES_PER_GROUP
(
sb
));

4599 
block
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ (
öode_off£t
 / 
öodes_≥r_block
);

4600 
ûoc
->
off£t
 = (
öode_off£t
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

4602 
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

4603 i‡(
	`u∆ikñy
(!
bh
))

4604  -
ENOMEM
;

4605 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4606 
	`lock_buf„r
(
bh
);

4614 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
Ë&& !
	`buf„r_u±od©e
(bh))

4615 
	`£t_buf„r_u±od©e
(
bh
);

4617 i‡(
	`buf„r_u±od©e
(
bh
)) {

4619 
	`u∆ock_buf„r
(
bh
);

4620 
has_buf„r
;

4628 i‡(
ö_mem
) {

4629 
buf„r_hód
 *
bôm≠_bh
;

4630 
i
, 
°¨t
;

4632 
°¨t
 = 
öode_off£t
 & ~(
öodes_≥r_block
 - 1);

4635 
bôm≠_bh
 = 
	`sb_gëblk
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
));

4636 i‡(
	`u∆ikñy
(!
bôm≠_bh
))

4637 
make_io
;

4644 i‡(!
	`buf„r_u±od©e
(
bôm≠_bh
)) {

4645 
	`bªl£
(
bôm≠_bh
);

4646 
make_io
;

4648 
i
 = 
°¨t
; i < sèπ + 
öodes_≥r_block
; i++) {

4649 i‡(
i
 =
öode_off£t
)

4651 i‡(
	`pxt4_ã°_bô
(
i
, 
bôm≠_bh
->
b_d©a
))

4654 
	`bªl£
(
bôm≠_bh
);

4655 i‡(
i
 =
°¨t
 + 
öodes_≥r_block
) {

4657 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

4658 
	`£t_buf„r_u±od©e
(
bh
);

4659 
	`u∆ock_buf„r
(
bh
);

4660 
has_buf„r
;

4664 
make_io
:

4669 
	`blk_°¨t_∂ug
(&
∂ug
);

4670 i‡(
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
) {

4671 
pxt4_fsblk_t
 
b
, 
íd
, 
èbÀ
;

4672 
num
;

4673 
__u32
 
ø_blks
 = 
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
;

4675 
èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

4677 
b
 = 
block
 & ~((
pxt4_fsblk_t
Ë
ø_blks
 - 1);

4678 i‡(
èbÀ
 > 
b
)

4679 
b
 = 
èbÀ
;

4680 
íd
 = 
b
 + 
ø_blks
;

4681 
num
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

4682 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

4683 
num
 -
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

4684 
èbÀ
 +
num
 / 
öodes_≥r_block
;

4685 i‡(
íd
 > 
èbÀ
)

4686 
íd
 = 
èbÀ
;

4687 
b
 <
íd
)

4688 
	`sb_bªadahód_unmovabÀ
(
sb
, 
b
++);

4696 
	`åa˚_pxt4_lﬂd_öode
(
öode
);

4697 
	`gë_bh
(
bh
);

4698 
bh
->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

4699 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

4700 
	`blk_föish_∂ug
(&
∂ug
);

4701 
	`waô_⁄_buf„r
(
bh
);

4702 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4703 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
,

4705 
	`bªl£
(
bh
);

4706  -
EIO
;

4709 
has_buf„r
:

4710 
ûoc
->
bh
 = bh;

4712 
	}
}

4714 
	$pxt4_gë_öode_loc
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

4717  
	`__pxt4_gë_öode_loc
(
öode
, 
ûoc
,

4718 !
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
));

4719 
	}
}

4721 
boﬁ
 
	$pxt4_should_u£_dax
(
öode
 *inode)

4723 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DAX
))

4724  
Ál£
;

4725 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4726  
Ál£
;

4727 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4728  
Ál£
;

4729 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

4730  
Ál£
;

4731 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
))

4732  
Ál£
;

4733 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
))

4734  
Ál£
;

4735  
åue
;

4736 
	}
}

4738 
	$pxt4_£t_öode_Êags
(
öode
 *inode)

4740 
Êags
 = 
	`PXT4_I
(
öode
)->
i_Êags
;

4741 
√w_Ê
 = 0;

4743 i‡(
Êags
 & 
PXT4_SYNC_FL
)

4744 
√w_Ê
 |
S_SYNC
;

4745 i‡(
Êags
 & 
PXT4_APPEND_FL
)

4746 
√w_Ê
 |
S_APPEND
;

4747 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

4748 
√w_Ê
 |
S_IMMUTABLE
;

4749 i‡(
Êags
 & 
PXT4_NOATIME_FL
)

4750 
√w_Ê
 |
S_NOATIME
;

4751 i‡(
Êags
 & 
PXT4_DIRSYNC_FL
)

4752 
√w_Ê
 |
S_DIRSYNC
;

4753 i‡(
	`pxt4_should_u£_dax
(
öode
))

4754 
√w_Ê
 |
S_DAX
;

4755 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

4756 
√w_Ê
 |
S_ENCRYPTED
;

4757 i‡(
Êags
 & 
PXT4_CASEFOLD_FL
)

4758 
√w_Ê
 |
S_CASEFOLD
;

4759 i‡(
Êags
 & 
PXT4_VERITY_FL
)

4760 
√w_Ê
 |
S_VERITY
;

4761 
	`öode_£t_Êags
(
öode
, 
√w_Ê
,

4762 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|
S_DAX
|

4763 
S_ENCRYPTED
|
S_CASEFOLD
|
S_VERITY
);

4764 
	}
}

4766 
blk˙t_t
 
	$pxt4_öode_blocks
(
pxt4_öode
 *
øw_öode
,

4767 
pxt4_öode_öfo
 *
ei
)

4769 
blk˙t_t
 
i_blocks
 ;

4770 
öode
 *öodê&(
ei
->
vfs_öode
);

4771 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4773 i‡(
	`pxt4_has_„©uª_huge_fûe
(
sb
)) {

4775 
i_blocks
 = ((
u64
)
	`À16_to_˝u
(
øw_öode
->
i_blocks_high
)) << 32 |

4776 
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4777 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
)) {

4779  
i_blocks
 << (
öode
->
i_blkbôs
 - 9);

4781  
i_blocks
;

4784  
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4786 
	}
}

4788 
ölöe
 
	$pxt4_igë_exåa_öode
(
öode
 *inode,

4789 
pxt4_öode
 *
øw_öode
,

4790 
pxt4_öode_öfo
 *
ei
)

4792 
__À32
 *
magic
 = (*)
øw_öode
 +

4793 
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
;

4795 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 + (
__À32
) <=

4796 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) &&

4797 *
magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

4798 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

4799  
	`pxt4_föd_ölöe_d©a_nﬁock
(
öode
);

4801 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

4803 
	}
}

4805 
	$pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
)

4807 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

4808  -
EOPNOTSUPP
;

4809 *
¥ojid
 = 
	`PXT4_I
(
öode
)->
i_¥ojid
;

4811 
	}
}

4818 
ölöe
 
	$pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
 *öode, 
u64
 
vÆ
)

4820 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4821 
	`öode_£t_ivîsi⁄_øw
(
öode
, 
vÆ
);

4823 
	`öode_£t_ivîsi⁄_quîõd
(
öode
, 
vÆ
);

4824 
	}
}

4825 
ölöe
 
u64
 
	$pxt4_öode_≥ek_ivîsi⁄
(c⁄° 
öode
 *inode)

4827 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4828  
	`öode_≥ek_ivîsi⁄_øw
(
öode
);

4830  
	`öode_≥ek_ivîsi⁄
(
öode
);

4831 
	}
}

4833 
öode
 *
	$__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

4834 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

4835 
löe
)

4837 
pxt4_ûoc
 
ûoc
;

4838 
pxt4_öode
 *
øw_öode
;

4839 
pxt4_öode_öfo
 *
ei
;

4840 
öode
 *inode;

4841 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

4842 
ªt
;

4843 
loff_t
 
size
;

4844 
block
;

4845 
uid_t
 
i_uid
;

4846 
gid_t
 
i_gid
;

4847 
¥ojid_t
 
i_¥ojid
;

4849 i‡((!(
Êags
 & 
PXT4_IGET_SPECIAL
) &&

4850 (
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë&& inÿ!
PXT4_ROOT_INO
)) ||

4851 (
öo
 < 
PXT4_ROOT_INO
) ||

4852 (
öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))) {

4853 i‡(
Êags
 & 
PXT4_IGET_HANDLE
)

4854  
	`ERR_PTR
(-
ESTALE
);

4855 
	`__pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
,

4857 
öo
, 
cuºít
->
comm
);

4858  
	`ERR_PTR
(-
EFSCORRUPTED
);

4861 
öode
 = 
	`igë_locked
(
sb
, 
öo
);

4862 i‡(!
öode
)

4863  
	`ERR_PTR
(-
ENOMEM
);

4864 i‡(!(
öode
->
i_°©e
 & 
I_NEW
))

4865  
öode
;

4867 
ei
 = 
	`PXT4_I
(
öode
);

4868 
ûoc
.
bh
 = 
NULL
;

4870 
ªt
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

4871 i‡(
ªt
 < 0)

4872 
bad_öode
;

4873 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

4875 i‡((
öo
 =
PXT4_ROOT_INO
Ë&& (
øw_öode
->
i_löks_cou¡
 == 0)) {

4876 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4878 
ªt
 = -
EFSCORRUPTED
;

4879 
bad_öode
;

4882 i‡((
Êags
 & 
PXT4_IGET_HANDLE
) &&

4883 (
øw_öode
->
i_löks_cou¡
 =0Ë&& (øw_öode->
i_mode
 == 0)) {

4884 
ªt
 = -
ESTALE
;

4885 
bad_öode
;

4888 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4889 
ei
->
i_exåa_isize
 = 
	`À16_to_˝u
(
øw_öode
->i_extra_isize);

4890 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 >

4891 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) ||

4892 (
ei
->
i_exåa_isize
 & 3)) {

4893 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4896 
ei
->
i_exåa_isize
,

4897 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

4898 
ªt
 = -
EFSCORRUPTED
;

4899 
bad_öode
;

4902 
ei
->
i_exåa_isize
 = 0;

4905 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

4906 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4907 
__u32
 
csum
;

4908 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

4909 
__À32
 
gí
 = 
øw_öode
->
i_gíî©i⁄
;

4910 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

4911 (
öum
));

4912 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

4913 (
gí
));

4916 i‡(!
	`pxt4_öode_csum_vîify
(
öode
, 
øw_öode
, 
ei
)) {

4917 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4919 
ªt
 = -
EFSBADCRC
;

4920 
bad_öode
;

4923 
öode
->
i_mode
 = 
	`À16_to_˝u
(
øw_öode
->i_mode);

4924 
i_uid
 = (
uid_t
)
	`À16_to_˝u
(
øw_öode
->
i_uid_low
);

4925 
i_gid
 = (
gid_t
)
	`À16_to_˝u
(
øw_öode
->
i_gid_low
);

4926 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

4927 
	`PXT4_INODE_SIZE
(
sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

4928 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

4929 
i_¥ojid
 = (
¥ojid_t
)
	`À32_to_˝u
(
øw_öode
->i_projid);

4931 
i_¥ojid
 = 
PXT4_DEF_PROJID
;

4933 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

4934 
i_uid
 |
	`À16_to_˝u
(
øw_öode
->
i_uid_high
) << 16;

4935 
i_gid
 |
	`À16_to_˝u
(
øw_öode
->
i_gid_high
) << 16;

4937 
	`i_uid_wrôe
(
öode
, 
i_uid
);

4938 
	`i_gid_wrôe
(
öode
, 
i_gid
);

4939 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, i_projid);

4940 
	`£t_∆ök
(
öode
, 
	`À16_to_˝u
(
øw_öode
->
i_löks_cou¡
));

4942 
	`pxt4_˛ór_°©e_Êags
(
ei
);

4943 
ei
->
i_ölöe_off
 = 0;

4944 
ei
->
i_dú_°¨t_lookup
 = 0;

4945 
ei
->
i_dtime
 = 
	`À32_to_˝u
(
øw_öode
->i_dtime);

4951 i‡(
öode
->
i_∆ök
 == 0) {

4952 i‡((
öode
->
i_mode
 == 0 ||

4953 !(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
)) &&

4954 
öo
 !
PXT4_BOOT_LOADER_INO
) {

4956 
ªt
 = -
ESTALE
;

4957 
bad_öode
;

4966 
ei
->
i_Êags
 = 
	`À32_to_˝u
(
øw_öode
->i_flags);

4967 
	`pxt4_£t_öode_Êags
(
öode
);

4968 
öode
->
i_blocks
 = 
	`pxt4_öode_blocks
(
øw_öode
, 
ei
);

4969 
ei
->
i_fûe_a˛
 = 
	`À32_to_˝u
(
øw_öode
->
i_fûe_a˛_lo
);

4970 i‡(
	`pxt4_has_„©uª_64bô
(
sb
))

4971 
ei
->
i_fûe_a˛
 |=

4972 ((
__u64
)
	`À16_to_˝u
(
øw_öode
->
i_fûe_a˛_high
)) << 32;

4973 
öode
->
i_size
 = 
	`pxt4_isize
(
sb
, 
øw_öode
);

4974 i‡((
size
 = 
	`i_size_ªad
(
öode
)) < 0) {

4975 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4976 "igë: bad i_sizêvÆue: %Œd", 
size
);

4977 
ªt
 = -
EFSCORRUPTED
;

4978 
bad_öode
;

4985 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
sb
Ë&& 
	`pxt4_has_mëad©a_csum
(sb) &&

4986 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) {

4987 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4989 
ªt
 = -
EFSCORRUPTED
;

4990 
bad_öode
;

4992 
ei
->
i_disksize
 = 
öode
->
i_size
;

4993 #ifde‡
CONFIG_QUOTA


4994 
ei
->
i_ª£rved_quŸa
 = 0;

4996 
öode
->
i_gíî©i⁄
 = 
	`À32_to_˝u
(
øw_öode
->i_generation);

4997 
ei
->
i_block_group
 = 
ûoc
.
block_group
;

4998 
ei
->
i_œ°_Æloc_group
 = ~0;

5003 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

5004 
ei
->
i_d©a
[
block
] = 
øw_öode
->
i_block
[block];

5005 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

5014 i‡(
jou∫Æ
) {

5015 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

5016 
tid_t
 
tid
;

5018 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

5019 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)

5020 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

5022 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

5023 i‡(
å™ß˘i⁄
)

5024 
tid
 = 
å™ß˘i⁄
->
t_tid
;

5026 
tid
 = 
jou∫Æ
->
j_commô_£quí˚
;

5027 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

5028 
ei
->
i_sync_tid
 = 
tid
;

5029 
ei
->
i_d©async_tid
 = 
tid
;

5032 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

5033 i‡(
ei
->
i_exåa_isize
 == 0) {

5035 
	`BUILD_BUG_ON
((
pxt4_öode
) & 3);

5036 
ei
->
i_exåa_isize
 = (
pxt4_öode
) -

5037 
PXT4_GOOD_OLD_INODE_SIZE
;

5039 
ªt
 = 
	`pxt4_igë_exåa_öode
(
öode
, 
øw_öode
, 
ei
);

5040 i‡(
ªt
)

5041 
bad_öode
;

5045 
	`PXT4_INODE_GET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5046 
	`PXT4_INODE_GET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5047 
	`PXT4_INODE_GET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5048 
	`PXT4_EINODE_GET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5050 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5051 
u64
 
ivîs
 = 
	`À32_to_˝u
(
øw_öode
->
i_disk_vîsi⁄
);

5053 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

5054 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5055 
ivîs
 |=

5056 (
__u64
)(
	`À32_to_˝u
(
øw_öode
->
i_vîsi⁄_hi
)) << 32;

5058 
	`pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
, 
ivîs
);

5061 
ªt
 = 0;

5062 i‡(
ei
->
i_fûe_a˛
 &&

5063 !
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
sb
), 
ei
->
i_fûe_a˛
, 1)) {

5064 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5066 
ei
->
i_fûe_a˛
);

5067 
ªt
 = -
EFSCORRUPTED
;

5068 
bad_öode
;

5069 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5071 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

5072 (
	`S_ISLNK
(
öode
->
i_mode
) &&

5073 !
	`pxt4_öode_is_Á°_symlök
(
öode
))) {

5074 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5075 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

5077 
ªt
 = 
	`pxt4_öd_check_öode
(
öode
);

5080 i‡(
ªt
)

5081 
bad_öode
;

5083 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

5084 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

5085 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

5086 
	`pxt4_£t_a›s
(
öode
);

5087 } i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

5088 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

5089 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

5090 } i‡(
	`S_ISLNK
(
öode
->
i_mode
)) {

5092 i‡(
	`IS_APPEND
(
öode
Ë|| 
	`IS_IMMUTABLE
(inode)) {

5093 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5096 
ªt
 = -
EFSCORRUPTED
;

5097 
bad_öode
;

5099 i‡(
	`IS_ENCRYPTED
(
öode
)) {

5100 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

5101 
	`pxt4_£t_a›s
(
öode
);

5102 } i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

5103 
öode
->
i_lök
 = (*)
ei
->
i_d©a
;

5104 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

5105 
	`nd_ãrmö©e_lök
(
ei
->
i_d©a
, 
öode
->
i_size
,

5106 (
ei
->
i_d©a
) - 1);

5108 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

5109 
	`pxt4_£t_a›s
(
öode
);

5111 
	`öode_nohighmem
(
öode
);

5112 } i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode) ||

5113 
	`S_ISFIFO
(
öode
->
i_mode
Ë|| 
	`S_ISSOCK
(inode->i_mode)) {

5114 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

5115 i‡(
øw_öode
->
i_block
[0])

5116 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5117 
	`ﬁd_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[0])));

5119 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5120 
	`√w_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[1])));

5121 } i‡(
öo
 =
PXT4_BOOT_LOADER_INO
) {

5122 
	`make_bad_öode
(
öode
);

5124 
ªt
 = -
EFSCORRUPTED
;

5125 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5126 "igë: bogu†i_modê(%o)", 
öode
->
i_mode
);

5127 
bad_öode
;

5129 i‡(
	`IS_CASEFOLDED
(
öode
Ë&& !
	`pxt4_has_„©uª_ˇ£fﬁd
(öode->
i_sb
))

5130 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5132 
	`bªl£
(
ûoc
.
bh
);

5134 
	`u∆ock_√w_öode
(
öode
);

5135  
öode
;

5137 
bad_öode
:

5138 
	`bªl£
(
ûoc
.
bh
);

5139 
	`igë_Áûed
(
öode
);

5140  
	`ERR_PTR
(
ªt
);

5141 
	}
}

5143 
	$pxt4_öode_blocks_£t
(
h™dÀ_t
 *
h™dÀ
,

5144 
pxt4_öode
 *
øw_öode
,

5145 
pxt4_öode_öfo
 *
ei
)

5147 
öode
 *öodê&(
ei
->
vfs_öode
);

5148 
u64
 
i_blocks
 = 
	`READ_ONCE
(
öode
->i_blocks);

5149 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5151 i‡(
i_blocks
 <= ~0U) {

5156 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5157 
øw_öode
->
i_blocks_high
 = 0;

5158 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5161 i‡(!
	`pxt4_has_„©uª_huge_fûe
(
sb
))

5162  -
EFBIG
;

5164 i‡(
i_blocks
 <= 0xffffffffffffULL) {

5169 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5170 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5171 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5173 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5175 
i_blocks
 = i_block†>> (
öode
->
i_blkbôs
 - 9);

5176 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5177 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5180 
	}
}

5182 
	sŸhî_öode
 {

5183 
	m‹ig_öo
;

5184 
pxt4_öode
 *
	møw_öode
;

5187 
	$Ÿhî_öode_m©ch
(
öode
 * inode, 
öo
,

5188 *
d©a
)

5190 
Ÿhî_öode
 *
oi
 = (Ÿhî_öodê*Ë
d©a
;

5192 i‡((
öode
->
i_öo
 !
öo
) ||

5193 (
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5194 
I_DIRTY_INODE
)) ||

5195 ((
öode
->
i_°©e
 & 
I_DIRTY_TIME
) == 0))

5197 
	`•ö_lock
(&
öode
->
i_lock
);

5198 i‡(((
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5199 
I_DIRTY_INODE
)) == 0) &&

5200 (
öode
->
i_°©e
 & 
I_DIRTY_TIME
)) {

5201 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5203 
öode
->
i_°©e
 &~(
I_DIRTY_TIME
 | 
I_DIRTY_TIME_EXPIRED
);

5204 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5206 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5207 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
oi
->
øw_öode
);

5208 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
oi
->
øw_öode
);

5209 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
oi
->
øw_öode
);

5210 
	`pxt4_öode_csum_£t
(
öode
, 
oi
->
øw_öode
, 
ei
);

5211 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5212 
	`åa˚_pxt4_Ÿhî_öode_upd©e_time
(
öode
, 
oi
->
‹ig_öo
);

5215 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5217 
	}
}

5223 
	$pxt4_upd©e_Ÿhî_öodes_time
(
su≥r_block
 *
sb
,

5224 
‹ig_öo
, *
buf
)

5226 
Ÿhî_öode
 
oi
;

5227 
öo
;

5228 
i
, 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

5229 
öode_size
 = 
	`PXT4_INODE_SIZE
(
sb
);

5231 
oi
.
‹ig_öo
 = orig_ino;

5237 
öo
 = ((
‹ig_öo
 - 1Ë& ~(
öodes_≥r_block
 - 1)) + 1;

5238 
i
 = 0; i < 
öodes_≥r_block
; i++, 
öo
++, 
buf
 +
öode_size
) {

5239 i‡(
öo
 =
‹ig_öo
)

5241 
oi
.
øw_öode
 = (
pxt4_öode
 *Ë
buf
;

5242 (Ë
	`föd_öode_nowaô
(
sb
, 
öo
, 
Ÿhî_öode_m©ch
, &
oi
);

5244 
	}
}

5253 
	$pxt4_do_upd©e_öode
(
h™dÀ_t
 *
h™dÀ
,

5254 
öode
 *inode,

5255 
pxt4_ûoc
 *
ûoc
)

5257 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5258 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5259 
buf„r_hód
 *
bh
 = 
ûoc
->bh;

5260 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5261 
îr
 = 0, 
rc
, 
block
;

5262 
√ed_d©async
 = 0, 
£t_œrge_fûe
 = 0;

5263 
uid_t
 
i_uid
;

5264 
gid_t
 
i_gid
;

5265 
¥ojid_t
 
i_¥ojid
;

5267 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5271 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

5272 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

5274 
øw_öode
->
i_mode
 = 
	`˝u_to_À16
(
öode
->i_mode);

5275 
i_uid
 = 
	`i_uid_ªad
(
öode
);

5276 
i_gid
 = 
	`i_gid_ªad
(
öode
);

5277 
i_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->i_projid);

5278 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

5279 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_uid
));

5280 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_gid
));

5285 i‡(
ei
->
i_dtime
 && 
	`li°_em±y
(&ei->
i_‹ph™
)) {

5286 
øw_öode
->
i_uid_high
 = 0;

5287 
øw_öode
->
i_gid_high
 = 0;

5289 
øw_öode
->
i_uid_high
 =

5290 
	`˝u_to_À16
(
	`high_16_bôs
(
i_uid
));

5291 
øw_öode
->
i_gid_high
 =

5292 
	`˝u_to_À16
(
	`high_16_bôs
(
i_gid
));

5295 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowuid
(
i_uid
));

5296 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowgid
(
i_gid
));

5297 
øw_öode
->
i_uid_high
 = 0;

5298 
øw_öode
->
i_gid_high
 = 0;

5300 
øw_öode
->
i_löks_cou¡
 = 
	`˝u_to_À16
(
öode
->
i_∆ök
);

5302 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5303 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5304 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5305 
	`PXT4_EINODE_SET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5307 
îr
 = 
	`pxt4_öode_blocks_£t
(
h™dÀ
, 
øw_öode
, 
ei
);

5308 i‡(
îr
) {

5309 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5310 
out_bªl£
;

5312 
øw_öode
->
i_dtime
 = 
	`˝u_to_À32
(
ei
->i_dtime);

5313 
øw_öode
->
i_Êags
 = 
	`˝u_to_À32
(
ei
->i_flags & 0xFFFFFFFF);

5314 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
)))

5315 
øw_öode
->
i_fûe_a˛_high
 =

5316 
	`˝u_to_À16
(
ei
->
i_fûe_a˛
 >> 32);

5317 
øw_öode
->
i_fûe_a˛_lo
 = 
	`˝u_to_À32
(
ei
->
i_fûe_a˛
);

5318 i‡(
ei
->
i_disksize
 !
	`pxt4_isize
(
öode
->
i_sb
, 
øw_öode
)) {

5319 
	`pxt4_isize_£t
(
øw_öode
, 
ei
->
i_disksize
);

5320 
√ed_d©async
 = 1;

5322 i‡(
ei
->
i_disksize
 > 0x7fffffffULL) {

5323 i‡(!
	`pxt4_has_„©uª_œrge_fûe
(
sb
) ||

5324 
	`PXT4_SB
(
sb
)->
s_es
->
s_ªv_Àvñ
 ==

5325 
	`˝u_to_À32
(
PXT4_GOOD_OLD_REV
))

5326 
£t_œrge_fûe
 = 1;

5328 
øw_öode
->
i_gíî©i⁄
 = 
	`˝u_to_À32
(
öode
->i_generation);

5329 i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode)) {

5330 i‡(
	`ﬁd_vÆid_dev
(
öode
->
i_rdev
)) {

5331 
øw_öode
->
i_block
[0] =

5332 
	`˝u_to_À32
(
	`ﬁd_ícode_dev
(
öode
->
i_rdev
));

5333 
øw_öode
->
i_block
[1] = 0;

5335 
øw_öode
->
i_block
[0] = 0;

5336 
øw_öode
->
i_block
[1] =

5337 
	`˝u_to_À32
(
	`√w_ícode_dev
(
öode
->
i_rdev
));

5338 
øw_öode
->
i_block
[2] = 0;

5340 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5341 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

5342 
øw_öode
->
i_block
[
block
] = 
ei
->
i_d©a
[block];

5345 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5346 
u64
 
ivîs
 = 
	`pxt4_öode_≥ek_ivîsi⁄
(
öode
);

5348 
øw_öode
->
i_disk_vîsi⁄
 = 
	`˝u_to_À32
(
ivîs
);

5349 i‡(
ei
->
i_exåa_isize
) {

5350 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5351 
øw_öode
->
i_vîsi⁄_hi
 =

5352 
	`˝u_to_À32
(
ivîs
 >> 32);

5353 
øw_öode
->
i_exåa_isize
 =

5354 
	`˝u_to_À16
(
ei
->
i_exåa_isize
);

5358 
	`BUG_ON
(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

5359 
i_¥ojid
 !
PXT4_DEF_PROJID
);

5361 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

5362 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

5363 
øw_öode
->
i_¥ojid
 = 
	`˝u_to_À32
(i_projid);

5365 
	`pxt4_öode_csum_£t
(
öode
, 
øw_öode
, 
ei
);

5366 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5367 i‡(
öode
->
i_sb
->
s_Êags
 & 
SB_LAZYTIME
)

5368 
	`pxt4_upd©e_Ÿhî_öodes_time
(
öode
->
i_sb
, inode->
i_öo
,

5369 
bh
->
b_d©a
);

5371 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

5372 
rc
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

5373 i‡(!
îr
)

5374 
îr
 = 
rc
;

5375 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

5376 i‡(
£t_œrge_fûe
) {

5377 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get writeáccess");

5378 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

5379 i‡(
îr
)

5380 
out_bªl£
;

5381 
	`pxt4_£t_„©uª_œrge_fûe
(
sb
);

5382 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5383 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

5385 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 
√ed_d©async
);

5386 
out_bªl£
:

5387 
	`bªl£
(
bh
);

5388 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5389  
îr
;

5390 
	}
}

5426 
	$pxt4_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
)

5428 
îr
;

5430 i‡(
	`WARN_ON_ONCE
(
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

5431 
	`sb_rd⁄ly
(
öode
->
i_sb
))

5434 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5435  -
EIO
;

5437 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

5438 i‡(
	`pxt4_jou∫Æ_cuºít_h™dÀ
()) {

5439 
	`jbd_debug
(1, "calledÑecursively,Çon-PF_MEMALLOC!\n");

5440 
	`dump_°ack
();

5441  -
EIO
;

5449 i‡(
wbc
->
sync_mode
 !
WB_SYNC_ALL
 || wbc->
f‹_sync
)

5452 
îr
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

5453 
	`PXT4_I
(
öode
)->
i_sync_tid
);

5455 
pxt4_ûoc
 
ûoc
;

5457 
îr
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

5458 i‡(
îr
)

5459  
îr
;

5464 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 && !wbc->
f‹_sync
)

5465 
	`sync_dúty_buf„r
(
ûoc
.
bh
);

5466 i‡(
	`buf„r_ªq
(
ûoc
.
bh
Ë&& !
	`buf„r_u±od©e
(iloc.bh)) {

5467 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ûoc
.
bh
->
b_blockƒ
,

5469 
îr
 = -
EIO
;

5471 
	`bªl£
(
ûoc
.
bh
);

5473  
îr
;

5474 
	}
}

5481 
	$pxt4_waô_f‹_èû_∑ge_commô
(
öode
 *inode)

5483 
∑ge
 *page;

5484 
off£t
;

5485 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

5486 
tid_t
 
commô_tid
 = 0;

5487 
ªt
;

5489 
off£t
 = 
öode
->
i_size
 & (
PAGE_SIZE
 - 1);

5499 i‡(!
off£t
 || off£à> (
PAGE_SIZE
 - 
	`i_blocksize
(
öode
)))

5502 
∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
,

5503 
öode
->
i_size
 >> 
PAGE_SHIFT
);

5504 i‡(!
∑ge
)

5506 
ªt
 = 
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
,

5507 
PAGE_SIZE
 - 
off£t
);

5508 
	`u∆ock_∑ge
(
∑ge
);

5509 
	`put_∑ge
(
∑ge
);

5510 i‡(
ªt
 !-
EBUSY
)

5512 
commô_tid
 = 0;

5513 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

5514 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

5515 
commô_tid
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

5516 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

5517 i‡(
commô_tid
)

5518 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
commô_tid
);

5520 
	}
}

5546 
	$pxt4_£èâr
(
díåy
 *díåy, 
üâr
 *
©å
)

5548 
öode
 *öodê
	`d_öode
(
díåy
);

5549 
îr‹
, 
rc
 = 0;

5550 
‹ph™
 = 0;

5551 c⁄° 
ü_vÆid
 = 
©å
->ia_valid;

5553 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5554  -
EIO
;

5556 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

5557  -
EPERM
;

5559 i‡(
	`u∆ikñy
(
	`IS_APPEND
(
öode
) &&

5560 (
ü_vÆid
 & (
ATTR_MODE
 | 
ATTR_UID
 |

5561 
ATTR_GID
 | 
ATTR_TIMES_SET
))))

5562  -
EPERM
;

5564 
îr‹
 = 
	`£èâr_¥ï¨e
(
díåy
, 
©å
);

5565 i‡(
îr‹
)

5566  
îr‹
;

5568 
îr‹
 = 
	`fs¸y±_¥ï¨e_£èâr
(
díåy
, 
©å
);

5569 i‡(
îr‹
)

5570  
îr‹
;

5572 
îr‹
 = 
	`fsvîôy_¥ï¨e_£èâr
(
díåy
, 
©å
);

5573 i‡(
îr‹
)

5574  
îr‹
;

5576 i‡(
	`is_quŸa_modifiˇti⁄
(
öode
, 
©å
)) {

5577 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

5578 i‡(
îr‹
)

5579  
îr‹
;

5581 i‡((
ü_vÆid
 & 
ATTR_UID
 && !
	`uid_eq
(
©å
->
ü_uid
, 
öode
->
i_uid
)) ||

5582 (
ü_vÆid
 & 
ATTR_GID
 && !
	`gid_eq
(
©å
->
ü_gid
, 
öode
->
i_gid
))) {

5583 
h™dÀ_t
 *
h™dÀ
;

5587 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5588 (
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
öode
->
i_sb
) +

5589 
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
)) + 3);

5590 i‡(
	`IS_ERR
(
h™dÀ
)) {

5591 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5592 
îr_out
;

5598 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5599 
îr‹
 = 
	`dquŸ_å™s„r
(
öode
, 
©å
);

5600 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5602 i‡(
îr‹
) {

5603 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5604  
îr‹
;

5608 i‡(
©å
->
ü_vÆid
 & 
ATTR_UID
)

5609 
öode
->
i_uid
 = 
©å
->
ü_uid
;

5610 i‡(
©å
->
ü_vÆid
 & 
ATTR_GID
)

5611 
öode
->
i_gid
 = 
©å
->
ü_gid
;

5612 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5613 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5616 i‡(
©å
->
ü_vÆid
 & 
ATTR_SIZE
) {

5617 
h™dÀ_t
 *
h™dÀ
;

5618 
loff_t
 
ﬁdsize
 = 
öode
->
i_size
;

5619 
shrök
 = (
©å
->
ü_size
 < 
öode
->
i_size
);

5621 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

5622 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5624 i‡(
©å
->
ü_size
 > 
sbi
->
s_bôm≠_maxbyãs
)

5625  -
EFBIG
;

5627 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5628  -
EINVAL
;

5630 i‡(
	`IS_I_VERSION
(
öode
Ë&& 
©å
->
ü_size
 !öode->
i_size
)

5631 
	`öode_öc_ivîsi⁄
(
öode
);

5633 i‡(
shrök
) {

5634 i‡(
	`pxt4_should_‹dî_d©a
(
öode
)) {

5635 
îr‹
 = 
	`pxt4_begö_‹dîed_åunˇã
(
öode
,

5636 
©å
->
ü_size
);

5637 i‡(
îr‹
)

5638 
îr_out
;

5644 
	`öode_dio_waô
(
öode
);

5647 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5649 
rc
 = 
	`pxt4_bªak_œyouts
(
öode
);

5650 i‡(
rc
) {

5651 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5652  
rc
;

5655 i‡(
©å
->
ü_size
 !
öode
->
i_size
) {

5656 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 3);

5657 i‡(
	`IS_ERR
(
h™dÀ
)) {

5658 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5659 
out_mm≠_£m
;

5661 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& 
shrök
) {

5662 
îr‹
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

5663 
‹ph™
 = 1;

5669 i‡(!
shrök
) {

5670 
öode
->
i_mtime
 = 
	`cuºít_time
(inode);

5671 
öode
->
i_˘ime
 = inode->
i_mtime
;

5673 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5674 
	`PXT4_I
(
öode
)->
i_disksize
 = 
©å
->
ü_size
;

5675 
rc
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5676 i‡(!
îr‹
)

5677 
îr‹
 = 
rc
;

5683 i‡(!
îr‹
)

5684 
	`i_size_wrôe
(
öode
, 
©å
->
ü_size
);

5685 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5686 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5687 i‡(
îr‹
)

5688 
out_mm≠_£m
;

5689 i‡(!
shrök
) {

5690 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁdsize
,

5691 
öode
->
i_size
);

5692 } i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5693 
	`pxt4_waô_f‹_èû_∑ge_commô
(
öode
);

5701 
	`åunˇã_∑geˇche
(
öode
, inode->
i_size
);

5706 i‡(
©å
->
ü_size
 <
ﬁdsize
) {

5707 
rc
 = 
	`pxt4_åunˇã
(
öode
);

5708 i‡(
rc
)

5709 
îr‹
 = 
rc
;

5711 
out_mm≠_£m
:

5712 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5715 i‡(!
îr‹
) {

5716 
	`£èâr_c›y
(
öode
, 
©å
);

5717 
	`m¨k_öode_dúty
(
öode
);

5724 i‡(
‹ph™
 && 
öode
->
i_∆ök
)

5725 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

5727 i‡(!
îr‹
 && (
ü_vÆid
 & 
ATTR_MODE
))

5728 
rc
 = 
	`posix_a˛_chmod
(
öode
, inode->
i_mode
);

5730 
îr_out
:

5731 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

5732 i‡(!
îr‹
)

5733 
îr‹
 = 
rc
;

5734  
îr‹
;

5735 
	}
}

5737 
	$pxt4_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5738 
u32
 
ªque°_mask
, 
quîy_Êags
)

5740 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5741 
pxt4_öode
 *
øw_öode
;

5742 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5743 
Êags
;

5745 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¸time
)) {

5746 
°©
->
ªsu…_mask
 |
STATX_BTIME
;

5747 
°©
->
btime
.
tv_£c
 = 
ei
->
i_¸time
.tv_sec;

5748 
°©
->
btime
.
tv_n£c
 = 
ei
->
i_¸time
.tv_nsec;

5751 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

5752 i‡(
Êags
 & 
PXT4_APPEND_FL
)

5753 
°©
->
©åibuãs
 |
STATX_ATTR_APPEND
;

5754 i‡(
Êags
 & 
PXT4_COMPR_FL
)

5755 
°©
->
©åibuãs
 |
STATX_ATTR_COMPRESSED
;

5756 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

5757 
°©
->
©åibuãs
 |
STATX_ATTR_ENCRYPTED
;

5758 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

5759 
°©
->
©åibuãs
 |
STATX_ATTR_IMMUTABLE
;

5760 i‡(
Êags
 & 
PXT4_NODUMP_FL
)

5761 
°©
->
©åibuãs
 |
STATX_ATTR_NODUMP
;

5763 
°©
->
©åibuãs_mask
 |(
STATX_ATTR_APPEND
 |

5764 
STATX_ATTR_COMPRESSED
 |

5765 
STATX_ATTR_ENCRYPTED
 |

5766 
STATX_ATTR_IMMUTABLE
 |

5767 
STATX_ATTR_NODUMP
);

5769 
	`gíîic_fûœâr
(
öode
, 
°©
);

5771 
	}
}

5773 
	$pxt4_fûe_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5774 
u32
 
ªque°_mask
, 
quîy_Êags
)

5776 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5777 
u64
 
dñÆloc_blocks
;

5779 
	`pxt4_gë©å
(
∑th
, 
°©
, 
ªque°_mask
, 
quîy_Êags
);

5787 i‡(
	`u∆ikñy
(
	`pxt4_has_ölöe_d©a
(
öode
)))

5788 
°©
->
blocks
 +(°©->
size
 + 511) >> 9;

5800 
dñÆloc_blocks
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

5801 
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
);

5802 
°©
->
blocks
 +
dñÆloc_blocks
 << (
öode
->
i_sb
->
s_blocksize_bôs
 - 9);

5804 
	}
}

5806 
	$pxt4_ödex_å™s_blocks
(
öode
 *öode, 
lblocks
,

5807 
≥xã¡s
)

5809 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

5810  
	`pxt4_öd_å™s_blocks
(
öode
, 
lblocks
);

5811  
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 
≥xã¡s
);

5812 
	}
}

5825 
	$pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

5826 
≥xã¡s
)

5828 
pxt4_group_t
 
groups
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
öode
->
i_sb
);

5829 
gdpblocks
;

5830 
idxblocks
;

5831 
ªt
 = 0;

5837 
idxblocks
 = 
	`pxt4_ödex_å™s_blocks
(
öode
, 
lblocks
, 
≥xã¡s
);

5839 
ªt
 = 
idxblocks
;

5845 
groups
 = 
idxblocks
 + 
≥xã¡s
;

5846 
gdpblocks
 = 
groups
;

5847 i‡(
groups
 > 
ngroups
)

5848 
groups
 = 
ngroups
;

5849 i‡(
groups
 > 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
)

5850 
gdpblocks
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
;

5853 
ªt
 +
groups
 + 
gdpblocks
;

5856 
ªt
 +
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

5858  
ªt
;

5859 
	}
}

5871 
	$pxt4_wrôïage_å™s_blocks
(
öode
 *inode)

5873 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

5874 
ªt
;

5876 
ªt
 = 
	`pxt4_mëa_å™s_blocks
(
öode
, 
bµ
, bpp);

5879 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

5880 
ªt
 +
bµ
;

5881  
ªt
;

5882 
	}
}

5893 
	$pxt4_chunk_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

5895  
	`pxt4_mëa_å™s_blocks
(
öode
, 
ƒblocks
, 1);

5896 
	}
}

5902 
	$pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

5903 
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

5905 
îr
 = 0;

5907 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

5908 
	`put_bh
(
ûoc
->
bh
);

5909  -
EIO
;

5911 i‡(
	`IS_I_VERSION
(
öode
))

5912 
	`öode_öc_ivîsi⁄
(
öode
);

5915 
	`gë_bh
(
ûoc
->
bh
);

5918 
îr
 = 
	`pxt4_do_upd©e_öode
(
h™dÀ
, 
öode
, 
ûoc
);

5919 
	`put_bh
(
ûoc
->
bh
);

5920  
îr
;

5921 
	}
}

5929 
	$pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5930 
pxt4_ûoc
 *
ûoc
)

5932 
îr
;

5934 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5935  -
EIO
;

5937 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, 
ûoc
);

5938 i‡(!
îr
) {

5939 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

5940 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

5941 i‡(
îr
) {

5942 
	`bªl£
(
ûoc
->
bh
);

5943 
ûoc
->
bh
 = 
NULL
;

5946 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5947  
îr
;

5948 
	}
}

5950 
	$__pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5951 
√w_exåa_isize
,

5952 
pxt4_ûoc
 *
ûoc
,

5953 
h™dÀ_t
 *
h™dÀ
, *
no_ex∑nd
)

5955 
pxt4_öode
 *
øw_öode
;

5956 
pxt4_x©å_ibody_hódî
 *
hódî
;

5957 
öode_size
 = 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
);

5958 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5959 
îr‹
;

5962 i‡((
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 > 
öode_size
) ||

5963 (
ei
->
i_exåa_isize
 & 3)) {

5964 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtra_isize %u (inode size %u)",

5965 
ei
->
i_exåa_isize
,

5966 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

5967  -
EFSCORRUPTED
;

5969 i‡((
√w_exåa_isize
 < 
ei
->
i_exåa_isize
) ||

5970 (
√w_exåa_isize
 < 4) ||

5971 (
√w_exåa_isize
 > 
öode_size
 - 
PXT4_GOOD_OLD_INODE_SIZE
))

5972  -
EINVAL
;

5974 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5976 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

5979 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
) ||

5980 
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

5981 
	`mem£t
((*)
øw_öode
 + 
PXT4_GOOD_OLD_INODE_SIZE
 +

5982 
	`PXT4_I
(
öode
)->
i_exåa_isize
, 0,

5983 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
);

5984 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

5989 
îr‹
 = 
	`pxt4_ex∑nd_exåa_isize_ó
(
öode
, 
√w_exåa_isize
,

5990 
øw_öode
, 
h™dÀ
);

5991 i‡(
îr‹
) {

5995 *
no_ex∑nd
 = 1;

5998  
îr‹
;

5999 
	}
}

6005 
	$pxt4_åy_to_ex∑nd_exåa_isize
(
öode
 *inode,

6006 
√w_exåa_isize
,

6007 
pxt4_ûoc
 
ûoc
,

6008 
h™dÀ_t
 *
h™dÀ
)

6010 
no_ex∑nd
;

6011 
îr‹
;

6013 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
))

6014  -
EOVERFLOW
;

6025 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

6026 
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
,

6027 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
)) != 0)

6028  -
ENOSPC
;

6030 i‡(
	`pxt4_wrôe_åylock_x©å
(
öode
, &
no_ex∑nd
) == 0)

6031  -
EBUSY
;

6033 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, &
ûoc
,

6034 
h™dÀ
, &
no_ex∑nd
);

6035 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

6037  
îr‹
;

6038 
	}
}

6040 
	$pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

6041 
√w_exåa_isize
,

6042 
pxt4_ûoc
 *
ûoc
)

6044 
h™dÀ_t
 *
h™dÀ
;

6045 
no_ex∑nd
;

6046 
îr‹
, 
rc
;

6048 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
)) {

6049 
	`bªl£
(
ûoc
->
bh
);

6050  -
EOVERFLOW
;

6053 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
,

6054 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
));

6055 i‡(
	`IS_ERR
(
h™dÀ
)) {

6056 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

6057 
	`bªl£
(
ûoc
->
bh
);

6058  
îr‹
;

6061 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

6063 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

6064 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

6065 i‡(
îr‹
) {

6066 
	`bªl£
(
ûoc
->
bh
);

6067 
out_u∆ock
;

6070 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, 
ûoc
,

6071 
h™dÀ
, &
no_ex∑nd
);

6073 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, 
ûoc
);

6074 i‡(!
îr‹
)

6075 
îr‹
 = 
rc
;

6077 
out_u∆ock
:

6078 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

6079 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6080  
îr‹
;

6081 
	}
}

6096 
	$pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

6098 
pxt4_ûoc
 
ûoc
;

6099 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6100 
îr
;

6102 
	`might_¶ìp
();

6103 
	`åa˚_pxt4_m¨k_öode_dúty
(
öode
, 
_RET_IP_
);

6104 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

6105 i‡(
îr
)

6106  
îr
;

6108 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 < 
sbi
->
s_w™t_exåa_isize
)

6109 
	`pxt4_åy_to_ex∑nd_exåa_isize
(
öode
, 
sbi
->
s_w™t_exåa_isize
,

6110 
ûoc
, 
h™dÀ
);

6112  
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

6113 
	}
}

6133 
	$pxt4_dúty_öode
(
öode
 *öode, 
Êags
)

6135 
h™dÀ_t
 *
h™dÀ
;

6137 i‡(
Êags
 =
I_DIRTY_TIME
)

6139 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

6140 i‡(
	`IS_ERR
(
h™dÀ
))

6141 
out
;

6143 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6145 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6146 
out
:

6148 
	}
}

6150 
	$pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *öode, 
vÆ
)

6152 
jou∫Æ_t
 *
jou∫Æ
;

6153 
h™dÀ_t
 *
h™dÀ
;

6154 
îr
;

6155 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6167 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

6168 i‡(!
jou∫Æ
)

6170 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

6171  -
EROFS
;

6174 
	`öode_dio_waô
(
öode
);

6184 i‡(
vÆ
) {

6185 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6186 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

6187 i‡(
îr
 < 0) {

6188 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6189  
îr
;

6193 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

6194 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

6204 i‡(
vÆ
)

6205 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6207 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

6208 i‡(
îr
 < 0) {

6209 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6210 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

6211  
îr
;

6213 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6215 
	`pxt4_£t_a›s
(
öode
);

6217 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6218 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

6220 i‡(
vÆ
)

6221 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6225 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

6226 i‡(
	`IS_ERR
(
h™dÀ
))

6227  
	`PTR_ERR
(
h™dÀ
);

6229 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6230 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

6231 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6232 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

6234  
îr
;

6235 
	}
}

6237 
	$pxt4_bh_unm≠≥d
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

6239  !
	`buf„r_m≠≥d
(
bh
);

6240 
	}
}

6242 
vm_Áu…_t
 
	$pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

6244 
vm_¨ó_°ru˘
 *
vma
 = 
vmf
->vma;

6245 
∑ge
 *∑gê
vmf
->page;

6246 
loff_t
 
size
;

6247 
Àn
;

6248 
îr
;

6249 
vm_Áu…_t
 
ªt
;

6250 
fûe
 *fûê
vma
->
vm_fûe
;

6251 
öode
 *öodê
	`fûe_öode
(
fûe
);

6252 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

6253 
h™dÀ_t
 *
h™dÀ
;

6254 
gë_block_t
 *
gë_block
;

6255 
ªåõs
 = 0;

6257 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

6258  
VM_FAULT_SIGBUS
;

6260 
	`sb_°¨t_∑geÁu…
(
öode
->
i_sb
);

6261 
	`fûe_upd©e_time
(
vma
->
vm_fûe
);

6263 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6265 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

6266 i‡(
îr
)

6267 
out_ªt
;

6270 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

6271 !
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

6272 !
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
)) {

6274 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
,

6275 
pxt4_da_gë_block_¥ï
);

6276 } 
îr
 =-
ENOSPC
 &&

6277 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

6278 
out_ªt
;

6281 
	`lock_∑ge
(
∑ge
);

6282 
size
 = 
	`i_size_ªad
(
öode
);

6284 i‡(
∑ge
->
m≠pög
 !m≠pög || 
	`∑ge_off£t
’ageË> 
size
) {

6285 
	`u∆ock_∑ge
(
∑ge
);

6286 
ªt
 = 
VM_FAULT_NOPAGE
;

6287 
out
;

6290 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
)

6291 
Àn
 = 
size
 & ~
PAGE_MASK
;

6293 
Àn
 = 
PAGE_SIZE
;

6298 i‡(
	`∑ge_has_buf„rs
(
∑ge
)) {

6299 i‡(!
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
	`∑ge_buf„rs
(
∑ge
),

6300 0, 
Àn
, 
NULL
,

6301 
pxt4_bh_unm≠≥d
)) {

6303 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

6304 
ªt
 = 
VM_FAULT_LOCKED
;

6305 
out
;

6308 
	`u∆ock_∑ge
(
∑ge
);

6310 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

6311 
gë_block
 = 
pxt4_gë_block_unwrôãn
;

6313 
gë_block
 = 
pxt4_gë_block
;

6314 
ªåy_Æloc
:

6315 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

6316 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

6317 i‡(
	`IS_ERR
(
h™dÀ
)) {

6318 
ªt
 = 
VM_FAULT_SIGBUS
;

6319 
out
;

6321 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
, 
gë_block
);

6322 i‡(!
îr
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

6323 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 0,

6324 
PAGE_SIZE
, 
NULL
, 
do_jou∫Æ_gë_wrôe_ac˚ss
)) {

6325 
	`u∆ock_∑ge
(
∑ge
);

6326 
ªt
 = 
VM_FAULT_SIGBUS
;

6327 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6328 
out
;

6330 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

6332 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6333 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

6334 
ªåy_Æloc
;

6335 
out_ªt
:

6336 
ªt
 = 
	`block_∑ge_mkwrôe_ªtu∫
(
îr
);

6337 
out
:

6338 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6339 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

6340  
ªt
;

6341 
	}
}

6343 
vm_Áu…_t
 
	$pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
)

6345 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

6346 
vm_Áu…_t
 
ªt
;

6348 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6349 
ªt
 = 
	`fûem≠_Áu…
(
vmf
);

6350 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6352  
ªt
;

6353 
	}
}

	@ioctl.c

11 
	~<löux/fs.h
>

12 
	~<löux/ˇ∑bûôy.h
>

13 
	~<löux/time.h
>

14 
	~<löux/com∑t.h
>

15 
	~<löux/mou¡.h
>

16 
	~<löux/fûe.h
>

17 
	~<löux/quŸa›s.h
>

18 
	~<löux/øndom.h
>

19 
	~<löux/uuid.h
>

20 
	~<löux/uac˚ss.h
>

21 
	~<löux/dñay.h
>

22 
	~<löux/ivîsi⁄.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

25 
	~<löux/fsm≠.h
>

26 
	~"fsm≠.h
"

27 
	~<åa˚/evíts/pxt4.h
>

37 
	$memsw≠
(*
a
, *
b
, 
size_t
 
Àn
)

39 *
≠
, *
bp
;

41 
≠
 = (*)
a
;

42 
bp
 = (*)
b
;

43 
Àn
-- > 0) {

44 
	`sw≠
(*
≠
, *
bp
);

45 
≠
++;

46 
bp
++;

48 
	}
}

61 
	$sw≠_öode_d©a
(
öode
 *
öode1
, öodê*
öode2
)

63 
loff_t
 
isize
;

64 
pxt4_öode_öfo
 *
ei1
;

65 
pxt4_öode_öfo
 *
ei2
;

66 
tmp
;

68 
ei1
 = 
	`PXT4_I
(
öode1
);

69 
ei2
 = 
	`PXT4_I
(
öode2
);

71 
	`sw≠
(
öode1
->
i_vîsi⁄
, 
öode2
->i_version);

72 
	`sw≠
(
öode1
->
i_©ime
, 
öode2
->i_atime);

73 
	`sw≠
(
öode1
->
i_mtime
, 
öode2
->i_mtime);

75 
	`memsw≠
(
ei1
->
i_d©a
, 
ei2
->i_data, (ei1->i_data));

76 
tmp
 = 
ei1
->
i_Êags
 & 
PXT4_FL_SHOULD_SWAP
;

77 
ei1
->
i_Êags
 = (
ei2
->i_Êag†& 
PXT4_FL_SHOULD_SWAP
) |

78 (
ei1
->
i_Êags
 & ~
PXT4_FL_SHOULD_SWAP
);

79 
ei2
->
i_Êags
 = 
tmp
 | (ei2->i_Êag†& ~
PXT4_FL_SHOULD_SWAP
);

80 
	`sw≠
(
ei1
->
i_disksize
, 
ei2
->i_disksize);

81 
	`pxt4_es_ªmove_exã¡
(
öode1
, 0, 
EXT_MAX_BLOCKS
);

82 
	`pxt4_es_ªmove_exã¡
(
öode2
, 0, 
EXT_MAX_BLOCKS
);

84 
isize
 = 
	`i_size_ªad
(
öode1
);

85 
	`i_size_wrôe
(
öode1
, 
	`i_size_ªad
(
öode2
));

86 
	`i_size_wrôe
(
öode2
, 
isize
);

87 
	}
}

89 
	$ª£t_öode_£ed
(
öode
 *inode)

91 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

92 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

93 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

94 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

95 
__u32
 
csum
;

97 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

100 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
, (inum));

101 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
, (gen));

102 
	}
}

113 
	$sw≠_öode_boŸ_lﬂdî
(
su≥r_block
 *
sb
,

114 
öode
 *inode)

116 
h™dÀ_t
 *
h™dÀ
;

117 
îr
;

118 
öode
 *
öode_bl
;

119 
pxt4_öode_öfo
 *
ei_bl
;

120 
qsize_t
 
size
, 
size_bl
, 
diff
;

121 
blk˙t_t
 
blocks
;

122 
byãs
;

124 
öode_bl
 = 
	`pxt4_igë
(
sb
, 
PXT4_BOOT_LOADER_INO
, 
PXT4_IGET_SPECIAL
);

125 i‡(
	`IS_ERR
(
öode_bl
))

126  
	`PTR_ERR
(
öode_bl
);

127 
ei_bl
 = 
	`PXT4_I
(
öode_bl
);

131 
	`lock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

133 i‡(
öode
->
i_∆ök
 !1 || !
	`S_ISREG
(öode->
i_mode
) ||

134 
	`IS_SWAPFILE
(
öode
Ë|| 
	`IS_ENCRYPTED
(inode) ||

135 (
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_JOURNAL_DATA_FL
) ||

136 
	`pxt4_has_ölöe_d©a
(
öode
)) {

137 
îr
 = -
EINVAL
;

138 
jou∫Æ_îr_out
;

141 i‡(
	`IS_RDONLY
(
öode
Ë|| 
	`IS_APPEND
(öodeË|| 
	`IS_IMMUTABLE
(inode) ||

142 !
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
Ë|| !
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

143 
îr
 = -
EPERM
;

144 
jou∫Æ_îr_out
;

147 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

148 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

149 i‡(
îr
)

150 
îr_out
;

152 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode_bl
->
i_m≠pög
);

153 i‡(
îr
)

154 
îr_out
;

157 
	`öode_dio_waô
(
öode
);

158 
	`öode_dio_waô
(
öode_bl
);

160 
	`åunˇã_öode_∑ges
(&
öode
->
i_d©a
, 0);

161 
	`åunˇã_öode_∑ges
(&
öode_bl
->
i_d©a
, 0);

163 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode_bl
, 
PXT4_HT_MOVE_EXTENTS
, 2);

164 i‡(
	`IS_ERR
(
h™dÀ
)) {

165 
îr
 = -
EINVAL
;

166 
îr_out
;

170 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
, 
öode_bl
);

172 i‡(
öode_bl
->
i_∆ök
 == 0) {

174 
	`£t_∆ök
(
öode_bl
, 1);

175 
	`i_uid_wrôe
(
öode_bl
, 0);

176 
	`i_gid_wrôe
(
öode_bl
, 0);

177 
öode_bl
->
i_Êags
 = 0;

178 
ei_bl
->
i_Êags
 = 0;

179 
	`öode_£t_ivîsi⁄
(
öode_bl
, 1);

180 
	`i_size_wrôe
(
öode_bl
, 0);

181 
öode_bl
->
i_mode
 = 
S_IFREG
;

182 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

183 
	`pxt4_£t_öode_Êag
(
öode_bl
, 
PXT4_INODE_EXTENTS
);

184 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode_bl
);

186 
	`mem£t
(
ei_bl
->
i_d©a
, 0, (ei_bl->i_data));

189 
îr
 = 
	`dquŸ_öôülize
(
öode
);

190 i‡(
îr
)

191 
îr_out1
;

193 
size
 = (
qsize_t
)(
öode
->
i_blocks
Ë* (1 << 9Ë+ inode->
i_byãs
;

194 
size_bl
 = (
qsize_t
)(
öode_bl
->
i_blocks
Ë* (1 << 9Ë+ inode_bl->
i_byãs
;

195 
diff
 = 
size
 - 
size_bl
;

196 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

198 
öode
->
i_˘ime
 = 
öode_bl
->i_˘imê
	`cuºít_time
(inode);

200 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

201 
öode_bl
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

202 
	`ª£t_öode_£ed
(
öode
);

203 
	`ª£t_öode_£ed
(
öode_bl
);

205 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

207 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

208 i‡(
îr
 < 0) {

210 
	`pxt4_w¨nög
(
öode
->
i_sb
,

212 
öode
->
i_öo
, 
îr
);

214 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

215 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

216 
îr_out1
;

219 
blocks
 = 
öode_bl
->
i_blocks
;

220 
byãs
 = 
öode_bl
->
i_byãs
;

221 
öode_bl
->
i_blocks
 = 
öode
->i_blocks;

222 
öode_bl
->
i_byãs
 = 
öode
->i_bytes;

223 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

224 i‡(
îr
 < 0) {

226 
	`pxt4_w¨nög
(
öode_bl
->
i_sb
,

228 
öode_bl
->
i_öo
, 
îr
);

229 
ªvît
;

233 i‡(
diff
 > 0)

234 
	`dquŸ_‰ì_•a˚
(
öode
, 
diff
);

236 
îr
 = 
	`dquŸ_Æloc_•a˚
(
öode
, -1 * 
diff
);

238 i‡(
îr
 < 0) {

239 
ªvît
:

241 
öode_bl
->
i_blocks
 = 
blocks
;

242 
öode_bl
->
i_byãs
 = 
byãs
;

243 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

244 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

245 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

248 
îr_out1
:

249 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

250 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
, 
öode_bl
);

252 
îr_out
:

253 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

254 
jou∫Æ_îr_out
:

255 
	`u∆ock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

256 
	`ùut
(
öode_bl
);

257  
îr
;

258 
	}
}

260 #ifde‡
CONFIG_FS_ENCRYPTION


261 
	$uuid_is_zîo
(
__u8
 
u
[16])

263 
i
;

265 
i
 = 0; i < 16; i++)

266 i‡(
u
[
i
])

269 
	}
}

277 
	$pxt4_io˘l_check_immuèbÀ
(
öode
 *öode, 
__u32
 
√w_¥ojid
,

278 
Êags
)

280 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

281 
ﬁdÊags
 = 
ei
->
i_Êags
;

283 i‡(!(
ﬁdÊags
 & 
PXT4_IMMUTABLE_FL
Ë|| !(
Êags
 & PXT4_IMMUTABLE_FL))

286 i‡((
ﬁdÊags
 & ~
PXT4_IMMUTABLE_FL
Ë!(
Êags
 & ~PXT4_IMMUTABLE_FL))

287  -
EPERM
;

288 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

289 
	`__k¥ojid_vÆ
(
ei
->
i_¥ojid
Ë!
√w_¥ojid
)

290  -
EPERM
;

293 
	}
}

295 
	$pxt4_io˘l_£tÊags
(
öode
 *inode,

296 
Êags
)

298 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

299 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

300 
îr
 = -
EPERM
, 
migøã
 = 0;

301 
pxt4_ûoc
 
ûoc
;

302 
ﬁdÊags
, 
mask
, 
i
;

303 
jÊag
;

304 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

307 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

308 
Êags_out
;

310 
ﬁdÊags
 = 
ei
->
i_Êags
;

313 
jÊag
 = 
Êags
 & 
PXT4_JOURNAL_DATA_FL
;

315 
îr
 = 
	`vfs_ioc_£tÊags_¥ï¨e
(
öode
, 
ﬁdÊags
, 
Êags
);

316 i‡(
îr
)

317 
Êags_out
;

323 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

324 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

325 
Êags_out
;

327 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_EXTENTS_FL
)

328 
migøã
 = 1;

330 i‡(
Êags
 & 
PXT4_EOFBLOCKS_FL
) {

332 i‡(!(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
)) {

333 
îr
 = -
EOPNOTSUPP
;

334 
Êags_out
;

336 } i‡(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
) {

337 
îr
 = 
	`pxt4_åunˇã
(
öode
);

338 i‡(
îr
)

339 
Êags_out
;

342 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_CASEFOLD_FL
) {

343 i‡(!
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

344 
îr
 = -
EOPNOTSUPP
;

345 
Êags_out
;

348 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

349 
îr
 = -
ENOTDIR
;

350 
Êags_out
;

353 i‡(!
	`pxt4_em±y_dú
(
öode
)) {

354 
îr
 = -
ENOTEMPTY
;

355 
Êags_out
;

365 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& !
	`IS_IMMUTABLE
(inode) &&

366 (
Êags
 & 
PXT4_IMMUTABLE_FL
)) {

367 
	`öode_dio_waô
(
öode
);

368 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

369 i‡(
îr
)

370 
Êags_out
;

373 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

374 i‡(
	`IS_ERR
(
h™dÀ
)) {

375 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

376 
Êags_out
;

378 i‡(
	`IS_SYNC
(
öode
))

379 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

380 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

381 i‡(
îr
)

382 
Êags_îr
;

384 
i
 = 0, 
mask
 = 1; i < 32; i++, mask <<= 1) {

385 i‡(!(
mask
 & 
PXT4_FL_USER_MODIFIABLE
))

388 i‡(
mask
 =
PXT4_JOURNAL_DATA_FL
 || mask =
PXT4_EXTENTS_FL
)

390 i‡(
mask
 & 
Êags
)

391 
	`pxt4_£t_öode_Êag
(
öode
, 
i
);

393 
	`pxt4_˛ór_öode_Êag
(
öode
, 
i
);

396 
	`pxt4_£t_öode_Êags
(
öode
);

397 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

399 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

400 
Êags_îr
:

401 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

402 i‡(
îr
)

403 
Êags_out
;

405 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

410 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DAX
)) {

411 
îr
 = -
EBUSY
;

412 
Êags_out
;

415 
îr
 = 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
, 
jÊag
);

416 i‡(
îr
)

417 
Êags_out
;

419 i‡(
migøã
) {

420 i‡(
Êags
 & 
PXT4_EXTENTS_FL
)

421 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

423 
îr
 = 
	`pxt4_öd_migøã
(
öode
);

426 
Êags_out
:

427  
îr
;

428 
	}
}

430 #ifde‡
CONFIG_QUOTA


431 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

433 
öode
 *öodê
	`fûe_öode
(
fûp
);

434 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

435 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

436 
îr
, 
rc
;

437 
h™dÀ_t
 *
h™dÀ
;

438 
k¥ojid_t
 
k¥ojid
;

439 
pxt4_ûoc
 
ûoc
;

440 
pxt4_öode
 *
øw_öode
;

441 
dquŸ
 *
å™s„r_to
[
MAXQUOTAS
] = { };

443 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
sb
)) {

444 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

445  -
EOPNOTSUPP
;

450 i‡(
	`PXT4_INODE_SIZE
(
sb
Ë<
PXT4_GOOD_OLD_INODE_SIZE
)

451  -
EOPNOTSUPP
;

453 
k¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, (
¥ojid_t
)
¥ojid
);

455 i‡(
	`¥ojid_eq
(
k¥ojid
, 
	`PXT4_I
(
öode
)->
i_¥ojid
))

458 
îr
 = -
EPERM
;

460 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

461  
îr
;

463 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

464 i‡(
îr
)

465  
îr
;

467 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

468 i‡(!
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
)) {

469 
îr
 = 
	`pxt4_ex∑nd_exåa_isize
(
öode
,

470 
	`PXT4_SB
(
sb
)->
s_w™t_exåa_isize
,

471 &
ûoc
);

472 i‡(
îr
)

473  
îr
;

475 
	`bªl£
(
ûoc
.
bh
);

478 
îr
 = 
	`dquŸ_öôülize
(
öode
);

479 i‡(
îr
)

480  
îr
;

482 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

483 
	`PXT4_QUOTA_INIT_BLOCKS
(
sb
) +

484 
	`PXT4_QUOTA_DEL_BLOCKS
(
sb
) + 3);

485 i‡(
	`IS_ERR
(
h™dÀ
))

486  
	`PTR_ERR
(
h™dÀ
);

488 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

489 i‡(
îr
)

490 
out_°›
;

492 
å™s„r_to
[
PRJQUOTA
] = 
	`dqgë
(
sb
, 
	`make_kqid_¥ojid
(
k¥ojid
));

493 i‡(!
	`IS_ERR
(
å™s„r_to
[
PRJQUOTA
])) {

498 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

499 
îr
 = 
	`__dquŸ_å™s„r
(
öode
, 
å™s„r_to
);

500 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

501 
	`dqput
(
å™s„r_to
[
PRJQUOTA
]);

502 i‡(
îr
)

503 
out_dúty
;

506 
	`PXT4_I
(
öode
)->
i_¥ojid
 = 
k¥ojid
;

507 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

508 
out_dúty
:

509 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

510 i‡(!
îr
)

511 
îr
 = 
rc
;

512 
out_°›
:

513 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

514  
îr
;

515 
	}
}

517 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

519 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

520  -
EOPNOTSUPP
;

522 
	}
}

526 
ölöe
 
__u32
 
	$pxt4_iÊags_to_xÊags
(
iÊags
)

528 
__u32
 
xÊags
 = 0;

530 i‡(
iÊags
 & 
PXT4_SYNC_FL
)

531 
xÊags
 |
FS_XFLAG_SYNC
;

532 i‡(
iÊags
 & 
PXT4_IMMUTABLE_FL
)

533 
xÊags
 |
FS_XFLAG_IMMUTABLE
;

534 i‡(
iÊags
 & 
PXT4_APPEND_FL
)

535 
xÊags
 |
FS_XFLAG_APPEND
;

536 i‡(
iÊags
 & 
PXT4_NODUMP_FL
)

537 
xÊags
 |
FS_XFLAG_NODUMP
;

538 i‡(
iÊags
 & 
PXT4_NOATIME_FL
)

539 
xÊags
 |
FS_XFLAG_NOATIME
;

540 i‡(
iÊags
 & 
PXT4_PROJINHERIT_FL
)

541 
xÊags
 |
FS_XFLAG_PROJINHERIT
;

542  
xÊags
;

543 
	}
}

545 
	#PXT4_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

546 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

547 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

550 
ölöe
 
	$pxt4_xÊags_to_iÊags
(
__u32
 
xÊags
)

552 
iÊags
 = 0;

554 i‡(
xÊags
 & 
FS_XFLAG_SYNC
)

555 
iÊags
 |
PXT4_SYNC_FL
;

556 i‡(
xÊags
 & 
FS_XFLAG_IMMUTABLE
)

557 
iÊags
 |
PXT4_IMMUTABLE_FL
;

558 i‡(
xÊags
 & 
FS_XFLAG_APPEND
)

559 
iÊags
 |
PXT4_APPEND_FL
;

560 i‡(
xÊags
 & 
FS_XFLAG_NODUMP
)

561 
iÊags
 |
PXT4_NODUMP_FL
;

562 i‡(
xÊags
 & 
FS_XFLAG_NOATIME
)

563 
iÊags
 |
PXT4_NOATIME_FL
;

564 i‡(
xÊags
 & 
FS_XFLAG_PROJINHERIT
)

565 
iÊags
 |
PXT4_PROJINHERIT_FL
;

567  
iÊags
;

568 
	}
}

570 
	$pxt4_shutdown
(
su≥r_block
 *
sb
, 
¨g
)

572 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

573 
__u32
 
Êags
;

575 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

576  -
EPERM
;

578 i‡(
	`gë_u£r
(
Êags
, (
__u32
 
__u£r
 *)
¨g
))

579  -
EFAULT
;

581 i‡(
Êags
 > 
PXT4_GOING_FLAGS_NOLOGFLUSH
)

582  -
EINVAL
;

584 i‡(
	`pxt4_f‹˚d_shutdown
(
sbi
))

587 
	`pxt4_msg
(
sb
, 
KERN_ALERT
, "shuàdow¿ªque°ed (%d)", 
Êags
);

588 
	`åa˚_pxt4_shutdown
(
sb
, 
Êags
);

590 
Êags
) {

591 
PXT4_GOING_FLAGS_DEFAULT
:

592 
	`‰ìze_bdev
(
sb
->
s_bdev
);

593 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

594 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

596 
PXT4_GOING_FLAGS_LOGFLUSH
:

597 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

598 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal)) {

599 (Ë
	`pxt4_f‹˚_commô
(
sb
);

600 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

603 
PXT4_GOING_FLAGS_NOLOGFLUSH
:

604 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

605 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal))

606 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

609  -
EINVAL
;

611 
	`˛ór_›t
(
sb
, 
DISCARD
);

613 
	}
}

615 
	sgëfsm≠_öfo
 {

616 
su≥r_block
 *
	mgi_sb
;

617 
fsm≠_hód
 
__u£r
 *
	mgi_d©a
;

618 
	mgi_idx
;

619 
__u32
 
	mgi_œ°_Êags
;

622 
	$pxt4_gëfsm≠_f‹m©
(
pxt4_fsm≠
 *
xfm
, *
¥iv
)

624 
gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

625 
fsm≠
 
fm
;

627 
	`åa˚_pxt4_gëfsm≠_m≠pög
(
öfo
->
gi_sb
, 
xfm
);

629 
öfo
->
gi_œ°_Êags
 = 
xfm
->
fmr_Êags
;

630 
	`pxt4_fsm≠_‰om_öã∫Æ
(
öfo
->
gi_sb
, &
fm
, 
xfm
);

631 i‡(
	`c›y_to_u£r
(&
öfo
->
gi_d©a
->
fmh_ªcs
[öfo->
gi_idx
++], &
fm
,

632 (
fsm≠
)))

633  -
EFAULT
;

636 
	}
}

638 
	$pxt4_ioc_gëfsm≠
(
su≥r_block
 *
sb
,

639 
fsm≠_hód
 
__u£r
 *
¨g
)

641 
gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

642 
pxt4_fsm≠_hód
 
xhód
 = {0};

643 
fsm≠_hód
 
hód
;

644 
boﬁ
 
ab‹ãd
 = 
Ál£
;

645 
îr‹
;

647 i‡(
	`c›y_‰om_u£r
(&
hód
, 
¨g
, (
fsm≠_hód
)))

648  -
EFAULT
;

649 i‡(
	`memchr_öv
(
hód
.
fmh_ª£rved
, 0, (head.fmh_reserved)) ||

650 
	`memchr_öv
(
hód
.
fmh_keys
[0].
fmr_ª£rved
, 0,

651 (
hód
.
fmh_keys
[0].
fmr_ª£rved
)) ||

652 
	`memchr_öv
(
hód
.
fmh_keys
[1].
fmr_ª£rved
, 0,

653 (
hód
.
fmh_keys
[1].
fmr_ª£rved
)))

654  -
EINVAL
;

659 i‡(
hód
.
fmh_keys
[0].
fmr_off£t
 ||

660 (
hód
.
fmh_keys
[1].
fmr_off£t
 != 0 &&

661 
hód
.
fmh_keys
[1].
fmr_off£t
 != -1ULL))

662  -
EINVAL
;

664 
xhód
.
fmh_iÊags
 = 
hód
.fmh_iflags;

665 
xhód
.
fmh_cou¡
 = 
hód
.fmh_count;

666 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[0], &
hód
.fmh_keys[0]);

667 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[1], &
hód
.fmh_keys[1]);

669 
	`åa˚_pxt4_gëfsm≠_low_key
(
sb
, &
xhód
.
fmh_keys
[0]);

670 
	`åa˚_pxt4_gëfsm≠_high_key
(
sb
, &
xhód
.
fmh_keys
[1]);

672 
öfo
.
gi_sb
 = 
sb
;

673 
öfo
.
gi_d©a
 = 
¨g
;

674 
îr‹
 = 
	`pxt4_gëfsm≠
(
sb
, &
xhód
, 
pxt4_gëfsm≠_f‹m©
, &
öfo
);

675 i‡(
îr‹
 =
PXT4_QUERY_RANGE_ABORT
) {

676 
îr‹
 = 0;

677 
ab‹ãd
 = 
åue
;

678 } i‡(
îr‹
)

679  
îr‹
;

682 i‡(!
ab‹ãd
 && 
öfo
.
gi_idx
) {

683 
öfo
.
gi_œ°_Êags
 |
FMR_OF_LAST
;

684 i‡(
	`c›y_to_u£r
(&
öfo
.
gi_d©a
->
fmh_ªcs
[öfo.
gi_idx
 - 1].
fmr_Êags
,

685 &
öfo
.
gi_œ°_Êags
,

686 (
öfo
.
gi_œ°_Êags
)))

687  -
EFAULT
;

691 
hód
.
fmh_íåõs
 = 
xhód
.fmh_entries;

692 
hód
.
fmh_oÊags
 = 
xhód
.fmh_oflags;

693 i‡(
	`c›y_to_u£r
(
¨g
, &
hód
, (
fsm≠_hód
)))

694  -
EFAULT
;

697 
	}
}

699 
	$pxt4_io˘l_group_add
(
fûe
 *file,

700 
pxt4_√w_group_d©a
 *
öput
)

702 
su≥r_block
 *
sb
 = 
	`fûe_öode
(
fûe
)->
i_sb
;

703 
îr
, 
îr2
=0;

705 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

706 i‡(
îr
)

707  
îr
;

709 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

710 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

712 
îr
 = -
EOPNOTSUPP
;

713 
group_add_out
;

716 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

717 i‡(
îr
)

718 
group_add_out
;

720 
îr
 = 
	`pxt4_group_add
(
sb
, 
öput
);

721 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

722 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

723 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

724 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

726 i‡(
îr
 == 0)

727 
îr
 = 
îr2
;

728 
	`m¡_dr›_wrôe_fûe
(
fûe
);

729 i‡(!
îr
 && 
	`pxt4_has_group_desc_csum
(
sb
) &&

730 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

731 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
öput
->
group
);

732 
group_add_out
:

733 
	`pxt4_ªsize_íd
(
sb
);

734  
îr
;

735 
	}
}

737 
	$pxt4_fûl_fsx©å
(
öode
 *öode, 
fsx©å
 *
Á
)

739 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

741 
	`sim∂e_fûl_fsx©å
(
Á
, 
	`pxt4_iÊags_to_xÊags
(
ei
->
i_Êags
 &

742 
PXT4_FL_USER_VISIBLE
));

744 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

745 
Á
->
fsx_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
);

746 
	}
}

749 
	$fõm≠_check_ønges
(
su≥r_block
 *
sb
,

750 
u64
 
°¨t
, u64 
Àn
, u64 *
√w_Àn
)

752 
u64
 
maxbyãs
 = (u64Ë
sb
->
s_maxbyãs
;

754 *
√w_Àn
 = 
Àn
;

756 i‡(
Àn
 == 0)

757  -
EINVAL
;

759 i‡(
°¨t
 > 
maxbyãs
)

760  -
EFBIG
;

765 i‡(
Àn
 > 
maxbyãs
 || (maxbyã†-ÜíË< 
°¨t
)

766 *
√w_Àn
 = 
maxbyãs
 - 
°¨t
;

769 
	}
}

772 
	#FIEMAP_MAX_EXTENTS
 (
UINT_MAX
 / (
fõm≠_exã¡
))

	)

774 
	$pxt4_io˘l_gë_es_ˇche
(
fûe
 *
fûp
, 
¨g
)

776 
fõm≠
 fiemap;

777 
fõm≠
 
__u£r
 *
ufõm≠
 = (fõm≠ __u£∏*Ë
¨g
;

778 
fõm≠_exã¡_öfo
 
fõöfo
 = { 0, };

779 
öode
 *öodê
	`fûe_öode
(
fûp
);

780 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

781 
u64
 
Àn
;

782 
îr‹
;

784 i‡(
	`c›y_‰om_u£r
(&
fõm≠
, 
ufõm≠
, (fiemap)))

785  -
EFAULT
;

787 i‡(
fõm≠
.
fm_exã¡_cou¡
 > 
FIEMAP_MAX_EXTENTS
)

788  -
EINVAL
;

790 
îr‹
 = 
	`fõm≠_check_ønges
(
sb
, 
fõm≠
.
fm_°¨t
, fõm≠.
fm_Àngth
,

791 &
Àn
);

792 i‡(
îr‹
)

793  
îr‹
;

795 
fõöfo
.
fi_Êags
 = 
fõm≠
.
fm_Êags
;

796 
fõöfo
.
fi_exã¡s_max
 = 
fõm≠
.
fm_exã¡_cou¡
;

797 
fõöfo
.
fi_exã¡s_°¨t
 = 
ufõm≠
->
fm_exã¡s
;

799 i‡(
fõm≠
.
fm_exã¡_cou¡
 != 0 &&

800 !
	`ac˚ss_ok
(
fõöfo
.
fi_exã¡s_°¨t
,

801 
fõöfo
.
fi_exã¡s_max
 * (
fõm≠_exã¡
)))

802  -
EFAULT
;

804 i‡(
fõöfo
.
fi_Êags
 & 
FIEMAP_FLAG_SYNC
)

805 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

807 
îr‹
 = 
	`pxt4_gë_es_ˇche
(
öode
, &
fõöfo
, 
fõm≠
.
fm_°¨t
, 
Àn
);

808 
fõm≠
.
fm_Êags
 = 
fõöfo
.
fi_Êags
;

809 
fõm≠
.
fm_m≠≥d_exã¡s
 = 
fõöfo
.
fi_exã¡s_m≠≥d
;

810 i‡(
	`c›y_to_u£r
(
ufõm≠
, &
fõm≠
, (fiemap)))

811 
îr‹
 = -
EFAULT
;

813  
îr‹
;

814 
	}
}

816 
	$pxt4_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
)

818 
öode
 *öodê
	`fûe_öode
(
fûp
);

819 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

820 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

821 
Êags
;

823 
	`pxt4_debug
("cmd = %u,árg = %lu\n", 
cmd
, 
¨g
);

825 
cmd
) {

826 
FS_IOC_GETFSMAP
:

827  
	`pxt4_ioc_gëfsm≠
(
sb
, (
__u£r
 *)
¨g
);

828 
PXT4_IOC_GETFLAGS
:

829 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

830 i‡(
	`S_ISREG
(
öode
->
i_mode
))

831 
Êags
 &~
PXT4_PROJINHERIT_FL
;

832  
	`put_u£r
(
Êags
, (
__u£r
 *Ë
¨g
);

833 
PXT4_IOC_SETFLAGS
: {

834 
îr
;

836 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

837  -
EACCES
;

839 i‡(
	`gë_u£r
(
Êags
, (
__u£r
 *Ë
¨g
))

840  -
EFAULT
;

842 i‡(
Êags
 & ~
PXT4_FL_USER_VISIBLE
)

843  -
EOPNOTSUPP
;

850 
Êags
 &
PXT4_FL_USER_MODIFIABLE
;

851 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

852  -
EOPNOTSUPP
;

854 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

855 i‡(
îr
)

856  
îr
;

858 
	`öode_lock
(
öode
);

859 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
,

860 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
),

861 
Êags
);

862 i‡(!
îr
)

863 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

864 
	`öode_u∆ock
(
öode
);

865 
	`m¡_dr›_wrôe_fûe
(
fûp
);

866  
îr
;

868 
PXT4_IOC_GETVERSION
:

869 
PXT4_IOC_GETVERSION_OLD
:

870  
	`put_u£r
(
öode
->
i_gíî©i⁄
, (
__u£r
 *Ë
¨g
);

871 
PXT4_IOC_SETVERSION
:

872 
PXT4_IOC_SETVERSION_OLD
: {

873 
h™dÀ_t
 *
h™dÀ
;

874 
pxt4_ûoc
 
ûoc
;

875 
__u32
 
gíî©i⁄
;

876 
îr
;

878 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

879  -
EPERM
;

881 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

882 
	`pxt4_w¨nög
(
sb
, "Setting inode version isÇot "

884  -
ENOTTY
;

887 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

888 i‡(
îr
)

889  
îr
;

890 i‡(
	`gë_u£r
(
gíî©i⁄
, (
__u£r
 *Ë
¨g
)) {

891 
îr
 = -
EFAULT
;

892 
£tvîsi⁄_out
;

895 
	`öode_lock
(
öode
);

896 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

897 i‡(
	`IS_ERR
(
h™dÀ
)) {

898 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

899 
u∆ock_out
;

901 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

902 i‡(
îr
 == 0) {

903 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

904 
öode
->
i_gíî©i⁄
 = 
gíî©i⁄
;

905 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

907 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

909 
u∆ock_out
:

910 
	`öode_u∆ock
(
öode
);

911 
£tvîsi⁄_out
:

912 
	`m¡_dr›_wrôe_fûe
(
fûp
);

913  
îr
;

915 
PXT4_IOC_GROUP_EXTEND
: {

916 
pxt4_fsblk_t
 
n_blocks_cou¡
;

917 
îr
, 
îr2
=0;

919 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

920 i‡(
îr
)

921  
îr
;

923 i‡(
	`gë_u£r
(
n_blocks_cou¡
, (
__u32
 
__u£r
 *)
¨g
)) {

924 
îr
 = -
EFAULT
;

925 
group_exãnd_out
;

928 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

929 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

931 
îr
 = -
EOPNOTSUPP
;

932 
group_exãnd_out
;

935 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

936 i‡(
îr
)

937 
group_exãnd_out
;

939 
îr
 = 
	`pxt4_group_exãnd
(
sb
, 
	`PXT4_SB
(sb)->
s_es
, 
n_blocks_cou¡
);

940 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

941 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

942 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

943 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

945 i‡(
îr
 == 0)

946 
îr
 = 
îr2
;

947 
	`m¡_dr›_wrôe_fûe
(
fûp
);

948 
group_exãnd_out
:

949 
	`pxt4_ªsize_íd
(
sb
);

950  
îr
;

953 
PXT4_IOC_MOVE_EXT
: {

954 
move_exã¡
 
me
;

955 
fd
 
d⁄‹
;

956 
îr
;

958 i‡(!(
fûp
->
f_mode
 & 
FMODE_READ
) ||

959 !(
fûp
->
f_mode
 & 
FMODE_WRITE
))

960  -
EBADF
;

962 i‡(
	`c›y_‰om_u£r
(&
me
,

963 (
move_exã¡
 
__u£r
 *)
¨g
, (
me
)))

964  -
EFAULT
;

965 
me
.
moved_Àn
 = 0;

967 
d⁄‹
 = 
	`fdgë
(
me
.
d⁄‹_fd
);

968 i‡(!
d⁄‹
.
fûe
)

969  -
EBADF
;

971 i‡(!(
d⁄‹
.
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

972 
îr
 = -
EBADF
;

973 
mext_out
;

976 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

977 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

979 
îr
 = -
EOPNOTSUPP
;

980 
mext_out
;

981 } i‡(
	`IS_DAX
(
öode
)) {

982 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

984 
îr
 = -
EOPNOTSUPP
;

985 
mext_out
;

988 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

989 i‡(
îr
)

990 
mext_out
;

992 
îr
 = 
	`pxt4_move_exã¡s
(
fûp
, 
d⁄‹
.
fûe
, 
me
.
‹ig_°¨t
,

993 
me
.
d⁄‹_°¨t
, me.
Àn
, &me.
moved_Àn
);

994 
	`m¡_dr›_wrôe_fûe
(
fûp
);

996 i‡(
	`c›y_to_u£r
((
move_exã¡
 
__u£r
 *)
¨g
,

997 &
me
, (me)))

998 
îr
 = -
EFAULT
;

999 
mext_out
:

1000 
	`fdput
(
d⁄‹
);

1001  
îr
;

1004 
PXT4_IOC_GROUP_ADD
: {

1005 
pxt4_√w_group_d©a
 
öput
;

1007 i‡(
	`c›y_‰om_u£r
(&
öput
, (
pxt4_√w_group_öput
 
__u£r
 *)
¨g
,

1008 (
öput
)))

1009  -
EFAULT
;

1011  
	`pxt4_io˘l_group_add
(
fûp
, &
öput
);

1014 
PXT4_IOC_MIGRATE
:

1016 
îr
;

1017 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1018  -
EACCES
;

1020 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1021 i‡(
îr
)

1022  
îr
;

1029 
	`öode_lock
((
öode
));

1030 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

1031 
	`öode_u∆ock
((
öode
));

1032 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1033  
îr
;

1036 
PXT4_IOC_ALLOC_DA_BLKS
:

1038 
îr
;

1039 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1040  -
EACCES
;

1042 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1043 i‡(
îr
)

1044  
îr
;

1045 
îr
 = 
	`pxt4_Æloc_da_blocks
(
öode
);

1046 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1047  
îr
;

1050 
PXT4_IOC_SWAP_BOOT
:

1052 
îr
;

1053 i‡(!(
fûp
->
f_mode
 & 
FMODE_WRITE
))

1054  -
EBADF
;

1055 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1056 i‡(
îr
)

1057  
îr
;

1058 
îr
 = 
	`sw≠_öode_boŸ_lﬂdî
(
sb
, 
öode
);

1059 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1060  
îr
;

1063 
PXT4_IOC_RESIZE_FS
: {

1064 
pxt4_fsblk_t
 
n_blocks_cou¡
;

1065 
îr
 = 0, 
îr2
 = 0;

1066 
pxt4_group_t
 
o_group
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

1068 i‡(
	`c›y_‰om_u£r
(&
n_blocks_cou¡
, (
__u64
 
__u£r
 *)
¨g
,

1069 (
__u64
))) {

1070  -
EFAULT
;

1073 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

1074 i‡(
îr
)

1075  
îr
;

1077 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1078 i‡(
îr
)

1079 
ªsizefs_out
;

1081 
îr
 = 
	`pxt4_ªsize_fs
(
sb
, 
n_blocks_cou¡
);

1082 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

1083 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1084 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1085 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1087 i‡(
îr
 == 0)

1088 
îr
 = 
îr2
;

1089 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1090 i‡(!
îr
 && (
o_group
 < 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
) &&

1091 
	`pxt4_has_group_desc_csum
(
sb
) &&

1092 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1093 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
o_group
);

1095 
ªsizefs_out
:

1096 
	`pxt4_ªsize_íd
(
sb
);

1097  
îr
;

1100 
FITRIM
:

1102 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

1103 
f°rim_ønge
 
ønge
;

1104 
ªt
 = 0;

1106 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1107  -
EPERM
;

1109 i‡(!
	`blk_queue_disˇrd
(
q
))

1110  -
EOPNOTSUPP
;

1116 i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb))

1117  -
EROFS
;

1119 i‡(
	`c›y_‰om_u£r
(&
ønge
, (
f°rim_ønge
 
__u£r
 *)
¨g
,

1120 (
ønge
)))

1121  -
EFAULT
;

1123 
ønge
.
möÀn
 = 
	`max
(()range.minlen,

1124 
q
->
limôs
.
disˇrd_gønuœrôy
);

1125 
ªt
 = 
	`pxt4_åim_fs
(
sb
, &
ønge
);

1126 i‡(
ªt
 < 0)

1127  
ªt
;

1129 i‡(
	`c›y_to_u£r
((
f°rim_ønge
 
__u£r
 *)
¨g
, &
ønge
,

1130 (
ønge
)))

1131  -
EFAULT
;

1135 
PXT4_IOC_PRECACHE_EXTENTS
:

1136  
	`pxt4_ext_¥eˇche
(
öode
);

1138 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1139 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1140  -
EOPNOTSUPP
;

1141  
	`fs¸y±_io˘l_£t_pﬁicy
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1143 
PXT4_IOC_GET_ENCRYPTION_PWSALT
: {

1144 #ifde‡
CONFIG_FS_ENCRYPTION


1145 
îr
, 
îr2
;

1146 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1147 
h™dÀ_t
 *
h™dÀ
;

1149 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1150  -
EOPNOTSUPP
;

1151 i‡(
	`uuid_is_zîo
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
)) {

1152 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1153 i‡(
îr
)

1154  
îr
;

1155 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1156 i‡(
	`IS_ERR
(
h™dÀ
)) {

1157 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1158 
pwß…_îr_exô
;

1160 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1161 i‡(
îr
)

1162 
pwß…_îr_jou∫Æ
;

1163 
	`gíî©e_øndom_uuid
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
);

1164 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1165 
sbi
->
s_sbh
);

1166 
pwß…_îr_jou∫Æ
:

1167 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1168 i‡(
îr2
 && !
îr
)

1169 
îr
 = 
îr2
;

1170 
pwß…_îr_exô
:

1171 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1172 i‡(
îr
)

1173  
îr
;

1175 i‡(
	`c›y_to_u£r
((
__u£r
 *Ë
¨g
,

1176 
sbi
->
s_es
->
s_í¸y±_pw_ß…
, 16))

1177  -
EFAULT
;

1180  -
EOPNOTSUPP
;

1183 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1184 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1185  -
EOPNOTSUPP
;

1186  
	`fs¸y±_io˘l_gë_pﬁicy
(
fûp
, (
__u£r
 *)
¨g
);

1188 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1189 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1190  -
EOPNOTSUPP
;

1191  
	`fs¸y±_io˘l_gë_pﬁicy_ex
(
fûp
, (
__u£r
 *)
¨g
);

1193 
FS_IOC_ADD_ENCRYPTION_KEY
:

1194 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1195  -
EOPNOTSUPP
;

1196  
	`fs¸y±_io˘l_add_key
(
fûp
, (
__u£r
 *)
¨g
);

1198 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1199 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1200  -
EOPNOTSUPP
;

1201  
	`fs¸y±_io˘l_ªmove_key
(
fûp
, (
__u£r
 *)
¨g
);

1203 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1204 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1205  -
EOPNOTSUPP
;

1206  
	`fs¸y±_io˘l_ªmove_key_Æl_u£rs
(
fûp
,

1207 (
__u£r
 *)
¨g
);

1208 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1209 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1210  -
EOPNOTSUPP
;

1211  
	`fs¸y±_io˘l_gë_key_°©us
(
fûp
, (
__u£r
 *)
¨g
);

1213 
PXT4_IOC_CLEAR_ES_CACHE
:

1215 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1216  -
EACCES
;

1217 
	`pxt4_˛ór_öode_es
(
öode
);

1221 
PXT4_IOC_GETSTATE
:

1223 
__u32
 
°©e
 = 0;

1225 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
))

1226 
°©e
 |
PXT4_STATE_FLAG_EXT_PRECACHED
;

1227 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

1228 
°©e
 |
PXT4_STATE_FLAG_NEW
;

1229 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

1230 
°©e
 |
PXT4_STATE_FLAG_NEWENTRY
;

1231 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
))

1232 
°©e
 |
PXT4_STATE_FLAG_DA_ALLOC_CLOSE
;

1234  
	`put_u£r
(
°©e
, (
__u32
 
__u£r
 *Ë
¨g
);

1237 
PXT4_IOC_GET_ES_CACHE
:

1238  
	`pxt4_io˘l_gë_es_ˇche
(
fûp
, 
¨g
);

1240 
PXT4_IOC_FSGETXATTR
:

1242 
fsx©å
 
Á
;

1244 
	`pxt4_fûl_fsx©å
(
öode
, &
Á
);

1246 i‡(
	`c›y_to_u£r
((
fsx©å
 
__u£r
 *)
¨g
,

1247 &
Á
, (fa)))

1248  -
EFAULT
;

1251 
PXT4_IOC_FSSETXATTR
:

1253 
fsx©å
 
Á
, 
ﬁd_Á
;

1254 
îr
;

1256 i‡(
	`c›y_‰om_u£r
(&
Á
, (
fsx©å
 
__u£r
 *)
¨g
,

1257 (
Á
)))

1258  -
EFAULT
;

1261 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1262  -
EACCES
;

1264 i‡(
Á
.
fsx_xÊags
 & ~
PXT4_SUPPORTED_FS_XFLAGS
)

1265  -
EOPNOTSUPP
;

1267 
Êags
 = 
	`pxt4_xÊags_to_iÊags
(
Á
.
fsx_xÊags
);

1268 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

1269  -
EOPNOTSUPP
;

1271 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1272 i‡(
îr
)

1273  
îr
;

1275 
	`öode_lock
(
öode
);

1276 
	`pxt4_fûl_fsx©å
(
öode
, &
ﬁd_Á
);

1277 
îr
 = 
	`vfs_ioc_fs£tx©å_check
(
öode
, &
ﬁd_Á
, &
Á
);

1278 i‡(
îr
)

1279 
out
;

1280 
Êags
 = (
ei
->
i_Êags
 & ~
PXT4_FL_XFLAG_VISIBLE
) |

1281 (
Êags
 & 
PXT4_FL_XFLAG_VISIBLE
);

1282 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
, 
Á
.
fsx_¥ojid
, 
Êags
);

1283 i‡(
îr
)

1284 
out
;

1285 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

1286 i‡(
îr
)

1287 
out
;

1288 
îr
 = 
	`pxt4_io˘l_£çroje˘
(
fûp
, 
Á
.
fsx_¥ojid
);

1289 
out
:

1290 
	`öode_u∆ock
(
öode
);

1291 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1292  
îr
;

1294 
PXT4_IOC_SHUTDOWN
:

1295  
	`pxt4_shutdown
(
sb
, 
¨g
);

1297 
FS_IOC_ENABLE_VERITY
:

1298 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1299  -
EOPNOTSUPP
;

1300  
	`fsvîôy_io˘l_íabÀ
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1302 
FS_IOC_MEASURE_VERITY
:

1303 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1304  -
EOPNOTSUPP
;

1305  
	`fsvîôy_io˘l_mósuª
(
fûp
, (
__u£r
 *)
¨g
);

1308  -
ENOTTY
;

1310 
	}
}

1312 #ifde‡
CONFIG_COMPAT


1313 
	$pxt4_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
)

1316 
cmd
) {

1317 
PXT4_IOC32_GETFLAGS
:

1318 
cmd
 = 
PXT4_IOC_GETFLAGS
;

1320 
PXT4_IOC32_SETFLAGS
:

1321 
cmd
 = 
PXT4_IOC_SETFLAGS
;

1323 
PXT4_IOC32_GETVERSION
:

1324 
cmd
 = 
PXT4_IOC_GETVERSION
;

1326 
PXT4_IOC32_SETVERSION
:

1327 
cmd
 = 
PXT4_IOC_SETVERSION
;

1329 
PXT4_IOC32_GROUP_EXTEND
:

1330 
cmd
 = 
PXT4_IOC_GROUP_EXTEND
;

1332 
PXT4_IOC32_GETVERSION_OLD
:

1333 
cmd
 = 
PXT4_IOC_GETVERSION_OLD
;

1335 
PXT4_IOC32_SETVERSION_OLD
:

1336 
cmd
 = 
PXT4_IOC_SETVERSION_OLD
;

1338 
PXT4_IOC32_GETRSVSZ
:

1339 
cmd
 = 
PXT4_IOC_GETRSVSZ
;

1341 
PXT4_IOC32_SETRSVSZ
:

1342 
cmd
 = 
PXT4_IOC_SETRSVSZ
;

1344 
PXT4_IOC32_GROUP_ADD
: {

1345 
com∑t_pxt4_√w_group_öput
 
__u£r
 *
uöput
;

1346 
pxt4_√w_group_d©a
 
öput
;

1347 
îr
;

1349 
uöput
 = 
	`com∑t_±r
(
¨g
);

1350 
îr
 = 
	`gë_u£r
(
öput
.
group
, &
uöput
->group);

1351 
îr
 |
	`gë_u£r
(
öput
.
block_bôm≠
, &
uöput
->block_bitmap);

1352 
îr
 |
	`gë_u£r
(
öput
.
öode_bôm≠
, &
uöput
->inode_bitmap);

1353 
îr
 |
	`gë_u£r
(
öput
.
öode_èbÀ
, &
uöput
->inode_table);

1354 
îr
 |
	`gë_u£r
(
öput
.
blocks_cou¡
, &
uöput
->blocks_count);

1355 
îr
 |
	`gë_u£r
(
öput
.
ª£rved_blocks
,

1356 &
uöput
->
ª£rved_blocks
);

1357 i‡(
îr
)

1358  -
EFAULT
;

1359  
	`pxt4_io˘l_group_add
(
fûe
, &
öput
);

1361 
PXT4_IOC_MOVE_EXT
:

1362 
PXT4_IOC_RESIZE_FS
:

1363 
PXT4_IOC_PRECACHE_EXTENTS
:

1364 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1365 
PXT4_IOC_GET_ENCRYPTION_PWSALT
:

1366 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1367 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1368 
FS_IOC_ADD_ENCRYPTION_KEY
:

1369 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1370 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1371 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1372 
PXT4_IOC_SHUTDOWN
:

1373 
FS_IOC_GETFSMAP
:

1374 
FS_IOC_ENABLE_VERITY
:

1375 
FS_IOC_MEASURE_VERITY
:

1376 
PXT4_IOC_CLEAR_ES_CACHE
:

1377 
PXT4_IOC_GETSTATE
:

1378 
PXT4_IOC_GET_ES_CACHE
:

1381  -
ENOIOCTLCMD
;

1383  
	`pxt4_io˘l
(
fûe
, 
cmd
, (Ë
	`com∑t_±r
(
¨g
));

1384 
	}
}

	@mballoc.c

12 
	~"pxt4_jbd3.h
"

13 
	~"mbÆloc.h
"

14 
	~<löux/log2.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/no•ec.h
>

18 
	~<löux/backög-dev.h
>

19 
	~<åa˚/evíts/pxt4.h
>

21 #ifde‡
CONFIG_PXT4_DEBUG


22 
ush‹t
 
pxt4_mbÆloc_debug
 
	g__ªad_mo°ly
;

24 
moduÀ_∑øm_«med
(
mbÆloc_debug
, 
pxt4_mbÆloc_debug
, 
ush‹t
, 0644);

25 
MODULE_PARM_DESC
(
mbÆloc_debug
, "DebuggingÜevel forÖxt4's mballoc");

339 
kmem_ˇche
 *
	gpxt4_p•a˚_ˇchï
;

340 
kmem_ˇche
 *
	gpxt4_ac_ˇchï
;

341 
kmem_ˇche
 *
	gpxt4_‰ì_d©a_ˇchï
;

346 
	#NR_GRPINFO_CACHES
 8

	)

347 
kmem_ˇche
 *
	gpxt4_groupöfo_ˇches
[
NR_GRPINFO_CACHES
];

349 c⁄° * c⁄° 
	gpxt4_groupöfo_¶ab_«mes
[
NR_GRPINFO_CACHES
] = {

355 
pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

356 
pxt4_group_t
 
group
);

357 
pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

358 
pxt4_group_t
 
group
);

360 
ölöe
 *
	$mb_c‹ª˘_addr_™d_bô
(*
bô
, *
addr
)

362 #i‡
BITS_PER_LONG
 == 64

363 *
bô
 +((Ë
addr
 & 7UL) << 3;

364 
addr
 = (*) (()áddr & ~7UL);

365 #ñi‡
BITS_PER_LONG
 == 32

366 *
bô
 +((Ë
addr
 & 3UL) << 3;

367 
addr
 = (*) (()áddr & ~3UL);

371  
addr
;

372 
	}
}

374 
ölöe
 
	$mb_ã°_bô
(
bô
, *
addr
)

380 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

381  
	`pxt4_ã°_bô
(
bô
, 
addr
);

382 
	}
}

384 
ölöe
 
	$mb_£t_bô
(
bô
, *
addr
)

386 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

387 
	`pxt4_£t_bô
(
bô
, 
addr
);

388 
	}
}

390 
ölöe
 
	$mb_˛ór_bô
(
bô
, *
addr
)

392 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

393 
	`pxt4_˛ór_bô
(
bô
, 
addr
);

394 
	}
}

396 
ölöe
 
	$mb_ã°_™d_˛ór_bô
(
bô
, *
addr
)

398 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

399  
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
addr
);

400 
	}
}

402 
ölöe
 
	$mb_föd_√xt_zîo_bô
(*
addr
, 
max
, 
°¨t
)

404 
fix
 = 0, 
ªt
, 
tmpmax
;

405 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

406 
tmpmax
 = 
max
 + 
fix
;

407 
°¨t
 +
fix
;

409 
ªt
 = 
	`pxt4_föd_√xt_zîo_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

410 i‡(
ªt
 > 
max
)

411  
max
;

412  
ªt
;

413 
	}
}

415 
ölöe
 
	$mb_föd_√xt_bô
(*
addr
, 
max
, 
°¨t
)

417 
fix
 = 0, 
ªt
, 
tmpmax
;

418 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

419 
tmpmax
 = 
max
 + 
fix
;

420 
°¨t
 +
fix
;

422 
ªt
 = 
	`pxt4_föd_√xt_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

423 i‡(
ªt
 > 
max
)

424  
max
;

425  
ªt
;

426 
	}
}

428 *
	$mb_föd_buddy
(
pxt4_buddy
 *
e4b
, 
‹dî
, *
max
)

430 *
bb
;

432 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

433 
	`BUG_ON
(
max
 =
NULL
);

435 i‡(
‹dî
 > 
e4b
->
bd_blkbôs
 + 1) {

436 *
max
 = 0;

437  
NULL
;

441 i‡(
‹dî
 == 0) {

442 *
max
 = 1 << (
e4b
->
bd_blkbôs
 + 3);

443  
e4b
->
bd_bôm≠
;

446 
bb
 = 
e4b
->
bd_buddy
 + 
	`PXT4_SB
”4b->
bd_sb
)->
s_mb_off£ts
[
‹dî
];

447 *
max
 = 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[
‹dî
];

449  
bb
;

450 
	}
}

452 #ifde‡
DOUBLE_CHECK


453 
	$mb_‰ì_blocks_doubÀ
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

454 
fú°
, 
cou¡
)

456 
i
;

457 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

459 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

461 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

462 
i
 = 0; i < 
cou¡
; i++) {

463 i‡(!
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
)) {

464 
pxt4_fsblk_t
 
blockƒ
;

466 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

467 
blockƒ
 +
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
fú°
 + 
i
);

468 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

469 
öode
 ? inode->
i_öo
 : 0,

470 
blockƒ
,

473 
fú°
 + 
i
);

474 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

475 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

477 
	`mb_˛ór_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

479 
	}
}

481 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

483 
i
;

485 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

487 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

488 
i
 = 0; i < 
cou¡
; i++) {

489 
	`BUG_ON
(
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
));

490 
	`mb_£t_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

492 
	}
}

494 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

496 i‡(
	`memcmp
(
e4b
->
bd_öfo
->
bb_bôm≠
, 
bôm≠
,É4b->
bd_sb
->
s_blocksize
)) {

497 *
b1
, *
b2
;

498 
i
;

499 
b1
 = (*Ë
e4b
->
bd_öfo
->
bb_bôm≠
;

500 
b2
 = (*Ë
bôm≠
;

501 
i
 = 0; i < 
e4b
->
bd_sb
->
s_blocksize
; i++) {

502 i‡(
b1
[
i
] !
b2
[i]) {

503 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_ERR
,

507 
e4b
->
bd_group
, 
i
, i * 8, 
b1
[i], 
b2
[i]);

508 
	`BUG
();

512 
	}
}

515 
ölöe
 
	$mb_‰ì_blocks_doubÀ
(
öode
 *inode,

516 
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

519 
	}
}

520 
ölöe
 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
,

521 
fú°
, 
cou¡
)

524 
	}
}

525 
ölöe
 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

528 
	}
}

531 #ifde‡
AGGRESSIVE_CHECK


533 
	#MB_CHECK_ASSERT
(
as£π
) \

535 i‡(!(
as£π
)) { \

536 
	`¥ötk
(
KERN_EMERG
 \

538 
fun˘i⁄
, 
fûe
, 
löe
, #assert); \

539 
	`BUG
(); \

541 } 0)

	)

543 
	$__mb_check_buddy
(
pxt4_buddy
 *
e4b
, *
fûe
,

544 c⁄° *
fun˘i⁄
, 
löe
)

546 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

547 
‹dî
 = 
e4b
->
bd_blkbôs
 + 1;

548 
max
;

549 
max2
;

550 
i
;

551 
j
;

552 
k
;

553 
cou¡
;

554 
pxt4_group_öfo
 *
gΩ
;

555 
‰agmíts
 = 0;

556 
f°¨t
;

557 
li°_hód
 *
cur
;

558 *
buddy
;

559 *
buddy2
;

562 
mb_check_cou¡î
;

563 i‡(
mb_check_cou¡î
++ % 100 != 0)

567 
‹dî
 > 1) {

568 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

569 
	`MB_CHECK_ASSERT
(
buddy
);

570 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
 - 1, &
max2
);

571 
	`MB_CHECK_ASSERT
(
buddy2
);

572 
	`MB_CHECK_ASSERT
(
buddy
 !
buddy2
);

573 
	`MB_CHECK_ASSERT
(
max
 * 2 =
max2
);

575 
cou¡
 = 0;

576 
i
 = 0; i < 
max
; i++) {

578 i‡(
	`mb_ã°_bô
(
i
, 
buddy
)) {

580 i‡(!
	`mb_ã°_bô
(
i
 << 1, 
buddy2
)) {

581 
	`MB_CHECK_ASSERT
(

582 
	`mb_ã°_bô
((
i
<<1)+1, 
buddy2
));

583 } i‡(!
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
)) {

584 
	`MB_CHECK_ASSERT
(

585 
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

591 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

592 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
));

594 
j
 = 0; j < (1 << 
‹dî
); j++) {

595 
k
 = (
i
 * (1 << 
‹dî
)Ë+ 
j
;

596 
	`MB_CHECK_ASSERT
(

597 !
	`mb_ã°_bô
(
k
, 
e4b
->
bd_bôm≠
));

599 
cou¡
++;

601 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] =
cou¡
);

602 
‹dî
--;

605 
f°¨t
 = -1;

606 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

607 
i
 = 0; i < 
max
; i++) {

608 i‡(!
	`mb_ã°_bô
(
i
, 
buddy
)) {

609 
	`MB_CHECK_ASSERT
(
i
 >
e4b
->
bd_öfo
->
bb_fú°_‰ì
);

610 i‡(
f°¨t
 == -1) {

611 
‰agmíts
++;

612 
f°¨t
 = 
i
;

616 
f°¨t
 = -1;

618 
j
 = 0; j < 
e4b
->
bd_blkbôs
 + 1; j++) {

619 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
j
, &
max2
);

620 
k
 = 
i
 >> 
j
;

621 
	`MB_CHECK_ASSERT
(
k
 < 
max2
);

622 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
, 
buddy2
));

625 
	`MB_CHECK_ASSERT
(!
	`PXT4_MB_GRP_NEED_INIT
(
e4b
->
bd_öfo
));

626 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_‰agmíts
 =
‰agmíts
);

628 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
e4b
->
bd_group
);

629 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

630 
pxt4_group_t
 
grou≤r
;

631 
pxt4_¥óŒoc_•a˚
 *
∑
;

632 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

633 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
grou≤r
, &
k
);

634 
	`MB_CHECK_ASSERT
(
grou≤r
 =
e4b
->
bd_group
);

635 
i
 = 0; i < 
∑
->
∑_Àn
; i++)

636 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
 + 
i
, 
buddy
));

639 
	}
}

640 #unde‡
MB_CHECK_ASSERT


641 
	#mb_check_buddy
(
e4b
Ë
	`__mb_check_buddy
(e4b, \

642 
__FILE__
, 
__func__
, 
__LINE__
)

	)

644 
	#mb_check_buddy
(
e4b
)

	)

653 
	$pxt4_mb_m¨k_‰ì_sim∂e
(
su≥r_block
 *
sb
,

654 *
buddy
, 
pxt4_gΩblk_t
 
fú°
,Öxt4_gΩblk_à
Àn
,

655 
pxt4_group_öfo
 *
gΩ
)

657 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

658 
pxt4_gΩblk_t
 
mö
;

659 
pxt4_gΩblk_t
 
max
;

660 
pxt4_gΩblk_t
 
chunk
;

661 
b‹dî
;

663 
	`BUG_ON
(
Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
));

665 
b‹dî
 = 2 << 
sb
->
s_blocksize_bôs
;

667 
Àn
 > 0) {

669 
max
 = 
	`ffs
(
fú°
 | 
b‹dî
) - 1;

672 
mö
 = 
	`Ês
(
Àn
) - 1;

674 i‡(
max
 < 
mö
)

675 
mö
 = 
max
;

676 
chunk
 = 1 << 
mö
;

679 
gΩ
->
bb_cou¡îs
[
mö
]++;

680 i‡(
mö
 > 0)

681 
	`mb_˛ór_bô
(
fú°
 >> 
mö
,

682 
buddy
 + 
sbi
->
s_mb_off£ts
[
mö
]);

684 
Àn
 -
chunk
;

685 
fú°
 +
chunk
;

687 
	}
}

694 
	$mb_£t_œrge°_‰ì_‹dî
(
su≥r_block
 *
sb
, 
pxt4_group_öfo
 *
gΩ
)

696 
i
;

697 
bôs
;

699 
gΩ
->
bb_œrge°_‰ì_‹dî
 = -1;

701 
bôs
 = 
sb
->
s_blocksize_bôs
 + 1;

702 
i
 = 
bôs
; i >= 0; i--) {

703 i‡(
gΩ
->
bb_cou¡îs
[
i
] > 0) {

704 
gΩ
->
bb_œrge°_‰ì_‹dî
 = 
i
;

708 
	}
}

710 
noölöe_f‹_°ack


711 
	$pxt4_mb_gíî©e_buddy
(
su≥r_block
 *
sb
,

712 *
buddy
, *
bôm≠
, 
pxt4_group_t
 
group
)

714 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

715 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

716 
pxt4_gΩblk_t
 
max
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

717 
pxt4_gΩblk_t
 
i
 = 0;

718 
pxt4_gΩblk_t
 
fú°
;

719 
pxt4_gΩblk_t
 
Àn
;

720 
‰ì
 = 0;

721 
‰agmíts
 = 0;

722 
≥riod
 = 
	`gë_cy˛es
();

726 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, 0);

727 
gΩ
->
bb_fú°_‰ì
 = 
i
;

728 
i
 < 
max
) {

729 
‰agmíts
++;

730 
fú°
 = 
i
;

731 
i
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
, i);

732 
Àn
 = 
i
 - 
fú°
;

733 
‰ì
 +
Àn
;

734 i‡(
Àn
 > 1)

735 
	`pxt4_mb_m¨k_‰ì_sim∂e
(
sb
, 
buddy
, 
fú°
, 
Àn
, 
gΩ
);

737 
gΩ
->
bb_cou¡îs
[0]++;

738 i‡(
i
 < 
max
)

739 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, i);

741 
gΩ
->
bb_‰agmíts
 = 
‰agmíts
;

743 i‡(
‰ì
 !
gΩ
->
bb_‰ì
) {

744 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0,

747 
‰ì
, 
gΩ
->
bb_‰ì
);

752 
gΩ
->
bb_‰ì
 = 
‰ì
;

753 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

754 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

756 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
gΩ
);

758 
	`˛ór_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &(
gΩ
->
bb_°©e
));

760 
≥riod
 = 
	`gë_cy˛es
() -Öeriod;

761 
	`•ö_lock
(&
sbi
->
s_bÆ_lock
);

762 
sbi
->
s_mb_buddõs_gíî©ed
++;

763 
sbi
->
s_mb_gíî©i⁄_time
 +
≥riod
;

764 
	`•ö_u∆ock
(&
sbi
->
s_bÆ_lock
);

765 
	}
}

767 
	$mb_ªgíî©e_buddy
(
pxt4_buddy
 *
e4b
)

769 
cou¡
;

770 
‹dî
 = 1;

771 *
buddy
;

773 (
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
++, &
cou¡
))) {

774 
	`pxt4_£t_bôs
(
buddy
, 0, 
cou¡
);

776 
e4b
->
bd_öfo
->
bb_‰agmíts
 = 0;

777 
	`mem£t
(
e4b
->
bd_öfo
->
bb_cou¡îs
, 0,

778 (*
e4b
->
bd_öfo
->
bb_cou¡îs
) *

779 (
e4b
->
bd_sb
->
s_blocksize_bôs
 + 2));

781 
	`pxt4_mb_gíî©e_buddy
(
e4b
->
bd_sb
,É4b->
bd_buddy
,

782 
e4b
->
bd_bôm≠
,É4b->
bd_group
);

783 
	}
}

805 
	$pxt4_mb_öô_ˇche
(
∑ge
 *∑ge, *
öc‹e
, 
gÂ_t
 
gÂ
)

807 
pxt4_group_t
 
ngroups
;

808 
blocksize
;

809 
blocks_≥r_∑ge
;

810 
groups_≥r_∑ge
;

811 
îr
 = 0;

812 
i
;

813 
pxt4_group_t
 
fú°_group
, 
group
;

814 
fú°_block
;

815 
su≥r_block
 *
sb
;

816 
buf„r_hód
 *
bhs
;

817 
buf„r_hód
 **
bh
 = 
NULL
;

818 
öode
 *inode;

819 *
d©a
;

820 *
bôm≠
;

821 
pxt4_group_öfo
 *
gröfo
;

823 
	`mb_debug
(1, "öôÖagê%lu\n", 
∑ge
->
ödex
);

825 
öode
 = 
∑ge
->
m≠pög
->
ho°
;

826 
sb
 = 
öode
->
i_sb
;

827 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

828 
blocksize
 = 
	`i_blocksize
(
öode
);

829 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
blocksize
;

831 
groups_≥r_∑ge
 = 
blocks_≥r_∑ge
 >> 1;

832 i‡(
groups_≥r_∑ge
 == 0)

833 
groups_≥r_∑ge
 = 1;

836 i‡(
groups_≥r_∑ge
 > 1) {

837 
i
 = (
buf„r_hód
 *Ë* 
groups_≥r_∑ge
;

838 
bh
 = 
	`kzÆloc
(
i
, 
gÂ
);

839 i‡(
bh
 =
NULL
) {

840 
îr
 = -
ENOMEM
;

841 
out
;

844 
bh
 = &
bhs
;

846 
fú°_group
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
 / 2;

849 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

850 i‡(
group
 >
ngroups
)

853 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

860 i‡(
	`PageU±od©e
(
∑ge
Ë&& !
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
)) {

861 
bh
[
i
] = 
NULL
;

864 
bh
[
i
] = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
group
);

865 i‡(
	`IS_ERR
(
bh
[
i
])) {

866 
îr
 = 
	`PTR_ERR
(
bh
[
i
]);

867 
bh
[
i
] = 
NULL
;

868 
out
;

870 
	`mb_debug
(1, "ªad bôm≠ f‹ grou∞%u\n", 
group
);

874 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

875 
îr2
;

877 i‡(!
bh
[
i
])

879 
îr2
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
group
, 
bh
[
i
]);

880 i‡(!
îr
)

881 
îr
 = 
îr2
;

884 
fú°_block
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
;

885 
i
 = 0; i < 
blocks_≥r_∑ge
; i++) {

886 
group
 = (
fú°_block
 + 
i
) >> 1;

887 i‡(
group
 >
ngroups
)

890 i‡(!
bh
[
group
 - 
fú°_group
])

894 i‡(!
	`buf„r_vîifõd
(
bh
[
group
 - 
fú°_group
]))

897 
îr
 = 0;

905 
d©a
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
i
 * 
blocksize
);

906 
bôm≠
 = 
bh
[
group
 - 
fú°_group
]->
b_d©a
;

912 i‡((
fú°_block
 + 
i
) & 1) {

914 
	`BUG_ON
(
öc‹e
 =
NULL
);

915 
	`mb_debug
(1, "put buddy for group %u inÖage %lu/%x\n",

916 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

917 
	`åa˚_pxt4_mb_buddy_bôm≠_lﬂd
(
sb
, 
group
);

918 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

919 
gröfo
->
bb_‰agmíts
 = 0;

920 
	`mem£t
(
gröfo
->
bb_cou¡îs
, 0,

921 (*
gröfo
->
bb_cou¡îs
) *

922 (
sb
->
s_blocksize_bôs
+2));

926 
	`pxt4_lock_group
(
sb
, 
group
);

928 
	`mem£t
(
d©a
, 0xff, 
blocksize
);

929 
	`pxt4_mb_gíî©e_buddy
(
sb
, 
d©a
, 
öc‹e
, 
group
);

930 
	`pxt4_u∆ock_group
(
sb
, 
group
);

931 
öc‹e
 = 
NULL
;

934 
	`BUG_ON
(
öc‹e
 !
NULL
);

935 
	`mb_debug
(1, "put bitmap for group %u inÖage %lu/%x\n",

936 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

937 
	`åa˚_pxt4_mb_bôm≠_lﬂd
(
sb
, 
group
);

940 
	`pxt4_lock_group
(
sb
, 
group
);

941 
	`mem˝y
(
d©a
, 
bôm≠
, 
blocksize
);

944 
	`pxt4_mb_gíî©e_‰om_∑
(
sb
, 
d©a
, 
group
);

945 
	`pxt4_mb_gíî©e_‰om_‰ìli°
(
sb
, 
d©a
, 
group
);

946 
	`pxt4_u∆ock_group
(
sb
, 
group
);

951 
öc‹e
 = 
d©a
;

954 
	`SëPageU±od©e
(
∑ge
);

956 
out
:

957 i‡(
bh
) {

958 
i
 = 0; i < 
groups_≥r_∑ge
; i++)

959 
	`bªl£
(
bh
[
i
]);

960 i‡(
bh
 !&
bhs
)

961 
	`k‰ì
(
bh
);

963  
îr
;

964 
	}
}

972 
	$pxt4_mb_gë_buddy_∑ge_lock
(
su≥r_block
 *
sb
,

973 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

975 
öode
 *öodê
	`PXT4_SB
(
sb
)->
s_buddy_ˇche
;

976 
block
, 
≤um
, 
poff
;

977 
blocks_≥r_∑ge
;

978 
∑ge
 *page;

980 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

981 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

983 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

989 
block
 = 
group
 * 2;

990 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

991 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

992 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

993 i‡(!
∑ge
)

994  -
ENOMEM
;

995 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

996 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

997 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

999 i‡(
blocks_≥r_∑ge
 >= 2) {

1004 
block
++;

1005 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1006 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1007 i‡(!
∑ge
)

1008  -
ENOMEM
;

1009 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1010 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1012 
	}
}

1014 
	$pxt4_mb_put_buddy_∑ge_lock
(
pxt4_buddy
 *
e4b
)

1016 i‡(
e4b
->
bd_bôm≠_∑ge
) {

1017 
	`u∆ock_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1018 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1020 i‡(
e4b
->
bd_buddy_∑ge
) {

1021 
	`u∆ock_∑ge
(
e4b
->
bd_buddy_∑ge
);

1022 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1024 
	}
}

1031 
noölöe_f‹_°ack


1032 
	$pxt4_mb_öô_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
gÂ_t
 
gÂ
)

1035 
pxt4_group_öfo
 *
this_gΩ
;

1036 
pxt4_buddy
 
e4b
;

1037 
∑ge
 *page;

1038 
ªt
 = 0;

1040 
	`might_¶ìp
();

1041 
	`mb_debug
(1, "öô grou∞%u\n", 
group
);

1042 
this_gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1052 
ªt
 = 
	`pxt4_mb_gë_buddy_∑ge_lock
(
sb
, 
group
, &
e4b
, 
gÂ
);

1053 i‡(
ªt
 || !
	`PXT4_MB_GRP_NEED_INIT
(
this_gΩ
)) {

1058 
îr
;

1061 
∑ge
 = 
e4b
.
bd_bôm≠_∑ge
;

1062 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1063 i‡(
ªt
)

1064 
îr
;

1065 i‡(!
	`PageU±od©e
(
∑ge
)) {

1066 
ªt
 = -
EIO
;

1067 
îr
;

1070 i‡(
e4b
.
bd_buddy_∑ge
 =
NULL
) {

1076 
ªt
 = 0;

1077 
îr
;

1080 
∑ge
 = 
e4b
.
bd_buddy_∑ge
;

1081 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
.
bd_bôm≠
, 
gÂ
);

1082 i‡(
ªt
)

1083 
îr
;

1084 i‡(!
	`PageU±od©e
(
∑ge
)) {

1085 
ªt
 = -
EIO
;

1086 
îr
;

1088 
îr
:

1089 
	`pxt4_mb_put_buddy_∑ge_lock
(&
e4b
);

1090  
ªt
;

1091 
	}
}

1098 
noölöe_f‹_°ack
 

1099 
	$pxt4_mb_lﬂd_buddy_gÂ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1100 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

1102 
blocks_≥r_∑ge
;

1103 
block
;

1104 
≤um
;

1105 
poff
;

1106 
∑ge
 *page;

1107 
ªt
;

1108 
pxt4_group_öfo
 *
gΩ
;

1109 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1110 
öode
 *öodê
sbi
->
s_buddy_ˇche
;

1112 
	`might_¶ìp
();

1113 
	`mb_debug
(1, "lﬂd grou∞%u\n", 
group
);

1115 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1116 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1118 
e4b
->
bd_blkbôs
 = 
sb
->
s_blocksize_bôs
;

1119 
e4b
->
bd_öfo
 = 
gΩ
;

1120 
e4b
->
bd_sb
 = 
sb
;

1121 
e4b
->
bd_group
 = 
group
;

1122 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

1123 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

1125 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

1130 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
gÂ
);

1131 i‡(
ªt
)

1132  
ªt
;

1140 
block
 = 
group
 * 2;

1141 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1142 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1146 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1147 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1148 i‡(
∑ge
)

1157 
	`put_∑ge
(
∑ge
);

1158 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1159 i‡(
∑ge
) {

1160 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1161 i‡(!
	`PageU±od©e
(
∑ge
)) {

1162 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1163 i‡(
ªt
) {

1164 
	`u∆ock_∑ge
(
∑ge
);

1165 
îr
;

1167 
	`mb_cmp_bôm≠s
(
e4b
, 
	`∑ge_addªss
(
∑ge
) +

1168 (
poff
 * 
sb
->
s_blocksize
));

1170 
	`u∆ock_∑ge
(
∑ge
);

1173 i‡(
∑ge
 =
NULL
) {

1174 
ªt
 = -
ENOMEM
;

1175 
îr
;

1177 i‡(!
	`PageU±od©e
(
∑ge
)) {

1178 
ªt
 = -
EIO
;

1179 
îr
;

1183 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

1184 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1186 
block
++;

1187 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1188 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1190 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1191 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1192 i‡(
∑ge
)

1193 
	`put_∑ge
(
∑ge
);

1194 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1195 i‡(
∑ge
) {

1196 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1197 i‡(!
	`PageU±od©e
(
∑ge
)) {

1198 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
->
bd_bôm≠
,

1199 
gÂ
);

1200 i‡(
ªt
) {

1201 
	`u∆ock_∑ge
(
∑ge
);

1202 
îr
;

1205 
	`u∆ock_∑ge
(
∑ge
);

1208 i‡(
∑ge
 =
NULL
) {

1209 
ªt
 = -
ENOMEM
;

1210 
îr
;

1212 i‡(!
	`PageU±od©e
(
∑ge
)) {

1213 
ªt
 = -
EIO
;

1214 
îr
;

1218 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1219 
e4b
->
bd_buddy
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1221 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

1222 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

1226 
îr
:

1227 i‡(
∑ge
)

1228 
	`put_∑ge
(
∑ge
);

1229 i‡(
e4b
->
bd_bôm≠_∑ge
)

1230 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1231 i‡(
e4b
->
bd_buddy_∑ge
)

1232 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1233 
e4b
->
bd_buddy
 = 
NULL
;

1234 
e4b
->
bd_bôm≠
 = 
NULL
;

1235  
ªt
;

1236 
	}
}

1238 
	$pxt4_mb_lﬂd_buddy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1239 
pxt4_buddy
 *
e4b
)

1241  
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, 
e4b
, 
GFP_NOFS
);

1242 
	}
}

1244 
	$pxt4_mb_u∆ﬂd_buddy
(
pxt4_buddy
 *
e4b
)

1246 i‡(
e4b
->
bd_bôm≠_∑ge
)

1247 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1248 i‡(
e4b
->
bd_buddy_∑ge
)

1249 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1250 
	}
}

1253 
	$mb_föd_‹dî_f‹_block
(
pxt4_buddy
 *
e4b
, 
block
)

1255 
‹dî
 = 1;

1256 
bb_ö¸
 = 1 << (
e4b
->
bd_blkbôs
 - 1);

1257 *
bb
;

1259 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

1260 
	`BUG_ON
(
block
 >(1 << (
e4b
->
bd_blkbôs
 + 3)));

1262 
bb
 = 
e4b
->
bd_buddy
;

1263 
‹dî
 <
e4b
->
bd_blkbôs
 + 1) {

1264 
block
 = block >> 1;

1265 i‡(!
	`mb_ã°_bô
(
block
, 
bb
)) {

1267  
‹dî
;

1269 
bb
 +
bb_ö¸
;

1270 
bb_ö¸
 >>= 1;

1271 
‹dî
++;

1274 
	}
}

1276 
	$mb_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1278 
__u32
 *
addr
;

1280 
Àn
 = 
cur
 +Üen;

1281 
cur
 < 
Àn
) {

1282 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1284 
addr
 = 
bm
 + (
cur
 >> 3);

1285 *
addr
 = 0;

1286 
cur
 += 32;

1289 
	`mb_˛ór_bô
(
cur
, 
bm
);

1290 
cur
++;

1292 
	}
}

1297 
	$mb_ã°_™d_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1299 
__u32
 *
addr
;

1300 
zîo_bô
 = -1;

1302 
Àn
 = 
cur
 +Üen;

1303 
cur
 < 
Àn
) {

1304 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1306 
addr
 = 
bm
 + (
cur
 >> 3);

1307 i‡(*
addr
 !(
__u32
)(-1Ë&& 
zîo_bô
 == -1)

1308 
zîo_bô
 = 
cur
 + 
	`mb_föd_√xt_zîo_bô
(
addr
, 32, 0);

1309 *
addr
 = 0;

1310 
cur
 += 32;

1313 i‡(!
	`mb_ã°_™d_˛ór_bô
(
cur
, 
bm
Ë&& 
zîo_bô
 == -1)

1314 
zîo_bô
 = 
cur
;

1315 
cur
++;

1318  
zîo_bô
;

1319 
	}
}

1321 
	$pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
)

1323 
__u32
 *
addr
;

1325 
Àn
 = 
cur
 +Üen;

1326 
cur
 < 
Àn
) {

1327 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1329 
addr
 = 
bm
 + (
cur
 >> 3);

1330 *
addr
 = 0xffffffff;

1331 
cur
 += 32;

1334 
	`mb_£t_bô
(
cur
, 
bm
);

1335 
cur
++;

1337 
	}
}

1342 
ölöe
 
	$mb_buddy_adju°_b‹dî
(* 
bô
, * 
bôm≠
, 
side
)

1344 i‡(
	`mb_ã°_bô
(*
bô
 + 
side
, 
bôm≠
)) {

1345 
	`mb_˛ór_bô
(*
bô
, 
bôm≠
);

1346 (*
bô
Ë-
side
;

1350 (*
bô
Ë+
side
;

1351 
	`mb_£t_bô
(*
bô
, 
bôm≠
);

1354 
	}
}

1356 
	$mb_buddy_m¨k_‰ì
(
pxt4_buddy
 *
e4b
, 
fú°
, 
œ°
)

1358 
max
;

1359 
‹dî
 = 1;

1360 *
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

1362 
buddy
) {

1363 *
buddy2
;

1394 i‡(
fú°
 & 1)

1395 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
fú°
, 
buddy
, -1);

1396 i‡(!(
œ°
 & 1))

1397 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
œ°
, 
buddy
, 1);

1398 i‡(
fú°
 > 
œ°
)

1400 
‹dî
++;

1402 i‡(
fú°
 =
œ°
 || !(
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
))) {

1403 
	`mb_˛ór_bôs
(
buddy
, 
fú°
, 
œ°
 - first + 1);

1404 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
 - 1] +
œ°
 - 
fú°
 + 1;

1407 
fú°
 >>= 1;

1408 
œ°
 >>= 1;

1409 
buddy
 = 
buddy2
;

1411 
	}
}

1413 
	$mb_‰ì_blocks
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

1414 
fú°
, 
cou¡
)

1416 
À·_is_‰ì
 = 0;

1417 
right_is_‰ì
 = 0;

1418 
block
;

1419 
œ°
 = 
fú°
 + 
cou¡
 - 1;

1420 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

1422 i‡(
	`WARN_ON
(
cou¡
 == 0))

1424 
	`BUG_ON
(
œ°
 >(
sb
->
s_blocksize
 << 3));

1425 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

1427 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
)))

1430 
	`mb_check_buddy
(
e4b
);

1431 
	`mb_‰ì_blocks_doubÀ
(
öode
, 
e4b
, 
fú°
, 
cou¡
);

1433 
e4b
->
bd_öfo
->
bb_‰ì
 +
cou¡
;

1434 i‡(
fú°
 < 
e4b
->
bd_öfo
->
bb_fú°_‰ì
)

1435 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 = 
fú°
;

1440 i‡(
fú°
 != 0)

1441 
À·_is_‰ì
 = !
	`mb_ã°_bô
(
fú°
 - 1, 
e4b
->
bd_bôm≠
);

1442 
block
 = 
	`mb_ã°_™d_˛ór_bôs
(
e4b
->
bd_bôm≠
, 
fú°
, 
cou¡
);

1443 i‡(
œ°
 + 1 < 
	`PXT4_SB
(
sb
)->
s_mb_maxs
[0])

1444 
right_is_‰ì
 = !
	`mb_ã°_bô
(
œ°
 + 1, 
e4b
->
bd_bôm≠
);

1446 i‡(
	`u∆ikñy
(
block
 != -1)) {

1447 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1448 
pxt4_fsblk_t
 
blockƒ
;

1450 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

1451 
blockƒ
 +
	`PXT4_C2B
(
sbi
, 
block
);

1452 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

1453 
öode
 ? inode->
i_öo
 : 0,

1454 
blockƒ
,

1457 
block
);

1458 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1459 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1460 
	`mb_ªgíî©e_buddy
(
e4b
);

1461 
d⁄e
;

1465 i‡(
À·_is_‰ì
 && 
right_is_‰ì
)

1466 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1467 i‡(!
À·_is_‰ì
 && !
right_is_‰ì
)

1468 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1476 i‡(
fú°
 & 1) {

1477 
fú°
 +!
À·_is_‰ì
;

1478 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
À·_is_‰ì
 ? -1 : 1;

1480 i‡(!(
œ°
 & 1)) {

1481 
œ°
 -!
right_is_‰ì
;

1482 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
right_is_‰ì
 ? -1 : 1;

1485 i‡(
fú°
 <
œ°
)

1486 
	`mb_buddy_m¨k_‰ì
(
e4b
, 
fú°
 >> 1, 
œ°
 >> 1);

1488 
d⁄e
:

1489 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
e4b
->
bd_öfo
);

1490 
	`mb_check_buddy
(
e4b
);

1491 
	}
}

1493 
	$mb_föd_exã¡
(
pxt4_buddy
 *
e4b
, 
block
,

1494 
√eded
, 
pxt4_‰ì_exã¡
 *
ex
)

1496 
√xt
 = 
block
;

1497 
max
, 
‹dî
;

1498 *
buddy
;

1500 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1501 
	`BUG_ON
(
ex
 =
NULL
);

1503 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

1504 
	`BUG_ON
(
buddy
 =
NULL
);

1505 
	`BUG_ON
(
block
 >
max
);

1506 i‡(
	`mb_ã°_bô
(
block
, 
buddy
)) {

1507 
ex
->
„_Àn
 = 0;

1508 
ex
->
„_°¨t
 = 0;

1509 
ex
->
„_group
 = 0;

1514 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
block
);

1515 
block
 = block >> 
‹dî
;

1517 
ex
->
„_Àn
 = 1 << 
‹dî
;

1518 
ex
->
„_°¨t
 = 
block
 << 
‹dî
;

1519 
ex
->
„_group
 = 
e4b
->
bd_group
;

1522 
√xt
 =Çexà- 
ex
->
„_°¨t
;

1523 
ex
->
„_Àn
 -
√xt
;

1524 
ex
->
„_°¨t
 +
√xt
;

1526 
√eded
 > 
ex
->
„_Àn
 &&

1527 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
)) {

1529 i‡(
block
 + 1 >
max
)

1532 
√xt
 = (
block
 + 1Ë* (1 << 
‹dî
);

1533 i‡(
	`mb_ã°_bô
(
√xt
, 
e4b
->
bd_bôm≠
))

1536 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
√xt
);

1538 
block
 = 
√xt
 >> 
‹dî
;

1539 
ex
->
„_Àn
 +1 << 
‹dî
;

1542 i‡(
ex
->
„_°¨t
 +Éx->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
e4b
->
bd_sb
)) {

1544 
	`WARN_ON
(1);

1545 
	`pxt4_îr‹
(
e4b
->
bd_sb
, "corruption or bug in mb_find_extent "

1547 
block
, 
‹dî
, 
√eded
, 
ex
->
„_group
,Éx->
„_°¨t
,

1548 
ex
->
„_Àn
,Éx->
„_logiˇl
);

1549 
ex
->
„_Àn
 = 0;

1550 
ex
->
„_°¨t
 = 0;

1551 
ex
->
„_group
 = 0;

1553  
ex
->
„_Àn
;

1554 
	}
}

1556 
	$mb_m¨k_u£d
(
pxt4_buddy
 *
e4b
, 
pxt4_‰ì_exã¡
 *
ex
)

1558 
‹d
;

1559 
mÀn
 = 0;

1560 
max
 = 0;

1561 
cur
;

1562 
°¨t
 = 
ex
->
„_°¨t
;

1563 
Àn
 = 
ex
->
„_Àn
;

1564 
ªt
 = 0;

1565 
Àn0
 = 
Àn
;

1566 *
buddy
;

1568 
	`BUG_ON
(
°¨t
 + 
Àn
 > (
e4b
->
bd_sb
->
s_blocksize
 << 3));

1569 
	`BUG_ON
(
e4b
->
bd_group
 !
ex
->
„_group
);

1570 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1571 
	`mb_check_buddy
(
e4b
);

1572 
	`mb_m¨k_u£d_doubÀ
(
e4b
, 
°¨t
, 
Àn
);

1574 
e4b
->
bd_öfo
->
bb_‰ì
 -
Àn
;

1575 i‡(
e4b
->
bd_öfo
->
bb_fú°_‰ì
 =
°¨t
)

1576 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 +
Àn
;

1579 i‡(
°¨t
 != 0)

1580 
mÀn
 = !
	`mb_ã°_bô
(
°¨t
 - 1, 
e4b
->
bd_bôm≠
);

1581 i‡(
°¨t
 + 
Àn
 < 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[0])

1582 
max
 = !
	`mb_ã°_bô
(
°¨t
 + 
Àn
, 
e4b
->
bd_bôm≠
);

1583 i‡(
mÀn
 && 
max
)

1584 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1585 i‡(!
mÀn
 && !
max
)

1586 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1589 
Àn
) {

1590 
‹d
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
°¨t
);

1592 i‡(((
°¨t
 >> 
‹d
Ë<< ordË=°¨à&& 
Àn
 >= (1 << ord)) {

1594 
mÀn
 = 1 << 
‹d
;

1595 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1596 
	`BUG_ON
((
°¨t
 >> 
‹d
Ë>
max
);

1597 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1598 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1599 
°¨t
 +
mÀn
;

1600 
Àn
 -
mÀn
;

1601 
	`BUG_ON
(
Àn
 < 0);

1606 i‡(
ªt
 == 0)

1607 
ªt
 = 
Àn
 | (
‹d
 << 16);

1610 
	`BUG_ON
(
‹d
 <= 0);

1611 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1612 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1613 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1615 
‹d
--;

1616 
cur
 = (
°¨t
 >> 
‹d
) & ~1U;

1617 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1618 
	`mb_˛ór_bô
(
cur
, 
buddy
);

1619 
	`mb_˛ór_bô
(
cur
 + 1, 
buddy
);

1620 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1621 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1623 
	`mb_£t_œrge°_‰ì_‹dî
(
e4b
->
bd_sb
,É4b->
bd_öfo
);

1625 
	`pxt4_£t_bôs
(
e4b
->
bd_bôm≠
, 
ex
->
„_°¨t
, 
Àn0
);

1626 
	`mb_check_buddy
(
e4b
);

1628  
ªt
;

1629 
	}
}

1634 
	$pxt4_mb_u£_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1635 
pxt4_buddy
 *
e4b
)

1637 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1638 
ªt
;

1640 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_group
 !
e4b
->
bd_group
);

1641 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

1643 
ac
->
ac_b_ex
.
„_Àn
 = 
	`mö
◊c->ac_b_ex.„_Àn,ác->
ac_g_ex
.fe_len);

1644 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_g_ex
.fe_logical;

1645 
ªt
 = 
	`mb_m¨k_u£d
(
e4b
, &
ac
->
ac_b_ex
);

1649 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

1651 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

1652 
ac
->
ac_èû
 = 
ªt
 & 0xffff;

1653 
ac
->
ac_buddy
 = 
ªt
 >> 16;

1662 
ac
->
ac_bôm≠_∑ge
 = 
e4b
->
bd_bôm≠_∑ge
;

1663 
	`gë_∑ge
(
ac
->
ac_bôm≠_∑ge
);

1664 
ac
->
ac_buddy_∑ge
 = 
e4b
->
bd_buddy_∑ge
;

1665 
	`gë_∑ge
(
ac
->
ac_buddy_∑ge
);

1667 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

1668 
	`•ö_lock
(&
sbi
->
s_md_lock
);

1669 
sbi
->
s_mb_œ°_group
 = 
ac
->
ac_f_ex
.
„_group
;

1670 
sbi
->
s_mb_œ°_°¨t
 = 
ac
->
ac_f_ex
.
„_°¨t
;

1671 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

1673 
	}
}

1679 
	$pxt4_mb_check_limôs
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1680 
pxt4_buddy
 *
e4b
,

1681 
föish_group
)

1683 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1684 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1685 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1686 
pxt4_‰ì_exã¡
 
ex
;

1687 
max
;

1689 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

1694 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
 &&

1695 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1696 
ac
->
ac_°©us
 = 
AC_STATUS_BREAK
;

1703 i‡(
bex
->
„_Àn
 < 
gex
->fe_len)

1706 i‡((
föish_group
 || 
ac
->
ac_found
 > 
sbi
->
s_mb_mö_to_sˇn
)

1707 && 
bex
->
„_group
 =
e4b
->
bd_group
) {

1711 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
bex
->
„_°¨t
, 
gex
->
„_Àn
, &
ex
);

1712 i‡(
max
 >
gex
->
„_Àn
) {

1713 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1717 
	}
}

1729 
	$pxt4_mb_mósuª_exã¡
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1730 
pxt4_‰ì_exã¡
 *
ex
,

1731 
pxt4_buddy
 *
e4b
)

1733 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1734 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1736 
	`BUG_ON
(
ex
->
„_Àn
 <= 0);

1737 
	`BUG_ON
(
ex
->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1738 
	`BUG_ON
(
ex
->
„_°¨t
 >
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1739 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
);

1741 
ac
->
ac_found
++;

1746 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1747 *
bex
 = *
ex
;

1748 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1755 i‡(
ex
->
„_Àn
 =
gex
->fe_len) {

1756 *
bex
 = *
ex
;

1757 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1764 i‡(
bex
->
„_Àn
 == 0) {

1765 *
bex
 = *
ex
;

1772 i‡(
bex
->
„_Àn
 < 
gex
->fe_len) {

1775 i‡(
ex
->
„_Àn
 > 
bex
->fe_len)

1776 *
bex
 = *
ex
;

1777 } i‡(
ex
->
„_Àn
 > 
gex
->fe_len) {

1781 i‡(
ex
->
„_Àn
 < 
bex
->fe_len)

1782 *
bex
 = *
ex
;

1785 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 0);

1786 
	}
}

1788 
noölöe_f‹_°ack


1789 
	$pxt4_mb_åy_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1790 
pxt4_buddy
 *
e4b
)

1792 
pxt4_‰ì_exã¡
 
ex
 = 
ac
->
ac_b_ex
;

1793 
pxt4_group_t
 
group
 = 
ex
.
„_group
;

1794 
max
;

1795 
îr
;

1797 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1798 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1799 i‡(
îr
)

1800  
îr
;

1802 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1803 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ex
.
„_°¨t
,Éx.
„_Àn
, &ex);

1805 i‡(
max
 > 0) {

1806 
ac
->
ac_b_ex
 = 
ex
;

1807 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1810 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1811 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1814 
	}
}

1816 
noölöe_f‹_°ack


1817 
	$pxt4_mb_föd_by_gﬂl
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1818 
pxt4_buddy
 *
e4b
)

1820 
pxt4_group_t
 
group
 = 
ac
->
ac_g_ex
.
„_group
;

1821 
max
;

1822 
îr
;

1823 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1824 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

1825 
pxt4_‰ì_exã¡
 
ex
;

1827 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_TRY_GOAL
))

1829 i‡(
gΩ
->
bb_‰ì
 == 0)

1832 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1833 i‡(
îr
)

1834  
îr
;

1836 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
))) {

1837 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1841 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1842 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ac
->
ac_g_ex
.
„_°¨t
,

1843 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1844 
ex
.
„_logiˇl
 = 0xDEADFA11;

1846 i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
 &&ác->ac_g_ex.„_À¿=
sbi
->
s_°rùe
) {

1847 
pxt4_fsblk_t
 
°¨t
;

1849 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
ac
->
ac_sb
, 
e4b
->
bd_group
) +

1850 
ex
.
„_°¨t
;

1852 i‡(
	`do_div
(
°¨t
, 
sbi
->
s_°rùe
) == 0) {

1853 
ac
->
ac_found
++;

1854 
ac
->
ac_b_ex
 = 
ex
;

1855 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1857 } i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
) {

1858 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1859 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1860 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1861 
ac
->
ac_found
++;

1862 
ac
->
ac_b_ex
 = 
ex
;

1863 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1864 } i‡(
max
 > 0 && (
ac
->
ac_Êags
 & 
PXT4_MB_HINT_MERGE
)) {

1867 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1868 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1869 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1870 
ac
->
ac_found
++;

1871 
ac
->
ac_b_ex
 = 
ex
;

1872 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1874 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1875 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1878 
	}
}

1884 
noölöe_f‹_°ack


1885 
	$pxt4_mb_sim∂e_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1886 
pxt4_buddy
 *
e4b
)

1888 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1889 
pxt4_group_öfo
 *
gΩ
 = 
e4b
->
bd_öfo
;

1890 *
buddy
;

1891 
i
;

1892 
k
;

1893 
max
;

1895 
	`BUG_ON
(
ac
->
ac_2‹dî
 <= 0);

1896 
i
 = 
ac
->
ac_2‹dî
; i <
sb
->
s_blocksize_bôs
 + 1; i++) {

1897 i‡(
gΩ
->
bb_cou¡îs
[
i
] == 0)

1900 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
i
, &
max
);

1901 
	`BUG_ON
(
buddy
 =
NULL
);

1903 
k
 = 
	`mb_föd_√xt_zîo_bô
(
buddy
, 
max
, 0);

1904 
	`BUG_ON
(
k
 >
max
);

1906 
ac
->
ac_found
++;

1908 
ac
->
ac_b_ex
.
„_Àn
 = 1 << 
i
;

1909 
ac
->
ac_b_ex
.
„_°¨t
 = 
k
 << 
i
;

1910 
ac
->
ac_b_ex
.
„_group
 = 
e4b
->
bd_group
;

1912 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1914 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 !ac->
ac_g_ex
.fe_len);

1916 i‡(
	`PXT4_SB
(
sb
)->
s_mb_°©s
)

1917 
	`©omic_öc
(&
	`PXT4_SB
(
sb
)->
s_bÆ_2‹dîs
);

1921 
	}
}

1928 
noölöe_f‹_°ack


1929 
	$pxt4_mb_com∂ex_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1930 
pxt4_buddy
 *
e4b
)

1932 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1933 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1934 
pxt4_‰ì_exã¡
 
ex
;

1935 
i
;

1936 
‰ì
;

1938 
‰ì
 = 
e4b
->
bd_öfo
->
bb_‰ì
;

1939 i‡(
	`WARN_ON
(
‰ì
 <= 0))

1942 
i
 = 
e4b
->
bd_öfo
->
bb_fú°_‰ì
;

1944 
‰ì
 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
) {

1945 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
,

1946 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
), 
i
);

1947 i‡(
i
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

1953 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1956 
‰ì
);

1957 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1958 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1962 
	`mb_föd_exã¡
(
e4b
, 
i
, 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1963 i‡(
	`WARN_ON
(
ex
.
„_Àn
 <= 0))

1965 i‡(
‰ì
 < 
ex
.
„_Àn
) {

1966 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1969 
‰ì
, 
ex
.
„_Àn
);

1970 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1971 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1979 
ex
.
„_logiˇl
 = 0xDEADC0DE;

1980 
	`pxt4_mb_mósuª_exã¡
(
ac
, &
ex
, 
e4b
);

1982 
i
 +
ex
.
„_Àn
;

1983 
‰ì
 -
ex
.
„_Àn
;

1986 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 1);

1987 
	}
}

1993 
noölöe_f‹_°ack


1994 
	$pxt4_mb_sˇn_Æig√d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1995 
pxt4_buddy
 *
e4b
)

1997 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1998 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1999 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

2000 
pxt4_‰ì_exã¡
 
ex
;

2001 
pxt4_fsblk_t
 
fú°_group_block
;

2002 
pxt4_fsblk_t
 
a
;

2003 
pxt4_gΩblk_t
 
i
;

2004 
max
;

2006 
	`BUG_ON
(
sbi
->
s_°rùe
 == 0);

2009 
fú°_group_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

2011 
a
 = 
fú°_group_block
 + 
sbi
->
s_°rùe
 - 1;

2012 
	`do_div
(
a
, 
sbi
->
s_°rùe
);

2013 
i
 = (
a
 * 
sbi
->
s_°rùe
Ë- 
fú°_group_block
;

2015 
i
 < 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

2016 i‡(!
	`mb_ã°_bô
(
i
, 
bôm≠
)) {

2017 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
i
, 
sbi
->
s_°rùe
, &
ex
);

2018 i‡(
max
 >
sbi
->
s_°rùe
) {

2019 
ac
->
ac_found
++;

2020 
ex
.
„_logiˇl
 = 0xDEADF00D;

2021 
ac
->
ac_b_ex
 = 
ex
;

2022 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

2026 
i
 +
sbi
->
s_°rùe
;

2028 
	}
}

2036 
	$pxt4_mb_good_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2037 
pxt4_group_t
 
group
, 
¸
)

2039 
‰ì
, 
‰agmíts
;

2040 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
ac
->
ac_sb
));

2041 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

2043 
	`BUG_ON
(
¸
 < 0 || cr >= 4);

2045 
‰ì
 = 
gΩ
->
bb_‰ì
;

2046 i‡(
‰ì
 == 0)

2048 i‡(
¸
 <2 && 
‰ì
 < 
ac
->
ac_g_ex
.
„_Àn
)

2051 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
)))

2055 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

2056 
ªt
 = 
	`pxt4_mb_öô_group
(
ac
->
ac_sb
, 
group
, 
GFP_NOFS
);

2057 i‡(
ªt
)

2058  
ªt
;

2061 
‰agmíts
 = 
gΩ
->
bb_‰agmíts
;

2062 i‡(
‰agmíts
 == 0)

2065 
¸
) {

2067 
	`BUG_ON
(
ac
->
ac_2‹dî
 == 0);

2070 i‡((
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
) &&

2071 (
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) &&

2072 ((
group
 % 
Êex_size
) == 0))

2075 i‡((
ac
->
ac_2‹dî
 >ác->
ac_sb
->
s_blocksize_bôs
+1) ||

2076 (
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2079 i‡(
gΩ
->
bb_œrge°_‰ì_‹dî
 < 
ac
->
ac_2‹dî
)

2084 i‡((
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2088 i‡(
‰ì
 >
ac
->
ac_g_ex
.
„_Àn
)

2094 
	`BUG
();

2098 
	}
}

2100 
noölöe_f‹_°ack
 

2101 
	$pxt4_mb_ªguœr_Æloˇt‹
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

2103 
pxt4_group_t
 
ngroups
, 
group
, 
i
;

2104 
¸
;

2105 
îr
 = 0, 
fú°_îr
 = 0;

2106 
pxt4_sb_öfo
 *
sbi
;

2107 
su≥r_block
 *
sb
;

2108 
pxt4_buddy
 
e4b
;

2110 
sb
 = 
ac
->
ac_sb
;

2111 
sbi
 = 
	`PXT4_SB
(
sb
);

2112 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2114 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)))

2115 
ngroups
 = 
sbi
->
s_blockfûe_groups
;

2117 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

2120 
îr
 = 
	`pxt4_mb_föd_by_gﬂl
(
ac
, &
e4b
);

2121 i‡(
îr
 || 
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

2122 
out
;

2124 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

2125 
out
;

2132 
i
 = 
	`Ês
(
ac
->
ac_g_ex
.
„_Àn
);

2133 
ac
->
ac_2‹dî
 = 0;

2141 i‡(
i
 >
sbi
->
s_mb_‹dî2_ªqs
 && i <
sb
->
s_blocksize_bôs
 + 2) {

2145 i‡((
ac
->
ac_g_ex
.
„_Àn
 & (~(1 << (
i
 - 1)))) == 0)

2146 
ac
->
ac_2‹dî
 = 
	`¨øy_ödex_no•ec
(
i
 - 1,

2147 
sb
->
s_blocksize_bôs
 + 2);

2151 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

2153 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2154 
ac
->
ac_g_ex
.
„_group
 = 
sbi
->
s_mb_œ°_group
;

2155 
ac
->
ac_g_ex
.
„_°¨t
 = 
sbi
->
s_mb_œ°_°¨t
;

2156 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2160 
¸
 = 
ac
->
ac_2‹dî
 ? 0 : 1;

2165 
ª≥©
:

2166 ; 
¸
 < 4 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
; cr++) {

2167 
ac
->
ac_¸ôîü
 = 
¸
;

2172 
group
 = 
ac
->
ac_g_ex
.
„_group
;

2174 
i
 = 0; i < 
ngroups
; 
group
++, i++) {

2175 
ªt
 = 0;

2176 
	`c⁄d_ªsched
();

2181 i‡(
group
 >
ngroups
)

2182 
group
 = 0;

2185 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2186 i‡(
ªt
 <= 0) {

2187 i‡(!
fú°_îr
)

2188 
fú°_îr
 = 
ªt
;

2192 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2193 i‡(
îr
)

2194 
out
;

2196 
	`pxt4_lock_group
(
sb
, 
group
);

2202 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2203 i‡(
ªt
 <= 0) {

2204 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2205 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2206 i‡(!
fú°_îr
)

2207 
fú°_îr
 = 
ªt
;

2211 
ac
->
ac_groups_sˇ¬ed
++;

2212 i‡(
¸
 == 0)

2213 
	`pxt4_mb_sim∂e_sˇn_group
(
ac
, &
e4b
);

2214 i‡(
¸
 =1 && 
sbi
->
s_°rùe
 &&

2215 !(
ac
->
ac_g_ex
.
„_Àn
 % 
sbi
->
s_°rùe
))

2216 
	`pxt4_mb_sˇn_Æig√d
(
ac
, &
e4b
);

2218 
	`pxt4_mb_com∂ex_sˇn_group
(
ac
, &
e4b
);

2220 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2221 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2223 i‡(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
)

2228 i‡(
ac
->
ac_b_ex
.
„_Àn
 > 0 &&ác->
ac_°©us
 !
AC_STATUS_FOUND
 &&

2229 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

2235 
	`pxt4_mb_åy_be°_found
(
ac
, &
e4b
);

2236 i‡(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
) {

2243 
ac
->
ac_b_ex
.
„_group
 = 0;

2244 
ac
->
ac_b_ex
.
„_°¨t
 = 0;

2245 
ac
->
ac_b_ex
.
„_Àn
 = 0;

2246 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

2247 
ac
->
ac_Êags
 |
PXT4_MB_HINT_FIRST
;

2248 
¸
 = 3;

2249 
	`©omic_öc
(&
sbi
->
s_mb_lo°_chunks
);

2250 
ª≥©
;

2253 
out
:

2254 i‡(!
îr
 && 
ac
->
ac_°©us
 !
AC_STATUS_FOUND
 && 
fú°_îr
)

2255 
îr
 = 
fú°_îr
;

2256  
îr
;

2257 
	}
}

2259 *
	$pxt4_mb_£q_groups_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

2261 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2262 
pxt4_group_t
 
group
;

2264 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2265  
NULL
;

2266 
group
 = *
pos
 + 1;

2267  (*Ë((Ë
group
);

2268 
	}
}

2270 *
	$pxt4_mb_£q_groups_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

2272 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2273 
pxt4_group_t
 
group
;

2275 ++*
pos
;

2276 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2277  
NULL
;

2278 
group
 = *
pos
 + 1;

2279  (*Ë((Ë
group
);

2280 
	}
}

2282 
	$pxt4_mb_£q_groups_show
(
£q_fûe
 *
£q
, *
v
)

2284 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2285 
pxt4_group_t
 
group
 = (pxt4_group_tË((Ë
v
);

2286 
i
;

2287 
îr
, 
buddy_lﬂded
 = 0;

2288 
pxt4_buddy
 
e4b
;

2289 
pxt4_group_öfo
 *
gröfo
;

2290 
blocksize_bôs
 = 
	`mö_t
(,

2291 
sb
->
s_blocksize_bôs
,

2292 
PXT4_MAX_BLOCK_LOG_SIZE
);

2293 
	ssg
 {

2294 
pxt4_group_öfo
 
öfo
;

2295 
pxt4_gΩblk_t
 
cou¡îs
[
PXT4_MAX_BLOCK_LOG_SIZE
 + 2];

2296 } 
sg
;

2298 
group
--;

2299 i‡(
group
 == 0)

2300 
	`£q_puts
(
£q
, "#group: free frags first ["

2304 
i
 = (
blocksize_bôs
 + 2Ë* (
sg
.
öfo
.
bb_cou¡îs
[0]) +

2305 (
pxt4_group_öfo
);

2307 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

2309 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
))) {

2310 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2311 i‡(
îr
) {

2312 
	`£q_¥ötf
(
£q
, "#%-5u: I/OÉº‹\n", 
group
);

2315 
buddy_lﬂded
 = 1;

2318 
	`mem˝y
(&
sg
, 
	`pxt4_gë_group_öfo
(
sb
, 
group
), 
i
);

2320 i‡(
buddy_lﬂded
)

2321 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2323 
	`£q_¥ötf
(
£q
, "#%-5u: %-5u %-5u %-5u [", 
group
, 
sg
.
öfo
.
bb_‰ì
,

2324 
sg
.
öfo
.
bb_‰agmíts
, sg.öfo.
bb_fú°_‰ì
);

2325 
i
 = 0; i <= 13; i++)

2326 
	`£q_¥ötf
(
£q
, " %-5u", 
i
 <
blocksize_bôs
 + 1 ?

2327 
sg
.
öfo
.
bb_cou¡îs
[
i
] : 0);

2328 
	`£q_¥ötf
(
£q
, " ]\n");

2331 
	}
}

2333 
	$pxt4_mb_£q_groups_°›
(
£q_fûe
 *
£q
, *
v
)

2335 
	}
}

2337 c⁄° 
£q_›î©i⁄s
 
	gpxt4_mb_£q_groups_›s
 = {

2338 .
°¨t
 = 
pxt4_mb_£q_groups_°¨t
,

2339 .
	g√xt
 = 
pxt4_mb_£q_groups_√xt
,

2340 .
	g°›
 = 
pxt4_mb_£q_groups_°›
,

2341 .
	gshow
 = 
pxt4_mb_£q_groups_show
,

2344 
kmem_ˇche
 *
	$gë_groupöfo_ˇche
(
blocksize_bôs
)

2346 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2347 
kmem_ˇche
 *
ˇchï
 = 
pxt4_groupöfo_ˇches
[
ˇche_ödex
];

2349 
	`BUG_ON
(!
ˇchï
);

2350  
ˇchï
;

2351 
	}
}

2357 
	$pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroups
)

2359 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2360 
size
;

2361 
pxt4_group_öfo
 ***
ﬁd_groupöfo
, ***
√w_groupöfo
;

2363 
size
 = (
ngroups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2364 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2365 i‡(
size
 <
sbi
->
s_group_öfo_size
)

2368 
size
 = 
	`roundup_pow_of_two
((*
sbi
->
s_group_öfo
) * size);

2369 
√w_groupöfo
 = 
	`kvzÆloc
(
size
, 
GFP_KERNEL
);

2370 i‡(!
√w_groupöfo
) {

2371 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy meta group");

2372  -
ENOMEM
;

2374 
	`rcu_ªad_lock
();

2375 
ﬁd_groupöfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2376 i‡(
ﬁd_groupöfo
)

2377 
	`mem˝y
(
√w_groupöfo
, 
ﬁd_groupöfo
,

2378 
sbi
->
s_group_öfo_size
 * (*sbi->
s_group_öfo
));

2379 
	`rcu_ªad_u∆ock
();

2380 
	`rcu_assign_poöãr
(
sbi
->
s_group_öfo
, 
√w_groupöfo
);

2381 
sbi
->
s_group_öfo_size
 = 
size
 / (*sbi->
s_group_öfo
);

2382 i‡(
ﬁd_groupöfo
)

2383 
	`pxt4_kv‰ì_¨øy_rcu
(
ﬁd_groupöfo
);

2384 
	`pxt4_debug
("allocated s_groupinfoárray for %d meta_bg's\n",

2385 
sbi
->
s_group_öfo_size
);

2387 
	}
}

2390 
	$pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2391 
pxt4_group_desc
 *
desc
)

2393 
i
;

2394 
mëÆí
 = 0;

2395 
idx
 = 
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2396 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2397 
pxt4_group_öfo
 **
mëa_group_öfo
;

2398 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2405 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2406 
mëÆí
 = (*
mëa_group_öfo
) <<

2407 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2408 
mëa_group_öfo
 = 
	`kmÆloc
(
mëÆí
, 
GFP_NOFS
);

2409 i‡(
mëa_group_öfo
 =
NULL
) {

2410 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate mem "

2412 
exô_mëa_group_öfo
;

2414 
	`rcu_ªad_lock
();

2415 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
)[
idx
] = 
mëa_group_öfo
;

2416 
	`rcu_ªad_u∆ock
();

2419 
mëa_group_öfo
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_öfo
, 
idx
);

2420 
i
 = 
group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

2422 
mëa_group_öfo
[
i
] = 
	`kmem_ˇche_zÆloc
(
ˇchï
, 
GFP_NOFS
);

2423 i‡(
mëa_group_öfo
[
i
] =
NULL
) {

2424 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy mem");

2425 
exô_group_öfo
;

2427 
	`£t_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
,

2428 &(
mëa_group_öfo
[
i
]->
bb_°©e
));

2434 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2435 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

2436 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2437 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
desc
);

2439 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2440 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

2443 
	`INIT_LIST_HEAD
(&
mëa_group_öfo
[
i
]->
bb_¥óŒoc_li°
);

2444 
	`öô_rw£m
(&
mëa_group_öfo
[
i
]->
Æloc_£m
);

2445 
mëa_group_öfo
[
i
]->
bb_‰ì_roŸ
 = 
RB_ROOT
;

2446 
mëa_group_öfo
[
i
]->
bb_œrge°_‰ì_‹dî
 = -1;

2448 #ifde‡
DOUBLE_CHECK


2450 
buf„r_hód
 *
bh
;

2451 
mëa_group_öfo
[
i
]->
bb_bôm≠
 =

2452 
	`kmÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

2453 
	`BUG_ON
(
mëa_group_öfo
[
i
]->
bb_bôm≠
 =
NULL
);

2454 
bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

2455 
	`BUG_ON
(
	`IS_ERR_OR_NULL
(
bh
));

2456 
	`mem˝y
(
mëa_group_öfo
[
i
]->
bb_bôm≠
, 
bh
->
b_d©a
,

2457 
sb
->
s_blocksize
);

2458 
	`put_bh
(
bh
);

2464 
exô_group_öfo
:

2466 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2467 
pxt4_group_öfo
 ***
group_öfo
;

2469 
	`rcu_ªad_lock
();

2470 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2471 
	`k‰ì
(
group_öfo
[
idx
]);

2472 
group_öfo
[
idx
] = 
NULL
;

2473 
	`rcu_ªad_u∆ock
();

2475 
exô_mëa_group_öfo
:

2476  -
ENOMEM
;

2477 
	}
}

2479 
	$pxt4_mb_öô_backíd
(
su≥r_block
 *
sb
)

2481 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2482 
pxt4_group_t
 
i
;

2483 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2484 
îr
;

2485 
pxt4_group_desc
 *
desc
;

2486 
pxt4_group_öfo
 ***
group_öfo
;

2487 
kmem_ˇche
 *
ˇchï
;

2489 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
ngroups
);

2490 i‡(
îr
)

2491  
îr
;

2493 
sbi
->
s_buddy_ˇche
 = 
	`√w_öode
(
sb
);

2494 i‡(
sbi
->
s_buddy_ˇche
 =
NULL
) {

2495 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't getÇew inode");

2496 
îr_‰ìsgi
;

2502 
sbi
->
s_buddy_ˇche
->
i_öo
 = 
PXT4_BAD_INO
;

2503 
	`PXT4_I
(
sbi
->
s_buddy_ˇche
)->
i_disksize
 = 0;

2504 
i
 = 0; i < 
ngroups
; i++) {

2505 
	`c⁄d_ªsched
();

2506 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2507 i‡(
desc
 =
NULL
) {

2508 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "ˇn'àªad des¸ùt‹ %u", 
i
);

2509 
îr_‰ìbuddy
;

2511 i‡(
	`pxt4_mb_add_groupöfo
(
sb
, 
i
, 
desc
) != 0)

2512 
îr_‰ìbuddy
;

2517 
îr_‰ìbuddy
:

2518 
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2519 
i
-- > 0)

2520 
	`kmem_ˇche_‰ì
(
ˇchï
, 
	`pxt4_gë_group_öfo
(
sb
, 
i
));

2521 
i
 = 
sbi
->
s_group_öfo_size
;

2522 
	`rcu_ªad_lock
();

2523 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2524 
i
-- > 0)

2525 
	`k‰ì
(
group_öfo
[
i
]);

2526 
	`rcu_ªad_u∆ock
();

2527 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2528 
îr_‰ìsgi
:

2529 
	`rcu_ªad_lock
();

2530 
	`kv‰ì
(
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
));

2531 
	`rcu_ªad_u∆ock
();

2532  -
ENOMEM
;

2533 
	}
}

2535 
	$pxt4_groupöfo_de°roy_¶abs
()

2537 
i
;

2539 
i
 = 0; i < 
NR_GRPINFO_CACHES
; i++) {

2540 
	`kmem_ˇche_de°roy
(
pxt4_groupöfo_ˇches
[
i
]);

2541 
pxt4_groupöfo_ˇches
[
i
] = 
NULL
;

2543 
	}
}

2545 
	$pxt4_groupöfo_¸óã_¶ab
(
size_t
 
size
)

2547 
	`DEFINE_MUTEX
(
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2548 
¶ab_size
;

2549 
blocksize_bôs
 = 
	`‹dî_ba£_2
(
size
);

2550 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2551 
kmem_ˇche
 *
ˇchï
;

2553 i‡(
ˇche_ödex
 >
NR_GRPINFO_CACHES
)

2554  -
EINVAL
;

2556 i‡(
	`u∆ikñy
(
ˇche_ödex
 < 0))

2557 
ˇche_ödex
 = 0;

2559 
	`muãx_lock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2560 i‡(
pxt4_groupöfo_ˇches
[
ˇche_ödex
]) {

2561 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2565 
¶ab_size
 = 
	`off£tof
(
pxt4_group_öfo
,

2566 
bb_cou¡îs
[
blocksize_bôs
 + 2]);

2568 
ˇchï
 = 
	`kmem_ˇche_¸óã
(
pxt4_groupöfo_¶ab_«mes
[
ˇche_ödex
],

2569 
¶ab_size
, 0, 
SLAB_RECLAIM_ACCOUNT
,

2570 
NULL
);

2572 
pxt4_groupöfo_ˇches
[
ˇche_ödex
] = 
ˇchï
;

2574 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2575 i‡(!
ˇchï
) {

2576 
	`¥ötk
(
KERN_EMERG


2578  -
ENOMEM
;

2582 
	}
}

2584 
	$pxt4_mb_öô
(
su≥r_block
 *
sb
)

2586 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2587 
i
, 
j
;

2588 
off£t
, 
off£t_ö¸
;

2589 
max
;

2590 
ªt
;

2592 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_off£ts
);

2594 
sbi
->
s_mb_off£ts
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2595 i‡(
sbi
->
s_mb_off£ts
 =
NULL
) {

2596 
ªt
 = -
ENOMEM
;

2597 
out
;

2600 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_maxs
);

2601 
sbi
->
s_mb_maxs
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2602 i‡(
sbi
->
s_mb_maxs
 =
NULL
) {

2603 
ªt
 = -
ENOMEM
;

2604 
out
;

2607 
ªt
 = 
	`pxt4_groupöfo_¸óã_¶ab
(
sb
->
s_blocksize
);

2608 i‡(
ªt
 < 0)

2609 
out
;

2612 
sbi
->
s_mb_maxs
[0] = 
sb
->
s_blocksize
 << 3;

2613 
sbi
->
s_mb_off£ts
[0] = 0;

2615 
i
 = 1;

2616 
off£t
 = 0;

2617 
off£t_ö¸
 = 1 << (
sb
->
s_blocksize_bôs
 - 1);

2618 
max
 = 
sb
->
s_blocksize
 << 2;

2620 
sbi
->
s_mb_off£ts
[
i
] = 
off£t
;

2621 
sbi
->
s_mb_maxs
[
i
] = 
max
;

2622 
off£t
 +
off£t_ö¸
;

2623 
off£t_ö¸
 = offset_incr >> 1;

2624 
max
 = max >> 1;

2625 
i
++;

2626 } 
i
 <
sb
->
s_blocksize_bôs
 + 1);

2628 
	`•ö_lock_öô
(&
sbi
->
s_md_lock
);

2629 
	`•ö_lock_öô
(&
sbi
->
s_bÆ_lock
);

2630 
sbi
->
s_mb_‰ì_≥ndög
 = 0;

2631 
	`INIT_LIST_HEAD
(&
sbi
->
s_‰ìd_d©a_li°
);

2633 
sbi
->
s_mb_max_to_sˇn
 = 
MB_DEFAULT_MAX_TO_SCAN
;

2634 
sbi
->
s_mb_mö_to_sˇn
 = 
MB_DEFAULT_MIN_TO_SCAN
;

2635 
sbi
->
s_mb_°©s
 = 
MB_DEFAULT_STATS
;

2636 
sbi
->
s_mb_°ªam_ªque°
 = 
MB_DEFAULT_STREAM_THRESHOLD
;

2637 
sbi
->
s_mb_‹dî2_ªqs
 = 
MB_DEFAULT_ORDER2_REQS
;

2650 
sbi
->
s_mb_group_¥óŒoc
 = 
	`max
(
MB_DEFAULT_GROUP_PREALLOC
 >>

2651 
sbi
->
s_˛u°î_bôs
, 32);

2660 i‡(
sbi
->
s_°rùe
 > 1) {

2661 
sbi
->
s_mb_group_¥óŒoc
 = 
	`roundup
(

2662 
sbi
->
s_mb_group_¥óŒoc
, sbi->
s_°rùe
);

2665 
sbi
->
s_loˇlôy_groups
 = 
	`Æloc_≥r˝u
(
pxt4_loˇlôy_group
);

2666 i‡(
sbi
->
s_loˇlôy_groups
 =
NULL
) {

2667 
ªt
 = -
ENOMEM
;

2668 
out
;

2670 
	`f‹_óch_possibÀ_˝u
(
i
) {

2671 
pxt4_loˇlôy_group
 *
lg
;

2672 
lg
 = 
	`≥r_˝u_±r
(
sbi
->
s_loˇlôy_groups
, 
i
);

2673 
	`muãx_öô
(&
lg
->
lg_muãx
);

2674 
j
 = 0; j < 
PREALLOC_TB_SIZE
; j++)

2675 
	`INIT_LIST_HEAD
(&
lg
->
lg_¥óŒoc_li°
[
j
]);

2676 
	`•ö_lock_öô
(&
lg
->
lg_¥óŒoc_lock
);

2680 
ªt
 = 
	`pxt4_mb_öô_backíd
(
sb
);

2681 i‡(
ªt
 != 0)

2682 
out_‰ì_loˇlôy_groups
;

2686 
out_‰ì_loˇlôy_groups
:

2687 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2688 
sbi
->
s_loˇlôy_groups
 = 
NULL
;

2689 
out
:

2690 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2691 
sbi
->
s_mb_off£ts
 = 
NULL
;

2692 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2693 
sbi
->
s_mb_maxs
 = 
NULL
;

2694  
ªt
;

2695 
	}
}

2698 
	$pxt4_mb_˛ónup_∑
(
pxt4_group_öfo
 *
gΩ
)

2700 
pxt4_¥óŒoc_•a˚
 *
∑
;

2701 
li°_hód
 *
cur
, *
tmp
;

2702 
cou¡
 = 0;

2704 
	`li°_f‹_óch_ß„
(
cur
, 
tmp
, &
gΩ
->
bb_¥óŒoc_li°
) {

2705 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

2706 
	`li°_dñ
(&
∑
->
∑_group_li°
);

2707 
cou¡
++;

2708 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

2710 i‡(
cou¡
)

2711 
	`mb_debug
(1, "mbÆloc: %u PA†À·\n", 
cou¡
);

2713 
	}
}

2715 
	$pxt4_mb_ªÀa£
(
su≥r_block
 *
sb
)

2717 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2718 
pxt4_group_t
 
i
;

2719 
num_mëa_group_öfos
;

2720 
pxt4_group_öfo
 *
gröfo
, ***
group_öfo
;

2721 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2722 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2724 i‡(
sbi
->
s_group_öfo
) {

2725 
i
 = 0; i < 
ngroups
; i++) {

2726 
	`c⁄d_ªsched
();

2727 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

2728 #ifde‡
DOUBLE_CHECK


2729 
	`k‰ì
(
gröfo
->
bb_bôm≠
);

2731 
	`pxt4_lock_group
(
sb
, 
i
);

2732 
	`pxt4_mb_˛ónup_∑
(
gröfo
);

2733 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2734 
	`kmem_ˇche_‰ì
(
ˇchï
, 
gröfo
);

2736 
num_mëa_group_öfos
 = (
ngroups
 +

2737 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2738 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2739 
	`rcu_ªad_lock
();

2740 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2741 
i
 = 0; i < 
num_mëa_group_öfos
; i++)

2742 
	`k‰ì
(
group_öfo
[
i
]);

2743 
	`kv‰ì
(
group_öfo
);

2744 
	`rcu_ªad_u∆ock
();

2746 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2747 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2748 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2749 i‡(
sbi
->
s_mb_°©s
) {

2750 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2752 
	`©omic_ªad
(&
sbi
->
s_bÆ_Æloˇãd
),

2753 
	`©omic_ªad
(&
sbi
->
s_bÆ_ªqs
),

2754 
	`©omic_ªad
(&
sbi
->
s_bÆ_suc˚ss
));

2755 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2758 
	`©omic_ªad
(&
sbi
->
s_bÆ_ex_sˇ¬ed
),

2759 
	`©omic_ªad
(&
sbi
->
s_bÆ_gﬂls
),

2760 
	`©omic_ªad
(&
sbi
->
s_bÆ_2‹dîs
),

2761 
	`©omic_ªad
(&
sbi
->
s_bÆ_bªaks
),

2762 
	`©omic_ªad
(&
sbi
->
s_mb_lo°_chunks
));

2763 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2765 
sbi
->
s_mb_buddõs_gíî©ed
,

2766 
sbi
->
s_mb_gíî©i⁄_time
);

2767 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2769 
	`©omic_ªad
(&
sbi
->
s_mb_¥óŒoˇãd
),

2770 
	`©omic_ªad
(&
sbi
->
s_mb_disˇrded
));

2773 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2776 
	}
}

2778 
ölöe
 
	$pxt4_issue_disˇrd
(
su≥r_block
 *
sb
,

2779 
pxt4_group_t
 
block_group
, 
pxt4_gΩblk_t
 
˛u°î
, 
cou¡
,

2780 
bio
 **
bi›
)

2782 
pxt4_fsblk_t
 
disˇrd_block
;

2784 
disˇrd_block
 = (
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
˛u°î
) +

2785 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
));

2786 
cou¡
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), count);

2787 
	`åa˚_pxt4_disˇrd_blocks
(
sb
,

2788 (Ë
disˇrd_block
, 
cou¡
);

2789 i‡(
bi›
) {

2790  
	`__blkdev_issue_disˇrd
(
sb
->
s_bdev
,

2791 (
£˘‹_t
)
disˇrd_block
 << (
sb
->
s_blocksize_bôs
 - 9),

2792 (
£˘‹_t
)
cou¡
 << (
sb
->
s_blocksize_bôs
 - 9),

2793 
GFP_NOFS
, 0, 
bi›
);

2795  
	`sb_issue_disˇrd
(
sb
, 
disˇrd_block
, 
cou¡
, 
GFP_NOFS
, 0);

2796 
	}
}

2798 
	$pxt4_‰ì_d©a_ö_buddy
(
su≥r_block
 *
sb
,

2799 
pxt4_‰ì_d©a
 *
íåy
)

2801 
pxt4_buddy
 
e4b
;

2802 
pxt4_group_öfo
 *
db
;

2803 
îr
, 
cou¡
 = 0, 
cou¡2
 = 0;

2805 
	`mb_debug
(1, "gonna free %u blocks in group %u (0x%p):",

2806 
íåy
->
efd_cou¡
,É¡ry->
efd_group
,Éntry);

2808 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
íåy
->
efd_group
, &
e4b
);

2810 
	`BUG_ON
(
îr
 != 0);

2812 
	`•ö_lock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2813 
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 -
íåy
->
efd_cou¡
;

2814 
	`•ö_u∆ock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2816 
db
 = 
e4b
.
bd_öfo
;

2818 
cou¡
 +
íåy
->
efd_cou¡
;

2819 
cou¡2
++;

2820 
	`pxt4_lock_group
(
sb
, 
íåy
->
efd_group
);

2822 
	`rb_îa£
(&
íåy
->
efd_node
, &(
db
->
bb_‰ì_roŸ
));

2823 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

2831 i‡(!
	`ã°_›t
(
sb
, 
DISCARD
))

2832 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
db
);

2834 i‡(!
db
->
bb_‰ì_roŸ
.
rb_node
) {

2838 
	`put_∑ge
(
e4b
.
bd_buddy_∑ge
);

2839 
	`put_∑ge
(
e4b
.
bd_bôm≠_∑ge
);

2841 
	`pxt4_u∆ock_group
(
sb
, 
íåy
->
efd_group
);

2842 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

2843 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2845 
	`mb_debug
(1, "‰ìd %u block†ö %u såu˘uªs\n", 
cou¡
, 
cou¡2
);

2846 
	}
}

2852 
	$pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
)

2854 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2855 
pxt4_‰ì_d©a
 *
íåy
, *
tmp
;

2856 
bio
 *
disˇrd_bio
 = 
NULL
;

2857 
li°_hód
 
‰ìd_d©a_li°
;

2858 
li°_hód
 *
cut_pos
 = 
NULL
;

2859 
îr
;

2861 
	`INIT_LIST_HEAD
(&
‰ìd_d©a_li°
);

2863 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2864 
	`li°_f‹_óch_íåy
(
íåy
, &
sbi
->
s_‰ìd_d©a_li°
, 
efd_li°
) {

2865 i‡(
íåy
->
efd_tid
 !
commô_tid
)

2867 
cut_pos
 = &
íåy
->
efd_li°
;

2869 i‡(
cut_pos
)

2870 
	`li°_cut_posôi⁄
(&
‰ìd_d©a_li°
, &
sbi
->
s_‰ìd_d©a_li°
,

2871 
cut_pos
);

2872 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2874 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

2875 
	`li°_f‹_óch_íåy
(
íåy
, &
‰ìd_d©a_li°
, 
efd_li°
) {

2876 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
íåy
->
efd_group
,

2877 
íåy
->
efd_°¨t_˛u°î
,

2878 
íåy
->
efd_cou¡
,

2879 &
disˇrd_bio
);

2880 i‡(
îr
 &&Éº !-
EOPNOTSUPP
) {

2881 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

2883 " wôh %d", 
íåy
->
efd_group
,

2884 
íåy
->
efd_°¨t_˛u°î
,

2885 
íåy
->
efd_cou¡
, 
îr
);

2886 } i‡(
îr
 =-
EOPNOTSUPP
)

2890 i‡(
disˇrd_bio
) {

2891 
	`submô_bio_waô
(
disˇrd_bio
);

2892 
	`bio_put
(
disˇrd_bio
);

2896 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
‰ìd_d©a_li°
, 
efd_li°
)

2897 
	`pxt4_‰ì_d©a_ö_buddy
(
sb
, 
íåy
);

2898 
	}
}

2900 
__öô
 
	$pxt4_öô_mbÆloc
()

2902 
pxt4_p•a˚_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_¥óŒoc_•a˚
,

2903 
SLAB_RECLAIM_ACCOUNT
);

2904 i‡(
pxt4_p•a˚_ˇchï
 =
NULL
)

2905  -
ENOMEM
;

2907 
pxt4_ac_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_Æloˇti⁄_c⁄ãxt
,

2908 
SLAB_RECLAIM_ACCOUNT
);

2909 i‡(
pxt4_ac_ˇchï
 =
NULL
) {

2910 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2911  -
ENOMEM
;

2914 
pxt4_‰ì_d©a_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_‰ì_d©a
,

2915 
SLAB_RECLAIM_ACCOUNT
);

2916 i‡(
pxt4_‰ì_d©a_ˇchï
 =
NULL
) {

2917 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2918 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2919  -
ENOMEM
;

2922 
	}
}

2924 
	$pxt4_exô_mbÆloc
()

2930 
	`rcu_b¨rõr
();

2931 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2932 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2933 
	`kmem_ˇche_de°roy
(
pxt4_‰ì_d©a_ˇchï
);

2934 
	`pxt4_groupöfo_de°roy_¶abs
();

2935 
	}
}

2942 
noölöe_f‹_°ack
 

2943 
	$pxt4_mb_m¨k_disk•a˚_u£d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2944 
h™dÀ_t
 *
h™dÀ
, 
ª£rv_˛°rs
)

2946 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

2947 
pxt4_group_desc
 *
gdp
;

2948 
buf„r_hód
 *
gdp_bh
;

2949 
pxt4_sb_öfo
 *
sbi
;

2950 
su≥r_block
 *
sb
;

2951 
pxt4_fsblk_t
 
block
;

2952 
îr
, 
Àn
;

2954 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

2955 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 <= 0);

2957 
sb
 = 
ac
->
ac_sb
;

2958 
sbi
 = 
	`PXT4_SB
(
sb
);

2960 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2961 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

2962 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

2963 
bôm≠_bh
 = 
NULL
;

2964 
out_îr
;

2967 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

2968 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

2969 i‡(
îr
)

2970 
out_îr
;

2972 
îr
 = -
EIO
;

2973 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ac
->
ac_b_ex
.
„_group
, &
gdp_bh
);

2974 i‡(!
gdp
)

2975 
out_îr
;

2977 
	`pxt4_debug
("usög block grou∞%u(%d)\n", 
ac
->
ac_b_ex
.
„_group
,

2978 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
));

2980 
	`BUFFER_TRACE
(
gdp_bh
, "get_write_access");

2981 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdp_bh
);

2982 i‡(
îr
)

2983 
out_îr
;

2985 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

2987 
Àn
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

2988 i‡(!
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
Àn
)) {

2989 
	`pxt4_îr‹
(
sb
, "Allocating blocks %llu-%llu which overlap "

2990 "f†mëad©a", 
block
, block+
Àn
);

2995 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2996 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

2997 
ac
->
ac_b_ex
.
„_Àn
);

2998 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2999 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

3000 i‡(!
îr
)

3001 
îr
 = -
EFSCORRUPTED
;

3002 
out_îr
;

3005 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3006 #ifde‡
AGGRESSIVE_CHECK


3008 
i
;

3009 
i
 = 0; i < 
ac
->
ac_b_ex
.
„_Àn
; i++) {

3010 
	`BUG_ON
(
	`mb_ã°_bô
(
ac
->
ac_b_ex
.
„_°¨t
 + 
i
,

3011 
bôm≠_bh
->
b_d©a
));

3015 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

3016 
ac
->
ac_b_ex
.
„_Àn
);

3017 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

3018 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

3019 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

3020 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

3021 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
,

3022 
ac
->
ac_b_ex
.
„_group
, 
gdp
));

3024 
Àn
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë- 
ac
->
ac_b_ex
.
„_Àn
;

3025 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
Àn
);

3026 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
, 
bôm≠_bh
);

3027 
	`pxt4_group_desc_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
);

3029 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3030 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
ac
->
ac_b_ex
.
„_Àn
);

3034 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_DELALLOC_RESERVED
))

3036 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

3037 
ª£rv_˛°rs
);

3039 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

3040 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
,

3041 
ac
->
ac_b_ex
.
„_group
);

3042 
	`©omic64_sub
(
ac
->
ac_b_ex
.
„_Àn
,

3043 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

3044 
Êex_group
)->
‰ì_˛u°îs
);

3047 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

3048 i‡(
îr
)

3049 
out_îr
;

3050 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdp_bh
);

3052 
out_îr
:

3053 
	`bªl£
(
bôm≠_bh
);

3054  
îr
;

3055 
	}
}

3066 
	$pxt4_mb_n‹mÆize_group_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3068 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3069 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

3071 
	`BUG_ON
(
lg
 =
NULL
);

3072 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_SB
(
sb
)->
s_mb_group_¥óŒoc
;

3073 
	`mb_debug
(1, "#%u: goal %u blocks forÜocality group\n",

3074 
cuºít
->
pid
, 
ac
->
ac_g_ex
.
„_Àn
);

3075 
	}
}

3081 
noölöe_f‹_°ack
 

3082 
	$pxt4_mb_n‹mÆize_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3083 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

3085 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3086 
bsbôs
, 
max
;

3087 
pxt4_lblk_t
 
íd
;

3088 
loff_t
 
size
, 
°¨t_off
;

3089 
loff_t
 
‹ig_size
 
__maybe_unu£d
;

3090 
pxt4_lblk_t
 
°¨t
;

3091 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3092 
pxt4_¥óŒoc_•a˚
 *
∑
;

3096 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3100 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

3105 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_NOPREALLOC
)

3108 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
) {

3109 
	`pxt4_mb_n‹mÆize_group_ªque°
(
ac
);

3113 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

3117 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

3118 
size
 = sizê<< 
bsbôs
;

3119 i‡(
size
 < 
	`i_size_ªad
(
ac
->
ac_öode
))

3120 
size
 = 
	`i_size_ªad
(
ac
->
ac_öode
);

3121 
‹ig_size
 = 
size
;

3124 
max
 = 2 << 
bsbôs
;

3126 
	#NRL_CHECK_SIZE
(
ªq
, 
size
, 
max
, 
chunk_size
) \

3127 (
ªq
 <(
size
Ë|| 
max
 <(
chunk_size
))

	)

3131 
°¨t_off
 = 0;

3132 i‡(
size
 <= 16 * 1024) {

3133 
size
 = 16 * 1024;

3134 } i‡(
size
 <= 32 * 1024) {

3135 
size
 = 32 * 1024;

3136 } i‡(
size
 <= 64 * 1024) {

3137 
size
 = 64 * 1024;

3138 } i‡(
size
 <= 128 * 1024) {

3139 
size
 = 128 * 1024;

3140 } i‡(
size
 <= 256 * 1024) {

3141 
size
 = 256 * 1024;

3142 } i‡(
size
 <= 512 * 1024) {

3143 
size
 = 512 * 1024;

3144 } i‡(
size
 <= 1024 * 1024) {

3145 
size
 = 1024 * 1024;

3146 } i‡(
	`NRL_CHECK_SIZE
(
size
, 4 * 1024 * 1024, 
max
, 2 * 1024)) {

3147 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3148 (21 - 
bsbôs
)) << 21;

3149 
size
 = 2 * 1024 * 1024;

3150 } i‡(
	`NRL_CHECK_SIZE
(
size
, 8 * 1024 * 1024, 
max
, 4 * 1024)) {

3151 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3152 (22 - 
bsbôs
)) << 22;

3153 
size
 = 4 * 1024 * 1024;

3154 } i‡(
	`NRL_CHECK_SIZE
(
ac
->
ac_o_ex
.
„_Àn
,

3155 (8<<20)>>
bsbôs
, 
max
, 8 * 1024)) {

3156 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3157 (23 - 
bsbôs
)) << 23;

3158 
size
 = 8 * 1024 * 1024;

3160 
°¨t_off
 = (
loff_t
Ë
ac
->
ac_o_ex
.
„_logiˇl
 << 
bsbôs
;

3161 
size
 = (
loff_t
Ë
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3162 
ac
->
ac_o_ex
.
„_Àn
Ë<< 
bsbôs
;

3164 
size
 = sizê>> 
bsbôs
;

3165 
°¨t
 = 
°¨t_off
 >> 
bsbôs
;

3168 i‡(
¨
->
∂e·
 && 
°¨t
 <¨->
Œe·
) {

3169 
size
 -
¨
->
Œe·
 + 1 - 
°¨t
;

3170 
°¨t
 = 
¨
->
Œe·
 + 1;

3172 i‡(
¨
->
¥ight
 && 
°¨t
 + 
size
 - 1 >¨->
Ãight
)

3173 
size
 -
°¨t
 + sizê- 
¨
->
Ãight
;

3179 i‡(
size
 > 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
))

3180 
size
 = 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
);

3182 
íd
 = 
°¨t
 + 
size
;

3185 
	`rcu_ªad_lock
();

3186 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3187 
pxt4_lblk_t
 
∑_íd
;

3189 i‡(
∑
->
∑_dñëed
)

3191 
	`•ö_lock
(&
∑
->
∑_lock
);

3192 i‡(
∑
->
∑_dñëed
) {

3193 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3197 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3198 
∑
->
∑_Àn
);

3201 
	`BUG_ON
(!(
ac
->
ac_o_ex
.
„_logiˇl
 >
∑_íd
 ||

3202 
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
));

3205 i‡(
∑
->
∑_l°¨t
 >
íd
 || 
∑_íd
 <
°¨t
) {

3206 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3209 
	`BUG_ON
(
∑
->
∑_l°¨t
 <
°¨t
 && 
∑_íd
 >
íd
);

3212 i‡(
∑_íd
 <
ac
->
ac_o_ex
.
„_logiˇl
) {

3213 
	`BUG_ON
(
∑_íd
 < 
°¨t
);

3214 
°¨t
 = 
∑_íd
;

3215 } i‡(
∑
->
∑_l°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3216 
	`BUG_ON
(
∑
->
∑_l°¨t
 > 
íd
);

3217 
íd
 = 
∑
->
∑_l°¨t
;

3219 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3221 
	`rcu_ªad_u∆ock
();

3222 
size
 = 
íd
 - 
°¨t
;

3225 
	`rcu_ªad_lock
();

3226 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3227 
pxt4_lblk_t
 
∑_íd
;

3229 
	`•ö_lock
(&
∑
->
∑_lock
);

3230 i‡(
∑
->
∑_dñëed
 == 0) {

3231 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3232 
∑
->
∑_Àn
);

3233 
	`BUG_ON
(!(
°¨t
 >
∑_íd
 || 
íd
 <
∑
->
∑_l°¨t
));

3235 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3237 
	`rcu_ªad_u∆ock
();

3239 i‡(
°¨t
 + 
size
 <
ac
->
ac_o_ex
.
„_logiˇl
 &&

3240 
°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3241 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
,

3243 (Ë
°¨t
, (Ë
size
,

3244 (Ë
ac
->
ac_o_ex
.
„_logiˇl
);

3245 
	`BUG
();

3247 
	`BUG_ON
(
size
 <0 || sizê> 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
));

3253 
ac
->
ac_g_ex
.
„_logiˇl
 = 
°¨t
;

3254 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
size
);

3257 i‡(
¨
->
¥ight
 && (¨->
Ãight
 =(
°¨t
 + 
size
))) {

3259 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
¥ight
 - 
size
,

3260 &
ac
->
ac_f_ex
.
„_group
,

3261 &
ac
->
ac_f_ex
.
„_°¨t
);

3262 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3264 i‡(
¨
->
∂e·
 && (¨->
Œe·
 + 1 =
°¨t
)) {

3266 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
∂e·
 + 1,

3267 &
ac
->
ac_f_ex
.
„_group
,

3268 &
ac
->
ac_f_ex
.
„_°¨t
);

3269 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3272 
	`mb_debug
(1, "gﬂl: %u(wa†%uËblock†© %u\n", (Ë
size
,

3273 (Ë
‹ig_size
, (Ë
°¨t
);

3274 
	}
}

3276 
	$pxt4_mb_cﬁÀ˘_°©s
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3278 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3280 i‡(
sbi
->
s_mb_°©s
 && 
ac
->
ac_g_ex
.
„_Àn
 > 1) {

3281 
	`©omic_öc
(&
sbi
->
s_bÆ_ªqs
);

3282 
	`©omic_add
(
ac
->
ac_b_ex
.
„_Àn
, &
sbi
->
s_bÆ_Æloˇãd
);

3283 i‡(
ac
->
ac_b_ex
.
„_Àn
 >ac->
ac_o_ex
.fe_len)

3284 
	`©omic_öc
(&
sbi
->
s_bÆ_suc˚ss
);

3285 
	`©omic_add
(
ac
->
ac_found
, &
sbi
->
s_bÆ_ex_sˇ¬ed
);

3286 i‡(
ac
->
ac_g_ex
.
„_°¨t
 =ac->
ac_b_ex
.fe_start &&

3287 
ac
->
ac_g_ex
.
„_group
 =ac->
ac_b_ex
.fe_group)

3288 
	`©omic_öc
(&
sbi
->
s_bÆ_gﬂls
);

3289 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
)

3290 
	`©omic_öc
(&
sbi
->
s_bÆ_bªaks
);

3293 i‡(
ac
->
ac_›
 =
PXT4_MB_HISTORY_ALLOC
)

3294 
	`åa˚_pxt4_mbÆloc_Æloc
(
ac
);

3296 
	`åa˚_pxt4_mbÆloc_¥óŒoc
(
ac
);

3297 
	}
}

3305 
	$pxt4_disˇrd_Æloˇãd_blocks
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3307 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

3308 
pxt4_buddy
 
e4b
;

3309 
îr
;

3311 i‡(
∑
 =
NULL
) {

3312 i‡(
ac
->
ac_f_ex
.
„_Àn
 == 0)

3314 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
, &
e4b
);

3315 i‡(
îr
) {

3321 
	`WARN
(1, "mb_lﬂd_buddy faûed (%d)", 
îr
);

3324 
	`pxt4_lock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3325 
	`mb_‰ì_blocks
(
ac
->
ac_öode
, &
e4b
,ác->
ac_f_ex
.
„_°¨t
,

3326 
ac
->
ac_f_ex
.
„_Àn
);

3327 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3328 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3331 i‡(
∑
->
∑_ty≥
 =
MB_INODE_PA
)

3332 
∑
->
∑_‰ì
 +
ac
->
ac_b_ex
.
„_Àn
;

3333 
	}
}

3338 
	$pxt4_mb_u£_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3339 
pxt4_¥óŒoc_•a˚
 *
∑
)

3341 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3342 
pxt4_fsblk_t
 
°¨t
;

3343 
pxt4_fsblk_t
 
íd
;

3344 
Àn
;

3347 
°¨t
 = 
∑
->
∑_p°¨t
 + (
ac
->
ac_o_ex
.
„_logiˇl
 -Öa->
∑_l°¨t
);

3348 
íd
 = 
	`mö
(
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
),

3349 
°¨t
 + 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_o_ex
.
„_Àn
));

3350 
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
íd
 - 
°¨t
);

3351 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
°¨t
, &ac->
ac_b_ex
.
„_group
,

3352 &
ac
->
ac_b_ex
.
„_°¨t
);

3353 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3354 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3355 
ac
->
ac_∑
 = 
∑
;

3357 
	`BUG_ON
(
°¨t
 < 
∑
->
∑_p°¨t
);

3358 
	`BUG_ON
(
íd
 > 
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
));

3359 
	`BUG_ON
(
∑
->
∑_‰ì
 < 
Àn
);

3360 
∑
->
∑_‰ì
 -
Àn
;

3362 
	`mb_debug
(1, "u£ %Œu/%u from inodê∑ %p\n", 
°¨t
, 
Àn
, 
∑
);

3363 
	}
}

3368 
	$pxt4_mb_u£_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3369 
pxt4_¥óŒoc_•a˚
 *
∑
)

3371 
Àn
 = 
ac
->
ac_o_ex
.
„_Àn
;

3373 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
∑
->
∑_p°¨t
,

3374 &
ac
->
ac_b_ex
.
„_group
,

3375 &
ac
->
ac_b_ex
.
„_°¨t
);

3376 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3377 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3378 
ac
->
ac_∑
 = 
∑
;

3386 
	`mb_debug
(1, "u£ %u/%u from grou∞∑ %p\n", 
∑
->
∑_l°¨t
-
Àn
,Üen,Öa);

3387 
	}
}

3395 
pxt4_¥óŒoc_•a˚
 *

3396 
	$pxt4_mb_check_group_∑
(
pxt4_fsblk_t
 
gﬂl_block
,

3397 
pxt4_¥óŒoc_•a˚
 *
∑
,

3398 
pxt4_¥óŒoc_•a˚
 *
˝a
)

3400 
pxt4_fsblk_t
 
cur_di°™˚
, 
√w_di°™˚
;

3402 i‡(
˝a
 =
NULL
) {

3403 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3404  
∑
;

3406 
cur_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
˝a
->
∑_p°¨t
);

3407 
√w_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
∑
->
∑_p°¨t
);

3409 i‡(
cur_di°™˚
 <
√w_di°™˚
)

3410  
˝a
;

3413 
	`©omic_dec
(&
˝a
->
∑_cou¡
);

3414 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3415  
∑
;

3416 
	}
}

3421 
noölöe_f‹_°ack
 

3422 
	$pxt4_mb_u£_¥óŒoˇãd
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3424 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3425 
‹dî
, 
i
;

3426 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3427 
pxt4_loˇlôy_group
 *
lg
;

3428 
pxt4_¥óŒoc_•a˚
 *
∑
, *
˝a
 = 
NULL
;

3429 
pxt4_fsblk_t
 
gﬂl_block
;

3432 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3436 
	`rcu_ªad_lock
();

3437 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3441 i‡(
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
 ||

3442 
ac
->
ac_o_ex
.
„_logiˇl
 >(
∑
->
∑_l°¨t
 +

3443 
	`PXT4_C2B
(
sbi
, 
∑
->
∑_Àn
)))

3447 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)) &&

3448 (
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
) >

3449 
PXT4_MAX_BLOCK_FILE_PHYS
))

3453 
	`•ö_lock
(&
∑
->
∑_lock
);

3454 i‡(
∑
->
∑_dñëed
 =0 &&Öa->
∑_‰ì
) {

3455 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3456 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3457 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3458 
ac
->
ac_¸ôîü
 = 10;

3459 
	`rcu_ªad_u∆ock
();

3462 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3464 
	`rcu_ªad_u∆ock
();

3467 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
))

3471 
lg
 = 
ac
->
ac_lg
;

3472 i‡(
lg
 =
NULL
)

3474 
‹dî
 = 
	`Ês
(
ac
->
ac_o_ex
.
„_Àn
) - 1;

3475 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

3477 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

3479 
gﬂl_block
 = 
	`pxt4_gΩ_offs_to_block
(
ac
->
ac_sb
, &ac->
ac_g_ex
);

3484 
i
 = 
‹dî
; i < 
PREALLOC_TB_SIZE
; i++) {

3485 
	`rcu_ªad_lock
();

3486 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
i
],

3487 
∑_öode_li°
) {

3488 
	`•ö_lock
(&
∑
->
∑_lock
);

3489 i‡(
∑
->
∑_dñëed
 == 0 &&

3490 
∑
->
∑_‰ì
 >
ac
->
ac_o_ex
.
„_Àn
) {

3492 
˝a
 = 
	`pxt4_mb_check_group_∑
(
gﬂl_block
,

3493 
∑
, 
˝a
);

3495 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3497 
	`rcu_ªad_u∆ock
();

3499 i‡(
˝a
) {

3500 
	`pxt4_mb_u£_group_∑
(
ac
, 
˝a
);

3501 
ac
->
ac_¸ôîü
 = 20;

3505 
	}
}

3513 
	$pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

3514 
pxt4_group_t
 
group
)

3516 
rb_node
 *
n
;

3517 
pxt4_group_öfo
 *
gΩ
;

3518 
pxt4_‰ì_d©a
 *
íåy
;

3520 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3521 
n
 = 
	`rb_fú°
(&(
gΩ
->
bb_‰ì_roŸ
));

3523 
n
) {

3524 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_‰ì_d©a
, 
efd_node
);

3525 
	`pxt4_£t_bôs
(
bôm≠
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

3526 
n
 = 
	`rb_√xt
(n);

3529 
	}
}

3536 
noölöe_f‹_°ack


3537 
	$pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

3538 
pxt4_group_t
 
group
)

3540 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3541 
pxt4_¥óŒoc_•a˚
 *
∑
;

3542 
li°_hód
 *
cur
;

3543 
pxt4_group_t
 
grou≤r
;

3544 
pxt4_gΩblk_t
 
°¨t
;

3545 
¥óŒoˇãd
 = 0;

3546 
Àn
;

3556 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

3557 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

3558 
	`•ö_lock
(&
∑
->
∑_lock
);

3559 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

3560 &
grou≤r
, &
°¨t
);

3561 
Àn
 = 
∑
->
∑_Àn
;

3562 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3563 i‡(
	`u∆ikñy
(
Àn
 == 0))

3565 
	`BUG_ON
(
grou≤r
 !
group
);

3566 
	`pxt4_£t_bôs
(
bôm≠
, 
°¨t
, 
Àn
);

3567 
¥óŒoˇãd
 +
Àn
;

3569 
	`mb_debug
(1, "¥óŒoˇãd %u f‹ grou∞%u\n", 
¥óŒoˇãd
, 
group
);

3570 
	}
}

3572 
	$pxt4_mb_∑_ˇŒback
(
rcu_hód
 *
hód
)

3574 
pxt4_¥óŒoc_•a˚
 *
∑
;

3575 
∑
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_¥óŒoc_•a˚
, 
u
.
∑_rcu
);

3577 
	`BUG_ON
(
	`©omic_ªad
(&
∑
->
∑_cou¡
));

3578 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3579 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

3580 
	}
}

3586 
	$pxt4_mb_put_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3587 
su≥r_block
 *
sb
, 
pxt4_¥óŒoc_•a˚
 *
∑
)

3589 
pxt4_group_t
 
gΩ
;

3590 
pxt4_fsblk_t
 
gΩ_blk
;

3593 
	`•ö_lock
(&
∑
->
∑_lock
);

3594 i‡(!
	`©omic_dec_™d_ã°
(&
∑
->
∑_cou¡
Ë||Öa->
∑_‰ì
 != 0) {

3595 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3599 i‡(
∑
->
∑_dñëed
 == 1) {

3600 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3604 
∑
->
∑_dñëed
 = 1;

3605 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3607 
gΩ_blk
 = 
∑
->
∑_p°¨t
;

3612 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3613 
gΩ_blk
--;

3615 
gΩ
 = 
	`pxt4_gë_group_numbî
(
sb
, 
gΩ_blk
);

3631 
	`pxt4_lock_group
(
sb
, 
gΩ
);

3632 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3633 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

3635 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3636 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3637 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3639 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3640 
	}
}

3645 
noölöe_f‹_°ack
 

3646 
	$pxt4_mb_√w_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3648 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3649 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3650 
pxt4_¥óŒoc_•a˚
 *
∑
;

3651 
pxt4_group_öfo
 *
gΩ
;

3652 
pxt4_öode_öfo
 *
ei
;

3655 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3656 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3657 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3659 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3660 i‡(
∑
 =
NULL
)

3661  -
ENOMEM
;

3663 i‡(
ac
->
ac_b_ex
.
„_Àn
 <ác->
ac_g_ex
.fe_len) {

3664 
wöl
;

3665 
wös
;

3666 
wö
;

3667 
offs
;

3672 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_logiˇl
 >ác->
ac_o_ex
.fe_logical);

3673 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_Àn
 <ác->
ac_o_ex
.fe_len);

3678 
wöl
 = 
ac
->
ac_o_ex
.
„_logiˇl
 -ác->
ac_g_ex
.fe_logical;

3681 
wös
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
 -ác->
ac_o_ex
.fe_len);

3684 
wö
 = 
	`mö
(
wöl
, 
wös
);

3686 
offs
 = 
ac
->
ac_o_ex
.
„_logiˇl
 %

3687 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

3688 i‡(
offs
 && off†< 
wö
)

3689 
wö
 = 
offs
;

3691 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_o_ex
.fe_logical -

3692 
	`PXT4_NUM_B2C
(
sbi
, 
wö
);

3693 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_logiˇl
 <ác->
ac_b_ex
.fe_logical);

3694 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ác->
ac_b_ex
.fe_len);

3699 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3701 
∑
->
∑_l°¨t
 = 
ac
->
ac_b_ex
.
„_logiˇl
;

3702 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3703 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3704 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3705 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3706 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3707 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3708 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3709 
∑
->
∑_dñëed
 = 0;

3710 
∑
->
∑_ty≥
 = 
MB_INODE_PA
;

3712 
	`mb_debug
(1, "√w inodê∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3713 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3714 
	`åa˚_pxt4_mb_√w_öode_∑
(
ac
, 
∑
);

3716 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3717 
	`©omic_add
(
∑
->
∑_‰ì
, &
sbi
->
s_mb_¥óŒoˇãd
);

3719 
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3720 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3722 
∑
->
∑_obj_lock
 = &
ei
->
i_¥óŒoc_lock
;

3723 
∑
->
∑_öode
 = 
ac
->
ac_öode
;

3725 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3726 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3727 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3729 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3730 
	`li°_add_rcu
(&
∑
->
∑_öode_li°
, &
ei
->
i_¥óŒoc_li°
);

3731 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3734 
	}
}

3739 
noölöe_f‹_°ack
 

3740 
	$pxt4_mb_√w_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3742 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3743 
pxt4_loˇlôy_group
 *
lg
;

3744 
pxt4_¥óŒoc_•a˚
 *
∑
;

3745 
pxt4_group_öfo
 *
gΩ
;

3748 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3749 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3750 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3752 
	`BUG_ON
(
pxt4_p•a˚_ˇchï
 =
NULL
);

3753 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3754 i‡(
∑
 =
NULL
)

3755  -
ENOMEM
;

3759 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3761 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3762 
∑
->
∑_l°¨t
 =Öa->
∑_p°¨t
;

3763 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3764 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3765 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3766 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3767 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3768 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3769 
∑
->
∑_dñëed
 = 0;

3770 
∑
->
∑_ty≥
 = 
MB_GROUP_PA
;

3772 
	`mb_debug
(1, "√w grou∞∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3773 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3774 
	`åa˚_pxt4_mb_√w_group_∑
(
ac
, 
∑
);

3776 
	`pxt4_mb_u£_group_∑
(
ac
, 
∑
);

3777 
	`©omic_add
(
∑
->
∑_‰ì
, &
	`PXT4_SB
(
sb
)->
s_mb_¥óŒoˇãd
);

3779 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3780 
lg
 = 
ac
->
ac_lg
;

3781 
	`BUG_ON
(
lg
 =
NULL
);

3783 
∑
->
∑_obj_lock
 = &
lg
->
lg_¥óŒoc_lock
;

3784 
∑
->
∑_öode
 = 
NULL
;

3786 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3787 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3788 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3795 
	}
}

3797 
	$pxt4_mb_√w_¥óŒoˇti⁄
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3799 
îr
;

3801 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

3802 
îr
 = 
	`pxt4_mb_√w_group_∑
(
ac
);

3804 
îr
 = 
	`pxt4_mb_√w_öode_∑
(
ac
);

3805  
îr
;

3806 
	}
}

3816 
noölöe_f‹_°ack
 

3817 
	$pxt4_mb_ªÀa£_öode_∑
(
pxt4_buddy
 *
e4b
, 
buf„r_hód
 *
bôm≠_bh
,

3818 
pxt4_¥óŒoc_•a˚
 *
∑
)

3820 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3821 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3822 
íd
;

3823 
√xt
;

3824 
pxt4_group_t
 
group
;

3825 
pxt4_gΩblk_t
 
bô
;

3826 
gΩ_blk_°¨t
;

3827 
‰ì
 = 0;

3829 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3830 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3831 
gΩ_blk_°¨t
 = 
∑
->
∑_p°¨t
 - 
	`PXT4_C2B
(
sbi
, 
bô
);

3832 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3833 
íd
 = 
bô
 + 
∑
->
∑_Àn
;

3835 
bô
 < 
íd
) {

3836 
bô
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, bit);

3837 i‡(
bô
 >
íd
)

3839 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, 
bô
);

3840 
	`mb_debug
(1, " freeÖreallocated %u/%u in group %u\n",

3841 (Ë
	`pxt4_group_fú°_block_no
(
sb
, 
group
Ë+ 
bô
,

3842 (Ë
√xt
 - 
bô
, (Ë
group
);

3843 
‰ì
 +
√xt
 - 
bô
;

3845 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
√xt
 - bit);

3846 
	`åa˚_pxt4_mb_ªÀa£_öode_∑
(
∑
, (
gΩ_blk_°¨t
 +

3847 
	`PXT4_C2B
(
sbi
, 
bô
)),

3848 
√xt
 - 
bô
);

3849 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
, 
√xt
 - bit);

3850 
bô
 = 
√xt
 + 1;

3852 i‡(
‰ì
 !
∑
->
∑_‰ì
) {

3853 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_CRIT
,

3855 
∑
, (Ë∑->
∑_l°¨t
,

3856 (Ë
∑
->
∑_p°¨t
,

3857 (Ë
∑
->
∑_Àn
);

3858 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0, "free %u,Öa_free %u",

3859 
‰ì
, 
∑
->
∑_‰ì
);

3865 
	`©omic_add
(
‰ì
, &
sbi
->
s_mb_disˇrded
);

3868 
	}
}

3870 
noölöe_f‹_°ack
 

3871 
	$pxt4_mb_ªÀa£_group_∑
(
pxt4_buddy
 *
e4b
,

3872 
pxt4_¥óŒoc_•a˚
 *
∑
)

3874 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3875 
pxt4_group_t
 
group
;

3876 
pxt4_gΩblk_t
 
bô
;

3878 
	`åa˚_pxt4_mb_ªÀa£_group_∑
(
sb
, 
∑
);

3879 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3880 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3881 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3882 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
,Öa->
∑_Àn
);

3883 
	`©omic_add
(
∑
->
∑_Àn
, &
	`PXT4_SB
(
sb
)->
s_mb_disˇrded
);

3884 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
∑
->
∑_Àn
);

3887 
	}
}

3898 
noölöe_f‹_°ack
 

3899 
	$pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

3900 
pxt4_group_t
 
group
, 
√eded
)

3902 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3903 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

3904 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

3905 
li°_hód
 
li°
;

3906 
pxt4_buddy
 
e4b
;

3907 
îr
;

3908 
busy
 = 0;

3909 
‰ì
 = 0;

3911 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ grou∞%u\n", 
group
);

3913 i‡(
	`li°_em±y
(&
gΩ
->
bb_¥óŒoc_li°
))

3916 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

3917 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

3918 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

3919 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

3920 
îr
, 
group
);

3924 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

3925 i‡(
îr
) {

3926 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

3927 
îr
, 
group
);

3928 
	`put_bh
(
bôm≠_bh
);

3932 i‡(
√eded
 == 0)

3933 
√eded
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) + 1;

3935 
	`INIT_LIST_HEAD
(&
li°
);

3936 
ª≥©
:

3937 
	`pxt4_lock_group
(
sb
, 
group
);

3938 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
,

3939 &
gΩ
->
bb_¥óŒoc_li°
, 
∑_group_li°
) {

3940 
	`•ö_lock
(&
∑
->
∑_lock
);

3941 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

3942 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3943 
busy
 = 1;

3946 i‡(
∑
->
∑_dñëed
) {

3947 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3952 
∑
->
∑_dñëed
 = 1;

3955 
‰ì
 +
∑
->
∑_‰ì
;

3957 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3959 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3960 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

3964 i‡(
‰ì
 < 
√eded
 && 
busy
) {

3965 
busy
 = 0;

3966 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3967 
	`c⁄d_ªsched
();

3968 
ª≥©
;

3972 i‡(
	`li°_em±y
(&
li°
)) {

3973 
	`BUG_ON
(
‰ì
 != 0);

3974 
out
;

3978 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

3981 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3982 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3983 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3985 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3986 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

3988 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

3990 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

3991 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3994 
out
:

3995 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3996 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3997 
	`put_bh
(
bôm≠_bh
);

3998  
‰ì
;

3999 
	}
}

4010 
	$pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *inode)

4012 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4013 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4014 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4015 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4016 
pxt4_group_t
 
group
 = 0;

4017 
li°_hód
 
li°
;

4018 
pxt4_buddy
 
e4b
;

4019 
îr
;

4021 i‡(!
	`S_ISREG
(
öode
->
i_mode
)) {

4026 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ inodê%lu\n", 
öode
->
i_öo
);

4027 
	`åa˚_pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4029 
	`INIT_LIST_HEAD
(&
li°
);

4031 
ª≥©
:

4033 
	`•ö_lock
(&
ei
->
i_¥óŒoc_lock
);

4034 !
	`li°_em±y
(&
ei
->
i_¥óŒoc_li°
)) {

4035 
∑
 = 
	`li°_íåy
(
ei
->
i_¥óŒoc_li°
.
√xt
,

4036 
pxt4_¥óŒoc_•a˚
, 
∑_öode_li°
);

4037 
	`BUG_ON
(
∑
->
∑_obj_lock
 !&
ei
->
i_¥óŒoc_lock
);

4038 
	`•ö_lock
(&
∑
->
∑_lock
);

4039 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4042 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4043 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4044 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4046 
	`WARN_ON
(1);

4047 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4048 
ª≥©
;

4051 i‡(
∑
->
∑_dñëed
 == 0) {

4052 
∑
->
∑_dñëed
 = 1;

4053 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4054 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4055 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

4060 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4061 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4075 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4076 
ª≥©
;

4078 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4080 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

4081 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_INODE_PA
);

4082 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4084 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4085 
GFP_NOFS
|
__GFP_NOFAIL
);

4086 i‡(
îr
) {

4087 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4088 
îr
, 
group
);

4092 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

4093 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4094 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4095 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

4096 
îr
, 
group
);

4097 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4101 
	`pxt4_lock_group
(
sb
, 
group
);

4102 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4103 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

4104 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4106 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4107 
	`put_bh
(
bôm≠_bh
);

4109 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4110 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4112 
	}
}

4114 #ifde‡
CONFIG_PXT4_DEBUG


4115 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4117 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4118 
pxt4_group_t
 
ngroups
, 
i
;

4120 i‡(!
pxt4_mbÆloc_debug
 ||

4121 (
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
))

4124 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "Can'tállocate:"

4126 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "status %d flags %d",

4127 
ac
->
ac_°©us
,ác->
ac_Êags
);

4128 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "orig %lu/%lu/%lu@%lu, "

4131 ()
ac
->
ac_o_ex
.
„_group
,

4132 ()
ac
->
ac_o_ex
.
„_°¨t
,

4133 ()
ac
->
ac_o_ex
.
„_Àn
,

4134 ()
ac
->
ac_o_ex
.
„_logiˇl
,

4135 ()
ac
->
ac_g_ex
.
„_group
,

4136 ()
ac
->
ac_g_ex
.
„_°¨t
,

4137 ()
ac
->
ac_g_ex
.
„_Àn
,

4138 ()
ac
->
ac_g_ex
.
„_logiˇl
,

4139 ()
ac
->
ac_b_ex
.
„_group
,

4140 ()
ac
->
ac_b_ex
.
„_°¨t
,

4141 ()
ac
->
ac_b_ex
.
„_Àn
,

4142 ()
ac
->
ac_b_ex
.
„_logiˇl
,

4143 ()
ac
->
ac_¸ôîü
);

4144 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "%d found",ác->
ac_found
);

4145 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "groups: ");

4146 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4147 
i
 = 0; i < 
ngroups
; i++) {

4148 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

4149 
pxt4_¥óŒoc_•a˚
 *
∑
;

4150 
pxt4_gΩblk_t
 
°¨t
;

4151 
li°_hód
 *
cur
;

4152 
	`pxt4_lock_group
(
sb
, 
i
);

4153 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

4154 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
,

4155 
∑_group_li°
);

4156 
	`•ö_lock
(&
∑
->
∑_lock
);

4157 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

4158 
NULL
, &
°¨t
);

4159 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4160 
	`¥ötk
(
KERN_ERR
 "PA:%u:%d:%u \n", 
i
,

4161 
°¨t
, 
∑
->
∑_Àn
);

4163 
	`pxt4_u∆ock_group
(
sb
, 
i
);

4165 i‡(
gΩ
->
bb_‰ì
 == 0)

4167 
	`¥ötk
(
KERN_ERR
 "%u: %d/%d \n",

4168 
i
, 
gΩ
->
bb_‰ì
, gΩ->
bb_‰agmíts
);

4170 
	`¥ötk
(
KERN_ERR
 "\n");

4171 
	}
}

4173 
ölöe
 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4176 
	}
}

4186 
	$pxt4_mb_group_‹_fûe
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4188 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4189 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

4190 
loff_t
 
size
, 
isize
;

4192 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

4195 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

4198 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

4199 
isize
 = (
	`i_size_ªad
(
ac
->
ac_öode
Ë+ác->
ac_sb
->
s_blocksize
 - 1)

4200 >> 
bsbôs
;

4202 i‡((
size
 =
isize
Ë&& !
	`pxt4_fs_is_busy
(
sbi
) &&

4203 !
	`öode_is_›í_f‹_wrôe
(
ac
->
ac_öode
)) {

4204 
ac
->
ac_Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4208 i‡(
sbi
->
s_mb_group_¥óŒoc
 <= 0) {

4209 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4214 
size
 = 
	`max
(size, 
isize
);

4215 i‡(
size
 > 
sbi
->
s_mb_°ªam_ªque°
) {

4216 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4220 
	`BUG_ON
(
ac
->
ac_lg
 !
NULL
);

4226 
ac
->
ac_lg
 = 
	`øw_˝u_±r
(
sbi
->
s_loˇlôy_groups
);

4229 
ac
->
ac_Êags
 |
PXT4_MB_HINT_GROUP_ALLOC
;

4232 
	`muãx_lock
(&
ac
->
ac_lg
->
lg_muãx
);

4233 
	}
}

4235 
noölöe_f‹_°ack
 

4236 
	$pxt4_mb_öôülize_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

4237 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

4239 
su≥r_block
 *
sb
 = 
¨
->
öode
->
i_sb
;

4240 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4241 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

4242 
pxt4_group_t
 
group
;

4243 
Àn
;

4244 
pxt4_fsblk_t
 
gﬂl
;

4245 
pxt4_gΩblk_t
 
block
;

4248 
Àn
 = 
¨
->len;

4251 i‡(
Àn
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

4252 
Àn
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

4255 
gﬂl
 = 
¨
->goal;

4256 i‡(
gﬂl
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

4257 
gﬂl
 >
	`pxt4_blocks_cou¡
(
es
))

4258 
gﬂl
 = 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

4259 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
gﬂl
, &
group
, &
block
);

4262 
ac
->
ac_b_ex
.
„_logiˇl
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
¨
->
logiˇl
);

4263 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

4264 
ac
->
ac_sb
 = 
sb
;

4265 
ac
->
ac_öode
 = 
¨
->
öode
;

4266 
ac
->
ac_o_ex
.
„_logiˇl
 =ác->
ac_b_ex
.fe_logical;

4267 
ac
->
ac_o_ex
.
„_group
 = 
group
;

4268 
ac
->
ac_o_ex
.
„_°¨t
 = 
block
;

4269 
ac
->
ac_o_ex
.
„_Àn
 = 
Àn
;

4270 
ac
->
ac_g_ex
 =ác->
ac_o_ex
;

4271 
ac
->
ac_Êags
 = 
¨
->
Êags
;

4275 
	`pxt4_mb_group_‹_fûe
(
ac
);

4277 
	`mb_debug
(1, "initác: %u blocks @ %u, goal %u, flags %x, 2^%d, "

4279 (Ë
¨
->
Àn
, (Ë¨->
logiˇl
,

4280 (Ë
¨
->
gﬂl
, 
ac
->
ac_Êags
,ác->
ac_2‹dî
,

4281 (Ë
¨
->
Œe·
, (Ë¨->
∂e·
,

4282 (Ë
¨
->
Ãight
, (Ë¨->
¥ight
,

4283 
	`öode_is_›í_f‹_wrôe
(
¨
->
öode
) ? "" : "non-");

4286 
	}
}

4288 
noölöe_f‹_°ack
 

4289 
	$pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

4290 
pxt4_loˇlôy_group
 *
lg
,

4291 
‹dî
, 
tŸÆ_íåõs
)

4293 
pxt4_group_t
 
group
 = 0;

4294 
pxt4_buddy
 
e4b
;

4295 
li°_hód
 
disˇrd_li°
;

4296 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4298 
	`mb_debug
(1, "discardÜocality groupÖreallocation\n");

4300 
	`INIT_LIST_HEAD
(&
disˇrd_li°
);

4302 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4303 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4304 
∑_öode_li°
) {

4305 
	`•ö_lock
(&
∑
->
∑_lock
);

4306 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4312 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4315 i‡(
∑
->
∑_dñëed
) {

4316 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4320 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_GROUP_PA
);

4323 
∑
->
∑_dñëed
 = 1;

4324 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4326 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4327 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
disˇrd_li°
);

4329 
tŸÆ_íåõs
--;

4330 i‡(
tŸÆ_íåõs
 <= 5) {

4340 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4342 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
disˇrd_li°
, 
u
.
∑_tmp_li°
) {

4343 
îr
;

4345 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4346 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4347 
GFP_NOFS
|
__GFP_NOFAIL
);

4348 i‡(
îr
) {

4349 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4350 
îr
, 
group
);

4353 
	`pxt4_lock_group
(
sb
, 
group
);

4354 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4355 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

4356 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4358 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4359 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4360 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4362 
	}
}

4373 
	$pxt4_mb_add_n_åim
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4375 
‹dî
, 
added
 = 0, 
lg_¥óŒoc_cou¡
 = 1;

4376 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4377 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

4378 
pxt4_¥óŒoc_•a˚
 *
tmp_∑
, *
∑
 = 
ac
->
ac_∑
;

4380 
‹dî
 = 
	`Ês
(
∑
->
∑_‰ì
) - 1;

4381 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

4383 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

4385 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4386 
	`li°_f‹_óch_íåy_rcu
(
tmp_∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4387 
∑_öode_li°
) {

4388 
	`•ö_lock
(&
tmp_∑
->
∑_lock
);

4389 i‡(
tmp_∑
->
∑_dñëed
) {

4390 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4393 i‡(!
added
 && 
∑
->
∑_‰ì
 < 
tmp_∑
->pa_free) {

4395 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4396 &
tmp_∑
->
∑_öode_li°
);

4397 
added
 = 1;

4403 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4404 
lg_¥óŒoc_cou¡
++;

4406 i‡(!
added
)

4407 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4408 &
lg
->
lg_¥óŒoc_li°
[
‹dî
]);

4409 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4412 i‡(
lg_¥óŒoc_cou¡
 > 8) {

4413 
	`pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
sb
, 
lg
,

4414 
‹dî
, 
lg_¥óŒoc_cou¡
);

4418 
	}
}

4423 
	$pxt4_mb_ªÀa£_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4425 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4426 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

4427 i‡(
∑
) {

4428 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
) {

4430 
	`•ö_lock
(&
∑
->
∑_lock
);

4431 
∑
->
∑_p°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4432 
∑
->
∑_l°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4433 
∑
->
∑_‰ì
 -
ac
->
ac_b_ex
.
„_Àn
;

4434 
∑
->
∑_Àn
 -
ac
->
ac_b_ex
.
„_Àn
;

4435 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4438 i‡(
∑
) {

4445 i‡((
∑
->
∑_ty≥
 =
MB_GROUP_PA
Ë&& 
	`likñy
’a->
∑_‰ì
)) {

4446 
	`•ö_lock
(
∑
->
∑_obj_lock
);

4447 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4448 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

4449 
	`pxt4_mb_add_n_åim
(
ac
);

4451 
	`pxt4_mb_put_∑
(
ac
,ác->
ac_sb
, 
∑
);

4453 i‡(
ac
->
ac_bôm≠_∑ge
)

4454 
	`put_∑ge
(
ac
->
ac_bôm≠_∑ge
);

4455 i‡(
ac
->
ac_buddy_∑ge
)

4456 
	`put_∑ge
(
ac
->
ac_buddy_∑ge
);

4457 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

4458 
	`muãx_u∆ock
(&
ac
->
ac_lg
->
lg_muãx
);

4459 
	`pxt4_mb_cﬁÀ˘_°©s
(
ac
);

4461 
	}
}

4463 
	$pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
, 
√eded
)

4465 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4466 
ªt
;

4467 
‰ìd
 = 0;

4469 
	`åa˚_pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
√eded
);

4470 
i
 = 0; i < 
ngroups
 && 
√eded
 > 0; i++) {

4471 
ªt
 = 
	`pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
sb
, 
i
, 
√eded
);

4472 
‰ìd
 +
ªt
;

4473 
√eded
 -
ªt
;

4476  
‰ìd
;

4477 
	}
}

4484 
pxt4_fsblk_t
 
	$pxt4_mb_√w_blocks
(
h™dÀ_t
 *
h™dÀ
,

4485 
pxt4_Æloˇti⁄_ªque°
 *
¨
, *
îΩ
)

4487 
‰ìd
;

4488 
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
 = 
NULL
;

4489 
pxt4_sb_öfo
 *
sbi
;

4490 
su≥r_block
 *
sb
;

4491 
pxt4_fsblk_t
 
block
 = 0;

4492 
öquŸa
 = 0;

4493 
ª£rv_˛°rs
 = 0;

4495 
	`might_¶ìp
();

4496 
sb
 = 
¨
->
öode
->
i_sb
;

4497 
sbi
 = 
	`PXT4_SB
(
sb
);

4499 
	`åa˚_pxt4_ªque°_blocks
(
¨
);

4502 i‡(
	`pxt4_is_quŸa_fûe
(
¨
->
öode
))

4503 
¨
->
Êags
 |
PXT4_MB_USE_ROOT_BLOCKS
;

4505 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0) {

4510 
¨
->
Àn
 &&

4511 
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 
¨
->
Àn
,ár->
Êags
)) {

4514 
	`c⁄d_ªsched
();

4515 
¨
->
Àn
 =ár->len >> 1;

4517 i‡(!
¨
->
Àn
) {

4518 *
îΩ
 = -
ENOSPC
;

4521 
ª£rv_˛°rs
 = 
¨
->
Àn
;

4522 i‡(
¨
->
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
) {

4523 
	`dquŸ_Æloc_block_noÁû
(
¨
->
öode
,

4524 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
));

4526 
¨
->
Àn
 &&

4527 
	`dquŸ_Æloc_block
(
¨
->
öode
,

4528 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
))) {

4530 
¨
->
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4531 
¨
->
Àn
--;

4534 
öquŸa
 = 
¨
->
Àn
;

4535 i‡(
¨
->
Àn
 == 0) {

4536 *
îΩ
 = -
EDQUOT
;

4537 
out
;

4541 
ac
 = 
	`kmem_ˇche_zÆloc
(
pxt4_ac_ˇchï
, 
GFP_NOFS
);

4542 i‡(!
ac
) {

4543 
¨
->
Àn
 = 0;

4544 *
îΩ
 = -
ENOMEM
;

4545 
out
;

4548 *
îΩ
 = 
	`pxt4_mb_öôülize_c⁄ãxt
(
ac
, 
¨
);

4549 i‡(*
îΩ
) {

4550 
¨
->
Àn
 = 0;

4551 
out
;

4554 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_PREALLOC
;

4555 i‡(!
	`pxt4_mb_u£_¥óŒoˇãd
(
ac
)) {

4556 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_ALLOC
;

4557 
	`pxt4_mb_n‹mÆize_ªque°
(
ac
, 
¨
);

4558 
ª≥©
:

4560 *
îΩ
 = 
	`pxt4_mb_ªguœr_Æloˇt‹
(
ac
);

4561 i‡(*
îΩ
)

4562 
disˇrd_™d_exô
;

4567 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
 &&

4568 
ac
->
ac_o_ex
.
„_Àn
 <ác->
ac_b_ex
.fe_len)

4569 *
îΩ
 = 
	`pxt4_mb_√w_¥óŒoˇti⁄
(
ac
);

4570 i‡(*
îΩ
) {

4571 
disˇrd_™d_exô
:

4572 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4573 
îrout
;

4576 i‡(
	`likñy
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)) {

4577 *
îΩ
 = 
	`pxt4_mb_m¨k_disk•a˚_u£d
(
ac
, 
h™dÀ
, 
ª£rv_˛°rs
);

4578 i‡(*
îΩ
) {

4579 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4580 
îrout
;

4582 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

4583 
¨
->
Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

4586 
‰ìd
 = 
	`pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
ac
->
ac_o_ex
.
„_Àn
);

4587 i‡(
‰ìd
)

4588 
ª≥©
;

4589 *
îΩ
 = -
ENOSPC
;

4592 
îrout
:

4593 i‡(*
îΩ
) {

4594 
ac
->
ac_b_ex
.
„_Àn
 = 0;

4595 
¨
->
Àn
 = 0;

4596 
	`pxt4_mb_show_ac
(
ac
);

4598 
	`pxt4_mb_ªÀa£_c⁄ãxt
(
ac
);

4599 
out
:

4600 i‡(
ac
)

4601 
	`kmem_ˇche_‰ì
(
pxt4_ac_ˇchï
, 
ac
);

4602 i‡(
öquŸa
 && 
¨
->
Àn
 < inquota)

4603 
	`dquŸ_‰ì_block
(
¨
->
öode
, 
	`PXT4_C2B
(
sbi
, 
öquŸa
 -ár->
Àn
));

4604 i‡(!
¨
->
Àn
) {

4605 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0)

4607 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

4608 
ª£rv_˛°rs
);

4611 
	`åa˚_pxt4_Æloˇã_blocks
(
¨
, ()
block
);

4613  
block
;

4614 
	}
}

4621 
	$pxt4_åy_mîge_‰ìd_exã¡
(
pxt4_sb_öfo
 *
sbi
,

4622 
pxt4_‰ì_d©a
 *
íåy
,

4623 
pxt4_‰ì_d©a
 *
√w_íåy
,

4624 
rb_roŸ
 *
íåy_rb_roŸ
)

4626 i‡((
íåy
->
efd_tid
 !
√w_íåy
->efd_tid) ||

4627 (
íåy
->
efd_group
 !
√w_íåy
->efd_group))

4629 i‡(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
 ==

4630 
√w_íåy
->
efd_°¨t_˛u°î
) {

4631 
√w_íåy
->
efd_°¨t_˛u°î
 = 
íåy
->efd_start_cluster;

4632 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4633 } i‡(
√w_íåy
->
efd_°¨t_˛u°î
 +Çew_íåy->
efd_cou¡
 ==

4634 
íåy
->
efd_°¨t_˛u°î
) {

4635 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4638 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4639 
	`li°_dñ
(&
íåy
->
efd_li°
);

4640 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4641 
	`rb_îa£
(&
íåy
->
efd_node
, 
íåy_rb_roŸ
);

4642 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

4643 
	}
}

4645 
noölöe_f‹_°ack
 

4646 
	$pxt4_mb_‰ì_mëad©a
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_buddy
 *
e4b
,

4647 
pxt4_‰ì_d©a
 *
√w_íåy
)

4649 
pxt4_group_t
 
group
 = 
e4b
->
bd_group
;

4650 
pxt4_gΩblk_t
 
˛u°î
;

4651 
pxt4_gΩblk_t
 
˛u°îs
 = 
√w_íåy
->
efd_cou¡
;

4652 
pxt4_‰ì_d©a
 *
íåy
;

4653 
pxt4_group_öfo
 *
db
 = 
e4b
->
bd_öfo
;

4654 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

4655 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4656 
rb_node
 **
n
 = &
db
->
bb_‰ì_roŸ
.rb_node, *
node
;

4657 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
;

4659 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

4660 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

4661 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

4663 
√w_node
 = &
√w_íåy
->
efd_node
;

4664 
˛u°î
 = 
√w_íåy
->
efd_°¨t_˛u°î
;

4666 i‡(!*
n
) {

4672 
	`gë_∑ge
(
e4b
->
bd_buddy_∑ge
);

4673 
	`gë_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

4675 *
n
) {

4676 
∑ª¡
 = *
n
;

4677 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_‰ì_d©a
, 
efd_node
);

4678 i‡(
˛u°î
 < 
íåy
->
efd_°¨t_˛u°î
)

4679 
n
 = &(*n)->
rb_À·
;

4680 i‡(
˛u°î
 >(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
))

4681 
n
 = &(*n)->
rb_right
;

4683 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0,

4684 
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

4685 
	`PXT4_C2B
(
sbi
, 
˛u°î
),

4691 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

4692 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
db
->
bb_‰ì_roŸ
);

4695 
node
 = 
	`rb_¥ev
(
√w_node
);

4696 i‡(
node
) {

4697 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4698 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4699 &(
db
->
bb_‰ì_roŸ
));

4702 
node
 = 
	`rb_√xt
(
√w_node
);

4703 i‡(
node
) {

4704 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4705 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4706 &(
db
->
bb_‰ì_roŸ
));

4709 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4710 
	`li°_add_èû
(&
√w_íåy
->
efd_li°
, &
sbi
->
s_‰ìd_d©a_li°
);

4711 
sbi
->
s_mb_‰ì_≥ndög
 +
˛u°îs
;

4712 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4714 
	}
}

4725 
	$pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4726 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

4727 
cou¡
, 
Êags
)

4729 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4730 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4731 
pxt4_group_desc
 *
gdp
;

4732 
ovîÊow
;

4733 
pxt4_gΩblk_t
 
bô
;

4734 
buf„r_hód
 *
gd_bh
;

4735 
pxt4_group_t
 
block_group
;

4736 
pxt4_sb_öfo
 *
sbi
;

4737 
pxt4_buddy
 
e4b
;

4738 
cou¡_˛u°îs
;

4739 
îr
 = 0;

4740 
ªt
;

4742 
	`might_¶ìp
();

4743 i‡(
bh
) {

4744 i‡(
block
)

4745 
	`BUG_ON
(
block
 !
bh
->
b_blockƒ
);

4747 
block
 = 
bh
->
b_blockƒ
;

4750 
sbi
 = 
	`PXT4_SB
(
sb
);

4751 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_VALIDATED
) &&

4752 !
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
cou¡
)) {

4753 
	`pxt4_îr‹
(
sb
, "Freeing blocksÇot in datazone - "

4754 "block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4755 
îr‹_ªtu∫
;

4758 
	`pxt4_debug
("‰ìög block %Œu\n", 
block
);

4759 
	`åa˚_pxt4_‰ì_blocks
(
öode
, 
block
, 
cou¡
, 
Êags
);

4761 i‡(
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4762 
	`BUG_ON
(
cou¡
 > 1);

4764 
	`pxt4_f‹gë
(
h™dÀ
, 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
,

4765 
öode
, 
bh
, 
block
);

4775 
ovîÊow
 = 
	`PXT4_PBLK_COFF
(
sbi
, 
block
);

4776 i‡(
ovîÊow
) {

4777 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
) {

4778 
ovîÊow
 = 
sbi
->
s_˛u°î_øtio
 - overflow;

4779 
block
 +
ovîÊow
;

4780 i‡(
cou¡
 > 
ovîÊow
)

4781 
cou¡
 -
ovîÊow
;

4785 
block
 -
ovîÊow
;

4786 
cou¡
 +
ovîÊow
;

4789 
ovîÊow
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
cou¡
);

4790 i‡(
ovîÊow
) {

4791 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
) {

4792 i‡(
cou¡
 > 
ovîÊow
)

4793 
cou¡
 -
ovîÊow
;

4797 
cou¡
 +
sbi
->
s_˛u°î_øtio
 - 
ovîÊow
;

4800 i‡(!
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4801 
i
;

4802 
is_mëad©a
 = 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
;

4804 
i
 = 0; i < 
cou¡
; i++) {

4805 
	`c⁄d_ªsched
();

4806 i‡(
is_mëad©a
)

4807 
bh
 = 
	`sb_föd_gë_block
(
öode
->
i_sb
, 
block
 + 
i
);

4808 
	`pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block
 + 
i
);

4812 
do_m‹e
:

4813 
ovîÊow
 = 0;

4814 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

4816 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(

4817 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
))))

4824 i‡(
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

4825 
ovîÊow
 = 
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 -

4826 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

4827 
cou¡
 -
ovîÊow
;

4829 
cou¡_˛u°îs
 = 
	`PXT4_NUM_B2C
(
sbi
, 
cou¡
);

4830 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

4831 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4832 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4833 
bôm≠_bh
 = 
NULL
;

4834 
îr‹_ªtu∫
;

4836 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

4837 i‡(!
gdp
) {

4838 
îr
 = -
EIO
;

4839 
îr‹_ªtu∫
;

4842 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4843 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4844 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4845 
sbi
->
s_ôb_≥r_group
) ||

4846 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4847 
sbi
->
s_ôb_≥r_group
)) {

4849 
	`pxt4_îr‹
(
sb
, "Freeing blocks in system zone - "

4850 "Block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4852 
îr‹_ªtu∫
;

4855 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

4856 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

4857 i‡(
îr
)

4858 
îr‹_ªtu∫
;

4865 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

4866 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

4867 i‡(
îr
)

4868 
îr‹_ªtu∫
;

4869 #ifde‡
AGGRESSIVE_CHECK


4871 
i
;

4872 
i
 = 0; i < 
cou¡_˛u°îs
; i++)

4873 
	`BUG_ON
(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
));

4876 
	`åa˚_pxt4_mbÆloc_‰ì
(
sb
, 
öode
, 
block_group
, 
bô
, 
cou¡_˛u°îs
);

4879 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
block_group
, &
e4b
,

4880 
GFP_NOFS
|
__GFP_NOFAIL
);

4881 i‡(
îr
)

4882 
îr‹_ªtu∫
;

4890 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

4891 ((
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
) ||

4892 !
	`pxt4_should_wrôeback_d©a
(
öode
))) {

4893 
pxt4_‰ì_d©a
 *
√w_íåy
;

4898 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_‰ì_d©a_ˇchï
,

4899 
GFP_NOFS
|
__GFP_NOFAIL
);

4900 
√w_íåy
->
efd_°¨t_˛u°î
 = 
bô
;

4901 
√w_íåy
->
efd_group
 = 
block_group
;

4902 
√w_íåy
->
efd_cou¡
 = 
cou¡_˛u°îs
;

4903 
√w_íåy
->
efd_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

4905 
	`pxt4_lock_group
(
sb
, 
block_group
);

4906 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4907 
	`pxt4_mb_‰ì_mëad©a
(
h™dÀ
, &
e4b
, 
√w_íåy
);

4913 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4914 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
block_group
, 
bô
, 
cou¡
,

4915 
NULL
);

4916 i‡(
îr
 &&Éº !-
EOPNOTSUPP
)

4917 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

4919 " wôh %d", 
block_group
, 
bô
, 
cou¡
,

4920 
îr
);

4922 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
e4b
.
bd_öfo
);

4924 
	`pxt4_lock_group
(
sb
, 
block_group
);

4925 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4926 
	`mb_‰ì_blocks
(
öode
, &
e4b
, 
bô
, 
cou¡_˛u°îs
);

4929 
ªt
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë+ 
cou¡_˛u°îs
;

4930 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
ªt
);

4931 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
);

4932 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

4933 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

4935 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

4936 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

4937 
	`©omic64_add
(
cou¡_˛u°îs
,

4938 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

4939 
Êex_group
)->
‰ì_˛u°îs
);

4947 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)) {

4948 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
))

4949 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
cou¡_˛u°îs
));

4950 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

4951 
cou¡_˛u°îs
);

4954 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4957 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

4958 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

4961 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

4962 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

4963 i‡(!
îr
)

4964 
îr
 = 
ªt
;

4966 i‡(
ovîÊow
 && !
îr
) {

4967 
block
 +
cou¡
;

4968 
cou¡
 = 
ovîÊow
;

4969 
	`put_bh
(
bôm≠_bh
);

4970 
do_m‹e
;

4972 
îr‹_ªtu∫
:

4973 
	`bªl£
(
bôm≠_bh
);

4974 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

4976 
	}
}

4987 
	$pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

4988 
pxt4_fsblk_t
 
block
, 
cou¡
)

4990 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4991 
buf„r_hód
 *
gd_bh
;

4992 
pxt4_group_t
 
block_group
;

4993 
pxt4_gΩblk_t
 
bô
;

4994 
i
;

4995 
pxt4_group_desc
 *
desc
;

4996 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4997 
pxt4_buddy
 
e4b
;

4998 
îr
 = 0, 
ªt
, 
‰ì_˛u°îs_cou¡
;

4999 
pxt4_gΩblk_t
 
˛u°îs_‰ìd
;

5000 
pxt4_fsblk_t
 
fú°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
);

5001 
pxt4_fsblk_t
 
œ°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
 + 
cou¡
 - 1);

5002 
˛u°î_cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

5004 
	`pxt4_debug
("Addög block(sË%Œu-%Œu\n", 
block
, block + 
cou¡
 - 1);

5006 i‡(
cou¡
 == 0)

5009 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

5014 i‡(
bô
 + 
˛u°î_cou¡
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

5015 
	`pxt4_w¨nög
(
sb
, "too many blocksáddedÅo group %u",

5016 
block_group
);

5017 
îr
 = -
EINVAL
;

5018 
îr‹_ªtu∫
;

5021 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

5022 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

5023 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

5024 
bôm≠_bh
 = 
NULL
;

5025 
îr‹_ªtu∫
;

5028 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

5029 i‡(!
desc
) {

5030 
îr
 = -
EIO
;

5031 
îr‹_ªtu∫
;

5034 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5035 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5036 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
), 
sbi
->
s_ôb_≥r_group
) ||

5037 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
),

5038 
sbi
->
s_ôb_≥r_group
)) {

5039 
	`pxt4_îr‹
(
sb
, "Adding blocks in system zones - "

5041 
block
, 
cou¡
);

5042 
îr
 = -
EINVAL
;

5043 
îr‹_ªtu∫
;

5046 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

5047 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

5048 i‡(
îr
)

5049 
îr‹_ªtu∫
;

5056 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5057 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

5058 i‡(
îr
)

5059 
îr‹_ªtu∫
;

5061 
i
 = 0, 
˛u°îs_‰ìd
 = 0; i < 
˛u°î_cou¡
; i++) {

5062 
	`BUFFER_TRACE
(
bôm≠_bh
, "clear bit");

5063 i‡(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
)) {

5064 
	`pxt4_îr‹
(
sb
, "bitálready cleared for block %llu",

5065 (
pxt4_fsblk_t
)(
block
 + 
i
));

5066 
	`BUFFER_TRACE
(
bôm≠_bh
, "bitálready cleared");

5068 
˛u°îs_‰ìd
++;

5072 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
block_group
, &
e4b
);

5073 i‡(
îr
)

5074 
îr‹_ªtu∫
;

5081 
	`pxt4_lock_group
(
sb
, 
block_group
);

5082 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
˛u°î_cou¡
);

5083 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
bô
, 
˛u°î_cou¡
);

5084 
‰ì_˛u°îs_cou¡
 = 
˛u°îs_‰ìd
 +

5085 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

5086 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
desc
, 
‰ì_˛u°îs_cou¡
);

5087 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
desc
, 
bôm≠_bh
);

5088 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
desc
);

5089 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

5090 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

5091 
˛u°îs_‰ìd
);

5093 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

5094 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

5095 
	`©omic64_add
(
˛u°îs_‰ìd
,

5096 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

5097 
Êex_group
)->
‰ì_˛u°îs
);

5100 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5103 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

5104 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

5107 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5108 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

5109 i‡(!
îr
)

5110 
îr
 = 
ªt
;

5112 
îr‹_ªtu∫
:

5113 
	`bªl£
(
bôm≠_bh
);

5114 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

5115  
îr
;

5116 
	}
}

5130 
	$pxt4_åim_exã¡
(
su≥r_block
 *
sb
, 
°¨t
, 
cou¡
,

5131 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
)

5132 
	$__ªÀa£s
(
bôlock
)

5133 
	$__acquúes
(
bôlock
)

5135 
pxt4_‰ì_exã¡
 
ex
;

5136 
ªt
 = 0;

5138 
	`åa˚_pxt4_åim_exã¡
(
sb
, 
group
, 
°¨t
, 
cou¡
);

5140 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

5142 
ex
.
„_°¨t
 = 
°¨t
;

5143 
ex
.
„_group
 = 
group
;

5144 
ex
.
„_Àn
 = 
cou¡
;

5150 
	`mb_m¨k_u£d
(
e4b
, &
ex
);

5151 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5152 
ªt
 = 
	`pxt4_issue_disˇrd
(
sb
, 
group
, 
°¨t
, 
cou¡
, 
NULL
);

5153 
	`pxt4_lock_group
(
sb
, 
group
);

5154 
	`mb_‰ì_blocks
(
NULL
, 
e4b
, 
°¨t
, 
ex
.
„_Àn
);

5155  
ªt
;

5156 
	}
}

5176 
pxt4_gΩblk_t


5177 
	$pxt4_åim_Æl_‰ì
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

5178 
pxt4_gΩblk_t
 
°¨t
,Öxt4_gΩblk_à
max
,

5179 
pxt4_gΩblk_t
 
möblocks
)

5181 *
bôm≠
;

5182 
pxt4_gΩblk_t
 
√xt
, 
cou¡
 = 0, 
‰ì_cou¡
 = 0;

5183 
pxt4_buddy
 
e4b
;

5184 
ªt
 = 0;

5186 
	`åa˚_pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
°¨t
, 
max
);

5188 
ªt
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5189 i‡(
ªt
) {

5190 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

5191 
ªt
, 
group
);

5192  
ªt
;

5194 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5196 
	`pxt4_lock_group
(
sb
, 
group
);

5197 i‡(
	`PXT4_MB_GRP_WAS_TRIMMED
(
e4b
.
bd_öfo
) &&

5198 
möblocks
 >
	`©omic_ªad
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
))

5199 
out
;

5201 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5202 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5204 
°¨t
 <
max
) {

5205 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
 + 1, start);

5206 i‡(
°¨t
 > 
max
)

5208 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
 + 1, 
°¨t
);

5210 i‡((
√xt
 - 
°¨t
Ë>
möblocks
) {

5211 
ªt
 = 
	`pxt4_åim_exã¡
(
sb
, 
°¨t
,

5212 
√xt
 - 
°¨t
, 
group
, &
e4b
);

5213 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
)

5215 
ªt
 = 0;

5216 
cou¡
 +
√xt
 - 
°¨t
;

5218 
‰ì_cou¡
 +
√xt
 - 
°¨t
;

5219 
°¨t
 = 
√xt
 + 1;

5221 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

5222 
cou¡
 = -
ERESTARTSYS
;

5226 i‡(
	`√ed_ªsched
()) {

5227 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5228 
	`c⁄d_ªsched
();

5229 
	`pxt4_lock_group
(
sb
, 
group
);

5232 i‡((
e4b
.
bd_öfo
->
bb_‰ì
 - 
‰ì_cou¡
Ë< 
möblocks
)

5236 i‡(!
ªt
) {

5237 
ªt
 = 
cou¡
;

5238 
	`PXT4_MB_GRP_SET_TRIMMED
(
e4b
.
bd_öfo
);

5240 
out
:

5241 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5242 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5244 
	`pxt4_debug
("trimmed %d blocks inÅhe group %d\n",

5245 
cou¡
, 
group
);

5247  
ªt
;

5248 
	}
}

5262 
	$pxt4_åim_fs
(
su≥r_block
 *
sb
, 
f°rim_ønge
 *
ønge
)

5264 
pxt4_group_öfo
 *
gΩ
;

5265 
pxt4_group_t
 
group
, 
fú°_group
, 
œ°_group
;

5266 
pxt4_gΩblk_t
 
˙t
 = 0, 
fú°_˛u°î
, 
œ°_˛u°î
;

5267 
uöt64_t
 
°¨t
, 
íd
, 
möÀn
, 
åimmed
 = 0;

5268 
pxt4_fsblk_t
 
fú°_d©a_blk
 =

5269 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

5270 
pxt4_fsblk_t
 
max_blks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
);

5271 
ªt
 = 0;

5273 
°¨t
 = 
ønge
->°¨à>> 
sb
->
s_blocksize_bôs
;

5274 
íd
 = 
°¨t
 + (
ønge
->
Àn
 >> 
sb
->
s_blocksize_bôs
) - 1;

5275 
möÀn
 = 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

5276 
ønge
->
möÀn
 >> 
sb
->
s_blocksize_bôs
);

5278 i‡(
möÀn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) ||

5279 
°¨t
 >
max_blks
 ||

5280 
ønge
->
Àn
 < 
sb
->
s_blocksize
)

5281  -
EINVAL
;

5282 i‡(
íd
 >
max_blks
)

5283 
íd
 = 
max_blks
 - 1;

5284 i‡(
íd
 <
fú°_d©a_blk
)

5285 
out
;

5286 i‡(
°¨t
 < 
fú°_d©a_blk
)

5287 
°¨t
 = 
fú°_d©a_blk
;

5290 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
°¨t
,

5291 &
fú°_group
, &
fú°_˛u°î
);

5292 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
íd
,

5293 &
œ°_group
, &
œ°_˛u°î
);

5296 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5298 
group
 = 
fú°_group
; grou∞<
œ°_group
; group++) {

5299 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

5301 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

5302 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
GFP_NOFS
);

5303 i‡(
ªt
)

5313 i‡(
group
 =
œ°_group
)

5314 
íd
 = 
œ°_˛u°î
;

5316 i‡(
gΩ
->
bb_‰ì
 >
möÀn
) {

5317 
˙t
 = 
	`pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
fú°_˛u°î
,

5318 
íd
, 
möÀn
);

5319 i‡(
˙t
 < 0) {

5320 
ªt
 = 
˙t
;

5323 
åimmed
 +
˙t
;

5330 
fú°_˛u°î
 = 0;

5333 i‡(!
ªt
)

5334 
	`©omic_£t
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
, 
möÀn
);

5336 
out
:

5337 
ønge
->
Àn
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
åimmed
Ë<< sb->
s_blocksize_bôs
;

5338  
ªt
;

5339 
	}
}

5343 
	$pxt4_mbÆloc_quîy_ønge
(

5344 
su≥r_block
 *
sb
,

5345 
pxt4_group_t
 
group
,

5346 
pxt4_gΩblk_t
 
°¨t
,

5347 
pxt4_gΩblk_t
 
íd
,

5348 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

5349 *
¥iv
)

5351 *
bôm≠
;

5352 
pxt4_gΩblk_t
 
√xt
;

5353 
pxt4_buddy
 
e4b
;

5354 
îr‹
;

5356 
îr‹
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5357 i‡(
îr‹
)

5358  
îr‹
;

5359 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5361 
	`pxt4_lock_group
(
sb
, 
group
);

5363 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5364 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5365 i‡(
íd
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

5366 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5368 
°¨t
 <
íd
) {

5369 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
íd
 + 1, start);

5370 i‡(
°¨t
 > 
íd
)

5372 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
íd
 + 1, 
°¨t
);

5374 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5375 
îr‹
 = 
	`f‹m©ãr
(
sb
, 
group
, 
°¨t
, 
√xt
 - sèπ, 
¥iv
);

5376 i‡(
îr‹
)

5377 
out_u∆ﬂd
;

5378 
	`pxt4_lock_group
(
sb
, 
group
);

5380 
°¨t
 = 
√xt
 + 1;

5383 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5384 
out_u∆ﬂd
:

5385 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5387  
îr‹
;

5388 
	}
}

	@mballoc.h

8 #i‚de‡
_PXT4_MBALLOC_H


9 
	#_PXT4_MBALLOC_H


	)

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/«mei.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/buf„r_hód.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/¥oc_fs.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~<löux/£q_fûe.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/muãx.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

28 #ifde‡
CONFIG_PXT4_DEBUG


29 
ush‹t
 
pxt4_mbÆloc_debug
;

31 
	#mb_debug
(
n
, 
fmt
, ...) \

33 i‡((
n
Ë<
pxt4_mbÆloc_debug
) { \

34 
	`¥ötk
(
KERN_DEBUG
 "(%s, %d): %s: " 
fmt
, \

35 
__FILE__
, 
__LINE__
, 
__func__
, ##
__VA_ARGS__
); \

37 } 0)

	)

39 
	#mb_debug
(
n
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

42 
	#PXT4_MB_HISTORY_ALLOC
 1

	)

43 
	#PXT4_MB_HISTORY_PREALLOC
 2

	)

48 
	#MB_DEFAULT_MAX_TO_SCAN
 200

	)

53 
	#MB_DEFAULT_MIN_TO_SCAN
 10

	)

59 
	#MB_DEFAULT_STATS
 0

	)

68 
	#MB_DEFAULT_STREAM_THRESHOLD
 16

	)

73 
	#MB_DEFAULT_ORDER2_REQS
 2

	)

78 
	#MB_DEFAULT_GROUP_PREALLOC
 512

	)

81 
	spxt4_‰ì_d©a
 {

83 
li°_hód
 
	mefd_li°
;

86 
rb_node
 
	mefd_node
;

89 
pxt4_group_t
 
	mefd_group
;

92 
pxt4_gΩblk_t
 
	mefd_°¨t_˛u°î
;

93 
pxt4_gΩblk_t
 
	mefd_cou¡
;

96 
tid_t
 
	mefd_tid
;

99 
	spxt4_¥óŒoc_•a˚
 {

100 
li°_hód
 
	m∑_öode_li°
;

101 
li°_hód
 
	m∑_group_li°
;

103 
li°_hód
 
	m∑_tmp_li°
;

104 
rcu_hód
 
	m∑_rcu
;

105 } 
	mu
;

106 
•ölock_t
 
	m∑_lock
;

107 
©omic_t
 
	m∑_cou¡
;

108 
	m∑_dñëed
;

109 
pxt4_fsblk_t
 
	m∑_p°¨t
;

110 
pxt4_lblk_t
 
	m∑_l°¨t
;

111 
pxt4_gΩblk_t
 
	m∑_Àn
;

112 
pxt4_gΩblk_t
 
	m∑_‰ì
;

113 
	m∑_ty≥
;

114 
•ölock_t
 *
	m∑_obj_lock
;

115 
öode
 *
	m∑_öode
;

119 
	mMB_INODE_PA
 = 0,

120 
	mMB_GROUP_PA
 = 1

123 
	spxt4_‰ì_exã¡
 {

124 
pxt4_lblk_t
 
	m„_logiˇl
;

125 
pxt4_gΩblk_t
 
	m„_°¨t
;

126 
pxt4_group_t
 
	m„_group
;

127 
pxt4_gΩblk_t
 
	m„_Àn
;

138 
	#PREALLOC_TB_SIZE
 10

	)

139 
	spxt4_loˇlôy_group
 {

142 
muãx
 
	mlg_muãx
;

144 
li°_hód
 
	mlg_¥óŒoc_li°
[
PREALLOC_TB_SIZE
];

145 
•ölock_t
 
	mlg_¥óŒoc_lock
;

148 
	spxt4_Æloˇti⁄_c⁄ãxt
 {

149 
öode
 *
	mac_öode
;

150 
su≥r_block
 *
	mac_sb
;

153 
pxt4_‰ì_exã¡
 
	mac_o_ex
;

156 
pxt4_‰ì_exã¡
 
	mac_g_ex
;

159 
pxt4_‰ì_exã¡
 
	mac_b_ex
;

162 
pxt4_‰ì_exã¡
 
	mac_f_ex
;

164 
__u16
 
	mac_groups_sˇ¬ed
;

165 
__u16
 
	mac_found
;

166 
__u16
 
	mac_èû
;

167 
__u16
 
	mac_buddy
;

168 
__u16
 
	mac_Êags
;

169 
__u8
 
	mac_°©us
;

170 
__u8
 
	mac_¸ôîü
;

171 
__u8
 
	mac_2‹dî
;

173 
__u8
 
	mac_›
;

174 
∑ge
 *
	mac_bôm≠_∑ge
;

175 
∑ge
 *
	mac_buddy_∑ge
;

176 
pxt4_¥óŒoc_•a˚
 *
	mac_∑
;

177 
pxt4_loˇlôy_group
 *
	mac_lg
;

180 
	#AC_STATUS_CONTINUE
 1

	)

181 
	#AC_STATUS_FOUND
 2

	)

182 
	#AC_STATUS_BREAK
 3

	)

184 
	spxt4_buddy
 {

185 
∑ge
 *
	mbd_buddy_∑ge
;

186 *
	mbd_buddy
;

187 
∑ge
 *
	mbd_bôm≠_∑ge
;

188 *
	mbd_bôm≠
;

189 
pxt4_group_öfo
 *
	mbd_öfo
;

190 
su≥r_block
 *
	mbd_sb
;

191 
__u16
 
	mbd_blkbôs
;

192 
pxt4_group_t
 
	mbd_group
;

195 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_gΩ_offs_to_block
(
su≥r_block
 *
sb
,

196 
pxt4_‰ì_exã¡
 *
„x
)

198  
	`pxt4_group_fú°_block_no
(
sb
, 
„x
->
„_group
) +

199 (
„x
->
„_°¨t
 << 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

200 
	}
}

202 (*
	tpxt4_mbÆloc_quîy_ønge_‚
)(

203 
	tsu≥r_block
 *
	tsb
,

204 
	tpxt4_group_t
 
	tagno
,

205 
	tpxt4_gΩblk_t
 
	t°¨t
,

206 
	tpxt4_gΩblk_t
 
	tÀn
,

207 *
	t¥iv
);

210 
	`pxt4_mbÆloc_quîy_ønge
(

211 
su≥r_block
 *
sb
,

212 
pxt4_group_t
 
agno
,

213 
pxt4_gΩblk_t
 
°¨t
,

214 
pxt4_gΩblk_t
 
íd
,

215 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

216 *
¥iv
);

	@migrate.c

8 
	~<löux/¶ab.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4_exã¡s.h
"

16 
	smigøã_°ru˘
 {

17 
pxt4_lblk_t
 
	mfú°_block
, 
	mœ°_block
, 
	mcuº_block
;

18 
pxt4_fsblk_t
 
	mfú°_pblock
, 
	mœ°_pblock
;

21 
	$föish_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

22 
migøã_°ru˘
 *
lb
)

25 
ªtvÆ
 = 0, 
√eded
;

26 
pxt4_exã¡
 
√wext
;

27 
pxt4_ext_∑th
 *
∑th
;

28 i‡(
lb
->
fú°_pblock
 == 0)

32 
√wext
.
ì_block
 = 
	`˝u_to_À32
(
lb
->
fú°_block
);

33 
√wext
.
ì_Àn
 = 
	`˝u_to_À16
(
lb
->
œ°_block
 -Üb->
fú°_block
 + 1);

34 
	`pxt4_ext_°‹e_pblock
(&
√wext
, 
lb
->
fú°_pblock
);

36 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

37 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lb
->
fú°_block
, 
NULL
, 0);

38 i‡(
	`IS_ERR
(
∑th
)) {

39 
ªtvÆ
 = 
	`PTR_ERR
(
∑th
);

40 
∑th
 = 
NULL
;

41 
îr_out
;

50 
√eded
 = 
	`pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
,

51 
lb
->
œ°_block
 -Üb->
fú°_block
 + 1, 
∑th
);

56 i‡(
√eded
 && 
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
,

57 
PXT4_RESERVE_TRANS_BLOCKS
)) {

58 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

59 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

60 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

61 i‡(
ªtvÆ
)

62 
îr_out
;

63 } i‡(
√eded
) {

64 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
);

65 i‡(
ªtvÆ
) {

69 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

70 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

71 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

72 i‡(
ªtvÆ
)

73 
îr_out
;

76 
ªtvÆ
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
, &
√wext
, 0);

77 
îr_out
:

78 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

79 
	`pxt4_ext_dr›_ªfs
(
∑th
);

80 
	`k‰ì
(
∑th
);

81 
lb
->
fú°_pblock
 = 0;

82  
ªtvÆ
;

83 
	}
}

85 
	$upd©e_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

86 
pxt4_fsblk_t
 
pblock
, 
migøã_°ru˘
 *
lb
)

88 
ªtvÆ
;

92 i‡(
lb
->
fú°_pblock
 &&

93 (
lb
->
œ°_pblock
+1 =
pblock
) &&

94 (
lb
->
œ°_block
+1 =lb->
cuº_block
)) {

95 
lb
->
œ°_pblock
 = 
pblock
;

96 
lb
->
œ°_block
 =Üb->
cuº_block
;

97 
lb
->
cuº_block
++;

103 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
öode
, 
lb
);

104 
lb
->
fú°_pblock
 =Üb->
œ°_pblock
 = 
pblock
;

105 
lb
->
fú°_block
 =Üb->
œ°_block
 =Üb->
cuº_block
;

106 
lb
->
cuº_block
++;

107  
ªtvÆ
;

108 
	}
}

110 
	$upd©e_öd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

111 
pxt4_fsblk_t
 
pblock
,

112 
migøã_°ru˘
 *
lb
)

114 
buf„r_hód
 *
bh
;

115 
__À32
 *
i_d©a
;

116 
i
, 
ªtvÆ
 = 0;

117 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

119 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

120 i‡(
	`IS_ERR
(
bh
))

121  
	`PTR_ERR
(
bh
);

123 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

124 
i
 = 0; i < 
max_íåõs
; i++) {

125 i‡(
i_d©a
[
i
]) {

126 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
öode
,

127 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

128 i‡(
ªtvÆ
)

131 
lb
->
cuº_block
++;

134 
	`put_bh
(
bh
);

135  
ªtvÆ
;

137 
	}
}

139 
	$upd©e_död_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

140 
pxt4_fsblk_t
 
pblock
,

141 
migøã_°ru˘
 *
lb
)

143 
buf„r_hód
 *
bh
;

144 
__À32
 *
i_d©a
;

145 
i
, 
ªtvÆ
 = 0;

146 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

148 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

149 i‡(
	`IS_ERR
(
bh
))

150  
	`PTR_ERR
(
bh
);

152 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

153 
i
 = 0; i < 
max_íåõs
; i++) {

154 i‡(
i_d©a
[
i
]) {

155 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
öode
,

156 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

157 i‡(
ªtvÆ
)

161 
lb
->
cuº_block
 +
max_íåõs
;

164 
	`put_bh
(
bh
);

165  
ªtvÆ
;

167 
	}
}

169 
	$upd©e_töd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

170 
pxt4_fsblk_t
 
pblock
,

171 
migøã_°ru˘
 *
lb
)

173 
buf„r_hód
 *
bh
;

174 
__À32
 *
i_d©a
;

175 
i
, 
ªtvÆ
 = 0;

176 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

178 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

179 i‡(
	`IS_ERR
(
bh
))

180  
	`PTR_ERR
(
bh
);

182 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

183 
i
 = 0; i < 
max_íåõs
; i++) {

184 i‡(
i_d©a
[
i
]) {

185 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
öode
,

186 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

187 i‡(
ªtvÆ
)

191 
lb
->
cuº_block
 +
max_íåõs
 * max_entries;

194 
	`put_bh
(
bh
);

195  
ªtvÆ
;

197 
	}
}

199 
	$exãnd_¸edô_f‹_blkdñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

201 
ªtvÆ
 = 0, 
√eded
;

203 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

211 
√eded
 = 3 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

213 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
) != 0)

214 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

216  
ªtvÆ
;

217 
	}
}

219 
	$‰ì_död_blocks
(
h™dÀ_t
 *
h™dÀ
,

220 
öode
 *öode, 
__À32
 
i_d©a
)

222 
i
;

223 
__À32
 *
tmp_id©a
;

224 
buf„r_hód
 *
bh
;

225 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

227 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

228 i‡(
	`IS_ERR
(
bh
))

229  
	`PTR_ERR
(
bh
);

231 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

232 
i
 = 0; i < 
max_íåõs
; i++) {

233 i‡(
tmp_id©a
[
i
]) {

234 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

235 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

236 
	`À32_to_˝u
(
tmp_id©a
[
i
]), 1,

237 
PXT4_FREE_BLOCKS_METADATA
 |

238 
PXT4_FREE_BLOCKS_FORGET
);

241 
	`put_bh
(
bh
);

242 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

243 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

244 
PXT4_FREE_BLOCKS_METADATA
 |

245 
PXT4_FREE_BLOCKS_FORGET
);

247 
	}
}

249 
	$‰ì_töd_blocks
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
__À32
 
i_d©a
)

252 
i
, 
ªtvÆ
 = 0;

253 
__À32
 *
tmp_id©a
;

254 
buf„r_hód
 *
bh
;

255 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

257 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

258 i‡(
	`IS_ERR
(
bh
))

259  
	`PTR_ERR
(
bh
);

261 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

262 
i
 = 0; i < 
max_íåõs
; i++) {

263 i‡(
tmp_id©a
[
i
]) {

264 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
,

265 
öode
, 
tmp_id©a
[
i
]);

266 i‡(
ªtvÆ
) {

267 
	`put_bh
(
bh
);

268  
ªtvÆ
;

272 
	`put_bh
(
bh
);

273 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

275 
PXT4_FREE_BLOCKS_METADATA
 |

276 
PXT4_FREE_BLOCKS_FORGET
);

278 
	}
}

280 
	$‰ì_öd_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
__À32
 *
i_d©a
)

282 
ªtvÆ
;

285 i‡(
i_d©a
[0]) {

286 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

287 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

288 
	`À32_to_˝u
(
i_d©a
[0]), 1,

289 
PXT4_FREE_BLOCKS_METADATA
 |

290 
PXT4_FREE_BLOCKS_FORGET
);

294 i‡(
i_d©a
[1]) {

295 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[1]);

296 i‡(
ªtvÆ
)

297  
ªtvÆ
;

301 i‡(
i_d©a
[2]) {

302 
ªtvÆ
 = 
	`‰ì_töd_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[2]);

303 i‡(
ªtvÆ
)

304  
ªtvÆ
;

307 
	}
}

309 
	$pxt4_ext_sw≠_öode_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

310 
öode
 *
tmp_öode
)

312 
ªtvÆ
;

313 
__À32
 
i_d©a
[3];

314 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

315 
pxt4_öode_öfo
 *
tmp_ei
 = 
	`PXT4_I
(
tmp_öode
);

321 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1);

322 i‡(
ªtvÆ
) {

323 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

324 i‡(
ªtvÆ
)

325 
îr_out
;

328 
i_d©a
[0] = 
ei
->i_d©a[
PXT4_IND_BLOCK
];

329 
i_d©a
[1] = 
ei
->i_d©a[
PXT4_DIND_BLOCK
];

330 
i_d©a
[2] = 
ei
->i_d©a[
PXT4_TIND_BLOCK
];

332 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

338 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
)) {

339 
ªtvÆ
 = -
EAGAIN
;

340 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

341 
îr_out
;

343 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

348 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

349 
	`mem˝y
(
ei
->
i_d©a
, 
tmp_ei
->i_data, (ei->i_data));

360 
	`•ö_lock
(&
öode
->
i_lock
);

361 
öode
->
i_blocks
 +
tmp_öode
->i_blocks;

362 
	`•ö_u∆ock
(&
öode
->
i_lock
);

363 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

369 
ªtvÆ
 = 
	`‰ì_öd_block
(
h™dÀ
, 
öode
, 
i_d©a
);

370 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

372 
îr_out
:

373  
ªtvÆ
;

374 
	}
}

376 
	$‰ì_ext_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

377 
pxt4_exã¡_idx
 *
ix
)

379 
i
, 
ªtvÆ
 = 0;

380 
pxt4_fsblk_t
 
block
;

381 
buf„r_hód
 *
bh
;

382 
pxt4_exã¡_hódî
 *
eh
;

384 
block
 = 
	`pxt4_idx_pblock
(
ix
);

385 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
block
, 0);

386 i‡(
	`IS_ERR
(
bh
))

387  
	`PTR_ERR
(
bh
);

389 
eh
 = (
pxt4_exã¡_hódî
 *)
bh
->
b_d©a
;

390 i‡(
eh
->
eh_dïth
 != 0) {

391 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

392 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

393 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

394 i‡(
ªtvÆ
)

398 
	`put_bh
(
bh
);

399 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

400 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

401 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

402  
ªtvÆ
;

403 
	}
}

408 
	$‰ì_ext_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

410 
i
, 
ªtvÆ
 = 0;

411 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

412 
pxt4_exã¡_hódî
 *
eh
 = (pxt4_exã¡_hódî *)
ei
->
i_d©a
;

413 
pxt4_exã¡_idx
 *
ix
;

414 i‡(
eh
->
eh_dïth
 == 0)

419 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

420 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

421 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

422 i‡(
ªtvÆ
)

423  
ªtvÆ
;

425  
ªtvÆ
;

426 
	}
}

428 
	$pxt4_ext_migøã
(
öode
 *inode)

430 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

431 
h™dÀ_t
 *
h™dÀ
;

432 
ªtvÆ
 = 0, 
i
;

433 
__À32
 *
i_d©a
;

434 
pxt4_öode_öfo
 *
ei
;

435 
öode
 *
tmp_öode
 = 
NULL
;

436 
migøã_°ru˘
 
lb
;

437 
max_íåõs
;

438 
__u32
 
gﬂl
;

439 
uid_t
 
ow√r
[2];

445 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

446 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

447  -
EINVAL
;

449 i‡(
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 == 0)

453  
ªtvÆ
;

455 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

462 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
,

463 4 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
));

465 i‡(
	`IS_ERR
(
h™dÀ
)) {

466 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

467 
out_u∆ock
;

469 
gﬂl
 = (((
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(öode->
i_sb
)) *

470 
	`PXT4_INODES_PER_GROUP
(
öode
->
i_sb
)) + 1;

471 
ow√r
[0] = 
	`i_uid_ªad
(
öode
);

472 
ow√r
[1] = 
	`i_gid_ªad
(
öode
);

473 
tmp_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
	`d_öode
(
öode
->
i_sb
->
s_roŸ
),

474 
S_IFREG
, 
NULL
, 
gﬂl
, 
ow√r
, 0);

475 i‡(
	`IS_ERR
(
tmp_öode
)) {

476 
ªtvÆ
 = 
	`PTR_ERR
(
tmp_öode
);

477 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

478 
out_u∆ock
;

480 
	`i_size_wrôe
(
tmp_öode
, 
	`i_size_ªad
(
öode
));

485 
	`˛ór_∆ök
(
tmp_öode
);

487 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

488 
	`pxt4_‹ph™_add
(
h™dÀ
, 
tmp_öode
);

489 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

507 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

508 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

509 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

511 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

512 i‡(
	`IS_ERR
(
h™dÀ
)) {

518 
	`pxt4_‹ph™_dñ
(
NULL
, 
tmp_öode
);

519 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

520 
out_tmp_öode
;

523 
ei
 = 
	`PXT4_I
(
öode
);

524 
i_d©a
 = 
ei
->i_data;

525 
	`mem£t
(&
lb
, 0, (lb));

528 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

529 
i
 = 0; i < 
PXT4_NDIR_BLOCKS
; i++) {

530 i‡(
i_d©a
[
i
]) {

531 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

532 
	`À32_to_˝u
(
i_d©a
[
i
]), &
lb
);

533 i‡(
ªtvÆ
)

534 
îr_out
;

536 
lb
.
cuº_block
++;

538 i‡(
i_d©a
[
PXT4_IND_BLOCK
]) {

539 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

540 
	`À32_to_˝u
(
i_d©a
[
PXT4_IND_BLOCK
]), &
lb
);

541 i‡(
ªtvÆ
)

542 
îr_out
;

544 
lb
.
cuº_block
 +
max_íåõs
;

545 i‡(
i_d©a
[
PXT4_DIND_BLOCK
]) {

546 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

547 
	`À32_to_˝u
(
i_d©a
[
PXT4_DIND_BLOCK
]), &
lb
);

548 i‡(
ªtvÆ
)

549 
îr_out
;

551 
lb
.
cuº_block
 +
max_íåõs
 * max_entries;

552 i‡(
i_d©a
[
PXT4_TIND_BLOCK
]) {

553 
ªtvÆ
 = 
	`upd©e_töd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

554 
	`À32_to_˝u
(
i_d©a
[
PXT4_TIND_BLOCK
]), &
lb
);

555 i‡(
ªtvÆ
)

556 
îr_out
;

561 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
tmp_öode
, &
lb
);

562 
îr_out
:

563 i‡(
ªtvÆ
)

568 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

570 
ªtvÆ
 = 
	`pxt4_ext_sw≠_öode_d©a
(
h™dÀ
, 
öode
, 
tmp_öode
);

571 i‡(
ªtvÆ
)

576 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

580 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1) != 0)

581 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

586 
	`i_size_wrôe
(
tmp_öode
, 0);

596 
tmp_öode
->
i_blocks
 = 0;

599 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

600 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

601 
out_tmp_öode
:

602 
	`u∆ock_√w_öode
(
tmp_öode
);

603 
	`ùut
(
tmp_öode
);

604 
out_u∆ock
:

605 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

606  
ªtvÆ
;

607 
	}
}

612 
	$pxt4_öd_migøã
(
öode
 *inode)

614 
pxt4_exã¡_hódî
 *
eh
;

615 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

616 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

617 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

618 
pxt4_exã¡
 *
ex
;

619 
i
, 
Àn
;

620 
pxt4_lblk_t
 
°¨t
, 
íd
;

621 
pxt4_fsblk_t
 
blk
;

622 
h™dÀ_t
 *
h™dÀ
;

623 
ªt
;

625 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

626 (!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

627  -
EINVAL
;

629 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
))

630  -
EOPNOTSUPP
;

637 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

638 
	`pxt4_Æloc_da_blocks
(
öode
);

640 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

642 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

643 i‡(
	`IS_ERR
(
h™dÀ
)) {

644 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

645 
out_u∆ock
;

648 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

649 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

650 i‡(
ªt
)

651 
îrout
;

653 
eh
 = 
	`ext_öode_hdr
(
öode
);

654 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

655 i‡(
	`pxt4_blocks_cou¡
(
es
Ë> 
PXT4_MAX_BLOCK_FILE_PHYS
 ||

656 
eh
->
eh_dïth
 !0 || 
	`À16_to_˝u
”h->
eh_íåõs
) > 1) {

657 
ªt
 = -
EOPNOTSUPP
;

658 
îrout
;

660 i‡(
eh
->
eh_íåõs
 == 0)

661 
blk
 = 
Àn
 = 
°¨t
 = 
íd
 = 0;

663 
Àn
 = 
	`À16_to_˝u
(
ex
->
ì_Àn
);

664 
blk
 = 
	`pxt4_ext_pblock
(
ex
);

665 
°¨t
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

666 
íd
 = 
°¨t
 + 
Àn
 - 1;

667 i‡(
íd
 >
PXT4_NDIR_BLOCKS
) {

668 
ªt
 = -
EOPNOTSUPP
;

669 
îrout
;

673 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

674 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

675 
i
 = 
°¨t
; i <
íd
; i++)

676 
ei
->
i_d©a
[
i
] = 
	`˝u_to_À32
(
blk
++);

677 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

678 
îrout
:

679 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

680 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

681 
out_u∆ock
:

682 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

683  
ªt
;

684 
	}
}

	@mmp.c

2 
	~<löux/fs.h
>

3 
	~<löux/øndom.h
>

4 
	~<löux/buf„r_hód.h
>

5 
	~<löux/ut¢ame.h
>

6 
	~<löux/kthªad.h
>

8 
	~"pxt4.h
"

11 
__À32
 
	$pxt4_mmp_csum
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

13 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

14 
off£t
 = 
	`off£tof
(
mmp_°ru˘
, 
mmp_checksum
);

15 
__u32
 
csum
;

17 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (*)
mmp
, 
off£t
);

19  
	`˝u_to_À32
(
csum
);

20 
	}
}

22 
	$pxt4_mmp_csum_vîify
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

24 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

27  
mmp
->
mmp_checksum
 =
	`pxt4_mmp_csum
(
sb
, mmp);

28 
	}
}

30 
	$pxt4_mmp_csum_£t
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

32 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

35 
mmp
->
mmp_checksum
 = 
	`pxt4_mmp_csum
(
sb
, mmp);

36 
	}
}

42 
	$wrôe_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 *
bh
)

44 
mmp_°ru˘
 *
mmp
 = (mmp_°ru˘ *)(
bh
->
b_d©a
);

50 
	`sb_°¨t_wrôe
(
sb
);

51 
	`pxt4_mmp_csum_£t
(
sb
, 
mmp
);

52 
	`lock_buf„r
(
bh
);

53 
bh
->
b_íd_io
 = 
íd_buf„r_wrôe_sync
;

54 
	`gë_bh
(
bh
);

55 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

56 
	`waô_⁄_buf„r
(
bh
);

57 
	`sb_íd_wrôe
(
sb
);

58 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

62 
	}
}

68 
	$ªad_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 **
bh
,

69 
pxt4_fsblk_t
 
mmp_block
)

71 
mmp_°ru˘
 *
mmp
;

72 
ªt
;

74 i‡(*
bh
)

75 
	`˛ór_buf„r_u±od©e
(*
bh
);

80 i‡(!*
bh
) {

81 *
bh
 = 
	`sb_gëblk
(
sb
, 
mmp_block
);

82 i‡(!*
bh
) {

83 
ªt
 = -
ENOMEM
;

84 
w¨n_exô
;

88 
	`gë_bh
(*
bh
);

89 
	`lock_buf„r
(*
bh
);

90 (*
bh
)->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

91 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, *
bh
);

92 
	`waô_⁄_buf„r
(*
bh
);

93 i‡(!
	`buf„r_u±od©e
(*
bh
)) {

94 
ªt
 = -
EIO
;

95 
w¨n_exô
;

97 
mmp
 = (
mmp_°ru˘
 *)((*
bh
)->
b_d©a
);

98 i‡(
	`À32_to_˝u
(
mmp
->
mmp_magic
Ë!
PXT4_MMP_MAGIC
) {

99 
ªt
 = -
EFSCORRUPTED
;

100 
w¨n_exô
;

102 i‡(!
	`pxt4_mmp_csum_vîify
(
sb
, 
mmp
)) {

103 
ªt
 = -
EFSBADCRC
;

104 
w¨n_exô
;

107 
w¨n_exô
:

108 
	`bªl£
(*
bh
);

109 *
bh
 = 
NULL
;

110 
	`pxt4_w¨nög
(
sb
, "Error %d whileÑeading MMP block %llu",

111 
ªt
, 
mmp_block
);

112  
ªt
;

113 
	}
}

118 
	$__dump_mmp_msg
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
,

119 c⁄° *
fun˘i⁄
, 
löe
, c⁄° *
msg
)

121 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
, "%s", 
msg
);

122 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
,

124 ()
	`À64_to_˝u
(
mmp
->
mmp_time
),

125 ()(
mmp
->
mmp_nodíame
), mmp->mmp_nodename,

126 ()(
mmp
->
mmp_bdev«me
), mmp->mmp_bdevname);

127 
	}
}

132 
	$kmmpd
(*
d©a
)

134 
su≥r_block
 *
sb
 = ((
mmpd_d©a
 *Ë
d©a
)->sb;

135 
buf„r_hód
 *
bh
 = ((
mmpd_d©a
 *Ë
d©a
)->bh;

136 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

137 
mmp_°ru˘
 *
mmp
;

138 
pxt4_fsblk_t
 
mmp_block
;

139 
u32
 
£q
 = 0;

140 
Áûed_wrôes
 = 0;

141 
mmp_upd©e_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

142 
mmp_check_öãrvÆ
;

143 
œ°_upd©e_time
;

144 
diff
;

145 
ªtvÆ
;

147 
mmp_block
 = 
	`À64_to_˝u
(
es
->
s_mmp_block
);

148 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

149 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

154 
mmp_check_öãrvÆ
 = 
	`max
(
PXT4_MMP_CHECK_MULT
 * 
mmp_upd©e_öãrvÆ
,

155 
PXT4_MMP_MIN_CHECK_INTERVAL
);

156 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

157 
	`BUILD_BUG_ON
((
mmp
->
mmp_bdev«me
Ë< 
BDEVNAME_SIZE
);

158 
	`bdev«me
(
bh
->
b_bdev
, 
mmp
->
mmp_bdev«me
);

160 
	`mem˝y
(
mmp
->
mmp_nodíame
, 
	`öô_ut¢ame
()->
nodíame
,

161 (
mmp
->
mmp_nodíame
));

163 !
	`kthªad_should_°›
()) {

164 i‡(++
£q
 > 
PXT4_MMP_SEQ_MAX
)

165 
£q
 = 1;

167 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

168 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

169 
œ°_upd©e_time
 = 
jiffõs
;

171 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

176 i‡(
ªtvÆ
) {

177 i‡((
Áûed_wrôes
 % 60) == 0)

178 
	`pxt4_îr‹
(
sb
, "Error writingÅo MMP block");

179 
Áûed_wrôes
++;

182 i‡(!(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

183 
PXT4_FEATURE_INCOMPAT_MMP
)) {

184 
	`pxt4_w¨nög
(
sb
, "kmmpd being stopped since MMP feature"

186 
exô_thªad
;

189 i‡(
	`sb_rd⁄ly
(
sb
))

192 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

193 i‡(
diff
 < 
mmp_upd©e_öãrvÆ
 * 
HZ
)

194 
	`scheduÀ_timeout_öãºu±ibÀ
(
mmp_upd©e_öãrvÆ
 *

195 
HZ
 - 
diff
);

202 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

203 i‡(
diff
 > 
mmp_check_öãrvÆ
 * 
HZ
) {

204 
buf„r_hód
 *
bh_check
 = 
NULL
;

205 
mmp_°ru˘
 *
mmp_check
;

207 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh_check
, 
mmp_block
);

208 i‡(
ªtvÆ
) {

209 
	`pxt4_îr‹
(
sb
, "errorÑeading MMP data: %d",

210 
ªtvÆ
);

211 
exô_thªad
;

214 
mmp_check
 = (
mmp_°ru˘
 *)(
bh_check
->
b_d©a
);

215 i‡(
mmp
->
mmp_£q
 !
mmp_check
->mmp_seq ||

216 
	`memcmp
(
mmp
->
mmp_nodíame
, 
mmp_check
->mmp_nodename,

217 (
mmp
->
mmp_nodíame
))) {

218 
	`dump_mmp_msg
(
sb
, 
mmp_check
,

222 
	`pxt4_îr‹
(
sb
, "abort");

223 
	`put_bh
(
bh_check
);

224 
ªtvÆ
 = -
EBUSY
;

225 
exô_thªad
;

227 
	`put_bh
(
bh_check
);

234 
mmp_check_öãrvÆ
 = 
	`max
(
	`mö
(
PXT4_MMP_CHECK_MULT
 * 
diff
 / 
HZ
,

235 
PXT4_MMP_MAX_CHECK_INTERVAL
),

236 
PXT4_MMP_MIN_CHECK_INTERVAL
);

237 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

243 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
PXT4_MMP_SEQ_CLEAN
);

244 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

246 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

248 
exô_thªad
:

249 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

250 
	`k‰ì
(
d©a
);

251 
	`bªl£
(
bh
);

252  
ªtvÆ
;

253 
	}
}

259 
	$mmp_√w_£q
()

261 
u32
 
√w_£q
;

264 
√w_£q
 = 
	`¥™dom_u32
();

265 } 
√w_£q
 > 
PXT4_MMP_SEQ_MAX
);

267  
√w_£q
;

268 
	}
}

273 
	$pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *
sb
,

274 
pxt4_fsblk_t
 
mmp_block
)

276 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

277 
buf„r_hód
 *
bh
 = 
NULL
;

278 
mmp_°ru˘
 *
mmp
 = 
NULL
;

279 
mmpd_d©a
 *mmpd_data;

280 
u32
 
£q
;

281 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

282 
waô_time
 = 0;

283 
ªtvÆ
;

285 i‡(
mmp_block
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

286 
mmp_block
 >
	`pxt4_blocks_cou¡
(
es
)) {

287 
	`pxt4_w¨nög
(
sb
, "Invalid MMP block in superblock");

288 
Áûed
;

291 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

292 i‡(
ªtvÆ
)

293 
Áûed
;

295 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

297 i‡(
mmp_check_öãrvÆ
 < 
PXT4_MMP_MIN_CHECK_INTERVAL
)

298 
mmp_check_öãrvÆ
 = 
PXT4_MMP_MIN_CHECK_INTERVAL
;

304 i‡(
	`À16_to_˝u
(
mmp
->
mmp_check_öãrvÆ
) > mmp_check_interval)

305 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
mmp
->mmp_check_interval);

307 
£q
 = 
	`À32_to_˝u
(
mmp
->
mmp_£q
);

308 i‡(
£q
 =
PXT4_MMP_SEQ_CLEAN
)

309 
skù
;

311 i‡(
£q
 =
PXT4_MMP_SEQ_FSCK
) {

312 
	`dump_mmp_msg
(
sb
, 
mmp
, "fsck isÑunning onÅhe filesystem");

313 
Áûed
;

316 
waô_time
 = 
	`mö
(
mmp_check_öãrvÆ
 * 2 + 1,

317 
mmp_check_öãrvÆ
 + 60);

320 i‡(
waô_time
 > 
PXT4_MMP_MIN_CHECK_INTERVAL
 * 4)

321 
	`pxt4_w¨nög
(
sb
, "MMP interval %u higherÅhanÉxpected,Ölease"

322 " waô.\n", 
waô_time
 * 2);

324 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

325 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount\n");

326 
Áûed
;

329 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

330 i‡(
ªtvÆ
)

331 
Áûed
;

332 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

333 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

334 
	`dump_mmp_msg
(
sb
, 
mmp
,

336 
Áûed
;

339 
skù
:

343 
£q
 = 
	`mmp_√w_£q
();

344 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

346 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

347 i‡(
ªtvÆ
)

348 
Áûed
;

353 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

354 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount");

355 
Áûed
;

358 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

359 i‡(
ªtvÆ
)

360 
Áûed
;

361 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

362 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

363 
	`dump_mmp_msg
(
sb
, 
mmp
,

365 
Áûed
;

368 
mmpd_d©a
 = 
	`kmÆloc
((*mmpd_d©a), 
GFP_KERNEL
);

369 i‡(!
mmpd_d©a
) {

370 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for mmpd_data");

371 
Áûed
;

373 
mmpd_d©a
->
sb
 = sb;

374 
mmpd_d©a
->
bh
 = bh;

379 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
	`kthªad_run
(
kmmpd
, 
mmpd_d©a
, "kmmpd-%.*s",

380 ()(
mmp
->
mmp_bdev«me
),

381 
	`bdev«me
(
bh
->
b_bdev
,

382 
mmp
->
mmp_bdev«me
));

383 i‡(
	`IS_ERR
(
	`PXT4_SB
(
sb
)->
s_mmp_tsk
)) {

384 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

385 
	`k‰ì
(
mmpd_d©a
);

386 
	`pxt4_w¨nög
(
sb
, "UnableÅo create kmmpdÅhread for %s.",

387 
sb
->
s_id
);

388 
Áûed
;

393 
Áûed
:

394 
	`bªl£
(
bh
);

396 
	}
}

	@move_extent.c

8 
	~<löux/fs.h
>

9 
	~<löux/quŸa›s.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"pxt4_exã¡s.h
"

24 
ölöe
 

25 
	$gë_ext_∑th
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
,

26 
pxt4_ext_∑th
 **
µ©h
)

28 
pxt4_ext_∑th
 *
∑th
;

30 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lblock
, 
µ©h
, 
PXT4_EX_NOCACHE
);

31 i‡(
	`IS_ERR
(
∑th
))

32  
	`PTR_ERR
(
∑th
);

33 i‡(
∑th
[
	`ext_dïth
(
öode
)].
p_ext
 =
NULL
) {

34 
	`pxt4_ext_dr›_ªfs
(
∑th
);

35 
	`k‰ì
(
∑th
);

36 *
µ©h
 = 
NULL
;

37  -
ENODATA
;

39 *
µ©h
 = 
∑th
;

41 
	}
}

51 
	$pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
, öodê*
£c⁄d
)

53 i‡(
fú°
 < 
£c⁄d
) {

54 
	`down_wrôe
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
);

55 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

57 
	`down_wrôe
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
);

58 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

61 
	}
}

71 
	$pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

72 
öode
 *
d⁄‹_öode
)

74 
	`up_wrôe
(&
	`PXT4_I
(
‹ig_öode
)->
i_d©a_£m
);

75 
	`up_wrôe
(&
	`PXT4_I
(
d⁄‹_öode
)->
i_d©a_£m
);

76 
	}
}

90 
	$mext_check_covîage
(
öode
 *öode, 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
cou¡
,

91 
unwrôãn
, *
îr
)

93 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

94 
pxt4_exã¡
 *
ext
;

95 
ªt
 = 0;

96 
pxt4_lblk_t
 
œ°
 = 
‰om
 + 
cou¡
;

97 
‰om
 < 
œ°
) {

98 *
îr
 = 
	`gë_ext_∑th
(
öode
, 
‰om
, &
∑th
);

99 i‡(*
îr
)

100 
out
;

101 
ext
 = 
∑th
[
	`ext_dïth
(
öode
)].
p_ext
;

102 i‡(
unwrôãn
 !
	`pxt4_ext_is_unwrôãn
(
ext
))

103 
out
;

104 
‰om
 +
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

105 
	`pxt4_ext_dr›_ªfs
(
∑th
);

107 
ªt
 = 1;

108 
out
:

109 
	`pxt4_ext_dr›_ªfs
(
∑th
);

110 
	`k‰ì
(
∑th
);

111  
ªt
;

112 
	}
}

126 
	$mext_∑ge_doubÀ_lock
(
öode
 *
öode1
, öodê*
öode2
,

127 
pgoff_t
 
ödex1
,Ögoff_à
ödex2
, 
∑ge
 *page[2])

129 
addªss_•a˚
 *
m≠pög
[2];

130 
Ê
 = 
AOP_FLAG_NOFS
;

132 
	`BUG_ON
(!
öode1
 || !
öode2
);

133 i‡(
öode1
 < 
öode2
) {

134 
m≠pög
[0] = 
öode1
->
i_m≠pög
;

135 
m≠pög
[1] = 
öode2
->
i_m≠pög
;

137 
	`sw≠
(
ödex1
, 
ödex2
);

138 
m≠pög
[0] = 
öode2
->
i_m≠pög
;

139 
m≠pög
[1] = 
öode1
->
i_m≠pög
;

142 
∑ge
[0] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[0], 
ödex1
, 
Ê
);

143 i‡(!
∑ge
[0])

144  -
ENOMEM
;

146 
∑ge
[1] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[1], 
ödex2
, 
Ê
);

147 i‡(!
∑ge
[1]) {

148 
	`u∆ock_∑ge
(
∑ge
[0]);

149 
	`put_∑ge
(
∑ge
[0]);

150  -
ENOMEM
;

157 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[0]);

158 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[1]);

159 i‡(
öode1
 > 
öode2
)

160 
	`sw≠
(
∑ge
[0],Öage[1]);

163 
	}
}

167 
	$mext_∑ge_mku±od©e
(
∑ge
 *∑ge, 
‰om
, 
to
)

169 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

170 
£˘‹_t
 
block
;

171 
buf„r_hód
 *
bh
, *
hód
, *
¨r
[
MAX_BUF_PER_PAGE
];

172 
blocksize
, 
block_°¨t
, 
block_íd
;

173 
i
, 
îr
, 
ƒ
 = 0, 
∑πül
 = 0;

174 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

175 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

177 i‡(
	`PageU±od©e
(
∑ge
))

180 
blocksize
 = 
	`i_blocksize
(
öode
);

181 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

182 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

184 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

185 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

186 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

187 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

188 
block_íd
 = 
block_°¨t
 + 
blocksize
;

189 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

190 i‡(!
	`buf„r_u±od©e
(
bh
))

191 
∑πül
 = 1;

194 i‡(
	`buf„r_u±od©e
(
bh
))

196 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

197 
îr
 = 
	`pxt4_gë_block
(
öode
, 
block
, 
bh
, 0);

198 i‡(
îr
) {

199 
	`SëPageEº‹
(
∑ge
);

200  
îr
;

202 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

203 
	`zîo_u£r
(
∑ge
, 
block_°¨t
, 
blocksize
);

204 
	`£t_buf„r_u±od©e
(
bh
);

208 
	`BUG_ON
(
ƒ
 >
MAX_BUF_PER_PAGE
);

209 
¨r
[
ƒ
++] = 
bh
;

212 i‡(!
ƒ
)

213 
out
;

215 
i
 = 0; i < 
ƒ
; i++) {

216 
bh
 = 
¨r
[
i
];

217 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

218 
îr
 = 
	`bh_submô_ªad
(
bh
);

219 i‡(
îr
)

220  
îr
;

223 
out
:

224 i‡(!
∑πül
)

225 
	`SëPageU±od©e
(
∑ge
);

227 
	}
}

247 
	$move_exã¡_≥r_∑ge
(
fûe
 *
o_fûp
, 
öode
 *
d⁄‹_öode
,

248 
pgoff_t
 
‹ig_∑ge_off£t
,Ögoff_à
d⁄‹_∑ge_off£t
,

249 
d©a_off£t_ö_∑ge
,

250 
block_Àn_ö_∑ge
, 
unwrôãn
, *
îr
)

252 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

253 
∑ge
 *
∑gï
[2] = {
NULL
, NULL};

254 
h™dÀ_t
 *
h™dÀ
;

255 
pxt4_lblk_t
 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
;

256 
blocksize
 = 
‹ig_öode
->
i_sb
->
s_blocksize
;

257 
tmp_d©a_size
, 
d©a_size
, 
ª∂a˚d_size
;

258 
i
, 
îr2
, 
jblocks
, 
ªåõs
 = 0;

259 
ª∂a˚d_cou¡
 = 0;

260 
‰om
 = 
d©a_off£t_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

261 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

262 
su≥r_block
 *
sb
 = 
‹ig_öode
->
i_sb
;

263 
buf„r_hód
 *
bh
 = 
NULL
;

269 
agaö
:

270 *
îr
 = 0;

271 
jblocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
‹ig_öode
) * 2;

272 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
‹ig_öode
, 
PXT4_HT_MOVE_EXTENTS
, 
jblocks
);

273 i‡(
	`IS_ERR
(
h™dÀ
)) {

274 *
îr
 = 
	`PTR_ERR
(
h™dÀ
);

278 
‹ig_blk_off£t
 = 
‹ig_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

279 
d©a_off£t_ö_∑ge
;

281 
d⁄‹_blk_off£t
 = 
d⁄‹_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

282 
d©a_off£t_ö_∑ge
;

285 i‡((
‹ig_blk_off£t
 + 
block_Àn_ö_∑ge
 - 1) ==

286 ((
‹ig_öode
->
i_size
 - 1Ë>> orig_öode->
i_blkbôs
)) {

288 
tmp_d©a_size
 = 
‹ig_öode
->
i_size
 & (
blocksize
 - 1);

293 i‡(
tmp_d©a_size
 == 0)

294 
tmp_d©a_size
 = 
blocksize
;

296 
d©a_size
 = 
tmp_d©a_size
 +

297 ((
block_Àn_ö_∑ge
 - 1Ë<< 
‹ig_öode
->
i_blkbôs
);

299 
d©a_size
 = 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

301 
ª∂a˚d_size
 = 
d©a_size
;

303 *
îr
 = 
	`mext_∑ge_doubÀ_lock
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_∑ge_off£t
,

304 
d⁄‹_∑ge_off£t
, 
∑gï
);

305 i‡(
	`u∆ikñy
(*
îr
 < 0))

306 
°›_jou∫Æ
;

314 i‡(
unwrôãn
) {

315 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

318 
unwrôãn
 = 
	`mext_check_covîage
(
‹ig_öode
, 
‹ig_blk_off£t
,

319 
block_Àn_ö_∑ge
, 1, 
îr
);

320 i‡(*
îr
)

321 
dr›_d©a_£m
;

323 
unwrôãn
 &
	`mext_check_covîage
(
d⁄‹_öode
, 
d⁄‹_blk_off£t
,

324 
block_Àn_ö_∑ge
, 1, 
îr
);

325 i‡(*
îr
)

326 
dr›_d©a_£m
;

328 i‡(!
unwrôãn
) {

329 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

330 
d©a_c›y
;

332 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]) &&

333 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[0], 0)) ||

334 (
	`∑ge_has_¥iv©e
(
∑gï
[1]) &&

335 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[1], 0))) {

336 *
îr
 = -
EBUSY
;

337 
dr›_d©a_£m
;

339 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
,

340 
d⁄‹_öode
, 
‹ig_blk_off£t
,

341 
d⁄‹_blk_off£t
,

342 
block_Àn_ö_∑ge
, 1, 
îr
);

343 
dr›_d©a_£m
:

344 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

345 
u∆ock_∑ges
;

347 
d©a_c›y
:

348 *
îr
 = 
	`mext_∑ge_mku±od©e
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

349 i‡(*
îr
)

350 
u∆ock_∑ges
;

354 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[0], 0)) ||

355 (
	`∑ge_has_¥iv©e
(
∑gï
[1]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[1], 0))) {

356 *
îr
 = -
EBUSY
;

357 
u∆ock_∑ges
;

359 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

360 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
, 
d⁄‹_öode
,

361 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

362 
block_Àn_ö_∑ge
, 1, 
îr
);

363 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

364 i‡(*
îr
) {

365 i‡(
ª∂a˚d_cou¡
) {

366 
block_Àn_ö_∑ge
 = 
ª∂a˚d_cou¡
;

367 
ª∂a˚d_size
 =

368 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

370 
u∆ock_∑ges
;

374 i‡(!
	`∑ge_has_buf„rs
(
∑gï
[0]))

375 
	`¸óã_em±y_buf„rs
(
∑gï
[0], 1 << 
‹ig_öode
->
i_blkbôs
, 0);

376 
bh
 = 
	`∑ge_buf„rs
(
∑gï
[0]);

377 
i
 = 0; i < 
d©a_off£t_ö_∑ge
; i++)

378 
bh
 = bh->
b_this_∑ge
;

379 
i
 = 0; i < 
block_Àn_ö_∑ge
; i++) {

380 *
îr
 = 
	`pxt4_gë_block
(
‹ig_öode
, 
‹ig_blk_off£t
 + 
i
, 
bh
, 0);

381 i‡(*
îr
 < 0)

383 
bh
 = bh->
b_this_∑ge
;

385 i‡(!*
îr
)

386 *
îr
 = 
	`block_commô_wrôe
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

388 i‡(
	`u∆ikñy
(*
îr
 < 0))

389 
ª∑ú_bønches
;

393 *
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
‹ig_öode
,

394 (
loff_t
)
‹ig_∑ge_off£t
 << 
PAGE_SHIFT
, 
ª∂a˚d_size
);

396 
u∆ock_∑ges
:

397 
	`u∆ock_∑ge
(
∑gï
[0]);

398 
	`put_∑ge
(
∑gï
[0]);

399 
	`u∆ock_∑ge
(
∑gï
[1]);

400 
	`put_∑ge
(
∑gï
[1]);

401 
°›_jou∫Æ
:

402 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

403 i‡(*
îr
 =-
ENOSPC
 &&

404 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

405 
agaö
;

408 i‡(*
îr
 =-
EBUSY
 && 
ªåõs
++ < 4 && 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

409 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
))

410 
agaö
;

411  
ª∂a˚d_cou¡
;

413 
ª∑ú_bønches
:

419 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

420 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
d⁄‹_öode
, 
‹ig_öode
,

421 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

422 
block_Àn_ö_∑ge
, 0, &
îr2
);

423 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

424 i‡(
ª∂a˚d_cou¡
 !
block_Àn_ö_∑ge
) {

425 
	`PXT4_ERROR_INODE_BLOCK
(
‹ig_öode
, (
£˘‹_t
)(
‹ig_blk_off£t
),

428 *
îr
 = -
EIO
;

430 
ª∂a˚d_cou¡
 = 0;

431 
u∆ock_∑ges
;

432 
	}
}

448 
	$mext_check_¨gumíts
(
öode
 *
‹ig_öode
,

449 
öode
 *
d⁄‹_öode
, 
__u64
 
‹ig_°¨t
,

450 
__u64
 
d⁄‹_°¨t
, __u64 *
Àn
)

452 
__u64
 
‹ig_eof
, 
d⁄‹_eof
;

453 
blkbôs
 = 
‹ig_öode
->
i_blkbôs
;

454 
blocksize
 = 1 << 
blkbôs
;

456 
‹ig_eof
 = (
	`i_size_ªad
(
‹ig_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

457 
d⁄‹_eof
 = (
	`i_size_ªad
(
d⁄‹_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

460 i‡(
d⁄‹_öode
->
i_mode
 & (
S_ISUID
|
S_ISGID
)) {

461 
	`pxt4_debug
("pxt4 moveÉxtent: suid or sgid is set"

463 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

464  -
EINVAL
;

467 i‡(
	`IS_IMMUTABLE
(
d⁄‹_öode
Ë|| 
	`IS_APPEND
(donor_inode))

468  -
EPERM
;

471 i‡(
	`IS_SWAPFILE
(
‹ig_öode
Ë|| IS_SWAPFILE(
d⁄‹_öode
)) {

472 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

474 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

475  -
EBUSY
;

478 i‡(
	`pxt4_is_quŸa_fûe
(
‹ig_öode
Ë&&Öxt4_is_quŸa_fûe(
d⁄‹_öode
)) {

479 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

481 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

482  -
EBUSY
;

486 i‡(!(
	`pxt4_ã°_öode_Êag
(
‹ig_öode
, 
PXT4_INODE_EXTENTS
))) {

487 
	`pxt4_debug
("pxt4 moveÉxtent: orig file isÇotÉxtents "

488 "ba£d fûê[öo:‹ig %lu]\n", 
‹ig_öode
->
i_öo
);

489  -
EOPNOTSUPP
;

490 } i‡(!(
	`pxt4_ã°_öode_Êag
(
d⁄‹_öode
, 
PXT4_INODE_EXTENTS
))) {

491 
	`pxt4_debug
("pxt4 moveÉxtent: donor file isÇotÉxtents "

492 "ba£d fûê[öo:d⁄‹ %lu]\n", 
d⁄‹_öode
->
i_öo
);

493  -
EOPNOTSUPP
;

496 i‡((!
‹ig_öode
->
i_size
Ë|| (!
d⁄‹_öode
->i_size)) {

497 
	`pxt4_debug
("pxt4 moveÉxtent: File size is 0 byte\n");

498  -
EINVAL
;

502 i‡((
‹ig_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
)) !=

503 (
d⁄‹_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
))) {

504 
	`pxt4_debug
("pxt4 moveÉxtent: origánd donor's start "

506 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

507  -
EINVAL
;

510 i‡((
‹ig_°¨t
 >
EXT_MAX_BLOCKS
) ||

511 (
d⁄‹_°¨t
 >
EXT_MAX_BLOCKS
) ||

512 (*
Àn
 > 
EXT_MAX_BLOCKS
) ||

513 (
d⁄‹_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
) ||

514 (
‹ig_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
)) {

515 
	`pxt4_debug
("pxt4 moveÉxtent: Can't handle over [%u] blocks "

516 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
EXT_MAX_BLOCKS
,

517 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

518  -
EINVAL
;

520 i‡(
‹ig_eof
 <
‹ig_°¨t
)

521 *
Àn
 = 0;

522 i‡(
‹ig_eof
 < 
‹ig_°¨t
 + *
Àn
 - 1)

523 *
Àn
 = 
‹ig_eof
 - 
‹ig_°¨t
;

524 i‡(
d⁄‹_eof
 <
d⁄‹_°¨t
)

525 *
Àn
 = 0;

526 i‡(
d⁄‹_eof
 < 
d⁄‹_°¨t
 + *
Àn
 - 1)

527 *
Àn
 = 
d⁄‹_eof
 - 
d⁄‹_°¨t
;

528 i‡(!*
Àn
) {

529 
	`pxt4_debug
("pxt4 moveÉxtent:Üen shouldÇot be 0 "

530 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
‹ig_öode
->
i_öo
,

531 
d⁄‹_öode
->
i_öo
);

532  -
EINVAL
;

536 
	}
}

553 
	$pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
, 
__u64
 
‹ig_blk
,

554 
__u64
 
d⁄‹_blk
, __u64 
Àn
, __u64 *
moved_Àn
)

556 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

557 
öode
 *
d⁄‹_öode
 = 
	`fûe_öode
(
d_fûp
);

558 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

559 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

560 
pxt4_lblk_t
 
o_íd
, 
o_°¨t
 = 
‹ig_blk
;

561 
pxt4_lblk_t
 
d_°¨t
 = 
d⁄‹_blk
;

562 
ªt
;

564 i‡(
‹ig_öode
->
i_sb
 !
d⁄‹_öode
->i_sb) {

565 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files "

567 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

568  -
EINVAL
;

572 i‡(
‹ig_öode
 =
d⁄‹_öode
) {

573 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files shouldÇot "

575 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

576  -
EINVAL
;

580 i‡(!
	`S_ISREG
(
‹ig_öode
->
i_mode
Ë|| !S_ISREG(
d⁄‹_öode
->i_mode)) {

581 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should be "

583 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

584  -
EINVAL
;

589 i‡(
	`pxt4_should_jou∫Æ_d©a
(
‹ig_öode
) ||

590 
	`pxt4_should_jou∫Æ_d©a
(
d⁄‹_öode
)) {

591 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

593  -
EOPNOTSUPP
;

596 i‡(
	`IS_ENCRYPTED
(
‹ig_öode
Ë|| IS_ENCRYPTED(
d⁄‹_öode
)) {

597 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

599  -
EOPNOTSUPP
;

603 
	`lock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

606 
	`öode_dio_waô
(
‹ig_öode
);

607 
	`öode_dio_waô
(
d⁄‹_öode
);

610 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

612 
ªt
 = 
	`mext_check_¨gumíts
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_blk
,

613 
d⁄‹_blk
, &
Àn
);

614 i‡(
ªt
)

615 
out
;

616 
o_íd
 = 
o_°¨t
 + 
Àn
;

618 
o_°¨t
 < 
o_íd
) {

619 
pxt4_exã¡
 *
ex
;

620 
pxt4_lblk_t
 
cur_blk
, 
√xt_blk
;

621 
pgoff_t
 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
;

622 
off£t_ö_∑ge
;

623 
unwrôãn
, 
cur_Àn
;

625 
ªt
 = 
	`gë_ext_∑th
(
‹ig_öode
, 
o_°¨t
, &
∑th
);

626 i‡(
ªt
)

627 
out
;

628 
ex
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

629 
√xt_blk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

630 
cur_blk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

631 
cur_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

633 i‡(
cur_blk
 + 
cur_Àn
 - 1 < 
o_°¨t
) {

634 i‡(
√xt_blk
 =
EXT_MAX_BLOCKS
) {

635 
o_°¨t
 = 
o_íd
;

636 
ªt
 = -
ENODATA
;

637 
out
;

639 
d_°¨t
 +
√xt_blk
 - 
o_°¨t
;

640 
o_°¨t
 = 
√xt_blk
;

643 } i‡(
cur_blk
 > 
o_°¨t
) {

645 
d_°¨t
 +
cur_blk
 - 
o_°¨t
;

646 
o_°¨t
 = 
cur_blk
;

648 i‡(
cur_blk
 >
o_íd
)

649 
out
;

651 
cur_Àn
 +
cur_blk
 - 
o_°¨t
;

653 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

654 i‡(
o_íd
 - 
o_°¨t
 < 
cur_Àn
)

655 
cur_Àn
 = 
o_íd
 - 
o_°¨t
;

657 
‹ig_∑ge_ödex
 = 
o_°¨t
 >> (
PAGE_SHIFT
 -

658 
‹ig_öode
->
i_blkbôs
);

659 
d⁄‹_∑ge_ödex
 = 
d_°¨t
 >> (
PAGE_SHIFT
 -

660 
d⁄‹_öode
->
i_blkbôs
);

661 
off£t_ö_∑ge
 = 
o_°¨t
 % 
blocks_≥r_∑ge
;

662 i‡(
cur_Àn
 > 
blocks_≥r_∑ge
- 
off£t_ö_∑ge
)

663 
cur_Àn
 = 
blocks_≥r_∑ge
 - 
off£t_ö_∑ge
;

671 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

673 
	`move_exã¡_≥r_∑ge
(
o_fûp
, 
d⁄‹_öode
,

674 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
,

675 
off£t_ö_∑ge
, 
cur_Àn
,

676 
unwrôãn
, &
ªt
);

677 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

678 i‡(
ªt
 < 0)

680 
o_°¨t
 +
cur_Àn
;

681 
d_°¨t
 +
cur_Àn
;

683 *
moved_Àn
 = 
o_°¨t
 - 
‹ig_blk
;

684 i‡(*
moved_Àn
 > 
Àn
)

685 *
moved_Àn
 = 
Àn
;

687 
out
:

688 i‡(*
moved_Àn
) {

689 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
‹ig_öode
);

690 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
d⁄‹_öode
);

693 
	`pxt4_ext_dr›_ªfs
(
∑th
);

694 
	`k‰ì
(
∑th
);

695 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

696 
	`u∆ock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

698  
ªt
;

699 
	}
}

	@namei.c

28 
	~<löux/fs.h
>

29 
	~<löux/∑gem≠.h
>

30 
	~<löux/time.h
>

31 
	~<löux/f˙é.h
>

32 
	~<löux/°©.h
>

33 
	~<löux/°rög.h
>

34 
	~<löux/quŸa›s.h
>

35 
	~<löux/buf„r_hód.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/ivîsi⁄.h
>

38 
	~<löux/unicode.h
>

39 
	~"pxt4.h
"

40 
	~"pxt4_jbd3.h
"

42 
	~"x©å.h
"

43 
	~"a˛.h
"

45 
	~<åa˚/evíts/pxt4.h
>

49 
	#NAMEI_RA_CHUNKS
 2

	)

50 
	#NAMEI_RA_BLOCKS
 4

	)

51 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

53 
buf„r_hód
 *
	$pxt4_≠≥nd
(
h™dÀ_t
 *
h™dÀ
,

54 
öode
 *inode,

55 
pxt4_lblk_t
 *
block
)

57 
buf„r_hód
 *
bh
;

58 
îr
;

60 i‡(
	`u∆ikñy
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
 &&

61 ((
öode
->
i_size
 >> 10) >=

62 
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
)))

63  
	`ERR_PTR
(-
ENOSPC
);

65 *
block
 = 
öode
->
i_size
 >> inode->
i_sb
->
s_blocksize_bôs
;

67 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, *
block
, 
PXT4_GET_BLOCKS_CREATE
);

68 i‡(
	`IS_ERR
(
bh
))

69  
bh
;

70 
öode
->
i_size
 +öode->
i_sb
->
s_blocksize
;

71 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

72 
	`BUFFER_TRACE
(
bh
, "get_write_access");

73 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

74 i‡(
îr
) {

75 
	`bªl£
(
bh
);

76 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

77  
	`ERR_PTR
(
îr
);

79  
bh
;

80 
	}
}

82 
pxt4_dx_csum_vîify
(
öode
 *inode,

83 
pxt4_dú_íåy
 *
dúít
);

96 
	mEITHER
, 
	mINDEX
, 
	mDIRENT
, 
	mDIRENT_HTREE


97 } 
	tdúblock_ty≥_t
;

99 
	#pxt4_ªad_dúblock
(
öode
, 
block
, 
ty≥
) \

100 
	`__pxt4_ªad_dúblock
((
öode
), (
block
), (
ty≥
), 
__func__
, 
__LINE__
)

	)

102 
buf„r_hód
 *
	$__pxt4_ªad_dúblock
(
öode
 *inode,

103 
pxt4_lblk_t
 
block
,

104 
dúblock_ty≥_t
 
ty≥
,

105 c⁄° *
func
,

106 
löe
)

108 
buf„r_hód
 *
bh
;

109 
pxt4_dú_íåy
 *
dúít
;

110 
is_dx_block
 = 0;

112 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
block
, 0);

113 i‡(
	`IS_ERR
(
bh
)) {

114 
	`__pxt4_w¨nög
(
öode
->
i_sb
, 
func
, 
löe
,

117 
öode
->
i_öo
, ()
block
,

118 
cuºít
->
comm
, 
	`PTR_ERR
(
bh
));

120  
bh
;

122 i‡(!
bh
 && (
ty≥
 =
INDEX
 ||Åy≥ =
DIRENT_HTREE
)) {

123 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

125 (
ty≥
 =
INDEX
) ? "index" : "leaf");

126  
	`ERR_PTR
(-
EFSCORRUPTED
);

128 i‡(!
bh
)

129  
NULL
;

130 
dúít
 = (
pxt4_dú_íåy
 *Ë
bh
->
b_d©a
;

132 i‡(
	`is_dx
(
öode
)) {

133 i‡(
block
 == 0)

134 
is_dx_block
 = 1;

135 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
dúít
->
ªc_Àn
,

136 
öode
->
i_sb
->
s_blocksize
) ==

137 
öode
->
i_sb
->
s_blocksize
)

138 
is_dx_block
 = 1;

140 i‡(!
is_dx_block
 && 
ty≥
 =
INDEX
) {

141 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

143 
	`bªl£
(
bh
);

144  
	`ERR_PTR
(-
EFSCORRUPTED
);

146 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
) ||

147 
	`buf„r_vîifõd
(
bh
))

148  
bh
;

155 i‡(
is_dx_block
 && 
ty≥
 =
INDEX
) {

156 i‡(
	`pxt4_dx_csum_vîify
(
öode
, 
dúít
))

157 
	`£t_buf„r_vîifõd
(
bh
);

159 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

161 
	`bªl£
(
bh
);

162  
	`ERR_PTR
(-
EFSBADCRC
);

165 i‡(!
is_dx_block
) {

166 i‡(
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
))

167 
	`£t_buf„r_vîifõd
(
bh
);

169 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

171 
	`bªl£
(
bh
);

172  
	`ERR_PTR
(-
EFSBADCRC
);

175  
bh
;

176 
	}
}

178 #i‚de‡
as£π


179 
	#as£π
(
ã°
Ë
	`J_ASSERT
—e°)

	)

182 #ifde‡
DX_DEBUG


183 
	#dxåa˚
(
comm™d
Ë
	)
command

185 
	#dxåa˚
(
comm™d
)

	)

188 
	sÁke_dúít


190 
__À32
 
	möode
;

191 
__À16
 
	mªc_Àn
;

192 
u8
 
	m«me_Àn
;

193 
u8
 
	mfûe_ty≥
;

196 
	sdx_cou¡limô


198 
__À16
 
	mlimô
;

199 
__À16
 
	mcou¡
;

202 
	sdx_íåy


204 
__À32
 
	mhash
;

205 
__À32
 
	mblock
;

214 
	sdx_roŸ


216 
Áke_dúít
 
	mdŸ
;

217 
	mdŸ_«me
[4];

218 
Áke_dúít
 
	mdŸdŸ
;

219 
	mdŸdŸ_«me
[4];

220 
	sdx_roŸ_öfo


222 
__À32
 
	mª£rved_zîo
;

223 
u8
 
	mhash_vîsi⁄
;

224 
u8
 
	möfo_Àngth
;

225 
u8
 
	mödúe˘_Àvñs
;

226 
u8
 
	munu£d_Êags
;

228 
	möfo
;

229 
dx_íåy
 
	míåõs
[0];

232 
	sdx_node


234 
Áke_dúít
 
	mÁke
;

235 
dx_íåy
 
	míåõs
[0];

239 
	sdx_‰ame


241 
buf„r_hód
 *
	mbh
;

242 
dx_íåy
 *
	míåõs
;

243 
dx_íåy
 *
	m©
;

246 
	sdx_m≠_íåy


248 
u32
 
	mhash
;

249 
u16
 
	moffs
;

250 
u16
 
	msize
;

256 
	sdx_èû
 {

257 
u32
 
	mdt_ª£rved
;

258 
__À32
 
	mdt_checksum
;

261 
ölöe
 
pxt4_lblk_t
 
dx_gë_block
(
dx_íåy
 *
íåy
);

262 
dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
);

263 
ölöe
 
dx_gë_hash
(
dx_íåy
 *
íåy
);

264 
dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
);

265 
dx_gë_cou¡
(
dx_íåy
 *
íåõs
);

266 
dx_gë_limô
(
dx_íåy
 *
íåõs
);

267 
dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
);

268 
dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
);

269 
dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
);

270 
dx_node_limô
(
öode
 *
dú
);

271 
dx_‰ame
 *
dx_¥obe
(
pxt4_fûíame
 *
‚ame
,

272 
öode
 *
dú
,

273 
dx_hash_öfo
 *
höfo
,

274 
dx_‰ame
 *
‰ame
);

275 
dx_ªÀa£
(
dx_‰ame
 *
‰ames
);

276 
dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

277 
blocksize
, 
dx_hash_öfo
 *
höfo
,

278 
dx_m≠_íåy
 
m≠
[]);

279 
dx_s‹t_m≠
(
dx_m≠_íåy
 *
m≠
, 
cou¡
);

280 
pxt4_dú_íåy_2
 *
dx_move_dúíts
(*
‰om
, *
to
,

281 
dx_m≠_íåy
 *
off£ts
, 
cou¡
, 
blocksize
);

282 
pxt4_dú_íåy_2
* 
dx_∑ck_dúíts
(*
ba£
, 
blocksize
);

283 
dx_ö£π_block
(
dx_‰ame
 *
‰ame
,

284 
u32
 
hash
, 
pxt4_lblk_t
 
block
);

285 
pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

286 
dx_‰ame
 *
‰ame
,

287 
dx_‰ame
 *
‰ames
,

288 
__u32
 *
°¨t_hash
);

289 
buf„r_hód
 * 
pxt4_dx_föd_íåy
(
öode
 *
dú
,

290 
pxt4_fûíame
 *
‚ame
,

291 
pxt4_dú_íåy_2
 **
ªs_dú
);

292 
pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

293 
öode
 *
dú
, inode *inode);

296 
	$pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

297 
blocksize
)

299 
pxt4_dú_íåy_èû
 *
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
blocksize
);

301 
	`mem£t
(
t
, 0, (
pxt4_dú_íåy_èû
));

302 
t
->
dë_ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

303 (
pxt4_dú_íåy_èû
), 
blocksize
);

304 
t
->
dë_ª£rved_·
 = 
PXT4_FT_DIR_CSUM
;

305 
	}
}

308 
pxt4_dú_íåy_èû
 *
	$gë_dúít_èû
(
öode
 *inode,

309 
buf„r_hód
 *
bh
)

311 
pxt4_dú_íåy_èû
 *
t
;

313 #ifde‡
PARANOID


314 
pxt4_dú_íåy
 *
d
, *
t›
;

316 
d
 = (
pxt4_dú_íåy
 *)
bh
->
b_d©a
;

317 
t›
 = (
pxt4_dú_íåy
 *)(
bh
->
b_d©a
 +

318 (
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) -

319 (
pxt4_dú_íåy_èû
)));

320 
d
 < 
t›
 && d->
ªc_Àn
)

321 
d
 = (
pxt4_dú_íåy
 *)(((*)d) +

322 
	`À16_to_˝u
(
d
->
ªc_Àn
));

324 i‡(
d
 !
t›
)

325  
NULL
;

327 
t
 = (
pxt4_dú_íåy_èû
 *)
d
;

329 
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
));

332 i‡(
t
->
dë_ª£rved_zîo1
 ||

333 
	`À16_to_˝u
(
t
->
dë_ªc_Àn
Ë!(
pxt4_dú_íåy_èû
) ||

334 
t
->
dë_ª£rved_zîo2
 ||

335 
t
->
dë_ª£rved_·
 !
PXT4_FT_DIR_CSUM
)

336  
NULL
;

338  
t
;

339 
	}
}

341 
__À32
 
	$pxt4_dúblock_csum
(
öode
 *öode, *
dúít
, 
size
)

343 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

344 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

345 
__u32
 
csum
;

347 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

348  
	`˝u_to_À32
(
csum
);

349 
	}
}

351 
	#w¨n_no_•a˚_f‹_csum
(
öode
) \

352 
	`__w¨n_no_•a˚_f‹_csum
((
öode
), 
__func__
, 
__LINE__
)

	)

354 
	$__w¨n_no_•a˚_f‹_csum
(
öode
 *öode, c⁄° *
func
,

355 
löe
)

357 
	`__pxt4_w¨nög_öode
(
öode
, 
func
, 
löe
,

359 
	}
}

361 
	$pxt4_dúblock_csum_vîify
(
öode
 *öode, 
buf„r_hód
 *
bh
)

363 
pxt4_dú_íåy_èû
 *
t
;

365 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

368 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

369 i‡(!
t
) {

370 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

374 i‡(
t
->
dë_checksum
 !
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

375 (*)
t
 - 
bh
->
b_d©a
))

379 
	}
}

381 
	$pxt4_dúblock_csum_£t
(
öode
 *inode,

382 
buf„r_hód
 *
bh
)

384 
pxt4_dú_íåy_èû
 *
t
;

386 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

389 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

390 i‡(!
t
) {

391 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

395 
t
->
dë_checksum
 = 
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

396 (*)
t
 - 
bh
->
b_d©a
);

397 
	}
}

399 
	$pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
,

400 
öode
 *inode,

401 
buf„r_hód
 *
bh
)

403 
	`pxt4_dúblock_csum_£t
(
öode
, 
bh
);

404  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

405 
	}
}

407 
dx_cou¡limô
 *
	$gë_dx_cou¡limô
(
öode
 *inode,

408 
pxt4_dú_íåy
 *
dúít
,

409 *
off£t
)

411 
pxt4_dú_íåy
 *
dp
;

412 
dx_roŸ_öfo
 *
roŸ
;

413 
cou¡_off£t
;

415 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
Ë=
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
))

416 
cou¡_off£t
 = 8;

417 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
) == 12) {

418 
dp
 = (
pxt4_dú_íåy
 *)(((*)
dúít
) + 12);

419 i‡(
	`À16_to_˝u
(
dp
->
ªc_Àn
) !=

420 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) - 12)

421  
NULL
;

422 
roŸ
 = (
dx_roŸ_öfo
 *)(((*)
dp
 + 12));

423 i‡(
roŸ
->
ª£rved_zîo
 ||

424 
roŸ
->
öfo_Àngth
 !(
dx_roŸ_öfo
))

425  
NULL
;

426 
cou¡_off£t
 = 32;

428  
NULL
;

430 i‡(
off£t
)

431 *
off£t
 = 
cou¡_off£t
;

432  (
dx_cou¡limô
 *)(((*)
dúít
Ë+ 
cou¡_off£t
);

433 
	}
}

435 
__À32
 
	$pxt4_dx_csum
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
,

436 
cou¡_off£t
, 
cou¡
, 
dx_èû
 *
t
)

438 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

439 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

440 
__u32
 
csum
;

441 
size
;

442 
__u32
 
dummy_csum
 = 0;

443 
off£t
 = 
	`off£tof
(
dx_èû
, 
dt_checksum
);

445 
size
 = 
cou¡_off£t
 + (
cou¡
 * (
dx_íåy
));

446 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

447 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
t
, 
off£t
);

448 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

450  
	`˝u_to_À32
(
csum
);

451 
	}
}

453 
	$pxt4_dx_csum_vîify
(
öode
 *inode,

454 
pxt4_dú_íåy
 *
dúít
)

456 
dx_cou¡limô
 *
c
;

457 
dx_èû
 *
t
;

458 
cou¡_off£t
, 
limô
, 
cou¡
;

460 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

463 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

464 i‡(!
c
) {

465 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

468 
limô
 = 
	`À16_to_˝u
(
c
->limit);

469 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

470 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

471 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

472 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

475 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

477 i‡(
t
->
dt_checksum
 !
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
,

478 
cou¡
, 
t
))

481 
	}
}

483 
	$pxt4_dx_csum_£t
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
)

485 
dx_cou¡limô
 *
c
;

486 
dx_èû
 *
t
;

487 
cou¡_off£t
, 
limô
, 
cou¡
;

489 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

492 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

493 i‡(!
c
) {

494 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

497 
limô
 = 
	`À16_to_˝u
(
c
->limit);

498 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

499 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

500 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

501 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

504 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

506 
t
->
dt_checksum
 = 
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
, 
cou¡
,Å);

507 
	}
}

509 
ölöe
 
	$pxt4_h™dÀ_dúty_dx_node
(
h™dÀ_t
 *
h™dÀ
,

510 
öode
 *inode,

511 
buf„r_hód
 *
bh
)

513 
	`pxt4_dx_csum_£t
(
öode
, (
pxt4_dú_íåy
 *)
bh
->
b_d©a
);

514  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

515 
	}
}

520 
ölöe
 
pxt4_dú_íåy_2
 *

521 
	$pxt4_√xt_íåy
(
pxt4_dú_íåy_2
 *
p
, 
blocksize
)

523  (
pxt4_dú_íåy_2
 *)((*)
p
 +

524 
	`pxt4_ªc_Àn_‰om_disk
(
p
->
ªc_Àn
, 
blocksize
));

525 
	}
}

532 
ölöe
 
pxt4_lblk_t
 
	$dx_gë_block
(
dx_íåy
 *
íåy
)

534  
	`À32_to_˝u
(
íåy
->
block
) & 0x0fffffff;

535 
	}
}

537 
ölöe
 
	$dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
)

539 
íåy
->
block
 = 
	`˝u_to_À32
(
vÆue
);

540 
	}
}

542 
ölöe
 
	$dx_gë_hash
(
dx_íåy
 *
íåy
)

544  
	`À32_to_˝u
(
íåy
->
hash
);

545 
	}
}

547 
ölöe
 
	$dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
)

549 
íåy
->
hash
 = 
	`˝u_to_À32
(
vÆue
);

550 
	}
}

552 
ölöe
 
	$dx_gë_cou¡
(
dx_íåy
 *
íåõs
)

554  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
);

555 
	}
}

557 
ölöe
 
	$dx_gë_limô
(
dx_íåy
 *
íåõs
)

559  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
limô
);

560 
	}
}

562 
ölöe
 
	$dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
)

564 ((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
 = 
	`˝u_to_À16
(
vÆue
);

565 
	}
}

567 
ölöe
 
	$dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
)

569 ((
dx_cou¡limô
 *Ë
íåõs
)->
limô
 = 
	`˝u_to_À16
(
vÆue
);

570 
	}
}

572 
ölöe
 
	$dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
)

574 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(1) -

575 
	`PXT4_DIR_REC_LEN
(2Ë- 
öfosize
;

577 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

578 
íåy_•a˚
 -(
dx_èû
);

579  
íåy_•a˚
 / (
dx_íåy
);

580 
	}
}

582 
ölöe
 
	$dx_node_limô
(
öode
 *
dú
)

584 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(0);

586 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

587 
íåy_•a˚
 -(
dx_èû
);

588  
íåy_•a˚
 / (
dx_íåy
);

589 
	}
}

594 #ifde‡
DX_DEBUG


595 
	$dx_show_ödex
(* 
œbñ
, 
dx_íåy
 *
íåõs
)

597 
i
, 
n
 = 
	`dx_gë_cou¡
 (
íåõs
);

598 
	`¥ötk
(
KERN_DEBUG
 "%†ödex", 
œbñ
);

599 
i
 = 0; i < 
n
; i++) {

600 
	`¥ötk
(
KERN_CONT
 " %x->%lu",

601 
i
 ? 
	`dx_gë_hash
(
íåõs
 + i) : 0,

602 ()
	`dx_gë_block
(
íåõs
 + 
i
));

604 
	`¥ötk
(
KERN_CONT
 "\n");

605 
	}
}

607 
	s°©s


609 
	m«mes
;

610 
	m•a˚
;

611 
	mbcou¡
;

614 
°©s
 
	$dx_show_Àaf
(
öode
 *
dú
,

615 
dx_hash_öfo
 *
höfo
,

616 
pxt4_dú_íåy_2
 *
de
,

617 
size
, 
show_«mes
)

619 
«mes
 = 0, 
•a˚
 = 0;

620 *
ba£
 = (*Ë
de
;

621 
dx_hash_öfo
 
h
 = *
höfo
;

623 
	`¥ötk
("names: ");

624 (*Ë
de
 < 
ba£
 + 
size
)

626 i‡(
de
->
öode
)

628 i‡(
show_«mes
)

630 #ifde‡
CONFIG_FS_ENCRYPTION


631 
Àn
;

632 *
«me
;

633 
fs¸y±_°r
 
‚ame_¸y±o_°r
 =

634 
	`FSTR_INIT
(
NULL
, 0);

635 
ªs
 = 0;

637 
«me
 = 
de
->name;

638 
Àn
 = 
de
->
«me_Àn
;

639 i‡(
	`IS_ENCRYPTED
(
dú
))

640 
ªs
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

641 i‡(
ªs
) {

642 
	`¥ötk
(
KERN_WARNING
 "Error setting up"

643 " f«mê¸y±o: %d\n", 
ªs
);

645 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
)) {

647 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

648 
de
->
«me_Àn
, &
h
);

649 
	`¥ötk
("%*.s:(U)%x.%u ", 
Àn
,

650 
«me
, 
h
.
hash
,

651 (Ë((*Ë
de


652 - 
ba£
));

654 
fs¸y±_°r
 
de_«me
 =

655 
	`FSTR_INIT
(
«me
, 
Àn
);

658 
ªs
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(

659 
dú
, 
Àn
,

660 &
‚ame_¸y±o_°r
);

661 i‡(
ªs
)

662 
	`¥ötk
(
KERN_WARNING
 "Error "

666 
ªs
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
,

667 0, 0, &
de_«me
,

668 &
‚ame_¸y±o_°r
);

669 i‡(
ªs
) {

670 
	`¥ötk
(
KERN_WARNING
 "Error "

674 
«me
 = "??";

675 
Àn
 = 2;

677 
«me
 = 
‚ame_¸y±o_°r
.name;

678 
Àn
 = 
‚ame_¸y±o_°r
.len;

680 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

681 
de
->
«me_Àn
, &
h
);

682 
	`¥ötk
("%*.s:(E)%x.%u ", 
Àn
, 
«me
,

683 
h
.
hash
, (Ë((*Ë
de


684 - 
ba£
));

685 
	`fs¸y±_‚ame_‰ì_buf„r
(

686 &
‚ame_¸y±o_°r
);

689 
Àn
 = 
de
->
«me_Àn
;

690 *
«me
 = 
de
->name;

691 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

692 
	`¥ötk
("%*.s:%x.%u ", 
Àn
, 
«me
, 
h
.
hash
,

693 (Ë((*Ë
de
 - 
ba£
));

696 
•a˚
 +
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

697 
«mes
++;

699 
de
 = 
	`pxt4_√xt_íåy
(de, 
size
);

701 
	`¥ötk
(
KERN_CONT
 "(%i)\n", 
«mes
);

702  (
°©s
Ë{ 
«mes
, 
•a˚
, 1 };

703 
	}
}

705 
°©s
 
	$dx_show_íåõs
(
dx_hash_öfo
 *
höfo
, 
öode
 *
dú
,

706 
dx_íåy
 *
íåõs
, 
Àvñs
)

708 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

709 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
), 
«mes
 = 0, 
•a˚
 = 0, 
i
;

710 
bcou¡
 = 0;

711 
buf„r_hód
 *
bh
;

712 
	`¥ötk
("%òödexed blocks...\n", 
cou¡
);

713 
i
 = 0; i < 
cou¡
; i++, 
íåõs
++)

715 
pxt4_lblk_t
 
block
 = 
	`dx_gë_block
(
íåõs
);

716 
pxt4_lblk_t
 
hash
 = 
i
 ? 
	`dx_gë_hash
(
íåõs
): 0;

717 
u32
 
ønge
 = 
i
 < 
cou¡
 - 1? (
	`dx_gë_hash
(
íåõs
 + 1Ë- 
hash
): ~hash;

718 
°©s
 stats;

719 
	`¥ötk
("%s%3u:%03u hash %8x/%8x ",
Àvñs
?"":" ", 
i
, 
block
, 
hash
, 
ønge
);

720 
bh
 = 
	`pxt4_bªad
(
NULL
,
dú
, 
block
, 0);

721 i‡(!
bh
 || 
	`IS_ERR
(bh))

723 
°©s
 = 
Àvñs
?

724 
	`dx_show_íåõs
(
höfo
, 
dú
, ((
dx_node
 *Ë
bh
->
b_d©a
)->
íåõs
, 
Àvñs
 - 1):

725 
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *)

726 
bh
->
b_d©a
, 
blocksize
, 0);

727 
«mes
 +
°©s
.names;

728 
•a˚
 +
°©s
.space;

729 
bcou¡
 +
°©s
.bcount;

730 
	`bªl£
(
bh
);

732 i‡(
bcou¡
)

733 
	`¥ötk
(
KERN_DEBUG
 "%snames %u, fullness %u (%u%%)\n",

734 
Àvñs
 ? "" : " ", 
«mes
, 
•a˚
/
bcou¡
,

735 (
•a˚
/
bcou¡
)*100/
blocksize
);

736  (
°©s
Ë{ 
«mes
, 
•a˚
, 
bcou¡
};

737 
	}
}

749 
dx_‰ame
 *

750 
	$dx_¥obe
(
pxt4_fûíame
 *
‚ame
, 
öode
 *
dú
,

751 
dx_hash_öfo
 *
höfo
, 
dx_‰ame
 *
‰ame_ö
)

753 
cou¡
, 
ödúe˘
;

754 
dx_íåy
 *
©
, *
íåõs
, *
p
, *
q
, *
m
;

755 
dx_roŸ
 *
roŸ
;

756 
dx_‰ame
 *
‰ame
 = 
‰ame_ö
;

757 
dx_‰ame
 *
ªt_îr
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

758 
u32
 
hash
;

760 
	`mem£t
(
‰ame_ö
, 0, 
PXT4_HTREE_LEVEL
 * (frame_in[0]));

761 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 0, 
INDEX
);

762 i‡(
	`IS_ERR
(
‰ame
->
bh
))

763  (
dx_‰ame
 *Ë
‰ame
->
bh
;

765 
roŸ
 = (
dx_roŸ
 *Ë
‰ame
->
bh
->
b_d©a
;

766 i‡(
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_TEA
 &&

767 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_HALF_MD4
 &&

768 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_LEGACY
) {

769 
	`pxt4_w¨nög_öode
(
dú
, "Unrecognised inode hash code %u",

770 
roŸ
->
öfo
.
hash_vîsi⁄
);

771 
Áû
;

773 i‡(
‚ame
)

774 
höfo
 = &
‚ame
->hinfo;

775 
höfo
->
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

776 i‡(
höfo
->
hash_vîsi⁄
 <
DX_HASH_TEA
)

777 
höfo
->
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

778 
höfo
->
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

779 i‡(
‚ame
 && 
	`‚ame_«me
(fname))

780 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), 
höfo
);

781 
hash
 = 
höfo
->hash;

783 i‡(
roŸ
->
öfo
.
unu£d_Êags
 & 1) {

784 
	`pxt4_w¨nög_öode
(
dú
, "Unimplemented hash flags: %#06x",

785 
roŸ
->
öfo
.
unu£d_Êags
);

786 
Áû
;

789 
ödúe˘
 = 
roŸ
->
öfo
.
ödúe˘_Àvñs
;

790 i‡(
ödúe˘
 >
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
)) {

791 
	`pxt4_w¨nög
(
dú
->
i_sb
,

793 "suµ‹ãd vÆue", 
dú
->
i_öo
,

794 
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
));

795 i‡(
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
Ë< 
PXT4_HTREE_LEVEL
) {

796 
	`pxt4_w¨nög
(
dú
->
i_sb
, "EnableÜarge directory "

799 
Áû
;

802 
íåõs
 = (
dx_íåy
 *)(((*)&
roŸ
->
öfo
) +

803 
roŸ
->
öfo
.
öfo_Àngth
);

805 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_roŸ_limô
(
dú
,

806 
roŸ
->
öfo
.
öfo_Àngth
)) {

807 
	`pxt4_w¨nög_öode
(
dú
, "dxÉntry:Üimit %u !=ÑootÜimit %u",

808 
	`dx_gë_limô
(
íåõs
),

809 
	`dx_roŸ_limô
(
dú
, 
roŸ
->
öfo
.
öfo_Àngth
));

810 
Áû
;

813 
	`dxåa˚
(
	`¥ötk
("Look u∞%x", 
hash
));

815 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

816 i‡(!
cou¡
 || cou¡ > 
	`dx_gë_limô
(
íåõs
)) {

817 
	`pxt4_w¨nög_öode
(
dú
,

819 
cou¡
, 
	`dx_gë_limô
(
íåõs
));

820 
Áû
;

823 
p
 = 
íåõs
 + 1;

824 
q
 = 
íåõs
 + 
cou¡
 - 1;

825 
p
 <
q
) {

826 
m
 = 
p
 + (
q
 -Ö) / 2;

827 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 "."));

828 i‡(
	`dx_gë_hash
(
m
Ë> 
hash
)

829 
q
 = 
m
 - 1;

831 
p
 = 
m
 + 1;

835 
n
 = 
cou¡
 - 1;

836 
©
 = 
íåõs
;

837 
n
--)

839 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 ","));

840 i‡(
	`dx_gë_hash
(++
©
Ë> 
hash
)

842 
©
--;

846 
	`as£π
 (
©
 =
p
 - 1);

849 
©
 = 
p
 - 1;

850 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 " %x->%u\n",

851 
©
 =
íåõs
 ? 0 : 
	`dx_gë_hash
(at),

852 
	`dx_gë_block
(
©
)));

853 
‰ame
->
íåõs
 =Éntries;

854 
‰ame
->
©
 =át;

855 i‡(!
ödúe˘
--)

856  
‰ame
;

857 
‰ame
++;

858 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
©
), 
INDEX
);

859 i‡(
	`IS_ERR
(
‰ame
->
bh
)) {

860 
ªt_îr
 = (
dx_‰ame
 *Ë
‰ame
->
bh
;

861 
‰ame
->
bh
 = 
NULL
;

862 
Áû
;

864 
íåõs
 = ((
dx_node
 *Ë
‰ame
->
bh
->
b_d©a
)->entries;

866 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_node_limô
(
dú
)) {

867 
	`pxt4_w¨nög_öode
(
dú
,

869 
	`dx_gë_limô
(
íåõs
), 
	`dx_node_limô
(
dú
));

870 
Áû
;

873 
Áû
:

874 
‰ame
 >
‰ame_ö
) {

875 
	`bªl£
(
‰ame
->
bh
);

876 
‰ame
--;

879 i‡(
ªt_îr
 =
	`ERR_PTR
(
ERR_BAD_DX_DIR
))

880 
	`pxt4_w¨nög_öode
(
dú
,

882  
ªt_îr
;

883 
	}
}

885 
	$dx_ªÀa£
(
dx_‰ame
 *
‰ames
)

887 
dx_roŸ_öfo
 *
öfo
;

888 
i
;

889 
ödúe˘_Àvñs
;

891 i‡(
‰ames
[0].
bh
 =
NULL
)

894 
öfo
 = &((
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
)->info;

896 
ödúe˘_Àvñs
 = 
öfo
->indirect_levels;

897 
i
 = 0; i <
ödúe˘_Àvñs
; i++) {

898 i‡(
‰ames
[
i
].
bh
 =
NULL
)

900 
	`bªl£
(
‰ames
[
i
].
bh
);

901 
‰ames
[
i
].
bh
 = 
NULL
;

903 
	}
}

922 
	$pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

923 
dx_‰ame
 *
‰ame
,

924 
dx_‰ame
 *
‰ames
,

925 
__u32
 *
°¨t_hash
)

927 
dx_‰ame
 *
p
;

928 
buf„r_hód
 *
bh
;

929 
num_‰ames
 = 0;

930 
__u32
 
bhash
;

932 
p
 = 
‰ame
;

941 i‡(++(
p
->
©
Ë<Ö->
íåõs
 + 
	`dx_gë_cou¡
(p->entries))

943 i‡(
p
 =
‰ames
)

945 
num_‰ames
++;

946 
p
--;

956 
bhash
 = 
	`dx_gë_hash
(
p
->
©
);

957 i‡(
°¨t_hash
)

958 *
°¨t_hash
 = 
bhash
;

959 i‡((
hash
 & 1) == 0) {

960 i‡((
bhash
 & ~1Ë!
hash
)

967 
num_‰ames
--) {

968 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
p
->
©
), 
INDEX
);

969 i‡(
	`IS_ERR
(
bh
))

970  
	`PTR_ERR
(
bh
);

971 
p
++;

972 
	`bªl£
(
p
->
bh
);

973 
p
->
bh
 = bh;

974 
p
->
©
 =Ö->
íåõs
 = ((
dx_node
 *Ë
bh
->
b_d©a
)->entries;

977 
	}
}

985 
	$håì_dúblock_to_åì
(
fûe
 *
dú_fûe
,

986 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

987 
dx_hash_öfo
 *
höfo
,

988 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
)

990 
buf„r_hód
 *
bh
;

991 
pxt4_dú_íåy_2
 *
de
, *
t›
;

992 
îr
 = 0, 
cou¡
 = 0;

993 
fs¸y±_°r
 
‚ame_¸y±o_°r
 = 
	`FSTR_INIT
(
NULL
, 0), 
tmp_°r
;

995 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "In htree dirblock_to_tree: block %lu\n",

996 ()
block
));

997 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

998 i‡(
	`IS_ERR
(
bh
))

999  
	`PTR_ERR
(
bh
);

1001 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

1002 
t›
 = (
pxt4_dú_íåy_2
 *Ë((*Ë
de
 +

1003 
dú
->
i_sb
->
s_blocksize
 -

1004 
	`PXT4_DIR_REC_LEN
(0));

1005 #ifde‡
CONFIG_FS_ENCRYPTION


1007 i‡(
	`IS_ENCRYPTED
(
dú
)) {

1008 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

1009 i‡(
îr
 < 0) {

1010 
	`bªl£
(
bh
);

1011  
îr
;

1013 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
dú
, 
PXT4_NAME_LEN
,

1014 &
‚ame_¸y±o_°r
);

1015 i‡(
îr
 < 0) {

1016 
	`bªl£
(
bh
);

1017  
îr
;

1021 ; 
de
 < 
t›
; dê
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
)) {

1022 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1023 
bh
->
b_d©a
, bh->
b_size
,

1024 (
block
<<
	`PXT4_BLOCK_SIZE_BITS
(
dú
->
i_sb
))

1025 + ((*)
de
 - 
bh
->
b_d©a
))) {

1029 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1030 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1031 ((
höfo
->
hash
 =
°¨t_hash
) &&

1032 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1034 i‡(
de
->
öode
 == 0)

1036 i‡(!
	`IS_ENCRYPTED
(
dú
)) {

1037 
tmp_°r
.
«me
 = 
de
->name;

1038 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1039 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1040 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1041 &
tmp_°r
);

1043 
ßve_Àn
 = 
‚ame_¸y±o_°r
.
Àn
;

1044 
fs¸y±_°r
 
de_«me
 = 
	`FSTR_INIT
(
de
->
«me
,

1045 
de
->
«me_Àn
);

1048 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
, 
höfo
->
hash
,

1049 
höfo
->
mö‹_hash
, &
de_«me
,

1050 &
‚ame_¸y±o_°r
);

1051 i‡(
îr
) {

1052 
cou¡
 = 
îr
;

1053 
îrout
;

1055 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1056 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1057 &
‚ame_¸y±o_°r
);

1058 
‚ame_¸y±o_°r
.
Àn
 = 
ßve_Àn
;

1060 i‡(
îr
 != 0) {

1061 
cou¡
 = 
îr
;

1062 
îrout
;

1064 
cou¡
++;

1066 
îrout
:

1067 
	`bªl£
(
bh
);

1068 #ifde‡
CONFIG_FS_ENCRYPTION


1069 
	`fs¸y±_‚ame_‰ì_buf„r
(&
‚ame_¸y±o_°r
);

1071  
cou¡
;

1072 
	}
}

1083 
	$pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

1084 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
)

1086 
dx_hash_öfo
 
höfo
;

1087 
pxt4_dú_íåy_2
 *
de
;

1088 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1089 
öode
 *
dú
;

1090 
pxt4_lblk_t
 
block
;

1091 
cou¡
 = 0;

1092 
ªt
, 
îr
;

1093 
__u32
 
hashvÆ
;

1094 
fs¸y±_°r
 
tmp_°r
;

1096 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "In htree_fill_tree, start hash: %x:%x\n",

1097 
°¨t_hash
, 
°¨t_mö‹_hash
));

1098 
dú
 = 
	`fûe_öode
(
dú_fûe
);

1099 i‡(!(
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
))) {

1100 
höfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

1101 i‡(
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

1102 
höfo
.
hash_vîsi⁄
 +=

1103 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

1104 
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

1105 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1106 
has_ölöe_d©a
 = 1;

1107 
cou¡
 = 
	`pxt4_ölöedú_to_åì
(
dú_fûe
, 
dú
, 0,

1108 &
höfo
, 
°¨t_hash
,

1109 
°¨t_mö‹_hash
,

1110 &
has_ölöe_d©a
);

1111 i‡(
has_ölöe_d©a
) {

1112 *
√xt_hash
 = ~0;

1113  
cou¡
;

1116 
cou¡
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 0, &
höfo
,

1117 
°¨t_hash
, 
°¨t_mö‹_hash
);

1118 *
√xt_hash
 = ~0;

1119  
cou¡
;

1121 
höfo
.
hash
 = 
°¨t_hash
;

1122 
höfo
.
mö‹_hash
 = 0;

1123 
‰ame
 = 
	`dx_¥obe
(
NULL
, 
dú
, &
höfo
, 
‰ames
);

1124 i‡(
	`IS_ERR
(
‰ame
))

1125  
	`PTR_ERR
(
‰ame
);

1128 i‡(!
°¨t_hash
 && !
°¨t_mö‹_hash
) {

1129 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1130 
tmp_°r
.
«me
 = 
de
->name;

1131 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1132 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 0, 0,

1133 
de
, &
tmp_°r
);

1134 i‡(
îr
 != 0)

1135 
îrout
;

1136 
cou¡
++;

1138 i‡(
°¨t_hash
 < 2 || (°¨t_hash ==2 && 
°¨t_mö‹_hash
==0)) {

1139 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1140 
de
 = 
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
);

1141 
tmp_°r
.
«me
 = 
de
->name;

1142 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1143 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 2, 0,

1144 
de
, &
tmp_°r
);

1145 i‡(
îr
 != 0)

1146 
îrout
;

1147 
cou¡
++;

1151 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

1152 
îr
 = -
ERESTARTSYS
;

1153 
îrout
;

1155 
	`c⁄d_ªsched
();

1156 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1157 
ªt
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 
block
, &
höfo
,

1158 
°¨t_hash
, 
°¨t_mö‹_hash
);

1159 i‡(
ªt
 < 0) {

1160 
îr
 = 
ªt
;

1161 
îrout
;

1163 
cou¡
 +
ªt
;

1164 
hashvÆ
 = ~0;

1165 
ªt
 = 
	`pxt4_håì_√xt_block
(
dú
, 
HASH_NB_ALWAYS
,

1166 
‰ame
, 
‰ames
, &
hashvÆ
);

1167 *
√xt_hash
 = 
hashvÆ
;

1168 i‡(
ªt
 < 0) {

1169 
îr
 = 
ªt
;

1170 
îrout
;

1177 i‡((
ªt
 == 0) ||

1178 (
cou¡
 && ((
hashvÆ
 & 1) == 0)))

1181 
	`dx_ªÀa£
(
‰ames
);

1182 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "FillÅree:Ñeturned %dÉntries, "

1183 "√xàhash: %x\n", 
cou¡
, *
√xt_hash
));

1184  
cou¡
;

1185 
îrout
:

1186 
	`dx_ªÀa£
(
‰ames
);

1187  (
îr
);

1188 
	}
}

1190 
ölöe
 
	$£¨ch_dúblock
(
buf„r_hód
 *
bh
,

1191 
öode
 *
dú
,

1192 
pxt4_fûíame
 *
‚ame
,

1193 
off£t
,

1194 
pxt4_dú_íåy_2
 **
ªs_dú
)

1196  
	`pxt4_£¨ch_dú
(
bh
, bh->
b_d©a
, 
dú
->
i_sb
->
s_blocksize
, dir,

1197 
‚ame
, 
off£t
, 
ªs_dú
);

1198 
	}
}

1208 
	$dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

1209 
blocksize
, 
dx_hash_öfo
 *
höfo
,

1210 
dx_m≠_íåy
 *
m≠_èû
)

1212 
cou¡
 = 0;

1213 *
ba£
 = (*Ë
de
;

1214 
dx_hash_öfo
 
h
 = *
höfo
;

1216 (*Ë
de
 < 
ba£
 + 
blocksize
) {

1217 i‡(
de
->
«me_Àn
 && de->
öode
) {

1218 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

1219 
m≠_èû
--;

1220 
m≠_èû
->
hash
 = 
h
.hash;

1221 
m≠_èû
->
offs
 = ((*Ë
de
 - 
ba£
)>>2;

1222 
m≠_èû
->
size
 = 
	`À16_to_˝u
(
de
->
ªc_Àn
);

1223 
cou¡
++;

1224 
	`c⁄d_ªsched
();

1227 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

1229  
cou¡
;

1230 
	}
}

1233 
	$dx_s‹t_m≠
 (
dx_m≠_íåy
 *
m≠
, 
cou¡
)

1235 
dx_m≠_íåy
 *
p
, *
q
, *
t›
 = 
m≠
 + 
cou¡
 - 1;

1236 
m‹e
;

1238 
cou¡
 > 2) {

1239 
cou¡
 = count*10/13;

1240 i‡(
cou¡
 - 9 < 2)

1241 
cou¡
 = 11;

1242 
p
 = 
t›
, 
q
 =Ö - 
cou¡
; q >
m≠
;Ö--, q--)

1243 i‡(
p
->
hash
 < 
q
->hash)

1244 
	`sw≠
(*
p
, *
q
);

1248 
m‹e
 = 0;

1249 
q
 = 
t›
;

1250 
q
-- > 
m≠
) {

1251 i‡(
q
[1].
hash
 >= q[0].hash)

1253 
	`sw≠
(*(
q
+1), *q);

1254 
m‹e
 = 1;

1256 } 
m‹e
);

1257 
	}
}

1259 
	$dx_ö£π_block
(
dx_‰ame
 *
‰ame
, 
u32
 
hash
, 
pxt4_lblk_t
 
block
)

1261 
dx_íåy
 *
íåõs
 = 
‰ame
->entries;

1262 
dx_íåy
 *
ﬁd
 = 
‰ame
->
©
, *
√w
 = old + 1;

1263 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

1265 
	`as£π
(
cou¡
 < 
	`dx_gë_limô
(
íåõs
));

1266 
	`as£π
(
ﬁd
 < 
íåõs
 + 
cou¡
);

1267 
	`memmove
(
√w
 + 1,Çew, (*)(
íåõs
 + 
cou¡
) - (*)(new));

1268 
	`dx_£t_hash
(
√w
, 
hash
);

1269 
	`dx_£t_block
(
√w
, 
block
);

1270 
	`dx_£t_cou¡
(
íåõs
, 
cou¡
 + 1);

1271 
	}
}

1273 #ifde‡
CONFIG_UNICODE


1282 
	$pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
, c⁄° 
q°r
 *
«me
,

1283 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
)

1285 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
∑ª¡
->
i_sb
);

1286 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

1287 
ªt
;

1289 i‡(
quick
)

1290 
ªt
 = 
	`utf8_°∫ˇ£cmp_fﬁded
(
um
, 
«me
, 
íåy
);

1292 
ªt
 = 
	`utf8_°∫ˇ£cmp
(
um
, 
«me
, 
íåy
);

1294 i‡(
ªt
 < 0) {

1298 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

1299  -
EINVAL
;

1301 i‡(
«me
->
Àn
 !
íåy
->len)

1304  !!
	`memcmp
(
«me
->«me, 
íåy
->«me,Çame->
Àn
);

1307  
ªt
;

1308 
	}
}

1310 
	$pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
, c⁄° 
q°r
 *
öame
,

1311 
fs¸y±_°r
 *
cf_«me
)

1313 
Àn
;

1315 i‡(!
	`IS_CASEFOLDED
(
dú
Ë|| !
	`PXT4_SB
(dú->
i_sb
)->
s_ícodög
) {

1316 
cf_«me
->
«me
 = 
NULL
;

1320 
cf_«me
->
«me
 = 
	`kmÆloc
(
PXT4_NAME_LEN
, 
GFP_NOFS
);

1321 i‡(!
cf_«me
->
«me
)

1324 
Àn
 = 
	`utf8_ˇ£fﬁd
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
,

1325 
öame
, 
cf_«me
->
«me
,

1326 
PXT4_NAME_LEN
);

1327 i‡(
Àn
 <= 0) {

1328 
	`k‰ì
(
cf_«me
->
«me
);

1329 
cf_«me
->
«me
 = 
NULL
;

1332 
cf_«me
->
Àn
 = ()Üen;

1334 
	}
}

1342 
ölöe
 
boﬁ
 
	$pxt4_m©ch
(c⁄° 
öode
 *
∑ª¡
,

1343 c⁄° 
pxt4_fûíame
 *
‚ame
,

1344 c⁄° 
pxt4_dú_íåy_2
 *
de
)

1346 
fs¸y±_«me
 
f
;

1347 #ifde‡
CONFIG_UNICODE


1348 c⁄° 
q°r
 
íåy
 = {.
«me
 = 
de
->«me, .
Àn
 = de->
«me_Àn
};

1351 i‡(!
de
->
öode
)

1352  
Ál£
;

1354 
f
.
u§_‚ame
 = 
‚ame
->usr_fname;

1355 
f
.
disk_«me
 = 
‚ame
->disk_name;

1356 #ifde‡
CONFIG_FS_ENCRYPTION


1357 
f
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

1360 #ifde‡
CONFIG_UNICODE


1361 i‡(
	`PXT4_SB
(
∑ª¡
->
i_sb
)->
s_ícodög
 && 
	`IS_CASEFOLDED
(parent)) {

1362 i‡(
‚ame
->
cf_«me
.
«me
) {

1363 
q°r
 
cf
 = {.
«me
 = 
‚ame
->
cf_«me
.name,

1364 .
Àn
 = 
‚ame
->
cf_«me
.len};

1365  !
	`pxt4_ci_com∑ª
(
∑ª¡
, &
cf
, &
íåy
, 
åue
);

1367  !
	`pxt4_ci_com∑ª
(
∑ª¡
, 
‚ame
->
u§_‚ame
, &
íåy
,

1368 
Ál£
);

1372  
	`fs¸y±_m©ch_«me
(&
f
, 
de
->
«me
, de->
«me_Àn
);

1373 
	}
}

1378 
	$pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
, *
£¨ch_buf
, 
buf_size
,

1379 
öode
 *
dú
, 
pxt4_fûíame
 *
‚ame
,

1380 
off£t
, 
pxt4_dú_íåy_2
 **
ªs_dú
)

1382 
pxt4_dú_íåy_2
 * 
de
;

1383 * 
dlimô
;

1384 
de_Àn
;

1386 
de
 = (
pxt4_dú_íåy_2
 *)
£¨ch_buf
;

1387 
dlimô
 = 
£¨ch_buf
 + 
buf_size
;

1388 (*Ë
de
 < 
dlimô
) {

1391 i‡((*Ë
de
 + de->
«me_Àn
 <
dlimô
 &&

1392 
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
)) {

1395 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
, 
£¨ch_buf
,

1396 
buf_size
, 
off£t
))

1398 *
ªs_dú
 = 
de
;

1402 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1403 
dú
->
i_sb
->
s_blocksize
);

1404 i‡(
de_Àn
 <= 0)

1406 
off£t
 +
de_Àn
;

1407 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1410 
	}
}

1412 
	$is_dx_öã∫Æ_node
(
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1413 
pxt4_dú_íåy
 *
de
)

1415 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1417 i‡(!
	`is_dx
(
dú
))

1419 i‡(
block
 == 0)

1421 i‡(
de
->
öode
 == 0 &&

1422 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
) ==

1423 
sb
->
s_blocksize
)

1426 
	}
}

1439 
buf„r_hód
 *
	$__pxt4_föd_íåy
(
öode
 *
dú
,

1440 
pxt4_fûíame
 *
‚ame
,

1441 
pxt4_dú_íåy_2
 **
ªs_dú
,

1442 *
ölöed
)

1444 
su≥r_block
 *
sb
;

1445 
buf„r_hód
 *
bh_u£
[
NAMEI_RA_SIZE
];

1446 
buf„r_hód
 *
bh
, *
ªt
 = 
NULL
;

1447 
pxt4_lblk_t
 
°¨t
, 
block
;

1448 c⁄° 
u8
 *
«me
 = 
‚ame
->
u§_‚ame
->name;

1449 
size_t
 
ø_max
 = 0;

1451 
size_t
 
ø_±r
 = 0;

1453 
pxt4_lblk_t
 
nblocks
;

1454 
i
, 
«mñí
, 
ªtvÆ
;

1456 *
ªs_dú
 = 
NULL
;

1457 
sb
 = 
dú
->
i_sb
;

1458 
«mñí
 = 
‚ame
->
u§_‚ame
->
Àn
;

1459 i‡(
«mñí
 > 
PXT4_NAME_LEN
)

1460  
NULL
;

1462 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1463 
has_ölöe_d©a
 = 1;

1464 
ªt
 = 
	`pxt4_föd_ölöe_íåy
(
dú
, 
‚ame
, 
ªs_dú
,

1465 &
has_ölöe_d©a
);

1466 i‡(
has_ölöe_d©a
) {

1467 i‡(
ölöed
)

1468 *
ölöed
 = 1;

1469 
˛ónup_™d_exô
;

1473 i‡((
«mñí
 <2Ë&& (
«me
[0] == '.') &&

1474 (
«me
[1] == '.' ||Çame[1] == '\0')) {

1479 
block
 = 
°¨t
 = 0;

1480 
nblocks
 = 1;

1481 
ª°¨t
;

1483 i‡(
	`is_dx
(
dú
)) {

1484 
ªt
 = 
	`pxt4_dx_föd_íåy
(
dú
, 
‚ame
, 
ªs_dú
);

1490 i‡(!
	`IS_ERR
(
ªt
Ë|| 
	`PTR_ERR
‘ëË!
ERR_BAD_DX_DIR
)

1491 
˛ónup_™d_exô
;

1492 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "pxt4_find_entry: dx failed, "

1494 
ªt
 = 
NULL
;

1496 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1497 i‡(!
nblocks
) {

1498 
ªt
 = 
NULL
;

1499 
˛ónup_™d_exô
;

1501 
°¨t
 = 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
;

1502 i‡(
°¨t
 >
nblocks
)

1503 
°¨t
 = 0;

1504 
block
 = 
°¨t
;

1505 
ª°¨t
:

1510 
	`c⁄d_ªsched
();

1511 i‡(
ø_±r
 >
ø_max
) {

1513 
ø_±r
 = 0;

1514 i‡(
block
 < 
°¨t
)

1515 
ø_max
 = 
°¨t
 - 
block
;

1517 
ø_max
 = 
nblocks
 - 
block
;

1518 
ø_max
 = 
	`mö
‘a_max, 
	`ARRAY_SIZE
(
bh_u£
));

1519 
ªtvÆ
 = 
	`pxt4_bªad_b©ch
(
dú
, 
block
, 
ø_max
,

1520 
Ál£
 , 
bh_u£
);

1521 i‡(
ªtvÆ
) {

1522 
ªt
 = 
	`ERR_PTR
(
ªtvÆ
);

1523 
ø_max
 = 0;

1524 
˛ónup_™d_exô
;

1527 i‡((
bh
 = 
bh_u£
[
ø_±r
++]Ë=
NULL
)

1528 
√xt
;

1529 
	`waô_⁄_buf„r
(
bh
);

1530 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1531 
	`PXT4_ERROR_INODE
(
dú
, "reading directoryÜblock %lu",

1532 (Ë
block
);

1533 
	`bªl£
(
bh
);

1534 
ªt
 = 
	`ERR_PTR
(-
EIO
);

1535 
˛ónup_™d_exô
;

1537 i‡(!
	`buf„r_vîifõd
(
bh
) &&

1538 !
	`is_dx_öã∫Æ_node
(
dú
, 
block
,

1539 (
pxt4_dú_íåy
 *)
bh
->
b_d©a
) &&

1540 !
	`pxt4_dúblock_csum_vîify
(
dú
, 
bh
)) {

1541 
	`PXT4_ERROR_INODE
(
dú
, "checksumming directory "

1542 "block %lu", ()
block
);

1543 
	`bªl£
(
bh
);

1544 
ªt
 = 
	`ERR_PTR
(-
EFSBADCRC
);

1545 
˛ónup_™d_exô
;

1547 
	`£t_buf„r_vîifõd
(
bh
);

1548 
i
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1549 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
), 
ªs_dú
);

1550 i‡(
i
 == 1) {

1551 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
 = 
block
;

1552 
ªt
 = 
bh
;

1553 
˛ónup_™d_exô
;

1555 
	`bªl£
(
bh
);

1556 i‡(
i
 < 0)

1557 
˛ónup_™d_exô
;

1559 
√xt
:

1560 i‡(++
block
 >
nblocks
)

1561 
block
 = 0;

1562 } 
block
 !
°¨t
);

1568 
block
 = 
nblocks
;

1569 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1570 i‡(
block
 < 
nblocks
) {

1571 
°¨t
 = 0;

1572 
ª°¨t
;

1575 
˛ónup_™d_exô
:

1577 ; 
ø_±r
 < 
ø_max
;Ña_ptr++)

1578 
	`bªl£
(
bh_u£
[
ø_±r
]);

1579  
ªt
;

1580 
	}
}

1582 
buf„r_hód
 *
	$pxt4_föd_íåy
(
öode
 *
dú
,

1583 c⁄° 
q°r
 *
d_«me
,

1584 
pxt4_dú_íåy_2
 **
ªs_dú
,

1585 *
ölöed
)

1587 
îr
;

1588 
pxt4_fûíame
 
‚ame
;

1589 
buf„r_hód
 *
bh
;

1591 
îr
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, 
d_«me
, 1, &
‚ame
);

1592 i‡(
îr
 =-
ENOENT
)

1593  
NULL
;

1594 i‡(
îr
)

1595  
	`ERR_PTR
(
îr
);

1597 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
ölöed
);

1599 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1600  
bh
;

1601 
	}
}

1603 
buf„r_hód
 *
	$pxt4_lookup_íåy
(
öode
 *
dú
,

1604 
díåy
 *dentry,

1605 
pxt4_dú_íåy_2
 **
ªs_dú
)

1607 
îr
;

1608 
pxt4_fûíame
 
‚ame
;

1609 
buf„r_hód
 *
bh
;

1611 
îr
 = 
	`pxt4_‚ame_¥ï¨e_lookup
(
dú
, 
díåy
, &
‚ame
);

1612 i‡(
îr
 =-
ENOENT
)

1613  
NULL
;

1614 i‡(
îr
)

1615  
	`ERR_PTR
(
îr
);

1617 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
NULL
);

1619 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1620  
bh
;

1621 
	}
}

1623 
buf„r_hód
 * 
	$pxt4_dx_föd_íåy
(
öode
 *
dú
,

1624 
pxt4_fûíame
 *
‚ame
,

1625 
pxt4_dú_íåy_2
 **
ªs_dú
)

1627 
su≥r_block
 * 
sb
 = 
dú
->
i_sb
;

1628 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1629 
buf„r_hód
 *
bh
;

1630 
pxt4_lblk_t
 
block
;

1631 
ªtvÆ
;

1633 #ifde‡
CONFIG_FS_ENCRYPTION


1634 *
ªs_dú
 = 
NULL
;

1636 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

1637 i‡(
	`IS_ERR
(
‰ame
))

1638  (
buf„r_hód
 *Ë
‰ame
;

1640 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1641 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

1642 i‡(
	`IS_ERR
(
bh
))

1643 
îrout
;

1645 
ªtvÆ
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1646 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
),

1647 
ªs_dú
);

1648 i‡(
ªtvÆ
 == 1)

1649 
suc˚ss
;

1650 
	`bªl£
(
bh
);

1651 i‡(
ªtvÆ
 == -1) {

1652 
bh
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

1653 
îrout
;

1657 
ªtvÆ
 = 
	`pxt4_håì_√xt_block
(
dú
, 
‚ame
->
höfo
.
hash
, 
‰ame
,

1658 
‰ames
, 
NULL
);

1659 i‡(
ªtvÆ
 < 0) {

1660 
	`pxt4_w¨nög_öode
(
dú
,

1662 
ªtvÆ
);

1663 
bh
 = 
	`ERR_PTR
(
ªtvÆ
);

1664 
îrout
;

1666 } 
ªtvÆ
 == 1);

1668 
bh
 = 
NULL
;

1669 
îrout
:

1670 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "%†nŸ found\n", 
‚ame
->
u§_‚ame
->
«me
));

1671 
suc˚ss
:

1672 
	`dx_ªÀa£
(
‰ames
);

1673  
bh
;

1674 
	}
}

1676 
díåy
 *
	$pxt4_lookup
(
öode
 *
dú
, 
díåy
 *díåy, 
Êags
)

1678 
öode
 *inode;

1679 
pxt4_dú_íåy_2
 *
de
;

1680 
buf„r_hód
 *
bh
;

1682 i‡(
díåy
->
d_«me
.
Àn
 > 
PXT4_NAME_LEN
)

1683  
	`ERR_PTR
(-
ENAMETOOLONG
);

1685 
bh
 = 
	`pxt4_lookup_íåy
(
dú
, 
díåy
, &
de
);

1686 i‡(
	`IS_ERR
(
bh
))

1687  
	`ERR_CAST
(
bh
);

1688 
öode
 = 
NULL
;

1689 i‡(
bh
) {

1690 
__u32
 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1691 
	`bªl£
(
bh
);

1692 i‡(!
	`pxt4_vÆid_öum
(
dú
->
i_sb
, 
öo
)) {

1693 
	`PXT4_ERROR_INODE
(
dú
, "bad inodênumbî: %u", 
öo
);

1694  
	`ERR_PTR
(-
EFSCORRUPTED
);

1696 i‡(
	`u∆ikñy
(
öo
 =
dú
->
i_öo
)) {

1697 
	`PXT4_ERROR_INODE
(
dú
, "'%pd'ÜinkedÅoÖarent dir",

1698 
díåy
);

1699  
	`ERR_PTR
(-
EFSCORRUPTED
);

1701 
öode
 = 
	`pxt4_igë
(
dú
->
i_sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1702 i‡(
öode
 =
	`ERR_PTR
(-
ESTALE
)) {

1703 
	`PXT4_ERROR_INODE
(
dú
,

1705 
öo
);

1706  
	`ERR_PTR
(-
EFSCORRUPTED
);

1708 i‡(!
	`IS_ERR
(
öode
Ë&& 
	`IS_ENCRYPTED
(
dú
) &&

1709 (
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) &&

1710 !
	`fs¸y±_has_≥rmôãd_c⁄ãxt
(
dú
, 
öode
)) {

1711 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1713 
dú
->
i_öo
, 
öode
->i_ino);

1714 
	`ùut
(
öode
);

1715  
	`ERR_PTR
(-
EPERM
);

1719 #ifde‡
CONFIG_UNICODE


1720 i‡(!
öode
 && 
	`IS_CASEFOLDED
(
dú
)) {

1726  
NULL
;

1729  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

1730 
	}
}

1733 
díåy
 *
	$pxt4_gë_∑ª¡
(
díåy
 *
chûd
)

1735 
__u32
 
öo
;

1736 c⁄° 
q°r
 
dŸdŸ
 = 
	`QSTR_INIT
("..", 2);

1737 
pxt4_dú_íåy_2
 * 
de
;

1738 
buf„r_hód
 *
bh
;

1740 
bh
 = 
	`pxt4_föd_íåy
(
	`d_öode
(
chûd
), &
dŸdŸ
, &
de
, 
NULL
);

1741 i‡(
	`IS_ERR
(
bh
))

1742  
	`ERR_CAST
(
bh
);

1743 i‡(!
bh
)

1744  
	`ERR_PTR
(-
ENOENT
);

1745 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1746 
	`bªl£
(
bh
);

1748 i‡(!
	`pxt4_vÆid_öum
(
chûd
->
d_sb
, 
öo
)) {

1749 
	`PXT4_ERROR_INODE
(
	`d_öode
(
chûd
),

1750 "badÖ¨íàöodênumbî: %u", 
öo
);

1751  
	`ERR_PTR
(-
EFSCORRUPTED
);

1754  
	`d_obèö_Æüs
(
	`pxt4_igë
(
chûd
->
d_sb
, 
öo
, 
PXT4_IGET_NORMAL
));

1755 
	}
}

1761 
pxt4_dú_íåy_2
 *

1762 
	$dx_move_dúíts
(*
‰om
, *
to
, 
dx_m≠_íåy
 *
m≠
, 
cou¡
,

1763 
blocksize
)

1765 
ªc_Àn
 = 0;

1767 
cou¡
--) {

1768 
pxt4_dú_íåy_2
 *
de
 = (pxt4_dir_entry_2 *)

1769 (
‰om
 + (
m≠
->
offs
<<2));

1770 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1771 
	`mem˝y
 (
to
, 
de
, 
ªc_Àn
);

1772 ((
pxt4_dú_íåy_2
 *Ë
to
)->
ªc_Àn
 =

1773 
	`pxt4_ªc_Àn_to_disk
(
ªc_Àn
, 
blocksize
);

1774 
de
->
öode
 = 0;

1775 
m≠
++;

1776 
to
 +
ªc_Àn
;

1778  (
pxt4_dú_íåy_2
 *Ë(
to
 - 
ªc_Àn
);

1779 
	}
}

1785 
pxt4_dú_íåy_2
* 
	$dx_∑ck_dúíts
(*
ba£
, 
blocksize
)

1787 
pxt4_dú_íåy_2
 *
√xt
, *
to
, *
¥ev
, *
de
 = (pxt4_dú_íåy_2 *Ë
ba£
;

1788 
ªc_Àn
 = 0;

1790 
¥ev
 = 
to
 = 
de
;

1791 (*)
de
 < 
ba£
 + 
blocksize
) {

1792 
√xt
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

1793 i‡(
de
->
öode
 && de->
«me_Àn
) {

1794 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1795 i‡(
de
 > 
to
)

1796 
	`memmove
(
to
, 
de
, 
ªc_Àn
);

1797 
to
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
‘ec_Àn, 
blocksize
);

1798 
¥ev
 = 
to
;

1799 
to
 = (
pxt4_dú_íåy_2
 *Ë(((*ËtoË+ 
ªc_Àn
);

1801 
de
 = 
√xt
;

1803  
¥ev
;

1804 
	}
}

1811 
pxt4_dú_íåy_2
 *
	$do_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1812 
buf„r_hód
 **
bh
,
dx_‰ame
 *
‰ame
,

1813 
dx_hash_öfo
 *
höfo
)

1815 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1816 
cou¡
, 
c⁄töued
;

1817 
buf„r_hód
 *
bh2
;

1818 
pxt4_lblk_t
 
√wblock
;

1819 
u32
 
hash2
;

1820 
dx_m≠_íåy
 *
m≠
;

1821 *
d©a1
 = (*
bh
)->
b_d©a
, *
d©a2
;

1822 
•lô
, 
move
, 
size
;

1823 
pxt4_dú_íåy_2
 *
de
 = 
NULL
, *
de2
;

1824 
csum_size
 = 0;

1825 
îr
 = 0, 
i
;

1827 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

1828 
csum_size
 = (
pxt4_dú_íåy_èû
);

1830 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

1831 i‡(
	`IS_ERR
(
bh2
)) {

1832 
	`bªl£
(*
bh
);

1833 *
bh
 = 
NULL
;

1834  (
pxt4_dú_íåy_2
 *Ë
bh2
;

1837 
	`BUFFER_TRACE
(*
bh
, "get_write_access");

1838 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, *
bh
);

1839 i‡(
îr
)

1840 
jou∫Æ_îr‹
;

1842 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

1843 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

1844 i‡(
îr
)

1845 
jou∫Æ_îr‹
;

1847 
d©a2
 = 
bh2
->
b_d©a
;

1850 
m≠
 = (
dx_m≠_íåy
 *Ë(
d©a2
 + 
blocksize
);

1851 
cou¡
 = 
	`dx_make_m≠
(
dú
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1852 
blocksize
, 
höfo
, 
m≠
);

1853 
m≠
 -
cou¡
;

1854 
	`dx_s‹t_m≠
(
m≠
, 
cou¡
);

1856 
size
 = 0;

1857 
move
 = 0;

1858 
i
 = 
cou¡
-1; i >= 0; i--) {

1860 i‡(
size
 + 
m≠
[
i
].size/2 > 
blocksize
/2)

1862 
size
 +
m≠
[
i
].size;

1863 
move
++;

1872 i‡(
i
 > 0)

1873 
•lô
 = 
cou¡
 - 
move
;

1875 
•lô
 = 
cou¡
/2;

1877 
hash2
 = 
m≠
[
•lô
].
hash
;

1878 
c⁄töued
 = 
hash2
 =
m≠
[
•lô
 - 1].
hash
;

1879 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "Split block %luát %x, %i/%i\n",

1880 ()
	`dx_gë_block
(
‰ame
->
©
),

1881 
hash2
, 
•lô
, 
cou¡
-split));

1884 
de2
 = 
	`dx_move_dúíts
(
d©a1
, 
d©a2
, 
m≠
 + 
•lô
, 
cou¡
 - split,

1885 
blocksize
);

1886 
de
 = 
	`dx_∑ck_dúíts
(
d©a1
, 
blocksize
);

1887 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1888 (*Ë
de
,

1889 
blocksize
);

1890 
de2
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

1891 (*Ë
de2
,

1892 
blocksize
);

1893 i‡(
csum_size
) {

1894 
	`pxt4_öôülize_dúít_èû
(*
bh
, 
blocksize
);

1895 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

1898 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1899 
blocksize
, 1));

1900 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a2
,

1901 
blocksize
, 1));

1904 i‡(
höfo
->
hash
 >
hash2
) {

1905 
	`sw≠
(*
bh
, 
bh2
);

1906 
de
 = 
de2
;

1908 
	`dx_ö£π_block
(
‰ame
, 
hash2
 + 
c⁄töued
, 
√wblock
);

1909 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

1910 i‡(
îr
)

1911 
jou∫Æ_îr‹
;

1912 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

1913 i‡(
îr
)

1914 
jou∫Æ_îr‹
;

1915 
	`bªl£
(
bh2
);

1916 
	`dxåa˚
(
	`dx_show_ödex
("‰ame", 
‰ame
->
íåõs
));

1917  
de
;

1919 
jou∫Æ_îr‹
:

1920 
	`bªl£
(*
bh
);

1921 
	`bªl£
(
bh2
);

1922 *
bh
 = 
NULL
;

1923 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1924  
	`ERR_PTR
(
îr
);

1925 
	}
}

1927 
	$pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

1928 
buf„r_hód
 *
bh
,

1929 *
buf
, 
buf_size
,

1930 
pxt4_fûíame
 *
‚ame
,

1931 
pxt4_dú_íåy_2
 **
de°_de
)

1933 
pxt4_dú_íåy_2
 *
de
;

1934 
ª˛í
 = 
	`PXT4_DIR_REC_LEN
(
	`‚ame_Àn
(
‚ame
));

1935 
∆í
, 
æí
;

1936 
off£t
 = 0;

1937 *
t›
;

1939 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

1940 
t›
 = 
buf
 + 
buf_size
 - 
ª˛í
;

1941 (*Ë
de
 <
t›
) {

1942 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1943 
buf
, 
buf_size
, 
off£t
))

1944  -
EFSCORRUPTED
;

1945 i‡(
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
))

1946  -
EEXIST
;

1947 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1948 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1949 i‡((
de
->
öode
 ? 
æí
 - 
∆í
 :ÑÀnË>
ª˛í
)

1951 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

1952 
off£t
 +
æí
;

1954 i‡((*Ë
de
 > 
t›
)

1955  -
ENOSPC
;

1957 *
de°_de
 = 
de
;

1959 
	}
}

1961 
	$pxt4_ö£π_díåy
(
öode
 *inode,

1962 
pxt4_dú_íåy_2
 *
de
,

1963 
buf_size
,

1964 
pxt4_fûíame
 *
‚ame
)

1967 
∆í
, 
æí
;

1969 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1970 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1971 i‡(
de
->
öode
) {

1972 
pxt4_dú_íåy_2
 *
de1
 =

1973 (
pxt4_dú_íåy_2
 *)((*)
de
 + 
∆í
);

1974 
de1
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
æí
 - 
∆í
, 
buf_size
);

1975 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
∆í
, 
buf_size
);

1976 
de
 = 
de1
;

1978 
de
->
fûe_ty≥
 = 
PXT4_FT_UNKNOWN
;

1979 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1980 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, inode->
i_mode
);

1981 
de
->
«me_Àn
 = 
	`‚ame_Àn
(
‚ame
);

1982 
	`mem˝y
(
de
->
«me
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(fname));

1983 
	}
}

1993 
	$add_dúít_to_buf
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1994 
öode
 *
dú
,

1995 
öode
 *öode, 
pxt4_dú_íåy_2
 *
de
,

1996 
buf„r_hód
 *
bh
)

1998 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1999 
csum_size
 = 0;

2000 
îr
;

2002 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2003 
csum_size
 = (
pxt4_dú_íåy_èû
);

2005 i‡(!
de
) {

2006 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
bh
, bh->
b_d©a
,

2007 
blocksize
 - 
csum_size
, 
‚ame
, &
de
);

2008 i‡(
îr
)

2009  
îr
;

2011 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2012 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2013 i‡(
îr
) {

2014 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2015  
îr
;

2019 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
blocksize
, 
‚ame
);

2032 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

2033 
	`pxt4_upd©e_dx_Êag
(
dú
);

2034 
	`öode_öc_ivîsi⁄
(
dú
);

2035 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2036 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2037 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2038 i‡(
îr
)

2039 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2041 
	}
}

2047 
	$make_ödexed_dú
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2048 
öode
 *
dú
,

2049 
öode
 *öode, 
buf„r_hód
 *
bh
)

2051 
buf„r_hód
 *
bh2
;

2052 
dx_roŸ
 *
roŸ
;

2053 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2054 
dx_íåy
 *
íåõs
;

2055 
pxt4_dú_íåy_2
 *
de
, *
de2
;

2056 *
d©a2
, *
t›
;

2057 
Àn
;

2058 
ªtvÆ
;

2059 
blocksize
;

2060 
pxt4_lblk_t
 
block
;

2061 
Áke_dúít
 *
fde
;

2062 
csum_size
 = 0;

2064 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2065 
csum_size
 = (
pxt4_dú_íåy_èû
);

2067 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2068 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Cª©ög index: inodê%lu\n", 
dú
->
i_öo
));

2069 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2070 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2071 i‡(
ªtvÆ
) {

2072 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
ªtvÆ
);

2073 
	`bªl£
(
bh
);

2074  
ªtvÆ
;

2076 
roŸ
 = (
dx_roŸ
 *Ë
bh
->
b_d©a
;

2079 
fde
 = &
roŸ
->
dŸdŸ
;

2080 
de
 = (
pxt4_dú_íåy_2
 *)((*)
fde
 +

2081 
	`pxt4_ªc_Àn_‰om_disk
(
fde
->
ªc_Àn
, 
blocksize
));

2082 i‡((*Ë
de
 >(((*Ë
roŸ
Ë+ 
blocksize
)) {

2083 
	`PXT4_ERROR_INODE
(
dú
, "invalidÑec_len for '..'");

2084 
	`bªl£
(
bh
);

2085  -
EFSCORRUPTED
;

2087 
Àn
 = ((*Ë
roŸ
Ë+ (
blocksize
 - 
csum_size
Ë- (*Ë
de
;

2090 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2091 i‡(
	`IS_ERR
(
bh2
)) {

2092 
	`bªl£
(
bh
);

2093  
	`PTR_ERR
(
bh2
);

2095 
	`pxt4_£t_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2096 
d©a2
 = 
bh2
->
b_d©a
;

2098 
	`mem˝y
(
d©a2
, 
de
, 
Àn
);

2099 
de
 = (
pxt4_dú_íåy_2
 *Ë
d©a2
;

2100 
t›
 = 
d©a2
 + 
Àn
;

2101 (*)(
de2
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
)Ë< 
t›
)

2102 
de
 = 
de2
;

2103 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

2104 (*Ë
de
, 
blocksize
);

2106 i‡(
csum_size
)

2107 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

2110 
de
 = (
pxt4_dú_íåy_2
 *Ë(&
roŸ
->
dŸdŸ
);

2111 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
	`PXT4_DIR_REC_LEN
(2),

2112 
blocksize
);

2113 
	`mem£t
 (&
roŸ
->
öfo
, 0, (root->info));

2114 
roŸ
->
öfo
.
öfo_Àngth
 = (root->info);

2115 
roŸ
->
öfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

2116 
íåõs
 = 
roŸ
->entries;

2117 
	`dx_£t_block
(
íåõs
, 1);

2118 
	`dx_£t_cou¡
(
íåõs
, 1);

2119 
	`dx_£t_limô
(
íåõs
, 
	`dx_roŸ_limô
(
dú
, (
roŸ
->
öfo
)));

2122 
‚ame
->
höfo
.
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

2123 i‡(
‚ame
->
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

2124 
‚ame
->
höfo
.
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

2125 
‚ame
->
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

2126 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), &‚ame->
höfo
);

2128 
	`mem£t
(
‰ames
, 0, (frames));

2129 
‰ame
 = 
‰ames
;

2130 
‰ame
->
íåõs
 =Éntries;

2131 
‰ame
->
©
 = 
íåõs
;

2132 
‰ame
->
bh
 = bh;

2134 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2135 i‡(
ªtvÆ
)

2136 
out_‰ames
;

2137 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

2138 i‡(
ªtvÆ
)

2139 
out_‰ames
;

2141 
de
 = 
	`do_•lô
(
h™dÀ
,
dú
, &
bh2
, 
‰ame
, &
‚ame
->
höfo
);

2142 i‡(
	`IS_ERR
(
de
)) {

2143 
ªtvÆ
 = 
	`PTR_ERR
(
de
);

2144 
out_‰ames
;

2147 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh2
);

2148 
out_‰ames
:

2154 i‡(
ªtvÆ
)

2155 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2156 
	`dx_ªÀa£
(
‰ames
);

2157 
	`bªl£
(
bh2
);

2158  
ªtvÆ
;

2159 
	}
}

2171 
	$pxt4_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
díåy
 *dentry,

2172 
öode
 *inode)

2174 
öode
 *
dú
 = 
	`d_öode
(
díåy
->
d_∑ª¡
);

2175 
buf„r_hód
 *
bh
 = 
NULL
;

2176 
pxt4_dú_íåy_2
 *
de
;

2177 
su≥r_block
 *
sb
;

2178 
pxt4_sb_öfo
 *
sbi
;

2179 
pxt4_fûíame
 
‚ame
;

2180 
ªtvÆ
;

2181 
dx_ÁŒback
=0;

2182 
blocksize
;

2183 
pxt4_lblk_t
 
block
, 
blocks
;

2184 
csum_size
 = 0;

2186 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2187 
csum_size
 = (
pxt4_dú_íåy_èû
);

2189 
sb
 = 
dú
->
i_sb
;

2190 
sbi
 = 
	`PXT4_SB
(
sb
);

2191 
blocksize
 = 
sb
->
s_blocksize
;

2192 i‡(!
díåy
->
d_«me
.
Àn
)

2193  -
EINVAL
;

2195 #ifde‡
CONFIG_UNICODE


2196 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
Ë&& 
	`IS_CASEFOLDED
(
dú
) &&

2197 
sbi
->
s_ícodög
 && 
	`utf8_vÆid©e
(sbi->s_ícodög, &
díåy
->
d_«me
))

2198  -
EINVAL
;

2201 
ªtvÆ
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 0, &
‚ame
);

2202 i‡(
ªtvÆ
)

2203  
ªtvÆ
;

2205 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2206 
ªtvÆ
 = 
	`pxt4_åy_add_ölöe_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2207 i‡(
ªtvÆ
 < 0)

2208 
out
;

2209 i‡(
ªtvÆ
 == 1) {

2210 
ªtvÆ
 = 0;

2211 
out
;

2215 i‡(
	`is_dx
(
dú
)) {

2216 
ªtvÆ
 = 
	`pxt4_dx_add_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2217 i‡(!
ªtvÆ
 || (ªtvÆ !
ERR_BAD_DX_DIR
))

2218 
out
;

2220 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

2221 
	`PXT4_ERROR_INODE
(
dú
,

2223 
ªtvÆ
 = -
EFSCORRUPTED
;

2224 
out
;

2226 
	`pxt4_˛ór_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2227 
dx_ÁŒback
++;

2228 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2230 
blocks
 = 
dú
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

2231 
block
 = 0; block < 
blocks
; block++) {

2232 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT
);

2233 i‡(
bh
 =
NULL
) {

2234 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
dú
, 
block
,

2235 
PXT4_GET_BLOCKS_CREATE
);

2236 
add_to_√w_block
;

2238 i‡(
	`IS_ERR
(
bh
)) {

2239 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2240 
bh
 = 
NULL
;

2241 
out
;

2243 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
,

2244 
NULL
, 
bh
);

2245 i‡(
ªtvÆ
 !-
ENOSPC
)

2246 
out
;

2248 i‡(
blocks
 =1 && !
dx_ÁŒback
 &&

2249 
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

2250 
ªtvÆ
 = 
	`make_ödexed_dú
(
h™dÀ
, &
‚ame
, 
dú
,

2251 
öode
, 
bh
);

2252 
bh
 = 
NULL
;

2253 
out
;

2255 
	`bªl£
(
bh
);

2257 
bh
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2258 
add_to_√w_block
:

2259 i‡(
	`IS_ERR
(
bh
)) {

2260 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2261 
bh
 = 
NULL
;

2262 
out
;

2264 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2265 
de
->
öode
 = 0;

2266 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
csum_size
, blocksize);

2268 i‡(
csum_size
)

2269 
	`pxt4_öôülize_dúít_èû
(
bh
, 
blocksize
);

2271 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2272 
out
:

2273 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

2274 
	`bªl£
(
bh
);

2275 i‡(
ªtvÆ
 == 0)

2276 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

2277  
ªtvÆ
;

2278 
	}
}

2283 
	$pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2284 
öode
 *
dú
, inode *inode)

2286 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2287 
dx_íåy
 *
íåõs
, *
©
;

2288 
buf„r_hód
 *
bh
;

2289 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

2290 
pxt4_dú_íåy_2
 *
de
;

2291 
ª°¨t
;

2292 
îr
;

2294 
agaö
:

2295 
ª°¨t
 = 0;

2296 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

2297 i‡(
	`IS_ERR
(
‰ame
))

2298  
	`PTR_ERR
(
‰ame
);

2299 
íåõs
 = 
‰ame
->entries;

2300 
©
 = 
‰ame
->at;

2301 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
‰ame
->
©
), 
DIRENT_HTREE
);

2302 i‡(
	`IS_ERR
(
bh
)) {

2303 
îr
 = 
	`PTR_ERR
(
bh
);

2304 
bh
 = 
NULL
;

2305 
˛ónup
;

2308 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2309 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2310 i‡(
îr
)

2311 
jou∫Æ_îr‹
;

2313 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
NULL
, 
bh
);

2314 i‡(
îr
 !-
ENOSPC
)

2315 
˛ónup
;

2317 
îr
 = 0;

2319 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "using %u of %uÇodeÉntries\n",

2320 
	`dx_gë_cou¡
(
íåõs
), 
	`dx_gë_limô
(entries)));

2322 i‡(
	`dx_gë_cou¡
(
íåõs
Ë=
	`dx_gë_limô
(entries)) {

2323 
pxt4_lblk_t
 
√wblock
;

2324 
Àvñs
 = 
‰ame
 - 
‰ames
 + 1;

2325 
icou¡
;

2326 
add_Àvñ
 = 1;

2327 
dx_íåy
 *
íåõs2
;

2328 
dx_node
 *
node2
;

2329 
buf„r_hód
 *
bh2
;

2331 
‰ame
 > 
‰ames
) {

2332 i‡(
	`dx_gë_cou¡
((
‰ame
 - 1)->
íåõs
) <

2333 
	`dx_gë_limô
((
‰ame
 - 1)->
íåõs
)) {

2334 
add_Àvñ
 = 0;

2337 
‰ame
--;

2338 
©
 = 
‰ame
->at;

2339 
íåõs
 = 
‰ame
->entries;

2340 
ª°¨t
 = 1;

2342 i‡(
add_Àvñ
 && 
Àvñs
 =
	`pxt4_dú_håì_Àvñ
(
sb
)) {

2343 
	`pxt4_w¨nög
(
sb
, "Directory (ino: %lu) index full, "

2345 
dú
->
i_öo
, 
Àvñs
);

2346 i‡(
	`pxt4_dú_håì_Àvñ
(
sb
Ë< 
PXT4_HTREE_LEVEL
) {

2347 
	`pxt4_w¨nög
(
sb
, "Large directory feature is "

2351 
îr
 = -
ENOSPC
;

2352 
˛ónup
;

2354 
icou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

2355 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

2356 i‡(
	`IS_ERR
(
bh2
)) {

2357 
îr
 = 
	`PTR_ERR
(
bh2
);

2358 
˛ónup
;

2360 
node2
 = (
dx_node
 *)(
bh2
->
b_d©a
);

2361 
íåõs2
 = 
node2
->
íåõs
;

2362 
	`mem£t
(&
node2
->
Áke
, 0, (
Áke_dúít
));

2363 
node2
->
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
sb
->
s_blocksize
,

2364 
sb
->
s_blocksize
);

2365 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2366 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

2367 i‡(
îr
)

2368 
jou∫Æ_îr‹
;

2369 i‡(!
add_Àvñ
) {

2370 
icou¡1
 = 
icou¡
/2, 
icou¡2
 = icount - icount1;

2371 
hash2
 = 
	`dx_gë_hash
(
íåõs
 + 
icou¡1
);

2372 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Split index %i/%i\n",

2373 
icou¡1
, 
icou¡2
));

2375 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2376 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2377 (
‰ame
 - 1)->
bh
);

2378 i‡(
îr
)

2379 
jou∫Æ_îr‹
;

2381 
	`mem˝y
((*Ë
íåõs2
, (*Ë(
íåõs
 + 
icou¡1
),

2382 
icou¡2
 * (
dx_íåy
));

2383 
	`dx_£t_cou¡
(
íåõs
, 
icou¡1
);

2384 
	`dx_£t_cou¡
(
íåõs2
, 
icou¡2
);

2385 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2388 i‡(
©
 - 
íåõs
 >
icou¡1
) {

2389 
‰ame
->
©
 =áà© - 
íåõs
 - 
icou¡1
 + 
íåõs2
;

2390 
‰ame
->
íåõs
 =É¡rõ†
íåõs2
;

2391 
	`sw≠
(
‰ame
->
bh
, 
bh2
);

2393 
	`dx_ö£π_block
((
‰ame
 - 1), 
hash2
, 
√wblock
);

2394 
	`dxåa˚
(
	`dx_show_ödex
("node", 
‰ame
->
íåõs
));

2395 
	`dxåa˚
(
	`dx_show_ödex
("node",

2396 ((
dx_node
 *Ë
bh2
->
b_d©a
)->
íåõs
));

2397 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2398 i‡(
îr
)

2399 
jou∫Æ_îr‹
;

2400 
	`bªl£
 (
bh2
);

2401 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2402 (
‰ame
 - 1)->
bh
);

2403 i‡(
îr
)

2404 
jou∫Æ_îr‹
;

2405 i‡(
ª°¨t
) {

2406 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2407 
‰ame
->
bh
);

2408 
jou∫Æ_îr‹
;

2411 
dx_roŸ
 *
dxroŸ
;

2412 
	`mem˝y
((*Ë
íåõs2
, (*Ë
íåõs
,

2413 
icou¡
 * (
dx_íåy
));

2414 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2417 
	`dx_£t_cou¡
(
íåõs
, 1);

2418 
	`dx_£t_block
(
íåõs
 + 0, 
√wblock
);

2419 
dxroŸ
 = (
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
;

2420 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
 += 1;

2421 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG


2423 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
));

2424 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2425 i‡(
îr
)

2426 
jou∫Æ_îr‹
;

2427 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2428 
	`bªl£
(
bh2
);

2429 
ª°¨t
 = 1;

2430 
jou∫Æ_îr‹
;

2433 
de
 = 
	`do_•lô
(
h™dÀ
, 
dú
, &
bh
, 
‰ame
, &
‚ame
->
höfo
);

2434 i‡(
	`IS_ERR
(
de
)) {

2435 
îr
 = 
	`PTR_ERR
(
de
);

2436 
˛ónup
;

2438 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2439 
˛ónup
;

2441 
jou∫Æ_îr‹
:

2442 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2443 
˛ónup
:

2444 
	`bªl£
(
bh
);

2445 
	`dx_ªÀa£
(
‰ames
);

2449 i‡(
ª°¨t
 && 
îr
 == 0)

2450 
agaö
;

2451  
îr
;

2452 
	}
}

2458 
	$pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2459 
öode
 *
dú
,

2460 
pxt4_dú_íåy_2
 *
de_dñ
,

2461 
buf„r_hód
 *
bh
,

2462 *
íåy_buf
,

2463 
buf_size
,

2464 
csum_size
)

2466 
pxt4_dú_íåy_2
 *
de
, *
pde
;

2467 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2468 
i
;

2470 
i
 = 0;

2471 
pde
 = 
NULL
;

2472 
de
 = (
pxt4_dú_íåy_2
 *)
íåy_buf
;

2473 
i
 < 
buf_size
 - 
csum_size
) {

2474 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

2475 
íåy_buf
, 
buf_size
, 
i
))

2476  -
EFSCORRUPTED
;

2477 i‡(
de
 =
de_dñ
) {

2478 i‡(
pde
)

2479 
pde
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2480 
	`pxt4_ªc_Àn_‰om_disk
(
pde
->
ªc_Àn
,

2481 
blocksize
) +

2482 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

2483 
blocksize
),

2484 
blocksize
);

2486 
de
->
öode
 = 0;

2487 
	`öode_öc_ivîsi⁄
(
dú
);

2490 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
blocksize
);

2491 
pde
 = 
de
;

2492 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2494  -
ENOENT
;

2495 
	}
}

2497 
	$pxt4_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2498 
öode
 *
dú
,

2499 
pxt4_dú_íåy_2
 *
de_dñ
,

2500 
buf„r_hód
 *
bh
)

2502 
îr
, 
csum_size
 = 0;

2504 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2505 
has_ölöe_d©a
 = 1;

2506 
îr
 = 
	`pxt4_dñëe_ölöe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

2507 &
has_ölöe_d©a
);

2508 i‡(
has_ölöe_d©a
)

2509  
îr
;

2512 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2513 
csum_size
 = (
pxt4_dú_íåy_èû
);

2515 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2516 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2517 i‡(
	`u∆ikñy
(
îr
))

2518 
out
;

2520 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
,

2521 
bh
, bh->
b_d©a
,

2522 
dú
->
i_sb
->
s_blocksize
, 
csum_size
);

2523 i‡(
îr
)

2524 
out
;

2526 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2527 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2528 i‡(
	`u∆ikñy
(
îr
))

2529 
out
;

2532 
out
:

2533 i‡(
îr
 !-
ENOENT
)

2534 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2535  
îr
;

2536 
	}
}

2549 
	$pxt4_öc_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2551 
	`öc_∆ök
(
öode
);

2552 i‡(
	`is_dx
(
öode
) &&

2553 (
öode
->
i_∆ök
 > 
PXT4_LINK_MAX
 || inode->i_nlink == 2))

2554 
	`£t_∆ök
(
öode
, 1);

2555 
	}
}

2561 
	$pxt4_dec_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2563 i‡(!
	`S_ISDIR
(
öode
->
i_mode
Ë|| inode->
i_∆ök
 > 2)

2564 
	`dr›_∆ök
(
öode
);

2565 
	}
}

2568 
	$pxt4_add_n⁄dú
(
h™dÀ_t
 *
h™dÀ
,

2569 
díåy
 *díåy, 
öode
 *inode)

2571 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2572 i‡(!
îr
) {

2573 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2574 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2577 
	`dr›_∆ök
(
öode
);

2578 
	`u∆ock_√w_öode
(
öode
);

2579 
	`ùut
(
öode
);

2580  
îr
;

2581 
	}
}

2591 
	$pxt4_¸óã
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
,

2592 
boﬁ
 
ex˛
)

2594 
h™dÀ_t
 *
h™dÀ
;

2595 
öode
 *inode;

2596 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2598 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2599 i‡(
îr
)

2600  
îr
;

2602 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2603 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2604 
ªåy
:

2605 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2606 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2607 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2608 
îr
 = 
	`PTR_ERR
(
öode
);

2609 i‡(!
	`IS_ERR
(
öode
)) {

2610 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2611 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2612 
	`pxt4_£t_a›s
(
öode
);

2613 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2614 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2615 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2617 i‡(
h™dÀ
)

2618 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2619 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2620 
ªåy
;

2621  
îr
;

2622 
	}
}

2624 
	$pxt4_mknod
(
öode
 *
dú
, 
díåy
 *dentry,

2625 
umode_t
 
mode
, 
dev_t
 
rdev
)

2627 
h™dÀ_t
 *
h™dÀ
;

2628 
öode
 *inode;

2629 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2631 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2632 i‡(
îr
)

2633  
îr
;

2635 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2636 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2637 
ªåy
:

2638 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2639 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2640 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2641 
îr
 = 
	`PTR_ERR
(
öode
);

2642 i‡(!
	`IS_ERR
(
öode
)) {

2643 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
rdev
);

2644 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

2645 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2646 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2647 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2649 i‡(
h™dÀ
)

2650 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2651 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2652 
ªåy
;

2653  
îr
;

2654 
	}
}

2656 
	$pxt4_tmpfûe
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2658 
h™dÀ_t
 *
h™dÀ
;

2659 
öode
 *inode;

2660 
îr
, 
ªåõs
 = 0;

2662 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2663 i‡(
îr
)

2664  
îr
;

2666 
ªåy
:

2667 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
,

2668 
NULL
, 0, NULL,

2669 
PXT4_HT_DIR
,

2670 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

2671 4 + 
PXT4_XATTR_TRANS_BLOCKS
);

2672 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2673 
îr
 = 
	`PTR_ERR
(
öode
);

2674 i‡(!
	`IS_ERR
(
öode
)) {

2675 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2676 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2677 
	`pxt4_£t_a›s
(
öode
);

2678 
	`d_tmpfûe
(
díåy
, 
öode
);

2679 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2680 i‡(
îr
)

2681 
îr_u∆ock_öode
;

2682 
	`m¨k_öode_dúty
(
öode
);

2683 
	`u∆ock_√w_öode
(
öode
);

2685 i‡(
h™dÀ
)

2686 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2687 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2688 
ªåy
;

2689  
îr
;

2690 
îr_u∆ock_öode
:

2691 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2692 
	`u∆ock_√w_öode
(
öode
);

2693  
îr
;

2694 
	}
}

2696 
pxt4_dú_íåy_2
 *
	$pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

2697 
pxt4_dú_íåy_2
 *
de
,

2698 
blocksize
, 
csum_size
,

2699 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
)

2701 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

2702 
de
->
«me_Àn
 = 1;

2703 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
	`PXT4_DIR_REC_LEN
(de->
«me_Àn
),

2704 
blocksize
);

2705 
	`°r˝y
(
de
->
«me
, ".");

2706 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2708 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2709 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

2710 
de
->
«me_Àn
 = 2;

2711 i‡(!
dŸdŸ_ªÆ_Àn
)

2712 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 -

2713 (
csum_size
 + 
	`PXT4_DIR_REC_LEN
(1)),

2714 
blocksize
);

2716 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2717 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
), 
blocksize
);

2718 
	`°r˝y
(
de
->
«me
, "..");

2719 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2721  
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

2722 
	}
}

2724 
	$pxt4_öô_√w_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

2725 
öode
 *inode)

2727 
buf„r_hód
 *
dú_block
 = 
NULL
;

2728 
pxt4_dú_íåy_2
 *
de
;

2729 
pxt4_lblk_t
 
block
 = 0;

2730 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2731 
csum_size
 = 0;

2732 
îr
;

2734 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2735 
csum_size
 = (
pxt4_dú_íåy_èû
);

2737 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

2738 
îr
 = 
	`pxt4_åy_¸óã_ölöe_dú
(
h™dÀ
, 
dú
, 
öode
);

2739 i‡(
îr
 < 0 &&Éº !-
ENOSPC
)

2740 
out
;

2741 i‡(!
îr
)

2742 
out
;

2745 
öode
->
i_size
 = 0;

2746 
dú_block
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
öode
, &
block
);

2747 i‡(
	`IS_ERR
(
dú_block
))

2748  
	`PTR_ERR
(
dú_block
);

2749 
de
 = (
pxt4_dú_íåy_2
 *)
dú_block
->
b_d©a
;

2750 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, 
de
, 
blocksize
, 
csum_size
, 
dú
->
i_öo
, 0);

2751 
	`£t_∆ök
(
öode
, 2);

2752 i‡(
csum_size
)

2753 
	`pxt4_öôülize_dúít_èû
(
dú_block
, 
blocksize
);

2755 
	`BUFFER_TRACE
(
dú_block
, "callÖxt4_handle_dirty_metadata");

2756 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

2757 i‡(
îr
)

2758 
out
;

2759 
	`£t_buf„r_vîifõd
(
dú_block
);

2760 
out
:

2761 
	`bªl£
(
dú_block
);

2762  
îr
;

2763 
	}
}

2765 
	$pxt4_mkdú
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2767 
h™dÀ_t
 *
h™dÀ
;

2768 
öode
 *inode;

2769 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2771 i‡(
	`PXT4_DIR_LINK_MAX
(
dú
))

2772  -
EMLINK
;

2774 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2775 i‡(
îr
)

2776  
îr
;

2778 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2779 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2780 
ªåy
:

2781 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFDIR
 | 
mode
,

2782 &
díåy
->
d_«me
,

2783 0, 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2784 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2785 
îr
 = 
	`PTR_ERR
(
öode
);

2786 i‡(
	`IS_ERR
(
öode
))

2787 
out_°›
;

2789 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

2790 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

2791 
îr
 = 
	`pxt4_öô_√w_dú
(
h™dÀ
, 
dú
, 
öode
);

2792 i‡(
îr
)

2793 
out_˛ór_öode
;

2794 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2795 i‡(!
îr
)

2796 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2797 i‡(
îr
) {

2798 
out_˛ór_öode
:

2799 
	`˛ór_∆ök
(
öode
);

2800 
	`u∆ock_√w_öode
(
öode
);

2801 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2802 
	`ùut
(
öode
);

2803 
out_°›
;

2805 
	`pxt4_öc_cou¡
(
h™dÀ
, 
dú
);

2806 
	`pxt4_upd©e_dx_Êag
(
dú
);

2807 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2808 i‡(
îr
)

2809 
out_˛ór_öode
;

2810 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2811 i‡(
	`IS_DIRSYNC
(
dú
))

2812 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2814 
out_°›
:

2815 i‡(
h™dÀ
)

2816 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2817 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2818 
ªåy
;

2819  
îr
;

2820 
	}
}

2825 
boﬁ
 
	$pxt4_em±y_dú
(
öode
 *inode)

2827 
off£t
;

2828 
buf„r_hód
 *
bh
;

2829 
pxt4_dú_íåy_2
 *
de
;

2830 
su≥r_block
 *
sb
;

2832 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2833 
has_ölöe_d©a
 = 1;

2834 
ªt
;

2836 
ªt
 = 
	`em±y_ölöe_dú
(
öode
, &
has_ölöe_d©a
);

2837 i‡(
has_ölöe_d©a
)

2838  
ªt
;

2841 
sb
 = 
öode
->
i_sb
;

2842 i‡(
öode
->
i_size
 < 
	`PXT4_DIR_REC_LEN
(1) + PXT4_DIR_REC_LEN(2)) {

2843 
	`PXT4_ERROR_INODE
(
öode
, "invalid size");

2844  
åue
;

2849 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

2850 i‡(
	`IS_ERR
(
bh
))

2851  
åue
;

2853 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2854 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
, bh->
b_size
,

2856 
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
 || 
	`°rcmp
(".", de->
«me
)) {

2857 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '.'");

2858 
	`bªl£
(
bh
);

2859  
åue
;

2861 
off£t
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2862 
de
 = 
	`pxt4_√xt_íåy
(de, 
sb
->
s_blocksize
);

2863 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
, bh->
b_size
,

2864 
off£t
) ||

2865 
	`À32_to_˝u
(
de
->
öode
Ë=0 || 
	`°rcmp
("..", de->
«me
)) {

2866 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '..'");

2867 
	`bªl£
(
bh
);

2868  
åue
;

2870 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2871 
off£t
 < 
öode
->
i_size
) {

2872 i‡(!(
off£t
 & (
sb
->
s_blocksize
 - 1))) {

2873 
lblock
;

2874 
	`bªl£
(
bh
);

2875 
lblock
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

2876 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 
lblock
, 
EITHER
);

2877 i‡(
bh
 =
NULL
) {

2878 
off£t
 +
sb
->
s_blocksize
;

2881 i‡(
	`IS_ERR
(
bh
))

2882  
åue
;

2884 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 +

2885 (
off£t
 & (
sb
->
s_blocksize
 - 1)));

2886 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
,

2887 
bh
->
b_d©a
, bh->
b_size
, 
off£t
)) {

2888 
off£t
 = (off£à| (
sb
->
s_blocksize
 - 1)) + 1;

2891 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

2892 
	`bªl£
(
bh
);

2893  
Ál£
;

2895 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2897 
	`bªl£
(
bh
);

2898  
åue
;

2899 
	}
}

2913 
	$pxt4_‹ph™_add
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2915 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2916 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2917 
pxt4_ûoc
 
ûoc
;

2918 
îr
 = 0, 
rc
;

2919 
boﬁ
 
dúty
 = 
Ál£
;

2921 i‡(!
sbi
->
s_jou∫Æ
 || 
	`is_bad_öode
(
öode
))

2924 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2925 !
	`öode_is_locked
(
öode
));

2930 i‡(!
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

2939 
	`J_ASSERT
((
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

2940 
	`S_ISLNK
(
öode
->
i_mode
)Ë|| inode->
i_∆ök
 == 0);

2942 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2943 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

2944 i‡(
îr
)

2945 
out
;

2947 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

2948 i‡(
îr
)

2949 
out
;

2951 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2956 i‡(!
	`NEXT_ORPHAN
(
öode
) || NEXT_ORPHAN(inode) >

2957 (
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
))) {

2959 
	`NEXT_ORPHAN
(
öode
Ë
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
);

2960 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

2961 
dúty
 = 
åue
;

2963 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
sbi
->
s_‹ph™
);

2964 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2966 i‡(
dúty
) {

2967 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

2968 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

2969 i‡(!
îr
)

2970 
îr
 = 
rc
;

2971 i‡(
îr
) {

2977 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2978 
	`li°_dñ_öô
(&
	`PXT4_I
(
öode
)->
i_‹ph™
);

2979 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2982 
	`bªl£
(
ûoc
.
bh
);

2984 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%lu\n", 
öode
->
i_öo
);

2985 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %d\n",

2986 
öode
->
i_öo
, 
	`NEXT_ORPHAN
(inode));

2987 
out
:

2988 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

2989  
îr
;

2990 
	}
}

2996 
	$pxt4_‹ph™_dñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2998 
li°_hód
 *
¥ev
;

2999 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3000 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3001 
__u32
 
öo_√xt
;

3002 
pxt4_ûoc
 
ûoc
;

3003 
îr
 = 0;

3005 i‡(!
sbi
->
s_jou∫Æ
 && !(sbi->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
))

3008 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

3009 !
	`öode_is_locked
(
öode
));

3011 i‡(
	`li°_em±y
(&
ei
->
i_‹ph™
))

3014 i‡(
h™dÀ
) {

3016 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

3019 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

3020 
	`jbd_debug
(4, "ªmovêöodê%lu from oΩh™Üi°\n", 
öode
->
i_öo
);

3022 
¥ev
 = 
ei
->
i_‹ph™
.prev;

3023 
	`li°_dñ_öô
(&
ei
->
i_‹ph™
);

3029 i‡(!
h™dÀ
 || 
îr
) {

3030 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3031 
out_îr
;

3034 
öo_√xt
 = 
	`NEXT_ORPHAN
(
öode
);

3035 i‡(
¥ev
 =&
sbi
->
s_‹ph™
) {

3036 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%u\n", 
öo_√xt
);

3037 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

3038 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

3039 i‡(
îr
) {

3040 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3041 
out_bªl£
;

3043 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öo_√xt
);

3044 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3045 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
öode
->
i_sb
);

3047 
pxt4_ûoc
 
ûoc2
;

3048 
öode
 *
i_¥ev
 =

3049 &
	`li°_íåy
(
¥ev
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

3051 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %u\n",

3052 
i_¥ev
->
i_öo
, 
öo_√xt
);

3053 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3054 i‡(
îr
) {

3055 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3056 
out_bªl£
;

3058 
	`NEXT_ORPHAN
(
i_¥ev
Ë
öo_√xt
;

3059 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3060 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3062 i‡(
îr
)

3063 
out_bªl£
;

3064 
	`NEXT_ORPHAN
(
öode
) = 0;

3065 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

3066 
out_îr
:

3067 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

3068  
îr
;

3070 
out_bªl£
:

3071 
	`bªl£
(
ûoc
.
bh
);

3072 
out_îr
;

3073 
	}
}

3075 
	$pxt4_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

3077 
ªtvÆ
;

3078 
öode
 *inode;

3079 
buf„r_hód
 *
bh
;

3080 
pxt4_dú_íåy_2
 *
de
;

3081 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3083 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3084  -
EIO
;

3088 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3089 i‡(
ªtvÆ
)

3090  
ªtvÆ
;

3091 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3092 i‡(
ªtvÆ
)

3093  
ªtvÆ
;

3095 
ªtvÆ
 = -
ENOENT
;

3096 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3097 i‡(
	`IS_ERR
(
bh
))

3098  
	`PTR_ERR
(
bh
);

3099 i‡(!
bh
)

3100 
íd_rmdú
;

3102 
öode
 = 
	`d_öode
(
díåy
);

3104 
ªtvÆ
 = -
EFSCORRUPTED
;

3105 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3106 
íd_rmdú
;

3108 
ªtvÆ
 = -
ENOTEMPTY
;

3109 i‡(!
	`pxt4_em±y_dú
(
öode
))

3110 
íd_rmdú
;

3112 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3113 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3114 i‡(
	`IS_ERR
(
h™dÀ
)) {

3115 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3116 
h™dÀ
 = 
NULL
;

3117 
íd_rmdú
;

3120 i‡(
	`IS_DIRSYNC
(
dú
))

3121 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3123 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3124 i‡(
ªtvÆ
)

3125 
íd_rmdú
;

3126 i‡(!
	`PXT4_DIR_LINK_EMPTY
(
öode
))

3127 
	`pxt4_w¨nög_öode
(
öode
,

3129 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
,

3130 
öode
->
i_∆ök
);

3131 
	`öode_öc_ivîsi⁄
(
öode
);

3132 
	`˛ór_∆ök
(
öode
);

3136 
öode
->
i_size
 = 0;

3137 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3138 
öode
->
i_˘ime
 = 
dú
->i_˘imêdú->
i_mtime
 = 
	`cuºít_time
(inode);

3139 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3140 
	`pxt4_dec_cou¡
(
h™dÀ
, 
dú
);

3141 
	`pxt4_upd©e_dx_Êag
(
dú
);

3142 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3144 #ifde‡
CONFIG_UNICODE


3151 i‡(
	`IS_CASEFOLDED
(
dú
))

3152 
	`d_övÆid©e
(
díåy
);

3155 
íd_rmdú
:

3156 
	`bªl£
(
bh
);

3157 i‡(
h™dÀ
)

3158 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3159  
ªtvÆ
;

3160 
	}
}

3162 
	$pxt4_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

3164 
ªtvÆ
;

3165 
öode
 *inode;

3166 
buf„r_hód
 *
bh
;

3167 
pxt4_dú_íåy_2
 *
de
;

3168 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3170 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3171  -
EIO
;

3173 
	`åa˚_pxt4_u∆ök_íãr
(
dú
, 
díåy
);

3176 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3177 i‡(
ªtvÆ
)

3178  
ªtvÆ
;

3179 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3180 i‡(
ªtvÆ
)

3181  
ªtvÆ
;

3183 
ªtvÆ
 = -
ENOENT
;

3184 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3185 i‡(
	`IS_ERR
(
bh
))

3186  
	`PTR_ERR
(
bh
);

3187 i‡(!
bh
)

3188 
íd_u∆ök
;

3190 
öode
 = 
	`d_öode
(
díåy
);

3192 
ªtvÆ
 = -
EFSCORRUPTED
;

3193 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3194 
íd_u∆ök
;

3196 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3197 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3198 i‡(
	`IS_ERR
(
h™dÀ
)) {

3199 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3200 
h™dÀ
 = 
NULL
;

3201 
íd_u∆ök
;

3204 i‡(
	`IS_DIRSYNC
(
dú
))

3205 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3207 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3208 i‡(
ªtvÆ
)

3209 
íd_u∆ök
;

3210 
dú
->
i_˘ime
 = dú->
i_mtime
 = 
	`cuºít_time
(dir);

3211 
	`pxt4_upd©e_dx_Êag
(
dú
);

3212 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3213 i‡(
öode
->
i_∆ök
 == 0)

3214 
	`pxt4_w¨nög_öode
(
öode
, "Deleting file '%.*s' withÇoÜinks",

3215 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
);

3217 
	`dr›_∆ök
(
öode
);

3218 i‡(!
öode
->
i_∆ök
)

3219 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3220 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3221 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3223 #ifde‡
CONFIG_UNICODE


3230 i‡(
	`IS_CASEFOLDED
(
dú
))

3231 
	`d_övÆid©e
(
díåy
);

3234 
íd_u∆ök
:

3235 
	`bªl£
(
bh
);

3236 i‡(
h™dÀ
)

3237 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3238 
	`åa˚_pxt4_u∆ök_exô
(
díåy
, 
ªtvÆ
);

3239  
ªtvÆ
;

3240 
	}
}

3242 
	$pxt4_symlök
(
öode
 *
dú
,

3243 
díåy
 *díåy, c⁄° *
sym«me
)

3245 
h™dÀ_t
 *
h™dÀ
;

3246 
öode
 *inode;

3247 
îr
, 
Àn
 = 
	`°æí
(
sym«me
);

3248 
¸edôs
;

3249 
fs¸y±_°r
 
disk_lök
;

3251 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3252  -
EIO
;

3254 
îr
 = 
	`fs¸y±_¥ï¨e_symlök
(
dú
, 
sym«me
, 
Àn
, dú->
i_sb
->
s_blocksize
,

3255 &
disk_lök
);

3256 i‡(
îr
)

3257  
îr
;

3259 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3260 i‡(
îr
)

3261  
îr
;

3263 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3270 
¸edôs
 = 4 + 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

3271 
PXT4_XATTR_TRANS_BLOCKS
;

3279 
¸edôs
 = 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3280 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3;

3283 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFLNK
|
S_IRWXUGO
,

3284 &
díåy
->
d_«me
, 0, 
NULL
,

3285 
PXT4_HT_DIR
, 
¸edôs
);

3286 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3287 i‡(
	`IS_ERR
(
öode
)) {

3288 i‡(
h™dÀ
)

3289 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3290  
	`PTR_ERR
(
öode
);

3293 i‡(
	`IS_ENCRYPTED
(
öode
)) {

3294 
îr
 = 
	`fs¸y±_í¸y±_symlök
(
öode
, 
sym«me
, 
Àn
, &
disk_lök
);

3295 i‡(
îr
)

3296 
îr_dr›_öode
;

3297 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3300 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3301 i‡(!
	`IS_ENCRYPTED
(
öode
))

3302 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

3303 
	`öode_nohighmem
(
öode
);

3304 
	`pxt4_£t_a›s
(
öode
);

3315 
	`dr›_∆ök
(
öode
);

3316 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3317 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3318 
h™dÀ
 = 
NULL
;

3319 i‡(
îr
)

3320 
îr_dr›_öode
;

3321 
îr
 = 
	`__∑ge_symlök
(
öode
, 
disk_lök
.
«me
, disk_lök.
Àn
, 1);

3322 i‡(
îr
)

3323 
îr_dr›_öode
;

3328 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3329 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3330 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 1);

3331 i‡(
	`IS_ERR
(
h™dÀ
)) {

3332 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

3333 
h™dÀ
 = 
NULL
;

3334 
îr_dr›_öode
;

3336 
	`£t_∆ök
(
öode
, 1);

3337 
îr
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3338 i‡(
îr
)

3339 
îr_dr›_öode
;

3342 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

3343 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

3344 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

3345 
öode
->
i_lök
 = (*)&
	`PXT4_I
(öode)->
i_d©a
;

3347 
	`mem˝y
((*)&
	`PXT4_I
(
öode
)->
i_d©a
, 
disk_lök
.
«me
,

3348 
disk_lök
.
Àn
);

3349 
öode
->
i_size
 = 
disk_lök
.
Àn
 - 1;

3351 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

3352 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

3353 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

3354 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3356 i‡(
h™dÀ
)

3357 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3358 
out_‰ì_í¸y±ed_lök
;

3360 
îr_dr›_öode
:

3361 i‡(
h™dÀ
)

3362 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3363 
	`˛ór_∆ök
(
öode
);

3364 
	`u∆ock_√w_öode
(
öode
);

3365 
	`ùut
(
öode
);

3366 
out_‰ì_í¸y±ed_lök
:

3367 i‡(
disk_lök
.
«me
 !(*)
sym«me
)

3368 
	`k‰ì
(
disk_lök
.
«me
);

3369  
îr
;

3370 
	}
}

3372 
	$pxt4_lök
(
díåy
 *
ﬁd_díåy
,

3373 
öode
 *
dú
, 
díåy
 *dentry)

3375 
h™dÀ_t
 *
h™dÀ
;

3376 
öode
 *öodê
	`d_öode
(
ﬁd_díåy
);

3377 
îr
, 
ªåõs
 = 0;

3379 i‡(
öode
->
i_∆ök
 >
PXT4_LINK_MAX
)

3380  -
EMLINK
;

3382 
îr
 = 
	`fs¸y±_¥ï¨e_lök
(
ﬁd_díåy
, 
dú
, 
díåy
);

3383 i‡(
îr
)

3384  
îr
;

3386 i‡((
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3387 (!
	`¥ojid_eq
(
	`PXT4_I
(
dú
)->
i_¥ojid
,

3388 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3389  -
EXDEV
;

3391 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3392 i‡(
îr
)

3393  
îr
;

3395 
ªåy
:

3396 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3397 (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3398 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
) + 1);

3399 i‡(
	`IS_ERR
(
h™dÀ
))

3400  
	`PTR_ERR
(
h™dÀ
);

3402 i‡(
	`IS_DIRSYNC
(
dú
))

3403 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3405 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3406 
	`pxt4_öc_cou¡
(
h™dÀ
, 
öode
);

3407 
	`ihﬁd
(
öode
);

3409 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

3410 i‡(!
îr
) {

3411 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3415 i‡(
öode
->
i_∆ök
 == 1)

3416 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3417 
	`d_ö°™tüã
(
díåy
, 
öode
);

3419 
	`dr›_∆ök
(
öode
);

3420 
	`ùut
(
öode
);

3422 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3423 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

3424 
ªåy
;

3425  
îr
;

3426 
	}
}

3434 
buf„r_hód
 *
	$pxt4_gë_fú°_dú_block
(
h™dÀ_t
 *
h™dÀ
,

3435 
öode
 *inode,

3436 *
ªtvÆ
,

3437 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3438 *
ölöed
)

3440 
buf„r_hód
 *
bh
;

3442 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

3446 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

3447 i‡(
	`IS_ERR
(
bh
)) {

3448 *
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

3449  
NULL
;

3451 *
∑ª¡_de
 = 
	`pxt4_√xt_íåy
(

3452 (
pxt4_dú_íåy_2
 *)
bh
->
b_d©a
,

3453 
öode
->
i_sb
->
s_blocksize
);

3454  
bh
;

3457 *
ölöed
 = 1;

3458  
	`pxt4_gë_fú°_ölöe_block
(
öode
, 
∑ª¡_de
, 
ªtvÆ
);

3459 
	}
}

3461 
	spxt4_ª«mít
 {

3462 
öode
 *
	mdú
;

3463 
díåy
 *
	mdíåy
;

3464 
öode
 *
	möode
;

3465 
boﬁ
 
	mis_dú
;

3466 
	mdú_∆ök_dñè
;

3469 
buf„r_hód
 *
	mbh
;

3470 
pxt4_dú_íåy_2
 *
	mde
;

3471 
	mölöed
;

3474 
buf„r_hód
 *
	mdú_bh
;

3475 
pxt4_dú_íåy_2
 *
	m∑ª¡_de
;

3476 
	mdú_ölöed
;

3479 
	$pxt4_ª«me_dú_¥ï¨e
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3481 
ªtvÆ
;

3483 
ít
->
dú_bh
 = 
	`pxt4_gë_fú°_dú_block
(
h™dÀ
,É¡->
öode
,

3484 &
ªtvÆ
, &
ít
->
∑ª¡_de
,

3485 &
ít
->
dú_ölöed
);

3486 i‡(!
ít
->
dú_bh
)

3487  
ªtvÆ
;

3488 i‡(
	`À32_to_˝u
(
ít
->
∑ª¡_de
->
öode
Ë!ít->
dú
->
i_öo
)

3489  -
EFSCORRUPTED
;

3490 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "get_write_access");

3491  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
dú_bh
);

3492 
	}
}

3494 
	$pxt4_ª«me_dú_föish
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3495 
dú_öo
)

3497 
ªtvÆ
;

3499 
ít
->
∑ª¡_de
->
öode
 = 
	`˝u_to_À32
(
dú_öo
);

3500 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "callÖxt4_handle_dirty_metadata");

3501 i‡(!
ít
->
dú_ölöed
) {

3502 i‡(
	`is_dx
(
ít
->
öode
)) {

3503 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
,

3504 
ít
->
öode
,

3505 
ít
->
dú_bh
);

3507 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
öode
,

3508 
ít
->
dú_bh
);

3511 
ªtvÆ
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
öode
);

3513 i‡(
ªtvÆ
) {

3514 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3515  
ªtvÆ
;

3518 
	}
}

3520 
	$pxt4_£ã¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3521 
öo
, 
fûe_ty≥
)

3523 
ªtvÆ
;

3525 
	`BUFFER_TRACE
(
ít
->
bh
, "get writeáccess");

3526 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
bh
);

3527 i‡(
ªtvÆ
)

3528  
ªtvÆ
;

3529 
ít
->
de
->
öode
 = 
	`˝u_to_À32
(
öo
);

3530 i‡(
	`pxt4_has_„©uª_fûëy≥
(
ít
->
dú
->
i_sb
))

3531 
ít
->
de
->
fûe_ty≥
 = file_type;

3532 
	`öode_öc_ivîsi⁄
(
ít
->
dú
);

3533 
ít
->
dú
->
i_˘ime
 =É¡->dú->
i_mtime
 =

3534 
	`cuºít_time
(
ít
->
dú
);

3535 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3536 
	`BUFFER_TRACE
(
ít
->
bh
, "callÖxt4_handle_dirty_metadata");

3537 i‡(!
ít
->
ölöed
) {

3538 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
dú
,É¡->
bh
);

3539 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

3540 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3541  
ªtvÆ
;

3544 
	`bªl£
(
ít
->
bh
);

3545 
ít
->
bh
 = 
NULL
;

3548 
	}
}

3550 
	$pxt4_föd_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

3551 c⁄° 
q°r
 *
d_«me
)

3553 
ªtvÆ
 = -
ENOENT
;

3554 
buf„r_hód
 *
bh
;

3555 
pxt4_dú_íåy_2
 *
de
;

3557 
bh
 = 
	`pxt4_föd_íåy
(
dú
, 
d_«me
, &
de
, 
NULL
);

3558 i‡(
	`IS_ERR
(
bh
))

3559  
	`PTR_ERR
(
bh
);

3560 i‡(
bh
) {

3561 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3562 
	`bªl£
(
bh
);

3564  
ªtvÆ
;

3565 
	}
}

3567 
	$pxt4_ª«me_dñëe
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3568 
f‹˚_ªªad
)

3570 
ªtvÆ
;

3577 i‡(
	`À32_to_˝u
(
ít
->
de
->
öode
Ë!ít->öode->
i_öo
 ||

3578 
ít
->
de
->
«me_Àn
 !ít->
díåy
->
d_«me
.
Àn
 ||

3579 
	`°∫cmp
(
ít
->
de
->
«me
,É¡->
díåy
->
d_«me
.name,

3580 
ít
->
de
->
«me_Àn
) ||

3581 
f‹˚_ªªad
) {

3582 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3583 &
ít
->
díåy
->
d_«me
);

3585 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,É¡->
de
,É¡->
bh
);

3586 i‡(
ªtvÆ
 =-
ENOENT
) {

3587 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3588 &
ít
->
díåy
->
d_«me
);

3592 i‡(
ªtvÆ
) {

3593 
	`pxt4_w¨nög_öode
(
ít
->
dú
,

3595 
ít
->
dú
->
i_∆ök
, 
ªtvÆ
);

3597 
	}
}

3599 
	$pxt4_upd©e_dú_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3601 i‡(
ít
->
dú_∆ök_dñè
) {

3602 i‡(
ít
->
dú_∆ök_dñè
 == -1)

3603 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ít
->
dú
);

3605 
	`pxt4_öc_cou¡
(
h™dÀ
, 
ít
->
dú
);

3606 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3608 
	}
}

3610 
öode
 *
	$pxt4_whôeout_f‹_ª«me
(
pxt4_ª«mít
 *
ít
,

3611 
¸edôs
, 
h™dÀ_t
 **
h
)

3613 
öode
 *
wh
;

3614 
h™dÀ_t
 *
h™dÀ
;

3615 
ªåõs
 = 0;

3621 
¸edôs
 +(
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
ít
->
dú
->
i_sb
) +

3622 
PXT4_XATTR_TRANS_BLOCKS
 + 4);

3623 
ªåy
:

3624 
wh
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
ít
->
dú
, 
S_IFCHR
 | 
WHITEOUT_MODE
,

3625 &
ít
->
díåy
->
d_«me
, 0, 
NULL
,

3626 
PXT4_HT_DIR
, 
¸edôs
);

3628 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3629 i‡(
	`IS_ERR
(
wh
)) {

3630 i‡(
h™dÀ
)

3631 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3632 i‡(
	`PTR_ERR
(
wh
Ë=-
ENOSPC
 &&

3633 
	`pxt4_should_ªåy_Æloc
(
ít
->
dú
->
i_sb
, &
ªåõs
))

3634 
ªåy
;

3636 *
h
 = 
h™dÀ
;

3637 
	`öô_•ecül_öode
(
wh
, wh->
i_mode
, 
WHITEOUT_DEV
);

3638 
wh
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

3640  
wh
;

3641 
	}
}

3651 
	$pxt4_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3652 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

3653 
Êags
)

3655 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3656 
pxt4_ª«mít
 
ﬁd
 = {

3657 .
dú
 = 
ﬁd_dú
,

3658 .
díåy
 = 
ﬁd_díåy
,

3659 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3661 
pxt4_ª«mít
 
√w
 = {

3662 .
dú
 = 
√w_dú
,

3663 .
díåy
 = 
√w_díåy
,

3664 .
öode
 = 
	`d_öode
(
√w_díåy
),

3666 
f‹˚_ªªad
;

3667 
ªtvÆ
;

3668 
öode
 *
whôeout
 = 
NULL
;

3669 
¸edôs
;

3670 
u8
 
ﬁd_fûe_ty≥
;

3672 i‡(
√w
.
öode
 &&Çew.öode->
i_∆ök
 == 0) {

3673 
	`PXT4_ERROR_INODE
(
√w
.
öode
,

3675  -
EFSCORRUPTED
;

3678 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3679 (!
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3680 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3681  -
EXDEV
;

3683 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3684 i‡(
ªtvÆ
)

3685  
ªtvÆ
;

3686 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3687 i‡(
ªtvÆ
)

3688  
ªtvÆ
;

3692 i‡(
√w
.
öode
) {

3693 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
öode
);

3694 i‡(
ªtvÆ
)

3695  
ªtvÆ
;

3698 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
, &ﬁd.
de
, 
NULL
);

3699 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3700  
	`PTR_ERR
(
ﬁd
.
bh
);

3707 
ªtvÆ
 = -
ENOENT
;

3708 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3709 
íd_ª«me
;

3711 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3712 &
√w
.
de
, &√w.
ölöed
);

3713 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3714 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3715 
√w
.
bh
 = 
NULL
;

3716 
íd_ª«me
;

3718 i‡(
√w
.
bh
) {

3719 i‡(!
√w
.
öode
) {

3720 
	`bªl£
(
√w
.
bh
);

3721 
√w
.
bh
 = 
NULL
;

3724 i‡(
√w
.
öode
 && !
	`ã°_›t
“ew.
dú
->
i_sb
, 
NO_AUTO_DA_ALLOC
))

3725 
	`pxt4_Æloc_da_blocks
(
ﬁd
.
öode
);

3727 
¸edôs
 = (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3728 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2);

3729 i‡(!(
Êags
 & 
RENAME_WHITEOUT
)) {

3730 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
, 
¸edôs
);

3731 i‡(
	`IS_ERR
(
h™dÀ
)) {

3732 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3733 
h™dÀ
 = 
NULL
;

3734 
íd_ª«me
;

3737 
whôeout
 = 
	`pxt4_whôeout_f‹_ª«me
(&
ﬁd
, 
¸edôs
, &
h™dÀ
);

3738 i‡(
	`IS_ERR
(
whôeout
)) {

3739 
ªtvÆ
 = 
	`PTR_ERR
(
whôeout
);

3740 
whôeout
 = 
NULL
;

3741 
íd_ª«me
;

3745 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3746 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3748 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3749 i‡(
√w
.
öode
) {

3750 
ªtvÆ
 = -
ENOTEMPTY
;

3751 i‡(!
	`pxt4_em±y_dú
(
√w
.
öode
))

3752 
íd_ª«me
;

3754 
ªtvÆ
 = -
EMLINK
;

3755 i‡(
√w
.
dú
 !
ﬁd
.dú && 
	`PXT4_DIR_LINK_MAX
(new.dir))

3756 
íd_ª«me
;

3758 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3759 i‡(
ªtvÆ
)

3760 
íd_ª«me
;

3769 
f‹˚_ªªad
 = (
√w
.
dú
->
i_öo
 =
ﬁd
.dir->i_ino &&

3770 
	`pxt4_ã°_öode_Êag
(
√w
.
dú
, 
PXT4_INODE_INLINE_DATA
));

3772 
ﬁd_fûe_ty≥
 = 
ﬁd
.
de
->
fûe_ty≥
;

3773 i‡(
whôeout
) {

3778 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
whôeout
->
i_öo
,

3779 
PXT4_FT_CHRDEV
);

3780 i‡(
ªtvÆ
)

3781 
íd_ª«me
;

3782 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
whôeout
);

3784 i‡(!
√w
.
bh
) {

3785 
ªtvÆ
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
√w
.
díåy
, 
ﬁd
.
öode
);

3786 i‡(
ªtvÆ
)

3787 
íd_ª«me
;

3789 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
,

3790 
ﬁd
.
öode
->
i_öo
, 
ﬁd_fûe_ty≥
);

3791 i‡(
ªtvÆ
)

3792 
íd_ª«me
;

3794 i‡(
f‹˚_ªªad
)

3795 
f‹˚_ªªad
 = !
	`pxt4_ã°_öode_Êag
(
√w
.
dú
,

3796 
PXT4_INODE_INLINE_DATA
);

3802 
ﬁd
.
öode
->
i_˘ime
 = 
	`cuºít_time
(old.inode);

3803 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3805 i‡(!
whôeout
) {

3809 
	`pxt4_ª«me_dñëe
(
h™dÀ
, &
ﬁd
, 
f‹˚_ªªad
);

3812 i‡(
√w
.
öode
) {

3813 
	`pxt4_dec_cou¡
(
h™dÀ
, 
√w
.
öode
);

3814 
√w
.
öode
->
i_˘ime
 = 
	`cuºít_time
(new.inode);

3816 
ﬁd
.
dú
->
i_˘ime
 = old.dú->
i_mtime
 = 
	`cuºít_time
(old.dir);

3817 
	`pxt4_upd©e_dx_Êag
(
ﬁd
.
dú
);

3818 i‡(
ﬁd
.
dú_bh
) {

3819 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3820 i‡(
ªtvÆ
)

3821 
íd_ª«me
;

3823 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ﬁd
.
dú
);

3824 i‡(
√w
.
öode
) {

3828 
	`˛ór_∆ök
(
√w
.
öode
);

3830 
	`pxt4_öc_cou¡
(
h™dÀ
, 
√w
.
dú
);

3831 
	`pxt4_upd©e_dx_Êag
(
√w
.
dú
);

3832 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
dú
);

3835 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
dú
);

3836 i‡(
√w
.
öode
) {

3837 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3838 i‡(!
√w
.
öode
->
i_∆ök
)

3839 
	`pxt4_‹ph™_add
(
h™dÀ
, 
√w
.
öode
);

3841 
ªtvÆ
 = 0;

3843 
íd_ª«me
:

3844 
	`bªl£
(
ﬁd
.
dú_bh
);

3845 
	`bªl£
(
ﬁd
.
bh
);

3846 
	`bªl£
(
√w
.
bh
);

3847 i‡(
whôeout
) {

3848 i‡(
ªtvÆ
)

3849 
	`dr›_∆ök
(
whôeout
);

3850 
	`u∆ock_√w_öode
(
whôeout
);

3851 
	`ùut
(
whôeout
);

3853 i‡(
h™dÀ
)

3854 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3855  
ªtvÆ
;

3856 
	}
}

3858 
	$pxt4_¸oss_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3859 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
)

3861 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3862 
pxt4_ª«mít
 
ﬁd
 = {

3863 .
dú
 = 
ﬁd_dú
,

3864 .
díåy
 = 
ﬁd_díåy
,

3865 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3867 
pxt4_ª«mít
 
√w
 = {

3868 .
dú
 = 
√w_dú
,

3869 .
díåy
 = 
√w_díåy
,

3870 .
öode
 = 
	`d_öode
(
√w_díåy
),

3872 
u8
 
√w_fûe_ty≥
;

3873 
ªtvÆ
;

3874 
time•ec64
 
˘ime
;

3876 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3877 !
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3878 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)) ||

3879 (
	`pxt4_ã°_öode_Êag
(
ﬁd_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3880 !
	`¥ojid_eq
(
	`PXT4_I
(
ﬁd_dú
)->
i_¥ojid
,

3881 
	`PXT4_I
(
√w_díåy
->
d_öode
)->
i_¥ojid
)))

3882  -
EXDEV
;

3884 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3885 i‡(
ªtvÆ
)

3886  
ªtvÆ
;

3887 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3888 i‡(
ªtvÆ
)

3889  
ªtvÆ
;

3891 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
,

3892 &
ﬁd
.
de
, &ﬁd.
ölöed
);

3893 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3894  
	`PTR_ERR
(
ﬁd
.
bh
);

3901 
ªtvÆ
 = -
ENOENT
;

3902 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3903 
íd_ª«me
;

3905 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3906 &
√w
.
de
, &√w.
ölöed
);

3907 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3908 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3909 
√w
.
bh
 = 
NULL
;

3910 
íd_ª«me
;

3914 i‡(!
√w
.
bh
 || 
	`À32_to_˝u
“ew.
de
->
öode
Ë!√w.öode->
i_öo
)

3915 
íd_ª«me
;

3917 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
,

3918 (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3919 2 * 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2));

3920 i‡(
	`IS_ERR
(
h™dÀ
)) {

3921 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3922 
h™dÀ
 = 
NULL
;

3923 
íd_ª«me
;

3926 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3927 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3929 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3930 
ﬁd
.
is_dú
 = 
åue
;

3931 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3932 i‡(
ªtvÆ
)

3933 
íd_ª«me
;

3935 i‡(
	`S_ISDIR
(
√w
.
öode
->
i_mode
)) {

3936 
√w
.
is_dú
 = 
åue
;

3937 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
√w
);

3938 i‡(
ªtvÆ
)

3939 
íd_ª«me
;

3946 i‡(
ﬁd
.
dú
 !
√w
.dú && old.
is_dú
 !=Çew.is_dir) {

3947 
ﬁd
.
dú_∆ök_dñè
 = old.
is_dú
 ? -1 : 1;

3948 
√w
.
dú_∆ök_dñè
 = -
ﬁd
.dir_nlink_delta;

3949 
ªtvÆ
 = -
EMLINK
;

3950 i‡((
ﬁd
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
(ﬁd.
dú
)) ||

3951 (
√w
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
“ew.
dú
)))

3952 
íd_ª«me
;

3955 
√w_fûe_ty≥
 = 
√w
.
de
->
fûe_ty≥
;

3956 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
, 
ﬁd
.
öode
->
i_öo
, old.
de
->
fûe_ty≥
);

3957 i‡(
ªtvÆ
)

3958 
íd_ª«me
;

3960 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
√w
.
öode
->
i_öo
, 
√w_fûe_ty≥
);

3961 i‡(
ªtvÆ
)

3962 
íd_ª«me
;

3968 
˘ime
 = 
	`cuºít_time
(
ﬁd
.
öode
);

3969 
ﬁd
.
öode
->
i_˘ime
 = 
˘ime
;

3970 
√w
.
öode
->
i_˘ime
 = 
˘ime
;

3971 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3972 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3974 i‡(
ﬁd
.
dú_bh
) {

3975 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3976 i‡(
ªtvÆ
)

3977 
íd_ª«me
;

3979 i‡(
√w
.
dú_bh
) {

3980 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
√w
, 
ﬁd
.
dú
->
i_öo
);

3981 i‡(
ªtvÆ
)

3982 
íd_ª«me
;

3984 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
ﬁd
);

3985 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
√w
);

3986 
ªtvÆ
 = 0;

3988 
íd_ª«me
:

3989 
	`bªl£
(
ﬁd
.
dú_bh
);

3990 
	`bªl£
(
√w
.
dú_bh
);

3991 
	`bªl£
(
ﬁd
.
bh
);

3992 
	`bªl£
(
√w
.
bh
);

3993 i‡(
h™dÀ
)

3994 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3995  
ªtvÆ
;

3996 
	}
}

3998 
	$pxt4_ª«me2
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3999 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

4000 
Êags
)

4002 
îr
;

4004 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
ﬁd_dú
->
i_sb
))))

4005  -
EIO
;

4007 i‡(
Êags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

4008  -
EINVAL
;

4010 
îr
 = 
	`fs¸y±_¥ï¨e_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
,

4011 
Êags
);

4012 i‡(
îr
)

4013  
îr
;

4015 i‡(
Êags
 & 
RENAME_EXCHANGE
) {

4016  
	`pxt4_¸oss_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
,

4017 
√w_dú
, 
√w_díåy
);

4020  
	`pxt4_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
, 
Êags
);

4021 
	}
}

4026 c⁄° 
öode_›î©i⁄s
 
	gpxt4_dú_öode_›î©i⁄s
 = {

4027 .
¸óã
 = 
pxt4_¸óã
,

4028 .
	glookup
 = 
pxt4_lookup
,

4029 .
	glök
 = 
pxt4_lök
,

4030 .
	gu∆ök
 = 
pxt4_u∆ök
,

4031 .
	gsymlök
 = 
pxt4_symlök
,

4032 .
	gmkdú
 = 
pxt4_mkdú
,

4033 .
	grmdú
 = 
pxt4_rmdú
,

4034 .
	gmknod
 = 
pxt4_mknod
,

4035 .
	gtmpfûe
 = 
pxt4_tmpfûe
,

4036 .
	gª«me
 = 
pxt4_ª«me2
,

4037 .
	g£èâr
 = 
pxt4_£èâr
,

4038 .
	ggë©å
 = 
pxt4_gë©å
,

4039 .
	gli°x©å
 = 
pxt4_li°x©å
,

4040 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4041 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

4042 .
	gfõm≠
 = 
pxt4_fõm≠
,

4045 c⁄° 
öode_›î©i⁄s
 
	gpxt4_•ecül_öode_›î©i⁄s
 = {

4046 .
£èâr
 = 
pxt4_£èâr
,

4047 .
	ggë©å
 = 
pxt4_gë©å
,

4048 .
	gli°x©å
 = 
pxt4_li°x©å
,

4049 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4050 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

	@page-io.c

10 
	~<löux/fs.h
>

11 
	~<löux/time.h
>

12 
	~<löux/highuid.h
>

13 
	~<löux/∑gem≠.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/wrôeback.h
>

18 
	~<löux/∑gevec.h
>

19 
	~<löux/m∑ge.h
>

20 
	~<löux/«mei.h
>

21 
	~<löux/uio.h
>

22 
	~<löux/bio.h
>

23 
	~<löux/w‹kqueue.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/backög-dev.h
>

29 
	~"pxt4_jbd3.h
"

30 
	~"x©å.h
"

31 
	~"a˛.h
"

33 
kmem_ˇche
 *
	gio_íd_ˇchï
;

35 
__öô
 
	$pxt4_öô_∑geio
()

37 
io_íd_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_io_íd
, 
SLAB_RECLAIM_ACCOUNT
);

38 i‡(
io_íd_ˇchï
 =
NULL
)

39  -
ENOMEM
;

41 
	}
}

43 
	$pxt4_exô_∑geio
()

45 
	`kmem_ˇche_de°roy
(
io_íd_ˇchï
);

46 
	}
}

55 
	$buf„r_io_îr‹
(
buf„r_hód
 *
bh
)

57 
	`¥ötk_øãlimôed
(
KERN_ERR
 "Buffer I/OÉrror on device %pg,Üogical block %llu\n",

58 
bh
->
b_bdev
,

59 ()
bh
->
b_blockƒ
);

60 
	}
}

62 
	$pxt4_föish_bio
(
bio
 *bio)

64 
bio_vec
 *
bvec
;

65 
bvec_ôî_Æl
 
ôî_Æl
;

67 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

68 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

69 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

70 
buf„r_hód
 *
bh
, *
hód
;

71 
bio_°¨t
 = 
bvec
->
bv_off£t
;

72 
bio_íd
 = 
bio_°¨t
 + 
bvec
->
bv_Àn
;

73 
undî_io
 = 0;

74 
Êags
;

76 i‡(!
∑ge
)

79 i‡(
	`fs¸y±_is_boun˚_∑ge
(
∑ge
)) {

80 
boun˚_∑ge
 = 
∑ge
;

81 
∑ge
 = 
	`fs¸y±_∑geˇche_∑ge
(
boun˚_∑ge
);

84 i‡(
bio
->
bi_°©us
) {

85 
	`SëPageEº‹
(
∑ge
);

86 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, -
EIO
);

88 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

93 
	`loˇl_úq_ßve
(
Êags
);

94 
	`bô_•ö_lock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

96 i‡(
	`bh_off£t
(
bh
Ë< 
bio_°¨t
 ||

97 
	`bh_off£t
(
bh
Ë+ bh->
b_size
 > 
bio_íd
) {

98 i‡(
	`buf„r_async_wrôe
(
bh
))

99 
undî_io
++;

102 
	`˛ór_buf„r_async_wrôe
(
bh
);

103 i‡(
bio
->
bi_°©us
)

104 
	`buf„r_io_îr‹
(
bh
);

105 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

106 
	`bô_•ö_u∆ock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

107 
	`loˇl_úq_ª°‹e
(
Êags
);

108 i‡(!
undî_io
) {

109 
	`fs¸y±_‰ì_boun˚_∑ge
(
boun˚_∑ge
);

110 
	`íd_∑ge_wrôeback
(
∑ge
);

113 
	}
}

115 
	$pxt4_ªÀa£_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

117 
bio
 *bio, *
√xt_bio
;

119 
	`BUG_ON
(!
	`li°_em±y
(&
io_íd
->
li°
));

120 
	`BUG_ON
(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
);

121 
	`WARN_ON
(
io_íd
->
h™dÀ
);

123 
bio
 = 
io_íd
->bio; bio; biÿ
√xt_bio
) {

124 
√xt_bio
 = 
bio
->
bi_¥iv©e
;

125 
	`pxt4_föish_bio
(
bio
);

126 
	`bio_put
(
bio
);

128 
	`kmem_ˇche_‰ì
(
io_íd_ˇchï
, 
io_íd
);

129 
	}
}

139 
	$pxt4_íd_io
(
pxt4_io_íd_t
 *
io
)

141 
öode
 *öodê
io
->inode;

142 
loff_t
 
off£t
 = 
io
->offset;

143 
ssize_t
 
size
 = 
io
->size;

144 
h™dÀ_t
 *
h™dÀ
 = 
io
->handle;

145 
ªt
 = 0;

147 
	`pxt4_debug
("pxt4_end_io_nolock: io 0x%p from inode %lu,list->next 0x%p,"

149 
io
, 
öode
->
i_öo
, io->
li°
.
√xt
, io->li°.
¥ev
);

151 
io
->
h™dÀ
 = 
NULL
;

152 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ
, 
öode
, 
off£t
, 
size
);

153 i‡(
ªt
 < 0 && !
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))) {

154 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_EMERG
,

158 
öode
->
i_öo
, 
off£t
, 
size
, 
ªt
);

160 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io
);

161 
	`pxt4_ªÀa£_io_íd
(
io
);

162  
ªt
;

163 
	}
}

165 
	$dump_com∂ëed_IO
(
öode
 *öode, 
li°_hód
 *
hód
)

167 #ifdef 
PXT4FS_DEBUG


168 
li°_hód
 *
cur
, *
bef‹e
, *
a·î
;

169 
pxt4_io_íd_t
 *
io
, *
io0
, *
io1
;

171 i‡(
	`li°_em±y
(
hód
))

174 
	`pxt4_debug
("Dum∞öodê%lu com∂ëed iÿli°\n", 
öode
->
i_öo
);

175 
	`li°_f‹_óch_íåy
(
io
, 
hód
, 
li°
) {

176 
cur
 = &
io
->
li°
;

177 
bef‹e
 = 
cur
->
¥ev
;

178 
io0
 = 
	`c⁄èöî_of
(
bef‹e
, 
pxt4_io_íd_t
, 
li°
);

179 
a·î
 = 
cur
->
√xt
;

180 
io1
 = 
	`c⁄èöî_of
(
a·î
, 
pxt4_io_íd_t
, 
li°
);

182 
	`pxt4_debug
("io 0x%p from inode %lu,prev 0x%p,next 0x%p\n",

183 
io
, 
öode
->
i_öo
, 
io0
, 
io1
);

186 
	}
}

189 
	$pxt4_add_com∂ëe_io
(
pxt4_io_íd_t
 *
io_íd
)

191 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
io_íd
->
öode
);

192 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
io_íd
->
öode
->
i_sb
);

193 
w‹kqueue_°ru˘
 *
wq
;

194 
Êags
;

197 
	`WARN_ON
(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

198 
	`WARN_ON
(!
io_íd
->
h™dÀ
 && 
sbi
->
s_jou∫Æ
);

199 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

200 
wq
 = 
sbi
->
rsv_c⁄vîsi⁄_wq
;

201 i‡(
	`li°_em±y
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
))

202 
	`queue_w‹k
(
wq
, &
ei
->
i_rsv_c⁄vîsi⁄_w‹k
);

203 
	`li°_add_èû
(&
io_íd
->
li°
, &
ei
->
i_rsv_c⁄vîsi⁄_li°
);

204 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

205 
	}
}

207 
	$pxt4_do_Êush_com∂ëed_IO
(
öode
 *inode,

208 
li°_hód
 *
hód
)

210 
pxt4_io_íd_t
 *
io
;

211 
li°_hód
 
unwrôãn
;

212 
Êags
;

213 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

214 
îr
, 
ªt
 = 0;

216 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

217 
	`dump_com∂ëed_IO
(
öode
, 
hód
);

218 
	`li°_ª∂a˚_öô
(
hód
, &
unwrôãn
);

219 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

221 !
	`li°_em±y
(&
unwrôãn
)) {

222 
io
 = 
	`li°_íåy
(
unwrôãn
.
√xt
, 
pxt4_io_íd_t
, 
li°
);

223 
	`BUG_ON
(!(
io
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

224 
	`li°_dñ_öô
(&
io
->
li°
);

226 
îr
 = 
	`pxt4_íd_io
(
io
);

227 i‡(
	`u∆ikñy
(!
ªt
 && 
îr
))

228 
ªt
 = 
îr
;

230  
ªt
;

231 
	}
}

236 
	$pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
)

238 
pxt4_öode_öfo
 *
ei
 = 
	`c⁄èöî_of
(
w‹k
, pxt4_inode_info,

239 
i_rsv_c⁄vîsi⁄_w‹k
);

240 
	`pxt4_do_Êush_com∂ëed_IO
(&
ei
->
vfs_öode
, &ei->
i_rsv_c⁄vîsi⁄_li°
);

241 
	}
}

243 
pxt4_io_íd_t
 *
	$pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
)

245 
pxt4_io_íd_t
 *
io
 = 
	`kmem_ˇche_zÆloc
(
io_íd_ˇchï
, 
Êags
);

246 i‡(
io
) {

247 
io
->
öode
 = inode;

248 
	`INIT_LIST_HEAD
(&
io
->
li°
);

249 
	`©omic_£t
(&
io
->
cou¡
, 1);

251  
io
;

252 
	}
}

254 
	$pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
)

256 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

257 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
Ë|| !io_íd->
size
) {

258 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

261 
	`pxt4_add_com∂ëe_io
(
io_íd
);

263 
	}
}

265 
	$pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

267 
îr
 = 0;

269 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

270 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

271 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
io_íd
->
h™dÀ
,

272 
io_íd
->
öode
, io_íd->
off£t
,

273 
io_íd
->
size
);

274 
io_íd
->
h™dÀ
 = 
NULL
;

275 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

277 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

279  
îr
;

280 
	}
}

282 
pxt4_io_íd_t
 *
	$pxt4_gë_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

284 
	`©omic_öc
(&
io_íd
->
cou¡
);

285  
io_íd
;

286 
	}
}

289 
	$pxt4_íd_bio
(
bio
 *bio)

291 
pxt4_io_íd_t
 *
io_íd
 = 
bio
->
bi_¥iv©e
;

292 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

293 
b
[
BDEVNAME_SIZE
];

295 i‡(
	`WARN_ONCE
(!
io_íd
, "io_end is NULL: %s: sector %LuÜen %uÉrr %d\n",

296 
	`bio_dev«me
(
bio
, 
b
),

297 (Ë
bio
->
bi_ôî
.
bi_£˘‹
,

298 (Ë
	`bio_£˘‹s
(
bio
),

299 
bio
->
bi_°©us
)) {

300 
	`pxt4_föish_bio
(
bio
);

301 
	`bio_put
(
bio
);

304 
bio
->
bi_íd_io
 = 
NULL
;

306 i‡(
bio
->
bi_°©us
) {

307 
öode
 *öodê
io_íd
->inode;

309 
	`pxt4_w¨nög
(
öode
->
i_sb
, "I/OÉrror %d writingÅo inode %lu "

311 
bio
->
bi_°©us
, 
öode
->
i_öo
,

312 (Ë
io_íd
->
off£t
,

313 (Ë
io_íd
->
size
,

315 
bi_£˘‹
 >> (
öode
->
i_blkbôs
 - 9));

316 
	`m≠pög_£t_îr‹
(
öode
->
i_m≠pög
,

317 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
));

320 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

326 
bio
->
bi_¥iv©e
 = 
	`xchg
(&
io_íd
->bio, bio);

327 
	`pxt4_put_io_íd_de„r
(
io_íd
);

333 
	`pxt4_put_io_íd_de„r
(
io_íd
);

334 
	`pxt4_föish_bio
(
bio
);

335 
	`bio_put
(
bio
);

337 
	}
}

339 
	$pxt4_io_submô
(
pxt4_io_submô
 *
io
)

341 
bio
 *biÿ
io
->
io_bio
;

343 i‡(
bio
) {

344 
io_›_Êags
 = 
io
->
io_wbc
->
sync_mode
 =
WB_SYNC_ALL
 ?

345 
REQ_SYNC
 : 0;

346 
io
->
io_bio
->
bi_wrôe_höt
 = io->
io_íd
->
öode
->
i_wrôe_höt
;

347 
	`bio_£t_›_©ås
(
io
->
io_bio
, 
REQ_OP_WRITE
, 
io_›_Êags
);

348 
	`submô_bio
(
io
->
io_bio
);

350 
io
->
io_bio
 = 
NULL
;

351 
	}
}

353 
	$pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

354 
wrôeback_c⁄åﬁ
 *
wbc
)

356 
io
->
io_wbc
 = 
wbc
;

357 
io
->
io_bio
 = 
NULL
;

358 
io
->
io_íd
 = 
NULL
;

359 
	}
}

361 
	$io_submô_öô_bio
(
pxt4_io_submô
 *
io
,

362 
buf„r_hód
 *
bh
)

364 
bio
 *bio;

366 
bio
 = 
	`bio_Æloc
(
GFP_NOIO
, 
BIO_MAX_PAGES
);

367 i‡(!
bio
)

368  -
ENOMEM
;

369 
bio
->
bi_ôî
.
bi_£˘‹
 = 
bh
->
b_blockƒ
 * (bh->
b_size
 >> 9);

370 
	`bio_£t_dev
(
bio
, 
bh
->
b_bdev
);

371 
bio
->
bi_íd_io
 = 
pxt4_íd_bio
;

372 
bio
->
bi_¥iv©e
 = 
	`pxt4_gë_io_íd
(
io
->
io_íd
);

373 
io
->
io_bio
 = 
bio
;

374 
io
->
io_√xt_block
 = 
bh
->
b_blockƒ
;

375 
	`wbc_öô_bio
(
io
->
io_wbc
, 
bio
);

377 
	}
}

379 
	$io_submô_add_bh
(
pxt4_io_submô
 *
io
,

380 
öode
 *inode,

381 
∑ge
 *page,

382 
buf„r_hód
 *
bh
)

384 
ªt
;

386 i‡(
io
->
io_bio
 && 
bh
->
b_blockƒ
 !io->
io_√xt_block
) {

387 
submô_™d_ªåy
:

388 
	`pxt4_io_submô
(
io
);

390 i‡(
io
->
io_bio
 =
NULL
) {

391 
ªt
 = 
	`io_submô_öô_bio
(
io
, 
bh
);

392 i‡(
ªt
)

393  
ªt
;

394 
io
->
io_bio
->
bi_wrôe_höt
 = 
öode
->
i_wrôe_höt
;

396 
ªt
 = 
	`bio_add_∑ge
(
io
->
io_bio
, 
∑ge
, 
bh
->
b_size
, 
	`bh_off£t
(bh));

397 i‡(
ªt
 !
bh
->
b_size
)

398 
submô_™d_ªåy
;

399 
	`wbc_accou¡_cgroup_ow√r
(
io
->
io_wbc
, 
∑ge
, 
bh
->
b_size
);

400 
io
->
io_√xt_block
++;

402 
	}
}

404 
	$pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

405 
∑ge
 *page,

406 
Àn
,

407 
wrôeback_c⁄åﬁ
 *
wbc
,

408 
boﬁ
 
kìp_towrôe
)

410 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

411 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

412 
block_°¨t
;

413 
buf„r_hód
 *
bh
, *
hód
;

414 
ªt
 = 0;

415 
ƒ_submôãd
 = 0;

416 
ƒ_to_submô
 = 0;

418 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

419 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

421 i‡(
kìp_towrôe
)

422 
	`£t_∑ge_wrôeback_kìpwrôe
(
∑ge
);

424 
	`£t_∑ge_wrôeback
(
∑ge
);

425 
	`CÀ¨PageEº‹
(
∑ge
);

436 i‡(
Àn
 < 
PAGE_SIZE
)

437 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

445 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

447 
block_°¨t
 = 
	`bh_off£t
(
bh
);

448 i‡(
block_°¨t
 >
Àn
) {

449 
	`˛ór_buf„r_dúty
(
bh
);

450 
	`£t_buf„r_u±od©e
(
bh
);

453 i‡(!
	`buf„r_dúty
(
bh
Ë|| 
	`buf„r_dñay
(bh) ||

454 !
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)) {

456 i‡(!
	`buf„r_m≠≥d
(
bh
))

457 
	`˛ór_buf„r_dúty
(
bh
);

458 i‡(
io
->
io_bio
)

459 
	`pxt4_io_submô
(
io
);

462 i‡(
	`buf„r_√w
(
bh
))

463 
	`˛ór_buf„r_√w
(
bh
);

464 
	`£t_buf„r_async_wrôe
(
bh
);

465 
ƒ_to_submô
++;

466 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

468 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

477 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
Ë&& 
ƒ_to_submô
) {

478 
gÂ_t
 
gÂ_Êags
 = 
GFP_NOFS
;

479 
íc_byãs
 = 
	`round_up
(
Àn
, 
	`i_blocksize
(
öode
));

486 i‡(
io
->
io_bio
)

487 
gÂ_Êags
 = 
GFP_NOWAIT
 | 
__GFP_NOWARN
;

488 
ªåy_í¸y±
:

489 
boun˚_∑ge
 = 
	`fs¸y±_í¸y±_∑geˇche_blocks
(
∑ge
, 
íc_byãs
,

490 0, 
gÂ_Êags
);

491 i‡(
	`IS_ERR
(
boun˚_∑ge
)) {

492 
ªt
 = 
	`PTR_ERR
(
boun˚_∑ge
);

493 i‡(
ªt
 =-
ENOMEM
 &&

494 (
io
->
io_bio
 || 
wbc
->
sync_mode
 =
WB_SYNC_ALL
)) {

495 
gÂ_Êags
 = 
GFP_NOFS
;

496 i‡(
io
->
io_bio
)

497 
	`pxt4_io_submô
(
io
);

499 
gÂ_Êags
 |
__GFP_NOFAIL
;

500 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

501 
ªåy_í¸y±
;

503 
boun˚_∑ge
 = 
NULL
;

504 
out
;

510 i‡(!
	`buf„r_async_wrôe
(
bh
))

512 
ªt
 = 
	`io_submô_add_bh
(
io
, 
öode
, 
boun˚_∑ge
 ?: 
∑ge
, 
bh
);

513 i‡(
ªt
) {

521 
ƒ_submôãd
++;

522 
	`˛ór_buf„r_dúty
(
bh
);

523 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

526 i‡(
ªt
) {

527 
out
:

528 
	`fs¸y±_‰ì_boun˚_∑ge
(
boun˚_∑ge
);

529 
	`¥ötk_øãlimôed
(
KERN_ERR
 "%s:Ñë = %d\n", 
__func__
, 
ªt
);

530 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

532 
	`˛ór_buf„r_async_wrôe
(
bh
);

533 
bh
 = bh->
b_this_∑ge
;

534 } 
bh
 !
hód
);

536 
	`u∆ock_∑ge
(
∑ge
);

538 i‡(!
ƒ_submôãd
)

539 
	`íd_∑ge_wrôeback
(
∑ge
);

540  
ªt
;

541 
	}
}

	@readpage.c

31 
	~<löux/kî√l.h
>

32 
	~<löux/exp‹t.h
>

33 
	~<löux/mm.h
>

34 
	~<löux/kdev_t.h
>

35 
	~<löux/gÂ.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/fs.h
>

38 
	~<löux/buf„r_hód.h
>

39 
	~<löux/blkdev.h
>

40 
	~<löux/highmem.h
>

41 
	~<löux/¥e„tch.h
>

42 
	~<löux/m∑ge.h
>

43 
	~<löux/wrôeback.h
>

44 
	~<löux/backög-dev.h
>

45 
	~<löux/∑gevec.h
>

46 
	~<löux/˛ónˇche.h
>

48 
	~"pxt4.h
"

50 
	#NUM_PREALLOC_POST_READ_CTXS
 128

	)

52 
kmem_ˇche
 *
	gbio_po°_ªad_˘x_ˇche
;

53 
mempoﬁ_t
 *
	gbio_po°_ªad_˘x_poﬁ
;

56 
	ebio_po°_ªad_°ï
 {

57 
	mSTEP_INITIAL
 = 0,

58 
	mSTEP_DECRYPT
,

59 
	mSTEP_VERITY
,

60 
	mSTEP_MAX
,

63 
	sbio_po°_ªad_˘x
 {

64 
bio
 *
	mbio
;

65 
w‹k_°ru˘
 
	mw‹k
;

66 
	mcur_°ï
;

67 
	míabÀd_°ïs
;

70 
	$__ªad_íd_io
(
bio
 *bio)

72 
∑ge
 *page;

73 
bio_vec
 *
bv
;

74 
bvec_ôî_Æl
 
ôî_Æl
;

76 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
bio
, 
ôî_Æl
) {

77 
∑ge
 = 
bv
->
bv_∑ge
;

80 i‡(
bio
->
bi_°©us
 || 
	`PageEº‹
(
∑ge
)) {

81 
	`CÀ¨PageU±od©e
(
∑ge
);

83 
	`CÀ¨PageEº‹
(
∑ge
);

85 
	`SëPageU±od©e
(
∑ge
);

87 
	`u∆ock_∑ge
(
∑ge
);

89 i‡(
bio
->
bi_¥iv©e
)

90 
	`mempoﬁ_‰ì
(
bio
->
bi_¥iv©e
, 
bio_po°_ªad_˘x_poﬁ
);

91 
	`bio_put
(
bio
);

92 
	}
}

94 
bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
);

96 
	$de¸y±_w‹k
(
w‹k_°ru˘
 *
w‹k
)

98 
bio_po°_ªad_˘x
 *
˘x
 =

99 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

101 
	`fs¸y±_de¸y±_bio
(
˘x
->
bio
);

103 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

104 
	}
}

106 
	$vîôy_w‹k
(
w‹k_°ru˘
 *
w‹k
)

108 
bio_po°_ªad_˘x
 *
˘x
 =

109 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

110 
bio
 *biÿ
˘x
->bio;

119 
	`BUILD_BUG_ON
(
STEP_VERITY
 + 1 !
STEP_MAX
);

120 
	`mempoﬁ_‰ì
(
˘x
, 
bio_po°_ªad_˘x_poﬁ
);

121 
bio
->
bi_¥iv©e
 = 
NULL
;

123 
	`fsvîôy_vîify_bio
(
bio
);

125 
	`__ªad_íd_io
(
bio
);

126 
	}
}

128 
	$bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
)

135 ++
˘x
->
cur_°ï
) {

136 
STEP_DECRYPT
:

137 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_DECRYPT
)) {

138 
	`INIT_WORK
(&
˘x
->
w‹k
, 
de¸y±_w‹k
);

139 
	`fs¸y±_íqueue_de¸y±_w‹k
(&
˘x
->
w‹k
);

142 
˘x
->
cur_°ï
++;

144 
STEP_VERITY
:

145 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_VERITY
)) {

146 
	`INIT_WORK
(&
˘x
->
w‹k
, 
vîôy_w‹k
);

147 
	`fsvîôy_íqueue_vîify_w‹k
(&
˘x
->
w‹k
);

150 
˘x
->
cur_°ï
++;

153 
	`__ªad_íd_io
(
˘x
->
bio
);

155 
	}
}

157 
boﬁ
 
	$bio_po°_ªad_ªquúed
(
bio
 *bio)

159  
bio
->
bi_¥iv©e
 && !bio->
bi_°©us
;

160 
	}
}

174 
	$m∑ge_íd_io
(
bio
 *bio)

176 i‡(
	`bio_po°_ªad_ªquúed
(
bio
)) {

177 
bio_po°_ªad_˘x
 *
˘x
 = 
bio
->
bi_¥iv©e
;

179 
˘x
->
cur_°ï
 = 
STEP_INITIAL
;

180 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

183 
	`__ªad_íd_io
(
bio
);

184 
	}
}

186 
ölöe
 
boﬁ
 
	$pxt4_√ed_vîôy
(c⁄° 
öode
 *öode, 
pgoff_t
 
idx
)

188  
	`fsvîôy_a˘ive
(
öode
) &&

189 
idx
 < 
	`DIV_ROUND_UP
(
öode
->
i_size
, 
PAGE_SIZE
);

190 
	}
}

192 
bio_po°_ªad_˘x
 *
	$gë_bio_po°_ªad_˘x
(
öode
 *inode,

193 
bio
 *bio,

194 
pgoff_t
 
fú°_idx
)

196 
po°_ªad_°ïs
 = 0;

197 
bio_po°_ªad_˘x
 *
˘x
 = 
NULL
;

199 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

200 
po°_ªad_°ïs
 |1 << 
STEP_DECRYPT
;

202 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
fú°_idx
))

203 
po°_ªad_°ïs
 |1 << 
STEP_VERITY
;

205 i‡(
po°_ªad_°ïs
) {

206 
˘x
 = 
	`mempoﬁ_Æloc
(
bio_po°_ªad_˘x_poﬁ
, 
GFP_NOFS
);

207 i‡(!
˘x
)

208  
	`ERR_PTR
(-
ENOMEM
);

209 
˘x
->
bio
 = bio;

210 
˘x
->
íabÀd_°ïs
 = 
po°_ªad_°ïs
;

211 
bio
->
bi_¥iv©e
 = 
˘x
;

213  
˘x
;

214 
	}
}

216 
ölöe
 
loff_t
 
	$pxt4_ªad∑ge_limô
(
öode
 *inode)

218 i‡(
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

219 (
	`IS_VERITY
(
öode
Ë|| 
	`pxt4_vîôy_ö_¥ogªss
(inode)))

220  
öode
->
i_sb
->
s_maxbyãs
;

222  
	`i_size_ªad
(
öode
);

223 
	}
}

225 
	$pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

226 
li°_hód
 *
∑ges
, 
∑ge
 *page,

227 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
)

229 
bio
 *biÿ
NULL
;

230 
£˘‹_t
 
œ°_block_ö_bio
 = 0;

232 
öode
 *öodê
m≠pög
->
ho°
;

233 c⁄° 
blkbôs
 = 
öode
->
i_blkbôs
;

234 c⁄° 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
blkbôs
;

235 c⁄° 
blocksize
 = 1 << 
blkbôs
;

236 
£˘‹_t
 
block_ö_fûe
;

237 
£˘‹_t
 
œ°_block
;

238 
£˘‹_t
 
œ°_block_ö_fûe
;

239 
£˘‹_t
 
blocks
[
MAX_BUF_PER_PAGE
];

240 
∑ge_block
;

241 
block_devi˚
 *
bdev
 = 
öode
->
i_sb
->
s_bdev
;

242 
Àngth
;

243 
ªœtive_block
 = 0;

244 
pxt4_m≠_blocks
 
m≠
;

246 
m≠
.
m_pblk
 = 0;

247 
m≠
.
m_lblk
 = 0;

248 
m≠
.
m_Àn
 = 0;

249 
m≠
.
m_Êags
 = 0;

251 ; 
ƒ_∑ges
;Çr_pages--) {

252 
fuŒy_m≠≥d
 = 1;

253 
fú°_hﬁe
 = 
blocks_≥r_∑ge
;

255 i‡(
∑ges
) {

256 
∑ge
 = 
	`Ãu_to_∑ge
(
∑ges
);

258 
	`¥e„tchw
(&
∑ge
->
Êags
);

259 
	`li°_dñ
(&
∑ge
->
Ãu
);

260 i‡(
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
,Öage->
ödex
,

261 
	`ªadahód_gÂ_mask
(
m≠pög
)))

262 
√xt_∑ge
;

265 i‡(
	`∑ge_has_buf„rs
(
∑ge
))

266 
c⁄fu£d
;

268 
block_ö_fûe
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
blkbôs
);

269 
œ°_block
 = 
block_ö_fûe
 + 
ƒ_∑ges
 * 
blocks_≥r_∑ge
;

270 
œ°_block_ö_fûe
 = (
	`pxt4_ªad∑ge_limô
(
öode
) +

271 
blocksize
 - 1Ë>> 
blkbôs
;

272 i‡(
œ°_block
 > 
œ°_block_ö_fûe
)

273 
œ°_block
 = 
œ°_block_ö_fûe
;

274 
∑ge_block
 = 0;

279 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) &&

280 
block_ö_fûe
 > 
m≠
.
m_lblk
 &&

281 
block_ö_fûe
 < (
m≠
.
m_lblk
 + m≠.
m_Àn
)) {

282 
m≠_off£t
 = 
block_ö_fûe
 - 
m≠
.
m_lblk
;

283 
œ°
 = 
m≠
.
m_Àn
 - 
m≠_off£t
;

285 
ªœtive_block
 = 0; ;Ñelative_block++) {

286 i‡(
ªœtive_block
 =
œ°
) {

288 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

291 i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

293 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
 + 
m≠_off£t
 +

294 
ªœtive_block
;

295 
∑ge_block
++;

296 
block_ö_fûe
++;

304 
∑ge_block
 < 
blocks_≥r_∑ge
) {

305 i‡(
block_ö_fûe
 < 
œ°_block
) {

306 
m≠
.
m_lblk
 = 
block_ö_fûe
;

307 
m≠
.
m_Àn
 = 
œ°_block
 - 
block_ö_fûe
;

309 i‡(
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0) < 0) {

310 
£t_îr‹_∑ge
:

311 
	`SëPageEº‹
(
∑ge
);

312 
	`zîo_u£r_£gmít
(
∑ge
, 0,

313 
PAGE_SIZE
);

314 
	`u∆ock_∑ge
(
∑ge
);

315 
√xt_∑ge
;

318 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) == 0) {

319 
fuŒy_m≠≥d
 = 0;

320 i‡(
fú°_hﬁe
 =
blocks_≥r_∑ge
)

321 
fú°_hﬁe
 = 
∑ge_block
;

322 
∑ge_block
++;

323 
block_ö_fûe
++;

326 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
)

327 
c⁄fu£d
;

330 i‡(
∑ge_block
 && 
blocks
[∑ge_block-1] !
m≠
.
m_pblk
-1)

331 
c⁄fu£d
;

332 
ªœtive_block
 = 0; ;Ñelative_block++) {

333 i‡(
ªœtive_block
 =
m≠
.
m_Àn
) {

335 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

337 } i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

339 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
+
ªœtive_block
;

340 
∑ge_block
++;

341 
block_ö_fûe
++;

344 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
) {

345 
	`zîo_u£r_£gmít
(
∑ge
, 
fú°_hﬁe
 << 
blkbôs
,

346 
PAGE_SIZE
);

347 i‡(
fú°_hﬁe
 == 0) {

348 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
∑ge
->
ödex
) &&

349 !
	`fsvîôy_vîify_∑ge
(
∑ge
))

350 
£t_îr‹_∑ge
;

351 
	`SëPageU±od©e
(
∑ge
);

352 
	`u∆ock_∑ge
(
∑ge
);

353 
√xt_∑ge
;

355 } i‡(
fuŒy_m≠≥d
) {

356 
	`SëPageM≠≥dToDisk
(
∑ge
);

358 i‡(
fuŒy_m≠≥d
 && 
blocks_≥r_∑ge
 == 1 &&

359 !
	`PageU±od©e
(
∑ge
Ë&& 
	`˛ónˇche_gë_∑ge
(page) == 0) {

360 
	`SëPageU±od©e
(
∑ge
);

361 
c⁄fu£d
;

368 i‡(
bio
 && (
œ°_block_ö_bio
 !
blocks
[0] - 1)) {

369 
submô_™d_ªÆloc
:

370 
	`submô_bio
(
bio
);

371 
bio
 = 
NULL
;

373 i‡(
bio
 =
NULL
) {

374 
bio_po°_ªad_˘x
 *
˘x
;

376 
bio
 = 
	`bio_Æloc
(
GFP_KERNEL
,

377 
	`mö_t
(, 
ƒ_∑ges
, 
BIO_MAX_PAGES
));

378 i‡(!
bio
)

379 
£t_îr‹_∑ge
;

380 
˘x
 = 
	`gë_bio_po°_ªad_˘x
(
öode
, 
bio
, 
∑ge
->
ödex
);

381 i‡(
	`IS_ERR
(
˘x
)) {

382 
	`bio_put
(
bio
);

383 
bio
 = 
NULL
;

384 
£t_îr‹_∑ge
;

386 
	`bio_£t_dev
(
bio
, 
bdev
);

387 
bio
->
bi_ôî
.
bi_£˘‹
 = 
blocks
[0] << (
blkbôs
 - 9);

388 
bio
->
bi_íd_io
 = 
m∑ge_íd_io
;

389 
bio
->
bi_¥iv©e
 = 
˘x
;

390 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_READ
,

391 
is_ªadahód
 ? 
REQ_RAHEAD
 : 0);

394 
Àngth
 = 
fú°_hﬁe
 << 
blkbôs
;

395 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àngth
, 0) <Üength)

396 
submô_™d_ªÆloc
;

398 i‡(((
m≠
.
m_Êags
 & 
PXT4_MAP_BOUNDARY
) &&

399 (
ªœtive_block
 =
m≠
.
m_Àn
)) ||

400 (
fú°_hﬁe
 !
blocks_≥r_∑ge
)) {

401 
	`submô_bio
(
bio
);

402 
bio
 = 
NULL
;

404 
œ°_block_ö_bio
 = 
blocks
[
blocks_≥r_∑ge
 - 1];

405 
√xt_∑ge
;

406 
c⁄fu£d
:

407 i‡(
bio
) {

408 
	`submô_bio
(
bio
);

409 
bio
 = 
NULL
;

411 i‡(!
	`PageU±od©e
(
∑ge
))

412 
	`block_ªad_fuŒ_∑ge
(
∑ge
, 
pxt4_gë_block
);

414 
	`u∆ock_∑ge
(
∑ge
);

415 
√xt_∑ge
:

416 i‡(
∑ges
)

417 
	`put_∑ge
(
∑ge
);

419 
	`BUG_ON
(
∑ges
 && !
	`li°_em±y
(pages));

420 i‡(
bio
)

421 
	`submô_bio
(
bio
);

423 
	}
}

425 
__öô
 
	$pxt4_öô_po°_ªad_¥o˚ssög
()

427 
bio_po°_ªad_˘x_ˇche
 =

428 
	`kmem_ˇche_¸óã
("pxt4_bio_post_read_ctx",

429 (
bio_po°_ªad_˘x
), 0, 0, 
NULL
);

430 i‡(!
bio_po°_ªad_˘x_ˇche
)

431 
Áû
;

432 
bio_po°_ªad_˘x_poﬁ
 =

433 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
NUM_PREALLOC_POST_READ_CTXS
,

434 
bio_po°_ªad_˘x_ˇche
);

435 i‡(!
bio_po°_ªad_˘x_poﬁ
)

436 
Áû_‰ì_ˇche
;

439 
Áû_‰ì_ˇche
:

440 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

441 
Áû
:

442  -
ENOMEM
;

443 
	}
}

445 
	$pxt4_exô_po°_ªad_¥o˚ssög
()

447 
	`mempoﬁ_de°roy
(
bio_po°_ªad_˘x_poﬁ
);

448 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

449 
	}
}

	@resize.c

13 
	#PXT4FS_DEBUG


	)

15 
	~<löux/î∫o.h
>

16 
	~<löux/¶ab.h
>

18 
	~"pxt4_jbd3.h
"

20 
	spxt4_rcu_±r
 {

21 
rcu_hód
 
	mrcu
;

22 *
	m±r
;

25 
	$pxt4_rcu_±r_ˇŒback
(
rcu_hód
 *
hód
)

27 
pxt4_rcu_±r
 *
±r
;

29 
±r
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_rcu_±r
, 
rcu
);

30 
	`kv‰ì
(
±r
->ptr);

31 
	`k‰ì
(
±r
);

32 
	}
}

34 
	$pxt4_kv‰ì_¨øy_rcu
(*
to_‰ì
)

36 
pxt4_rcu_±r
 *
±r
 = 
	`kzÆloc
((*±r), 
GFP_KERNEL
);

38 i‡(
±r
) {

39 
±r
->±∏
to_‰ì
;

40 
	`ˇŒ_rcu
(&
±r
->
rcu
, 
pxt4_rcu_±r_ˇŒback
);

43 
	`synchr⁄ize_rcu
();

44 
	`kv‰ì
(
to_‰ì
);

45 
	}
}

47 
	$pxt4_ªsize_begö
(
su≥r_block
 *
sb
)

49 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

50 
ªt
 = 0;

52 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

53  -
EPERM
;

60 i‡(
	`PXT4_B2C
(
sbi
, sbi->
s_sbh
->
b_blockƒ
) !=

61 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) {

62 
	`pxt4_w¨nög
(
sb
, "won'tÑesize using backup superblockát %llu",

63 ()
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
);

64  -
EPERM
;

71 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

72 
	`pxt4_w¨nög
(
sb
, "ThereáreÉrrors inÅhe filesystem, "

74  -
EPERM
;

77 i‡(
	`ã°_™d_£t_bô_lock
(
PXT4_FLAGS_RESIZING
,

78 &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
))

79 
ªt
 = -
EBUSY
;

81  
ªt
;

82 
	}
}

84 
	$pxt4_ªsize_íd
(
su≥r_block
 *
sb
)

86 
	`˛ór_bô_u∆ock
(
PXT4_FLAGS_RESIZING
, &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
);

87 
	`smp_mb__a·î_©omic
();

88 
	}
}

90 
pxt4_group_t
 
	$pxt4_mëa_bg_fú°_group
(
su≥r_block
 *
sb
,

91 
pxt4_group_t
 
group
) {

92  (
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)) <<

93 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

94 
	}
}

96 
pxt4_fsblk_t
 
	$pxt4_mëa_bg_fú°_block_no
(
su≥r_block
 *
sb
,

97 
pxt4_group_t
 
group
) {

98 
group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, group);

99  
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

100 
	}
}

102 
pxt4_gΩblk_t
 
	$pxt4_group_ovîhód_blocks
(
su≥r_block
 *
sb
,

103 
pxt4_group_t
 
group
) {

104 
pxt4_gΩblk_t
 
ovîhód
;

105 
ovîhód
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

106 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

107 
ovîhód
 += 1 +

108 
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

109  
ovîhód
;

110 
	}
}

112 
	#outside
(
b
, 
fú°
, 
œ°
Ë((bË< (fú°Ë|| (bË>÷a°))

	)

113 
	#öside
(
b
, 
fú°
, 
œ°
Ë((bË>(fú°Ë&& (bË< (œ°))

	)

115 
	$vîify_group_öput
(
su≥r_block
 *
sb
,

116 
pxt4_√w_group_d©a
 *
öput
)

118 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

119 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

120 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_blocks_cou¡
(
es
);

121 
pxt4_fsblk_t
 
íd
 = 
°¨t
 + 
öput
->
blocks_cou¡
;

122 
pxt4_group_t
 
group
 = 
öput
->group;

123 
pxt4_fsblk_t
 
ôíd
 = 
öput
->
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
;

124 
ovîhód
;

125 
pxt4_fsblk_t
 
më´nd
;

126 
buf„r_hód
 *
bh
 = 
NULL
;

127 
pxt4_gΩblk_t
 
‰ì_blocks_cou¡
, 
off£t
;

128 
îr
 = -
EINVAL
;

130 i‡(
group
 !
sbi
->
s_groups_cou¡
) {

131 
	`pxt4_w¨nög
(
sb
, "Cannotáddát group %u (only %u groups)",

132 
öput
->
group
, 
sbi
->
s_groups_cou¡
);

133  -
EINVAL
;

136 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

137 
më´nd
 = 
°¨t
 + 
ovîhód
;

138 
öput
->
‰ì_˛u°îs_cou¡
 = 
‰ì_blocks_cou¡
 =

139 
öput
->
blocks_cou¡
 - 2 - 
ovîhód
 - 
sbi
->
s_ôb_≥r_group
;

141 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

142 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádding %s group %u: %u blocks "

144 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ? "normal" :

145 "no-su≥r", 
öput
->
group
, i≈ut->
blocks_cou¡
,

146 
‰ì_blocks_cou¡
, 
öput
->
ª£rved_blocks
);

148 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t
, 
NULL
, &
off£t
);

149 i‡(
off£t
 != 0)

150 
	`pxt4_w¨nög
(
sb
, "Last groupÇot full");

151 i‡(
öput
->
ª£rved_blocks
 > i≈ut->
blocks_cou¡
 / 5)

152 
	`pxt4_w¨nög
(
sb
, "Reserved blocksÅoo high (%u)",

153 
öput
->
ª£rved_blocks
);

154 i‡(
‰ì_blocks_cou¡
 < 0)

155 
	`pxt4_w¨nög
(
sb
, "Bad blocks count %u",

156 
öput
->
blocks_cou¡
);

157 i‡(
	`IS_ERR
(
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
íd
 - 1, 0))) {

158 
îr
 = 
	`PTR_ERR
(
bh
);

159 
bh
 = 
NULL
;

160 
	`pxt4_w¨nög
(
sb
, "CannotÑeadÜast block (%llu)",

161 
íd
 - 1);

162 } i‡(
	`outside
(
öput
->
block_bôm≠
, 
°¨t
, 
íd
))

163 
	`pxt4_w¨nög
(
sb
, "Block bitmapÇot in group (block %llu)",

164 ()
öput
->
block_bôm≠
);

165 i‡(
	`outside
(
öput
->
öode_bôm≠
, 
°¨t
, 
íd
))

166 
	`pxt4_w¨nög
(
sb
, "Inode bitmapÇot in group (block %llu)",

167 ()
öput
->
öode_bôm≠
);

168 i‡(
	`outside
(
öput
->
öode_èbÀ
, 
°¨t
, 
íd
) ||

169 
	`outside
(
ôíd
 - 1, 
°¨t
, 
íd
))

170 
	`pxt4_w¨nög
(
sb
, "InodeÅableÇot in group (blocks %llu-%llu)",

171 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

172 i‡(
öput
->
öode_bôm≠
 =öput->
block_bôm≠
)

173 
	`pxt4_w¨nög
(
sb
, "Block bitmap sameás inode bitmap (%llu)",

174 ()
öput
->
block_bôm≠
);

175 i‡(
	`öside
(
öput
->
block_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

176 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in inodeÅable "

178 ()
öput
->
block_bôm≠
,

179 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

180 i‡(
	`öside
(
öput
->
öode_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

181 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in inodeÅable "

183 ()
öput
->
öode_bôm≠
,

184 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

185 i‡(
	`öside
(
öput
->
block_bôm≠
, 
°¨t
, 
më´nd
))

186 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in GDTÅable (%llu-%llu)",

187 ()
öput
->
block_bôm≠
,

188 
°¨t
, 
më´nd
 - 1);

189 i‡(
	`öside
(
öput
->
öode_bôm≠
, 
°¨t
, 
më´nd
))

190 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in GDTÅable (%llu-%llu)",

191 ()
öput
->
öode_bôm≠
,

192 
°¨t
, 
më´nd
 - 1);

193 i‡(
	`öside
(
öput
->
öode_èbÀ
, 
°¨t
, 
më´nd
) ||

194 
	`öside
(
ôíd
 - 1, 
°¨t
, 
më´nd
))

195 
	`pxt4_w¨nög
(
sb
, "InodeÅable (%llu-%llu) overlaps GDTÅable "

197 ()
öput
->
öode_èbÀ
,

198 
ôíd
 - 1, 
°¨t
, 
më´nd
 - 1);

200 
îr
 = 0;

201 
	`bªl£
(
bh
);

203  
îr
;

204 
	}
}

210 
	spxt4_√w_Êex_group_d©a
 {

211 
pxt4_√w_group_d©a
 *
	mgroups
;

213 
__u16
 *
	mbg_Êags
;

215 
pxt4_group_t
 
	mcou¡
;

225 
pxt4_√w_Êex_group_d©a
 *
	$Æloc_Êex_gd
(
Êexbg_size
)

227 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
;

229 
Êex_gd
 = 
	`kmÆloc
((*Êex_gd), 
GFP_NOFS
);

230 i‡(
Êex_gd
 =
NULL
)

231 
out3
;

233 i‡(
Êexbg_size
 >
UINT_MAX
 / (
pxt4_√w_group_d©a
))

234 
out2
;

235 
Êex_gd
->
cou¡
 = 
Êexbg_size
;

237 
Êex_gd
->
groups
 = 
	`kmÆloc_¨øy
(
Êexbg_size
,

238 (
pxt4_√w_group_d©a
),

239 
GFP_NOFS
);

240 i‡(
Êex_gd
->
groups
 =
NULL
)

241 
out2
;

243 
Êex_gd
->
bg_Êags
 = 
	`kmÆloc_¨øy
(
Êexbg_size
, (
__u16
),

244 
GFP_NOFS
);

245 i‡(
Êex_gd
->
bg_Êags
 =
NULL
)

246 
out1
;

248  
Êex_gd
;

250 
out1
:

251 
	`k‰ì
(
Êex_gd
->
groups
);

252 
out2
:

253 
	`k‰ì
(
Êex_gd
);

254 
out3
:

255  
NULL
;

256 
	}
}

258 
	$‰ì_Êex_gd
(
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

260 
	`k‰ì
(
Êex_gd
->
bg_Êags
);

261 
	`k‰ì
(
Êex_gd
->
groups
);

262 
	`k‰ì
(
Êex_gd
);

263 
	}
}

278 
	$pxt4_Æloc_group_èbÀs
(
su≥r_block
 *
sb
,

279 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

280 
Êexbg_size
)

282 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

283 
pxt4_fsblk_t
 
°¨t_blk
;

284 
pxt4_fsblk_t
 
œ°_blk
;

285 
pxt4_group_t
 
§c_group
;

286 
pxt4_group_t
 
bb_ödex
 = 0;

287 
pxt4_group_t
 
ib_ödex
 = 0;

288 
pxt4_group_t
 
ô_ödex
 = 0;

289 
pxt4_group_t
 
group
;

290 
pxt4_group_t
 
œ°_group
;

291 
ovîhód
;

292 
__u16
 
unöô_mask
 = (
Êexbg_size
 > 1Ë? ~
PXT4_BG_BLOCK_UNINIT
 : ~0;

293 
i
;

295 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

297 
§c_group
 = 
group_d©a
[0].
group
;

298 
œ°_group
 = 
§c_group
 + 
Êex_gd
->
cou¡
 - 1;

300 
	`BUG_ON
((
Êexbg_size
 > 1Ë&& ((
§c_group
 & ~(flexbg_size - 1)) !=

301 (
œ°_group
 & ~(
Êexbg_size
 - 1))));

302 
√xt_group
:

303 
group
 = 
group_d©a
[0].group;

304 i‡(
§c_group
 >
group_d©a
[0].
group
 + 
Êex_gd
->
cou¡
)

305  -
ENOSPC
;

306 
°¨t_blk
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
§c_group
);

307 
œ°_blk
 = 
°¨t_blk
 + 
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

309 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

311 
°¨t_blk
 +
ovîhód
;

314 
§c_group
++;

315 ; 
§c_group
 <
œ°_group
; src_group++) {

316 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

317 i‡(
ovîhód
 == 0)

318 
œ°_blk
 +
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

324 ; 
bb_ödex
 < 
Êex_gd
->
cou¡
; bb_index++) {

325 i‡(
°¨t_blk
 >
œ°_blk
)

326 
√xt_group
;

327 
group_d©a
[
bb_ödex
].
block_bôm≠
 = 
°¨t_blk
++;

328 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

329 
group
 -
group_d©a
[0].group;

330 
group_d©a
[
group
].
md©a_blocks
++;

331 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

335 ; 
ib_ödex
 < 
Êex_gd
->
cou¡
; ib_index++) {

336 i‡(
°¨t_blk
 >
œ°_blk
)

337 
√xt_group
;

338 
group_d©a
[
ib_ödex
].
öode_bôm≠
 = 
°¨t_blk
++;

339 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

340 
group
 -
group_d©a
[0].group;

341 
group_d©a
[
group
].
md©a_blocks
++;

342 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

346 ; 
ô_ödex
 < 
Êex_gd
->
cou¡
; it_index++) {

347 
ôb
 = 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

348 
pxt4_fsblk_t
 
√xt_group_°¨t
;

350 i‡(
°¨t_blk
 + 
ôb
 > 
œ°_blk
)

351 
√xt_group
;

352 
group_d©a
[
ô_ödex
].
öode_èbÀ
 = 
°¨t_blk
;

353 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
);

354 
√xt_group_°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
 + 1);

355 
group
 -
group_d©a
[0].group;

357 i‡(
°¨t_blk
 + 
ôb
 > 
√xt_group_°¨t
) {

358 
Êex_gd
->
bg_Êags
[
group
 + 1] &
unöô_mask
;

359 
ovîhód
 = 
°¨t_blk
 + 
ôb
 - 
√xt_group_°¨t
;

360 
group_d©a
[
group
 + 1].
md©a_blocks
 +
ovîhód
;

361 
ôb
 -
ovîhód
;

364 
group_d©a
[
group
].
md©a_blocks
 +
ôb
;

365 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

366 
°¨t_blk
 +
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

370 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

371 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 -=

372 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

373 
group_d©a
[
i
].
md©a_blocks
);

376 i‡(
	`ã°_›t
(
sb
, 
DEBUG
)) {

377 
i
;

378 
group
 = 
group_d©a
[0].group;

380 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:áddingá flex group with "

381 "%d groups, fÀxbg sizêi†%d:\n", 
Êex_gd
->
cou¡
,

382 
Êexbg_size
);

384 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

385 
	`pxt4_debug
(

387 
	`pxt4_bg_has_su≥r
(
sb
, 
group
 + 
i
) ? "normal" :

388 "no-su≥r", 
group
 + 
i
,

389 
group_d©a
[
i
].
blocks_cou¡
,

390 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
,

391 
group_d©a
[
i
].
md©a_blocks
);

395 
	}
}

397 
buf„r_hód
 *
	$b˛ón
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

398 
pxt4_fsblk_t
 
blk
)

400 
buf„r_hód
 *
bh
;

401 
îr
;

403 
bh
 = 
	`sb_gëblk
(
sb
, 
blk
);

404 i‡(
	`u∆ikñy
(!
bh
))

405  
	`ERR_PTR
(-
ENOMEM
);

406 
	`BUFFER_TRACE
(
bh
, "get_write_access");

407 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

408 
	`bªl£
(
bh
);

409 
bh
 = 
	`ERR_PTR
(
îr
);

411 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

412 
	`£t_buf„r_u±od©e
(
bh
);

415  
bh
;

416 
	}
}

423 
	$exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
thªsh
)

425 
îr
;

427 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
thªsh
))

430 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

431 i‡(
îr
 < 0)

432  
îr
;

433 i‡(
îr
) {

434 
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

435 i‡(
îr
)

436  
îr
;

440 
	}
}

451 
	$£t_Êexbg_block_bôm≠
(
su≥r_block
 *
sb
, 
h™dÀ_t
 *
h™dÀ
,

452 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

453 
pxt4_fsblk_t
 
fú°_˛u°î
,Öxt4_fsblk_à
œ°_˛u°î
)

455 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

456 
pxt4_group_t
 
cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

457 
pxt4_group_t
 
cou¡2
;

459 
	`pxt4_debug
("m¨k clu°î†[%Œu-%Œu] u£d\n", 
fú°_˛u°î
,

460 
œ°_˛u°î
);

461 
cou¡2
 = 
cou¡
; count > 0;

462 
cou¡
 -
cou¡2
, 
fú°_˛u°î
 += count2) {

463 
pxt4_fsblk_t
 
°¨t
;

464 
buf„r_hód
 *
bh
;

465 
pxt4_group_t
 
group
;

466 
îr
;

468 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
));

469 
°¨t
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

470 
group
 -
Êex_gd
->
groups
[0].group;

472 
cou¡2
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
fú°_˛u°î
 - 
°¨t
);

473 i‡(
cou¡2
 > 
cou¡
)

474 
cou¡2
 = 
cou¡
;

476 i‡(
Êex_gd
->
bg_Êags
[
group
] & 
PXT4_BG_BLOCK_UNINIT
) {

477 
	`BUG_ON
(
Êex_gd
->
cou¡
 > 1);

481 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

482 i‡(
îr
)

483  
îr
;

485 
bh
 = 
	`sb_gëblk
(
sb
, 
Êex_gd
->
groups
[
group
].
block_bôm≠
);

486 i‡(
	`u∆ikñy
(!
bh
))

487  -
ENOMEM
;

489 
	`BUFFER_TRACE
(
bh
, "get_write_access");

490 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

491 i‡(
îr
) {

492 
	`bªl£
(
bh
);

493  
îr
;

495 
	`pxt4_debug
("mark block bitmap %#04llx (+%llu/%u)\n",

496 
fú°_˛u°î
, fú°_˛u°î - 
°¨t
, 
cou¡2
);

497 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 
fú°_˛u°î
 - 
°¨t
, 
cou¡2
);

499 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

500 
	`bªl£
(
bh
);

501 i‡(
	`u∆ikñy
(
îr
))

502  
îr
;

506 
	}
}

522 
	$£tup_√w_Êex_group_blocks
(
su≥r_block
 *
sb
,

523 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

525 
group_èbÀ_cou¡
[] = {1, 1, 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
};

526 
pxt4_fsblk_t
 
°¨t
;

527 
pxt4_fsblk_t
 
block
;

528 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

529 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

530 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

531 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

532 
h™dÀ_t
 *
h™dÀ
;

533 
pxt4_group_t
 
group
, 
cou¡
;

534 
buf„r_hód
 *
bh
 = 
NULL
;

535 
ª£rved_gdb
, 
i
, 
j
, 
îr
 = 0, 
îr2
;

536 
mëa_bg
;

538 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !
group_d©a
 ||

539 
group_d©a
[0].
group
 !
sbi
->
s_groups_cou¡
);

541 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

542 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

545 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

546 i‡(
	`IS_ERR
(
h™dÀ
))

547  
	`PTR_ERR
(
h™dÀ
);

549 
group
 = 
group_d©a
[0].group;

550 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group
++) {

551 
gdblocks
;

552 
pxt4_gΩblk_t
 
ovîhód
;

554 
gdblocks
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

555 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

557 i‡(
mëa_bg
 =0 && !
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

558 
h™dÀ_ôb
;

560 i‡(
mëa_bg
 == 1) {

561 
pxt4_group_t
 
fú°_group
;

562 
fú°_group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, 
group
);

563 i‡(
fú°_group
 !
group
 + 1 &&

564 
fú°_group
 !
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1)

565 
h™dÀ_ôb
;

568 
block
 = 
°¨t
 + 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

570 
j
 = 0; j < 
gdblocks
; j++, 
block
++) {

571 
buf„r_hód
 *
gdb
;

573 
	`pxt4_debug
("upd©êbacku∞grou∞%#04Œx\n", 
block
);

574 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

575 i‡(
îr
)

576 
out
;

578 
gdb
 = 
	`sb_gëblk
(
sb
, 
block
);

579 i‡(
	`u∆ikñy
(!
gdb
)) {

580 
îr
 = -
ENOMEM
;

581 
out
;

584 
	`BUFFER_TRACE
(
gdb
, "get_write_access");

585 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb
);

586 i‡(
îr
) {

587 
	`bªl£
(
gdb
);

588 
out
;

590 
	`mem˝y
(
gdb
->
b_d©a
, 
	`sbi_¨øy_rcu_dîef
(
sbi
,

591 
s_group_desc
, 
j
)->
b_d©a
, 
gdb
->
b_size
);

592 
	`£t_buf„r_u±od©e
(
gdb
);

594 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb
);

595 i‡(
	`u∆ikñy
(
îr
)) {

596 
	`bªl£
(
gdb
);

597 
out
;

599 
	`bªl£
(
gdb
);

605 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
)) {

606 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
gdblocks
 + 
°¨t
 + 1,

607 
ª£rved_gdb
, 
GFP_NOFS
);

608 i‡(
îr
)

609 
out
;

612 
h™dÀ_ôb
:

614 i‡(!(
bg_Êags
[
i
] & 
PXT4_BG_INODE_ZEROED
))

615 
h™dÀ_bb
;

618 
block
 = 
group_d©a
[
i
].
öode_èbÀ
;

619 
	`pxt4_debug
("clear inodeÅable blocks %#04llx -> %#04lx\n",

620 
block
, 
sbi
->
s_ôb_≥r_group
);

621 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
block
, 
sbi
->
s_ôb_≥r_group
,

622 
GFP_NOFS
);

623 i‡(
îr
)

624 
out
;

626 
h™dÀ_bb
:

627 i‡(
bg_Êags
[
i
] & 
PXT4_BG_BLOCK_UNINIT
)

628 
h™dÀ_ib
;

631 
block
 = 
group_d©a
[
i
].
block_bôm≠
;

632 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

633 i‡(
îr
)

634 
out
;

636 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

637 i‡(
	`IS_ERR
(
bh
)) {

638 
îr
 = 
	`PTR_ERR
(
bh
);

639 
out
;

641 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

642 i‡(
ovîhód
 != 0) {

643 
	`pxt4_debug
("mark backup superblock %#04llx (+0)\n",

644 
°¨t
);

645 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 0,

646 
	`PXT4_NUM_B2C
(
sbi
, 
ovîhód
));

648 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_B2C
(
sbi
, 
group_d©a
[
i
].
blocks_cou¡
),

649 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

650 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

651 
	`bªl£
(
bh
);

652 i‡(
îr
)

653 
out
;

655 
h™dÀ_ib
:

656 i‡(
bg_Êags
[
i
] & 
PXT4_BG_INODE_UNINIT
)

660 
block
 = 
group_d©a
[
i
].
öode_bôm≠
;

661 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

662 i‡(
îr
)

663 
out
;

665 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

666 i‡(
	`IS_ERR
(
bh
)) {

667 
îr
 = 
	`PTR_ERR
(
bh
);

668 
out
;

671 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

672 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

673 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

674 
	`bªl£
(
bh
);

675 i‡(
îr
)

676 
out
;

680 
j
 = 0; j < 
GROUP_TABLE_COUNT
; j++) {

681 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

682 
°¨t
 = (&
group_d©a
[0].
block_bôm≠
)[
j
];

683 
block
 = 
°¨t
;

684 
i
 = 1; i < 
Êex_gd
->
cou¡
; i++) {

685 
block
 +
group_èbÀ_cou¡
[
j
];

686 i‡(
block
 =(&
group_d©a
[
i
].
block_bôm≠
)[
j
]) {

687 
cou¡
 +
group_èbÀ_cou¡
[
j
];

690 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

691 
Êex_gd
,

692 
	`PXT4_B2C
(
sbi
, 
°¨t
),

693 
	`PXT4_B2C
(
sbi
,

694 
°¨t
 + 
cou¡


696 i‡(
îr
)

697 
out
;

698 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

699 
°¨t
 = (&
group_d©a
[
i
].
block_bôm≠
)[
j
];

700 
block
 = 
°¨t
;

703 i‡(
cou¡
) {

704 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

705 
Êex_gd
,

706 
	`PXT4_B2C
(
sbi
, 
°¨t
),

707 
	`PXT4_B2C
(
sbi
,

708 
°¨t
 + 
cou¡


710 i‡(
îr
)

711 
out
;

715 
out
:

716 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

717 i‡(
îr2
 && !
îr
)

718 
îr
 = 
îr2
;

720  
îr
;

721 
	}
}

730 
	$pxt4_li°_backups
(
su≥r_block
 *
sb
, *
thªe
,

731 *
five
, *
£ví
)

733 *
mö
 = 
thªe
;

734 
mu…
 = 3;

735 
ªt
;

737 i‡(!
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

738 
ªt
 = *
mö
;

739 *
mö
 += 1;

740  
ªt
;

743 i‡(*
five
 < *
mö
) {

744 
mö
 = 
five
;

745 
mu…
 = 5;

747 i‡(*
£ví
 < *
mö
) {

748 
mö
 = 
£ví
;

749 
mu…
 = 7;

752 
ªt
 = *
mö
;

753 *
mö
 *
mu…
;

755  
ªt
;

756 
	}
}

763 
	$vîify_ª£rved_gdb
(
su≥r_block
 *
sb
,

764 
pxt4_group_t
 
íd
,

765 
buf„r_hód
 *
¥im¨y
)

767 c⁄° 
pxt4_fsblk_t
 
blk
 = 
¥im¨y
->
b_blockƒ
;

768 
thªe
 = 1;

769 
five
 = 5;

770 
£ví
 = 7;

771 
gΩ
;

772 
__À32
 *
p
 = (__À32 *)
¥im¨y
->
b_d©a
;

773 
gdbackups
 = 0;

775 (
gΩ
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
)Ë< 
íd
) {

776 i‡(
	`À32_to_˝u
(*
p
++) !=

777 
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë+ 
blk
){

778 
	`pxt4_w¨nög
(
sb
, "reserved GDT %llu"

780 
blk
, 
gΩ
,

781 
gΩ
 *

782 (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

783 
blk
);

784  -
EINVAL
;

786 i‡(++
gdbackups
 > 
	`PXT4_ADDR_PER_BLOCK
(
sb
))

787  -
EFBIG
;

790  
gdbackups
;

791 
	}
}

806 
	$add_√w_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

807 
pxt4_group_t
 
group
)

809 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

810 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

811 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

812 
pxt4_fsblk_t
 
gdblock
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + 
gdb_num
;

813 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
 = 
NULL
;

814 
buf„r_hód
 *
död
 = 
NULL
;

815 
buf„r_hód
 *
gdb_bh
 = 
NULL
;

816 
gdbackups
;

817 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

818 
__À32
 *
d©a
;

819 
îr
;

821 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

822 
	`¥ötk
(
KERN_DEBUG


824 
gdb_num
);

826 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

827 i‡(
	`IS_ERR
(
gdb_bh
))

828  
	`PTR_ERR
(
gdb_bh
);

830 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
gdb_bh
);

831 i‡(
gdbackups
 < 0) {

832 
îr
 = 
gdbackups
;

833 
îrout
;

836 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

837 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

838 i‡(
	`IS_ERR
(
död
)) {

839 
îr
 = 
	`PTR_ERR
(
död
);

840 
död
 = 
NULL
;

841 
îrout
;

844 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

845 i‡(
	`À32_to_˝u
(
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)]Ë!
gdblock
) {

846 
	`pxt4_w¨nög
(
sb
, "new group %u GDT block %lluÇotÑeserved",

847 
group
, 
gdblock
);

848 
îr
 = -
EINVAL
;

849 
îrout
;

852 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

853 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

854 i‡(
	`u∆ikñy
(
îr
))

855 
îrout
;

857 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

858 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

859 i‡(
	`u∆ikñy
(
îr
))

860 
îrout
;

862 
	`BUFFER_TRACE
(
död
, "get_write_access");

863 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
död
);

864 i‡(
	`u∆ikñy
(
îr
))

865 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

868 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

869 i‡(
	`u∆ikñy
(
îr
))

870 
îrout
;

872 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

873 (
buf„r_hód
 *),

874 
GFP_NOFS
);

875 i‡(!
n_group_desc
) {

876 
îr
 = -
ENOMEM
;

877 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

878 
gdb_num
 + 1);

879 
îrout
;

891 
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)] = 0;

892 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
död
);

893 i‡(
	`u∆ikñy
(
îr
)) {

894 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

895 
îrout
;

897 
öode
->
i_blocks
 -(
gdbackups
 + 1Ë* 
sb
->
s_blocksize
 >>

898 (9 - 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

899 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

900 
	`mem£t
(
gdb_bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

901 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

902 i‡(
	`u∆ikñy
(
îr
)) {

903 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

904 
ûoc
.
bh
 = 
NULL
;

905 
îrout
;

907 
	`bªl£
(
död
);

909 
	`rcu_ªad_lock
();

910 
o_group_desc
 = 
	`rcu_dîe„ªn˚
(
	`PXT4_SB
(
sb
)->
s_group_desc
);

911 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

912 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

913 
	`rcu_ªad_u∆ock
();

914 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

915 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
s_group_desc
, 
n_group_desc
);

916 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

917 
	`pxt4_kv‰ì_¨øy_rcu
(
o_group_desc
);

919 
	`À16_add_˝u
(&
es
->
s_ª£rved_gdt_blocks
, -1);

920 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

921 i‡(
îr
)

922 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

923  
îr
;

924 
îrout
:

925 
	`kv‰ì
(
n_group_desc
);

926 
	`bªl£
(
ûoc
.
bh
);

927 
	`bªl£
(
död
);

928 
	`bªl£
(
gdb_bh
);

930 
	`pxt4_debug
("Àavög wôhÉº‹ %d\n", 
îr
);

931  
îr
;

932 
	}
}

937 
	$add_√w_gdb_mëa_bg
(
su≥r_block
 *
sb
,

938 
h™dÀ_t
 *
h™dÀ
, 
pxt4_group_t
 
group
) {

939 
pxt4_fsblk_t
 
gdblock
;

940 
buf„r_hód
 *
gdb_bh
;

941 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
;

942 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

943 
îr
;

945 
gdblock
 = 
	`pxt4_mëa_bg_fú°_block_no
(
sb
, 
group
) +

946 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

947 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

948 i‡(
	`IS_ERR
(
gdb_bh
))

949  
	`PTR_ERR
(
gdb_bh
);

950 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

951 (
buf„r_hód
 *),

952 
GFP_NOFS
);

953 i‡(!
n_group_desc
) {

954 
	`bªl£
(
gdb_bh
);

955 
îr
 = -
ENOMEM
;

956 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

957 
gdb_num
 + 1);

958  
îr
;

961 
	`rcu_ªad_lock
();

962 
o_group_desc
 = 
	`rcu_dîe„ªn˚
(
	`PXT4_SB
(
sb
)->
s_group_desc
);

963 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

964 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

965 
	`rcu_ªad_u∆ock
();

966 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

968 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

969 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

970 i‡(
îr
) {

971 
	`kv‰ì
(
n_group_desc
);

972 
	`bªl£
(
gdb_bh
);

973  
îr
;

976 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
s_group_desc
, 
n_group_desc
);

977 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

978 
	`pxt4_kv‰ì_¨øy_rcu
(
o_group_desc
);

979  
îr
;

980 
	}
}

995 
	$ª£rve_backup_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

996 
pxt4_group_t
 
group
)

998 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

999 
ª£rved_gdb
 =
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

1000 
˛u°î_bôs
 = 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

1001 
buf„r_hód
 **
¥im¨y
;

1002 
buf„r_hód
 *
död
;

1003 
pxt4_ûoc
 
ûoc
;

1004 
pxt4_fsblk_t
 
blk
;

1005 
__À32
 *
d©a
, *
íd
;

1006 
gdbackups
 = 0;

1007 
ªs
, 
i
;

1008 
îr
;

1010 
¥im¨y
 = 
	`kmÆloc_¨øy
(
ª£rved_gdb
, (*¥im¨y), 
GFP_NOFS
);

1011 i‡(!
¥im¨y
)

1012  -
ENOMEM
;

1014 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

1015 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

1016 i‡(
	`IS_ERR
(
död
)) {

1017 
îr
 = 
	`PTR_ERR
(
död
);

1018 
död
 = 
NULL
;

1019 
exô_‰ì
;

1022 
blk
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + PXT4_SB(sb)->
s_gdb_cou¡
;

1023 
d©a
 = (
__À32
 *)
död
->
b_d©a
 + (
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 %

1024 
	`PXT4_ADDR_PER_BLOCK
(
sb
));

1025 
íd
 = (
__À32
 *)
död
->
b_d©a
 + 
	`PXT4_ADDR_PER_BLOCK
(
sb
);

1028 
ªs
 = 0;Ñe†< 
ª£rved_gdb
;Ñes++, 
blk
++) {

1029 i‡(
	`À32_to_˝u
(*
d©a
Ë!
blk
) {

1030 
	`pxt4_w¨nög
(
sb
, "reserved block %llu"

1032 
blk
,

1033 ()(
d©a
 - (
__À32
 *)
död
->
b_d©a
));

1034 
îr
 = -
EINVAL
;

1035 
exô_bh
;

1037 
¥im¨y
[
ªs
] = 
	`pxt4_sb_bªad
(
sb
, 
blk
, 0);

1038 i‡(
	`IS_ERR
(
¥im¨y
[
ªs
])) {

1039 
îr
 = 
	`PTR_ERR
(
¥im¨y
[
ªs
]);

1040 
¥im¨y
[
ªs
] = 
NULL
;

1041 
exô_bh
;

1043 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
¥im¨y
[
ªs
]);

1044 i‡(
gdbackups
 < 0) {

1045 
	`bªl£
(
¥im¨y
[
ªs
]);

1046 
îr
 = 
gdbackups
;

1047 
exô_bh
;

1049 i‡(++
d©a
 >
íd
)

1050 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

1053 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1054 
	`BUFFER_TRACE
(
¥im¨y
[
i
], "get_write_access");

1055 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
¥im¨y
[
i
])))

1056 
exô_bh
;

1059 i‡((
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
)))

1060 
exô_bh
;

1066 
blk
 = 
group
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1067 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1068 
îr2
;

1069 
d©a
 = (
__À32
 *)
¥im¨y
[
i
]->
b_d©a
;

1073 
d©a
[
gdbackups
] = 
	`˝u_to_À32
(
blk
 + 
¥im¨y
[
i
]->
b_blockƒ
);

1074 
îr2
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
¥im¨y
[
i
]);

1075 i‡(!
îr
)

1076 
îr
 = 
îr2
;

1079 
öode
->
i_blocks
 +
ª£rved_gdb
 * 
sb
->
s_blocksize
 >> (9 - 
˛u°î_bôs
);

1080 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

1082 
exô_bh
:

1083 --
ªs
 >= 0)

1084 
	`bªl£
(
¥im¨y
[
ªs
]);

1085 
	`bªl£
(
död
);

1087 
exô_‰ì
:

1088 
	`k‰ì
(
¥im¨y
);

1090  
îr
;

1091 
	}
}

1109 
	$upd©e_backups
(
su≥r_block
 *
sb
, 
£˘‹_t
 
blk_off
, *
d©a
,

1110 
size
, 
mëa_bg
)

1112 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1113 
pxt4_group_t
 
œ°
;

1114 c⁄° 
bpg
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1115 
thªe
 = 1;

1116 
five
 = 5;

1117 
£ví
 = 7;

1118 
pxt4_group_t
 
group
 = 0;

1119 
ª°
 = 
sb
->
s_blocksize
 - 
size
;

1120 
h™dÀ_t
 *
h™dÀ
;

1121 
îr
 = 0, 
îr2
;

1123 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

1124 i‡(
	`IS_ERR
(
h™dÀ
)) {

1125 
group
 = 1;

1126 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1127 
exô_îr
;

1130 i‡(
mëa_bg
 == 0) {

1131 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1132 
œ°
 = 
sbi
->
s_groups_cou¡
;

1134 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
blk_off
) + 1;

1135 
œ°
 = (
pxt4_group_t
)(
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 2);

1138 
group
 < 
sbi
->
s_groups_cou¡
) {

1139 
buf„r_hód
 *
bh
;

1140 
pxt4_fsblk_t
 
backup_block
;

1143 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

1144 
h™dÀ
->
h_buf„r_¸edôs
 == 0 &&

1145 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
) &&

1146 (
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
)))

1149 i‡(
mëa_bg
 == 0)

1150 
backup_block
 = ((
pxt4_fsblk_t
)
group
Ë* 
bpg
 + 
blk_off
;

1152 
backup_block
 = (
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

1153 
	`pxt4_bg_has_su≥r
(
sb
, 
group
));

1155 
bh
 = 
	`sb_gëblk
(
sb
, 
backup_block
);

1156 i‡(
	`u∆ikñy
(!
bh
)) {

1157 
îr
 = -
ENOMEM
;

1160 
	`pxt4_debug
("update metadata backup %llu(+%llu)\n",

1161 
backup_block
, backup_block -

1162 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

1163 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1164 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

1165 
	`bªl£
(
bh
);

1168 
	`lock_buf„r
(
bh
);

1169 
	`mem˝y
(
bh
->
b_d©a
, 
d©a
, 
size
);

1170 i‡(
ª°
)

1171 
	`mem£t
(
bh
->
b_d©a
 + 
size
, 0, 
ª°
);

1172 
	`£t_buf„r_u±od©e
(
bh
);

1173 
	`u∆ock_buf„r
(
bh
);

1174 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1175 i‡(
	`u∆ikñy
(
îr
))

1176 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1177 
	`bªl£
(
bh
);

1179 i‡(
mëa_bg
 == 0)

1180 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1181 i‡(
group
 =
œ°
)

1184 
group
 = 
œ°
;

1186 i‡((
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
)Ë&& !
îr
)

1187 
îr
 = 
îr2
;

1199 
exô_îr
:

1200 i‡(
îr
) {

1201 
	`pxt4_w¨nög
(
sb
, "can't update backup for group %u (err %d), "

1202 "f‹cög fsck o¿√xàªboŸ", 
group
, 
îr
);

1203 
sbi
->
s_mou¡_°©e
 &~
PXT4_VALID_FS
;

1204 
sbi
->
s_es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

1205 
	`m¨k_buf„r_dúty
(
sbi
->
s_sbh
);

1207 
	}
}

1219 
	$pxt4_add_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1220 
pxt4_group_t
 
group
, 
öode
 *
ªsize_öode
,

1221 
pxt4_group_t
 
cou¡
)

1223 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1224 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1225 
buf„r_hód
 *
gdb_bh
;

1226 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1227 
mëa_bg
;

1229 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1230 
i
 = 0; i < 
cou¡
; i++, 
group
++) {

1231 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
group
) ?

1232 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1234 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1235 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1243 i‡(
gdb_off
) {

1244 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
,

1245 
gdb_num
);

1246 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

1247 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

1249 i‡(!
îr
 && 
ª£rved_gdb
 && 
	`pxt4_bg_num_gdb
(
sb
, 
group
))

1250 
îr
 = 
	`ª£rve_backup_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1251 } i‡(
mëa_bg
 != 0) {

1252 
îr
 = 
	`add_√w_gdb_mëa_bg
(
sb
, 
h™dÀ
, 
group
);

1254 
îr
 = 
	`add_√w_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1256 i‡(
îr
)

1259  
îr
;

1260 
	}
}

1262 
buf„r_hód
 *
	$pxt4_gë_bôm≠
(
su≥r_block
 *
sb
, 
__u64
 
block
)

1264 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

1265 i‡(
	`u∆ikñy
(!
bh
))

1266  
NULL
;

1267 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

1268 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

1269 
	`bªl£
(
bh
);

1270  
NULL
;

1274  
bh
;

1275 
	}
}

1277 
	$pxt4_£t_bôm≠_checksums
(
su≥r_block
 *
sb
,

1278 
pxt4_group_t
 
group
,

1279 
pxt4_group_desc
 *
gdp
,

1280 
pxt4_√w_group_d©a
 *
group_d©a
)

1282 
buf„r_hód
 *
bh
;

1284 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

1287 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
öode_bôm≠
);

1288 i‡(!
bh
)

1289  -
EIO
;

1290 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
,

1291 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1292 
	`bªl£
(
bh
);

1294 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
block_bôm≠
);

1295 i‡(!
bh
)

1296  -
EIO
;

1297 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
);

1298 
	`bªl£
(
bh
);

1301 
	}
}

1306 
	$pxt4_£tup_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1307 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1309 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1310 
pxt4_group_desc
 *
gdp
;

1311 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1312 
buf„r_hód
 *
gdb_bh
;

1313 
pxt4_group_t
 
group
;

1314 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

1315 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1318 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group_d©a
++, 
bg_Êags
++) {

1319 
group
 = 
group_d©a
->group;

1321 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1322 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1327 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
, 
gdb_num
);

1329 
gdp
 = (
pxt4_group_desc
 *)(
gdb_bh
->
b_d©a
 +

1330 
gdb_off
 * 
	`PXT4_DESC_SIZE
(
sb
));

1332 
	`mem£t
(
gdp
, 0, 
	`PXT4_DESC_SIZE
(
sb
));

1333 
	`pxt4_block_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
block_bôm≠
);

1334 
	`pxt4_öode_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_bôm≠
);

1335 
îr
 = 
	`pxt4_£t_bôm≠_checksums
(
sb
, 
group
, 
gdp
, 
group_d©a
);

1336 i‡(
îr
) {

1337 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1341 
	`pxt4_öode_èbÀ_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_èbÀ
);

1342 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1343 
group_d©a
->
‰ì_˛u°îs_cou¡
);

1344 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`PXT4_INODES_PER_GROUP
(sb));

1345 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

1346 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1347 
	`PXT4_INODES_PER_GROUP
(
sb
));

1348 
gdp
->
bg_Êags
 = 
	`˝u_to_À16
(*bg_flags);

1349 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1351 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

1352 i‡(
	`u∆ikñy
(
îr
)) {

1353 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1361 
îr
 = 
	`pxt4_mb_add_groupöfo
(
sb
, 
group
, 
gdp
);

1362 i‡(
îr
)

1365  
îr
;

1366 
	}
}

1375 
	$pxt4_upd©e_su≥r
(
su≥r_block
 *
sb
,

1376 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1378 
pxt4_fsblk_t
 
blocks_cou¡
 = 0;

1379 
pxt4_fsblk_t
 
‰ì_blocks
 = 0;

1380 
pxt4_fsblk_t
 
ª£rved_blocks
 = 0;

1381 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1382 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1383 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1384 
i
;

1386 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

1397 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1398 
blocks_cou¡
 +
group_d©a
[
i
].blocks_count;

1399 
‰ì_blocks
 +
	`PXT4_C2B
(
sbi
, 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
);

1402 
ª£rved_blocks
 = 
	`pxt4_r_blocks_cou¡
(
es
) * 100;

1403 
ª£rved_blocks
 = 
	`div64_u64
‘e£rved_blocks, 
	`pxt4_blocks_cou¡
(
es
));

1404 
ª£rved_blocks
 *
blocks_cou¡
;

1405 
	`do_div
(
ª£rved_blocks
, 100);

1407 
	`pxt4_blocks_cou¡_£t
(
es
, 
	`pxt4_blocks_cou¡
”sË+ 
blocks_cou¡
);

1408 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
‰ì_blocks
);

1409 
	`À32_add_˝u
(&
es
->
s_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1410 
Êex_gd
->
cou¡
);

1411 
	`À32_add_˝u
(&
es
->
s_‰ì_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1412 
Êex_gd
->
cou¡
);

1414 
	`pxt4_debug
("‰ì block†cou¡ %Œu", 
	`pxt4_‰ì_blocks_cou¡
(
es
));

1433 
	`smp_wmb
();

1436 
sbi
->
s_groups_cou¡
 +
Êex_gd
->
cou¡
;

1437 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

1438 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

1442 
	`pxt4_r_blocks_cou¡_£t
(
es
, 
	`pxt4_r_blocks_cou¡
(es) +

1443 
ª£rved_blocks
);

1446 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

1447 
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
));

1448 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ìöodes_cou¡î
,

1449 
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
);

1451 
	`pxt4_debug
("free blocks count %llu",

1452 
	`≥r˝u_cou¡î_ªad
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

1453 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
Ë&& 
sbi
->
s_log_groups_≥r_Êex
) {

1454 
pxt4_group_t
 
Êex_group
;

1455 
Êex_groups
 *
fg
;

1457 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group_d©a
[0].
group
);

1458 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
, 
Êex_group
);

1459 
	`©omic64_add
(
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
),

1460 &
fg
->
‰ì_˛u°îs
);

1461 
	`©omic_add
(
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
,

1462 &
fg
->
‰ì_öodes
);

1468 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

1470 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1471 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádded group %u:"

1472 "%Œu blocks(%Œu fªê%ŒuÑe£rved)\n", 
Êex_gd
->
cou¡
,

1473 
blocks_cou¡
, 
‰ì_blocks
, 
ª£rved_blocks
);

1474 
	}
}

1480 
	$pxt4_Êex_group_add
(
su≥r_block
 *
sb
,

1481 
öode
 *
ªsize_öode
,

1482 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1484 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1485 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1486 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1487 
pxt4_gΩblk_t
 
œ°
;

1488 
pxt4_group_t
 
group
;

1489 
h™dÀ_t
 *
h™dÀ
;

1490 
ª£rved_gdb
;

1491 
îr
 = 0, 
îr2
 = 0, 
¸edô
;

1493 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !Êex_gd->
groups
 || !Êex_gd->
bg_Êags
);

1495 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1496 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1497 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1498 
	`BUG_ON
(
œ°
);

1500 
îr
 = 
	`£tup_√w_Êex_group_blocks
(
sb
, 
Êex_gd
);

1501 i‡(
îr
)

1502 
exô
;

1510 
¸edô
 = 3;

1512 
¸edô
 +1 + 
	`DIV_ROUND_UP
(
Êex_gd
->
cou¡
, 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1513 
¸edô
 +
ª£rved_gdb
;

1514 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edô
);

1515 i‡(
	`IS_ERR
(
h™dÀ
)) {

1516 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1517 
exô
;

1520 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1521 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1522 i‡(
îr
)

1523 
exô_jou∫Æ
;

1525 
group
 = 
Êex_gd
->
groups
[0].group;

1526 
	`BUG_ON
(
group
 !
sbi
->
s_groups_cou¡
);

1527 
îr
 = 
	`pxt4_add_√w_descs
(
h™dÀ
, 
sb
, 
group
,

1528 
ªsize_öode
, 
Êex_gd
->
cou¡
);

1529 i‡(
îr
)

1530 
exô_jou∫Æ
;

1532 
îr
 = 
	`pxt4_£tup_√w_descs
(
h™dÀ
, 
sb
, 
Êex_gd
);

1533 i‡(
îr
)

1534 
exô_jou∫Æ
;

1536 
	`pxt4_upd©e_su≥r
(
sb
, 
Êex_gd
);

1538 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1540 
exô_jou∫Æ
:

1541 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1542 i‡(!
îr
)

1543 
îr
 = 
îr2
;

1545 i‡(!
îr
) {

1546 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1547 
gdb_num_íd
 = ((
group
 + 
Êex_gd
->
cou¡
 - 1) /

1548 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1549 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1550 
£˘‹_t
 
ﬁd_gdb
 = 0;

1552 
	`upd©e_backups
(
sb
, 
sbi
->
s_sbh
->
b_blockƒ
, (*)
es
,

1553 (
pxt4_su≥r_block
), 0);

1554 ; 
gdb_num
 <
gdb_num_íd
; gdb_num++) {

1555 
buf„r_hód
 *
gdb_bh
;

1557 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
,

1558 
gdb_num
);

1559 i‡(
ﬁd_gdb
 =
gdb_bh
->
b_blockƒ
)

1561 
	`upd©e_backups
(
sb
, 
gdb_bh
->
b_blockƒ
, gdb_bh->
b_d©a
,

1562 
gdb_bh
->
b_size
, 
mëa_bg
);

1563 
ﬁd_gdb
 = 
gdb_bh
->
b_blockƒ
;

1566 
exô
:

1567  
îr
;

1568 
	}
}

1570 
	$pxt4_£tup_√xt_Êex_gd
(
su≥r_block
 *
sb
,

1571 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

1572 
pxt4_fsblk_t
 
n_blocks_cou¡
,

1573 
Êexbg_size
)

1575 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1576 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1577 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1578 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1579 
pxt4_group_t
 
n_group
;

1580 
pxt4_group_t
 
group
;

1581 
pxt4_group_t
 
œ°_group
;

1582 
pxt4_gΩblk_t
 
œ°
;

1583 
pxt4_gΩblk_t
 
˛u°îs_≥r_group
;

1584 
i
;

1586 
˛u°îs_≥r_group
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1588 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1590 i‡(
o_blocks_cou¡
 =
n_blocks_cou¡
)

1593 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1594 
	`BUG_ON
(
œ°
);

1595 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
n_blocks_cou¡
 - 1, &
n_group
, &
œ°
);

1597 
œ°_group
 = 
group
 | (
Êexbg_size
 - 1);

1598 i‡(
œ°_group
 > 
n_group
)

1599 
œ°_group
 = 
n_group
;

1601 
Êex_gd
->
cou¡
 = 
œ°_group
 - 
group
 + 1;

1603 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1604 
ovîhód
;

1606 
group_d©a
[
i
].
group
 = group + i;

1607 
group_d©a
[
i
].
blocks_cou¡
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1608 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
 + 
i
);

1609 
group_d©a
[
i
].
md©a_blocks
 = 
ovîhód
;

1610 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1611 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1612 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_BLOCK_UNINIT
 |

1613 
PXT4_BG_INODE_UNINIT
;

1614 i‡(!
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1615 
Êex_gd
->
bg_Êags
[
i
] |
PXT4_BG_INODE_ZEROED
;

1617 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_INODE_ZEROED
;

1620 i‡(
œ°_group
 =
n_group
 && 
	`pxt4_has_group_desc_csum
(
sb
))

1622 
Êex_gd
->
bg_Êags
[
i
 - 1] &~
PXT4_BG_BLOCK_UNINIT
;

1624 i‡((
œ°_group
 =
n_group
Ë&& (
œ°
 !
˛u°îs_≥r_group
 - 1)) {

1625 
group_d©a
[
i
 - 1].
blocks_cou¡
 = 
	`PXT4_C2B
(
sbi
, 
œ°
 + 1);

1626 
group_d©a
[
i
 - 1].
‰ì_˛u°îs_cou¡
 -
˛u°îs_≥r_group
 -

1627 
œ°
 - 1;

1631 
	}
}

1646 
	$pxt4_group_add
(
su≥r_block
 *
sb
, 
pxt4_√w_group_d©a
 *
öput
)

1648 
pxt4_√w_Êex_group_d©a
 
Êex_gd
;

1649 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1650 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1651 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ?

1652 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1653 
öode
 *öodê
NULL
;

1654 
gdb_off
;

1655 
îr
;

1656 
__u16
 
bg_Êags
 = 0;

1658 
gdb_off
 = 
öput
->
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1660 i‡(
gdb_off
 =0 && !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

1661 
	`pxt4_w¨nög
(
sb
, "Can'tÑesizeÇon-sparse filesystem further");

1662  -
EPERM
;

1665 i‡(
	`pxt4_blocks_cou¡
(
es
Ë+ 
öput
->
blocks_cou¡
 <

1666 
	`pxt4_blocks_cou¡
(
es
)) {

1667 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1668  -
EINVAL
;

1671 i‡(
	`À32_to_˝u
(
es
->
s_öodes_cou¡
Ë+ 
	`PXT4_INODES_PER_GROUP
(
sb
) <

1672 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

1673 
	`pxt4_w¨nög
(
sb
, "inodes_count overflow");

1674  -
EINVAL
;

1677 i‡(
ª£rved_gdb
 || 
gdb_off
 == 0) {

1678 i‡(!
	`pxt4_has_„©uª_ªsize_öode
(
sb
) ||

1679 !
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1680 
	`pxt4_w¨nög
(
sb
,

1682  -
EPERM
;

1684 
öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
, 
PXT4_IGET_SPECIAL
);

1685 i‡(
	`IS_ERR
(
öode
)) {

1686 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1687  
	`PTR_ERR
(
öode
);

1692 
îr
 = 
	`vîify_group_öput
(
sb
, 
öput
);

1693 i‡(
îr
)

1694 
out
;

1696 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
öput
->
group
 + 1);

1697 i‡(
îr
)

1698 
out
;

1700 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
öput
->
group
 + 1);

1701 i‡(
îr
)

1702 
out
;

1704 
Êex_gd
.
cou¡
 = 1;

1705 
Êex_gd
.
groups
 = 
öput
;

1706 
Êex_gd
.
bg_Êags
 = &bg_flags;

1707 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
öode
, &
Êex_gd
);

1708 
out
:

1709 
	`ùut
(
öode
);

1710  
îr
;

1711 
	}
}

1716 
	$pxt4_group_exãnd_no_check
(
su≥r_block
 *
sb
,

1717 
pxt4_fsblk_t
 
o_blocks_cou¡
, 
pxt4_gΩblk_t
 
add
)

1719 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1720 
h™dÀ_t
 *
h™dÀ
;

1721 
îr
 = 0, 
îr2
;

1726 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 3);

1727 i‡(
	`IS_ERR
(
h™dÀ
)) {

1728 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1729 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ sèπ", 
îr
);

1730  
îr
;

1733 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

1734 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

1735 i‡(
îr
) {

1736 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ wrôêac˚ss", 
îr
);

1737 
îrout
;

1740 
	`pxt4_blocks_cou¡_£t
(
es
, 
o_blocks_cou¡
 + 
add
);

1741 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
add
);

1742 
	`pxt4_debug
("‰ìög block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1743 
o_blocks_cou¡
 + 
add
);

1745 
îr
 = 
	`pxt4_group_add_blocks
(
h™dÀ
, 
sb
, 
o_blocks_cou¡
, 
add
);

1746 i‡(
îr
)

1747 
îrout
;

1748 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1749 
	`pxt4_debug
("‰ìd block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1750 
o_blocks_cou¡
 + 
add
);

1751 
îrout
:

1752 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1753 i‡(
îr2
 && !
îr
)

1754 
îr
 = 
îr2
;

1756 i‡(!
îr
) {

1757 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1758 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:Éxtended groupÅo %llu "

1759 "blocks\n", 
	`pxt4_blocks_cou¡
(
es
));

1760 
	`upd©e_backups
(
sb
, 
	`PXT4_SB
(sb)->
s_sbh
->
b_blockƒ
,

1761 (*)
es
, (
pxt4_su≥r_block
), 0);

1763  
îr
;

1764 
	}
}

1776 
	$pxt4_group_exãnd
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

1777 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1779 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1780 
pxt4_gΩblk_t
 
œ°
;

1781 
pxt4_gΩblk_t
 
add
;

1782 
buf„r_hód
 *
bh
;

1783 
îr
;

1784 
pxt4_group_t
 
group
;

1786 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1788 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1789 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

1791 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1793 i‡(
n_blocks_cou¡
 =0 ||Ç_blocks_cou¡ =
o_blocks_cou¡
)

1796 i‡(
n_blocks_cou¡
 > (
£˘‹_t
)(~0ULLË>> (
sb
->
s_blocksize_bôs
 - 9)) {

1797 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1799 
n_blocks_cou¡
);

1800  -
EINVAL
;

1803 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1804 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1805  -
EINVAL
;

1809 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1811 i‡(
œ°
 == 0) {

1812 
	`pxt4_w¨nög
(
sb
, "needÅo useÖxt2onlineÅoÑesize further");

1813  -
EPERM
;

1816 
add
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
œ°
;

1818 i‡(
o_blocks_cou¡
 + 
add
 < o_blocks_count) {

1819 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1820  -
EINVAL
;

1823 i‡(
o_blocks_cou¡
 + 
add
 > 
n_blocks_cou¡
)

1824 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

1826 i‡(
o_blocks_cou¡
 + 
add
 < 
n_blocks_cou¡
)

1827 
	`pxt4_w¨nög
(
sb
, "will only finish group (%llu blocks, %uÇew)",

1828 
o_blocks_cou¡
 + 
add
,ádd);

1831 
bh
 = 
	`sb_bªad
(
sb
, 
o_blocks_cou¡
 + 
add
 - 1);

1832 i‡(!
bh
) {

1833 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1834  -
ENOSPC
;

1836 
	`bªl£
(
bh
);

1838 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

1839  
îr
;

1840 
	}
}

1843 
	$num_desc_blocks
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
groups
)

1845  (
groups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) / PXT4_DESC_PER_BLOCK(sb);

1846 
	}
}

1853 
	$pxt4_c⁄vît_mëa_bg
(
su≥r_block
 *
sb
, 
öode
 *inode)

1855 
h™dÀ_t
 *
h™dÀ
;

1856 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1857 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1858 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1859 
pxt4_fsblk_t
 
ƒ
;

1860 
i
, 
ªt
, 
îr
 = 0;

1861 
¸edôs
 = 1;

1863 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Converting file systemÅo meta_bg");

1864 i‡(
öode
) {

1865 i‡(
es
->
s_ª£rved_gdt_blocks
) {

1866 
	`pxt4_îr‹
(
sb
, "UnexpectedÇon-zero "

1868  -
EPERM
;

1872 i‡(
öode
->
i_blocks
 !1 << (öode->
i_blkbôs
 -

1873 (9 - 
sbi
->
s_˛u°î_bôs
)))

1874 
övÆid_ªsize_öode
;

1875 
i
 = 0; i < 
PXT4_N_BLOCKS
; i++) {

1876 i‡(
i
 =
PXT4_DIND_BLOCK
) {

1877 i‡(
ei
->
i_d©a
[
i
])

1880 
övÆid_ªsize_öode
;

1882 i‡(
ei
->
i_d©a
[
i
])

1883 
övÆid_ªsize_öode
;

1885 
¸edôs
 += 3;

1888 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edôs
);

1889 i‡(
	`IS_ERR
(
h™dÀ
))

1890  
	`PTR_ERR
(
h™dÀ
);

1892 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1893 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1894 i‡(
îr
)

1895 
îrout
;

1897 
	`pxt4_˛ór_„©uª_ªsize_öode
(
sb
);

1898 
	`pxt4_£t_„©uª_mëa_bg
(
sb
);

1899 
sbi
->
s_es
->
s_fú°_mëa_bg
 =

1900 
	`˝u_to_À32
(
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
));

1902 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1903 i‡(
îr
) {

1904 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1905 
îrout
;

1908 i‡(
öode
) {

1909 
ƒ
 = 
	`À32_to_˝u
(
ei
->
i_d©a
[
PXT4_DIND_BLOCK
]);

1910 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1911 
PXT4_FREE_BLOCKS_METADATA
 |

1912 
PXT4_FREE_BLOCKS_FORGET
);

1913 
ei
->
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1914 
öode
->
i_blocks
 = 0;

1916 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1917 i‡(
îr
)

1918 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1921 
îrout
:

1922 
ªt
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1923 i‡(!
îr
)

1924 
îr
 = 
ªt
;

1925  
ªt
;

1927 
övÆid_ªsize_öode
:

1928 
	`pxt4_îr‹
(
sb
, "corrupted/inconsistentÑesize inode");

1929  -
EINVAL
;

1930 
	}
}

1938 
	$pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1940 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
 = 
NULL
;

1941 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1942 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1943 
buf„r_hód
 *
bh
;

1944 
öode
 *
ªsize_öode
 = 
NULL
;

1945 
pxt4_gΩblk_t
 
add
, 
off£t
;

1946 
n_desc_blocks
;

1947 
o_desc_blocks
;

1948 
pxt4_group_t
 
o_group
;

1949 
pxt4_group_t
 
n_group
;

1950 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1951 
pxt4_fsblk_t
 
n_blocks_cou¡_ªåy
 = 0;

1952 
œ°_upd©e_time
 = 0;

1953 
îr
 = 0, 
Êexbg_size
 = 1 << 
sbi
->
s_log_groups_≥r_Êex
;

1954 
mëa_bg
;

1957 
bh
 = 
	`sb_bªad
(
sb
, 
n_blocks_cou¡
 - 1);

1958 i‡(!
bh
) {

1959 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1960  -
ENOSPC
;

1962 
	`bªl£
(
bh
);

1964 
ªåy
:

1965 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1967 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resizing filesystem from %llu "

1968 "tÿ%Œu blocks", 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1970 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1972 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1973  -
EINVAL
;

1976 i‡(
n_blocks_cou¡
 =
o_blocks_cou¡
)

1980 
n_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
n_blocks_cou¡
 - 1);

1981 i‡(
n_group
 >(0xFFFFFFFFUL / 
	`PXT4_INODES_PER_GROUP
(
sb
))) {

1982 
	`pxt4_w¨nög
(
sb
, "resize would cause inodes_count overflow");

1983  -
EINVAL
;

1985 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
 - 1, &
o_group
, &
off£t
);

1987 
n_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
n_group
 + 1);

1988 
o_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
);

1990 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1992 i‡(
	`pxt4_has_„©uª_ªsize_öode
(
sb
)) {

1993 i‡(
mëa_bg
) {

1994 
	`pxt4_îr‹
(
sb
, "resize_inodeánd meta_bgÉnabled "

1996  -
EINVAL
;

1998 i‡(
n_desc_blocks
 > 
o_desc_blocks
 +

1999 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

2000 
n_blocks_cou¡_ªåy
 = 
n_blocks_cou¡
;

2001 
n_desc_blocks
 = 
o_desc_blocks
 +

2002 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

2003 
n_group
 = 
n_desc_blocks
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

2004 
n_blocks_cou¡
 = (
pxt4_fsblk_t
)
n_group
 *

2005 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

2006 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

2007 
n_group
--;

2010 i‡(!
ªsize_öode
)

2011 
ªsize_öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
,

2012 
PXT4_IGET_SPECIAL
);

2013 i‡(
	`IS_ERR
(
ªsize_öode
)) {

2014 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

2015  
	`PTR_ERR
(
ªsize_öode
);

2019 i‡((!
ªsize_öode
 && !
mëa_bg
Ë|| 
n_blocks_cou¡
 =
o_blocks_cou¡
) {

2020 
îr
 = 
	`pxt4_c⁄vît_mëa_bg
(
sb
, 
ªsize_öode
);

2021 i‡(
îr
)

2022 
out
;

2023 i‡(
ªsize_öode
) {

2024 
	`ùut
(
ªsize_öode
);

2025 
ªsize_öode
 = 
NULL
;

2027 i‡(
n_blocks_cou¡_ªåy
) {

2028 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2029 
n_blocks_cou¡_ªåy
 = 0;

2030 
ªåy
;

2041 i‡((
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
) +

2042 
	`pxt4_group_ovîhód_blocks
(
sb
, 
n_group
) + 2 +

2043 
sbi
->
s_ôb_≥r_group
 + sbi->
s_˛u°î_øtio
Ë>
n_blocks_cou¡
) {

2044 
n_blocks_cou¡
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
);

2045 
n_group
--;

2046 
n_blocks_cou¡_ªåy
 = 0;

2047 i‡(
ªsize_öode
) {

2048 
	`ùut
(
ªsize_öode
);

2049 
ªsize_öode
 = 
NULL
;

2051 
ªåy
;

2055 i‡(
n_group
 =
o_group
)

2056 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

2058 
add
 = 
	`PXT4_C2B
(
sbi
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
off£t
 + 1));

2059 i‡(
add
 > 0) {

2060 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

2061 i‡(
îr
)

2062 
out
;

2065 i‡(
	`pxt4_blocks_cou¡
(
es
Ë=
n_blocks_cou¡
)

2066 
out
;

2068 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
n_group
 + 1);

2069 i‡(
îr
)

2070 
out
;

2072 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
n_group
 + 1);

2073 i‡(
îr
)

2074 
out
;

2076 
Êex_gd
 = 
	`Æloc_Êex_gd
(
Êexbg_size
);

2077 i‡(
Êex_gd
 =
NULL
) {

2078 
îr
 = -
ENOMEM
;

2079 
out
;

2085 
	`pxt4_£tup_√xt_Êex_gd
(
sb
, 
Êex_gd
, 
n_blocks_cou¡
,

2086 
Êexbg_size
)) {

2087 i‡(
jiffõs
 - 
œ°_upd©e_time
 > 
HZ
 * 10) {

2088 i‡(
œ°_upd©e_time
)

2089 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2091 
	`pxt4_blocks_cou¡
(
es
));

2092 
œ°_upd©e_time
 = 
jiffõs
;

2094 i‡(
	`pxt4_Æloc_group_èbÀs
(
sb
, 
Êex_gd
, 
Êexbg_size
) != 0)

2096 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
ªsize_öode
, 
Êex_gd
);

2097 i‡(
	`u∆ikñy
(
îr
))

2101 i‡(!
îr
 && 
n_blocks_cou¡_ªåy
) {

2102 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2103 
n_blocks_cou¡_ªåy
 = 0;

2104 
	`‰ì_Êex_gd
(
Êex_gd
);

2105 
Êex_gd
 = 
NULL
;

2106 i‡(
ªsize_öode
) {

2107 
	`ùut
(
ªsize_öode
);

2108 
ªsize_öode
 = 
NULL
;

2110 
ªåy
;

2113 
out
:

2114 i‡(
Êex_gd
)

2115 
	`‰ì_Êex_gd
(
Êex_gd
);

2116 i‡(
ªsize_öode
 !
NULL
)

2117 
	`ùut
(
ªsize_öode
);

2118 i‡(
îr
)

2119 
	`pxt4_w¨nög
(
sb
, "error (%d) occurred during "

2120 "fûêsy°emÑesize", 
îr
);

2121 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resized filesystemÅo %llu",

2122 
	`pxt4_blocks_cou¡
(
es
));

2123  
îr
;

2124 
	}
}

	@super.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/vmÆloc.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/blkdev.h
>

28 
	~<löux/backög-dev.h
>

29 
	~<löux/∑r£r.h
>

30 
	~<löux/buf„r_hód.h
>

31 
	~<löux/exp‹tfs.h
>

32 
	~<löux/vfs.h
>

33 
	~<löux/øndom.h
>

34 
	~<löux/mou¡.h
>

35 
	~<löux/«mei.h
>

36 
	~<löux/quŸa›s.h
>

37 
	~<löux/£q_fûe.h
>

38 
	~<löux/˘y≥.h
>

39 
	~<löux/log2.h
>

40 
	~<löux/¸c16.h
>

41 
	~<löux/dax.h
>

42 
	~<löux/˛ónˇche.h
>

43 
	~<löux/uac˚ss.h
>

44 
	~<löux/ivîsi⁄.h
>

45 
	~<löux/unicode.h
>

47 
	~<löux/kthªad.h
>

48 
	~<löux/‰ìzî.h
>

50 
	~"pxt4.h
"

51 
	~"pxt4_exã¡s.h
"

52 
	~"pxt4_jbd3.h
"

53 
	~"x©å.h
"

54 
	~"a˛.h
"

55 
	~"mbÆloc.h
"

56 
	~"fsm≠.h
"

58 
	#CREATE_TRACE_POINTS


	)

59 
	~<åa˚/evíts/pxt4.h
>

61 
pxt4_œzy_öô
 *
	gpxt4_li_öfo
;

62 
muãx
 
	gpxt4_li_mtx
;

63 
øãlimô_°©e
 
	gpxt4_mou¡_msg_øãlimô
;

65 
pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *, 
pxt4_su≥r_block
 *,

66 
jou∫Æ_devnum
);

67 
pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
);

68 
pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
);

69 
pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

70 
pxt4_su≥r_block
 *
es
);

71 
pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

72 
pxt4_su≥r_block
 *
es
);

73 
pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
);

74 
pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
);

75 
pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
);

76 
pxt4_un‰ìze
(
su≥r_block
 *
sb
);

77 
pxt4_‰ìze
(
su≥r_block
 *
sb
);

78 
díåy
 *
pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

79 c⁄° *
dev_«me
, *
d©a
);

80 
ölöe
 
pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
);

81 
ölöe
 
ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
);

82 
pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
);

83 
pxt4_de°roy_œzyöô_thªad
();

84 
pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
);

85 
pxt4_˛ór_ªque°_li°
();

86 
öode
 *
pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

87 
jou∫Æ_öum
);

117 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

118 
fûe_sy°em_ty≥
 
	gpxt2_fs_ty≥
 = {

119 .
ow√r
 = 
THIS_MODULE
,

120 .
	g«me
 = "pxt2",

121 .
	gmou¡
 = 
pxt4_mou¡
,

122 .
	gkûl_sb
 = 
kûl_block_su≥r
,

123 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

125 
MODULE_ALIAS_FS
("pxt2");

126 
MODULE_ALIAS
("pxt2");

127 
	#IS_PXT2_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
pxt2_fs_ty≥
)

	)

129 
	#IS_PXT2_SB
(
sb
Ë(0)

	)

133 
fûe_sy°em_ty≥
 
	gext3_fs_ty≥
 = {

134 .
ow√r
 = 
THIS_MODULE
,

135 .
	g«me
 = "ext3",

136 .
	gmou¡
 = 
pxt4_mou¡
,

137 .
	gkûl_sb
 = 
kûl_block_su≥r
,

138 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

140 
MODULE_ALIAS_FS
("ext3");

141 
MODULE_ALIAS
("ext3");

142 
	#IS_EXT3_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
ext3_fs_ty≥
)

	)

150 
buf„r_hód
 *

151 
	$pxt4_sb_bªad
(
su≥r_block
 *
sb
, 
£˘‹_t
 
block
, 
›_Êags
)

153 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

155 i‡(
bh
 =
NULL
)

156  
	`ERR_PTR
(-
ENOMEM
);

157 i‡(
	`buf„r_u±od©e
(
bh
))

158  
bh
;

159 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
›_Êags
, 1, &
bh
);

160 
	`waô_⁄_buf„r
(
bh
);

161 i‡(
	`buf„r_u±od©e
(
bh
))

162  
bh
;

163 
	`put_bh
(
bh
);

164  
	`ERR_PTR
(-
EIO
);

165 
	}
}

167 
	$pxt4_vîify_csum_ty≥
(
su≥r_block
 *
sb
,

168 
pxt4_su≥r_block
 *
es
)

170 i‡(!
	`pxt4_has_„©uª_mëad©a_csum
(
sb
))

173  
es
->
s_checksum_ty≥
 =
PXT4_CRC32C_CHKSUM
;

174 
	}
}

176 
__À32
 
	$pxt4_su≥rblock_csum
(
su≥r_block
 *
sb
,

177 
pxt4_su≥r_block
 *
es
)

179 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

180 
off£t
 = 
	`off£tof
(
pxt4_su≥r_block
, 
s_checksum
);

181 
__u32
 
csum
;

183 
csum
 = 
	`pxt4_chksum
(
sbi
, ~0, (*)
es
, 
off£t
);

185  
	`˝u_to_À32
(
csum
);

186 
	}
}

188 
	$pxt4_su≥rblock_csum_vîify
(
su≥r_block
 *
sb
,

189 
pxt4_su≥r_block
 *
es
)

191 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

194  
es
->
s_checksum
 =
	`pxt4_su≥rblock_csum
(
sb
,És);

195 
	}
}

197 
	$pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
)

199 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

201 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

204 
es
->
s_checksum
 = 
	`pxt4_su≥rblock_csum
(
sb
,És);

205 
	}
}

207 *
	$pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

209 *
ªt
;

211 
ªt
 = 
	`kmÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

212 i‡(!
ªt
)

213 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
, 
PAGE_KERNEL
);

214  
ªt
;

215 
	}
}

217 *
	$pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

219 *
ªt
;

221 
ªt
 = 
	`kzÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

222 i‡(!
ªt
)

223 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
 | 
__GFP_ZERO
, 
PAGE_KERNEL
);

224  
ªt
;

225 
	}
}

227 
pxt4_fsblk_t
 
	$pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

228 
pxt4_group_desc
 *
bg
)

230  
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_lo
) |

231 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

232 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_hi
) << 32 : 0);

233 
	}
}

235 
pxt4_fsblk_t
 
	$pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

236 
pxt4_group_desc
 *
bg
)

238  
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_lo
) |

239 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

240 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_hi
) << 32 : 0);

241 
	}
}

243 
pxt4_fsblk_t
 
	$pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

244 
pxt4_group_desc
 *
bg
)

246  
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_lo
) |

247 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

248 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_hi
) << 32 : 0);

249 
	}
}

251 
__u32
 
	$pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

252 
pxt4_group_desc
 *
bg
)

254  
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_lo
) |

255 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

256 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_hi
) << 16 : 0);

257 
	}
}

259 
__u32
 
	$pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

260 
pxt4_group_desc
 *
bg
)

262  
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_lo
) |

263 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

264 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_hi
) << 16 : 0);

265 
	}
}

267 
__u32
 
	$pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

268 
pxt4_group_desc
 *
bg
)

270  
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_lo
) |

271 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

272 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_hi
) << 16 : 0);

273 
	}
}

275 
__u32
 
	$pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

276 
pxt4_group_desc
 *
bg
)

278  
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_lo
) |

279 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

280 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_hi
) << 16 : 0);

281 
	}
}

283 
	$pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

284 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

286 
bg
->
bg_block_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

287 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

288 
bg
->
bg_block_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

289 
	}
}

291 
	$pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

292 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

294 
bg
->
bg_öode_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

295 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

296 
bg
->
bg_öode_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

297 
	}
}

299 
	$pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

300 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

302 
bg
->
bg_öode_èbÀ_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

303 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

304 
bg
->
bg_öode_èbÀ_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

305 
	}
}

307 
	$pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

308 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

310 
bg
->
bg_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

311 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

312 
bg
->
bg_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

313 
	}
}

315 
	$pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

316 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

318 
bg
->
bg_‰ì_öodes_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

319 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

320 
bg
->
bg_‰ì_öodes_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

321 
	}
}

323 
	$pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

324 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

326 
bg
->
bg_u£d_dús_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

327 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

328 
bg
->
bg_u£d_dús_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

329 
	}
}

331 
	$pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

332 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

334 
bg
->
bg_ôabÀ_unu£d_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

335 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

336 
bg
->
bg_ôabÀ_unu£d_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

337 
	}
}

339 
	$__pxt4_upd©e_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

341 
time64_t
 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

343 
now
 = 
	`˛amp_vÆ
(now, 0, (1ull << 40) - 1);

345 *
lo
 = 
	`˝u_to_À32
(
	`lowî_32_bôs
(
now
));

346 *
hi
 = 
	`uµî_32_bôs
(
now
);

347 
	}
}

349 
time64_t
 
	$__pxt4_gë_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

351  ((
time64_t
)(*
hi
Ë<< 32Ë+ 
	`À32_to_˝u
(*
lo
);

352 
	}
}

353 
	#pxt4_upd©e_t°amp
(
es
, 
t°amp
) \

354 
	`__pxt4_upd©e_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

355 
	#pxt4_gë_t°amp
(
es
, 
t°amp
) \

356 
	`__pxt4_gë_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

358 
	$__ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

359 
löe
)

361 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

363 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

364 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
))

366 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

367 
	`pxt4_upd©e_t°amp
(
es
, 
s_œ°_îr‹_time
);

368 
	`°∫˝y
(
es
->
s_œ°_îr‹_func
, 
func
, (es->s_last_error_func));

369 
es
->
s_œ°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

370 i‡(!
es
->
s_fú°_îr‹_time
) {

371 
es
->
s_fú°_îr‹_time
 =És->
s_œ°_îr‹_time
;

372 
es
->
s_fú°_îr‹_time_hi
 =És->
s_œ°_îr‹_time_hi
;

373 
	`°∫˝y
(
es
->
s_fú°_îr‹_func
, 
func
,

374 (
es
->
s_fú°_îr‹_func
));

375 
es
->
s_fú°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

376 
es
->
s_fú°_îr‹_öo
 =És->
s_œ°_îr‹_öo
;

377 
es
->
s_fú°_îr‹_block
 =És->
s_œ°_îr‹_block
;

383 i‡(!
es
->
s_îr‹_cou¡
)

384 
	`mod_timî
(&
	`PXT4_SB
(
sb
)->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

385 
	`À32_add_˝u
(&
es
->
s_îr‹_cou¡
, 1);

386 
	}
}

388 
	$ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

389 
löe
)

391 
	`__ßve_îr‹_öfo
(
sb
, 
func
, 
löe
);

392 i‡(!
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
))

393 
	`pxt4_commô_su≥r
(
sb
, 1);

394 
	}
}

404 
	$block_devi˚_eje˘ed
(
su≥r_block
 *
sb
)

406 
öode
 *
bd_öode
 = 
sb
->
s_bdev
->bd_inode;

407 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
bd_öode
);

409  
bdi
->
dev
 =
NULL
;

410 
	}
}

412 
	$pxt4_jou∫Æ_commô_ˇŒback
(
jou∫Æ_t
 *
jou∫Æ
, 
å™ß˘i⁄_t
 *
txn
)

414 
su≥r_block
 *
sb
 = 
jou∫Æ
->
j_¥iv©e
;

415 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

416 
îr‹
 = 
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
);

417 
pxt4_jou∫Æ_cb_íåy
 *
j˚
;

419 
	`BUG_ON
(
txn
->
t_°©e
 =
T_FINISHED
);

421 
	`pxt4_¥o˚ss_‰ìd_d©a
(
sb
, 
txn
->
t_tid
);

423 
	`•ö_lock
(&
sbi
->
s_md_lock
);

424 !
	`li°_em±y
(&
txn
->
t_¥iv©e_li°
)) {

425 
j˚
 = 
	`li°_íåy
(
txn
->
t_¥iv©e_li°
.
√xt
,

426 
pxt4_jou∫Æ_cb_íåy
, 
j˚_li°
);

427 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

428 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

429 
j˚
->
	`j˚_func
(
sb
, j˚, 
îr‹
);

430 
	`•ö_lock
(&
sbi
->
s_md_lock
);

432 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

433 
	}
}

435 
boﬁ
 
	$sy°em_goög_down
()

437  
sy°em_°©e
 =
SYSTEM_HALT
 || sy°em_°©ê=
SYSTEM_POWER_OFF


438 || 
sy°em_°©e
 =
SYSTEM_RESTART
;

439 
	}
}

456 
	$pxt4_h™dÀ_îr‹
(
su≥r_block
 *
sb
)

458 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

459 
	`WARN_ON_ONCE
(1);

461 i‡(
	`sb_rd⁄ly
(
sb
))

464 i‡(!
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

465 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

467 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

468 i‡(
jou∫Æ
)

469 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

476 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë|| 
	`sy°em_goög_down
()) {

477 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

482 
	`smp_wmb
();

483 
sb
->
s_Êags
 |
SB_RDONLY
;

484 } i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
)) {

485 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

486 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

488 
	`∑nic
("PXT4-fs (device %s):Öanic forcedáfterÉrror\n",

489 
sb
->
s_id
);

491 
	}
}

493 
	#pxt4_îr‹_øãlimô
(
sb
) \

494 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_îr_øãlimô_°©e
), \

495 "PXT4-f†îr‹")

	)

497 
	$__pxt4_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

498 
löe
, c⁄° *
fmt
, ...)

500 
va_f‹m©
 
vaf
;

501 
va_li°
 
¨gs
;

503 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

506 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

507 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

508 
	`va_°¨t
(
¨gs
, 
fmt
);

509 
vaf
.
fmt
 = fmt;

510 
vaf
.
va
 = &
¨gs
;

511 
	`¥ötk
(
KERN_CRIT


513 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
cuºít
->
comm
, &
vaf
);

514 
	`va_íd
(
¨gs
);

516 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

517 
	`pxt4_h™dÀ_îr‹
(
sb
);

518 
	}
}

520 
	$__pxt4_îr‹_öode
(
öode
 *öode, c⁄° *
fun˘i⁄
,

521 
löe
, 
pxt4_fsblk_t
 
block
,

522 c⁄° *
fmt
, ...)

524 
va_li°
 
¨gs
;

525 
va_f‹m©
 
vaf
;

526 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

528 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

531 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

532 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

533 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

534 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

535 
	`va_°¨t
(
¨gs
, 
fmt
);

536 
vaf
.
fmt
 = fmt;

537 
vaf
.
va
 = &
¨gs
;

538 i‡(
block
)

539 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

541 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

542 
block
, 
cuºít
->
comm
, &
vaf
);

544 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

546 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

547 
cuºít
->
comm
, &
vaf
);

548 
	`va_íd
(
¨gs
);

550 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

551 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

552 
	}
}

554 
	$__pxt4_îr‹_fûe
(
fûe
 *fûe, c⁄° *
fun˘i⁄
,

555 
löe
, 
pxt4_fsblk_t
 
block
,

556 c⁄° *
fmt
, ...)

558 
va_li°
 
¨gs
;

559 
va_f‹m©
 
vaf
;

560 
pxt4_su≥r_block
 *
es
;

561 
öode
 *öodê
	`fûe_öode
(
fûe
);

562 
∑th«me
[80], *
∑th
;

564 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

567 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

568 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

569 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

570 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

571 
∑th
 = 
	`fûe_∑th
(
fûe
, 
∑th«me
, (pathname));

572 i‡(
	`IS_ERR
(
∑th
))

573 
∑th
 = "(unknown)";

574 
	`va_°¨t
(
¨gs
, 
fmt
);

575 
vaf
.
fmt
 = fmt;

576 
vaf
.
va
 = &
¨gs
;

577 i‡(
block
)

578 
	`¥ötk
(
KERN_CRIT


581 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

582 
block
, 
cuºít
->
comm
, 
∑th
, &
vaf
);

584 
	`¥ötk
(
KERN_CRIT


587 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

588 
cuºít
->
comm
, 
∑th
, &
vaf
);

589 
	`va_íd
(
¨gs
);

591 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

592 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

593 
	}
}

595 c⁄° *
	$pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

596 
nbuf
[16])

598 *
îr°r
 = 
NULL
;

600 
î∫o
) {

601 -
EFSCORRUPTED
:

602 
îr°r
 = "Corrupt filesystem";

604 -
EFSBADCRC
:

605 
îr°r
 = "Filesystem failed CRC";

607 -
EIO
:

608 
îr°r
 = "IO failure";

610 -
ENOMEM
:

611 
îr°r
 = "Out of memory";

613 -
EROFS
:

614 i‡(!
sb
 || (
	`PXT4_SB
(sb)->
s_jou∫Æ
 &&

615 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
))

616 
îr°r
 = "Journal hasáborted";

618 
îr°r
 = "Readonly filesystem";

624 i‡(
nbuf
) {

626 i‡(
	`¢¥ötf
(
nbuf
, 16, "îr‹ %d", -
î∫o
) >= 0)

627 
îr°r
 = 
nbuf
;

632  
îr°r
;

633 
	}
}

638 
	$__pxt4_°d_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

639 
löe
, 
î∫o
)

641 
nbuf
[16];

642 c⁄° *
îr°r
;

644 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

650 i‡(
î∫o
 =-
EROFS
 && 
	`jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
 && 
	`sb_rd⁄ly
(
sb
))

653 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

654 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
î∫o
, 
nbuf
);

655 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s) in %s:%d: %s\n",

656 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
îr°r
);

659 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

660 
	`pxt4_h™dÀ_îr‹
(
sb
);

661 
	}
}

673 
	$__pxt4_ab‹t
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

674 
löe
, c⁄° *
fmt
, ...)

676 
va_f‹m©
 
vaf
;

677 
va_li°
 
¨gs
;

679 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

682 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

683 
	`va_°¨t
(
¨gs
, 
fmt
);

684 
vaf
.
fmt
 = fmt;

685 
vaf
.
va
 = &
¨gs
;

686 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: %pV\n",

687 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

688 
	`va_íd
(
¨gs
);

690 i‡(
	`sb_rd⁄ly
(
sb
) == 0) {

691 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

692 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

697 
	`smp_wmb
();

698 
sb
->
s_Êags
 |
SB_RDONLY
;

699 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

700 
	`jbd3_jou∫Æ_ab‹t
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, -
EIO
);

701 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

703 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& !
	`sy°em_goög_down
()) {

704 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

705 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

707 
	`∑nic
("PXT4-fsÖanic fromÖreviousÉrror\n");

709 
	}
}

711 
	$__pxt4_msg
(
su≥r_block
 *
sb
,

712 c⁄° *
¥efix
, c⁄° *
fmt
, ...)

714 
va_f‹m©
 
vaf
;

715 
va_li°
 
¨gs
;

717 i‡(!
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_msg_øãlimô_°©e
), "PXT4-fs"))

720 
	`va_°¨t
(
¨gs
, 
fmt
);

721 
vaf
.
fmt
 = fmt;

722 
vaf
.
va
 = &
¨gs
;

723 
	`¥ötk
("%sPXT4-f†(%s): %pV\n", 
¥efix
, 
sb
->
s_id
, &
vaf
);

724 
	`va_íd
(
¨gs
);

725 
	}
}

727 
	#pxt4_w¨nög_øãlimô
(
sb
) \

728 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_w¨nög_øãlimô_°©e
), \

729 "PXT4-f†w¨nög")

	)

731 
	$__pxt4_w¨nög
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

732 
löe
, c⁄° *
fmt
, ...)

734 
va_f‹m©
 
vaf
;

735 
va_li°
 
¨gs
;

737 i‡(!
	`pxt4_w¨nög_øãlimô
(
sb
))

740 
	`va_°¨t
(
¨gs
, 
fmt
);

741 
vaf
.
fmt
 = fmt;

742 
vaf
.
va
 = &
¨gs
;

743 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: %pV\n",

744 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

745 
	`va_íd
(
¨gs
);

746 
	}
}

748 
	$__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

749 
löe
, c⁄° *
fmt
, ...)

751 
va_f‹m©
 
vaf
;

752 
va_li°
 
¨gs
;

754 i‡(!
	`pxt4_w¨nög_øãlimô
(
öode
->
i_sb
))

757 
	`va_°¨t
(
¨gs
, 
fmt
);

758 
vaf
.
fmt
 = fmt;

759 
vaf
.
va
 = &
¨gs
;

760 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: "

761 "öodê#%lu: comm %s: %pV\n", 
öode
->
i_sb
->
s_id
,

762 
fun˘i⁄
, 
löe
, 
öode
->
i_öo
, 
cuºít
->
comm
, &
vaf
);

763 
	`va_íd
(
¨gs
);

764 
	}
}

766 
	$__pxt4_gΩ_locked_îr‹
(c⁄° *
fun˘i⁄
, 
löe
,

767 
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

768 
öo
, 
pxt4_fsblk_t
 
block
,

769 c⁄° *
fmt
, ...)

770 
	$__ªÀa£s
(
bôlock
)

771 
	$__acquúes
(
bôlock
)

773 
va_f‹m©
 
vaf
;

774 
va_li°
 
¨gs
;

775 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

777 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

780 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

781 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öo
);

782 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

783 
	`__ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

785 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

786 
	`va_°¨t
(
¨gs
, 
fmt
);

787 
vaf
.
fmt
 = fmt;

788 
vaf
.
va
 = &
¨gs
;

789 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: group %u, ",

790 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
gΩ
);

791 i‡(
öo
)

792 
	`¥ötk
(
KERN_CONT
 "öodê%lu: ", 
öo
);

793 i‡(
block
)

794 
	`¥ötk
(
KERN_CONT
 "block %llu:",

795 (Ë
block
);

796 
	`¥ötk
(
KERN_CONT
 "%pV\n", &
vaf
);

797 
	`va_íd
(
¨gs
);

800 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

801 
	`WARN_ON_ONCE
(1);

803 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

804 
	`pxt4_commô_su≥r
(
sb
, 0);

808 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

809 
	`pxt4_commô_su≥r
(
sb
, 1);

810 
	`pxt4_h™dÀ_îr‹
(
sb
);

822 
	`pxt4_lock_group
(
sb
, 
gΩ
);

824 
	}
}

826 
	$pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

827 
pxt4_group_t
 
group
,

828 
Êags
)

830 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

831 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

832 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

833 
ªt
;

835 i‡(
Êags
 & 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
) {

836 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
,

837 &
gΩ
->
bb_°©e
);

838 i‡(!
ªt
)

839 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

840 
gΩ
->
bb_‰ì
);

843 i‡(
Êags
 & 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
) {

844 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
,

845 &
gΩ
->
bb_°©e
);

846 i‡(!
ªt
 && 
gdp
) {

847 
cou¡
;

849 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

850 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ìöodes_cou¡î
,

851 
cou¡
);

854 
	}
}

856 
	$pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
)

858 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

860 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_GOOD_OLD_REV
)

863 
	`pxt4_w¨nög
(
sb
,

866 
PXT4_DYNAMIC_REV
);

868 
es
->
s_fú°_öo
 = 
	`˝u_to_À32
(
PXT4_GOOD_OLD_FIRST_INO
);

869 
es
->
s_öode_size
 = 
	`˝u_to_À16
(
PXT4_GOOD_OLD_INODE_SIZE
);

870 
es
->
s_ªv_Àvñ
 = 
	`˝u_to_À32
(
PXT4_DYNAMIC_REV
);

879 
	}
}

884 
block_devi˚
 *
	$pxt4_blkdev_gë
(
dev_t
 
dev
, 
su≥r_block
 *
sb
)

886 
block_devi˚
 *
bdev
;

887 
b
[
BDEVNAME_SIZE
];

889 
bdev
 = 
	`blkdev_gë_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
, 
sb
);

890 i‡(
	`IS_ERR
(
bdev
))

891 
Áû
;

892  
bdev
;

894 
Áû
:

895 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo open journal device %s: %ld",

896 
	`__bdev«me
(
dev
, 
b
), 
	`PTR_ERR
(
bdev
));

897  
NULL
;

898 
	}
}

903 
	$pxt4_blkdev_put
(
block_devi˚
 *
bdev
)

905 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

906 
	}
}

908 
	$pxt4_blkdev_ªmove
(
pxt4_sb_öfo
 *
sbi
)

910 
block_devi˚
 *
bdev
;

911 
bdev
 = 
sbi
->
jou∫Æ_bdev
;

912 i‡(
bdev
) {

913 
	`pxt4_blkdev_put
(
bdev
);

914 
sbi
->
jou∫Æ_bdev
 = 
NULL
;

916 
	}
}

918 
ölöe
 
öode
 *
	$‹ph™_li°_íåy
(
li°_hód
 *
l
)

920  &
	`li°_íåy
(
l
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

921 
	}
}

923 
	$dump_‹ph™_li°
(
su≥r_block
 *
sb
, 
pxt4_sb_öfo
 *
sbi
)

925 
li°_hód
 *
l
;

927 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "sb orphan head is %d",

928 
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
));

930 
	`¥ötk
(
KERN_ERR
 "sb_info orphanÜist:\n");

931 
	`li°_f‹_óch
(
l
, &
sbi
->
s_‹ph™
) {

932 
öode
 *öodê
	`‹ph™_li°_íåy
(
l
);

933 
	`¥ötk
(
KERN_ERR
 " "

935 
öode
->
i_sb
->
s_id
, inode->
i_öo
, inode,

936 
öode
->
i_mode
, inode->
i_∆ök
,

937 
	`NEXT_ORPHAN
(
öode
));

939 
	}
}

941 #ifde‡
CONFIG_QUOTA


942 
pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
);

944 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

946 
ty≥
;

949 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++)

950 
	`pxt4_quŸa_off
(
sb
, 
ty≥
);

951 
	}
}

957 
ölöe
 *
	$gë_qf_«me
(
su≥r_block
 *
sb
,

958 
pxt4_sb_öfo
 *
sbi
,

959 
ty≥
)

961  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
sbi
->
s_qf_«mes
[
ty≥
],

962 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

963 
	}
}

965 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

967 
	}
}

970 
	$pxt4_put_su≥r
(
su≥r_block
 *
sb
)

972 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

973 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

974 
buf„r_hód
 **
group_desc
;

975 
Êex_groups
 **flex_groups;

976 
ab‹ãd
 = 0;

977 
i
, 
îr
;

979 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

980 
	`pxt4_quŸa_off_umou¡
(
sb
);

982 
	`de°roy_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

984 i‡(
sbi
->
s_jou∫Æ
) {

985 
ab‹ãd
 = 
	`is_jou∫Æ_ab‹ãd
(
sbi
->
s_jou∫Æ
);

986 
îr
 = 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

987 
sbi
->
s_jou∫Æ
 = 
NULL
;

988 i‡((
îr
 < 0Ë&& !
ab‹ãd
)

989 
	`pxt4_ab‹t
(
sb
, "Couldn't clean upÅhe journal");

992 
	`pxt4_uƒegi°î_sysfs
(
sb
);

993 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

994 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

995 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

996 
	`pxt4_mb_ªÀa£
(
sb
);

997 
	`pxt4_ext_ªÀa£
(
sb
);

999 i‡(!
	`sb_rd⁄ly
(
sb
Ë&& !
ab‹ãd
) {

1000 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

1001 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

1003 i‡(!
	`sb_rd⁄ly
(
sb
))

1004 
	`pxt4_commô_su≥r
(
sb
, 1);

1006 
	`rcu_ªad_lock
();

1007 
group_desc
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
);

1008 
i
 = 0; i < 
sbi
->
s_gdb_cou¡
; i++)

1009 
	`bªl£
(
group_desc
[
i
]);

1010 
	`kv‰ì
(
group_desc
);

1011 
Êex_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

1012 i‡(
Êex_groups
) {

1013 
i
 = 0; i < 
sbi
->
s_Êex_groups_Æloˇãd
; i++)

1014 
	`kv‰ì
(
Êex_groups
[
i
]);

1015 
	`kv‰ì
(
Êex_groups
);

1017 
	`rcu_ªad_u∆ock
();

1018 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

1019 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

1020 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

1021 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

1022 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

1023 #ifde‡
CONFIG_QUOTA


1024 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

1025 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

1032 i‡(!
	`li°_em±y
(&
sbi
->
s_‹ph™
))

1033 
	`dump_‹ph™_li°
(
sb
, 
sbi
);

1034 
	`J_ASSERT
(
	`li°_em±y
(&
sbi
->
s_‹ph™
));

1036 
	`sync_blockdev
(
sb
->
s_bdev
);

1037 
	`övÆid©e_bdev
(
sb
->
s_bdev
);

1038 i‡(
sbi
->
jou∫Æ_bdev
 && sbi->jou∫Æ_bdev !
sb
->
s_bdev
) {

1044 
	`sync_blockdev
(
sbi
->
jou∫Æ_bdev
);

1045 
	`övÆid©e_bdev
(
sbi
->
jou∫Æ_bdev
);

1046 
	`pxt4_blkdev_ªmove
(
sbi
);

1049 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

1050 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

1052 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

1053 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

1055 i‡(
sbi
->
s_mmp_tsk
)

1056 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

1057 
	`bªl£
(
sbi
->
s_sbh
);

1058 
sb
->
s_fs_öfo
 = 
NULL
;

1063 
	`kobje˘_put
(&
sbi
->
s_kobj
);

1064 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

1065 i‡(
sbi
->
s_chksum_drivî
)

1066 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

1067 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

1068 
	`fs_put_dax
(
sbi
->
s_daxdev
);

1069 #ifde‡
CONFIG_UNICODE


1070 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

1072 
	`k‰ì
(
sbi
);

1073 
	}
}

1075 
kmem_ˇche
 *
	gpxt4_öode_ˇchï
;

1080 
öode
 *
	$pxt4_Æloc_öode
(
su≥r_block
 *
sb
)

1082 
pxt4_öode_öfo
 *
ei
;

1084 
ei
 = 
	`kmem_ˇche_Æloc
(
pxt4_öode_ˇchï
, 
GFP_NOFS
);

1085 i‡(!
ei
)

1086  
NULL
;

1088 
	`öode_£t_ivîsi⁄
(&
ei
->
vfs_öode
, 1);

1089 
	`•ö_lock_öô
(&
ei
->
i_øw_lock
);

1090 
	`INIT_LIST_HEAD
(&
ei
->
i_¥óŒoc_li°
);

1091 
	`•ö_lock_öô
(&
ei
->
i_¥óŒoc_lock
);

1092 
	`pxt4_es_öô_åì
(&
ei
->
i_es_åì
);

1093 
	`rwlock_öô
(&
ei
->
i_es_lock
);

1094 
	`INIT_LIST_HEAD
(&
ei
->
i_es_li°
);

1095 
ei
->
i_es_Æl_ƒ
 = 0;

1096 
ei
->
i_es_shk_ƒ
 = 0;

1097 
ei
->
i_es_shrök_lblk
 = 0;

1098 
ei
->
i_ª£rved_d©a_blocks
 = 0;

1099 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

1100 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 0;

1101 
	`•ö_lock_öô
(&(
ei
->
i_block_ª£rv©i⁄_lock
));

1102 
	`pxt4_öô_≥ndög_åì
(&
ei
->
i_≥ndög_åì
);

1103 #ifde‡
CONFIG_QUOTA


1104 
ei
->
i_ª£rved_quŸa
 = 0;

1105 
	`mem£t
(&
ei
->
i_dquŸ
, 0, (ei->i_dquot));

1107 
ei
->
jöode
 = 
NULL
;

1108 
	`INIT_LIST_HEAD
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
);

1109 
	`•ö_lock_öô
(&
ei
->
i_com∂ëed_io_lock
);

1110 
ei
->
i_sync_tid
 = 0;

1111 
ei
->
i_d©async_tid
 = 0;

1112 
	`©omic_£t
(&
ei
->
i_unwrôãn
, 0);

1113 
	`INIT_WORK
(&
ei
->
i_rsv_c⁄vîsi⁄_w‹k
, 
pxt4_íd_io_rsv_w‹k
);

1114  &
ei
->
vfs_öode
;

1115 
	}
}

1117 
	$pxt4_dr›_öode
(
öode
 *inode)

1119 
dr›
 = 
	`gíîic_dr›_öode
(
öode
);

1121 i‡(!
dr›
)

1122 
dr›
 = 
	`fs¸y±_dr›_öode
(
öode
);

1124 
	`åa˚_pxt4_dr›_öode
(
öode
, 
dr›
);

1125  
dr›
;

1126 
	}
}

1128 
	$pxt4_‰ì_ö_c‹e_öode
(
öode
 *inode)

1130 
	`fs¸y±_‰ì_öode
(
öode
);

1131 
	`kmem_ˇche_‰ì
(
pxt4_öode_ˇchï
, 
	`PXT4_I
(
öode
));

1132 
	}
}

1134 
	$pxt4_de°roy_öode
(
öode
 *inode)

1136 i‡(!
	`li°_em±y
(&(
	`PXT4_I
(
öode
)->
i_‹ph™
))) {

1137 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_ERR
,

1139 
öode
->
i_öo
, 
	`PXT4_I
(inode));

1140 
	`¥öt_hex_dump
(
KERN_INFO
, "", 
DUMP_PREFIX_ADDRESS
, 16, 4,

1141 
	`PXT4_I
(
öode
), (
pxt4_öode_öfo
),

1142 
åue
);

1143 
	`dump_°ack
();

1145 
	}
}

1147 
	$öô_⁄˚
(*
foo
)

1149 
pxt4_öode_öfo
 *
ei
 = (pxt4_öode_öfÿ*Ë
foo
;

1151 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

1152 
	`öô_rw£m
(&
ei
->
x©å_£m
);

1153 
	`öô_rw£m
(&
ei
->
i_d©a_£m
);

1154 
	`öô_rw£m
(&
ei
->
i_mm≠_£m
);

1155 
	`öode_öô_⁄˚
(&
ei
->
vfs_öode
);

1156 
	}
}

1158 
__öô
 
	$öô_öodeˇche
()

1160 
pxt4_öode_ˇchï
 = 
	`kmem_ˇche_¸óã_u£rc›y
("pxt4_inode_cache",

1161 (
pxt4_öode_öfo
), 0,

1162 (
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
|

1163 
SLAB_ACCOUNT
),

1164 
	`off£tof
(
pxt4_öode_öfo
, 
i_d©a
),

1165 
	`sizeof_fõld
(
pxt4_öode_öfo
, 
i_d©a
),

1166 
öô_⁄˚
);

1167 i‡(
pxt4_öode_ˇchï
 =
NULL
)

1168  -
ENOMEM
;

1170 
	}
}

1172 
	$de°roy_öodeˇche
()

1178 
	`rcu_b¨rõr
();

1179 
	`kmem_ˇche_de°roy
(
pxt4_öode_ˇchï
);

1180 
	}
}

1182 
	$pxt4_˛ór_öode
(
öode
 *inode)

1184 
	`övÆid©e_öode_buf„rs
(
öode
);

1185 
	`˛ór_öode
(
öode
);

1186 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

1187 
	`pxt4_es_ªmove_exã¡
(
öode
, 0, 
EXT_MAX_BLOCKS
);

1188 
	`dquŸ_dr›
(
öode
);

1189 i‡(
	`PXT4_I
(
öode
)->
jöode
) {

1190 
	`jbd3_jou∫Æ_ªÀa£_jbd_öode
(
	`PXT4_JOURNAL
(
öode
),

1191 
	`PXT4_I
(
öode
)->
jöode
);

1192 
	`jbd3_‰ì_öode
(
	`PXT4_I
(
öode
)->
jöode
);

1193 
	`PXT4_I
(
öode
)->
jöode
 = 
NULL
;

1195 
	`fs¸y±_put_í¸y±i⁄_öfo
(
öode
);

1196 
	`fsvîôy_˛ónup_öode
(
öode
);

1197 
	}
}

1199 
öode
 *
	$pxt4_nfs_gë_öode
(
su≥r_block
 *
sb
,

1200 
u64
 
öo
, 
u32
 
gíî©i⁄
)

1202 
öode
 *inode;

1208 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_HANDLE
);

1209 i‡(
	`IS_ERR
(
öode
))

1210  
	`ERR_CAST
(
öode
);

1211 i‡(
gíî©i⁄
 && 
öode
->
i_gíî©i⁄
 != generation) {

1212 
	`ùut
(
öode
);

1213  
	`ERR_PTR
(-
ESTALE
);

1216  
öode
;

1217 
	}
}

1219 
díåy
 *
	$pxt4_fh_to_díåy
(
su≥r_block
 *
sb
, 
fid
 *fid,

1220 
fh_Àn
, 
fh_ty≥
)

1222  
	`gíîic_fh_to_díåy
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1223 
pxt4_nfs_gë_öode
);

1224 
	}
}

1226 
díåy
 *
	$pxt4_fh_to_∑ª¡
(
su≥r_block
 *
sb
, 
fid
 *fid,

1227 
fh_Àn
, 
fh_ty≥
)

1229  
	`gíîic_fh_to_∑ª¡
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1230 
pxt4_nfs_gë_öode
);

1231 
	}
}

1233 
	$pxt4_nfs_commô_mëad©a
(
öode
 *inode)

1235 
wrôeback_c⁄åﬁ
 
wbc
 = {

1236 .
sync_mode
 = 
WB_SYNC_ALL


1239 
	`åa˚_pxt4_nfs_commô_mëad©a
(
öode
);

1240  
	`pxt4_wrôe_öode
(
öode
, &
wbc
);

1241 
	}
}

1249 
	$bdev_åy_to_‰ì_∑ge
(
su≥r_block
 *
sb
, 
∑ge
 *page,

1250 
gÂ_t
 
waô
)

1252 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

1254 
	`WARN_ON
(
	`PageChecked
(
∑ge
));

1255 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1257 i‡(
jou∫Æ
)

1258  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
,

1259 
waô
 & ~
__GFP_DIRECT_RECLAIM
);

1260  
	`åy_to_‰ì_buf„rs
(
∑ge
);

1261 
	}
}

1263 #ifde‡
CONFIG_FS_ENCRYPTION


1264 
	$pxt4_gë_c⁄ãxt
(
öode
 *öode, *
˘x
, 
size_t
 
Àn
)

1266  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1267 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
, 
˘x
, 
Àn
);

1268 
	}
}

1270 
	$pxt4_£t_c⁄ãxt
(
öode
 *öode, c⁄° *
˘x
, 
size_t
 
Àn
,

1271 *
fs_d©a
)

1273 
h™dÀ_t
 *
h™dÀ
 = 
fs_d©a
;

1274 
ªs
, 
ªs2
, 
¸edôs
, 
ªåõs
 = 0;

1282 i‡(
öode
->
i_öo
 =
PXT4_ROOT_INO
)

1283  -
EPERM
;

1285 i‡(
	`WARN_ON_ONCE
(
	`IS_DAX
(
öode
Ë&& 
	`i_size_ªad
(inode)))

1286  -
EINVAL
;

1288 
ªs
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

1289 i‡(
ªs
)

1290  
ªs
;

1300 i‡(
h™dÀ
) {

1301 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

1302 
PXT4_XATTR_INDEX_ENCRYPTION
,

1303 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1304 
˘x
, 
Àn
, 0);

1305 i‡(!
ªs
) {

1306 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1307 
	`pxt4_˛ór_öode_°©e
(
öode
,

1308 
PXT4_STATE_MAY_INLINE_DATA
);

1313 
	`pxt4_£t_öode_Êags
(
öode
);

1315  
ªs
;

1318 
ªs
 = 
	`dquŸ_öôülize
(
öode
);

1319 i‡(
ªs
)

1320  
ªs
;

1321 
ªåy
:

1322 
ªs
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
Àn
, 
Ál£
 ,

1323 &
¸edôs
);

1324 i‡(
ªs
)

1325  
ªs
;

1327 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

1328 i‡(
	`IS_ERR
(
h™dÀ
))

1329  
	`PTR_ERR
(
h™dÀ
);

1331 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1332 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1333 
˘x
, 
Àn
, 0);

1334 i‡(!
ªs
) {

1335 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1340 
	`pxt4_£t_öode_Êags
(
öode
);

1341 
ªs
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1342 i‡(
ªs
)

1343 
	`PXT4_ERROR_INODE
(
öode
, "FailedÅo mark inode dirty");

1345 
ªs2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1347 i‡(
ªs
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1348 
ªåy
;

1349 i‡(!
ªs
)

1350 
ªs
 = 
ªs2
;

1351  
ªs
;

1352 
	}
}

1354 
boﬁ
 
	$pxt4_dummy_c⁄ãxt
(
öode
 *inode)

1356  
	`DUMMY_ENCRYPTION_ENABLED
(
	`PXT4_SB
(
öode
->
i_sb
));

1357 
	}
}

1359 c⁄° 
fs¸y±_›î©i⁄s
 
	gpxt4_¸y±›s
 = {

1360 .
key_¥efix
 = "pxt4:",

1361 .
	ggë_c⁄ãxt
 = 
pxt4_gë_c⁄ãxt
,

1362 .
	g£t_c⁄ãxt
 = 
pxt4_£t_c⁄ãxt
,

1363 .
	gdummy_c⁄ãxt
 = 
pxt4_dummy_c⁄ãxt
,

1364 .
	gem±y_dú
 = 
pxt4_em±y_dú
,

1365 .
	gmax_«mñí
 = 
PXT4_NAME_LEN
,

1369 #ifde‡
CONFIG_QUOTA


1370 c⁄° * c⁄° 
	gquŸ©y≥s
[] = 
INITQFNAMES
;

1371 
	#QTYPE2NAME
(
t
Ë(
quŸ©y≥s
[t])

	)

1373 
pxt4_wrôe_dquŸ
(
dquŸ
 *dquot);

1374 
pxt4_acquúe_dquŸ
(
dquŸ
 *dquot);

1375 
pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot);

1376 
pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot);

1377 
pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
);

1378 
pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1379 c⁄° 
∑th
 *path);

1380 
pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
);

1381 
ssize_t
 
pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

1382 
size_t
 
Àn
, 
loff_t
 
off
);

1383 
ssize_t
 
pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

1384 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
);

1385 
pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1386 
Êags
);

1387 
pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
);

1388 
pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
);

1390 
dquŸ
 **
	$pxt4_gë_dquŸs
(
öode
 *inode)

1392  
	`PXT4_I
(
öode
)->
i_dquŸ
;

1393 
	}
}

1395 c⁄° 
dquŸ_›î©i⁄s
 
	gpxt4_quŸa_›î©i⁄s
 = {

1396 .
gë_ª£rved_•a˚
 = 
pxt4_gë_ª£rved_•a˚
,

1397 .
	gwrôe_dquŸ
 = 
pxt4_wrôe_dquŸ
,

1398 .
	gacquúe_dquŸ
 = 
pxt4_acquúe_dquŸ
,

1399 .
	gªÀa£_dquŸ
 = 
pxt4_ªÀa£_dquŸ
,

1400 .
	gm¨k_dúty
 = 
pxt4_m¨k_dquŸ_dúty
,

1401 .
	gwrôe_öfo
 = 
pxt4_wrôe_öfo
,

1402 .
	gÆloc_dquŸ
 = 
dquŸ_Æloc
,

1403 .
	gde°roy_dquŸ
 = 
dquŸ_de°roy
,

1404 .
	ggë_¥ojid
 = 
pxt4_gë_¥ojid
,

1405 .
	ggë_öode_ußge
 = 
pxt4_gë_öode_ußge
,

1406 .
	ggë_√xt_id
 = 
pxt4_gë_√xt_id
,

1409 c⁄° 
quŸa˘l_›s
 
	gpxt4_q˘l_›î©i⁄s
 = {

1410 .
quŸa_⁄
 = 
pxt4_quŸa_⁄
,

1411 .
	gquŸa_off
 = 
pxt4_quŸa_off
,

1412 .
	gquŸa_sync
 = 
dquŸ_quŸa_sync
,

1413 .
	ggë_°©e
 = 
dquŸ_gë_°©e
,

1414 .
	g£t_öfo
 = 
dquŸ_£t_dqöfo
,

1415 .
	ggë_dqblk
 = 
dquŸ_gë_dqblk
,

1416 .
	g£t_dqblk
 = 
dquŸ_£t_dqblk
,

1417 .
	ggë_√xtdqblk
 = 
dquŸ_gë_√xt_dqblk
,

1421 c⁄° 
su≥r_›î©i⁄s
 
	gpxt4_s›s
 = {

1422 .
Æloc_öode
 = 
pxt4_Æloc_öode
,

1423 .
	g‰ì_öode
 = 
pxt4_‰ì_ö_c‹e_öode
,

1424 .
	gde°roy_öode
 = 
pxt4_de°roy_öode
,

1425 .
	gwrôe_öode
 = 
pxt4_wrôe_öode
,

1426 .
	gdúty_öode
 = 
pxt4_dúty_öode
,

1427 .
	gdr›_öode
 = 
pxt4_dr›_öode
,

1428 .
	gevi˘_öode
 = 
pxt4_evi˘_öode
,

1429 .
	gput_su≥r
 = 
pxt4_put_su≥r
,

1430 .
	gsync_fs
 = 
pxt4_sync_fs
,

1431 .
	g‰ìze_fs
 = 
pxt4_‰ìze
,

1432 .
	gun‰ìze_fs
 = 
pxt4_un‰ìze
,

1433 .
	g°©fs
 = 
pxt4_°©fs
,

1434 .
	gªmou¡_fs
 = 
pxt4_ªmou¡
,

1435 .
	gshow_›ti⁄s
 = 
pxt4_show_›ti⁄s
,

1436 #ifde‡
CONFIG_QUOTA


1437 .
	gquŸa_ªad
 = 
pxt4_quŸa_ªad
,

1438 .
	gquŸa_wrôe
 = 
pxt4_quŸa_wrôe
,

1439 .
	ggë_dquŸs
 = 
pxt4_gë_dquŸs
,

1441 .
	gbdev_åy_to_‰ì_∑ge
 = 
bdev_åy_to_‰ì_∑ge
,

1444 c⁄° 
exp‹t_›î©i⁄s
 
	gpxt4_exp‹t_›s
 = {

1445 .
fh_to_díåy
 = 
pxt4_fh_to_díåy
,

1446 .
	gfh_to_∑ª¡
 = 
pxt4_fh_to_∑ª¡
,

1447 .
	ggë_∑ª¡
 = 
pxt4_gë_∑ª¡
,

1448 .
	gcommô_mëad©a
 = 
pxt4_nfs_commô_mëad©a
,

1452 
	mO±_bsd_df
, 
	mO±_möix_df
, 
	mO±_gΩid
, 
	mO±_nogΩid
,

1453 
	mO±_ªsgid
, 
	mO±_ªsuid
, 
	mO±_sb
, 
	mO±_îr_c⁄t
, 
	mO±_îr_∑nic
, 
	mO±_îr_ro
,

1454 
	mO±_nouid32
, 
	mO±_debug
, 
	mO±_ªmoved
,

1455 
	mO±_u£r_x©å
, 
	mO±_nou£r_x©å
, 
	mO±_a˛
, 
	mO±_nﬂ˛
,

1456 
	mO±_auto_da_Æloc
, 
	mO±_nﬂuto_da_Æloc
, 
	mO±_nﬁﬂd
,

1457 
	mO±_commô
, 
	mO±_mö_b©ch_time
, 
	mO±_max_b©ch_time
, 
	mO±_jou∫Æ_dev
,

1458 
	mO±_jou∫Æ_∑th
, 
	mO±_jou∫Æ_checksum
, 
	mO±_jou∫Æ_async_commô
,

1459 
	mO±_ab‹t
, 
	mO±_d©a_jou∫Æ
, 
	mO±_d©a_‹dîed
, 
	mO±_d©a_wrôeback
,

1460 
	mO±_d©a_îr_ab‹t
, 
	mO±_d©a_îr_ign‹e
, 
	mO±_ã°_dummy_í¸y±i⁄
,

1461 
	mO±_u§jquŸa
, 
	mO±_gΩjquŸa
, 
	mO±_offu§jquŸa
, 
	mO±_offgΩjquŸa
,

1462 
	mO±_jqfmt_vfsﬁd
, 
	mO±_jqfmt_vfsv0
, 
	mO±_jqfmt_vfsv1
, 
	mO±_quŸa
,

1463 
	mO±_noquŸa
, 
	mO±_b¨rõr
, 
	mO±_nob¨rõr
, 
	mO±_îr
,

1464 
	mO±_u§quŸa
, 
	mO±_gΩquŸa
, 
	mO±_¥jquŸa
, 
	mO±_i_vîsi⁄
, 
	mO±_dax
,

1465 
	mO±_°rùe
, 
	mO±_dñÆloc
, 
	mO±_nodñÆloc
, 
	mO±_w¨n_⁄_îr‹
,

1466 
	mO±_now¨n_⁄_îr‹
, 
	mO±_mblk_io_submô
,

1467 
	mO±_œzytime
, 
	mO±_nﬁazytime
, 
	mO±_debug_w™t_exåa_isize
,

1468 
	mO±_nomblk_io_submô
, 
	mO±_block_vÆidôy
, 
	mO±_noblock_vÆidôy
,

1469 
	mO±_öode_ªadahód_blks
, 
	mO±_jou∫Æ_i›rio
,

1470 
	mO±_di‹ód_nﬁock
, 
	mO±_di‹ód_lock
,

1471 
	mO±_disˇrd
, 
	mO±_nodisˇrd
, 
	mO±_öô_ôabÀ
, 
	mO±_noöô_ôabÀ
,

1472 
	mO±_max_dú_size_kb
, 
	mO±_nojou∫Æ_checksum
, 
	mO±_nombˇche
,

1475 c⁄° 
m©ch_èbÀ_t
 
	gtokís
 = {

1476 {
O±_bsd_df
, "bsddf"},

1477 {
O±_möix_df
, "minixdf"},

1478 {
O±_gΩid
, "grpid"},

1479 {
O±_gΩid
, "bsdgroups"},

1480 {
O±_nogΩid
, "nogrpid"},

1481 {
O±_nogΩid
, "sysvgroups"},

1482 {
O±_ªsgid
, "resgid=%u"},

1483 {
O±_ªsuid
, "resuid=%u"},

1484 {
O±_sb
, "sb=%u"},

1485 {
O±_îr_c⁄t
, "errors=continue"},

1486 {
O±_îr_∑nic
, "errors=panic"},

1487 {
O±_îr_ro
, "errors=remount-ro"},

1488 {
O±_nouid32
, "nouid32"},

1489 {
O±_debug
, "debug"},

1490 {
O±_ªmoved
, "oldalloc"},

1491 {
O±_ªmoved
, "orlov"},

1492 {
O±_u£r_x©å
, "user_xattr"},

1493 {
O±_nou£r_x©å
, "nouser_xattr"},

1494 {
O±_a˛
, "acl"},

1495 {
O±_nﬂ˛
, "noacl"},

1496 {
O±_nﬁﬂd
, "norecovery"},

1497 {
O±_nﬁﬂd
, "noload"},

1498 {
O±_ªmoved
, "nobh"},

1499 {
O±_ªmoved
, "bh"},

1500 {
O±_commô
, "commit=%u"},

1501 {
O±_mö_b©ch_time
, "min_batch_time=%u"},

1502 {
O±_max_b©ch_time
, "max_batch_time=%u"},

1503 {
O±_jou∫Æ_dev
, "journal_dev=%u"},

1504 {
O±_jou∫Æ_∑th
, "journal_path=%s"},

1505 {
O±_jou∫Æ_checksum
, "journal_checksum"},

1506 {
O±_nojou∫Æ_checksum
, "nojournal_checksum"},

1507 {
O±_jou∫Æ_async_commô
, "journal_async_commit"},

1508 {
O±_ab‹t
, "abort"},

1509 {
O±_d©a_jou∫Æ
, "data=journal"},

1510 {
O±_d©a_‹dîed
, "data=ordered"},

1511 {
O±_d©a_wrôeback
, "data=writeback"},

1512 {
O±_d©a_îr_ab‹t
, "data_err=abort"},

1513 {
O±_d©a_îr_ign‹e
, "data_err=ignore"},

1514 {
O±_offu§jquŸa
, "usrjquota="},

1515 {
O±_u§jquŸa
, "usrjquota=%s"},

1516 {
O±_offgΩjquŸa
, "grpjquota="},

1517 {
O±_gΩjquŸa
, "grpjquota=%s"},

1518 {
O±_jqfmt_vfsﬁd
, "jqfmt=vfsold"},

1519 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

1520 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

1521 {
O±_gΩquŸa
, "grpquota"},

1522 {
O±_noquŸa
, "noquota"},

1523 {
O±_quŸa
, "quota"},

1524 {
O±_u§quŸa
, "usrquota"},

1525 {
O±_¥jquŸa
, "prjquota"},

1526 {
O±_b¨rõr
, "barrier=%u"},

1527 {
O±_b¨rõr
, "barrier"},

1528 {
O±_nob¨rõr
, "nobarrier"},

1529 {
O±_i_vîsi⁄
, "i_version"},

1530 {
O±_dax
, "dax"},

1531 {
O±_°rùe
, "stripe=%u"},

1532 {
O±_dñÆloc
, "delalloc"},

1533 {
O±_w¨n_⁄_îr‹
, "warn_on_error"},

1534 {
O±_now¨n_⁄_îr‹
, "nowarn_on_error"},

1535 {
O±_œzytime
, "lazytime"},

1536 {
O±_nﬁazytime
, "nolazytime"},

1537 {
O±_debug_w™t_exåa_isize
, "debug_want_extra_isize=%u"},

1538 {
O±_nodñÆloc
, "nodelalloc"},

1539 {
O±_ªmoved
, "mblk_io_submit"},

1540 {
O±_ªmoved
, "nomblk_io_submit"},

1541 {
O±_block_vÆidôy
, "block_validity"},

1542 {
O±_noblock_vÆidôy
, "noblock_validity"},

1543 {
O±_öode_ªadahód_blks
, "inode_readahead_blks=%u"},

1544 {
O±_jou∫Æ_i›rio
, "journal_ioprio=%u"},

1545 {
O±_auto_da_Æloc
, "auto_da_alloc=%u"},

1546 {
O±_auto_da_Æloc
, "auto_da_alloc"},

1547 {
O±_nﬂuto_da_Æloc
, "noauto_da_alloc"},

1548 {
O±_di‹ód_nﬁock
, "dioread_nolock"},

1549 {
O±_di‹ód_lock
, "dioread_lock"},

1550 {
O±_disˇrd
, "discard"},

1551 {
O±_nodisˇrd
, "nodiscard"},

1552 {
O±_öô_ôabÀ
, "init_itable=%u"},

1553 {
O±_öô_ôabÀ
, "init_itable"},

1554 {
O±_noöô_ôabÀ
, "noinit_itable"},

1555 {
O±_max_dú_size_kb
, "max_dir_size_kb=%u"},

1556 {
O±_ã°_dummy_í¸y±i⁄
, "test_dummy_encryption"},

1557 {
O±_nombˇche
, "nombcache"},

1558 {
O±_nombˇche
, "no_mbcache"},

1559 {
O±_ªmoved
, "check=none"},

1560 {
O±_ªmoved
, "nocheck"},

1561 {
O±_ªmoved
, "reservation"},

1562 {
O±_ªmoved
, "noreservation"},

1563 {
O±_ªmoved
, "journal=%u"},

1564 {
O±_îr
, 
NULL
},

1567 
pxt4_fsblk_t
 
	$gë_sb_block
(**
d©a
)

1569 
pxt4_fsblk_t
 
sb_block
;

1570 *
›ti⁄s
 = (*Ë*
d©a
;

1572 i‡(!
›ti⁄s
 || 
	`°∫cmp
(options, "sb=", 3) != 0)

1575 
›ti⁄s
 += 3;

1577 
sb_block
 = 
	`sim∂e_°πoul
(
›ti⁄s
, &options, 0);

1578 i‡(*
›ti⁄s
 && *options != ',') {

1579 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: Invalid sb specification: %s\n",

1580 (*Ë*
d©a
);

1583 i‡(*
›ti⁄s
 == ',')

1584 
›ti⁄s
++;

1585 *
d©a
 = (*Ë
›ti⁄s
;

1587  
sb_block
;

1588 
	}
}

1590 
	#DEFAULT_JOURNAL_IOPRIO
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 3))

	)

1591 c⁄° 
	gdïªˇãd_msg
[] =

1595 #ifde‡
CONFIG_QUOTA


1596 
	$£t_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
, 
sub°rög_t
 *
¨gs
)

1598 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1599 *
q«me
, *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1600 
ªt
 = -1;

1602 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& !
ﬁd_q«me
) {

1603 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1608 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

1609 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Journaled quota options "

1613 
q«me
 = 
	`m©ch_°rdup
(
¨gs
);

1614 i‡(!
q«me
) {

1615 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1619 i‡(
ﬁd_q«me
) {

1620 i‡(
	`°rcmp
(
ﬁd_q«me
, 
q«me
) == 0)

1621 
ªt
 = 1;

1623 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1625 
	`QTYPE2NAME
(
qty≥
));

1626 
îrout
;

1628 i‡(
	`°rchr
(
q«me
, '/')) {

1629 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1631 
îrout
;

1633 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
q«me
);

1634 
	`£t_›t
(
sb
, 
QUOTA
);

1636 
îrout
:

1637 
	`k‰ì
(
q«me
);

1638  
ªt
;

1639 
	}
}

1641 
	$˛ór_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
)

1644 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1645 *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1647 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& 
ﬁd_q«me
) {

1648 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

1652 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
NULL
);

1653 
	`synchr⁄ize_rcu
();

1654 
	`k‰ì
(
ﬁd_q«me
);

1656 
	}
}

1659 
	#MOPT_SET
 0x0001

	)

1660 
	#MOPT_CLEAR
 0x0002

	)

1661 
	#MOPT_NOSUPPORT
 0x0004

	)

1662 
	#MOPT_EXPLICIT
 0x0008

	)

1663 
	#MOPT_CLEAR_ERR
 0x0010

	)

1664 
	#MOPT_GTE0
 0x0020

	)

1665 #ifde‡
CONFIG_QUOTA


1666 
	#MOPT_Q
 0

	)

1667 
	#MOPT_QFMT
 0x0040

	)

1669 
	#MOPT_Q
 
MOPT_NOSUPPORT


	)

1670 
	#MOPT_QFMT
 
MOPT_NOSUPPORT


	)

1672 
	#MOPT_DATAJ
 0x0080

	)

1673 
	#MOPT_NO_PXT2
 0x0100

	)

1674 
	#MOPT_NO_EXT3
 0x0200

	)

1675 
	#MOPT_PXT4_ONLY
 (
MOPT_NO_PXT2
 | 
MOPT_NO_EXT3
)

	)

1676 
	#MOPT_STRING
 0x0400

	)

1678 c⁄° 
	smou¡_›ts
 {

1679 
	mtokí
;

1680 
	mmou¡_›t
;

1681 
	mÊags
;

1682 } 
	gpxt4_mou¡_›ts
[] = {

1683 {
O±_möix_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_SET
},

1684 {
O±_bsd_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_CLEAR
},

1685 {
O±_gΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_SET
},

1686 {
O±_nogΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_CLEAR
},

1687 {
O±_block_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_SET
},

1688 {
O±_noblock_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_CLEAR
},

1689 {
O±_di‹ód_nﬁock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1690 
MOPT_PXT4_ONLY
 | 
MOPT_SET
},

1691 {
O±_di‹ód_lock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1692 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1693 {
O±_disˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_SET
},

1694 {
O±_nodisˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_CLEAR
},

1695 {
O±_dñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1696 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1697 {
O±_nodñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1698 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1699 {
O±_w¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_SET
},

1700 {
O±_now¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_CLEAR
},

1701 {
O±_nojou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1702 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1703 {
O±_jou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1704 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1705 {
O±_jou∫Æ_async_commô
, (
PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 |

1706 
PXT4_MOUNT_JOURNAL_CHECKSUM
),

1707 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1708 {
O±_nﬁﬂd
, 
PXT4_MOUNT_NOLOAD
, 
MOPT_NO_PXT2
 | 
MOPT_SET
},

1709 {
O±_îr_∑nic
, 
PXT4_MOUNT_ERRORS_PANIC
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1710 {
O±_îr_ro
, 
PXT4_MOUNT_ERRORS_RO
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1711 {
O±_îr_c⁄t
, 
PXT4_MOUNT_ERRORS_CONT
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1712 {
O±_d©a_îr_ab‹t
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1713 
MOPT_NO_PXT2
},

1714 {
O±_d©a_îr_ign‹e
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1715 
MOPT_NO_PXT2
},

1716 {
O±_b¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_SET
},

1717 {
O±_nob¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_CLEAR
},

1718 {
O±_nﬂuto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_SET
},

1719 {
O±_auto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_CLEAR
},

1720 {
O±_noöô_ôabÀ
, 
PXT4_MOUNT_INIT_INODE_TABLE
, 
MOPT_CLEAR
},

1721 {
O±_commô
, 0, 
MOPT_GTE0
},

1722 {
O±_max_b©ch_time
, 0, 
MOPT_GTE0
},

1723 {
O±_mö_b©ch_time
, 0, 
MOPT_GTE0
},

1724 {
O±_öode_ªadahód_blks
, 0, 
MOPT_GTE0
},

1725 {
O±_öô_ôabÀ
, 0, 
MOPT_GTE0
},

1726 {
O±_dax
, 
PXT4_MOUNT_DAX
, 
MOPT_SET
},

1727 {
O±_°rùe
, 0, 
MOPT_GTE0
},

1728 {
O±_ªsuid
, 0, 
MOPT_GTE0
},

1729 {
O±_ªsgid
, 0, 
MOPT_GTE0
},

1730 {
O±_jou∫Æ_dev
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1731 {
O±_jou∫Æ_∑th
, 0, 
MOPT_NO_PXT2
 | 
MOPT_STRING
},

1732 {
O±_jou∫Æ_i›rio
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1733 {
O±_d©a_jou∫Æ
, 
PXT4_MOUNT_JOURNAL_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1734 {
O±_d©a_‹dîed
, 
PXT4_MOUNT_ORDERED_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1735 {
O±_d©a_wrôeback
, 
PXT4_MOUNT_WRITEBACK_DATA
,

1736 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1737 {
O±_u£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_SET
},

1738 {
O±_nou£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_CLEAR
},

1739 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


1740 {
O±_a˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_SET
},

1741 {
O±_nﬂ˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_CLEAR
},

1743 {
O±_a˛
, 0, 
MOPT_NOSUPPORT
},

1744 {
O±_nﬂ˛
, 0, 
MOPT_NOSUPPORT
},

1746 {
O±_nouid32
, 
PXT4_MOUNT_NO_UID32
, 
MOPT_SET
},

1747 {
O±_debug
, 
PXT4_MOUNT_DEBUG
, 
MOPT_SET
},

1748 {
O±_debug_w™t_exåa_isize
, 0, 
MOPT_GTE0
},

1749 {
O±_quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
, 
MOPT_SET
 | 
MOPT_Q
},

1750 {
O±_u§quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
,

1751 
MOPT_SET
 | 
MOPT_Q
},

1752 {
O±_gΩquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_GRPQUOTA
,

1753 
MOPT_SET
 | 
MOPT_Q
},

1754 {
O±_¥jquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_PRJQUOTA
,

1755 
MOPT_SET
 | 
MOPT_Q
},

1756 {
O±_noquŸa
, (
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
 |

1757 
PXT4_MOUNT_GRPQUOTA
 | 
PXT4_MOUNT_PRJQUOTA
),

1758 
MOPT_CLEAR
 | 
MOPT_Q
},

1759 {
O±_u§jquŸa
, 0, 
MOPT_Q
},

1760 {
O±_gΩjquŸa
, 0, 
MOPT_Q
},

1761 {
O±_offu§jquŸa
, 0, 
MOPT_Q
},

1762 {
O±_offgΩjquŸa
, 0, 
MOPT_Q
},

1763 {
O±_jqfmt_vfsﬁd
, 
QFMT_VFS_OLD
, 
MOPT_QFMT
},

1764 {
O±_jqfmt_vfsv0
, 
QFMT_VFS_V0
, 
MOPT_QFMT
},

1765 {
O±_jqfmt_vfsv1
, 
QFMT_VFS_V1
, 
MOPT_QFMT
},

1766 {
O±_max_dú_size_kb
, 0, 
MOPT_GTE0
},

1767 {
O±_ã°_dummy_í¸y±i⁄
, 0, 
MOPT_GTE0
},

1768 {
O±_nombˇche
, 
PXT4_MOUNT_NO_MBCACHE
, 
MOPT_SET
},

1769 {
O±_îr
, 0, 0}

1772 #ifde‡
CONFIG_UNICODE


1773 c⁄° 
	spxt4_sb_ícodögs
 {

1774 
__u16
 
	mmagic
;

1775 *
	m«me
;

1776 *
	mvîsi⁄
;

1777 } 
	gpxt4_sb_ícodög_m≠
[] = {

1778 {
PXT4_ENC_UTF8_12_1
, "utf8", "12.1.0"},

1781 
	$pxt4_sb_ªad_ícodög
(c⁄° 
pxt4_su≥r_block
 *
es
,

1782 c⁄° 
pxt4_sb_ícodögs
 **
ícodög
,

1783 
__u16
 *
Êags
)

1785 
__u16
 
magic
 = 
	`À16_to_˝u
(
es
->
s_ícodög
);

1786 
i
;

1788 
i
 = 0; i < 
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
); i++)

1789 i‡(
magic
 =
pxt4_sb_ícodög_m≠
[
i
].magic)

1792 i‡(
i
 >
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
))

1793  -
EINVAL
;

1795 *
ícodög
 = &
pxt4_sb_ícodög_m≠
[
i
];

1796 *
Êags
 = 
	`À16_to_˝u
(
es
->
s_ícodög_Êags
);

1799 
	}
}

1802 
	$h™dÀ_mou¡_›t
(
su≥r_block
 *
sb
, *
›t
, 
tokí
,

1803 
sub°rög_t
 *
¨gs
, *
jou∫Æ_devnum
,

1804 *
jou∫Æ_i›rio
, 
is_ªmou¡
)

1806 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1807 c⁄° 
mou¡_›ts
 *
m
;

1808 
kuid_t
 
uid
;

1809 
kgid_t
 
gid
;

1810 
¨g
 = 0;

1812 #ifde‡
CONFIG_QUOTA


1813 i‡(
tokí
 =
O±_u§jquŸa
)

1814  
	`£t_qf_«me
(
sb
, 
USRQUOTA
, &
¨gs
[0]);

1815 i‡(
tokí
 =
O±_gΩjquŸa
)

1816  
	`£t_qf_«me
(
sb
, 
GRPQUOTA
, &
¨gs
[0]);

1817 i‡(
tokí
 =
O±_offu§jquŸa
)

1818  
	`˛ór_qf_«me
(
sb
, 
USRQUOTA
);

1819 i‡(
tokí
 =
O±_offgΩjquŸa
)

1820  
	`˛ór_qf_«me
(
sb
, 
GRPQUOTA
);

1822 
tokí
) {

1823 
O±_nﬂ˛
:

1824 
O±_nou£r_x©å
:

1825 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, 
dïªˇãd_msg
, 
›t
, "3.5");

1827 
O±_sb
:

1829 
O±_ªmoved
:

1830 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Ign‹ögÑemoved %†›ti⁄", 
›t
);

1832 
O±_ab‹t
:

1833 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

1835 
O±_i_vîsi⁄
:

1836 
sb
->
s_Êags
 |
SB_I_VERSION
;

1838 
O±_œzytime
:

1839 
sb
->
s_Êags
 |
SB_LAZYTIME
;

1841 
O±_nﬁazytime
:

1842 
sb
->
s_Êags
 &~
SB_LAZYTIME
;

1846 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++)

1847 i‡(
tokí
 =
m
->token)

1850 i‡(
m
->
tokí
 =
O±_îr
) {

1851 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unrecognized mount option \"%s\" "

1852 "‹ missög vÆue", 
›t
);

1856 i‡((
m
->
Êags
 & 
MOPT_NO_PXT2
Ë&& 
	`IS_PXT2_SB
(
sb
)) {

1857 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1858 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÖxt2", 
›t
);

1861 i‡((
m
->
Êags
 & 
MOPT_NO_EXT3
Ë&& 
	`IS_EXT3_SB
(
sb
)) {

1862 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1863 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÉxt3", 
›t
);

1867 i‡(
¨gs
->
‰om
 && !(
m
->
Êags
 & 
MOPT_STRING
Ë&& 
	`m©ch_öt
◊rgs, &
¨g
))

1869 i‡(
¨gs
->
‰om
 && (
m
->
Êags
 & 
MOPT_GTE0
Ë&& (
¨g
 < 0))

1871 i‡(
m
->
Êags
 & 
MOPT_EXPLICIT
) {

1872 i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_DELALLOC
) {

1873 
	`£t_›t2
(
sb
, 
EXPLICIT_DELALLOC
);

1874 } i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) {

1875 
	`£t_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
);

1879 i‡(
m
->
Êags
 & 
MOPT_CLEAR_ERR
)

1880 
	`˛ór_›t
(
sb
, 
ERRORS_MASK
);

1881 i‡(
tokí
 =
O±_noquŸa
 && 
	`sb_™y_quŸa_lﬂded
(
sb
)) {

1882 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change quota "

1887 i‡(
m
->
Êags
 & 
MOPT_NOSUPPORT
) {

1888 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%†›ti⁄ÇŸ suµ‹ãd", 
›t
);

1889 } i‡(
tokí
 =
O±_commô
) {

1890 i‡(
¨g
 == 0)

1891 
¨g
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
;

1892 i‡(
¨g
 > 
INT_MAX
 / 
HZ
) {

1893 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1896 
¨g
, 
INT_MAX
 / 
HZ
);

1899 
sbi
->
s_commô_öãrvÆ
 = 
HZ
 * 
¨g
;

1900 } i‡(
tokí
 =
O±_debug_w™t_exåa_isize
) {

1901 i‡((
¨g
 & 1) ||

1902 (
¨g
 < 4) ||

1903 (
¨g
 > (
sbi
->
s_öode_size
 - 
PXT4_GOOD_OLD_INODE_SIZE
))) {

1904 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1905 "InvÆid w™t_exåa_isizê%d", 
¨g
);

1908 
sbi
->
s_w™t_exåa_isize
 = 
¨g
;

1909 } i‡(
tokí
 =
O±_max_b©ch_time
) {

1910 
sbi
->
s_max_b©ch_time
 = 
¨g
;

1911 } i‡(
tokí
 =
O±_mö_b©ch_time
) {

1912 
sbi
->
s_mö_b©ch_time
 = 
¨g
;

1913 } i‡(
tokí
 =
O±_öode_ªadahód_blks
) {

1914 i‡(
¨g
 && (¨g > (1 << 30Ë|| !
	`is_powî_of_2
(arg))) {

1915 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1920 
sbi
->
s_öode_ªadahód_blks
 = 
¨g
;

1921 } i‡(
tokí
 =
O±_öô_ôabÀ
) {

1922 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

1923 i‡(!
¨gs
->
‰om
)

1924 
¨g
 = 
PXT4_DEF_LI_WAIT_MULT
;

1925 
sbi
->
s_li_waô_mu…
 = 
¨g
;

1926 } i‡(
tokí
 =
O±_max_dú_size_kb
) {

1927 
sbi
->
s_max_dú_size_kb
 = 
¨g
;

1928 } i‡(
tokí
 =
O±_°rùe
) {

1929 
sbi
->
s_°rùe
 = 
¨g
;

1930 } i‡(
tokí
 =
O±_ªsuid
) {

1931 
uid
 = 
	`make_kuid
(
	`cuºít_u£r_ns
(), 
¨g
);

1932 i‡(!
	`uid_vÆid
(
uid
)) {

1933 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid uid vÆuê%d", 
¨g
);

1936 
sbi
->
s_ªsuid
 = 
uid
;

1937 } i‡(
tokí
 =
O±_ªsgid
) {

1938 
gid
 = 
	`make_kgid
(
	`cuºít_u£r_ns
(), 
¨g
);

1939 i‡(!
	`gid_vÆid
(
gid
)) {

1940 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid gid vÆuê%d", 
¨g
);

1943 
sbi
->
s_ªsgid
 = 
gid
;

1944 } i‡(
tokí
 =
O±_jou∫Æ_dev
) {

1945 i‡(
is_ªmou¡
) {

1946 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1950 *
jou∫Æ_devnum
 = 
¨g
;

1951 } i‡(
tokí
 =
O±_jou∫Æ_∑th
) {

1952 *
jou∫Æ_∑th
;

1953 
öode
 *
jou∫Æ_öode
;

1954 
∑th
Öath;

1955 
îr‹
;

1957 i‡(
is_ªmou¡
) {

1958 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1962 
jou∫Æ_∑th
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

1963 i‡(!
jou∫Æ_∑th
) {

1964 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot dup "

1969 
îr‹
 = 
	`kîn_∑th
(
jou∫Æ_∑th
, 
LOOKUP_FOLLOW
, &
∑th
);

1970 i‡(
îr‹
) {

1971 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot find "

1972 "jou∫Æ devi˚Ö©h:Éº‹ %d", 
îr‹
);

1973 
	`k‰ì
(
jou∫Æ_∑th
);

1977 
jou∫Æ_öode
 = 
	`d_öode
(
∑th
.
díåy
);

1978 i‡(!
	`S_ISBLK
(
jou∫Æ_öode
->
i_mode
)) {

1979 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: journalÖath %s "

1980 "i†nŸá block devi˚", 
jou∫Æ_∑th
);

1981 
	`∑th_put
(&
∑th
);

1982 
	`k‰ì
(
jou∫Æ_∑th
);

1986 *
jou∫Æ_devnum
 = 
	`√w_ícode_dev
(
jou∫Æ_öode
->
i_rdev
);

1987 
	`∑th_put
(&
∑th
);

1988 
	`k‰ì
(
jou∫Æ_∑th
);

1989 } i‡(
tokí
 =
O±_jou∫Æ_i›rio
) {

1990 i‡(
¨g
 > 7) {

1991 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Invalid journal IOÖriority"

1995 *
jou∫Æ_i›rio
 =

1996 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
¨g
);

1997 } i‡(
tokí
 =
O±_ã°_dummy_í¸y±i⁄
) {

1998 #ifde‡
CONFIG_FS_ENCRYPTION


1999 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_TEST_DUMMY_ENCRYPTION
;

2000 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2003 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2006 } i‡(
m
->
Êags
 & 
MOPT_DATAJ
) {

2007 i‡(
is_ªmou¡
) {

2008 i‡(!
sbi
->
s_jou∫Æ
)

2009 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Remounting file system withÇo journal so ignoring journalled data option");

2010 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë!
m
->
mou¡_›t
) {

2011 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2016 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

2017 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2019 #ifde‡
CONFIG_QUOTA


2020 } i‡(
m
->
Êags
 & 
MOPT_QFMT
) {

2021 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
) &&

2022 
sbi
->
s_jquŸa_fmt
 !
m
->
mou¡_›t
) {

2023 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled "

2027 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

2028 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2033 
sbi
->
s_jquŸa_fmt
 = 
m
->
mou¡_›t
;

2035 } i‡(
tokí
 =
O±_dax
) {

2036 #ifde‡
CONFIG_FS_DAX


2037 i‡(
is_ªmou¡
 && 
	`ã°_›t
(
sb
, 
DAX
)) {

2038 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

2042 i‡(
is_ªmou¡
 && !(
sbi
->
s_mou¡_›t
 & 
PXT4_MOUNT_DAX
)) {

2043 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't change "

2047 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2049 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2051 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "dax optionÇot supported");

2054 } i‡(
tokí
 =
O±_d©a_îr_ab‹t
) {

2055 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2056 } i‡(
tokí
 =
O±_d©a_îr_ign‹e
) {

2057 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2059 i‡(!
¨gs
->
‰om
)

2060 
¨g
 = 1;

2061 i‡(
m
->
Êags
 & 
MOPT_CLEAR
)

2062 
¨g
 = !arg;

2063 i‡(
	`u∆ikñy
(!(
m
->
Êags
 & 
MOPT_SET
))) {

2064 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2065 "buggy h™dlög o‡›ti⁄ %s", 
›t
);

2066 
	`WARN_ON
(1);

2069 i‡(
¨g
 != 0)

2070 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2072 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2075 
	}
}

2077 
	$∑r£_›ti⁄s
(*
›ti⁄s
, 
su≥r_block
 *
sb
,

2078 *
jou∫Æ_devnum
,

2079 *
jou∫Æ_i›rio
,

2080 
is_ªmou¡
)

2082 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2083 *
p
, 
__maybe_unu£d
 *
u§_qf_«me
, __maybe_unu£d *
gΩ_qf_«me
;

2084 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

2085 
tokí
;

2087 i‡(!
›ti⁄s
)

2090 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

2091 i‡(!*
p
)

2097 
¨gs
[0].
to
 =árgs[0].
‰om
 = 
NULL
;

2098 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

2099 i‡(
	`h™dÀ_mou¡_›t
(
sb
, 
p
, 
tokí
, 
¨gs
, 
jou∫Æ_devnum
,

2100 
jou∫Æ_i›rio
, 
is_ªmou¡
) < 0)

2103 #ifde‡
CONFIG_QUOTA


2109 i‡(
	`ã°_›t
(
sb
, 
PRJQUOTA
Ë&& !
	`pxt4_has_„©uª_¥oje˘
(sb)) {

2110 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Project quota featureÇotÉnabled. "

2114 
u§_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
USRQUOTA
);

2115 
gΩ_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
GRPQUOTA
);

2116 i‡(
u§_qf_«me
 || 
gΩ_qf_«me
) {

2117 i‡(
	`ã°_›t
(
sb
, 
USRQUOTA
Ë&& 
u§_qf_«me
)

2118 
	`˛ór_›t
(
sb
, 
USRQUOTA
);

2120 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë&& 
gΩ_qf_«me
)

2121 
	`˛ór_›t
(
sb
, 
GRPQUOTA
);

2123 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë||Åe°_›t(sb, 
USRQUOTA
)) {

2124 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "oldándÇew quota "

2129 i‡(!
sbi
->
s_jquŸa_fmt
) {

2130 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journaled quota format "

2136 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

2137 
blocksize
 =

2138 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
sbi
->
s_es
->
s_log_block_size
);

2140 i‡(
blocksize
 < 
PAGE_SIZE
) {

2141 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

2147 
	}
}

2149 
ölöe
 
	$pxt4_show_quŸa_›ti⁄s
(
£q_fûe
 *
£q
,

2150 
su≥r_block
 *
sb
)

2152 #i‡
	`deföed
(
CONFIG_QUOTA
)

2153 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2154 *
u§_qf_«me
, *
gΩ_qf_«me
;

2156 i‡(
sbi
->
s_jquŸa_fmt
) {

2157 *
fmäame
 = "";

2159 
sbi
->
s_jquŸa_fmt
) {

2160 
QFMT_VFS_OLD
:

2161 
fmäame
 = "vfsold";

2163 
QFMT_VFS_V0
:

2164 
fmäame
 = "vfsv0";

2166 
QFMT_VFS_V1
:

2167 
fmäame
 = "vfsv1";

2170 
	`£q_¥ötf
(
£q
, ",jqfmt=%s", 
fmäame
);

2173 
	`rcu_ªad_lock
();

2174 
u§_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
USRQUOTA
]);

2175 
gΩ_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
GRPQUOTA
]);

2176 i‡(
u§_qf_«me
)

2177 
	`£q_show_›ti⁄
(
£q
, "u§jquŸa", 
u§_qf_«me
);

2178 i‡(
gΩ_qf_«me
)

2179 
	`£q_show_›ti⁄
(
£q
, "gΩjquŸa", 
gΩ_qf_«me
);

2180 
	`rcu_ªad_u∆ock
();

2182 
	}
}

2184 c⁄° *
	$tokí2°r
(
tokí
)

2186 c⁄° 
m©ch_tokí
 *
t
;

2188 
t
 = 
tokís
;Å->
tokí
 !
O±_îr
;Å++)

2189 i‡(
t
->
tokí
 =tokí && !
	`°rchr
—->
∑âîn
, '='))

2191  
t
->
∑âîn
;

2192 
	}
}

2199 
	$_pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
su≥r_block
 *
sb
,

2200 
nodefs
)

2202 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2203 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

2204 
def_îr‹s
, 
def_mou¡_›t
 = 
sbi
->
s_def_mou¡_›t
;

2205 c⁄° 
mou¡_›ts
 *
m
;

2206 
£p
 = 
nodefs
 ? '\n' : ',';

2208 
	#SEQ_OPTS_PUTS
(
°r
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
)

	)

2209 
	#SEQ_OPTS_PRINT
(
°r
, 
¨g
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
,árg)

	)

2211 i‡(
sbi
->
s_sb_block
 != 1)

2212 
	`SEQ_OPTS_PRINT
("sb=%Œu", 
sbi
->
s_sb_block
);

2214 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++) {

2215 
w™t_£t
 = 
m
->
Êags
 & 
MOPT_SET
;

2216 i‡(((
m
->
Êags
 & (
MOPT_SET
|
MOPT_CLEAR
)) == 0) ||

2217 (
m
->
Êags
 & 
MOPT_CLEAR_ERR
))

2219 i‡(!
nodefs
 && !(
m
->
mou¡_›t
 & (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)))

2221 i‡((
w™t_£t
 &&

2222 (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
) != m->mount_opt) ||

2223 (!
w™t_£t
 && (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
)))

2225 
	`SEQ_OPTS_PRINT
("%s", 
	`tokí2°r
(
m
->
tokí
));

2228 i‡(
nodefs
 || !
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`make_kuid
(&
öô_u£r_ns
, 
PXT4_DEF_RESUID
)) ||

2229 
	`À16_to_˝u
(
es
->
s_def_ªsuid
Ë!
PXT4_DEF_RESUID
)

2230 
	`SEQ_OPTS_PRINT
("resuid=%u",

2231 
	`‰om_kuid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsuid
));

2232 i‡(
nodefs
 || !
	`gid_eq
(
sbi
->
s_ªsgid
, 
	`make_kgid
(&
öô_u£r_ns
, 
PXT4_DEF_RESGID
)) ||

2233 
	`À16_to_˝u
(
es
->
s_def_ªsgid
Ë!
PXT4_DEF_RESGID
)

2234 
	`SEQ_OPTS_PRINT
("resgid=%u",

2235 
	`‰om_kgid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsgid
));

2236 
def_îr‹s
 = 
nodefs
 ? -1 : 
	`À16_to_˝u
(
es
->
s_îr‹s
);

2237 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_RO
)

2238 
	`SEQ_OPTS_PUTS
("errors=remount-ro");

2239 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_CONTINUE
)

2240 
	`SEQ_OPTS_PUTS
("errors=continue");

2241 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_PANIC
)

2242 
	`SEQ_OPTS_PUTS
("errors=panic");

2243 i‡(
nodefs
 || 
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
)

2244 
	`SEQ_OPTS_PRINT
("commô=%lu", 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

2245 i‡(
nodefs
 || 
sbi
->
s_mö_b©ch_time
 !
PXT4_DEF_MIN_BATCH_TIME
)

2246 
	`SEQ_OPTS_PRINT
("mö_b©ch_time=%u", 
sbi
->
s_mö_b©ch_time
);

2247 i‡(
nodefs
 || 
sbi
->
s_max_b©ch_time
 !
PXT4_DEF_MAX_BATCH_TIME
)

2248 
	`SEQ_OPTS_PRINT
("max_b©ch_time=%u", 
sbi
->
s_max_b©ch_time
);

2249 i‡(
sb
->
s_Êags
 & 
SB_I_VERSION
)

2250 
	`SEQ_OPTS_PUTS
("i_version");

2251 i‡(
nodefs
 || 
sbi
->
s_°rùe
)

2252 
	`SEQ_OPTS_PRINT
("°rùe=%lu", 
sbi
->
s_°rùe
);

2253 i‡(
nodefs
 || 
PXT4_MOUNT_DATA_FLAGS
 &

2254 (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)) {

2255 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

2256 
	`SEQ_OPTS_PUTS
("data=journal");

2257 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

2258 
	`SEQ_OPTS_PUTS
("data=ordered");

2259 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

2260 
	`SEQ_OPTS_PUTS
("data=writeback");

2262 i‡(
nodefs
 ||

2263 
sbi
->
s_öode_ªadahód_blks
 !
PXT4_DEF_INODE_READAHEAD_BLKS
)

2264 
	`SEQ_OPTS_PRINT
("inode_readahead_blks=%u",

2265 
sbi
->
s_öode_ªadahód_blks
);

2267 i‡(
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
Ë&& (
nodefs
 ||

2268 (
sbi
->
s_li_waô_mu…
 !
PXT4_DEF_LI_WAIT_MULT
)))

2269 
	`SEQ_OPTS_PRINT
("öô_ôabÀ=%u", 
sbi
->
s_li_waô_mu…
);

2270 i‡(
nodefs
 || 
sbi
->
s_max_dú_size_kb
)

2271 
	`SEQ_OPTS_PRINT
("max_dú_size_kb=%u", 
sbi
->
s_max_dú_size_kb
);

2272 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

2273 
	`SEQ_OPTS_PUTS
("data_err=abort");

2274 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
))

2275 
	`SEQ_OPTS_PUTS
("test_dummy_encryption");

2277 
	`pxt4_show_quŸa_›ti⁄s
(
£q
, 
sb
);

2279 
	}
}

2281 
	$pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
)

2283  
	`_pxt4_show_›ti⁄s
(
£q
, 
roŸ
->
d_sb
, 0);

2284 
	}
}

2286 
	$pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
)

2288 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

2289 
rc
;

2291 
	`£q_puts
(
£q
, 
	`sb_rd⁄ly
(
sb
) ? "ro" : "rw");

2292 
rc
 = 
	`_pxt4_show_›ti⁄s
(
£q
, 
sb
, 1);

2293 
	`£q_puts
(
£q
, "\n");

2294  
rc
;

2295 
	}
}

2297 
	$pxt4_£tup_su≥r
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

2298 
ªad_⁄ly
)

2300 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2301 
îr
 = 0;

2303 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_MAX_SUPP_REV
) {

2304 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "revisionÜevelÅoo high, "

2306 
îr
 = -
EROFS
;

2307 
d⁄e
;

2309 i‡(
ªad_⁄ly
)

2310 
d⁄e
;

2311 i‡(!(
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

2312 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning: mounting unchecked fs, "

2314 i‡(
sbi
->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
)

2315 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2318 i‡((
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
) > 0 &&

2319 
	`À16_to_˝u
(
es
->
s_m¡_cou¡
) >=

2320 (Ë(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2321 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2324 i‡(
	`À32_to_˝u
(
es
->
s_checköãrvÆ
) &&

2325 (
	`pxt4_gë_t°amp
(
es
, 
s_œ°check
) +

2326 
	`À32_to_˝u
(
es
->
s_checköãrvÆ
Ë<
	`ktime_gë_ªÆ_£c⁄ds
()))

2327 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2330 i‡(!
sbi
->
s_jou∫Æ
)

2331 
es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

2332 i‡(!(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2333 
es
->
s_max_m¡_cou¡
 = 
	`˝u_to_À16
(
PXT4_DFL_MAX_MNT_COUNT
);

2334 
	`À16_add_˝u
(&
es
->
s_m¡_cou¡
, 1);

2335 
	`pxt4_upd©e_t°amp
(
es
, 
s_mtime
);

2336 i‡(
sbi
->
s_jou∫Æ
)

2337 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

2339 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

2340 
d⁄e
:

2341 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2342 
	`¥ötk
(
KERN_INFO
 "[PXT4 FS bs=%lu, gc=%u, "

2344 
sb
->
s_blocksize
,

2345 
sbi
->
s_groups_cou¡
,

2346 
	`PXT4_BLOCKS_PER_GROUP
(
sb
),

2347 
	`PXT4_INODES_PER_GROUP
(
sb
),

2348 
sbi
->
s_mou¡_›t
, sbi->
s_mou¡_›t2
);

2350 
	`˛ónˇche_öô_fs
(
sb
);

2351  
îr
;

2352 
	}
}

2354 
	$pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroup
)

2356 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2357 
Êex_groups
 **
ﬁd_groups
, **
√w_groups
;

2358 
size
, 
i
, 
j
;

2360 i‡(!
sbi
->
s_log_groups_≥r_Êex
)

2363 
size
 = 
	`pxt4_Êex_group
(
sbi
, 
ngroup
 - 1) + 1;

2364 i‡(
size
 <
sbi
->
s_Êex_groups_Æloˇãd
)

2367 
√w_groups
 = 
	`kvzÆloc
(
	`roundup_pow_of_two
(
size
 *

2368 (*
sbi
->
s_Êex_groups
)), 
GFP_KERNEL
);

2369 i‡(!
√w_groups
) {

2370 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2371 "nŸÉnough mem‹y f‹ %d fÀx grou∞poöãrs", 
size
);

2372  -
ENOMEM
;

2374 
i
 = 
sbi
->
s_Êex_groups_Æloˇãd
; i < 
size
; i++) {

2375 
√w_groups
[
i
] = 
	`kvzÆloc
(
	`roundup_pow_of_two
(

2376 (
Êex_groups
)),

2377 
GFP_KERNEL
);

2378 i‡(!
√w_groups
[
i
]) {

2379 
j
 = 
sbi
->
s_Êex_groups_Æloˇãd
; j < 
i
; j++)

2380 
	`kv‰ì
(
√w_groups
[
j
]);

2381 
	`kv‰ì
(
√w_groups
);

2382 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2383 "nŸÉnough mem‹y f‹ %d fÀx groups", 
size
);

2384  -
ENOMEM
;

2387 
	`rcu_ªad_lock
();

2388 
ﬁd_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

2389 i‡(
ﬁd_groups
)

2390 
	`mem˝y
(
√w_groups
, 
ﬁd_groups
,

2391 (
sbi
->
s_Êex_groups_Æloˇãd
 *

2392 (
Êex_groups
 *)));

2393 
	`rcu_ªad_u∆ock
();

2394 
	`rcu_assign_poöãr
(
sbi
->
s_Êex_groups
, 
√w_groups
);

2395 
sbi
->
s_Êex_groups_Æloˇãd
 = 
size
;

2396 i‡(
ﬁd_groups
)

2397 
	`pxt4_kv‰ì_¨øy_rcu
(
ﬁd_groups
);

2399 
	}
}

2401 
	$pxt4_fûl_Êex_öfo
(
su≥r_block
 *
sb
)

2403 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2404 
pxt4_group_desc
 *
gdp
 = 
NULL
;

2405 
Êex_groups
 *
fg
;

2406 
pxt4_group_t
 
Êex_group
;

2407 
i
, 
îr
;

2409 
sbi
->
s_log_groups_≥r_Êex
 = sbi->
s_es
->s_log_groups_per_flex;

2410 i‡(
sbi
->
s_log_groups_≥r_Êex
 < 1 || sbi->s_log_groups_per_flex > 31) {

2411 
sbi
->
s_log_groups_≥r_Êex
 = 0;

2415 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
sbi
->
s_groups_cou¡
);

2416 i‡(
îr
)

2417 
Áûed
;

2419 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2420 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2422 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
i
);

2423 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
, 
Êex_group
);

2424 
	`©omic_add
(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), &
fg
->
‰ì_öodes
);

2425 
	`©omic64_add
(
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
),

2426 &
fg
->
‰ì_˛u°îs
);

2427 
	`©omic_add
(
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
), &
fg
->
u£d_dús
);

2431 
Áûed
:

2433 
	}
}

2435 
__À16
 
	$pxt4_group_desc_csum
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2436 
pxt4_group_desc
 *
gdp
)

2438 
off£t
 = 
	`off£tof
(
pxt4_group_desc
, 
bg_checksum
);

2439 
__u16
 
¸c
 = 0;

2440 
__À32
 
À_group
 = 
	`˝u_to_À32
(
block_group
);

2441 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2443 i‡(
	`pxt4_has_mëad©a_csum
(
sbi
->
s_sb
)) {

2445 
__u32
 
csum32
;

2446 
__u16
 
dummy_csum
 = 0;

2448 
csum32
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
À_group
,

2449 (
À_group
));

2450 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
, 
off£t
);

2451 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)&
dummy_csum
,

2452 (
dummy_csum
));

2453 
off£t
 +(
dummy_csum
);

2454 i‡(
off£t
 < 
sbi
->
s_desc_size
)

2455 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
 + 
off£t
,

2456 
sbi
->
s_desc_size
 - 
off£t
);

2458 
¸c
 = 
csum32
 & 0xFFFF;

2459 
out
;

2463 i‡(!
	`pxt4_has_„©uª_gdt_csum
(
sb
))

2466 
¸c
 = 
	`¸c16
(~0, 
sbi
->
s_es
->
s_uuid
, (sbi->s_es->s_uuid));

2467 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)&
À_group
, (le_group));

2468 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
, 
off£t
);

2469 
off£t
 +(
gdp
->
bg_checksum
);

2471 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

2472 
off£t
 < 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
))

2473 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
 + 
off£t
,

2474 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
) -

2475 
off£t
);

2477 
out
:

2478  
	`˝u_to_À16
(
¸c
);

2479 
	}
}

2481 
	$pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2482 
pxt4_group_desc
 *
gdp
)

2484 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2485 (
gdp
->
bg_checksum
 !
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp)))

2489 
	}
}

2491 
	$pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2492 
pxt4_group_desc
 *
gdp
)

2494 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

2496 
gdp
->
bg_checksum
 = 
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp);

2497 
	}
}

2500 
	$pxt4_check_des¸ùt‹s
(
su≥r_block
 *
sb
,

2501 
pxt4_fsblk_t
 
sb_block
,

2502 
pxt4_group_t
 *
fú°_nŸ_zî€d
)

2504 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2505 
pxt4_fsblk_t
 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

2506 
pxt4_fsblk_t
 
œ°_block
;

2507 
pxt4_fsblk_t
 
œ°_bg_block
 = 
sb_block
 + 
	`pxt4_bg_num_gdb
(
sb
, 0);

2508 
pxt4_fsblk_t
 
block_bôm≠
;

2509 
pxt4_fsblk_t
 
öode_bôm≠
;

2510 
pxt4_fsblk_t
 
öode_èbÀ
;

2511 
Êexbg_Êag
 = 0;

2512 
pxt4_group_t
 
i
, 
gΩ
 = 
sbi
->
s_groups_cou¡
;

2514 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

2515 
Êexbg_Êag
 = 1;

2517 
	`pxt4_debug
("Checking group descriptors");

2519 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2520 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2522 i‡(
i
 =
sbi
->
s_groups_cou¡
 - 1 || 
Êexbg_Êag
)

2523 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) - 1;

2525 
œ°_block
 = 
fú°_block
 +

2526 (
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

2528 i‡((
gΩ
 =
sbi
->
s_groups_cou¡
) &&

2529 !(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

2530 
gΩ
 = 
i
;

2532 
block_bôm≠
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

2533 i‡(
block_bôm≠
 =
sb_block
) {

2534 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2536 "su≥rblock", 
i
);

2537 i‡(!
	`sb_rd⁄ly
(
sb
))

2540 i‡(
block_bôm≠
 >
sb_block
 + 1 &&

2541 
block_bôm≠
 <
œ°_bg_block
) {

2542 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2544 "block grou∞des¸ùt‹s", 
i
);

2545 i‡(!
	`sb_rd⁄ly
(
sb
))

2548 i‡(
block_bôm≠
 < 
fú°_block
 || block_bôm≠ > 
œ°_block
) {

2549 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2551 "(block %Œu)!", 
i
, 
block_bôm≠
);

2554 
öode_bôm≠
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

2555 i‡(
öode_bôm≠
 =
sb_block
) {

2556 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2558 "su≥rblock", 
i
);

2559 i‡(!
	`sb_rd⁄ly
(
sb
))

2562 i‡(
öode_bôm≠
 >
sb_block
 + 1 &&

2563 
öode_bôm≠
 <
œ°_bg_block
) {

2564 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2566 "block grou∞des¸ùt‹s", 
i
);

2567 i‡(!
	`sb_rd⁄ly
(
sb
))

2570 i‡(
öode_bôm≠
 < 
fú°_block
 || inode_bôm≠ > 
œ°_block
) {

2571 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2573 "(block %Œu)!", 
i
, 
öode_bôm≠
);

2576 
öode_èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

2577 i‡(
öode_èbÀ
 =
sb_block
) {

2578 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2580 "su≥rblock", 
i
);

2581 i‡(!
	`sb_rd⁄ly
(
sb
))

2584 i‡(
öode_èbÀ
 >
sb_block
 + 1 &&

2585 
öode_èbÀ
 <
œ°_bg_block
) {

2586 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2588 "block grou∞des¸ùt‹s", 
i
);

2589 i‡(!
	`sb_rd⁄ly
(
sb
))

2592 i‡(
öode_èbÀ
 < 
fú°_block
 ||

2593 
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
 - 1 > 
œ°_block
) {

2594 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2596 "(block %Œu)!", 
i
, 
öode_èbÀ
);

2599 
	`pxt4_lock_group
(
sb
, 
i
);

2600 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
i
, 
gdp
)) {

2601 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2603 
i
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, i,

2604 
gdp
)), 
	`À16_to_˝u
(gdp->
bg_checksum
));

2605 i‡(!
	`sb_rd⁄ly
(
sb
)) {

2606 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2610 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2611 i‡(!
Êexbg_Êag
)

2612 
fú°_block
 +
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

2614 i‡(
NULL
 !
fú°_nŸ_zî€d
)

2615 *
fú°_nŸ_zî€d
 = 
gΩ
;

2617 
	}
}

2636 
	$pxt4_‹ph™_˛ónup
(
su≥r_block
 *
sb
,

2637 
pxt4_su≥r_block
 *
es
)

2639 
s_Êags
 = 
sb
->s_flags;

2640 
ªt
, 
ƒ_‹ph™s
 = 0, 
ƒ_åunˇãs
 = 0;

2641 #ifde‡
CONFIG_QUOTA


2642 
quŸa_upd©e
 = 0;

2643 
i
;

2645 i‡(!
es
->
s_œ°_‹ph™
) {

2646 
	`jbd_debug
(4, "no orphan inodesÅo clean up\n");

2650 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
)) {

2651 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

2657 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

2658 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Skipping orphan cleanup dueÅo "

2663 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2665 i‡(
es
->
s_œ°_‹ph™
 && !(
s_Êags
 & 
SB_RDONLY
)) {

2666 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Errors on filesystem, "

2668 
es
->
s_œ°_‹ph™
 = 0;

2670 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2674 i‡(
s_Êags
 & 
SB_RDONLY
) {

2675 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "orphan cleanup onÑeadonly fs");

2676 
sb
->
s_Êags
 &~
SB_RDONLY
;

2678 #ifde‡
CONFIG_QUOTA


2680 
sb
->
s_Êags
 |
SB_ACTIVE
;

2686 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& (
s_Êags
 & 
SB_RDONLY
)) {

2687 
ªt
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

2689 i‡(!
ªt
)

2690 
quŸa_upd©e
 = 1;

2692 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2693 "C™nŸÅu∫ o¿quŸas:Éº‹ %d", 
ªt
);

2697 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2698 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
i
]) {

2699 
ªt
 = 
	`pxt4_quŸa_⁄_mou¡
(
sb
, 
i
);

2701 i‡(!
ªt
)

2702 
quŸa_upd©e
 = 1;

2704 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2706 "quŸa:Åy≥ %d:Éº‹ %d", 
i
, 
ªt
);

2711 
es
->
s_œ°_‹ph™
) {

2712 
öode
 *inode;

2718 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2719 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2720 
es
->
s_œ°_‹ph™
 = 0;

2724 
öode
 = 
	`pxt4_‹ph™_gë
(
sb
, 
	`À32_to_˝u
(
es
->
s_œ°_‹ph™
));

2725 i‡(
	`IS_ERR
(
öode
)) {

2726 
es
->
s_œ°_‹ph™
 = 0;

2730 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
	`PXT4_SB
(
sb
)->
s_‹ph™
);

2731 
	`dquŸ_öôülize
(
öode
);

2732 i‡(
öode
->
i_∆ök
) {

2733 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2734 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2736 
__func__
, 
öode
->
i_öo
, inode->
i_size
);

2737 
	`jbd_debug
(2, "truncating inode %luÅo %lld bytes\n",

2738 
öode
->
i_öo
, inode->
i_size
);

2739 
	`öode_lock
(
öode
);

2740 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

2741 
ªt
 = 
	`pxt4_åunˇã
(
öode
);

2742 i‡(
ªt
)

2743 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

2744 
	`öode_u∆ock
(
öode
);

2745 
ƒ_åunˇãs
++;

2747 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2748 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2750 
__func__
, 
öode
->
i_öo
);

2751 
	`jbd_debug
(2, "deleting unreferenced inode %lu\n",

2752 
öode
->
i_öo
);

2753 
ƒ_‹ph™s
++;

2755 
	`ùut
(
öode
);

2758 
	#PLURAL
(
x
Ë(x), ((xË=1Ë? "" : "s"

	)

2760 i‡(
ƒ_‹ph™s
)

2761 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%d orphan inode%s deleted",

2762 
	`PLURAL
(
ƒ_‹ph™s
));

2763 i‡(
ƒ_åunˇãs
)

2764 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%dÅruncate%s cleaned up",

2765 
	`PLURAL
(
ƒ_åunˇãs
));

2766 #ifde‡
CONFIG_QUOTA


2768 i‡(
quŸa_upd©e
) {

2769 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2770 i‡(
	`sb_dq›t
(
sb
)->
fûes
[
i
])

2771 
	`dquŸ_quŸa_off
(
sb
, 
i
);

2775 
sb
->
s_Êags
 = s_flags;

2776 
	}
}

2793 
loff_t
 
	$pxt4_max_size
(
blkbôs
, 
has_huge_fûes
)

2795 
loff_t
 
ªs
;

2796 
loff_t
 
uµî_limô
 = 
MAX_LFS_FILESIZE
;

2798 
	`BUILD_BUG_ON
((
blk˙t_t
Ë< (
u64
));

2800 i‡(!
has_huge_fûes
) {

2801 
uµî_limô
 = (1LL << 32) - 1;

2804 
uµî_limô
 >>(
blkbôs
 - 9);

2805 
uµî_limô
 <<
blkbôs
;

2813 
ªs
 = (1LL << 32) - 1;

2814 
ªs
 <<
blkbôs
;

2817 i‡(
ªs
 > 
uµî_limô
)

2818 
ªs
 = 
uµî_limô
;

2820  
ªs
;

2821 
	}
}

2828 
loff_t
 
	$pxt4_max_bôm≠_size
(
bôs
, 
has_huge_fûes
)

2830 
loff_t
 
ªs
 = 
PXT4_NDIR_BLOCKS
;

2831 
mëa_blocks
;

2832 
loff_t
 
uµî_limô
;

2841 i‡(!
has_huge_fûes
) {

2847 
uµî_limô
 = (1LL << 32) - 1;

2850 
uµî_limô
 >>(
bôs
 - 9);

2859 
uµî_limô
 = (1LL << 48) - 1;

2864 
mëa_blocks
 = 1;

2866 
mëa_blocks
 +1 + (1LL << (
bôs
-2));

2868 
mëa_blocks
 +1 + (1LL << (
bôs
-2)) + (1LL << (2*(bits-2)));

2870 
uµî_limô
 -
mëa_blocks
;

2871 
uµî_limô
 <<
bôs
;

2873 
ªs
 +1LL << (
bôs
-2);

2874 
ªs
 +1LL << (2*(
bôs
-2));

2875 
ªs
 +1LL << (3*(
bôs
-2));

2876 
ªs
 <<
bôs
;

2877 i‡(
ªs
 > 
uµî_limô
)

2878 
ªs
 = 
uµî_limô
;

2880 i‡(
ªs
 > 
MAX_LFS_FILESIZE
)

2881 
ªs
 = 
MAX_LFS_FILESIZE
;

2883  
ªs
;

2884 
	}
}

2886 
pxt4_fsblk_t
 
	$des¸ùt‹_loc
(
su≥r_block
 *
sb
,

2887 
pxt4_fsblk_t
 
logiˇl_sb_block
, 
ƒ
)

2889 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2890 
pxt4_group_t
 
bg
, 
fú°_mëa_bg
;

2891 
has_su≥r
 = 0;

2893 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

2895 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
ƒ
 < 
fú°_mëa_bg
)

2896  
logiˇl_sb_block
 + 
ƒ
 + 1;

2897 
bg
 = 
sbi
->
s_desc_≥r_block
 * 
ƒ
;

2898 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
bg
))

2899 
has_su≥r
 = 1;

2907 i‡(
sb
->
s_blocksize
 =1024 && 
ƒ
 == 0 &&

2908 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) == 0)

2909 
has_su≥r
++;

2911  (
has_su≥r
 + 
	`pxt4_group_fú°_block_no
(
sb
, 
bg
));

2912 
	}
}

2925 
	$pxt4_gë_°rùe_size
(
pxt4_sb_öfo
 *
sbi
)

2927 
°ride
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_øid_°ride
);

2928 
°rùe_width
 =

2929 
	`À32_to_˝u
(
sbi
->
s_es
->
s_øid_°rùe_width
);

2930 
ªt
;

2932 i‡(
sbi
->
s_°rùe
 && sbi->s_°rùê<sbi->
s_blocks_≥r_group
)

2933 
ªt
 = 
sbi
->
s_°rùe
;

2934 i‡(
°rùe_width
 && såùe_width <
sbi
->
s_blocks_≥r_group
)

2935 
ªt
 = 
°rùe_width
;

2936 i‡(
°ride
 && såidê<
sbi
->
s_blocks_≥r_group
)

2937 
ªt
 = 
°ride
;

2939 
ªt
 = 0;

2945 i‡(
ªt
 <= 1)

2946 
ªt
 = 0;

2948  
ªt
;

2949 
	}
}

2957 
	$pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
)

2959 i‡(
	`pxt4_has_unknown_pxt4_öcom∑t_„©uªs
(
sb
)) {

2960 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2963 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
) &

2964 ~
PXT4_FEATURE_INCOMPAT_SUPP
));

2968 #i‚de‡
CONFIG_UNICODE


2969 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

2970 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2977 i‡(
ªad⁄ly
)

2980 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
)) {

2981 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "filesystem isÑead-only");

2982 
sb
->
s_Êags
 |
SB_RDONLY
;

2987 i‡(
	`pxt4_has_unknown_pxt4_ro_com∑t_„©uªs
(
sb
)) {

2988 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mount RDWR because of "

2990 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
) &

2991 ~
PXT4_FEATURE_RO_COMPAT_SUPP
));

2994 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
Ë&& !
	`pxt4_has_„©uª_exã¡s
(sb)) {

2995 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3001 #i‡!
	`IS_ENABLED
(
CONFIG_QUOTA
Ë|| !IS_ENABLED(
CONFIG_QFMT_V2
)

3002 i‡(!
ªad⁄ly
 && (
	`pxt4_has_„©uª_quŸa
(
sb
) ||

3003 
	`pxt4_has_„©uª_¥oje˘
(
sb
))) {

3004 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3010 
	}
}

3016 
	$¥öt_daûy_îr‹_öfo
(
timî_li°
 *
t
)

3018 
pxt4_sb_öfo
 *
sbi
 = 
	`‰om_timî
(sbi, 
t
, 
s_îr_ªp‹t
);

3019 
su≥r_block
 *
sb
 = 
sbi
->
s_sb
;

3020 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3022 i‡(
es
->
s_îr‹_cou¡
)

3024 
	`pxt4_msg
(
sb
, 
KERN_NOTICE
, "error count sinceÜast fsck: %u",

3025 
	`À32_to_˝u
(
es
->
s_îr‹_cou¡
));

3026 i‡(
es
->
s_fú°_îr‹_time
) {

3027 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s): initialÉrrorátÅime %llu: %.*s:%d",

3028 
sb
->
s_id
,

3029 
	`pxt4_gë_t°amp
(
es
, 
s_fú°_îr‹_time
),

3030 (Ë(
es
->
s_fú°_îr‹_func
),

3031 
es
->
s_fú°_îr‹_func
,

3032 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_löe
));

3033 i‡(
es
->
s_fú°_îr‹_öo
)

3034 
	`¥ötk
(
KERN_CONT
 ": inode %u",

3035 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_öo
));

3036 i‡(
es
->
s_fú°_îr‹_block
)

3037 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3038 
	`À64_to_˝u
(
es
->
s_fú°_îr‹_block
));

3039 
	`¥ötk
(
KERN_CONT
 "\n");

3041 i‡(
es
->
s_œ°_îr‹_time
) {

3042 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s):ÜastÉrrorátÅime %llu: %.*s:%d",

3043 
sb
->
s_id
,

3044 
	`pxt4_gë_t°amp
(
es
, 
s_œ°_îr‹_time
),

3045 (Ë(
es
->
s_œ°_îr‹_func
),

3046 
es
->
s_œ°_îr‹_func
,

3047 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_löe
));

3048 i‡(
es
->
s_œ°_îr‹_öo
)

3049 
	`¥ötk
(
KERN_CONT
 ": inode %u",

3050 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_öo
));

3051 i‡(
es
->
s_œ°_îr‹_block
)

3052 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3053 
	`À64_to_˝u
(
es
->
s_œ°_îr‹_block
));

3054 
	`¥ötk
(
KERN_CONT
 "\n");

3056 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

3057 
	}
}

3060 
	$pxt4_run_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3062 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3063 
pxt4_group_t
 
group
, 
ngroups
;

3064 
su≥r_block
 *
sb
;

3065 
timeout
 = 0;

3066 
ªt
 = 0;

3068 
sb
 = 
ñr
->
Ã_su≥r
;

3069 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3071 
group
 = 
ñr
->
Ã_√xt_group
; grou∞< 
ngroups
; group++) {

3072 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3073 i‡(!
gdp
) {

3074 
ªt
 = 1;

3078 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3082 i‡(
group
 >
ngroups
)

3083 
ªt
 = 1;

3085 i‡(!
ªt
) {

3086 
timeout
 = 
jiffõs
;

3087 
ªt
 = 
	`pxt4_öô_öode_èbÀ
(
sb
, 
group
,

3088 
ñr
->
Ã_timeout
 ? 0 : 1);

3089 i‡(
ñr
->
Ã_timeout
 == 0) {

3090 
timeout
 = (
jiffõs
 -Åimeout) *

3091 
ñr
->
Ã_sbi
->
s_li_waô_mu…
;

3092 
ñr
->
Ã_timeout
 = 
timeout
;

3094 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +ÉÃ->
Ã_timeout
;

3095 
ñr
->
Ã_√xt_group
 = 
group
 + 1;

3097  
ªt
;

3098 
	}
}

3104 
	$pxt4_ªmove_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3106 
pxt4_sb_öfo
 *
sbi
;

3108 i‡(!
ñr
)

3111 
sbi
 = 
ñr
->
Ã_sbi
;

3113 
	`li°_dñ
(&
ñr
->
Ã_ªque°
);

3114 
sbi
->
s_li_ªque°
 = 
NULL
;

3115 
	`k‰ì
(
ñr
);

3116 
	}
}

3118 
	$pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
)

3120 
	`muãx_lock
(&
pxt4_li_mtx
);

3121 i‡(!
pxt4_li_öfo
) {

3122 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3126 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3127 
	`pxt4_ªmove_li_ªque°
(
	`PXT4_SB
(
sb
)->
s_li_ªque°
);

3128 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3129 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3130 
	}
}

3132 
èsk_°ru˘
 *
	gpxt4_œzyöô_èsk
;

3143 
	$pxt4_œzyöô_thªad
(*
¨g
)

3145 
pxt4_œzy_öô
 *
ñi
 = (pxt4_œzy_öô *)
¨g
;

3146 
li°_hód
 *
pos
, *
n
;

3147 
pxt4_li_ªque°
 *
ñr
;

3148 
√xt_wakeup
, 
cur
;

3150 
	`BUG_ON
(
NULL
 =
ñi
);

3152 
c⁄t_thªad
:

3153 
åue
) {

3154 
√xt_wakeup
 = 
MAX_JIFFY_OFFSET
;

3156 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3157 i‡(
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3158 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3159 
exô_thªad
;

3161 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
ñi
->
li_ªque°_li°
) {

3162 
îr
 = 0;

3163 
¥ogªss
 = 0;

3164 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3165 
Ã_ªque°
);

3167 i‡(
	`time_bef‹e
(
jiffõs
, 
ñr
->
Ã_√xt_sched
)) {

3168 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3169 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3172 i‡(
	`down_ªad_åylock
(&
ñr
->
Ã_su≥r
->
s_umou¡
)) {

3173 i‡(
	`sb_°¨t_wrôe_åylock
(
ñr
->
Ã_su≥r
)) {

3174 
¥ogªss
 = 1;

3180 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3181 
îr
 = 
	`pxt4_run_li_ªque°
(
ñr
);

3182 
	`sb_íd_wrôe
(
ñr
->
Ã_su≥r
);

3183 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3184 
n
 = 
pos
->
√xt
;

3186 
	`up_ªad
((&
ñr
->
Ã_su≥r
->
s_umou¡
));

3189 i‡(
îr
) {

3190 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3193 i‡(!
¥ogªss
) {

3194 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +

3195 (
	`¥™dom_u32
()

3196 % (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3198 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3199 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3201 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3203 
	`åy_to_‰ìze
();

3205 
cur
 = 
jiffõs
;

3206 i‡((
	`time_a·î_eq
(
cur
, 
√xt_wakeup
)) ||

3207 (
MAX_JIFFY_OFFSET
 =
√xt_wakeup
)) {

3208 
	`c⁄d_ªsched
();

3212 
	`scheduÀ_timeout_öãºu±ibÀ
(
√xt_wakeup
 - 
cur
);

3214 i‡(
	`kthªad_should_°›
()) {

3215 
	`pxt4_˛ór_ªque°_li°
();

3216 
exô_thªad
;

3220 
exô_thªad
:

3229 
	`muãx_lock
(&
pxt4_li_mtx
);

3230 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3231 i‡(!
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3232 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3233 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3234 
c⁄t_thªad
;

3236 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3237 
	`k‰ì
(
pxt4_li_öfo
);

3238 
pxt4_li_öfo
 = 
NULL
;

3239 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3242 
	}
}

3244 
	$pxt4_˛ór_ªque°_li°
()

3246 
li°_hód
 *
pos
, *
n
;

3247 
pxt4_li_ªque°
 *
ñr
;

3249 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3250 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
pxt4_li_öfo
->
li_ªque°_li°
) {

3251 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3252 
Ã_ªque°
);

3253 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3255 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3256 
	}
}

3258 
	$pxt4_run_œzyöô_thªad
()

3260 
pxt4_œzyöô_èsk
 = 
	`kthªad_run
(
pxt4_œzyöô_thªad
,

3261 
pxt4_li_öfo
, "pxt4lazyinit");

3262 i‡(
	`IS_ERR
(
pxt4_œzyöô_èsk
)) {

3263 
îr
 = 
	`PTR_ERR
(
pxt4_œzyöô_èsk
);

3264 
	`pxt4_˛ór_ªque°_li°
();

3265 
	`k‰ì
(
pxt4_li_öfo
);

3266 
pxt4_li_öfo
 = 
NULL
;

3267 
	`¥ötk
(
KERN_CRIT
 "PXT4-fs:Érror %d creating inodeÅable "

3269 
îr
);

3270  
îr
;

3272 
pxt4_li_öfo
->
li_°©e
 |
PXT4_LAZYINIT_RUNNING
;

3274 
	}
}

3282 
pxt4_group_t
 
	$pxt4_has_unöô_ôabÀ
(
su≥r_block
 *
sb
)

3284 
pxt4_group_t
 
group
, 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3285 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3287 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

3288  
ngroups
;

3290 
group
 = 0; grou∞< 
ngroups
; group++) {

3291 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3292 i‡(!
gdp
)

3295 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3299  
group
;

3300 
	}
}

3302 
	$pxt4_li_öfo_√w
()

3304 
pxt4_œzy_öô
 *
ñi
 = 
NULL
;

3306 
ñi
 = 
	`kzÆloc
((*ñi), 
GFP_KERNEL
);

3307 i‡(!
ñi
)

3308  -
ENOMEM
;

3310 
	`INIT_LIST_HEAD
(&
ñi
->
li_ªque°_li°
);

3311 
	`muãx_öô
(&
ñi
->
li_li°_mtx
);

3313 
ñi
->
li_°©e
 |
PXT4_LAZYINIT_QUIT
;

3315 
pxt4_li_öfo
 = 
ñi
;

3318 
	}
}

3320 
pxt4_li_ªque°
 *
	$pxt4_li_ªque°_√w
(
su≥r_block
 *
sb
,

3321 
pxt4_group_t
 
°¨t
)

3323 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3324 
pxt4_li_ªque°
 *
ñr
;

3326 
ñr
 = 
	`kzÆloc
((*ñr), 
GFP_KERNEL
);

3327 i‡(!
ñr
)

3328  
NULL
;

3330 
ñr
->
Ã_su≥r
 = 
sb
;

3331 
ñr
->
Ã_sbi
 = 
sbi
;

3332 
ñr
->
Ã_√xt_group
 = 
°¨t
;

3339 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 + (
	`¥™dom_u32
() %

3340 (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3341  
ñr
;

3342 
	}
}

3344 
	$pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

3345 
pxt4_group_t
 
fú°_nŸ_zî€d
)

3347 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3348 
pxt4_li_ªque°
 *
ñr
 = 
NULL
;

3349 
pxt4_group_t
 
ngroups
 = 
sbi
->
s_groups_cou¡
;

3350 
ªt
 = 0;

3352 
	`muãx_lock
(&
pxt4_li_mtx
);

3353 i‡(
sbi
->
s_li_ªque°
 !
NULL
) {

3358 
sbi
->
s_li_ªque°
->
Ã_timeout
 = 0;

3359 
out
;

3362 i‡(
fú°_nŸ_zî€d
 =
ngroups
 || 
	`sb_rd⁄ly
(
sb
) ||

3363 !
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

3364 
out
;

3366 
ñr
 = 
	`pxt4_li_ªque°_√w
(
sb
, 
fú°_nŸ_zî€d
);

3367 i‡(!
ñr
) {

3368 
ªt
 = -
ENOMEM
;

3369 
out
;

3372 i‡(
NULL
 =
pxt4_li_öfo
) {

3373 
ªt
 = 
	`pxt4_li_öfo_√w
();

3374 i‡(
ªt
)

3375 
out
;

3378 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3379 
	`li°_add
(&
ñr
->
Ã_ªque°
, &
pxt4_li_öfo
->
li_ªque°_li°
);

3380 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3382 
sbi
->
s_li_ªque°
 = 
ñr
;

3388 
ñr
 = 
NULL
;

3390 i‡(!(
pxt4_li_öfo
->
li_°©e
 & 
PXT4_LAZYINIT_RUNNING
)) {

3391 
ªt
 = 
	`pxt4_run_œzyöô_thªad
();

3392 i‡(
ªt
)

3393 
out
;

3395 
out
:

3396 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3397 i‡(
ªt
)

3398 
	`k‰ì
(
ñr
);

3399  
ªt
;

3400 
	}
}

3406 
	$pxt4_de°roy_œzyöô_thªad
()

3412 i‡(!
pxt4_li_öfo
 || !
pxt4_œzyöô_èsk
)

3415 
	`kthªad_°›
(
pxt4_œzyöô_èsk
);

3416 
	}
}

3418 
	$£t_jou∫Æ_csum_„©uª_£t
(
su≥r_block
 *
sb
)

3420 
ªt
 = 1;

3421 
com∑t
, 
öcom∑t
;

3422 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3424 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

3426 
com∑t
 = 0;

3427 
öcom∑t
 = 
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

3430 
com∑t
 = 
JBD3_FEATURE_COMPAT_CHECKSUM
;

3431 
öcom∑t
 = 0;

3434 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
,

3435 
JBD3_FEATURE_COMPAT_CHECKSUM
, 0,

3436 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 |

3437 
JBD3_FEATURE_INCOMPAT_CSUM_V2
);

3438 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

3439 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3440 
com∑t
, 0,

3441 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
 |

3442 
öcom∑t
);

3443 } i‡(
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

3444 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3445 
com∑t
, 0,

3446 
öcom∑t
);

3447 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3448 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3450 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3451 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3454  
ªt
;

3455 
	}
}

3472 
	$cou¡_ovîhód
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

3473 *
buf
)

3475 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3476 
pxt4_group_desc
 *
gdp
;

3477 
pxt4_fsblk_t
 
fú°_block
, 
œ°_block
, 
b
;

3478 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3479 
s
, 
j
, 
cou¡
 = 0;

3481 i‡(!
	`pxt4_has_„©uª_bigÆloc
(
sb
))

3482  (
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
Ë+ 
	`pxt4_bg_num_gdb
(sb, grp) +

3483 
sbi
->
s_ôb_≥r_group
 + 2);

3485 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) +

3486 (
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

3487 
œ°_block
 = 
fú°_block
 + 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1;

3488 
i
 = 0; i < 
ngroups
; i++) {

3489 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

3490 
b
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

3491 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3492 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3493 
cou¡
++;

3495 
b
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

3496 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3497 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3498 
cou¡
++;

3500 
b
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

3501 i‡(
b
 >
fú°_block
 && b + 
sbi
->
s_ôb_≥r_group
 <
œ°_block
)

3502 
j
 = 0; j < 
sbi
->
s_ôb_≥r_group
; j++, 
b
++) {

3503 
c
 = 
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
);

3504 
	`pxt4_£t_bô
(
c
, 
buf
);

3505 
cou¡
++;

3507 i‡(
i
 !
gΩ
)

3509 
s
 = 0;

3510 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
)) {

3511 
	`pxt4_£t_bô
(
s
++, 
buf
);

3512 
cou¡
++;

3514 
j
 = 
	`pxt4_bg_num_gdb
(
sb
, 
gΩ
);

3515 i‡(
s
 + 
j
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

3516 
	`pxt4_îr‹
(
sb
, "InvalidÇumber of block group "

3517 "des¸ùt‹ blocks: %d", 
j
);

3518 
j
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
s
;

3520 
cou¡
 +
j
;

3521 ; 
j
 > 0; j--)

3522 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
s
++), 
buf
);

3524 i‡(!
cou¡
)

3526  
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) -

3527 
	`pxt4_cou¡_‰ì
(
buf
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

3528 
	}
}

3533 
	$pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
)

3535 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3536 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3537 
öode
 *
j_öode
;

3538 
j_blocks
, 
j_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

3539 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3540 
pxt4_fsblk_t
 
ovîhód
 = 0;

3541 *
buf
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_NOFS
);

3543 i‡(!
buf
)

3544  -
ENOMEM
;

3555 
ovîhód
 = 
	`PXT4_B2C
(
sbi
, 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
));

3560 
i
 = 0; i < 
ngroups
; i++) {

3561 
blks
;

3563 
blks
 = 
	`cou¡_ovîhód
(
sb
, 
i
, 
buf
);

3564 
ovîhód
 +
blks
;

3565 i‡(
blks
)

3566 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

3567 
	`c⁄d_ªsched
();

3574 i‡(
sbi
->
s_jou∫Æ
 && !sbi->
jou∫Æ_bdev
)

3575 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, sbi->
s_jou∫Æ
->
j_maxÀn
);

3576 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& !
sbi
->
s_jou∫Æ
 && 
j_öum
) {

3578 
j_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
j_öum
);

3579 i‡(
j_öode
) {

3580 
j_blocks
 = 
j_öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

3581 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, 
j_blocks
);

3582 
	`ùut
(
j_öode
);

3584 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't get journal size");

3587 
sbi
->
s_ovîhód
 = 
ovîhód
;

3588 
	`smp_wmb
();

3589 
	`‰ì_∑ge
((Ë
buf
);

3591 
	}
}

3593 
	$pxt4_£t_ªsv_˛u°îs
(
su≥r_block
 *
sb
)

3595 
pxt4_fsblk_t
 
ªsv_˛u°îs
;

3596 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3604 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3614 
ªsv_˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

3615 
sbi
->
s_˛u°î_bôs
);

3617 
	`do_div
(
ªsv_˛u°îs
, 50);

3618 
ªsv_˛u°îs
 = 
	`mö_t
(
pxt4_fsblk_t
,Ñesv_clusters, 4096);

3620 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
ªsv_˛u°îs
);

3621 
	}
}

3623 
	$pxt4_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

3625 
dax_devi˚
 *
dax_dev
 = 
	`fs_dax_gë_by_bdev
(
sb
->
s_bdev
);

3626 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

3627 
buf„r_hód
 *
bh
, **
group_desc
;

3628 
pxt4_su≥r_block
 *
es
 = 
NULL
;

3629 
pxt4_sb_öfo
 *
sbi
 = 
	`kzÆloc
((*sbi), 
GFP_KERNEL
);

3630 
Êex_groups
 **flex_groups;

3631 
pxt4_fsblk_t
 
block
;

3632 
pxt4_fsblk_t
 
sb_block
 = 
	`gë_sb_block
(&
d©a
);

3633 
pxt4_fsblk_t
 
logiˇl_sb_block
;

3634 
off£t
 = 0;

3635 
jou∫Æ_devnum
 = 0;

3636 
def_mou¡_›ts
;

3637 
öode
 *
roŸ
;

3638 c⁄° *
des¸
;

3639 
ªt
 = -
ENOMEM
;

3640 
blocksize
, 
˛u°îsize
;

3641 
db_cou¡
;

3642 
i
;

3643 
√eds_ªcovîy
, 
has_huge_fûes
, 
has_bigÆloc
;

3644 
__u64
 
blocks_cou¡
;

3645 
îr
 = 0;

3646 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

3647 
pxt4_group_t
 
fú°_nŸ_zî€d
;

3649 i‡((
d©a
 && !
‹ig_d©a
Ë|| !
sbi
)

3650 
out_‰ì_ba£
;

3652 
sbi
->
s_daxdev
 = 
dax_dev
;

3653 
sbi
->
s_blockgroup_lock
 =

3654 
	`kzÆloc
((
blockgroup_lock
), 
GFP_KERNEL
);

3655 i‡(!
sbi
->
s_blockgroup_lock
)

3656 
out_‰ì_ba£
;

3658 
sb
->
s_fs_öfo
 = 
sbi
;

3659 
sbi
->
s_sb
 = 
sb
;

3660 
sbi
->
s_öode_ªadahód_blks
 = 
PXT4_DEF_INODE_READAHEAD_BLKS
;

3661 
sbi
->
s_sb_block
 = 
sb_block
;

3662 i‡(
sb
->
s_bdev
->
bd_∑π
)

3663 
sbi
->
s_£˘‹s_wrôãn_°¨t
 =

3664 
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
, 
£˘‹s
[
STAT_WRITE
]);

3667 
	`°ºïœ˚
(
sb
->
s_id
, '/', '!');

3670 
ªt
 = -
EINVAL
;

3671 
blocksize
 = 
	`sb_mö_blocksize
(
sb
, 
PXT4_MIN_BLOCK_SIZE
);

3672 i‡(!
blocksize
) {

3673 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅo set blocksize");

3674 
out_Áû
;

3681 i‡(
blocksize
 !
PXT4_MIN_BLOCK_SIZE
) {

3682 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

3683 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

3685 
logiˇl_sb_block
 = 
sb_block
;

3688 i‡(!(
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
))) {

3689 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead superblock");

3690 
out_Áû
;

3696 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

3697 
sbi
->
s_es
 = 
es
;

3698 
sb
->
s_magic
 = 
	`À16_to_˝u
(
es
->s_magic);

3699 i‡(
sb
->
s_magic
 !
PXT4_SUPER_MAGIC
)

3700 
ˇ¡föd_pxt4
;

3701 
sbi
->
s_kbyãs_wrôãn
 = 
	`À64_to_˝u
(
es
->s_kbytes_written);

3704 i‡(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

3705 
	`pxt4_has_„©uª_gdt_csum
(
sb
))

3706 
	`pxt4_w¨nög
(
sb
, "metadata_csumánd uninit_bgáre "

3710 i‡(!
	`pxt4_vîify_csum_ty≥
(
sb
, 
es
)) {

3711 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3713 
sûít
 = 1;

3714 
ˇ¡föd_pxt4
;

3718 
sbi
->
s_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

3719 i‡(
	`IS_ERR
(
sbi
->
s_chksum_drivî
)) {

3720 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CannotÜoad crc32c driver.");

3721 
ªt
 = 
	`PTR_ERR
(
sbi
->
s_chksum_drivî
);

3722 
sbi
->
s_chksum_drivî
 = 
NULL
;

3723 
Áûed_mou¡
;

3727 i‡(!
	`pxt4_su≥rblock_csum_vîify
(
sb
, 
es
)) {

3728 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3730 
sûít
 = 1;

3731 
ªt
 = -
EFSBADCRC
;

3732 
ˇ¡föd_pxt4
;

3736 i‡(
	`pxt4_has_„©uª_csum_£ed
(
sb
))

3737 
sbi
->
s_csum_£ed
 = 
	`À32_to_˝u
(
es
->
s_checksum_£ed
);

3738 i‡(
	`pxt4_has_mëad©a_csum
(
sb
Ë|| 
	`pxt4_has_„©uª_ó_öode
(sb))

3739 
sbi
->
s_csum_£ed
 = 
	`pxt4_chksum
(sbi, ~0, 
es
->
s_uuid
,

3740 (
es
->
s_uuid
));

3743 
def_mou¡_›ts
 = 
	`À32_to_˝u
(
es
->
s_deÁu…_mou¡_›ts
);

3744 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

3745 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DEBUG
)

3746 
	`£t_›t
(
sb
, 
DEBUG
);

3747 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_BSDGROUPS
)

3748 
	`£t_›t
(
sb
, 
GRPID
);

3749 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_UID16
)

3750 
	`£t_›t
(
sb
, 
NO_UID32
);

3752 
	`£t_›t
(
sb
, 
XATTR_USER
);

3753 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


3754 
	`£t_›t
(
sb
, 
POSIX_ACL
);

3757 i‡(
	`pxt4_has_mëad©a_csum
(
sb
))

3758 
	`£t_›t
(
sb
, 
JOURNAL_CHECKSUM
);

3760 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_DATA
)

3761 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

3762 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_ORDERED
)

3763 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

3764 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_WBACK
)

3765 
	`£t_›t
(
sb
, 
WRITEBACK_DATA
);

3767 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_PANIC
)

3768 
	`£t_›t
(
sb
, 
ERRORS_PANIC
);

3769 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_CONTINUE
)

3770 
	`£t_›t
(
sb
, 
ERRORS_CONT
);

3772 
	`£t_›t
(
sb
, 
ERRORS_RO
);

3774 
	`£t_›t
(
sb
, 
BLOCK_VALIDITY
);

3775 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DISCARD
)

3776 
	`£t_›t
(
sb
, 
DISCARD
);

3778 
sbi
->
s_ªsuid
 = 
	`make_kuid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsuid
));

3779 
sbi
->
s_ªsgid
 = 
	`make_kgid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsgid
));

3780 
sbi
->
s_commô_öãrvÆ
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
 * 
HZ
;

3781 
sbi
->
s_mö_b©ch_time
 = 
PXT4_DEF_MIN_BATCH_TIME
;

3782 
sbi
->
s_max_b©ch_time
 = 
PXT4_DEF_MAX_BATCH_TIME
;

3784 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_NOBARRIER
) == 0)

3785 
	`£t_›t
(
sb
, 
BARRIER
);

3791 i‡(!
	`IS_EXT3_SB
(
sb
Ë&& !
	`IS_PXT2_SB
(sb) &&

3792 ((
def_mou¡_›ts
 & 
PXT4_DEFM_NODELALLOC
) == 0))

3793 
	`£t_›t
(
sb
, 
DELALLOC
);

3799 
sbi
->
s_li_waô_mu…
 = 
PXT4_DEF_LI_WAIT_MULT
;

3801 
blocksize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_block_size
);

3802 i‡(
blocksize
 < 
PXT4_MIN_BLOCK_SIZE
 ||

3803 
blocksize
 > 
PXT4_MAX_BLOCK_SIZE
) {

3804 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3806 
blocksize
, 
	`À32_to_˝u
(
es
->
s_log_block_size
));

3807 
Áûed_mou¡
;

3810 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
) {

3811 
sbi
->
s_öode_size
 = 
PXT4_GOOD_OLD_INODE_SIZE
;

3812 
sbi
->
s_fú°_öo
 = 
PXT4_GOOD_OLD_FIRST_INO
;

3814 
sbi
->
s_öode_size
 = 
	`À16_to_˝u
(
es
->s_inode_size);

3815 
sbi
->
s_fú°_öo
 = 
	`À32_to_˝u
(
es
->s_first_ino);

3816 i‡(
sbi
->
s_fú°_öo
 < 
PXT4_GOOD_OLD_FIRST_INO
) {

3817 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid first ino: %u",

3818 
sbi
->
s_fú°_öo
);

3819 
Áûed_mou¡
;

3821 i‡((
sbi
->
s_öode_size
 < 
PXT4_GOOD_OLD_INODE_SIZE
) ||

3822 (!
	`is_powî_of_2
(
sbi
->
s_öode_size
)) ||

3823 (
sbi
->
s_öode_size
 > 
blocksize
)) {

3824 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3826 
sbi
->
s_öode_size
);

3827 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksize: %d", 
blocksize
);

3828 
Áûed_mou¡
;

3836 i‡(
sbi
->
s_öode_size
 >
	`off£tof
(
pxt4_öode
, 
i_©ime_exåa
) +

3837 (((
pxt4_öode
 *)0)->
i_©ime_exåa
)) {

3838 
sb
->
s_time_gøn
 = 1;

3839 
sb
->
s_time_max
 = 
PXT4_EXTRA_TIMESTAMP_MAX
;

3841 
sb
->
s_time_gøn
 = 
NSEC_PER_SEC
;

3842 
sb
->
s_time_max
 = 
PXT4_NON_EXTRA_TIMESTAMP_MAX
;

3844 
sb
->
s_time_mö
 = 
PXT4_TIMESTAMP_MIN
;

3846 i‡(
sbi
->
s_öode_size
 > 
PXT4_GOOD_OLD_INODE_SIZE
) {

3847 
sbi
->
s_w™t_exåa_isize
 = (
pxt4_öode
) -

3848 
PXT4_GOOD_OLD_INODE_SIZE
;

3849 i‡(
	`pxt4_has_„©uª_exåa_isize
(
sb
)) {

3850 
v
, 
max
 = (
sbi
->
s_öode_size
 -

3851 
PXT4_GOOD_OLD_INODE_SIZE
);

3853 
v
 = 
	`À16_to_˝u
(
es
->
s_w™t_exåa_isize
);

3854 i‡(
v
 > 
max
) {

3855 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3856 "bad s_w™t_exåa_isize: %d", 
v
);

3857 
Áûed_mou¡
;

3859 i‡(
sbi
->
s_w™t_exåa_isize
 < 
v
)

3860 
sbi
->
s_w™t_exåa_isize
 = 
v
;

3862 
v
 = 
	`À16_to_˝u
(
es
->
s_mö_exåa_isize
);

3863 i‡(
v
 > 
max
) {

3864 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3865 "bad s_mö_exåa_isize: %d", 
v
);

3866 
Áûed_mou¡
;

3868 i‡(
sbi
->
s_w™t_exåa_isize
 < 
v
)

3869 
sbi
->
s_w™t_exåa_isize
 = 
v
;

3873 i‡(
sbi
->
s_es
->
s_mou¡_›ts
[0]) {

3874 *
s_mou¡_›ts
 = 
	`k°∫dup
(
sbi
->
s_es
->s_mount_opts,

3875 (
sbi
->
s_es
->
s_mou¡_›ts
),

3876 
GFP_KERNEL
);

3877 i‡(!
s_mou¡_›ts
)

3878 
Áûed_mou¡
;

3879 i‡(!
	`∑r£_›ti⁄s
(
s_mou¡_›ts
, 
sb
, &
jou∫Æ_devnum
,

3880 &
jou∫Æ_i›rio
, 0)) {

3881 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3883 
s_mou¡_›ts
);

3885 
	`k‰ì
(
s_mou¡_›ts
);

3887 
sbi
->
s_def_mou¡_›t
 = sbi->
s_mou¡_›t
;

3888 i‡(!
	`∑r£_›ti⁄s
((*Ë
d©a
, 
sb
, &
jou∫Æ_devnum
,

3889 &
jou∫Æ_i›rio
, 0))

3890 
Áûed_mou¡
;

3892 #ifde‡
CONFIG_UNICODE


3893 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
Ë&& !
sbi
->
s_ícodög
) {

3894 c⁄° 
pxt4_sb_ícodögs
 *
ícodög_öfo
;

3895 
unicode_m≠
 *
ícodög
;

3896 
__u16
 
ícodög_Êags
;

3898 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3899 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3901 
Áûed_mou¡
;

3904 i‡(
	`pxt4_sb_ªad_ícodög
(
es
, &
ícodög_öfo
,

3905 &
ícodög_Êags
)) {

3906 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3908 
Áûed_mou¡
;

3911 
ícodög
 = 
	`utf8_lﬂd
(
ícodög_öfo
->
vîsi⁄
);

3912 i‡(
	`IS_ERR
(
ícodög
)) {

3913 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3916 
ícodög_öfo
->
«me
,Éncodög_öfo->
vîsi⁄
,

3917 
ícodög_Êags
);

3918 
Áûed_mou¡
;

3920 
	`pxt4_msg
(
sb
, 
KERN_INFO
,"UsingÉncoding defined by superblock: "

3921 "%s-%†wôh fœg†0x%hx", 
ícodög_öfo
->
«me
,

3922 
ícodög_öfo
->
vîsi⁄
?:"\b", 
ícodög_Êags
);

3924 
sbi
->
s_ícodög
 = 
ícodög
;

3925 
sbi
->
s_ícodög_Êags
 = 
ícodög_Êags
;

3929 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

3930 
	`¥ötk_⁄˚
(
KERN_WARNING
 "PXT4-fs: Warning: mounting "

3933 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

3934 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3936 
Áûed_mou¡
;

3938 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

3939 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3941 
Áûed_mou¡
;

3943 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

3944 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3946 
Áûed_mou¡
;

3948 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3949 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3953 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

3954 
	`˛ór_›t
(
sb
, 
DELALLOC
);

3956 
sb
->
s_iÊags
 |
SB_I_CGROUPWB
;

3959 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

3960 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

3962 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
 &&

3963 (
	`pxt4_has_com∑t_„©uªs
(
sb
) ||

3964 
	`pxt4_has_ro_com∑t_„©uªs
(
sb
) ||

3965 
	`pxt4_has_öcom∑t_„©uªs
(
sb
)))

3966 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3970 i‡(
es
->
s_¸ót‹_os
 =
	`˝u_to_À32
(
PXT4_OS_HURD
)) {

3971 
	`£t_›t2
(
sb
, 
HURD_COMPAT
);

3972 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

3973 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3975 
Áûed_mou¡
;

3982 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

3983 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3985 
Áûed_mou¡
;

3989 i‡(
	`IS_PXT2_SB
(
sb
)) {

3990 i‡(
	`pxt2_„©uª_£t_ok
(
sb
))

3991 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÖxt2 file system "

3998 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

3999 
Áûed_mou¡
;

4000 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÖxt2 due "

4002 
Áûed_mou¡
;

4006 i‡(
	`IS_EXT3_SB
(
sb
)) {

4007 i‡(
	`ext3_„©uª_£t_ok
(
sb
))

4008 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÉxt3 file system "

4015 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

4016 
Áûed_mou¡
;

4017 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÉxt3 due "

4019 
Áûed_mou¡
;

4028 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, (
	`sb_rd⁄ly
(sb))))

4029 
Áûed_mou¡
;

4031 i‡(
	`À32_to_˝u
(
es
->
s_log_block_size
) >

4032 (
PXT4_MAX_BLOCK_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

4033 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4035 
	`À32_to_˝u
(
es
->
s_log_block_size
));

4036 
Áûed_mou¡
;

4038 i‡(
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) >

4039 (
PXT4_MAX_CLUSTER_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

4040 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4042 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
));

4043 
Áûed_mou¡
;

4046 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
Ë> (
blocksize
 / 4)) {

4047 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4049 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
));

4050 
Áûed_mou¡
;

4053 i‡(
sbi
->
s_mou¡_›t
 & 
PXT4_MOUNT_DAX
) {

4054 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
)) {

4055 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot use DAX oná filesystem"

4057 
Áûed_mou¡
;

4059 i‡(!
	`bdev_dax_suµ‹ãd
(
sb
->
s_bdev
, 
blocksize
)) {

4060 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4062 
Áûed_mou¡
;

4066 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
Ë&& 
es
->
s_í¸y±i⁄_Àvñ
) {

4067 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "UnsupportedÉncryptionÜevel %d",

4068 
es
->
s_í¸y±i⁄_Àvñ
);

4069 
Áûed_mou¡
;

4072 i‡(
sb
->
s_blocksize
 !
blocksize
) {

4074 i‡(!
	`sb_£t_blocksize
(
sb
, 
blocksize
)) {

4075 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "bad block size %d",

4076 
blocksize
);

4077 
Áûed_mou¡
;

4080 
	`bªl£
(
bh
);

4081 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

4082 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

4083 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
);

4084 i‡(!
bh
) {

4085 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4087 
Áûed_mou¡
;

4089 
es
 = (
pxt4_su≥r_block
 *)(
bh
->
b_d©a
 + 
off£t
);

4090 
sbi
->
s_es
 = 
es
;

4091 i‡(
es
->
s_magic
 !
	`˝u_to_À16
(
PXT4_SUPER_MAGIC
)) {

4092 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4094 
Áûed_mou¡
;

4098 
has_huge_fûes
 = 
	`pxt4_has_„©uª_huge_fûe
(
sb
);

4099 
sbi
->
s_bôm≠_maxbyãs
 = 
	`pxt4_max_bôm≠_size
(
sb
->
s_blocksize_bôs
,

4100 
has_huge_fûes
);

4101 
sb
->
s_maxbyãs
 = 
	`pxt4_max_size
(sb->
s_blocksize_bôs
, 
has_huge_fûes
);

4103 
sbi
->
s_desc_size
 = 
	`À16_to_˝u
(
es
->s_desc_size);

4104 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

4105 i‡(
sbi
->
s_desc_size
 < 
PXT4_MIN_DESC_SIZE_64BIT
 ||

4106 
sbi
->
s_desc_size
 > 
PXT4_MAX_DESC_SIZE
 ||

4107 !
	`is_powî_of_2
(
sbi
->
s_desc_size
)) {

4108 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4110 
sbi
->
s_desc_size
);

4111 
Áûed_mou¡
;

4114 
sbi
->
s_desc_size
 = 
PXT4_MIN_DESC_SIZE
;

4116 
sbi
->
s_blocks_≥r_group
 = 
	`À32_to_˝u
(
es
->s_blocks_per_group);

4117 
sbi
->
s_öodes_≥r_group
 = 
	`À32_to_˝u
(
es
->s_inodes_per_group);

4119 
sbi
->
s_öodes_≥r_block
 = 
blocksize
 / 
	`PXT4_INODE_SIZE
(
sb
);

4120 i‡(
sbi
->
s_öodes_≥r_block
 == 0)

4121 
ˇ¡föd_pxt4
;

4122 i‡(
sbi
->
s_öodes_≥r_group
 < sbi->
s_öodes_≥r_block
 ||

4123 
sbi
->
s_öodes_≥r_group
 > 
blocksize
 * 8) {

4124 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid inodesÖer group: %lu\n",

4125 
sbi
->
s_öodes_≥r_group
);

4126 
Áûed_mou¡
;

4128 
sbi
->
s_ôb_≥r_group
 = sbi->
s_öodes_≥r_group
 /

4129 
sbi
->
s_öodes_≥r_block
;

4130 
sbi
->
s_desc_≥r_block
 = 
blocksize
 / 
	`PXT4_DESC_SIZE
(
sb
);

4131 
sbi
->
s_sbh
 = 
bh
;

4132 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

4133 
sbi
->
s_addr_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_ADDR_PER_BLOCK
(
sb
));

4134 
sbi
->
s_desc_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_DESC_PER_BLOCK
(
sb
));

4136 
i
 = 0; i < 4; i++)

4137 
sbi
->
s_hash_£ed
[
i
] = 
	`À32_to_˝u
(
es
->s_hash_seed[i]);

4138 
sbi
->
s_def_hash_vîsi⁄
 = 
es
->s_def_hash_version;

4139 i‡(
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

4140 
i
 = 
	`À32_to_˝u
(
es
->
s_Êags
);

4141 i‡(
i
 & 
PXT2_FLAGS_UNSIGNED_HASH
)

4142 
sbi
->
s_hash_unsig√d
 = 3;

4143 i‡((
i
 & 
PXT2_FLAGS_SIGNED_HASH
) == 0) {

4144 #ifde‡
__CHAR_UNSIGNED__


4145 i‡(!
	`sb_rd⁄ly
(
sb
))

4146 
es
->
s_Êags
 |=

4147 
	`˝u_to_À32
(
PXT2_FLAGS_UNSIGNED_HASH
);

4148 
sbi
->
s_hash_unsig√d
 = 3;

4150 i‡(!
	`sb_rd⁄ly
(
sb
))

4151 
es
->
s_Êags
 |=

4152 
	`˝u_to_À32
(
PXT2_FLAGS_SIGNED_HASH
);

4158 
˛u°îsize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
);

4159 
has_bigÆloc
 = 
	`pxt4_has_„©uª_bigÆloc
(
sb
);

4160 i‡(
has_bigÆloc
) {

4161 i‡(
˛u°îsize
 < 
blocksize
) {

4162 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4164 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4165 
Áûed_mou¡
;

4167 
sbi
->
s_˛u°î_bôs
 = 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) -

4168 
	`À32_to_˝u
(
es
->
s_log_block_size
);

4169 
sbi
->
s_˛u°îs_≥r_group
 =

4170 
	`À32_to_˝u
(
es
->
s_˛u°îs_≥r_group
);

4171 i‡(
sbi
->
s_˛u°îs_≥r_group
 > 
blocksize
 * 8) {

4172 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4174 
sbi
->
s_˛u°îs_≥r_group
);

4175 
Áûed_mou¡
;

4177 i‡(
sbi
->
s_blocks_≥r_group
 !=

4178 (
sbi
->
s_˛u°îs_≥r_group
 * (
˛u°îsize
 / 
blocksize
))) {

4179 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksÖer group (%lu)ánd "

4181 
sbi
->
s_blocks_≥r_group
,

4182 
sbi
->
s_˛u°îs_≥r_group
);

4183 
Áûed_mou¡
;

4186 i‡(
˛u°îsize
 !
blocksize
) {

4187 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4189 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4190 
Áûed_mou¡
;

4192 i‡(
sbi
->
s_blocks_≥r_group
 > 
blocksize
 * 8) {

4193 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4195 
sbi
->
s_blocks_≥r_group
);

4196 
Áûed_mou¡
;

4198 
sbi
->
s_˛u°îs_≥r_group
 = sbi->
s_blocks_≥r_group
;

4199 
sbi
->
s_˛u°î_bôs
 = 0;

4201 
sbi
->
s_˛u°î_øtio
 = 
˛u°îsize
 / 
blocksize
;

4204 i‡(
sbi
->
s_blocks_≥r_group
 =
˛u°îsize
 << 3)

4205 
	`£t_›t2
(
sb
, 
STD_GROUP_SIZE
);

4211 
îr
 = 
	`gíîic_check_addªsßbÀ
(
sb
->
s_blocksize_bôs
,

4212 
	`pxt4_blocks_cou¡
(
es
));

4213 i‡(
îr
) {

4214 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem"

4216 
Áûed_mou¡
;

4219 i‡(
	`PXT4_BLOCKS_PER_GROUP
(
sb
) == 0)

4220 
ˇ¡föd_pxt4
;

4223 
blocks_cou¡
 = 
sb
->
s_bdev
->
bd_öode
->
i_size
 >> sb->
s_blocksize_bôs
;

4224 i‡(
blocks_cou¡
 && 
	`pxt4_blocks_cou¡
(
es
) > blocks_count) {

4225 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: block count %llu "

4227 
	`pxt4_blocks_cou¡
(
es
), 
blocks_cou¡
);

4228 
Áûed_mou¡
;

4235 i‡(
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
Ë>
	`pxt4_blocks_cou¡
(es)) {

4236 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4238 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4239 
	`pxt4_blocks_cou¡
(
es
));

4240 
Áûed_mou¡
;

4242 i‡((
es
->
s_fú°_d©a_block
 =0Ë&& (es->
s_log_block_size
 == 0) &&

4243 (
sbi
->
s_˛u°î_øtio
 == 1)) {

4244 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4246 
Áûed_mou¡
;

4249 
blocks_cou¡
 = (
	`pxt4_blocks_cou¡
(
es
) -

4250 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) +

4251 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

4252 
	`do_div
(
blocks_cou¡
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4253 i‡(
blocks_cou¡
 > ((
uöt64_t
)1<<32Ë- 
	`PXT4_DESC_PER_BLOCK
(
sb
)) {

4254 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "groups countÅooÜarge: %llu "

4256 "block†≥∏grou∞%lu)", 
blocks_cou¡
,

4257 
	`pxt4_blocks_cou¡
(
es
),

4258 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4259 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4260 
Áûed_mou¡
;

4262 
sbi
->
s_groups_cou¡
 = 
blocks_cou¡
;

4263 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

4264 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

4265 i‡(((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
) !=

4266 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

4267 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "inodes countÇot valid: %u vs %llu",

4268 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
),

4269 ((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
));

4270 
ªt
 = -
EINVAL
;

4271 
Áûed_mou¡
;

4273 
db_cou¡
 = (
sbi
->
s_groups_cou¡
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) /

4274 
	`PXT4_DESC_PER_BLOCK
(
sb
);

4275 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
)) {

4276 i‡(
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
Ë> 
db_cou¡
) {

4277 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4280 
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
), 
db_cou¡
);

4281 
Áûed_mou¡
;

4284 
	`rcu_assign_poöãr
(
sbi
->
s_group_desc
,

4285 
	`kvmÆloc_¨øy
(
db_cou¡
,

4286 (
buf„r_hód
 *),

4287 
GFP_KERNEL
));

4288 i‡(
sbi
->
s_group_desc
 =
NULL
) {

4289 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "notÉnough memory");

4290 
ªt
 = -
ENOMEM
;

4291 
Áûed_mou¡
;

4294 
	`bgl_lock_öô
(
sbi
->
s_blockgroup_lock
);

4297 
i
 = 0; i < 
db_cou¡
; i++) {

4298 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4299 
	`sb_bªadahód_unmovabÀ
(
sb
, 
block
);

4302 
i
 = 0; i < 
db_cou¡
; i++) {

4303 
buf„r_hód
 *
bh
;

4305 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4306 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
block
);

4307 i‡(!
bh
) {

4308 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4309 "ˇn'àªad grou∞des¸ùt‹ %d", 
i
);

4310 
db_cou¡
 = 
i
;

4311 
Áûed_mou¡2
;

4313 
	`rcu_ªad_lock
();

4314 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
)[
i
] = 
bh
;

4315 
	`rcu_ªad_u∆ock
();

4317 
sbi
->
s_gdb_cou¡
 = 
db_cou¡
;

4318 i‡(!
	`pxt4_check_des¸ùt‹s
(
sb
, 
logiˇl_sb_block
, &
fú°_nŸ_zî€d
)) {

4319 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "group descriptors corrupted!");

4320 
ªt
 = -
EFSCORRUPTED
;

4321 
Áûed_mou¡2
;

4324 
	`timî_£tup
(&
sbi
->
s_îr_ªp‹t
, 
¥öt_daûy_îr‹_öfo
, 0);

4327 i‡(
	`pxt4_es_ªgi°î_shrökî
(
sbi
))

4328 
Áûed_mou¡3
;

4330 
sbi
->
s_°rùe
 = 
	`pxt4_gë_°rùe_size
(sbi);

4331 
sbi
->
s_exã¡_max_zîoout_kb
 = 32;

4336 
sb
->
s_›
 = &
pxt4_s›s
;

4337 
sb
->
s_exp‹t_›
 = &
pxt4_exp‹t_›s
;

4338 
sb
->
s_x©å
 = 
pxt4_x©å_h™dÀrs
;

4339 #ifde‡
CONFIG_FS_ENCRYPTION


4340 
sb
->
s_c›
 = &
pxt4_¸y±›s
;

4342 #ifde‡
CONFIG_FS_VERITY


4343 
sb
->
s_v›
 = &
pxt4_vîôy›s
;

4345 #ifde‡
CONFIG_QUOTA


4346 
sb
->
dq_›
 = &
pxt4_quŸa_›î©i⁄s
;

4347 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
))

4348 
sb
->
s_qc›
 = &
dquŸ_quŸa˘l_sysfûe_›s
;

4350 
sb
->
s_qc›
 = &
pxt4_q˘l_›î©i⁄s
;

4351 
sb
->
s_quŸa_ty≥s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

4353 
	`mem˝y
(&
sb
->
s_uuid
, 
es
->s_uuid, (es->s_uuid));

4355 
	`INIT_LIST_HEAD
(&
sbi
->
s_‹ph™
);

4356 
	`muãx_öô
(&
sbi
->
s_‹ph™_lock
);

4358 
sb
->
s_roŸ
 = 
NULL
;

4360 
√eds_ªcovîy
 = (
es
->
s_œ°_‹ph™
 != 0 ||

4361 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
));

4363 i‡(
	`pxt4_has_„©uª_mmp
(
sb
Ë&& !
	`sb_rd⁄ly
(sb))

4364 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
, 
	`À64_to_˝u
(
es
->
s_mmp_block
)))

4365 
Áûed_mou¡3a
;

4371 i‡(!
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb)) {

4372 
îr
 = 
	`pxt4_lﬂd_jou∫Æ
(
sb
, 
es
, 
jou∫Æ_devnum
);

4373 i‡(
îr
)

4374 
Áûed_mou¡3a
;

4375 } i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& !
	`sb_rd⁄ly
(sb) &&

4376 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4377 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "required journalÑecovery "

4379 
Áûed_mou¡_wq
;

4382 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
)) {

4383 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4385 
Áûed_mou¡_wq
;

4387 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4388 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4390 
Áûed_mou¡_wq
;

4392 i‡(
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
) {

4393 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4395 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

4396 
Áûed_mou¡_wq
;

4398 i‡(
PXT4_MOUNT_DATA_FLAGS
 &

4399 (
sbi
->
s_mou¡_›t
 ^ sbi->
s_def_mou¡_›t
)) {

4400 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4402 
Áûed_mou¡_wq
;

4404 
sbi
->
s_def_mou¡_›t
 &~
PXT4_MOUNT_JOURNAL_CHECKSUM
;

4405 
	`˛ór_›t
(
sb
, 
JOURNAL_CHECKSUM
);

4406 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

4407 
sbi
->
s_jou∫Æ
 = 
NULL
;

4408 
√eds_ªcovîy
 = 0;

4409 
no_jou∫Æ
;

4412 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

4413 !
	`jbd3_jou∫Æ_£t_„©uªs
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, 0, 0,

4414 
JBD3_FEATURE_INCOMPAT_64BIT
)) {

4415 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set 64-bit journal feature");

4416 
Áûed_mou¡_wq
;

4419 i‡(!
	`£t_jou∫Æ_csum_„©uª_£t
(
sb
)) {

4420 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set journal checksum "

4422 
Áûed_mou¡_wq
;

4427 
	`ã°_›t
(
sb
, 
DATA_FLAGS
)) {

4433 i‡(
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4434 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4435 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

4436 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_ORDERED_DATA
;

4438 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

4439 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_JOURNAL_DATA
;

4443 
PXT4_MOUNT_ORDERED_DATA
:

4444 
PXT4_MOUNT_WRITEBACK_DATA
:

4445 i‡(!
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4446 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4447 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Journal doesÇot support "

4449 
Áûed_mou¡_wq
;

4455 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
 &&

4456 
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4457 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4459 
Áûed_mou¡_wq
;

4462 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

4464 
sbi
->
s_jou∫Æ
->
j_commô_ˇŒback
 = 
pxt4_jou∫Æ_commô_ˇŒback
;

4466 
no_jou∫Æ
:

4467 i‡(!
	`ã°_›t
(
sb
, 
NO_MBCACHE
)) {

4468 
sbi
->
s_ó_block_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4469 i‡(!
sbi
->
s_ó_block_ˇche
) {

4470 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4472 
Áûed_mou¡_wq
;

4475 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

4476 
sbi
->
s_ó_öode_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4477 i‡(!
sbi
->
s_ó_öode_ˇche
) {

4478 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4480 
Áûed_mou¡_wq
;

4485 i‡((
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë|| 
	`pxt4_has_„©uª_í¸y±
(
sb
)) &&

4486 (
blocksize
 !
PAGE_SIZE
)) {

4487 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4489 
Áûed_mou¡_wq
;

4492 i‡(
	`pxt4_has_„©uª_vîôy
(
sb
Ë&& 
blocksize
 !
PAGE_SIZE
) {

4493 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unsupported blocksize for fs-verity");

4494 
Áûed_mou¡_wq
;

4497 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë&& !
	`sb_rd⁄ly
(
sb
) &&

4498 !
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

4499 
	`pxt4_£t_„©uª_í¸y±
(
sb
);

4500 
	`pxt4_commô_su≥r
(
sb
, 1);

4507 i‡(
es
->
s_ovîhód_˛u°îs
)

4508 
sbi
->
s_ovîhód
 = 
	`À32_to_˝u
(
es
->
s_ovîhód_˛u°îs
);

4510 
îr
 = 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

4511 i‡(
îr
)

4512 
Áûed_mou¡_wq
;

4519 
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
 =

4520 
	`Æloc_w‹kqueue
("pxt4-rsv-c⁄vîsi⁄", 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

4521 i‡(!
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
) {

4522 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: failedÅo create workqueue\n");

4523 
ªt
 = -
ENOMEM
;

4524 
Áûed_mou¡4
;

4532 
roŸ
 = 
	`pxt4_igë
(
sb
, 
PXT4_ROOT_INO
, 
PXT4_IGET_SPECIAL
);

4533 i‡(
	`IS_ERR
(
roŸ
)) {

4534 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot inode failed");

4535 
ªt
 = 
	`PTR_ERR
(
roŸ
);

4536 
roŸ
 = 
NULL
;

4537 
Áûed_mou¡4
;

4539 i‡(!
	`S_ISDIR
(
roŸ
->
i_mode
Ë|| !roŸ->
i_blocks
 || !roŸ->
i_size
) {

4540 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "corruptÑoot inode,ÑunÉ2fsck");

4541 
	`ùut
(
roŸ
);

4542 
Áûed_mou¡4
;

4545 #ifde‡
CONFIG_UNICODE


4546 i‡(
sbi
->
s_ícodög
)

4547 
sb
->
s_d_›
 = &
pxt4_díåy_›s
;

4550 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
roŸ
);

4551 i‡(!
sb
->
s_roŸ
) {

4552 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot dentry failed");

4553 
ªt
 = -
ENOMEM
;

4554 
Áûed_mou¡4
;

4557 
ªt
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 
	`sb_rd⁄ly
(sb));

4558 i‡(
ªt
 =-
EROFS
) {

4559 
sb
->
s_Êags
 |
SB_RDONLY
;

4560 
ªt
 = 0;

4561 } i‡(
ªt
)

4562 
Áûed_mou¡4a
;

4564 
	`pxt4_£t_ªsv_˛u°îs
(
sb
);

4566 i‡(
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
)) {

4567 
îr
 = 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

4568 i‡(
îr
) {

4569 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize system "

4570 "z⁄ê(%d)", 
îr
);

4571 
Áûed_mou¡4a
;

4575 
	`pxt4_ext_öô
(
sb
);

4576 
îr
 = 
	`pxt4_mb_öô
(
sb
);

4577 i‡(
îr
) {

4578 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize mballoc (%d)",

4579 
îr
);

4580 
Áûed_mou¡5
;

4583 
block
 = 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
);

4584 
	`pxt4_‰ì_blocks_cou¡_£t
(
sbi
->
s_es
,

4585 
	`PXT4_C2B
(
sbi
, 
block
));

4586 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4587 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
block
,

4588 
GFP_KERNEL
);

4589 i‡(!
îr
) {

4590 
‰ìi
 = 
	`pxt4_cou¡_‰ì_öodes
(
sb
);

4591 
sbi
->
s_es
->
s_‰ì_öodes_cou¡
 = 
	`˝u_to_À32
(
‰ìi
);

4592 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4593 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ìöodes_cou¡î
, 
‰ìi
,

4594 
GFP_KERNEL
);

4596 i‡(!
îr
)

4597 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dús_cou¡î
,

4598 
	`pxt4_cou¡_dús
(
sb
), 
GFP_KERNEL
);

4599 i‡(!
îr
)

4600 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 0,

4601 
GFP_KERNEL
);

4602 i‡(!
îr
)

4603 
îr
 = 
	`≥r˝u_öô_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

4605 i‡(
îr
) {

4606 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "insufficient memory");

4607 
Áûed_mou¡6
;

4610 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

4611 i‡(!
	`pxt4_fûl_Êex_öfo
(
sb
)) {

4612 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4615 
Áûed_mou¡6
;

4618 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

4619 i‡(
îr
)

4620 
Áûed_mou¡6
;

4622 
îr
 = 
	`pxt4_ªgi°î_sysfs
(
sb
);

4623 i‡(
îr
)

4624 
Áûed_mou¡7
;

4626 #ifde‡
CONFIG_QUOTA


4628 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& !
	`sb_rd⁄ly
(sb)) {

4629 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

4630 i‡(
îr
)

4631 
Áûed_mou¡8
;

4635 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ORPHAN_FS
;

4636 
	`pxt4_‹ph™_˛ónup
(
sb
, 
es
);

4637 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 &~
PXT4_ORPHAN_FS
;

4638 i‡(
√eds_ªcovîy
) {

4639 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "recovery complete");

4640 
îr
 = 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

4641 i‡(
îr
)

4642 
Áûed_mou¡8
;

4644 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

4645 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

4646 
des¸
 = " journalled data mode";

4647 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

4648 
des¸
 = " ordered data mode";

4650 
des¸
 = " writeback data mode";

4652 
des¸
 = "out journal";

4654 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4655 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

4656 i‡(!
	`blk_queue_disˇrd
(
q
))

4657 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4662 i‡(
	`___øãlimô
(&
pxt4_mou¡_msg_øãlimô
, "PXT4-fs mount"))

4663 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mounted filesystem with%s. "

4664 "O±s: %.*s%s%s", 
des¸
,

4665 (Ë(
sbi
->
s_es
->
s_mou¡_›ts
),

4666 
sbi
->
s_es
->
s_mou¡_›ts
,

4667 *
sbi
->
s_es
->
s_mou¡_›ts
 ? "; " : "", 
‹ig_d©a
);

4669 i‡(
es
->
s_îr‹_cou¡
)

4670 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 300*
HZ
);

4673 
	`øãlimô_°©e_öô
(&
sbi
->
s_îr_øãlimô_°©e
, 5 * 
HZ
, 10);

4674 
	`øãlimô_°©e_öô
(&
sbi
->
s_w¨nög_øãlimô_°©e
, 5 * 
HZ
, 10);

4675 
	`øãlimô_°©e_öô
(&
sbi
->
s_msg_øãlimô_°©e
, 5 * 
HZ
, 10);

4677 
	`k‰ì
(
‹ig_d©a
);

4680 
ˇ¡föd_pxt4
:

4681 i‡(!
sûít
)

4682 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: Can't findÖxt4 filesystem");

4683 
Áûed_mou¡
;

4685 
Áûed_mou¡8
:

4686 
	`pxt4_uƒegi°î_sysfs
(
sb
);

4687 
Áûed_mou¡7
:

4688 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

4689 
Áûed_mou¡6
:

4690 
	`pxt4_mb_ªÀa£
(
sb
);

4691 
	`rcu_ªad_lock
();

4692 
Êex_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

4693 i‡(
Êex_groups
) {

4694 
i
 = 0; i < 
sbi
->
s_Êex_groups_Æloˇãd
; i++)

4695 
	`kv‰ì
(
Êex_groups
[
i
]);

4696 
	`kv‰ì
(
Êex_groups
);

4698 
	`rcu_ªad_u∆ock
();

4699 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

4700 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

4701 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

4702 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

4703 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

4704 
Áûed_mou¡5
:

4705 
	`pxt4_ext_ªÀa£
(
sb
);

4706 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

4707 
Áûed_mou¡4a
:

4708 
	`dput
(
sb
->
s_roŸ
);

4709 
sb
->
s_roŸ
 = 
NULL
;

4710 
Áûed_mou¡4
:

4711 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "mount failed");

4712 i‡(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
)

4713 
	`de°roy_w‹kqueue
(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
);

4714 
Áûed_mou¡_wq
:

4715 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

4716 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

4718 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

4719 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

4721 i‡(
sbi
->
s_jou∫Æ
) {

4722 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

4723 
sbi
->
s_jou∫Æ
 = 
NULL
;

4725 
Áûed_mou¡3a
:

4726 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

4727 
Áûed_mou¡3
:

4728 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

4729 i‡(
sbi
->
s_mmp_tsk
)

4730 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

4731 
Áûed_mou¡2
:

4732 
	`rcu_ªad_lock
();

4733 
group_desc
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
);

4734 
i
 = 0; i < 
db_cou¡
; i++)

4735 
	`bªl£
(
group_desc
[
i
]);

4736 
	`kv‰ì
(
group_desc
);

4737 
	`rcu_ªad_u∆ock
();

4738 
Áûed_mou¡
:

4739 i‡(
sbi
->
s_chksum_drivî
)

4740 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

4742 #ifde‡
CONFIG_UNICODE


4743 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

4746 #ifde‡
CONFIG_QUOTA


4747 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

4748 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

4750 
	`pxt4_blkdev_ªmove
(
sbi
);

4751 
	`bªl£
(
bh
);

4752 
out_Áû
:

4753 
sb
->
s_fs_öfo
 = 
NULL
;

4754 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

4755 
out_‰ì_ba£
:

4756 
	`k‰ì
(
sbi
);

4757 
	`k‰ì
(
‹ig_d©a
);

4758 
	`fs_put_dax
(
dax_dev
);

4759  
îr
 ?Éº : 
ªt
;

4760 
	}
}

4767 
	$pxt4_öô_jou∫Æ_∑øms
(
su≥r_block
 *
sb
, 
jou∫Æ_t
 *
jou∫Æ
)

4769 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4771 
jou∫Æ
->
j_commô_öãrvÆ
 = 
sbi
->
s_commô_öãrvÆ
;

4772 
jou∫Æ
->
j_mö_b©ch_time
 = 
sbi
->
s_mö_b©ch_time
;

4773 
jou∫Æ
->
j_max_b©ch_time
 = 
sbi
->
s_max_b©ch_time
;

4775 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

4776 i‡(
	`ã°_›t
(
sb
, 
BARRIER
))

4777 
jou∫Æ
->
j_Êags
 |
JBD3_BARRIER
;

4779 
jou∫Æ
->
j_Êags
 &~
JBD3_BARRIER
;

4780 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

4781 
jou∫Æ
->
j_Êags
 |
JBD3_ABORT_ON_SYNCDATA_ERR
;

4783 
jou∫Æ
->
j_Êags
 &~
JBD3_ABORT_ON_SYNCDATA_ERR
;

4784 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4785 
	}
}

4787 
öode
 *
	$pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

4788 
jou∫Æ_öum
)

4790 
öode
 *
jou∫Æ_öode
;

4797 
jou∫Æ_öode
 = 
	`pxt4_igë
(
sb
, 
jou∫Æ_öum
, 
PXT4_IGET_SPECIAL
);

4798 i‡(
	`IS_ERR
(
jou∫Æ_öode
)) {

4799 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "no journal found");

4800  
NULL
;

4802 i‡(!
jou∫Æ_öode
->
i_∆ök
) {

4803 
	`make_bad_öode
(
jou∫Æ_öode
);

4804 
	`ùut
(
jou∫Æ_öode
);

4805 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal inode is deleted");

4806  
NULL
;

4809 
	`jbd_debug
(2, "Journal inode foundát %p: %lld bytes\n",

4810 
jou∫Æ_öode
, jou∫Æ_öode->
i_size
);

4811 i‡(!
	`S_ISREG
(
jou∫Æ_öode
->
i_mode
)) {

4812 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid journal inode");

4813 
	`ùut
(
jou∫Æ_öode
);

4814  
NULL
;

4816  
jou∫Æ_öode
;

4817 
	}
}

4819 
jou∫Æ_t
 *
	$pxt4_gë_jou∫Æ
(
su≥r_block
 *
sb
,

4820 
jou∫Æ_öum
)

4822 
öode
 *
jou∫Æ_öode
;

4823 
jou∫Æ_t
 *
jou∫Æ
;

4825 i‡(
	`WARN_ON_ONCE
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)))

4826  
NULL
;

4828 
jou∫Æ_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
jou∫Æ_öum
);

4829 i‡(!
jou∫Æ_öode
)

4830  
NULL
;

4832 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_öode
(
jou∫Æ_öode
);

4833 i‡(!
jou∫Æ
) {

4834 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CouldÇotÜoad journal inode");

4835 
	`ùut
(
jou∫Æ_öode
);

4836  
NULL
;

4838 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4839 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4840  
jou∫Æ
;

4841 
	}
}

4843 
jou∫Æ_t
 *
	$pxt4_gë_dev_jou∫Æ
(
su≥r_block
 *
sb
,

4844 
dev_t
 
j_dev
)

4846 
buf„r_hód
 *
bh
;

4847 
jou∫Æ_t
 *
jou∫Æ
;

4848 
pxt4_fsblk_t
 
°¨t
;

4849 
pxt4_fsblk_t
 
Àn
;

4850 
hblock
, 
blocksize
;

4851 
pxt4_fsblk_t
 
sb_block
;

4852 
off£t
;

4853 
pxt4_su≥r_block
 *
es
;

4854 
block_devi˚
 *
bdev
;

4856 i‡(
	`WARN_ON_ONCE
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)))

4857  
NULL
;

4859 
bdev
 = 
	`pxt4_blkdev_gë
(
j_dev
, 
sb
);

4860 i‡(
bdev
 =
NULL
)

4861  
NULL
;

4863 
blocksize
 = 
sb
->
s_blocksize
;

4864 
hblock
 = 
	`bdev_logiˇl_block_size
(
bdev
);

4865 i‡(
blocksize
 < 
hblock
) {

4866 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4868 
out_bdev
;

4871 
sb_block
 = 
PXT4_MIN_BLOCK_SIZE
 / 
blocksize
;

4872 
off£t
 = 
PXT4_MIN_BLOCK_SIZE
 % 
blocksize
;

4873 
	`£t_blocksize
(
bdev
, 
blocksize
);

4874 i‡(!(
bh
 = 
	`__bªad
(
bdev
, 
sb_block
, 
blocksize
))) {

4875 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn'tÑead superblock of "

4877 
out_bdev
;

4880 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

4881 i‡((
	`À16_to_˝u
(
es
->
s_magic
Ë!
PXT4_SUPER_MAGIC
) ||

4882 !(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

4883 
PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
)) {

4884 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4886 
	`bªl£
(
bh
);

4887 
out_bdev
;

4890 i‡((
	`À32_to_˝u
(
es
->
s_„©uª_ro_com∑t
) &

4891 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
) &&

4892 
es
->
s_checksum
 !
	`pxt4_su≥rblock_csum
(
sb
,És)) {

4893 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4895 
	`bªl£
(
bh
);

4896 
out_bdev
;

4899 i‡(
	`memcmp
(
	`PXT4_SB
(
sb
)->
s_es
->
s_jou∫Æ_uuid
, 
es
->
s_uuid
, 16)) {

4900 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal UUID doesÇot match");

4901 
	`bªl£
(
bh
);

4902 
out_bdev
;

4905 
Àn
 = 
	`pxt4_blocks_cou¡
(
es
);

4906 
°¨t
 = 
sb_block
 + 1;

4907 
	`bªl£
(
bh
);

4909 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_dev
(
bdev
, 
sb
->
s_bdev
,

4910 
°¨t
, 
Àn
, 
blocksize
);

4911 i‡(!
jou∫Æ
) {

4912 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo create device journal");

4913 
out_bdev
;

4915 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4916 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
jou∫Æ
->
j_sb_buf„r
);

4917 
	`waô_⁄_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

4918 i‡(!
	`buf„r_u±od©e
(
jou∫Æ
->
j_sb_buf„r
)) {

4919 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror on journal device");

4920 
out_jou∫Æ
;

4922 i‡(
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
) != 1) {

4923 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "External journal has moreÅhan one "

4925 
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
));

4926 
out_jou∫Æ
;

4928 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 = 
bdev
;

4929 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4930  
jou∫Æ
;

4932 
out_jou∫Æ
:

4933 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4934 
out_bdev
:

4935 
	`pxt4_blkdev_put
(
bdev
);

4936  
NULL
;

4937 
	}
}

4939 
	$pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *
sb
,

4940 
pxt4_su≥r_block
 *
es
,

4941 
jou∫Æ_devnum
)

4943 
jou∫Æ_t
 *
jou∫Æ
;

4944 
jou∫Æ_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

4945 
dev_t
 
jou∫Æ_dev
;

4946 
îr
 = 0;

4947 
ªÆly_ªad_⁄ly
;

4948 
jou∫Æ_dev_ro
;

4950 i‡(
	`WARN_ON_ONCE
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)))

4951  -
EFSCORRUPTED
;

4953 i‡(
jou∫Æ_devnum
 &&

4954 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

4955 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "external journal device major/minor "

4957 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
jou∫Æ_devnum
);

4959 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
));

4961 i‡(
jou∫Æ_öum
 && 
jou∫Æ_dev
) {

4962 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4964  -
EINVAL
;

4967 i‡(
jou∫Æ_öum
) {

4968 
jou∫Æ
 = 
	`pxt4_gë_jou∫Æ
(
sb
, 
jou∫Æ_öum
);

4969 i‡(!
jou∫Æ
)

4970  -
EINVAL
;

4972 
jou∫Æ
 = 
	`pxt4_gë_dev_jou∫Æ
(
sb
, 
jou∫Æ_dev
);

4973 i‡(!
jou∫Æ
)

4974  -
EINVAL
;

4977 
jou∫Æ_dev_ro
 = 
	`bdev_ªad_⁄ly
(
jou∫Æ
->
j_dev
);

4978 
ªÆly_ªad_⁄ly
 = 
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
Ë| 
jou∫Æ_dev_ro
;

4980 i‡(
jou∫Æ_dev_ro
 && !
	`sb_rd⁄ly
(
sb
)) {

4981 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4983 
îr
 = -
EROFS
;

4984 
îr_out
;

4992 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4993 i‡(
	`sb_rd⁄ly
(
sb
)) {

4994 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "INFO:Ñecovery "

4996 i‡(
ªÆly_ªad_⁄ly
) {

4997 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

5000 
îr
 = -
EROFS
;

5001 
îr_out
;

5003 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "writeáccess will "

5008 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

5009 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "barriers disabled");

5011 i‡(!
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
))

5012 
îr
 = 
	`jbd3_jou∫Æ_wùe
(
jou∫Æ
, !
ªÆly_ªad_⁄ly
);

5013 i‡(!
îr
) {

5014 *
ßve
 = 
	`kmÆloc
(
PXT4_S_ERR_LEN
, 
GFP_KERNEL
);

5015 i‡(
ßve
)

5016 
	`mem˝y
(
ßve
, ((*Ë
es
) +

5017 
PXT4_S_ERR_START
, 
PXT4_S_ERR_LEN
);

5018 
îr
 = 
	`jbd3_jou∫Æ_lﬂd
(
jou∫Æ
);

5019 i‡(
ßve
)

5020 
	`mem˝y
(((*Ë
es
Ë+ 
PXT4_S_ERR_START
,

5021 
ßve
, 
PXT4_S_ERR_LEN
);

5022 
	`k‰ì
(
ßve
);

5025 i‡(
îr
) {

5026 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "errorÜoading journal");

5027 
îr_out
;

5030 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 = 
jou∫Æ
;

5031 
îr
 = 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5032 i‡(
îr
) {

5033 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 = 
NULL
;

5034 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

5035  
îr
;

5038 i‡(!
ªÆly_ªad_⁄ly
 && 
jou∫Æ_devnum
 &&

5039 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

5040 
es
->
s_jou∫Æ_dev
 = 
	`˝u_to_À32
(
jou∫Æ_devnum
);

5043 
	`pxt4_commô_su≥r
(
sb
, 1);

5048 
îr_out
:

5049 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

5050  
îr
;

5051 
	}
}

5053 
	$pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
)

5055 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

5056 
buf„r_hód
 *
sbh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

5057 
îr‹
 = 0;

5059 i‡(!
sbh
 || 
	`block_devi˚_eje˘ed
(
sb
))

5060  
îr‹
;

5072 i‡(!(
sb
->
s_Êags
 & 
SB_RDONLY
))

5073 
	`pxt4_upd©e_t°amp
(
es
, 
s_wtime
);

5074 i‡(
sb
->
s_bdev
->
bd_∑π
)

5075 
es
->
s_kbyãs_wrôãn
 =

5076 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
 +

5077 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

5078 
£˘‹s
[
STAT_WRITE
]) -

5079 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1));

5081 
es
->
s_kbyãs_wrôãn
 =

5082 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
);

5083 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
))

5084 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
,

5085 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
	`≥r˝u_cou¡î_sum_posôive
(

5086 &
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
)));

5087 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
))

5088 
es
->
s_‰ì_öodes_cou¡
 =

5089 
	`˝u_to_À32
(
	`≥r˝u_cou¡î_sum_posôive
(

5090 &
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
));

5091 
	`BUFFER_TRACE
(
sbh
, "marking dirty");

5092 
	`pxt4_su≥rblock_csum_£t
(
sb
);

5093 i‡(
sync
)

5094 
	`lock_buf„r
(
sbh
);

5095 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
Ë|| !
	`buf„r_u±od©e
(sbh)) {

5104 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "previous I/OÉrrorÅo "

5106 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5107 
	`£t_buf„r_u±od©e
(
sbh
);

5109 
	`m¨k_buf„r_dúty
(
sbh
);

5110 i‡(
sync
) {

5111 
	`u∆ock_buf„r
(
sbh
);

5112 
îr‹
 = 
	`__sync_dúty_buf„r
(
sbh
,

5113 
REQ_SYNC
 | (
	`ã°_›t
(
sb
, 
BARRIER
Ë? 
REQ_FUA
 : 0));

5114 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
)) {

5115 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror while writing "

5117 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5118 
	`£t_buf„r_u±od©e
(
sbh
);

5121  
îr‹
;

5122 
	}
}

5129 
	$pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

5130 
pxt4_su≥r_block
 *
es
)

5132 
îr
;

5133 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5135 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)) {

5136 i‡(
jou∫Æ
 !
NULL
) {

5137 
	`pxt4_îr‹
(
sb
, "Journal gotÑemoved whileÅhe fs was "

5139  -
EFSCORRUPTED
;

5143 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5144 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5145 i‡(
îr
 < 0)

5146 
out
;

5148 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
Ë&& 
	`sb_rd⁄ly
(sb)) {

5149 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5150 
	`pxt4_commô_su≥r
(
sb
, 1);

5152 
out
:

5153 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5154  
îr
;

5155 
	}
}

5162 
	$pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

5163 
pxt4_su≥r_block
 *
es
)

5165 
jou∫Æ_t
 *
jou∫Æ
;

5166 
j_î∫o
;

5167 c⁄° *
îr°r
;

5169 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)) {

5170 
	`pxt4_îr‹
(
sb
, "Journal gotÑemoved whileÅhe fs was mounted!");

5171  -
EFSCORRUPTED
;

5174 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5181 
j_î∫o
 = 
	`jbd3_jou∫Æ_î∫o
(
jou∫Æ
);

5182 i‡(
j_î∫o
) {

5183 
nbuf
[16];

5185 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
j_î∫o
, 
nbuf
);

5186 
	`pxt4_w¨nög
(
sb
, "FilesystemÉrrorÑecorded "

5187 "‰omÖªviou†mou¡: %s", 
îr°r
);

5188 
	`pxt4_w¨nög
(
sb
, "Marking fs inÇeed of filesystem check.");

5190 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

5191 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

5192 
	`pxt4_commô_su≥r
(
sb
, 1);

5194 
	`jbd3_jou∫Æ_˛ór_îr
(
jou∫Æ
);

5195 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

5198 
	}
}

5204 
	$pxt4_f‹˚_commô
(
su≥r_block
 *
sb
)

5206 
jou∫Æ_t
 *
jou∫Æ
;

5208 i‡(
	`sb_rd⁄ly
(
sb
))

5211 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5212  
	`pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

5213 
	}
}

5215 
	$pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
)

5217 
ªt
 = 0;

5218 
tid_t
 
èrgë
;

5219 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

5220 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5222 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

5225 
	`åa˚_pxt4_sync_fs
(
sb
, 
waô
);

5226 
	`Êush_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

5231 
	`dquŸ_wrôeback_dquŸs
(
sb
, -1);

5237 i‡(
sbi
->
s_jou∫Æ
) {

5238 
èrgë
 = 
	`jbd3_gë_œã°_å™ß˘i⁄
(
sbi
->
s_jou∫Æ
);

5239 i‡(
waô
 && 
sbi
->
s_jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

5240 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
sbi
->
s_jou∫Æ
, 
èrgë
))

5241 
√eds_b¨rõr
 = 
åue
;

5243 i‡(
	`jbd3_jou∫Æ_°¨t_commô
(
sbi
->
s_jou∫Æ
, &
èrgë
)) {

5244 i‡(
waô
)

5245 
ªt
 = 
	`jbd3_log_waô_commô
(
sbi
->
s_jou∫Æ
,

5246 
èrgë
);

5248 } i‡(
waô
 && 
	`ã°_›t
(
sb
, 
BARRIER
))

5249 
√eds_b¨rõr
 = 
åue
;

5250 i‡(
√eds_b¨rõr
) {

5251 
îr
;

5252 
îr
 = 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

5253 i‡(!
ªt
)

5254 
ªt
 = 
îr
;

5257  
ªt
;

5258 
	}
}

5268 
	$pxt4_‰ìze
(
su≥r_block
 *
sb
)

5270 
îr‹
 = 0;

5271 
jou∫Æ_t
 *
jou∫Æ
;

5273 i‡(
	`sb_rd⁄ly
(
sb
))

5276 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5278 i‡(
jou∫Æ
) {

5280 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5286 
îr‹
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5287 i‡(
îr‹
 < 0)

5288 
out
;

5291 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5294 
îr‹
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5295 
out
:

5296 i‡(
jou∫Æ
)

5298 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5299  
îr‹
;

5300 
	}
}

5306 
	$pxt4_un‰ìze
(
su≥r_block
 *
sb
)

5308 i‡(
	`sb_rd⁄ly
(
sb
Ë|| 
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(sb)))

5311 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

5313 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5316 
	`pxt4_commô_su≥r
(
sb
, 1);

5318 
	}
}

5323 
	spxt4_mou¡_›ti⁄s
 {

5324 
	ms_mou¡_›t
;

5325 
	ms_mou¡_›t2
;

5326 
kuid_t
 
	ms_ªsuid
;

5327 
kgid_t
 
	ms_ªsgid
;

5328 
	ms_commô_öãrvÆ
;

5329 
u32
 
	ms_mö_b©ch_time
, 
	ms_max_b©ch_time
;

5330 #ifde‡
CONFIG_QUOTA


5331 
	ms_jquŸa_fmt
;

5332 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

5336 
	$pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
)

5338 
pxt4_su≥r_block
 *
es
;

5339 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5340 
ﬁd_sb_Êags
, 
vfs_Êags
;

5341 
pxt4_mou¡_›ti⁄s
 
ﬁd_›ts
;

5342 
íabÀ_quŸa
 = 0;

5343 
pxt4_group_t
 
g
;

5344 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

5345 
îr
 = 0;

5346 #ifde‡
CONFIG_QUOTA


5347 
i
, 
j
;

5348 *
to_‰ì
[
PXT4_MAXQUOTAS
];

5350 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

5352 i‡(
d©a
 && !
‹ig_d©a
)

5353  -
ENOMEM
;

5356 
ﬁd_sb_Êags
 = 
sb
->
s_Êags
;

5357 
ﬁd_›ts
.
s_mou¡_›t
 = 
sbi
->s_mount_opt;

5358 
ﬁd_›ts
.
s_mou¡_›t2
 = 
sbi
->s_mount_opt2;

5359 
ﬁd_›ts
.
s_ªsuid
 = 
sbi
->s_resuid;

5360 
ﬁd_›ts
.
s_ªsgid
 = 
sbi
->s_resgid;

5361 
ﬁd_›ts
.
s_commô_öãrvÆ
 = 
sbi
->s_commit_interval;

5362 
ﬁd_›ts
.
s_mö_b©ch_time
 = 
sbi
->s_min_batch_time;

5363 
ﬁd_›ts
.
s_max_b©ch_time
 = 
sbi
->s_max_batch_time;

5364 #ifde‡
CONFIG_QUOTA


5365 
ﬁd_›ts
.
s_jquŸa_fmt
 = 
sbi
->s_jquota_fmt;

5366 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5367 i‡(
sbi
->
s_qf_«mes
[
i
]) {

5368 *
qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
i
);

5370 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
	`k°rdup
(
qf_«me
, 
GFP_KERNEL
);

5371 i‡(!
ﬁd_›ts
.
s_qf_«mes
[
i
]) {

5372 
j
 = 0; j < 
i
; j++)

5373 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
j
]);

5374 
	`k‰ì
(
‹ig_d©a
);

5375  -
ENOMEM
;

5378 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
NULL
;

5380 i‡(
sbi
->
s_jou∫Æ
 && sbi->s_jou∫Æ->
j_èsk
->
io_c⁄ãxt
)

5381 
jou∫Æ_i›rio
 = 
sbi
->
s_jou∫Æ
->
j_èsk
->
io_c⁄ãxt
->
i›rio
;

5388 
vfs_Êags
 = 
SB_LAZYTIME
 | 
SB_I_VERSION
;

5389 
sb
->
s_Êags
 = (sb->s_Êag†& ~
vfs_Êags
Ë| (*
Êags
 & vfs_flags);

5391 i‡(!
	`∑r£_›ti⁄s
(
d©a
, 
sb
, 
NULL
, &
jou∫Æ_i›rio
, 1)) {

5392 
îr
 = -
EINVAL
;

5393 
ª°‹e_›ts
;

5396 i‡((
ﬁd_›ts
.
s_mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) ^

5397 
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

5398 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "changing journal_checksum "

5400 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_JOURNAL_CHECKSUM
;

5403 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

5404 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

5405 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5407 
îr
 = -
EINVAL
;

5408 
ª°‹e_›ts
;

5410 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

5411 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5413 
îr
 = -
EINVAL
;

5414 
ª°‹e_›ts
;

5416 } i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
) {

5417 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

5418 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5420 
îr
 = -
EINVAL
;

5421 
ª°‹e_›ts
;

5425 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_NO_MBCACHE
) {

5426 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tÉnableÇombcache duringÑemount");

5427 
îr
 = -
EINVAL
;

5428 
ª°‹e_›ts
;

5431 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

5432 
	`pxt4_ab‹t
(
sb
, "Abort forced by user");

5434 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

5435 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

5437 
es
 = 
sbi
->
s_es
;

5439 i‡(
sbi
->
s_jou∫Æ
) {

5440 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
sbi
->
s_jou∫Æ
);

5441 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

5444 i‡((
boﬁ
)(*
Êags
 & 
SB_RDONLY
Ë!
	`sb_rd⁄ly
(
sb
)) {

5445 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
) {

5446 
îr
 = -
EROFS
;

5447 
ª°‹e_›ts
;

5450 i‡(*
Êags
 & 
SB_RDONLY
) {

5451 
îr
 = 
	`sync_fûesy°em
(
sb
);

5452 i‡(
îr
 < 0)

5453 
ª°‹e_›ts
;

5454 
îr
 = 
	`dquŸ_su•íd
(
sb
, -1);

5455 i‡(
îr
 < 0)

5456 
ª°‹e_›ts
;

5462 
sb
->
s_Êags
 |
SB_RDONLY
;

5469 i‡(!(
es
->
s_°©e
 & 
	`˝u_to_À16
(
PXT4_VALID_FS
)) &&

5470 (
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

5471 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

5473 i‡(
sbi
->
s_jou∫Æ
) {

5478 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

5480 i‡(
sbi
->
s_mmp_tsk
)

5481 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

5484 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
) ||

5485 !
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

5486 
îr
 = -
EROFS
;

5487 
ª°‹e_›ts
;

5493 
g
 = 0; g < 
sbi
->
s_groups_cou¡
; g++) {

5494 
pxt4_group_desc
 *
gdp
 =

5495 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

5497 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
g
, 
gdp
)) {

5498 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

5500 
g
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, g, 
gdp
)),

5501 
	`À16_to_˝u
(
gdp
->
bg_checksum
));

5502 
îr
 = -
EFSBADCRC
;

5503 
ª°‹e_›ts
;

5512 i‡(
es
->
s_œ°_‹ph™
) {

5513 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Couldn't "

5517 
îr
 = -
EINVAL
;

5518 
ª°‹e_›ts
;

5527 i‡(
sbi
->
s_jou∫Æ
) {

5528 
îr
 = 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5529 i‡(
îr
)

5530 
ª°‹e_›ts
;

5532 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

5534 
îr
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 0);

5535 i‡(
îr
)

5536 
ª°‹e_›ts
;

5538 
sb
->
s_Êags
 &~
SB_RDONLY
;

5539 i‡(
	`pxt4_has_„©uª_mmp
(
sb
))

5540 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
,

5541 
	`À64_to_˝u
(
es
->
s_mmp_block
))) {

5542 
îr
 = -
EROFS
;

5543 
ª°‹e_›ts
;

5545 
íabÀ_quŸa
 = 1;

5553 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`ã°_›t
(sb, 
INIT_INODE_TABLE
))

5554 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

5556 
pxt4_group_t
 
fú°_nŸ_zî€d
;

5557 
fú°_nŸ_zî€d
 = 
	`pxt4_has_unöô_ôabÀ
(
sb
);

5558 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

5566 i‡(
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
Ë&& !
sbi
->
sy°em_blks
) {

5567 
îr
 = 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

5568 i‡(
îr
)

5569 
ª°‹e_›ts
;

5572 i‡(
sbi
->
s_jou∫Æ
 =
NULL
 && !(
ﬁd_sb_Êags
 & 
SB_RDONLY
)) {

5573 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5574 i‡(
îr
)

5575 
ª°‹e_›ts
;

5578 #ifde‡
CONFIG_QUOTA


5580 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5581 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
i
]);

5582 i‡(
íabÀ_quŸa
) {

5583 i‡(
	`sb_™y_quŸa_su•íded
(
sb
))

5584 
	`dquŸ_ªsume
(
sb
, -1);

5585 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

5586 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

5587 i‡(
îr
)

5588 
ª°‹e_›ts
;

5592 i‡(!
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
Ë&& 
sbi
->
sy°em_blks
)

5593 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

5600 *
Êags
 = (*Êag†& ~
vfs_Êags
Ë| (
sb
->
s_Êags
 & vfs_flags);

5602 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "ª-mou¡ed. O±s: %s", 
‹ig_d©a
);

5603 
	`k‰ì
(
‹ig_d©a
);

5606 
ª°‹e_›ts
:

5607 
sb
->
s_Êags
 = 
ﬁd_sb_Êags
;

5608 
sbi
->
s_mou¡_›t
 = 
ﬁd_›ts
.s_mount_opt;

5609 
sbi
->
s_mou¡_›t2
 = 
ﬁd_›ts
.s_mount_opt2;

5610 
sbi
->
s_ªsuid
 = 
ﬁd_›ts
.s_resuid;

5611 
sbi
->
s_ªsgid
 = 
ﬁd_›ts
.s_resgid;

5612 
sbi
->
s_commô_öãrvÆ
 = 
ﬁd_›ts
.s_commit_interval;

5613 
sbi
->
s_mö_b©ch_time
 = 
ﬁd_›ts
.s_min_batch_time;

5614 
sbi
->
s_max_b©ch_time
 = 
ﬁd_›ts
.s_max_batch_time;

5615 i‡(!
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
Ë&& 
sbi
->
sy°em_blks
)

5616 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

5617 #ifde‡
CONFIG_QUOTA


5618 
sbi
->
s_jquŸa_fmt
 = 
ﬁd_›ts
.s_jquota_fmt;

5619 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

5620 
to_‰ì
[
i
] = 
	`gë_qf_«me
(
sb
, 
sbi
, i);

5621 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
i
], 
ﬁd_›ts
.s_qf_names[i]);

5623 
	`synchr⁄ize_rcu
();

5624 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5625 
	`k‰ì
(
to_‰ì
[
i
]);

5627 
	`k‰ì
(
‹ig_d©a
);

5628  
îr
;

5629 
	}
}

5631 #ifde‡
CONFIG_QUOTA


5632 
	$pxt4_°©fs_¥oje˘
(
su≥r_block
 *
sb
,

5633 
k¥ojid_t
 
¥ojid
, 
k°©fs
 *
buf
)

5635 
kqid
 
qid
;

5636 
dquŸ
 *dquot;

5637 
u64
 
limô
;

5638 
u64
 
curblock
;

5640 
qid
 = 
	`make_kqid_¥ojid
(
¥ojid
);

5641 
dquŸ
 = 
	`dqgë
(
sb
, 
qid
);

5642 i‡(
	`IS_ERR
(
dquŸ
))

5643  
	`PTR_ERR
(
dquŸ
);

5644 
	`•ö_lock
(&
dquŸ
->
dq_dqb_lock
);

5646 
limô
 = 0;

5647 i‡(
dquŸ
->
dq_dqb
.
dqb_bso·limô
 &&

5648 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_bso·limô
 <Üimit))

5649 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_bso·limô
;

5650 i‡(
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
 &&

5651 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
 <Üimit))

5652 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
;

5653 
limô
 >>
sb
->
s_blocksize_bôs
;

5655 i‡(
limô
 && 
buf
->
f_blocks
 >Üimit) {

5656 
curblock
 = (
dquŸ
->
dq_dqb
.
dqb_cur•a˚
 +

5657 
dquŸ
->
dq_dqb
.
dqb_rsv•a˚
Ë>> 
sb
->
s_blocksize_bôs
;

5658 
buf
->
f_blocks
 = 
limô
;

5659 
buf
->
f_b‰ì
 = buf->
f_bavaû
 =

5660 (
buf
->
f_blocks
 > 
curblock
) ?

5661 (
buf
->
f_blocks
 - 
curblock
) : 0;

5664 
limô
 = 0;

5665 i‡(
dquŸ
->
dq_dqb
.
dqb_iso·limô
 &&

5666 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_iso·limô
 <Üimit))

5667 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_iso·limô
;

5668 i‡(
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
 &&

5669 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
 <Üimit))

5670 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
;

5672 i‡(
limô
 && 
buf
->
f_fûes
 >Üimit) {

5673 
buf
->
f_fûes
 = 
limô
;

5674 
buf
->
f_f‰ì
 =

5675 (
buf
->
f_fûes
 > 
dquŸ
->
dq_dqb
.
dqb_curöodes
) ?

5676 (
buf
->
f_fûes
 - 
dquŸ
->
dq_dqb
.
dqb_curöodes
) : 0;

5679 
	`•ö_u∆ock
(&
dquŸ
->
dq_dqb_lock
);

5680 
	`dqput
(
dquŸ
);

5682 
	}
}

5685 
	$pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
)

5687 
su≥r_block
 *
sb
 = 
díåy
->
d_sb
;

5688 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5689 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

5690 
pxt4_fsblk_t
 
ovîhód
 = 0, 
ªsv_blocks
;

5691 
u64
 
fsid
;

5692 
s64
 
b‰ì
;

5693 
ªsv_blocks
 = 
	`PXT4_C2B
(
sbi
, 
	`©omic64_ªad
(&sbi->
s_ªsv_˛u°îs
));

5695 i‡(!
	`ã°_›t
(
sb
, 
MINIX_DF
))

5696 
ovîhód
 = 
sbi
->
s_ovîhód
;

5698 
buf
->
f_ty≥
 = 
PXT4_SUPER_MAGIC
;

5699 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

5700 
buf
->
f_blocks
 = 
	`pxt4_blocks_cou¡
(
es
Ë- 
	`PXT4_C2B
(
sbi
, 
ovîhód
);

5701 
b‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
) -

5702 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

5704 
buf
->
f_b‰ì
 = 
	`PXT4_C2B
(
sbi
, 
	`max_t
(
s64
, 
b‰ì
, 0));

5705 
buf
->
f_bavaû
 = buf->
f_b‰ì
 -

5706 (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
);

5707 i‡(
buf
->
f_b‰ì
 < (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
))

5708 
buf
->
f_bavaû
 = 0;

5709 
buf
->
f_fûes
 = 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
);

5710 
buf
->
f_f‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

5711 
buf
->
f_«mñí
 = 
PXT4_NAME_LEN
;

5712 
fsid
 = 
	`À64_to_˝up
((*)
es
->
s_uuid
) ^

5713 
	`À64_to_˝up
((*)
es
->
s_uuid
 + (
u64
));

5714 
buf
->
f_fsid
.
vÆ
[0] = 
fsid
 & 0xFFFFFFFFUL;

5715 
buf
->
f_fsid
.
vÆ
[1] = (
fsid
 >> 32) & 0xFFFFFFFFUL;

5717 #ifde‡
CONFIG_QUOTA


5718 i‡(
	`pxt4_ã°_öode_Êag
(
díåy
->
d_öode
, 
PXT4_INODE_PROJINHERIT
) &&

5719 
	`sb_has_quŸa_limôs_íabÀd
(
sb
, 
PRJQUOTA
))

5720 
	`pxt4_°©fs_¥oje˘
(
sb
, 
	`PXT4_I
(
díåy
->
d_öode
)->
i_¥ojid
, 
buf
);

5723 
	}
}

5726 #ifde‡
CONFIG_QUOTA


5732 
ölöe
 
öode
 *
	$dquŸ_to_öode
(
dquŸ
 *dquot)

5734  
	`sb_dq›t
(
dquŸ
->
dq_sb
)->
fûes
[dquŸ->
dq_id
.
ty≥
];

5735 
	}
}

5737 
	$pxt4_wrôe_dquŸ
(
dquŸ
 *dquot)

5739 
ªt
, 
îr
;

5740 
h™dÀ_t
 *
h™dÀ
;

5741 
öode
 *inode;

5743 
öode
 = 
	`dquŸ_to_öode
(
dquŸ
);

5744 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5745 
	`PXT4_QUOTA_TRANS_BLOCKS
(
dquŸ
->
dq_sb
));

5746 i‡(
	`IS_ERR
(
h™dÀ
))

5747  
	`PTR_ERR
(
h™dÀ
);

5748 
ªt
 = 
	`dquŸ_commô
(
dquŸ
);

5749 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5750 i‡(!
ªt
)

5751 
ªt
 = 
îr
;

5752  
ªt
;

5753 
	}
}

5755 
	$pxt4_acquúe_dquŸ
(
dquŸ
 *dquot)

5757 
ªt
, 
îr
;

5758 
h™dÀ_t
 *
h™dÀ
;

5760 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5761 
	`PXT4_QUOTA_INIT_BLOCKS
(
dquŸ
->
dq_sb
));

5762 i‡(
	`IS_ERR
(
h™dÀ
))

5763  
	`PTR_ERR
(
h™dÀ
);

5764 
ªt
 = 
	`dquŸ_acquúe
(
dquŸ
);

5765 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5766 i‡(!
ªt
)

5767 
ªt
 = 
îr
;

5768  
ªt
;

5769 
	}
}

5771 
	$pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot)

5773 
ªt
, 
îr
;

5774 
h™dÀ_t
 *
h™dÀ
;

5776 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5777 
	`PXT4_QUOTA_DEL_BLOCKS
(
dquŸ
->
dq_sb
));

5778 i‡(
	`IS_ERR
(
h™dÀ
)) {

5780 
	`dquŸ_ªÀa£
(
dquŸ
);

5781  
	`PTR_ERR
(
h™dÀ
);

5783 
ªt
 = 
	`dquŸ_ªÀa£
(
dquŸ
);

5784 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5785 i‡(!
ªt
)

5786 
ªt
 = 
îr
;

5787  
ªt
;

5788 
	}
}

5790 
	$pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot)

5792 
su≥r_block
 *
sb
 = 
dquŸ
->
dq_sb
;

5793 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5796 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
) ||

5797 
sbi
->
s_qf_«mes
[
USRQUOTA
] || sbi->s_qf_«mes[
GRPQUOTA
]) {

5798 
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5799  
	`pxt4_wrôe_dquŸ
(
dquŸ
);

5801  
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5803 
	}
}

5805 
	$pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
)

5807 
ªt
, 
îr
;

5808 
h™dÀ_t
 *
h™dÀ
;

5811 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`d_öode
(
sb
->
s_roŸ
), 
PXT4_HT_QUOTA
, 2);

5812 i‡(
	`IS_ERR
(
h™dÀ
))

5813  
	`PTR_ERR
(
h™dÀ
);

5814 
ªt
 = 
	`dquŸ_commô_öfo
(
sb
, 
ty≥
);

5815 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5816 i‡(!
ªt
)

5817 
ªt
 = 
îr
;

5818  
ªt
;

5819 
	}
}

5825 
	$pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
)

5827  
	`dquŸ_quŸa_⁄_mou¡
(
sb
, 
	`gë_qf_«me
(sb, 
	`PXT4_SB
(sb), 
ty≥
),

5828 
	`PXT4_SB
(
sb
)->
s_jquŸa_fmt
, 
ty≥
);

5829 
	}
}

5831 
	$lockdï_£t_quŸa_öode
(
öode
 *öode, 
sub˛ass
)

5833 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5841 (Ë
ei
;

5842 
	`lockdï_£t_sub˛ass
(&
ei
->
i_d©a_£m
, 
sub˛ass
);

5843 
	}
}

5848 
	$pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5849 c⁄° 
∑th
 *path)

5851 
îr
;

5853 i‡(!
	`ã°_›t
(
sb
, 
QUOTA
))

5854  -
EINVAL
;

5857 i‡(
∑th
->
díåy
->
d_sb
 !
sb
)

5858  -
EXDEV
;

5860 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
ty≥
]) {

5862 i‡(
∑th
->
díåy
->
d_∑ª¡
 !
sb
->
s_roŸ
)

5863 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

5866 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_NOLIST_DIRTY
;

5872 
	`sb_dq›t
(
sb
)->
Êags
 &~
DQUOT_NOLIST_DIRTY
;

5879 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

5880 
	`pxt4_should_jou∫Æ_d©a
(
	`d_öode
(
∑th
->
díåy
))) {

5885 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5886 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5887 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5888 i‡(
îr
)

5889  
îr
;

5892 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
, 
I_DATA_SEM_QUOTA
);

5893 
îr
 = 
	`dquŸ_quŸa_⁄
(
sb
, 
ty≥
, 
f‹m©_id
, 
∑th
);

5894 i‡(
îr
) {

5895 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
,

5896 
I_DATA_SEM_NORMAL
);

5898 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5899 
h™dÀ_t
 *
h™dÀ
;

5906 
	`öode_lock
(
öode
);

5907 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5908 i‡(
	`IS_ERR
(
h™dÀ
))

5909 
u∆ock_öode
;

5910 
	`PXT4_I
(
öode
)->
i_Êags
 |
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
;

5911 
	`öode_£t_Êags
(
öode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

5912 
S_NOATIME
 | 
S_IMMUTABLE
);

5913 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5914 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5915 
u∆ock_öode
:

5916 
	`öode_u∆ock
(
öode
);

5918  
îr
;

5919 
	}
}

5921 
	$pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5922 
Êags
)

5924 
îr
;

5925 
öode
 *
qf_öode
;

5926 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5927 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5928 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5929 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5932 
	`BUG_ON
(!
	`pxt4_has_„©uª_quŸa
(
sb
));

5934 i‡(!
qf_öums
[
ty≥
])

5935  -
EPERM
;

5937 
qf_öode
 = 
	`pxt4_igë
(
sb
, 
qf_öums
[
ty≥
], 
PXT4_IGET_SPECIAL
);

5938 i‡(
	`IS_ERR
(
qf_öode
)) {

5939 
	`pxt4_îr‹
(
sb
, "Bad quŸ®öodê# %lu", 
qf_öums
[
ty≥
]);

5940  
	`PTR_ERR
(
qf_öode
);

5944 
qf_öode
->
i_Êags
 |
S_NOQUOTA
;

5945 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_QUOTA
);

5946 
îr
 = 
	`dquŸ_íabÀ
(
qf_öode
, 
ty≥
, 
f‹m©_id
, 
Êags
);

5947 i‡(
îr
)

5948 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_NORMAL
);

5949 
	`ùut
(
qf_öode
);

5951  
îr
;

5952 
	}
}

5955 
	$pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
)

5957 
ty≥
, 
îr
 = 0;

5958 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5959 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5960 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5961 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5963 
boﬁ
 
quŸa_m›t
[
PXT4_MAXQUOTAS
] = {

5964 
	`ã°_›t
(
sb
, 
USRQUOTA
),

5965 
	`ã°_›t
(
sb
, 
GRPQUOTA
),

5966 
	`ã°_›t
(
sb
, 
PRJQUOTA
),

5969 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_QUOTA_SYS_FILE
 | 
DQUOT_NOLIST_DIRTY
;

5970 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++) {

5971 i‡(
qf_öums
[
ty≥
]) {

5972 
îr
 = 
	`pxt4_quŸa_íabÀ
(
sb
, 
ty≥
, 
QFMT_VFS_V1
,

5973 
DQUOT_USAGE_ENABLED
 |

5974 (
quŸa_m›t
[
ty≥
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

5975 i‡(
îr
) {

5976 
	`pxt4_w¨nög
(
sb
,

5979 "e2fsckÅÿfix.", 
ty≥
, 
îr
);

5980 
ty≥
--;Åype >= 0;Åype--)

5981 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5983  
îr
;

5988 
	}
}

5990 
	$pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
)

5992 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5993 
h™dÀ_t
 *
h™dÀ
;

5994 
îr
;

5998 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

5999 
	`sync_fûesy°em
(
sb
);

6001 i‡(!
öode
 || !
	`igøb
(inode))

6002 
out
;

6004 
îr
 = 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

6005 i‡(
îr
 || 
	`pxt4_has_„©uª_quŸa
(
sb
))

6006 
out_put
;

6008 
	`öode_lock
(
öode
);

6014 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

6015 i‡(
	`IS_ERR
(
h™dÀ
))

6016 
out_u∆ock
;

6017 
	`PXT4_I
(
öode
)->
i_Êags
 &~(
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
);

6018 
	`öode_£t_Êags
(
öode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

6019 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

6020 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6021 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6022 
out_u∆ock
:

6023 
	`öode_u∆ock
(
öode
);

6024 
out_put
:

6025 
	`lockdï_£t_quŸa_öode
(
öode
, 
I_DATA_SEM_NORMAL
);

6026 
	`ùut
(
öode
);

6027  
îr
;

6028 
out
:

6029  
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

6030 
	}
}

6036 
ssize_t
 
	$pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

6037 
size_t
 
Àn
, 
loff_t
 
off
)

6039 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

6040 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

6041 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

6042 
toc›y
;

6043 
size_t
 
t‹ód
;

6044 
buf„r_hód
 *
bh
;

6045 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

6047 i‡(
off
 > 
i_size
)

6049 i‡(
off
+
Àn
 > 
i_size
)

6050 
Àn
 = 
i_size
-
off
;

6051 
t‹ód
 = 
Àn
;

6052 
t‹ód
 > 0) {

6053 
toc›y
 = 
sb
->
s_blocksize
 - 
off£t
 < 
t‹ód
 ?

6054 
sb
->
s_blocksize
 - 
off£t
 : 
t‹ód
;

6055 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
blk
, 0);

6056 i‡(
	`IS_ERR
(
bh
))

6057  
	`PTR_ERR
(
bh
);

6058 i‡(!
bh
)

6059 
	`mem£t
(
d©a
, 0, 
toc›y
);

6061 
	`mem˝y
(
d©a
, 
bh
->
b_d©a
+
off£t
, 
toc›y
);

6062 
	`bªl£
(
bh
);

6063 
off£t
 = 0;

6064 
t‹ód
 -
toc›y
;

6065 
d©a
 +
toc›y
;

6066 
blk
++;

6068  
Àn
;

6069 
	}
}

6073 
ssize_t
 
	$pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

6074 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
)

6076 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

6077 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

6078 
îr
, 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

6079 
ªåõs
 = 0;

6080 
buf„r_hód
 *
bh
;

6081 
h™dÀ_t
 *
h™dÀ
 = 
	`jou∫Æ_cuºít_h™dÀ
();

6083 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 && !
h™dÀ
) {

6084 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

6086 ()
off
, ()
Àn
);

6087  -
EIO
;

6093 i‡(
sb
->
s_blocksize
 - 
off£t
 < 
Àn
) {

6094 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

6096 ()
off
, ()
Àn
);

6097  -
EIO
;

6101 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, 
blk
,

6102 
PXT4_GET_BLOCKS_CREATE
 |

6103 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

6104 } 
	`IS_ERR
(
bh
Ë&& (
	`PTR_ERR
(bhË=-
ENOSPC
) &&

6105 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

6106 i‡(
	`IS_ERR
(
bh
))

6107  
	`PTR_ERR
(
bh
);

6108 i‡(!
bh
)

6109 
out
;

6110 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

6111 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

6112 i‡(
îr
) {

6113 
	`bªl£
(
bh
);

6114  
îr
;

6116 
	`lock_buf„r
(
bh
);

6117 
	`mem˝y
(
bh
->
b_d©a
+
off£t
, 
d©a
, 
Àn
);

6118 
	`Êush_dˇche_∑ge
(
bh
->
b_∑ge
);

6119 
	`u∆ock_buf„r
(
bh
);

6120 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

6121 
	`bªl£
(
bh
);

6122 
out
:

6123 i‡(
öode
->
i_size
 < 
off
 + 
Àn
) {

6124 
	`i_size_wrôe
(
öode
, 
off
 + 
Àn
);

6125 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

6126 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6128  
Àn
;

6129 
	}
}

6131 
	$pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
)

6133 c⁄° 
quŸa_f‹m©_›s
 *
›s
;

6135 i‡(!
	`sb_has_quŸa_lﬂded
(
sb
, 
qid
->
ty≥
))

6136  -
ESRCH
;

6137 
›s
 = 
	`sb_dq›t
(
sb
)->›s[
qid
->
ty≥
];

6138 i‡(!
›s
 || !›s->
gë_√xt_id
)

6139  -
ENOSYS
;

6140  
	`dquŸ_gë_√xt_id
(
sb
, 
qid
);

6141 
	}
}

6144 
díåy
 *
	$pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

6145 c⁄° *
dev_«me
, *
d©a
)

6147  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
pxt4_fûl_su≥r
);

6148 
	}
}

6150 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

6151 
ölöe
 
	$ªgi°î_as_pxt2
()

6153 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6154 i‡(
îr
)

6155 
	`¥ötk
(
KERN_WARNING


6156 "PXT4-fs: U«bÀÅÿªgi°îá†pxt2 (%d)\n", 
îr
);

6157 
	}
}

6159 
ölöe
 
	$uƒegi°î_as_pxt2
()

6161 
	`uƒegi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6162 
	}
}

6164 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6166 i‡(
	`pxt4_has_unknown_pxt2_öcom∑t_„©uªs
(
sb
))

6168 i‡(
	`sb_rd⁄ly
(
sb
))

6170 i‡(
	`pxt4_has_unknown_pxt2_ro_com∑t_„©uªs
(
sb
))

6173 
	}
}

6175 
ölöe
 
	$ªgi°î_as_pxt2
(Ë{ 
	}
}

6176 
ölöe
 
	$uƒegi°î_as_pxt2
(Ë{ 
	}
}

6177 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
Ë{  0; 
	}
}

6180 
ölöe
 
	$ªgi°î_as_ext3
()

6182 
îr
 = 
	`ªgi°î_fûesy°em
(&
ext3_fs_ty≥
);

6183 i‡(
îr
)

6184 
	`¥ötk
(
KERN_WARNING


6185 "PXT4-fs: U«bÀÅÿªgi°îá†ext3 (%d)\n", 
îr
);

6186 
	}
}

6188 
ölöe
 
	$uƒegi°î_as_ext3
()

6190 
	`uƒegi°î_fûesy°em
(&
ext3_fs_ty≥
);

6191 
	}
}

6193 
ölöe
 
	$ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6195 i‡(
	`pxt4_has_unknown_ext3_öcom∑t_„©uªs
(
sb
))

6197 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
))

6199 i‡(
	`sb_rd⁄ly
(
sb
))

6201 i‡(
	`pxt4_has_unknown_ext3_ro_com∑t_„©uªs
(
sb
))

6204 
	}
}

6206 
fûe_sy°em_ty≥
 
	gpxt4_fs_ty≥
 = {

6207 .
ow√r
 = 
THIS_MODULE
,

6208 .
	g«me
 = "pxt4",

6209 .
	gmou¡
 = 
pxt4_mou¡
,

6210 .
	gkûl_sb
 = 
kûl_block_su≥r
,

6211 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

6213 
MODULE_ALIAS_FS
("pxt4");

6216 
waô_queue_hód_t
 
	gpxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

6218 
__öô
 
	$pxt4_öô_fs
()

6220 
i
, 
îr
;

6222 
	`øãlimô_°©e_öô
(&
pxt4_mou¡_msg_øãlimô
, 30 * 
HZ
, 64);

6223 
pxt4_li_öfo
 = 
NULL
;

6224 
	`muãx_öô
(&
pxt4_li_mtx
);

6227 
	`pxt4_check_Êag_vÆues
();

6229 
i
 = 0; i < 
PXT4_WQ_HASH_SZ
; i++)

6230 
	`öô_waôqueue_hód
(&
pxt4__i€nd_wq
[
i
]);

6232 
îr
 = 
	`pxt4_öô_es
();

6233 i‡(
îr
)

6234  
îr
;

6236 
îr
 = 
	`pxt4_öô_≥ndög
();

6237 i‡(
îr
)

6238 
out7
;

6240 
îr
 = 
	`pxt4_öô_po°_ªad_¥o˚ssög
();

6241 i‡(
îr
)

6242 
out6
;

6244 
îr
 = 
	`pxt4_öô_∑geio
();

6245 i‡(
îr
)

6246 
out5
;

6248 
îr
 = 
	`pxt4_öô_sy°em_z⁄e
();

6249 i‡(
îr
)

6250 
out4
;

6252 
îr
 = 
	`pxt4_öô_sysfs
();

6253 i‡(
îr
)

6254 
out3
;

6256 
îr
 = 
	`pxt4_öô_mbÆloc
();

6257 i‡(
îr
)

6258 
out2
;

6259 
îr
 = 
	`öô_öodeˇche
();

6260 i‡(
îr
)

6261 
out1
;

6262 
	`ªgi°î_as_ext3
();

6263 
	`ªgi°î_as_pxt2
();

6264 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6265 i‡(
îr
)

6266 
out
;

6269 
out
:

6270 
	`uƒegi°î_as_pxt2
();

6271 
	`uƒegi°î_as_ext3
();

6272 
	`de°roy_öodeˇche
();

6273 
out1
:

6274 
	`pxt4_exô_mbÆloc
();

6275 
out2
:

6276 
	`pxt4_exô_sysfs
();

6277 
out3
:

6278 
	`pxt4_exô_sy°em_z⁄e
();

6279 
out4
:

6280 
	`pxt4_exô_∑geio
();

6281 
out5
:

6282 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6283 
out6
:

6284 
	`pxt4_exô_≥ndög
();

6285 
out7
:

6286 
	`pxt4_exô_es
();

6288  
îr
;

6289 
	}
}

6291 
__exô
 
	$pxt4_exô_fs
()

6293 
	`pxt4_de°roy_œzyöô_thªad
();

6294 
	`uƒegi°î_as_pxt2
();

6295 
	`uƒegi°î_as_ext3
();

6296 
	`uƒegi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6297 
	`de°roy_öodeˇche
();

6298 
	`pxt4_exô_mbÆloc
();

6299 
	`pxt4_exô_sysfs
();

6300 
	`pxt4_exô_sy°em_z⁄e
();

6301 
	`pxt4_exô_∑geio
();

6302 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6303 
	`pxt4_exô_es
();

6304 
	`pxt4_exô_≥ndög
();

6305 
	}
}

6307 
MODULE_AUTHOR
("Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'oánd others");

6308 
MODULE_DESCRIPTION
("Fourth Extended Filesystem");

6309 
MODULE_LICENSE
("GPL");

6310 
MODULE_SOFTDEP
("pre: crc32c");

6311 
	$moduÀ_öô
(
pxt4_öô_fs
)

6312 
	`moduÀ_exô
(
pxt4_exô_fs
)

	@symlink.c

21 
	~<löux/fs.h
>

22 
	~<löux/«mei.h
>

23 
	~"pxt4.h
"

24 
	~"x©å.h
"

26 c⁄° *
	$pxt4_í¸y±ed_gë_lök
(
díåy
 *dentry,

27 
öode
 *inode,

28 
dñayed_ˇŒ
 *
d⁄e
)

30 
∑ge
 *
˝age
 = 
NULL
;

31 c⁄° *
ˇddr
;

32 
max_size
;

33 c⁄° *
∑ddr
;

35 i‡(!
díåy
)

36  
	`ERR_PTR
(-
ECHILD
);

38 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

39 
ˇddr
 = 
	`PXT4_I
(
öode
)->
i_d©a
;

40 
max_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

42 
˝age
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 0, 
NULL
);

43 i‡(
	`IS_ERR
(
˝age
))

44  
	`ERR_CAST
(
˝age
);

45 
ˇddr
 = 
	`∑ge_addªss
(
˝age
);

46 
max_size
 = 
öode
->
i_sb
->
s_blocksize
;

49 
∑ddr
 = 
	`fs¸y±_gë_symlök
(
öode
, 
ˇddr
, 
max_size
, 
d⁄e
);

50 i‡(
˝age
)

51 
	`put_∑ge
(
˝age
);

52  
∑ddr
;

53 
	}
}

55 c⁄° 
öode_›î©i⁄s
 
	gpxt4_í¸y±ed_symlök_öode_›î©i⁄s
 = {

56 .
gë_lök
 = 
pxt4_í¸y±ed_gë_lök
,

57 .
	g£èâr
 = 
pxt4_£èâr
,

58 .
	ggë©å
 = 
pxt4_gë©å
,

59 .
	gli°x©å
 = 
pxt4_li°x©å
,

62 c⁄° 
öode_›î©i⁄s
 
	gpxt4_symlök_öode_›î©i⁄s
 = {

63 .
gë_lök
 = 
∑ge_gë_lök
,

64 .
	g£èâr
 = 
pxt4_£èâr
,

65 .
	ggë©å
 = 
pxt4_gë©å
,

66 .
	gli°x©å
 = 
pxt4_li°x©å
,

69 c⁄° 
öode_›î©i⁄s
 
	gpxt4_Á°_symlök_öode_›î©i⁄s
 = {

70 .
gë_lök
 = 
sim∂e_gë_lök
,

71 .
	g£èâr
 = 
pxt4_£èâr
,

72 .
	ggë©å
 = 
pxt4_gë©å
,

73 .
	gli°x©å
 = 
pxt4_li°x©å
,

	@sysfs.c

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/¥oc_fs.h
>

17 
	~"pxt4.h
"

18 
	~"pxt4_jbd3.h
"

21 
	m©å_no›
,

22 
	m©å_dñayed_Æloˇti⁄_blocks
,

23 
	m©å_£ssi⁄_wrôe_kbyãs
,

24 
	m©å_li„time_wrôe_kbyãs
,

25 
	m©å_ª£rved_˛u°îs
,

26 
	m©å_öode_ªadahód
,

27 
	m©å_åiggî_ã°_îr‹
,

28 
	m©å_fú°_îr‹_time
,

29 
	m©å_œ°_îr‹_time
,

30 
	m©å_„©uª
,

31 
	m©å_poöãr_ui
,

32 
	m©å_poöãr_©omic
,

33 
	m©å_jou∫Æ_èsk
,

34 } 
	t©å_id_t
;

37 
	m±r_ex∂icô
,

38 
	m±r_pxt4_sb_öfo_off£t
,

39 
	m±r_pxt4_su≥r_block_off£t
,

40 } 
	t©å_±r_t
;

42 c⁄° 
	g¥oc_dú«me
[] = "fs/pxt4";

43 
¥oc_dú_íåy
 *
	gpxt4_¥oc_roŸ
;

45 
	spxt4_©å
 {

46 
©åibuã
 
	m©å
;

47 
	m©å_id
;

48 
	m©å_±r
;

50 
	moff£t
;

51 *
	mex∂icô_±r
;

52 } 
	mu
;

55 
ssize_t
 
	$£ssi⁄_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

57 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

59 i‡(!
sb
->
s_bdev
->
bd_∑π
)

60  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

61  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lu\n",

62 (
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

63 
£˘‹s
[
STAT_WRITE
]) -

64 
sbi
->
s_£˘‹s_wrôãn_°¨t
) >> 1);

65 
	}
}

67 
ssize_t
 
	$li„time_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

69 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

71 i‡(!
sb
->
s_bdev
->
bd_∑π
)

72  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

73  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

74 ()(
sbi
->
s_kbyãs_wrôãn
 +

75 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

76 
£˘‹s
[
STAT_WRITE
]) -

77 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1)));

78 
	}
}

80 
ssize_t
 
	$öode_ªadahód_blks_°‹e
(
pxt4_sb_öfo
 *
sbi
,

81 c⁄° *
buf
, 
size_t
 
cou¡
)

83 
t
;

84 
ªt
;

86 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

87 i‡(
ªt
)

88  
ªt
;

90 i‡(
t
 && (!
	`is_powî_of_2
(t) ||Å > 0x40000000))

91  -
EINVAL
;

93 
sbi
->
s_öode_ªadahód_blks
 = 
t
;

94  
cou¡
;

95 
	}
}

97 
ssize_t
 
	$ª£rved_˛u°îs_°‹e
(
pxt4_sb_öfo
 *
sbi
,

98 c⁄° *
buf
, 
size_t
 
cou¡
)

100 
vÆ
;

101 
pxt4_fsblk_t
 
˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

102 
sbi
->
s_˛u°î_bôs
);

103 
ªt
;

105 
ªt
 = 
	`k°πouŒ
(
	`skù_•a˚s
(
buf
), 0, &
vÆ
);

106 i‡(
ªt
 || 
vÆ
 >
˛u°îs
)

107  -
EINVAL
;

109 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
vÆ
);

110  
cou¡
;

111 
	}
}

113 
ssize_t
 
	$åiggî_ã°_îr‹
(
pxt4_sb_öfo
 *
sbi
,

114 c⁄° *
buf
, 
size_t
 
cou¡
)

116 
Àn
 = 
cou¡
;

118 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

119  -
EPERM
;

121 i‡(
Àn
 && 
buf
[len-1] == '\n')

122 
Àn
--;

124 i‡(
Àn
)

125 
	`pxt4_îr‹
(
sbi
->
s_sb
, "%.*s", 
Àn
, 
buf
);

126  
cou¡
;

127 
	}
}

129 
ssize_t
 
	$jou∫Æ_èsk_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

131 i‡(!
sbi
->
s_jou∫Æ
)

132  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "<none>\n");

133  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

134 
	`èsk_pid_vƒ
(
sbi
->
s_jou∫Æ
->
j_èsk
));

135 
	}
}

137 
	#PXT4_ATTR
(
_«me
,
_mode
,
_id
) \

138 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

139 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

140 .
©å_id
 = 
©å_
##
_id
, \

141 }

	)

143 
	#PXT4_ATTR_FUNC
(
_«me
,
_mode
Ë
	`PXT4_ATTR
(_«me,_mode,_«me)

	)

145 
	#PXT4_ATTR_FEATURE
(
_«me
Ë
	`PXT4_ATTR
(_«me, 0444, 
„©uª
)

	)

147 
	#PXT4_ATTR_OFFSET
(
_«me
,
_mode
,
_id
,
_°ru˘
,
_ñ«me
) \

148 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

149 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

150 .
©å_id
 = 
©å_
##
_id
, \

151 .
©å_±r
 = 
±r_
##
_°ru˘
##
_off£t
, \

152 .
u
 = { \

153 .
off£t
 = 
	`off£tof
(
_°ru˘
, 
_ñ«me
),\

155 }

	)

157 
	#PXT4_RO_ATTR_ES_UI
(
_«me
,
_ñ«me
) \

158 
	`PXT4_ATTR_OFFSET
(
_«me
, 0444, 
poöãr_ui
, 
pxt4_su≥r_block
, 
_ñ«me
)

	)

160 
	#PXT4_RW_ATTR_SBI_UI
(
_«me
,
_ñ«me
) \

161 
	`PXT4_ATTR_OFFSET
(
_«me
, 0644, 
poöãr_ui
, 
pxt4_sb_öfo
, 
_ñ«me
)

	)

163 
	#PXT4_ATTR_PTR
(
_«me
,
_mode
,
_id
,
_±r
) \

164 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

165 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

166 .
©å_id
 = 
©å_
##
_id
, \

167 .
©å_±r
 = 
±r_ex∂icô
, \

168 .
u
 = { \

169 .
ex∂icô_±r
 = 
_±r
, \

171 }

	)

173 
	#ATTR_LIST
(
«me
Ë&
pxt4_©å_
##«me.
©å


	)

175 
PXT4_ATTR_FUNC
(
dñayed_Æloˇti⁄_blocks
, 0444);

176 
PXT4_ATTR_FUNC
(
£ssi⁄_wrôe_kbyãs
, 0444);

177 
PXT4_ATTR_FUNC
(
li„time_wrôe_kbyãs
, 0444);

178 
PXT4_ATTR_FUNC
(
ª£rved_˛u°îs
, 0644);

180 
PXT4_ATTR_OFFSET
(
öode_ªadahód_blks
, 0644, 
öode_ªadahód
,

181 
pxt4_sb_öfo
, 
s_öode_ªadahód_blks
);

182 
PXT4_RW_ATTR_SBI_UI
(
öode_gﬂl
, 
s_öode_gﬂl
);

183 
PXT4_RW_ATTR_SBI_UI
(
mb_°©s
, 
s_mb_°©s
);

184 
PXT4_RW_ATTR_SBI_UI
(
mb_max_to_sˇn
, 
s_mb_max_to_sˇn
);

185 
PXT4_RW_ATTR_SBI_UI
(
mb_mö_to_sˇn
, 
s_mb_mö_to_sˇn
);

186 
PXT4_RW_ATTR_SBI_UI
(
mb_‹dî2_ªq
, 
s_mb_‹dî2_ªqs
);

187 
PXT4_RW_ATTR_SBI_UI
(
mb_°ªam_ªq
, 
s_mb_°ªam_ªque°
);

188 
PXT4_RW_ATTR_SBI_UI
(
mb_group_¥óŒoc
, 
s_mb_group_¥óŒoc
);

189 
PXT4_RW_ATTR_SBI_UI
(
exã¡_max_zîoout_kb
, 
s_exã¡_max_zîoout_kb
);

190 
PXT4_ATTR
(
åiggî_fs_îr‹
, 0200, 
åiggî_ã°_îr‹
);

191 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_öãrvÆ_ms
, 
s_îr_øãlimô_°©e
.
öãrvÆ
);

192 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_bur°
, 
s_îr_øãlimô_°©e
.
bur°
);

193 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_öãrvÆ_ms
, 
s_w¨nög_øãlimô_°©e
.
öãrvÆ
);

194 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_bur°
, 
s_w¨nög_øãlimô_°©e
.
bur°
);

195 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_öãrvÆ_ms
, 
s_msg_øãlimô_°©e
.
öãrvÆ
);

196 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_bur°
, 
s_msg_øãlimô_°©e
.
bur°
);

197 
PXT4_RO_ATTR_ES_UI
(
îr‹s_cou¡
, 
s_îr‹_cou¡
);

198 
PXT4_ATTR
(
fú°_îr‹_time
, 0444, first_error_time);

199 
PXT4_ATTR
(
œ°_îr‹_time
, 0444,Üast_error_time);

200 
PXT4_ATTR
(
jou∫Æ_èsk
, 0444, journal_task);

202 
	gﬁd_bump_vÆ
 = 128;

203 
PXT4_ATTR_PTR
(
max_wrôeback_mb_bump
, 0444, 
poöãr_ui
, &
ﬁd_bump_vÆ
);

205 
©åibuã
 *
	gpxt4_©ås
[] = {

206 
ATTR_LIST
(
dñayed_Æloˇti⁄_blocks
),

207 
ATTR_LIST
(
£ssi⁄_wrôe_kbyãs
),

208 
ATTR_LIST
(
li„time_wrôe_kbyãs
),

209 
ATTR_LIST
(
ª£rved_˛u°îs
),

210 
ATTR_LIST
(
öode_ªadahód_blks
),

211 
ATTR_LIST
(
öode_gﬂl
),

212 
ATTR_LIST
(
mb_°©s
),

213 
ATTR_LIST
(
mb_max_to_sˇn
),

214 
ATTR_LIST
(
mb_mö_to_sˇn
),

215 
ATTR_LIST
(
mb_‹dî2_ªq
),

216 
ATTR_LIST
(
mb_°ªam_ªq
),

217 
ATTR_LIST
(
mb_group_¥óŒoc
),

218 
ATTR_LIST
(
max_wrôeback_mb_bump
),

219 
ATTR_LIST
(
exã¡_max_zîoout_kb
),

220 
ATTR_LIST
(
åiggî_fs_îr‹
),

221 
ATTR_LIST
(
îr_øãlimô_öãrvÆ_ms
),

222 
ATTR_LIST
(
îr_øãlimô_bur°
),

223 
ATTR_LIST
(
w¨nög_øãlimô_öãrvÆ_ms
),

224 
ATTR_LIST
(
w¨nög_øãlimô_bur°
),

225 
ATTR_LIST
(
msg_øãlimô_öãrvÆ_ms
),

226 
ATTR_LIST
(
msg_øãlimô_bur°
),

227 
ATTR_LIST
(
îr‹s_cou¡
),

228 
ATTR_LIST
(
fú°_îr‹_time
),

229 
ATTR_LIST
(
œ°_îr‹_time
),

230 
ATTR_LIST
(
jou∫Æ_èsk
),

231 
NULL
,

233 
ATTRIBUTE_GROUPS
(
pxt4
);

236 
PXT4_ATTR_FEATURE
(
œzy_ôabÀ_öô
);

237 
PXT4_ATTR_FEATURE
(
b©ched_disˇrd
);

238 
PXT4_ATTR_FEATURE
(
mëa_bg_ªsize
);

239 #ifde‡
CONFIG_FS_ENCRYPTION


240 
PXT4_ATTR_FEATURE
(
í¸y±i⁄
);

242 #ifde‡
CONFIG_UNICODE


243 
PXT4_ATTR_FEATURE
(
ˇ£fﬁd
);

245 #ifde‡
CONFIG_FS_VERITY


246 
PXT4_ATTR_FEATURE
(
vîôy
);

248 
PXT4_ATTR_FEATURE
(
mëad©a_csum_£ed
);

250 
©åibuã
 *
	gpxt4_„©_©ås
[] = {

251 
ATTR_LIST
(
œzy_ôabÀ_öô
),

252 
ATTR_LIST
(
b©ched_disˇrd
),

253 
ATTR_LIST
(
mëa_bg_ªsize
),

254 #ifde‡
CONFIG_FS_ENCRYPTION


255 
ATTR_LIST
(
í¸y±i⁄
),

257 #ifde‡
CONFIG_UNICODE


258 
ATTR_LIST
(
ˇ£fﬁd
),

260 #ifde‡
CONFIG_FS_VERITY


261 
ATTR_LIST
(
vîôy
),

263 
ATTR_LIST
(
mëad©a_csum_£ed
),

264 
NULL
,

266 
ATTRIBUTE_GROUPS
(
pxt4_„©
);

268 *
	$ˇlc_±r
(
pxt4_©å
 *
a
, 
pxt4_sb_öfo
 *
sbi
)

270 
a
->
©å_±r
) {

271 
±r_ex∂icô
:

272  
a
->
u
.
ex∂icô_±r
;

273 
±r_pxt4_sb_öfo_off£t
:

274  (*Ë(((*Ë
sbi
Ë+ 
a
->
u
.
off£t
);

275 
±r_pxt4_su≥r_block_off£t
:

276  (*Ë(((*Ë
sbi
->
s_es
Ë+ 
a
->
u
.
off£t
);

278  
NULL
;

279 
	}
}

281 
ssize_t
 
	$__¥öt_t°amp
(*
buf
, 
__À32
 
lo
, 
__u8
 
hi
)

283  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lld",

284 ((
time64_t
)
hi
 << 32Ë+ 
	`À32_to_˝u
(
lo
));

285 
	}
}

287 
	#¥öt_t°amp
(
buf
, 
es
, 
t°amp
) \

288 
	`__¥öt_t°amp
(
buf
, (
es
)->
t°amp
, (es)->t°am∞## 
_hi
)

	)

290 
ssize_t
 
	$pxt4_©å_show
(
kobje˘
 *
kobj
,

291 
©åibuã
 *
©å
, *
buf
)

293 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

294 
s_kobj
);

295 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

296 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

298 
a
->
©å_id
) {

299 
©å_dñayed_Æloˇti⁄_blocks
:

300  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

301 (
s64
Ë
	`PXT4_C2B
(
sbi
,

302 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

303 
©å_£ssi⁄_wrôe_kbyãs
:

304  
	`£ssi⁄_wrôe_kbyãs_show
(
sbi
, 
buf
);

305 
©å_li„time_wrôe_kbyãs
:

306  
	`li„time_wrôe_kbyãs_show
(
sbi
, 
buf
);

307 
©å_ª£rved_˛u°îs
:

308  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

310 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
));

311 
©å_öode_ªadahód
:

312 
©å_poöãr_ui
:

313 i‡(!
±r
)

315 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

316  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

317 
	`À32_to_˝up
(
±r
));

319  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

320 *((*Ë
±r
));

321 
©å_poöãr_©omic
:

322 i‡(!
±r
)

324  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

325 
	`©omic_ªad
((
©omic_t
 *Ë
±r
));

326 
©å_„©uª
:

327  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "supported\n");

328 
©å_fú°_îr‹_time
:

329  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_fú°_îr‹_time
);

330 
©å_œ°_îr‹_time
:

331  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_œ°_îr‹_time
);

332 
©å_jou∫Æ_èsk
:

333  
	`jou∫Æ_èsk_show
(
sbi
, 
buf
);

337 
	}
}

339 
ssize_t
 
	$pxt4_©å_°‹e
(
kobje˘
 *
kobj
,

340 
©åibuã
 *
©å
,

341 c⁄° *
buf
, 
size_t
 
Àn
)

343 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

344 
s_kobj
);

345 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

346 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

347 
t
;

348 
ªt
;

350 
a
->
©å_id
) {

351 
©å_ª£rved_˛u°îs
:

352  
	`ª£rved_˛u°îs_°‹e
(
sbi
, 
buf
, 
Àn
);

353 
©å_poöãr_ui
:

354 i‡(!
±r
)

356 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

357 i‡(
ªt
)

358  
ªt
;

359 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

360 *((
__À32
 *Ë
±r
Ë
	`˝u_to_À32
(
t
);

362 *((*Ë
±r
Ë
t
;

363  
Àn
;

364 
©å_öode_ªadahód
:

365  
	`öode_ªadahód_blks_°‹e
(
sbi
, 
buf
, 
Àn
);

366 
©å_åiggî_ã°_îr‹
:

367  
	`åiggî_ã°_îr‹
(
sbi
, 
buf
, 
Àn
);

370 
	}
}

372 
	$pxt4_sb_ªÀa£
(
kobje˘
 *
kobj
)

374 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

375 
s_kobj
);

376 
	`com∂ëe
(&
sbi
->
s_kobj_uƒegi°î
);

377 
	}
}

379 c⁄° 
sysfs_›s
 
	gpxt4_©å_›s
 = {

380 .
show
 = 
pxt4_©å_show
,

381 .
	g°‹e
 = 
pxt4_©å_°‹e
,

384 
kobj_ty≥
 
	gpxt4_sb_kty≥
 = {

385 .
deÁu…_groups
 = 
pxt4_groups
,

386 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

387 .
	gªÀa£
 = 
pxt4_sb_ªÀa£
,

390 
kobj_ty≥
 
	gpxt4_„©_kty≥
 = {

391 .
deÁu…_groups
 = 
pxt4_„©_groups
,

392 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

393 .
	gªÀa£
 = ((*)(
kobje˘
 *))
k‰ì
,

396 
kobje˘
 *
	gpxt4_roŸ
;

398 
kobje˘
 *
	gpxt4_„©
;

400 
	$pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
)

402 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

403 
îr
;

405 
	`öô_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

406 
îr
 = 
	`kobje˘_öô_™d_add
(&
sbi
->
s_kobj
, &
pxt4_sb_kty≥
, 
pxt4_roŸ
,

407 "%s", 
sb
->
s_id
);

408 i‡(
îr
) {

409 
	`kobje˘_put
(&
sbi
->
s_kobj
);

410 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

411  
îr
;

414 i‡(
pxt4_¥oc_roŸ
)

415 
sbi
->
s_¥oc
 = 
	`¥oc_mkdú
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

416 i‡(
sbi
->
s_¥oc
) {

417 
	`¥oc_¸óã_sögÀ_d©a
("›ti⁄s", 
S_IRUGO
, 
sbi
->
s_¥oc
,

418 
pxt4_£q_›ti⁄s_show
, 
sb
);

419 
	`¥oc_¸óã_sögÀ_d©a
("es_shrökî_öfo", 
S_IRUGO
,

420 
sbi
->
s_¥oc
, 
pxt4_£q_es_shrökî_öfo_show
,

421 
sb
);

422 
	`¥oc_¸óã_£q_d©a
("mb_groups", 
S_IRUGO
, 
sbi
->
s_¥oc
,

423 &
pxt4_mb_£q_groups_›s
, 
sb
);

426 
	}
}

428 
	$pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
)

430 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

432 i‡(
sbi
->
s_¥oc
)

433 
	`ªmove_¥oc_subåì
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

434 
	`kobje˘_dñ
(&
sbi
->
s_kobj
);

435 
	}
}

437 
__öô
 
	$pxt4_öô_sysfs
()

439 
ªt
;

441 
pxt4_roŸ
 = 
	`kobje˘_¸óã_™d_add
("pxt4", 
fs_kobj
);

442 i‡(!
pxt4_roŸ
)

443  -
ENOMEM
;

445 
pxt4_„©
 = 
	`kzÆloc
((*pxt4_„©), 
GFP_KERNEL
);

446 i‡(!
pxt4_„©
) {

447 
ªt
 = -
ENOMEM
;

448 
roŸ_îr
;

451 
ªt
 = 
	`kobje˘_öô_™d_add
(
pxt4_„©
, &
pxt4_„©_kty≥
,

452 
pxt4_roŸ
, "features");

453 i‡(
ªt
)

454 
„©_îr
;

456 
pxt4_¥oc_roŸ
 = 
	`¥oc_mkdú
(
¥oc_dú«me
, 
NULL
);

457  
ªt
;

459 
„©_îr
:

460 
	`kobje˘_put
(
pxt4_„©
);

461 
pxt4_„©
 = 
NULL
;

462 
roŸ_îr
:

463 
	`kobje˘_put
(
pxt4_roŸ
);

464 
pxt4_roŸ
 = 
NULL
;

465  
ªt
;

466 
	}
}

468 
	$pxt4_exô_sysfs
()

470 
	`kobje˘_put
(
pxt4_„©
);

471 
pxt4_„©
 = 
NULL
;

472 
	`kobje˘_put
(
pxt4_roŸ
);

473 
pxt4_roŸ
 = 
NULL
;

474 
	`ªmove_¥oc_íåy
(
¥oc_dú«me
, 
NULL
);

475 
pxt4_¥oc_roŸ
 = 
NULL
;

476 
	}
}

	@truncate.h

12 
ölöe
 
	$pxt4_åunˇã_Áûed_wrôe
(
öode
 *inode)

18 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

19 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

20 
	`pxt4_åunˇã
(
öode
);

21 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

22 
	}
}

28 
ölöe
 
	$pxt4_blocks_f‹_åunˇã
(
öode
 *inode)

30 
pxt4_lblk_t
 
√eded
;

32 
√eded
 = 
öode
->
i_blocks
 >> (öode->
i_sb
->
s_blocksize_bôs
 - 9);

40 i‡(
√eded
 < 2)

41 
√eded
 = 2;

45 i‡(
√eded
 > 
PXT4_MAX_TRANS_DATA
)

46 
√eded
 = 
PXT4_MAX_TRANS_DATA
;

48  
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
Ë+ 
√eded
;

49 
	}
}

	@verity.c

26 
	~<löux/quŸa›s.h
>

28 
	~"pxt4.h
"

29 
	~"pxt4_exã¡s.h
"

30 
	~"pxt4_jbd3.h
"

32 
ölöe
 
loff_t
 
	$pxt4_vîôy_mëad©a_pos
(c⁄° 
öode
 *inode)

34  
	`round_up
(
öode
->
i_size
, 65536);

35 
	}
}

41 
	$∑geˇche_ªad
(
öode
 *öode, *
buf
, 
size_t
 
cou¡
,

42 
loff_t
 
pos
)

44 
cou¡
) {

45 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

46 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

47 
∑ge
 *page;

48 *
addr
;

50 
∑ge
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
pos
 >> 
PAGE_SHIFT
,

51 
NULL
);

52 i‡(
	`IS_ERR
(
∑ge
))

53  
	`PTR_ERR
(
∑ge
);

55 
addr
 = 
	`km≠_©omic
(
∑ge
);

56 
	`mem˝y
(
buf
, 
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
n
);

57 
	`kunm≠_©omic
(
addr
);

59 
	`put_∑ge
(
∑ge
);

61 
buf
 +
n
;

62 
pos
 +
n
;

63 
cou¡
 -
n
;

66 
	}
}

72 
	$∑geˇche_wrôe
(
öode
 *öode, c⁄° *
buf
, 
size_t
 
cou¡
,

73 
loff_t
 
pos
)

75 i‡(
pos
 + 
cou¡
 > 
öode
->
i_sb
->
s_maxbyãs
)

76  -
EFBIG
;

78 
cou¡
) {

79 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

80 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

81 
∑ge
 *page;

82 *
fsd©a
;

83 *
addr
;

84 
ªs
;

86 
ªs
 = 
	`∑geˇche_wrôe_begö
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
, 0,

87 &
∑ge
, &
fsd©a
);

88 i‡(
ªs
)

89  
ªs
;

91 
addr
 = 
	`km≠_©omic
(
∑ge
);

92 
	`mem˝y
(
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
buf
, 
n
);

93 
	`kunm≠_©omic
(
addr
);

95 
ªs
 = 
	`∑geˇche_wrôe_íd
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
,Ç,

96 
∑ge
, 
fsd©a
);

97 i‡(
ªs
 < 0)

98  
ªs
;

99 i‡(
ªs
 !
n
)

100  -
EIO
;

102 
buf
 +
n
;

103 
pos
 +
n
;

104 
cou¡
 -
n
;

107 
	}
}

109 
	$pxt4_begö_íabÀ_vîôy
(
fûe
 *
fûp
)

111 
öode
 *öodê
	`fûe_öode
(
fûp
);

112 c⁄° 
¸edôs
 = 2;

113 
h™dÀ_t
 *
h™dÀ
;

114 
îr
;

116 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

117  -
EBUSY
;

125 
îr
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

126 i‡(
îr
)

127  
îr
;

129 
îr
 = 
	`dquŸ_öôülize
(
öode
);

130 i‡(
îr
)

131  
îr
;

133 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

134 i‡(
îr
)

135  
îr
;

137 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

138 
	`pxt4_w¨nög_öode
(
öode
,

140  -
EOPNOTSUPP
;

147 
îr
 = 
	`pxt4_åunˇã
(
öode
);

148 i‡(
îr
)

149  
îr
;

151 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

152 i‡(
	`IS_ERR
(
h™dÀ
))

153  
	`PTR_ERR
(
h™dÀ
);

155 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

156 i‡(
îr
 == 0)

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

159 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

160  
îr
;

161 
	}
}

175 
	$pxt4_wrôe_vîôy_des¸ùt‹
(
öode
 *öode, c⁄° *
desc
,

176 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

178 c⁄° 
u64
 
desc_pos
 = 
	`round_up
(
	`pxt4_vîôy_mëad©a_pos
(
öode
) +

179 
mîkÀ_åì_size
, 
	`i_blocksize
(
öode
));

180 c⁄° 
u64
 
desc_íd
 = 
desc_pos
 + 
desc_size
;

181 c⁄° 
__À32
 
desc_size_disk
 = 
	`˝u_to_À32
(
desc_size
);

182 c⁄° 
u64
 
desc_size_pos
 = 
	`round_up
(
desc_íd
 + (
desc_size_disk
),

183 
	`i_blocksize
(
öode
)) -

184 (
desc_size_disk
);

185 
îr
;

187 
îr
 = 
	`∑geˇche_wrôe
(
öode
, 
desc
, 
desc_size
, 
desc_pos
);

188 i‡(
îr
)

189  
îr
;

191  
	`∑geˇche_wrôe
(
öode
, &
desc_size_disk
, (desc_size_disk),

192 
desc_size_pos
);

193 
	}
}

195 
	$pxt4_íd_íabÀ_vîôy
(
fûe
 *
fûp
, c⁄° *
desc
,

196 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

198 
öode
 *öodê
	`fûe_öode
(
fûp
);

199 c⁄° 
¸edôs
 = 2;

200 
h™dÀ_t
 *
h™dÀ
;

201 
îr
 = 0;

202 
îr2
;

204 i‡(
desc
 !
NULL
) {

206 
îr
 = 
	`pxt4_wrôe_vîôy_des¸ùt‹
(
öode
, 
desc
, 
desc_size
,

207 
mîkÀ_åì_size
);

210 i‡(!
îr
)

211 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

215 i‡(
desc
 =
NULL
 || 
îr
)

216 
	`pxt4_åunˇã
(
öode
);

225 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

227 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

228 i‡(
	`IS_ERR
(
h™dÀ
)) {

229 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

230  
	`PTR_ERR
(
h™dÀ
);

233 
îr2
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

234 i‡(
îr2
)

235 
out_°›
;

237 i‡(
desc
 !
NULL
 && !
îr
) {

238 
pxt4_ûoc
 
ûoc
;

240 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

241 i‡(
îr
)

242 
out_°›
;

243 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
);

244 
	`pxt4_£t_öode_Êags
(
öode
);

245 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

247 
out_°›
:

248 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

249  
îr
 ?: 
îr2
;

250 
	}
}

252 
	$pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
 *inode,

253 
size_t
 *
desc_size_ªt
,

254 
u64
 *
desc_pos_ªt
)

256 
pxt4_ext_∑th
 *
∑th
;

257 
pxt4_exã¡
 *
œ°_exã¡
;

258 
u32
 
íd_lblk
;

259 
u64
 
desc_size_pos
;

260 
__À32
 
desc_size_disk
;

261 
u32
 
desc_size
;

262 
u64
 
desc_pos
;

263 
îr
;

270 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

271 
	`PXT4_ERROR_INODE
(
öode
, "verity file doesn't useÉxtents");

272  -
EFSCORRUPTED
;

275 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
, 0);

276 i‡(
	`IS_ERR
(
∑th
))

277  
	`PTR_ERR
(
∑th
);

279 
œ°_exã¡
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

280 i‡(!
œ°_exã¡
) {

281 
	`PXT4_ERROR_INODE
(
öode
, "verity file hasÇoÉxtents");

282 
	`pxt4_ext_dr›_ªfs
(
∑th
);

283 
	`k‰ì
(
∑th
);

284  -
EFSCORRUPTED
;

287 
íd_lblk
 = 
	`À32_to_˝u
(
œ°_exã¡
->
ì_block
) +

288 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_exã¡
);

289 
desc_size_pos
 = (
u64
)
íd_lblk
 << 
öode
->
i_blkbôs
;

290 
	`pxt4_ext_dr›_ªfs
(
∑th
);

291 
	`k‰ì
(
∑th
);

293 i‡(
desc_size_pos
 < (
desc_size_disk
))

294 
bad
;

295 
desc_size_pos
 -(
desc_size_disk
);

297 
îr
 = 
	`∑geˇche_ªad
(
öode
, &
desc_size_disk
, (desc_size_disk),

298 
desc_size_pos
);

299 i‡(
îr
)

300  
îr
;

301 
desc_size
 = 
	`À32_to_˝u
(
desc_size_disk
);

308 i‡(
desc_size
 > 
INT_MAX
 || desc_sizê> 
desc_size_pos
)

309 
bad
;

311 
desc_pos
 = 
	`round_down
(
desc_size_pos
 - 
desc_size
, 
	`i_blocksize
(
öode
));

312 i‡(
desc_pos
 < 
	`pxt4_vîôy_mëad©a_pos
(
öode
))

313 
bad
;

315 *
desc_size_ªt
 = 
desc_size
;

316 *
desc_pos_ªt
 = 
desc_pos
;

319 
bad
:

320 
	`PXT4_ERROR_INODE
(
öode
, "verity file corrupted; can't find descriptor");

321  -
EFSCORRUPTED
;

322 
	}
}

324 
	$pxt4_gë_vîôy_des¸ùt‹
(
öode
 *öode, *
buf
,

325 
size_t
 
buf_size
)

327 
size_t
 
desc_size
 = 0;

328 
u64
 
desc_pos
 = 0;

329 
îr
;

331 
îr
 = 
	`pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
, &
desc_size
, &
desc_pos
);

332 i‡(
îr
)

333  
îr
;

335 i‡(
buf_size
) {

336 i‡(
desc_size
 > 
buf_size
)

337  -
ERANGE
;

338 
îr
 = 
	`∑geˇche_ªad
(
öode
, 
buf
, 
desc_size
, 
desc_pos
);

339 i‡(
îr
)

340  
îr
;

342  
desc_size
;

343 
	}
}

345 
∑ge
 *
	$pxt4_ªad_mîkÀ_åì_∑ge
(
öode
 *inode,

346 
pgoff_t
 
ödex
)

348 
ödex
 +
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë>> 
PAGE_SHIFT
;

350  
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
ödex
, 
NULL
);

351 
	}
}

353 
	$pxt4_wrôe_mîkÀ_åì_block
(
öode
 *öode, c⁄° *
buf
,

354 
u64
 
ödex
, 
log_blocksize
)

356 
loff_t
 
pos
 = 
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë+ (
ödex
 << 
log_blocksize
);

358  
	`∑geˇche_wrôe
(
öode
, 
buf
, 1 << 
log_blocksize
, 
pos
);

359 
	}
}

361 c⁄° 
fsvîôy_›î©i⁄s
 
	gpxt4_vîôy›s
 = {

362 .
begö_íabÀ_vîôy
 = 
pxt4_begö_íabÀ_vîôy
,

363 .
	gíd_íabÀ_vîôy
 = 
pxt4_íd_íabÀ_vîôy
,

364 .
	ggë_vîôy_des¸ùt‹
 = 
pxt4_gë_vîôy_des¸ùt‹
,

365 .
	gªad_mîkÀ_åì_∑ge
 = 
pxt4_ªad_mîkÀ_åì_∑ge
,

366 .
	gwrôe_mîkÀ_åì_block
 = 
pxt4_wrôe_mîkÀ_åì_block
,

	@xattr.c

54 
	~<löux/öô.h
>

55 
	~<löux/fs.h
>

56 
	~<löux/¶ab.h
>

57 
	~<löux/mbˇche.h
>

58 
	~<löux/quŸa›s.h
>

59 
	~<löux/ivîsi⁄.h
>

60 
	~"pxt4_jbd3.h
"

61 
	~"pxt4.h
"

62 
	~"x©å.h
"

63 
	~"a˛.h
"

65 #ifde‡
PXT4_XATTR_DEBUG


66 
	#ó_idebug
(
öode
, 
fmt
, ...) \

67 
	`¥ötk
(
KERN_DEBUG
 "öodê%s:%lu: " 
fmt
 "\n", \

68 
öode
->
i_sb
->
s_id
, inode->
i_öo
, ##
__VA_ARGS__
)

	)

69 
	#ó_bdebug
(
bh
, 
fmt
, ...) \

70 
	`¥ötk
(
KERN_DEBUG
 "block %pg:%lu: " 
fmt
 "\n", \

71 
bh
->
b_bdev
, ()bh->
b_blockƒ
, ##
__VA_ARGS__
)

	)

73 
	#ó_idebug
(
öode
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

74 
	#ó_bdebug
(
bh
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

77 
pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *,

78 
buf„r_hód
 *);

79 
buf„r_hód
 *

80 
pxt4_x©å_block_ˇche_föd
(
öode
 *, 
pxt4_x©å_hódî
 *,

81 
mb_ˇche_íåy
 **);

82 
__À32
 
pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, __À32 *
vÆue
,

83 
size_t
 
vÆue_cou¡
);

84 
pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *);

86 c⁄° 
x©å_h™dÀr
 * c⁄° 
	gpxt4_x©å_h™dÀr_m≠
[] = {

87 [
PXT4_XATTR_INDEX_USER
] = &
pxt4_x©å_u£r_h™dÀr
,

88 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


89 [
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_a˛_ac˚ss_x©å_h™dÀr
,

90 [
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_a˛_deÁu…_x©å_h™dÀr
,

92 [
PXT4_XATTR_INDEX_TRUSTED
] = &
pxt4_x©å_åu°ed_h™dÀr
,

93 #ifde‡
CONFIG_PXT4_FS_SECURITY


94 [
PXT4_XATTR_INDEX_SECURITY
] = &
pxt4_x©å_£curôy_h™dÀr
,

98 c⁄° 
x©å_h™dÀr
 *
	gpxt4_x©å_h™dÀrs
[] = {

99 &
pxt4_x©å_u£r_h™dÀr
,

100 &
pxt4_x©å_åu°ed_h™dÀr
,

101 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


102 &
posix_a˛_ac˚ss_x©å_h™dÀr
,

103 &
posix_a˛_deÁu…_x©å_h™dÀr
,

105 #ifde‡
CONFIG_PXT4_FS_SECURITY


106 &
pxt4_x©å_£curôy_h™dÀr
,

108 
NULL


111 
	#EA_BLOCK_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

112 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_block_ˇche
)

	)

114 
	#EA_INODE_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

115 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_öode_ˇche
)

	)

118 
pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

119 
öode
 *inode);

121 #ifde‡
CONFIG_LOCKDEP


122 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
)

124 
	`lockdï_£t_sub˛ass
(&
ó_öode
->
i_rw£m
, 1);

125 
	}
}

128 
__À32
 
	$pxt4_x©å_block_csum
(
öode
 *inode,

129 
£˘‹_t
 
block_ƒ
,

130 
pxt4_x©å_hódî
 *
hdr
)

132 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

133 
__u32
 
csum
;

134 
__À64
 
dsk_block_ƒ
 = 
	`˝u_to_À64
(
block_ƒ
);

135 
__u32
 
dummy_csum
 = 0;

136 
off£t
 = 
	`off£tof
(
pxt4_x©å_hódî
, 
h_checksum
);

138 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
dsk_block_ƒ
,

139 (
dsk_block_ƒ
));

140 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
, 
off£t
);

141 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

142 
off£t
 +(
dummy_csum
);

143 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
 + 
off£t
,

144 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

146  
	`˝u_to_À32
(
csum
);

147 
	}
}

149 
	$pxt4_x©å_block_csum_vîify
(
öode
 *inode,

150 
buf„r_hód
 *
bh
)

152 
pxt4_x©å_hódî
 *
hdr
 = 
	`BHDR
(
bh
);

153 
ªt
 = 1;

155 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

156 
	`lock_buf„r
(
bh
);

157 
ªt
 = (
hdr
->
h_checksum
 =
	`pxt4_x©å_block_csum
(
öode
,

158 
bh
->
b_blockƒ
, 
hdr
));

159 
	`u∆ock_buf„r
(
bh
);

161  
ªt
;

162 
	}
}

164 
	$pxt4_x©å_block_csum_£t
(
öode
 *inode,

165 
buf„r_hód
 *
bh
)

167 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

168 
	`BHDR
(
bh
)->
h_checksum
 = 
	`pxt4_x©å_block_csum
(
öode
,

169 
bh
->
b_blockƒ
, 
	`BHDR
(bh));

170 
	}
}

172 
ölöe
 c⁄° 
x©å_h™dÀr
 *

173 
	$pxt4_x©å_h™dÀr
(
«me_ödex
)

175 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 = 
NULL
;

177 i‡(
«me_ödex
 > 0 &&Çame_ödex < 
	`ARRAY_SIZE
(
pxt4_x©å_h™dÀr_m≠
))

178 
h™dÀr
 = 
pxt4_x©å_h™dÀr_m≠
[
«me_ödex
];

179  
h™dÀr
;

180 
	}
}

183 
	$pxt4_x©å_check_íåõs
(
pxt4_x©å_íåy
 *
íåy
, *
íd
,

184 *
vÆue_°¨t
)

186 
pxt4_x©å_íåy
 *
e
 = 
íåy
;

189 !
	`IS_LAST_ENTRY
(
e
)) {

190 
pxt4_x©å_íåy
 *
√xt
 = 
	`PXT4_XATTR_NEXT
(
e
);

191 i‡((*)
√xt
 >
íd
)

192  -
EFSCORRUPTED
;

193 i‡(
	`°∫Àn
(
e
->
e_«me
,É->
e_«me_Àn
) !=É->e_name_len)

194  -
EFSCORRUPTED
;

195 
e
 = 
√xt
;

199 !
	`IS_LAST_ENTRY
(
íåy
)) {

200 
u32
 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

202 i‡(
size
 > 
PXT4_XATTR_SIZE_MAX
)

203  -
EFSCORRUPTED
;

205 i‡(
size
 !0 && 
íåy
->
e_vÆue_öum
 == 0) {

206 
u16
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

207 *
vÆue
;

215 i‡(
offs
 > 
íd
 - 
vÆue_°¨t
)

216  -
EFSCORRUPTED
;

217 
vÆue
 = 
vÆue_°¨t
 + 
offs
;

218 i‡(
vÆue
 < (*)
e
 + (
u32
) ||

219 
size
 > 
íd
 - 
vÆue
 ||

220 
	`PXT4_XATTR_SIZE
(
size
Ë> 
íd
 - 
vÆue
)

221  -
EFSCORRUPTED
;

223 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry);

227 
	}
}

229 
ölöe
 

230 
	$__pxt4_x©å_check_block
(
öode
 *öode, 
buf„r_hód
 *
bh
,

231 c⁄° *
fun˘i⁄
, 
löe
)

233 
îr‹
 = -
EFSCORRUPTED
;

235 i‡(
	`BHDR
(
bh
)->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
) ||

236 
	`BHDR
(
bh
)->
h_blocks
 !
	`˝u_to_À32
(1))

237 
îrout
;

238 i‡(
	`buf„r_vîifõd
(
bh
))

241 
îr‹
 = -
EFSBADCRC
;

242 i‡(!
	`pxt4_x©å_block_csum_vîify
(
öode
, 
bh
))

243 
îrout
;

244 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`BFIRST
(
bh
), bh->
b_d©a
 + bh->
b_size
,

245 
bh
->
b_d©a
);

246 
îrout
:

247 i‡(
îr‹
)

248 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

250 (Ë
bh
->
b_blockƒ
);

252 
	`£t_buf„r_vîifõd
(
bh
);

253  
îr‹
;

254 
	}
}

256 
	#pxt4_x©å_check_block
(
öode
, 
bh
) \

257 
	`__pxt4_x©å_check_block
((
öode
), (
bh
), 
__func__
, 
__LINE__
)

	)

261 
	$__x©å_check_öode
(
öode
 *öode, 
pxt4_x©å_ibody_hódî
 *
hódî
,

262 *
íd
, c⁄° *
fun˘i⁄
, 
löe
)

264 
îr‹
 = -
EFSCORRUPTED
;

266 i‡(
íd
 - (*)
hódî
 < (*hódîË+ (
u32
) ||

267 (
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)))

268 
îrout
;

269 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`IFIRST
(
hódî
), 
íd
, IFIRST(header));

270 
îrout
:

271 i‡(
îr‹
)

272 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

274  
îr‹
;

275 
	}
}

277 
	#x©å_check_öode
(
öode
, 
hódî
, 
íd
) \

278 
	`__x©å_check_öode
((
öode
), (
hódî
), (
íd
), 
__func__
, 
__LINE__
)

	)

281 
	$x©å_föd_íåy
(
öode
 *öode, 
pxt4_x©å_íåy
 **
≥¡ry
,

282 *
íd
, 
«me_ödex
, c⁄° *
«me
, 
s‹ãd
)

284 
pxt4_x©å_íåy
 *
íåy
, *
√xt
;

285 
size_t
 
«me_Àn
;

286 
cmp
 = 1;

288 i‡(
«me
 =
NULL
)

289  -
EINVAL
;

290 
«me_Àn
 = 
	`°æí
(
«me
);

291 
íåy
 = *
≥¡ry
; !
	`IS_LAST_ENTRY
”¡ry);É¡ry = 
√xt
) {

292 
√xt
 = 
	`PXT4_XATTR_NEXT
(
íåy
);

293 i‡((*Ë
√xt
 >
íd
) {

294 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

295  -
EFSCORRUPTED
;

297 
cmp
 = 
«me_ödex
 - 
íåy
->
e_«me_ödex
;

298 i‡(!
cmp
)

299 
cmp
 = 
«me_Àn
 - 
íåy
->
e_«me_Àn
;

300 i‡(!
cmp
)

301 
cmp
 = 
	`memcmp
(
«me
, 
íåy
->
e_«me
, 
«me_Àn
);

302 i‡(
cmp
 <0 && (
s‹ãd
 || cmp == 0))

305 *
≥¡ry
 = 
íåy
;

306  
cmp
 ? -
ENODATA
 : 0;

307 
	}
}

309 
u32


310 
	$pxt4_x©å_öode_hash
(
pxt4_sb_öfo
 *
sbi
, c⁄° *
buf„r
, 
size_t
 
size
)

312  
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, 
buf„r
, 
size
);

313 
	}
}

315 
u64
 
	$pxt4_x©å_öode_gë_ªf
(
öode
 *
ó_öode
)

317  ((
u64
)
ó_öode
->
i_˘ime
.
tv_£c
 << 32) |

318 (
u32
Ë
	`öode_≥ek_ivîsi⁄_øw
(
ó_öode
);

319 
	}
}

321 
	$pxt4_x©å_öode_£t_ªf
(
öode
 *
ó_öode
, 
u64
 
ªf_cou¡
)

323 
ó_öode
->
i_˘ime
.
tv_£c
 = (
u32
)(
ªf_cou¡
 >> 32);

324 
	`öode_£t_ivîsi⁄_øw
(
ó_öode
, 
ªf_cou¡
 & 0xffffffff);

325 
	}
}

327 
u32
 
	$pxt4_x©å_öode_gë_hash
(
öode
 *
ó_öode
)

329  (
u32
)
ó_öode
->
i_©ime
.
tv_£c
;

330 
	}
}

332 
	$pxt4_x©å_öode_£t_hash
(
öode
 *
ó_öode
, 
u32
 
hash
)

334 
ó_öode
->
i_©ime
.
tv_£c
 = 
hash
;

335 
	}
}

340 
	$pxt4_x©å_öode_ªad
(
öode
 *
ó_öode
, *
buf
, 
size_t
 
size
)

342 
blocksize
 = 1 << 
ó_öode
->
i_blkbôs
;

343 
bh_cou¡
 = (
size
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

344 
èû_size
 = (
size
 % 
blocksize
) ?: blocksize;

345 
buf„r_hód
 *
bhs_ölöe
[8];

346 
buf„r_hód
 **
bhs
 = 
bhs_ölöe
;

347 
i
, 
ªt
;

349 i‡(
bh_cou¡
 > 
	`ARRAY_SIZE
(
bhs_ölöe
)) {

350 
bhs
 = 
	`kmÆloc_¨øy
(
bh_cou¡
, (*bhs), 
GFP_NOFS
);

351 i‡(!
bhs
)

352  -
ENOMEM
;

355 
ªt
 = 
	`pxt4_bªad_b©ch
(
ó_öode
, 0 , 
bh_cou¡
,

356 
åue
 , 
bhs
);

357 i‡(
ªt
)

358 
‰ì_bhs
;

360 
i
 = 0; i < 
bh_cou¡
; i++) {

362 i‡(!
bhs
[
i
]) {

363 
ªt
 = -
EFSCORRUPTED
;

364 
put_bhs
;

366 
	`mem˝y
((*)
buf
 + 
blocksize
 * 
i
, 
bhs
[i]->
b_d©a
,

367 
i
 < 
bh_cou¡
 - 1 ? 
blocksize
 : 
èû_size
);

369 
ªt
 = 0;

370 
put_bhs
:

371 
i
 = 0; i < 
bh_cou¡
; i++)

372 
	`bªl£
(
bhs
[
i
]);

373 
‰ì_bhs
:

374 i‡(
bhs
 !
bhs_ölöe
)

375 
	`k‰ì
(
bhs
);

376  
ªt
;

377 
	}
}

379 
	#PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë((
__u32
)(öode)->
i_mtime
.
tv_£c
)

	)

381 
	$pxt4_x©å_öode_igë
(
öode
 *
∑ª¡
, 
ó_öo
,

382 
u32
 
ó_öode_hash
, 
öode
 **
ó_öode
)

384 
öode
 *inode;

385 
îr
;

387 
öode
 = 
	`pxt4_igë
(
∑ª¡
->
i_sb
, 
ó_öo
, 
PXT4_IGET_NORMAL
);

388 i‡(
	`IS_ERR
(
öode
)) {

389 
îr
 = 
	`PTR_ERR
(
öode
);

390 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

391 "îr‹ whûêªadög EA inodê%luÉº=%d", 
ó_öo
,

392 
îr
);

393  
îr
;

396 i‡(
	`is_bad_öode
(
öode
)) {

397 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

399 
ó_öo
);

400 
îr
 = -
EIO
;

401 
îr‹
;

404 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

405 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

407 
ó_öo
);

408 
îr
 = -
EINVAL
;

409 
îr‹
;

412 
	`pxt4_x©å_öode_£t_˛ass
(
öode
);

419 i‡(
ó_öode_hash
 !
	`pxt4_x©å_öode_gë_hash
(
öode
) &&

420 
	`PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë=
∑ª¡
->
i_öo
 &&

421 
öode
->
i_gíî©i⁄
 =
∑ª¡
->i_generation) {

422 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_LUSTRE_EA_INODE
);

423 
	`pxt4_x©å_öode_£t_ªf
(
öode
, 1);

425 
	`öode_lock
(
öode
);

426 
öode
->
i_Êags
 |
S_NOQUOTA
;

427 
	`öode_u∆ock
(
öode
);

430 *
ó_öode
 = 
öode
;

432 
îr‹
:

433 
	`ùut
(
öode
);

434  
îr
;

435 
	}
}

438 
	$pxt4_x©å_öode_vîify_hashes
(
öode
 *
ó_öode
,

439 
pxt4_x©å_íåy
 *
íåy
, *
buf„r
,

440 
size_t
 
size
)

442 
u32
 
hash
;

445 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
ó_öode
->
i_sb
), 
buf„r
, 
size
);

446 i‡(
hash
 !
	`pxt4_x©å_öode_gë_hash
(
ó_öode
))

447  -
EFSCORRUPTED
;

449 i‡(
íåy
) {

450 
__À32
 
e_hash
, 
tmp_d©a
;

453 
tmp_d©a
 = 
	`˝u_to_À32
(
hash
);

454 
e_hash
 = 
	`pxt4_x©å_hash_íåy
(
íåy
->
e_«me
,É¡ry->
e_«me_Àn
,

455 &
tmp_d©a
, 1);

456 i‡(
e_hash
 !
íåy
->e_hash)

457  -
EFSCORRUPTED
;

460 
	}
}

466 
	$pxt4_x©å_öode_gë
(
öode
 *öode, 
pxt4_x©å_íåy
 *
íåy
,

467 *
buf„r
, 
size_t
 
size
)

469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

470 
öode
 *
ó_öode
;

471 
îr
;

473 
îr
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

474 
	`À32_to_˝u
(
íåy
->
e_hash
), &
ó_öode
);

475 i‡(
îr
) {

476 
ó_öode
 = 
NULL
;

477 
out
;

480 i‡(
	`i_size_ªad
(
ó_öode
Ë!
size
) {

481 
	`pxt4_w¨nög_öode
(
ó_öode
,

483 
	`i_size_ªad
(
ó_öode
), 
size
);

484 
îr
 = -
EFSCORRUPTED
;

485 
out
;

488 
îr
 = 
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
buf„r
, 
size
);

489 i‡(
îr
)

490 
out
;

492 i‡(!
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
)) {

493 
îr
 = 
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
íåy
, 
buf„r
,

494 
size
);

495 i‡(
îr
) {

496 
	`pxt4_w¨nög_öode
(
ó_öode
,

498 
out
;

501 i‡(
ó_öode_ˇche
)

502 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
, 
GFP_NOFS
,

503 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
),

504 
ó_öode
->
i_öo
, 
åue
 );

506 
out
:

507 
	`ùut
(
ó_öode
);

508  
îr
;

509 
	}
}

512 
	$pxt4_x©å_block_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

513 *
buf„r
, 
size_t
 
buf„r_size
)

515 
buf„r_hód
 *
bh
 = 
NULL
;

516 
pxt4_x©å_íåy
 *
íåy
;

517 
size_t
 
size
;

518 *
íd
;

519 
îr‹
;

520 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

522 
	`ó_idebug
(
öode
, "name=%d.%s, buffer=%p, buffer_size=%ld",

523 
«me_ödex
, 
«me
, 
buf„r
, ()
buf„r_size
);

525 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

526  -
ENODATA
;

527 
	`ó_idebug
(
öode
, "reading block %llu",

528 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

529 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

530 i‡(
	`IS_ERR
(
bh
))

531  
	`PTR_ERR
(
bh
);

532 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

533 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

534 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

535 i‡(
îr‹
)

536 
˛ónup
;

537 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bh
);

538 
íåy
 = 
	`BFIRST
(
bh
);

539 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

540 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 1);

541 i‡(
îr‹
)

542 
˛ónup
;

543 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

544 
îr‹
 = -
ERANGE
;

545 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

546 
˛ónup
;

547 i‡(
buf„r
) {

548 i‡(
size
 > 
buf„r_size
)

549 
˛ónup
;

550 i‡(
íåy
->
e_vÆue_öum
) {

551 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

552 
size
);

553 i‡(
îr‹
)

554 
˛ónup
;

556 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

557 *
p
 = 
bh
->
b_d©a
 + 
off£t
;

559 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

560 
˛ónup
;

561 
	`mem˝y
(
buf„r
, 
p
, 
size
);

564 
îr‹
 = 
size
;

566 
˛ónup
:

567 
	`bªl£
(
bh
);

568  
îr‹
;

569 
	}
}

572 
	$pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

573 *
buf„r
, 
size_t
 
buf„r_size
)

575 
pxt4_x©å_ibody_hódî
 *
hódî
;

576 
pxt4_x©å_íåy
 *
íåy
;

577 
pxt4_öode
 *
øw_öode
;

578 
pxt4_ûoc
 
ûoc
;

579 
size_t
 
size
;

580 *
íd
;

581 
îr‹
;

583 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

584  -
ENODATA
;

585 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

586 i‡(
îr‹
)

587  
îr‹
;

588 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

589 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

590 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

591 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

592 i‡(
îr‹
)

593 
˛ónup
;

594 
íåy
 = 
	`IFIRST
(
hódî
);

595 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 0);

596 i‡(
îr‹
)

597 
˛ónup
;

598 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

599 
îr‹
 = -
ERANGE
;

600 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

601 
˛ónup
;

602 i‡(
buf„r
) {

603 i‡(
size
 > 
buf„r_size
)

604 
˛ónup
;

605 i‡(
íåy
->
e_vÆue_öum
) {

606 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

607 
size
);

608 i‡(
îr‹
)

609 
˛ónup
;

611 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

612 *
p
 = (*)
	`IFIRST
(
hódî
Ë+ 
off£t
;

614 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

615 
˛ónup
;

616 
	`mem˝y
(
buf„r
, 
p
, 
size
);

619 
îr‹
 = 
size
;

621 
˛ónup
:

622 
	`bªl£
(
ûoc
.
bh
);

623  
îr‹
;

624 
	}
}

637 
	$pxt4_x©å_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

638 *
buf„r
, 
size_t
 
buf„r_size
)

640 
îr‹
;

642 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

643  -
EIO
;

645 i‡(
	`°æí
(
«me
) > 255)

646  -
ERANGE
;

648 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

649 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

650 
buf„r_size
);

651 i‡(
îr‹
 =-
ENODATA
)

652 
îr‹
 = 
	`pxt4_x©å_block_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

653 
buf„r_size
);

654 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

655  
îr‹
;

656 
	}
}

659 
	$pxt4_x©å_li°_íåõs
(
díåy
 *díåy, 
pxt4_x©å_íåy
 *
íåy
,

660 *
buf„r
, 
size_t
 
buf„r_size
)

662 
size_t
 
ª°
 = 
buf„r_size
;

664 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

665 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 =

666 
	`pxt4_x©å_h™dÀr
(
íåy
->
e_«me_ödex
);

668 i‡(
h™dÀr
 && (!h™dÀr->
li°
 || h™dÀr->
	`li°
(
díåy
))) {

669 c⁄° *
¥efix
 = 
h™dÀr
->¥efix ?: h™dÀr->
«me
;

670 
size_t
 
¥efix_Àn
 = 
	`°æí
(
¥efix
);

671 
size_t
 
size
 = 
¥efix_Àn
 + 
íåy
->
e_«me_Àn
 + 1;

673 i‡(
buf„r
) {

674 i‡(
size
 > 
ª°
)

675  -
ERANGE
;

676 
	`mem˝y
(
buf„r
, 
¥efix
, 
¥efix_Àn
);

677 
buf„r
 +
¥efix_Àn
;

678 
	`mem˝y
(
buf„r
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

679 
buf„r
 +
íåy
->
e_«me_Àn
;

680 *
buf„r
++ = 0;

682 
ª°
 -
size
;

685  
buf„r_size
 - 
ª°
;

686 
	}
}

689 
	$pxt4_x©å_block_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

691 
öode
 *öodê
	`d_öode
(
díåy
);

692 
buf„r_hód
 *
bh
 = 
NULL
;

693 
îr‹
;

695 
	`ó_idebug
(
öode
, "buffer=%p, buffer_size=%ld",

696 
buf„r
, ()
buf„r_size
);

698 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

700 
	`ó_idebug
(
öode
, "reading block %llu",

701 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

702 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

703 i‡(
	`IS_ERR
(
bh
))

704  
	`PTR_ERR
(
bh
);

705 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

706 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

707 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

708 i‡(
îr‹
)

709 
˛ónup
;

710 
	`pxt4_x©å_block_ˇche_ö£π
(
	`EA_BLOCK_CACHE
(
öode
), 
bh
);

711 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`BFIRST
(
bh
), 
buf„r
,

712 
buf„r_size
);

713 
˛ónup
:

714 
	`bªl£
(
bh
);

715  
îr‹
;

716 
	}
}

719 
	$pxt4_x©å_ibody_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

721 
öode
 *öodê
	`d_öode
(
díåy
);

722 
pxt4_x©å_ibody_hódî
 *
hódî
;

723 
pxt4_öode
 *
øw_öode
;

724 
pxt4_ûoc
 
ûoc
;

725 *
íd
;

726 
îr‹
;

728 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

730 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

731 i‡(
îr‹
)

732  
îr‹
;

733 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

734 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

735 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

736 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

737 i‡(
îr‹
)

738 
˛ónup
;

739 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`IFIRST
(
hódî
),

740 
buf„r
, 
buf„r_size
);

742 
˛ónup
:

743 
	`bªl£
(
ûoc
.
bh
);

744  
îr‹
;

745 
	}
}

759 
ssize_t


760 
	$pxt4_li°x©å
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

762 
ªt
, 
ªt2
;

764 
	`down_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

765 
ªt
 = 
ªt2
 = 
	`pxt4_x©å_ibody_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

766 i‡(
ªt
 < 0)

767 
îrout
;

768 i‡(
buf„r
) {

769 
buf„r
 +
ªt
;

770 
buf„r_size
 -
ªt
;

772 
ªt
 = 
	`pxt4_x©å_block_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

773 i‡(
ªt
 < 0)

774 
îrout
;

775 
ªt
 +
ªt2
;

776 
îrout
:

777 
	`up_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

778  
ªt
;

779 
	}
}

785 
	$pxt4_x©å_upd©e_su≥r_block
(
h™dÀ_t
 *
h™dÀ
,

786 
su≥r_block
 *
sb
)

788 i‡(
	`pxt4_has_„©uª_x©å
(
sb
))

791 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

792 i‡(
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
) == 0) {

793 
	`pxt4_£t_„©uª_x©å
(
sb
);

794 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

796 
	}
}

798 
	$pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
)

800 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

801 
buf„r_hód
 *
bh
 = 
NULL
;

802 
pxt4_öode
 *
øw_öode
;

803 
pxt4_x©å_ibody_hódî
 *
hódî
;

804 
pxt4_x©å_íåy
 *
íåy
;

805 
qsize_t
 
ó_öode_ªfs
 = 0;

806 *
íd
;

807 
ªt
;

809 
	`lockdï_as£π_hñd_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

811 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

812 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

813 i‡(
ªt
)

814 
out
;

815 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

816 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

817 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

818 
ªt
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

819 i‡(
ªt
)

820 
out
;

822 
íåy
 = 
	`IFIRST
(
hódî
); !
	`IS_LAST_ENTRY
(entry);

823 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

824 i‡(
íåy
->
e_vÆue_öum
)

825 
ó_öode_ªfs
++;

828 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

829 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

830 i‡(
	`IS_ERR
(
bh
)) {

831 
ªt
 = 
	`PTR_ERR
(
bh
);

832 
bh
 = 
NULL
;

833 
out
;

836 
ªt
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

837 i‡(
ªt
)

838 
out
;

840 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

841 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

842 i‡(
íåy
->
e_vÆue_öum
)

843 
ó_öode_ªfs
++;

845 *
ußge
 = 
ó_öode_ªfs
 + 1;

846 
ªt
 = 0;

847 
out
:

848 
	`bªl£
(
ûoc
.
bh
);

849 
	`bªl£
(
bh
);

850  
ªt
;

851 
	}
}

853 
ölöe
 
size_t
 
	$round_up_˛u°î
(
öode
 *öode, 
size_t
 
Àngth
)

855 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

856 
size_t
 
˛u°î_size
 = 1 << (
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
 +

857 
öode
->
i_blkbôs
);

858 
size_t
 
mask
 = ~(
˛u°î_size
 - 1);

860  (
Àngth
 + 
˛u°î_size
 - 1Ë& 
mask
;

861 
	}
}

863 
	$pxt4_x©å_öode_Æloc_quŸa
(
öode
 *öode, 
size_t
 
Àn
)

865 
îr
;

867 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

868 i‡(
îr
)

869  
îr
;

870 
îr
 = 
	`dquŸ_Æloc_•a˚_nodúty
(
öode
, 
	`round_up_˛u°î
(öode, 
Àn
));

871 i‡(
îr
)

872 
	`dquŸ_‰ì_öode
(
öode
);

873  
îr
;

874 
	}
}

876 
	$pxt4_x©å_öode_‰ì_quŸa
(
öode
 *
∑ª¡
,

877 
öode
 *
ó_öode
,

878 
size_t
 
Àn
)

880 i‡(
ó_öode
 &&

881 
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
))

883 
	`dquŸ_‰ì_•a˚_nodúty
(
∑ª¡
, 
	`round_up_˛u°î
’¨ít, 
Àn
));

884 
	`dquŸ_‰ì_öode
(
∑ª¡
);

885 
	}
}

887 
	$__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

888 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

889 
boﬁ
 
is_¸óã
)

891 
¸edôs
;

892 
blocks
;

907 
¸edôs
 = 7;

910 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
);

916 i‡(
öode
 && 
	`pxt4_has_ölöe_d©a
(inode))

917 
¸edôs
 +
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

920 i‡(!
	`pxt4_has_„©uª_ó_öode
(
sb
))

921  
¸edôs
;

924 
¸edôs
 += 4;

927 
blocks
 = (
vÆue_Àn
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

930 
blocks
 += 1;

933 
¸edôs
 +
blocks
 * 2;

936 
¸edôs
 +
blocks
;

938 i‡(!
is_¸óã
) {

942 
¸edôs
 += 4;

945 
blocks
 = 
XATTR_SIZE_MAX
 >> 
sb
->
s_blocksize_bôs
;

950 
blocks
 += 1;

953 
¸edôs
 +
blocks
 * 2;

959 i‡(
block_bh
) {

960 
pxt4_x©å_íåy
 *
íåy
 = 
	`BFIRST
(
block_bh
);

962 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry))

963 i‡(
íåy
->
e_vÆue_öum
)

965 
¸edôs
 += 1;

967  
¸edôs
;

968 
	}
}

970 
	$pxt4_x©å_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

971 
¸edôs
, 
buf„r_hód
 *
bh
,

972 
boﬁ
 
dúty
, boﬁ 
block_csum
)

974 
îr‹
;

976 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

979 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
¸edôs
)

982 
îr‹
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
¸edôs
 - h™dÀ->
h_buf„r_¸edôs
);

983 i‡(!
îr‹
)

985 i‡(
îr‹
 < 0) {

986 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Exãnd jou∫Æ (îr‹ %d)", 
îr‹
);

987  
îr‹
;

990 i‡(
bh
 && 
dúty
) {

991 i‡(
block_csum
)

992 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

993 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

994 i‡(
îr‹
) {

995 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Handle metadata (error %d)",

996 
îr‹
);

997  
îr‹
;

1001 
îr‹
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
¸edôs
);

1002 i‡(
îr‹
) {

1003 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Re°¨àjou∫Æ (îr‹ %d)", 
îr‹
);

1004  
îr‹
;

1007 i‡(
bh
) {

1008 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1009 i‡(
îr‹
) {

1010 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1012 
îr‹
);

1013  
îr‹
;

1017 
	}
}

1019 
	$pxt4_x©å_öode_upd©e_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1020 
ªf_ch™ge
)

1022 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
ó_öode
);

1023 
pxt4_ûoc
 
ûoc
;

1024 
s64
 
ªf_cou¡
;

1025 
u32
 
hash
;

1026 
ªt
;

1028 
	`öode_lock
(
ó_öode
);

1030 
ªt
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1031 i‡(
ªt
)

1032 
out
;

1034 
ªf_cou¡
 = 
	`pxt4_x©å_öode_gë_ªf
(
ó_öode
);

1035 
ªf_cou¡
 +
ªf_ch™ge
;

1036 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 
ªf_cou¡
);

1038 i‡(
ªf_ch™ge
 > 0) {

1039 
	`WARN_ONCE
(
ªf_cou¡
 <= 0, "EA inode %luÑef_count=%lld",

1040 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1042 i‡(
ªf_cou¡
 == 1) {

1043 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
, "EA inode %lu i_nlink=%u",

1044 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1046 
	`£t_∆ök
(
ó_öode
, 1);

1047 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
ó_öode
);

1049 i‡(
ó_öode_ˇche
) {

1050 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1051 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
,

1052 
GFP_NOFS
, 
hash
,

1053 
ó_öode
->
i_öo
,

1054 
åue
 );

1058 
	`WARN_ONCE
(
ªf_cou¡
 < 0, "EA inode %luÑef_count=%lld",

1059 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1061 i‡(
ªf_cou¡
 == 0) {

1062 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
 != 1,

1064 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1066 
	`˛ór_∆ök
(
ó_öode
);

1067 
	`pxt4_‹ph™_add
(
h™dÀ
, 
ó_öode
);

1069 i‡(
ó_öode_ˇche
) {

1070 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1071 
	`mb_ˇche_íåy_dñëe
(
ó_öode_ˇche
, 
hash
,

1072 
ó_öode
->
i_öo
);

1077 
ªt
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1078 i‡(
ªt
)

1079 
	`pxt4_w¨nög_öode
(
ó_öode
,

1080 "pxt4_m¨k_ûoc_dúty(ËÁûedÑë=%d", 
ªt
);

1081 
out
:

1082 
	`öode_u∆ock
(
ó_öode
);

1083  
ªt
;

1084 
	}
}

1086 
	$pxt4_x©å_öode_öc_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1088  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, 1);

1089 
	}
}

1091 
	$pxt4_x©å_öode_dec_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1093  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, -1);

1094 
	}
}

1096 
	$pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1097 
pxt4_x©å_íåy
 *
fú°
)

1099 
öode
 *
ó_öode
;

1100 
pxt4_x©å_íåy
 *
íåy
;

1101 
pxt4_x©å_íåy
 *
Áûed_íåy
;

1102 
ó_öo
;

1103 
îr
, 
ßved_îr
;

1105 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1106 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1107 i‡(!
íåy
->
e_vÆue_öum
)

1109 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1110 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1111 
	`À32_to_˝u
(
íåy
->
e_hash
),

1112 &
ó_öode
);

1113 i‡(
îr
)

1114 
˛ónup
;

1115 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1116 i‡(
îr
) {

1117 
	`pxt4_w¨nög_öode
(
ó_öode
, "ö¯ª‡îr‹ %d", 
îr
);

1118 
	`ùut
(
ó_öode
);

1119 
˛ónup
;

1121 
	`ùut
(
ó_öode
);

1125 
˛ónup
:

1126 
ßved_îr
 = 
îr
;

1127 
Áûed_íåy
 = 
íåy
;

1129 
íåy
 = 
fú°
;É¡ry !
Áûed_íåy
;

1130 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1131 i‡(!
íåy
->
e_vÆue_öum
)

1133 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1134 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1135 
	`À32_to_˝u
(
íåy
->
e_hash
),

1136 &
ó_öode
);

1137 i‡(
îr
) {

1138 
	`pxt4_w¨nög
(
∑ª¡
->
i_sb
,

1139 "˛ónu∞ó_öÿ%u igëÉº‹ %d", 
ó_öo
,

1140 
îr
);

1143 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1144 i‡(
îr
)

1145 
	`pxt4_w¨nög_öode
(
ó_öode
, "cleanup decÑefÉrror %d",

1146 
îr
);

1147 
	`ùut
(
ó_öode
);

1149  
ßved_îr
;

1150 
	}
}

1153 
	$pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1154 
buf„r_hód
 *
bh
,

1155 
pxt4_x©å_íåy
 *
fú°
, 
boﬁ
 
block_csum
,

1156 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1157 
exåa_¸edôs
, 
boﬁ
 
skù_quŸa
)

1159 
öode
 *
ó_öode
;

1160 
pxt4_x©å_íåy
 *
íåy
;

1161 
boﬁ
 
dúty
 = 
Ál£
;

1162 
ó_öo
;

1163 
îr
;

1164 
¸edôs
;

1167 
¸edôs
 = 2 + 
exåa_¸edôs
;

1169 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1170 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1171 i‡(!
íåy
->
e_vÆue_öum
)

1173 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1174 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1175 
	`À32_to_˝u
(
íåy
->
e_hash
),

1176 &
ó_öode
);

1177 i‡(
îr
)

1180 
îr
 = 
	`pxt4_ex∑nd_öode_¨øy
(
ó_öode_¨øy
, 
ó_öode
);

1181 i‡(
îr
) {

1182 
	`pxt4_w¨nög_öode
(
ó_öode
,

1183 "Ex∑nd inodê¨øyÉº=%d", 
îr
);

1184 
	`ùut
(
ó_öode
);

1188 
îr
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
∑ª¡
, 
¸edôs
, 
bh
,

1189 
dúty
, 
block_csum
);

1190 i‡(
îr
) {

1191 
	`pxt4_w¨nög_öode
(
ó_öode
, "Ensure creditsÉrr=%d",

1192 
îr
);

1196 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1197 i‡(
îr
) {

1198 
	`pxt4_w¨nög_öode
(
ó_öode
, "ea_inode decÑefÉrr=%d",

1199 
îr
);

1203 i‡(!
skù_quŸa
)

1204 
	`pxt4_x©å_öode_‰ì_quŸa
(
∑ª¡
, 
ó_öode
,

1205 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

1213 
íåy
->
e_vÆue_öum
 = 0;

1214 
íåy
->
e_vÆue_size
 = 0;

1216 
dúty
 = 
åue
;

1219 i‡(
dúty
) {

1226 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1227 i‡(
îr
)

1228 
	`pxt4_w¨nög_öode
(
∑ª¡
,

1229 "h™dÀ dúty mëad©®îr=%d", 
îr
);

1231 
	}
}

1238 
	$pxt4_x©å_ªÀa£_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1239 
buf„r_hód
 *
bh
,

1240 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1241 
exåa_¸edôs
)

1243 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1244 
u32
 
hash
, 
ªf
;

1245 
îr‹
 = 0;

1247 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1248 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1249 i‡(
îr‹
)

1250 
out
;

1252 
	`lock_buf„r
(
bh
);

1253 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_hash
);

1254 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
);

1255 i‡(
ªf
 == 1) {

1256 
	`ó_bdebug
(
bh
, "refcountÇow=0; freeing");

1261 i‡(
ó_block_ˇche
)

1262 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1263 
bh
->
b_blockƒ
);

1264 
	`gë_bh
(
bh
);

1265 
	`u∆ock_buf„r
(
bh
);

1267 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
))

1268 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
bh
,

1269 
	`BFIRST
(
bh
),

1270 
åue
 ,

1271 
ó_öode_¨øy
,

1272 
exåa_¸edôs
,

1273 
åue
 );

1274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
bh
, 0, 1,

1275 
PXT4_FREE_BLOCKS_METADATA
 |

1276 
PXT4_FREE_BLOCKS_FORGET
);

1278 
ªf
--;

1279 
	`BHDR
(
bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

1280 i‡(
ªf
 =
PXT4_XATTR_REFCOUNT_MAX
 - 1) {

1281 
mb_ˇche_íåy
 *
˚
;

1283 i‡(
ó_block_ˇche
) {

1284 
˚
 = 
	`mb_ˇche_íåy_gë
(
ó_block_ˇche
, 
hash
,

1285 
bh
->
b_blockƒ
);

1286 i‡(
˚
) {

1287 
˚
->
e_ªußbÀ
 = 1;

1288 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

1293 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

1304 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1305 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1306 
	`u∆ock_buf„r
(
bh
);

1307 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1308 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1309 i‡(
	`IS_SYNC
(
öode
))

1310 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1311 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(öode->
i_sb
), 1));

1312 
	`ó_bdebug
(
bh
, "refcountÇow=%d;Ñeleasing",

1313 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
));

1315 
out
:

1316 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

1318 
	}
}

1324 
size_t
 
	$pxt4_x©å_‰ì_•a˚
(
pxt4_x©å_íåy
 *
œ°
,

1325 
size_t
 *
mö_offs
, *
ba£
, *
tŸÆ
)

1327 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

1328 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1329 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1330 i‡(
offs
 < *
mö_offs
)

1331 *
mö_offs
 = 
offs
;

1333 i‡(
tŸÆ
)

1334 *
tŸÆ
 +
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

1336  (*
mö_offs
 - ((*)
œ°
 - 
ba£
Ë- (
__u32
));

1337 
	}
}

1342 
	$pxt4_x©å_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1343 c⁄° *
buf
, 
bufsize
)

1345 
buf„r_hód
 *
bh
 = 
NULL
;

1346 
block
 = 0;

1347 
blocksize
 = 
ó_öode
->
i_sb
->
s_blocksize
;

1348 
max_blocks
 = (
bufsize
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

1349 
csize
, 
wsize
 = 0;

1350 
ªt
 = 0;

1351 
ªåõs
 = 0;

1353 
ªåy
:

1354 
ªt
 >0 &&Ñë < 
max_blocks
) {

1355 
pxt4_m≠_blocks
 
m≠
;

1356 
m≠
.
m_lblk
 = 
block
 +
ªt
;

1357 
m≠
.
m_Àn
 = 
max_blocks
 -
ªt
;

1359 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
ó_öode
, &
m≠
,

1360 
PXT4_GET_BLOCKS_CREATE
);

1361 i‡(
ªt
 <= 0) {

1362 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1363 i‡(
ªt
 =-
ENOSPC
 &&

1364 
	`pxt4_should_ªåy_Æloc
(
ó_öode
->
i_sb
, &
ªåõs
)) {

1365 
ªt
 = 0;

1366 
ªåy
;

1372 i‡(
ªt
 < 0)

1373  
ªt
;

1375 
block
 = 0;

1376 
wsize
 < 
bufsize
) {

1377 i‡(
bh
 !
NULL
)

1378 
	`bªl£
(
bh
);

1379 
csize
 = (
bufsize
 - 
wsize
Ë> 
blocksize
 ? blocksize :

1380 
bufsize
 - 
wsize
;

1381 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
ó_öode
, 
block
, 0);

1382 i‡(
	`IS_ERR
(
bh
))

1383  
	`PTR_ERR
(
bh
);

1384 i‡(!
bh
) {

1385 
	`WARN_ON_ONCE
(1);

1386 
	`PXT4_ERROR_INODE
(
ó_öode
,

1388  -
EFSCORRUPTED
;

1390 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1391 i‡(
ªt
)

1392 
out
;

1394 
	`mem˝y
(
bh
->
b_d©a
, 
buf
, 
csize
);

1395 
	`£t_buf„r_u±od©e
(
bh
);

1396 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
ó_öode
, 
bh
);

1398 
buf
 +
csize
;

1399 
wsize
 +
csize
;

1400 
block
 += 1;

1403 
	`öode_lock
(
ó_öode
);

1404 
	`i_size_wrôe
(
ó_öode
, 
wsize
);

1405 
	`pxt4_upd©e_i_disksize
(
ó_öode
, 
wsize
);

1406 
	`öode_u∆ock
(
ó_öode
);

1408 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1410 
out
:

1411 
	`bªl£
(
bh
);

1413  
ªt
;

1414 
	}
}

1419 
öode
 *
	$pxt4_x©å_öode_¸óã
(
h™dÀ_t
 *
h™dÀ
,

1420 
öode
 *öode, 
u32
 
hash
)

1422 
öode
 *
ó_öode
 = 
NULL
;

1423 
uid_t
 
ow√r
[2] = { 
	`i_uid_ªad
(
öode
), 
	`i_gid_ªad
(inode) };

1424 
îr
;

1430 
ó_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
öode
->
i_sb
->
s_roŸ
->
d_öode
,

1431 
S_IFREG
 | 0600, 
NULL
, 
öode
->
i_öo
 + 1, 
ow√r
,

1432 
PXT4_EA_INODE_FL
);

1433 i‡(!
	`IS_ERR
(
ó_öode
)) {

1434 
ó_öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

1435 
ó_öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

1436 
	`pxt4_£t_a›s
(
ó_öode
);

1437 
	`pxt4_x©å_öode_£t_˛ass
(
ó_öode
);

1438 
	`u∆ock_√w_öode
(
ó_öode
);

1439 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 1);

1440 
	`pxt4_x©å_öode_£t_hash
(
ó_öode
, 
hash
);

1441 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1442 i‡(!
îr
)

1443 
îr
 = 
	`pxt4_öode_©èch_jöode
(
ó_öode
);

1444 i‡(
îr
) {

1445 
	`ùut
(
ó_öode
);

1446  
	`ERR_PTR
(
îr
);

1453 
	`dquŸ_‰ì_öode
(
ó_öode
);

1454 
	`dquŸ_dr›
(
ó_öode
);

1455 
	`öode_lock
(
ó_öode
);

1456 
ó_öode
->
i_Êags
 |
S_NOQUOTA
;

1457 
	`öode_u∆ock
(
ó_öode
);

1460  
ó_öode
;

1461 
	}
}

1463 
öode
 *

1464 
	$pxt4_x©å_öode_ˇche_föd
(
öode
 *öode, c⁄° *
vÆue
,

1465 
size_t
 
vÆue_Àn
, 
u32
 
hash
)

1467 
öode
 *
ó_öode
;

1468 
mb_ˇche_íåy
 *
˚
;

1469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

1470 *
ó_d©a
;

1472 i‡(!
ó_öode_ˇche
)

1473  
NULL
;

1475 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_öode_ˇche
, 
hash
);

1476 i‡(!
˚
)

1477  
NULL
;

1479 
ó_d©a
 = 
	`pxt4_kvmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1480 i‡(!
ó_d©a
) {

1481 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1482  
NULL
;

1485 
˚
) {

1486 
ó_öode
 = 
	`pxt4_igë
(
öode
->
i_sb
, 
˚
->
e_vÆue
,

1487 
PXT4_IGET_NORMAL
);

1488 i‡(!
	`IS_ERR
(
ó_öode
) &&

1489 !
	`is_bad_öode
(
ó_öode
) &&

1490 (
	`PXT4_I
(
ó_öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
) &&

1491 
	`i_size_ªad
(
ó_öode
Ë=
vÆue_Àn
 &&

1492 !
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
ó_d©a
, 
vÆue_Àn
) &&

1493 !
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
NULL
, 
ó_d©a
,

1494 
vÆue_Àn
) &&

1495 !
	`memcmp
(
vÆue
, 
ó_d©a
, 
vÆue_Àn
)) {

1496 
	`mb_ˇche_íåy_touch
(
ó_öode_ˇche
, 
˚
);

1497 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1498 
	`kv‰ì
(
ó_d©a
);

1499  
ó_öode
;

1502 i‡(!
	`IS_ERR
(
ó_öode
))

1503 
	`ùut
(
ó_öode
);

1504 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_öode_ˇche
, ce);

1506 
	`kv‰ì
(
ó_d©a
);

1507  
NULL
;

1508 
	}
}

1513 
	$pxt4_x©å_öode_lookup_¸óã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1514 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

1515 
öode
 **
ªt_öode
)

1517 
öode
 *
ó_öode
;

1518 
u32
 
hash
;

1519 
îr
;

1521 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
öode
->
i_sb
), 
vÆue
, 
vÆue_Àn
);

1522 
ó_öode
 = 
	`pxt4_x©å_öode_ˇche_föd
(
öode
, 
vÆue
, 
vÆue_Àn
, 
hash
);

1523 i‡(
ó_öode
) {

1524 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1525 i‡(
îr
) {

1526 
	`ùut
(
ó_öode
);

1527  
îr
;

1530 *
ªt_öode
 = 
ó_öode
;

1535 
ó_öode
 = 
	`pxt4_x©å_öode_¸óã
(
h™dÀ
, 
öode
, 
hash
);

1536 i‡(
	`IS_ERR
(
ó_öode
))

1537  
	`PTR_ERR
(
ó_öode
);

1539 
îr
 = 
	`pxt4_x©å_öode_wrôe
(
h™dÀ
, 
ó_öode
, 
vÆue
, 
vÆue_Àn
);

1540 i‡(
îr
) {

1541 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1542 
	`ùut
(
ó_öode
);

1543  
îr
;

1546 i‡(
	`EA_INODE_CACHE
(
öode
))

1547 
	`mb_ˇche_íåy_¸óã
(
	`EA_INODE_CACHE
(
öode
), 
GFP_NOFS
, 
hash
,

1548 
ó_öode
->
i_öo
, 
åue
 );

1550 *
ªt_öode
 = 
ó_öode
;

1552 
	}
}

1558 
	#PXT4_XATTR_BLOCK_RESERVE
(
öode
Ë
	`mö
(
	`i_blocksize
(öode)/8, 1024U)

	)

1560 
	$pxt4_x©å_£t_íåy
(
pxt4_x©å_öfo
 *
i
,

1561 
pxt4_x©å_£¨ch
 *
s
,

1562 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1563 
boﬁ
 
is_block
)

1565 
pxt4_x©å_íåy
 *
œ°
, *
√xt
;

1566 
pxt4_x©å_íåy
 *
hîe
 = 
s
->here;

1567 
size_t
 
mö_offs
 = 
s
->
íd
 - s->
ba£
, 
«me_Àn
 = 
	`°æí
(
i
->
«me
);

1568 
ö_öode
 = 
i
->in_inode;

1569 
öode
 *
ﬁd_ó_öode
 = 
NULL
;

1570 
öode
 *
√w_ó_öode
 = 
NULL
;

1571 
size_t
 
ﬁd_size
, 
√w_size
;

1572 
ªt
;

1575 
ﬁd_size
 = (!
s
->
nŸ_found
 && !
hîe
->
e_vÆue_öum
) ?

1576 
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
hîe
->
e_vÆue_size
)) : 0;

1577 
√w_size
 = (
i
->
vÆue
 && !
ö_öode
Ë? 
	`PXT4_XATTR_SIZE
(i->
vÆue_Àn
) : 0;

1583 i‡(
√w_size
 &&Çew_sizê=
ﬁd_size
) {

1584 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1585 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1587 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1588 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1589 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1591 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1593 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0, 
√w_size
 - i->value_len);

1595 
upd©e_hash
;

1599 
œ°
 = 
s
->
fú°
;

1600 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
√xt
) {

1601 
√xt
 = 
	`PXT4_XATTR_NEXT
(
œ°
);

1602 i‡((*)
√xt
 >
s
->
íd
) {

1603 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

1604 
ªt
 = -
EFSCORRUPTED
;

1605 
out
;

1607 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1608 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1609 i‡(
offs
 < 
mö_offs
)

1610 
mö_offs
 = 
offs
;

1615 i‡(
i
->
vÆue
) {

1616 
size_t
 
‰ì
;

1618 
‰ì
 = 
mö_offs
 - ((*)
œ°
 - 
s
->
ba£
Ë- (
__u32
);

1619 i‡(!
s
->
nŸ_found
)

1620 
‰ì
 +
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
ﬁd_size
;

1622 i‡(
‰ì
 < 
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
√w_size
) {

1623 
ªt
 = -
ENOSPC
;

1624 
out
;

1633 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

1634 
√w_size
 && 
is_block
 &&

1635 (
mö_offs
 + 
ﬁd_size
 - 
√w_size
) <

1636 
	`PXT4_XATTR_BLOCK_RESERVE
(
öode
)) {

1637 
ªt
 = -
ENOSPC
;

1638 
out
;

1646 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_öum
) {

1647 
ªt
 = 
	`pxt4_x©å_öode_igë
(
öode
,

1648 
	`À32_to_˝u
(
hîe
->
e_vÆue_öum
),

1649 
	`À32_to_˝u
(
hîe
->
e_hash
),

1650 &
ﬁd_ó_öode
);

1651 i‡(
ªt
) {

1652 
ﬁd_ó_öode
 = 
NULL
;

1653 
out
;

1656 i‡(
i
->
vÆue
 && 
ö_öode
) {

1657 
	`WARN_ON_ONCE
(!
i
->
vÆue_Àn
);

1659 
ªt
 = 
	`pxt4_x©å_öode_Æloc_quŸa
(
öode
, 
i
->
vÆue_Àn
);

1660 i‡(
ªt
)

1661 
out
;

1663 
ªt
 = 
	`pxt4_x©å_öode_lookup_¸óã
(
h™dÀ
, 
öode
, 
i
->
vÆue
,

1664 
i
->
vÆue_Àn
,

1665 &
√w_ó_öode
);

1666 i‡(
ªt
) {

1667 
√w_ó_öode
 = 
NULL
;

1668 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
i
->
vÆue_Àn
);

1669 
out
;

1673 i‡(
ﬁd_ó_öode
) {

1675 
ªt
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ﬁd_ó_öode
);

1676 i‡(
ªt
) {

1678 i‡(
√w_ó_öode
) {

1679 
îr
;

1681 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

1682 
√w_ó_öode
);

1683 i‡(
îr
)

1684 
	`pxt4_w¨nög_öode
(
√w_ó_öode
,

1686 
îr
);

1687 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
√w_ó_öode
,

1688 
i
->
vÆue_Àn
);

1690 
out
;

1693 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ﬁd_ó_öode
,

1694 
	`À32_to_˝u
(
hîe
->
e_vÆue_size
));

1699 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_size
 && !hîe->
e_vÆue_öum
) {

1701 *
fú°_vÆ
 = 
s
->
ba£
 + 
mö_offs
;

1702 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1703 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1705 
	`memmove
(
fú°_vÆ
 + 
ﬁd_size
, fú°_vÆ, 
vÆ
 - first_val);

1706 
	`mem£t
(
fú°_vÆ
, 0, 
ﬁd_size
);

1707 
mö_offs
 +
ﬁd_size
;

1710 
œ°
 = 
s
->
fú°
;

1711 !
	`IS_LAST_ENTRY
(
œ°
)) {

1712 
size_t
 
o
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1714 i‡(!
œ°
->
e_vÆue_öum
 &&

1715 
œ°
->
e_vÆue_size
 && 
o
 < 
offs
)

1716 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
o
 + 
ﬁd_size
);

1717 
œ°
 = 
	`PXT4_XATTR_NEXT
(last);

1721 i‡(!
i
->
vÆue
) {

1723 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1725 
œ°
 = 
	`ENTRY
((*Óa° - 
size
);

1726 
	`memmove
(
hîe
, (*)hîê+ 
size
,

1727 (*)
œ°
 - (*)
hîe
 + (
__u32
));

1728 
	`mem£t
(
œ°
, 0, 
size
);

1729 } i‡(
s
->
nŸ_found
) {

1731 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1732 
size_t
 
ª°
 = (*)
œ°
 - (*)
hîe
 + (
__u32
);

1734 
	`memmove
((*)
hîe
 + 
size
, hîe, 
ª°
);

1735 
	`mem£t
(
hîe
, 0, 
size
);

1736 
hîe
->
e_«me_ödex
 = 
i
->
«me_ödex
;

1737 
hîe
->
e_«me_Àn
 = 
«me_Àn
;

1738 
	`mem˝y
(
hîe
->
e_«me
, 
i
->
«me
, 
«me_Àn
);

1741 
hîe
->
e_vÆue_öum
 = 0;

1742 
hîe
->
e_vÆue_offs
 = 0;

1743 
hîe
->
e_vÆue_size
 = 0;

1746 i‡(
i
->
vÆue
) {

1748 i‡(
ö_öode
) {

1749 
hîe
->
e_vÆue_öum
 = 
	`˝u_to_À32
(
√w_ó_öode
->
i_öo
);

1750 } i‡(
i
->
vÆue_Àn
) {

1751 *
vÆ
 = 
s
->
ba£
 + 
mö_offs
 - 
√w_size
;

1753 
hîe
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
mö_offs
 - 
√w_size
);

1754 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1755 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1757 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1759 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0,

1760 
√w_size
 - 
i
->
vÆue_Àn
);

1763 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1766 
upd©e_hash
:

1767 i‡(
i
->
vÆue
) {

1768 
__À32
 
hash
 = 0;

1771 i‡(
ö_öode
) {

1772 
__À32
 
¸c32c_hash
;

1779 
¸c32c_hash
 = 
	`˝u_to_À32
(

1780 
	`pxt4_x©å_öode_gë_hash
(
√w_ó_öode
));

1781 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1782 
hîe
->
e_«me_Àn
,

1783 &
¸c32c_hash
, 1);

1784 } i‡(
is_block
) {

1785 
__À32
 *
vÆue
 = 
s
->
ba£
 + 
	`À16_to_˝u
(

1786 
hîe
->
e_vÆue_offs
);

1788 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1789 
hîe
->
e_«me_Àn
, 
vÆue
,

1790 
√w_size
 >> 2);

1792 
hîe
->
e_hash
 = 
hash
;

1795 i‡(
is_block
)

1796 
	`pxt4_x©å_ªhash
((
pxt4_x©å_hódî
 *)
s
->
ba£
);

1798 
ªt
 = 0;

1799 
out
:

1800 
	`ùut
(
ﬁd_ó_öode
);

1801 
	`ùut
(
√w_ó_öode
);

1802  
ªt
;

1803 
	}
}

1805 
	spxt4_x©å_block_föd
 {

1806 
pxt4_x©å_£¨ch
 
	ms
;

1807 
buf„r_hód
 *
	mbh
;

1811 
	$pxt4_x©å_block_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

1812 
pxt4_x©å_block_föd
 *
bs
)

1814 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1815 
îr‹
;

1817 
	`ó_idebug
(
öode
, "name=%d.%s, value=%p, value_len=%ld",

1818 
i
->
«me_ödex
, i->
«me
, i->
vÆue
, ()i->
vÆue_Àn
);

1820 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

1822 
bs
->
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
	`PXT4_I
(
öode
)->
i_fûe_a˛
, 
REQ_PRIO
);

1823 i‡(
	`IS_ERR
(
bs
->
bh
)) {

1824 
îr‹
 = 
	`PTR_ERR
(
bs
->
bh
);

1825 
bs
->
bh
 = 
NULL
;

1826  
îr‹
;

1828 
	`ó_bdebug
(
bs
->
bh
, "b_count=%d,Ñefcount=%d",

1829 
	`©omic_ªad
(&(
bs
->
bh
->
b_cou¡
)),

1830 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_ªfcou¡
));

1831 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bs
->
bh
);

1832 i‡(
îr‹
)

1833  
îr‹
;

1835 
bs
->
s
.
ba£
 = 
	`BHDR
(bs->
bh
);

1836 
bs
->
s
.
fú°
 = 
	`BFIRST
(bs->
bh
);

1837 
bs
->
s
.
íd
 = bs->
bh
->
b_d©a
 + bs->bh->
b_size
;

1838 
bs
->
s
.
hîe
 = bs->s.
fú°
;

1839 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
bs
->
s
.
hîe
, bs->s.
íd
,

1840 
i
->
«me_ödex
, i->
«me
, 1);

1841 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

1842  
îr‹
;

1843 
bs
->
s
.
nŸ_found
 = 
îr‹
;

1846 
	}
}

1849 
	$pxt4_x©å_block_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1850 
pxt4_x©å_öfo
 *
i
,

1851 
pxt4_x©å_block_föd
 *
bs
)

1853 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1854 
buf„r_hód
 *
√w_bh
 = 
NULL
;

1855 
pxt4_x©å_£¨ch
 
s_c›y
 = 
bs
->
s
;

1856 
pxt4_x©å_£¨ch
 *
s
 = &
s_c›y
;

1857 
mb_ˇche_íåy
 *
˚
 = 
NULL
;

1858 
îr‹
 = 0;

1859 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1860 
öode
 *
ó_öode
 = 
NULL
, *
tmp_öode
;

1861 
size_t
 
ﬁd_ó_öode_quŸa
 = 0;

1862 
ó_öo
;

1865 
	#hódî
(
x
Ë((
pxt4_x©å_hódî
 *)(x))

	)

1867 i‡(
s
->
ba£
) {

1868 
	`BUFFER_TRACE
(
bs
->
bh
, "get_write_access");

1869 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bs
->
bh
);

1870 i‡(
îr‹
)

1871 
˛ónup
;

1872 
	`lock_buf„r
(
bs
->
bh
);

1874 i‡(
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 =
	`˝u_to_À32
(1)) {

1875 
__u32
 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_hash
);

1882 i‡(
ó_block_ˇche
)

1883 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1884 
bs
->
bh
->
b_blockƒ
);

1885 
	`ó_bdebug
(
bs
->
bh
, "modifying in-place");

1886 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
,

1887 
åue
 );

1888 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bs
->
bh
);

1889 
	`u∆ock_buf„r
(
bs
->
bh
);

1890 i‡(
îr‹
 =-
EFSCORRUPTED
)

1891 
bad_block
;

1892 i‡(!
îr‹
)

1893 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1894 
öode
,

1895 
bs
->
bh
);

1896 i‡(
îr‹
)

1897 
˛ónup
;

1898 
ö£πed
;

1900 
off£t
 = (*)
s
->
hîe
 - 
bs
->
bh
->
b_d©a
;

1902 
	`u∆ock_buf„r
(
bs
->
bh
);

1903 
	`ó_bdebug
(
bs
->
bh
, "cloning");

1904 
s
->
ba£
 = 
	`kmÆloc
(
bs
->
bh
->
b_size
, 
GFP_NOFS
);

1905 
îr‹
 = -
ENOMEM
;

1906 i‡(
s
->
ba£
 =
NULL
)

1907 
˛ónup
;

1908 
	`mem˝y
(
s
->
ba£
, 
	`BHDR
(
bs
->
bh
), bs->bh->
b_size
);

1909 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1910 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1911 
s
->
hîe
 = 
	`ENTRY
(s->
ba£
 + 
off£t
);

1912 
s
->
íd
 = s->
ba£
 + 
bs
->
bh
->
b_size
;

1921 i‡(!
s
->
nŸ_found
 && s->
hîe
->
e_vÆue_öum
) {

1922 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1923 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1924 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1925 &
tmp_öode
);

1926 i‡(
îr‹
)

1927 
˛ónup
;

1929 i‡(!
	`pxt4_ã°_öode_°©e
(
tmp_öode
,

1930 
PXT4_STATE_LUSTRE_EA_INODE
)) {

1935 
ﬁd_ó_öode_quŸa
 = 
	`À32_to_˝u
(

1936 
s
->
hîe
->
e_vÆue_size
);

1938 
	`ùut
(
tmp_öode
);

1940 
s
->
hîe
->
e_vÆue_öum
 = 0;

1941 
s
->
hîe
->
e_vÆue_size
 = 0;

1946 
s
->
ba£
 = 
	`kzÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

1948 
îr‹
 = -
ENOMEM
;

1949 i‡(
s
->
ba£
 =
NULL
)

1950 
˛ónup
;

1951 
	`hódî
(
s
->
ba£
)->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

1952 
	`hódî
(
s
->
ba£
)->
h_blocks
 = 
	`˝u_to_À32
(1);

1953 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1954 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1955 
s
->
hîe
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1956 
s
->
íd
 = s->
ba£
 + 
sb
->
s_blocksize
;

1959 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
åue
 );

1960 i‡(
îr‹
 =-
EFSCORRUPTED
)

1961 
bad_block
;

1962 i‡(
îr‹
)

1963 
˛ónup
;

1965 i‡(
i
->
vÆue
 && 
s
->
hîe
->
e_vÆue_öum
) {

1972 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1973 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1974 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1975 &
ó_öode
);

1976 i‡(
îr‹
) {

1977 
ó_öode
 = 
NULL
;

1978 
˛ónup
;

1982 
ö£πed
:

1983 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

1984 
√w_bh
 = 
	`pxt4_x©å_block_ˇche_föd
(
öode
, 
	`hódî
(
s
->
ba£
),

1985 &
˚
);

1986 i‡(
√w_bh
) {

1988 i‡(
√w_bh
 =
bs
->
bh
)

1989 
	`ó_bdebug
(
√w_bh
, "keeping");

1991 
u32
 
ªf
;

1993 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

1997 
îr‹
 = 
	`dquŸ_Æloc_block
(
öode
,

1998 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

1999 i‡(
îr‹
)

2000 
˛ónup
;

2001 
	`BUFFER_TRACE
(
√w_bh
, "get_write_access");

2002 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2003 
√w_bh
);

2004 i‡(
îr‹
)

2005 
˛ónup_dquŸ
;

2006 
	`lock_buf„r
(
√w_bh
);

2019 i‡(
	`hli°_bl_unhashed
(&
˚
->
e_hash_li°
) ||

2020 !
˚
->
e_ªußbÀ
) {

2025 
	`u∆ock_buf„r
(
√w_bh
);

2026 
	`dquŸ_‰ì_block
(
öode
,

2027 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

2029 
	`bªl£
(
√w_bh
);

2030 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2031 
˚
 = 
NULL
;

2032 
√w_bh
 = 
NULL
;

2033 
ö£πed
;

2035 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
√w_bh
)->
h_ªfcou¡
) + 1;

2036 
	`BHDR
(
√w_bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

2037 i‡(
ªf
 >
PXT4_XATTR_REFCOUNT_MAX
)

2038 
˚
->
e_ªußbÀ
 = 0;

2039 
	`ó_bdebug
(
√w_bh
, "reusing;ÑefcountÇow=%d",

2040 
ªf
);

2041 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2042 
	`u∆ock_buf„r
(
√w_bh
);

2043 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

2044 
öode
,

2045 
√w_bh
);

2046 i‡(
îr‹
)

2047 
˛ónup_dquŸ
;

2049 
	`mb_ˇche_íåy_touch
(
ó_block_ˇche
, 
˚
);

2050 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2051 
˚
 = 
NULL
;

2052 } i‡(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
) {

2054 
	`ó_bdebug
(
bs
->
bh
, "keepingÅhis block");

2055 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bs
->
bh
);

2056 
√w_bh
 = 
bs
->
bh
;

2057 
	`gë_bh
(
√w_bh
);

2060 
pxt4_fsblk_t
 
gﬂl
, 
block
;

2062 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

2064 
gﬂl
 = 
	`pxt4_group_fú°_block_no
(
sb
,

2065 
	`PXT4_I
(
öode
)->
i_block_group
);

2068 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2069 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

2071 
block
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 0,

2072 
NULL
, &
îr‹
);

2073 i‡(
îr‹
)

2074 
˛ónup
;

2076 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2077 
	`BUG_ON
(
block
 > 
PXT4_MAX_BLOCK_FILE_PHYS
);

2079 
	`ó_idebug
(
öode
, "creating block %llu",

2080 ()
block
);

2082 
√w_bh
 = 
	`sb_gëblk
(
sb
, 
block
);

2083 i‡(
	`u∆ikñy
(!
√w_bh
)) {

2084 
îr‹
 = -
ENOMEM
;

2085 
gëblk_Áûed
:

2086 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

2087 
PXT4_FREE_BLOCKS_METADATA
);

2088 
˛ónup
;

2090 
îr‹
 = 
	`pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ
, 
öode
,

2091 
	`ENTRY
(
	`hódî
(
s
->
ba£
)+1));

2092 i‡(
îr‹
)

2093 
gëblk_Áûed
;

2094 i‡(
ó_öode
) {

2096 
îr‹
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

2097 
ó_öode
);

2098 i‡(
îr‹
)

2099 
	`pxt4_w¨nög_öode
(
ó_öode
,

2101 
îr‹
);

2102 
	`ùut
(
ó_öode
);

2103 
ó_öode
 = 
NULL
;

2106 
	`lock_buf„r
(
√w_bh
);

2107 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
√w_bh
);

2108 i‡(
îr‹
) {

2109 
	`u∆ock_buf„r
(
√w_bh
);

2110 
îr‹
 = -
EIO
;

2111 
gëblk_Áûed
;

2113 
	`mem˝y
(
√w_bh
->
b_d©a
, 
s
->
ba£
,Çew_bh->
b_size
);

2114 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2115 
	`£t_buf„r_u±od©e
(
√w_bh
);

2116 
	`u∆ock_buf„r
(
√w_bh
);

2117 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
√w_bh
);

2118 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
,

2119 
√w_bh
);

2120 i‡(
îr‹
)

2121 
˛ónup
;

2125 i‡(
ﬁd_ó_öode_quŸa
)

2126 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
ﬁd_ó_öode_quŸa
);

2129 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 
√w_bh
 ?Çew_bh->
b_blockƒ
 : 0;

2132 i‡(
bs
->
bh
 && bs->bh !
√w_bh
) {

2133 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

2135 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bs
->
bh
,

2136 &
ó_öode_¨øy
,

2138 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

2140 
îr‹
 = 0;

2142 
˛ónup
:

2143 i‡(
ó_öode
) {

2144 
îr‹2
;

2146 
îr‹2
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

2147 i‡(
îr‹2
)

2148 
	`pxt4_w¨nög_öode
(
ó_öode
, "decÑefÉrror=%d",

2149 
îr‹2
);

2152 i‡(
îr‹
)

2153 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2154 
	`i_size_ªad
(
ó_öode
));

2155 
	`ùut
(
ó_öode
);

2157 i‡(
˚
)

2158 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2159 
	`bªl£
(
√w_bh
);

2160 i‡(!(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
))

2161 
	`k‰ì
(
s
->
ba£
);

2163  
îr‹
;

2165 
˛ónup_dquŸ
:

2166 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

2167 
˛ónup
;

2169 
bad_block
:

2170 
	`PXT4_ERROR_INODE
(
öode
, "bad block %llu",

2171 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2172 
˛ónup
;

2174 #unde‡
hódî


2175 
	}
}

2177 
	$pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

2178 
pxt4_x©å_ibody_föd
 *
is
)

2180 
pxt4_x©å_ibody_hódî
 *
hódî
;

2181 
pxt4_öode
 *
øw_öode
;

2182 
îr‹
;

2184 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2186 
øw_öode
 = 
	`pxt4_øw_öode
(&
is
->
ûoc
);

2187 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2188 
is
->
s
.
ba£
 = is->s.
fú°
 = 
	`IFIRST
(
hódî
);

2189 
is
->
s
.
hîe
 = is->s.
fú°
;

2190 
is
->
s
.
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2191 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2192 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
is
->
s
.
íd
);

2193 i‡(
îr‹
)

2194  
îr‹
;

2196 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
is
->
s
.
hîe
, is->s.
íd
,

2197 
i
->
«me_ödex
, i->
«me
, 0);

2198 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

2199  
îr‹
;

2200 
is
->
s
.
nŸ_found
 = 
îr‹
;

2203 
	}
}

2205 
	$pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2206 
pxt4_x©å_öfo
 *
i
,

2207 
pxt4_x©å_ibody_föd
 *
is
)

2209 
pxt4_x©å_ibody_hódî
 *
hódî
;

2210 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2211 
îr‹
;

2213 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2214  -
ENOSPC
;

2215 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2216 i‡(
îr‹
)

2217  
îr‹
;

2218 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2219 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2220 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2221 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2223 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2224 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2227 
	}
}

2229 
	$pxt4_x©å_ibody_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2230 
pxt4_x©å_öfo
 *
i
,

2231 
pxt4_x©å_ibody_föd
 *
is
)

2233 
pxt4_x©å_ibody_hódî
 *
hódî
;

2234 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2235 
îr‹
;

2237 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2238  -
ENOSPC
;

2239 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2240 i‡(
îr‹
)

2241  
îr‹
;

2242 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2243 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2244 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2245 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2247 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2248 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2251 
	}
}

2253 
	$pxt4_x©å_vÆue_ßme
(
pxt4_x©å_£¨ch
 *
s
,

2254 
pxt4_x©å_öfo
 *
i
)

2256 *
vÆue
;

2259 i‡(
s
->
hîe
->
e_vÆue_öum
)

2261 i‡(
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_size
Ë!
i
->
vÆue_Àn
)

2263 
vÆue
 = ((*)
s
->
ba£
Ë+ 
	`À16_to_˝u
(s->
hîe
->
e_vÆue_offs
);

2264  !
	`memcmp
(
vÆue
, 
i
->vÆue, i->
vÆue_Àn
);

2265 
	}
}

2267 
buf„r_hód
 *
	$pxt4_x©å_gë_block
(
öode
 *inode)

2269 
buf„r_hód
 *
bh
;

2270 
îr‹
;

2272 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

2273  
NULL
;

2274 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2275 i‡(
	`IS_ERR
(
bh
))

2276  
bh
;

2277 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2278 i‡(
îr‹
) {

2279 
	`bªl£
(
bh
);

2280  
	`ERR_PTR
(
îr‹
);

2282  
bh
;

2283 
	}
}

2298 
	$pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
«me_ödex
,

2299 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

2300 
Êags
)

2302 
pxt4_x©å_öfo
 
i
 = {

2303 .
«me_ödex
 =Çame_index,

2304 .
«me
 =Çame,

2305 .
vÆue
 = value,

2306 .
vÆue_Àn
 = value_len,

2307 .
ö_öode
 = 0,

2309 
pxt4_x©å_ibody_föd
 
is
 = {

2310 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2312 
pxt4_x©å_block_föd
 
bs
 = {

2313 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2315 
no_ex∑nd
;

2316 
îr‹
;

2318 i‡(!
«me
)

2319  -
EINVAL
;

2320 i‡(
	`°æí
(
«me
) > 255)

2321  -
ERANGE
;

2323 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2326 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2327 
buf„r_hód
 *
bh
;

2328 
¸edôs
;

2330 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2331 i‡(
	`IS_ERR
(
bh
)) {

2332 
îr‹
 = 
	`PTR_ERR
(
bh
);

2333 
˛ónup
;

2336 
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2337 
vÆue_Àn
,

2338 
Êags
 & 
XATTR_CREATE
);

2339 
	`bªl£
(
bh
);

2341 i‡(!
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
¸edôs
)) {

2342 
îr‹
 = -
ENOSPC
;

2343 
˛ónup
;

2347 
îr‹
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2348 i‡(
îr‹
)

2349 
˛ónup
;

2351 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
)) {

2352 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(&
is
.
ûoc
);

2353 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

2354 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

2357 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

2358 i‡(
îr‹
)

2359 
˛ónup
;

2360 i‡(
is
.
s
.
nŸ_found
)

2361 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2362 i‡(
îr‹
)

2363 
˛ónup
;

2364 i‡(
is
.
s
.
nŸ_found
 && 
bs
.s.not_found) {

2365 
îr‹
 = -
ENODATA
;

2366 i‡(
Êags
 & 
XATTR_REPLACE
)

2367 
˛ónup
;

2368 
îr‹
 = 0;

2369 i‡(!
vÆue
)

2370 
˛ónup
;

2372 
îr‹
 = -
EEXIST
;

2373 i‡(
Êags
 & 
XATTR_CREATE
)

2374 
˛ónup
;

2377 i‡(!
vÆue
) {

2378 i‡(!
is
.
s
.
nŸ_found
)

2379 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2380 i‡(!
bs
.
s
.
nŸ_found
)

2381 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2383 
îr‹
 = 0;

2385 i‡(!
is
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&is.s, &
i
))

2386 
˛ónup
;

2387 i‡(!
bs
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&bs.s, &
i
))

2388 
˛ónup
;

2390 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2391 (
	`PXT4_XATTR_SIZE
(
i
.
vÆue_Àn
) >

2392 
	`PXT4_XATTR_MIN_LARGE_EA_SIZE
(
öode
->
i_sb
->
s_blocksize
)))

2393 
i
.
ö_öode
 = 1;

2394 
ªåy_öode
:

2395 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2396 i‡(!
îr‹
 && !
bs
.
s
.
nŸ_found
) {

2397 
i
.
vÆue
 = 
NULL
;

2398 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2399 } i‡(
îr‹
 =-
ENOSPC
) {

2400 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
 && !
bs
.
s
.
ba£
) {

2401 
	`bªl£
(
bs
.
bh
);

2402 
bs
.
bh
 = 
NULL
;

2403 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2404 i‡(
îr‹
)

2405 
˛ónup
;

2407 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2408 i‡(!
îr‹
 && !
is
.
s
.
nŸ_found
) {

2409 
i
.
vÆue
 = 
NULL
;

2410 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
,

2411 &
is
);

2412 } i‡(
îr‹
 =-
ENOSPC
) {

2417 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2418 !
i
.
ö_öode
) {

2419 
i
.
ö_öode
 = 1;

2420 
ªåy_öode
;

2425 i‡(!
îr‹
) {

2426 
	`pxt4_x©å_upd©e_su≥r_block
(
h™dÀ
, 
öode
->
i_sb
);

2427 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

2428 i‡(!
vÆue
)

2429 
no_ex∑nd
 = 0;

2430 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2435 
is
.
ûoc
.
bh
 = 
NULL
;

2436 i‡(
	`IS_SYNC
(
öode
))

2437 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2440 
˛ónup
:

2441 
	`bªl£
(
is
.
ûoc
.
bh
);

2442 
	`bªl£
(
bs
.
bh
);

2443 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2444  
îr‹
;

2445 
	}
}

2447 
	$pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

2448 
boﬁ
 
is_¸óã
, *
¸edôs
)

2450 
buf„r_hód
 *
bh
;

2451 
îr
;

2453 *
¸edôs
 = 0;

2455 i‡(!
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

2458 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2460 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2461 i‡(
	`IS_ERR
(
bh
)) {

2462 
îr
 = 
	`PTR_ERR
(
bh
);

2464 *
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2465 
vÆue_Àn
, 
is_¸óã
);

2466 
	`bªl£
(
bh
);

2467 
îr
 = 0;

2470 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2471  
îr
;

2472 
	}
}

2483 
	$pxt4_x©å_£t
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

2484 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
, 
Êags
)

2486 
h™dÀ_t
 *
h™dÀ
;

2487 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2488 
îr‹
, 
ªåõs
 = 0;

2489 
¸edôs
;

2491 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

2492 i‡(
îr‹
)

2493  
îr‹
;

2495 
ªåy
:

2496 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
vÆue_Àn
, 
Êags
 & 
XATTR_CREATE
,

2497 &
¸edôs
);

2498 i‡(
îr‹
)

2499  
îr‹
;

2501 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

2502 i‡(
	`IS_ERR
(
h™dÀ
)) {

2503 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2505 
îr‹2
;

2507 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, 
«me
,

2508 
vÆue
, 
vÆue_Àn
, 
Êags
);

2509 
îr‹2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2510 i‡(
îr‹
 =-
ENOSPC
 &&

2511 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

2512 
ªåy
;

2513 i‡(
îr‹
 == 0)

2514 
îr‹
 = 
îr‹2
;

2517  
îr‹
;

2518 
	}
}

2524 
	$pxt4_x©å_shi·_íåõs
(
pxt4_x©å_íåy
 *
íåy
,

2525 
vÆue_offs_shi·
, *
to
,

2526 *
‰om
, 
size_t
 
n
)

2528 
pxt4_x©å_íåy
 *
œ°
 = 
íåy
;

2529 
√w_offs
;

2532 
	`BUG_ON
(
vÆue_offs_shi·
 > 0);

2535 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2536 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

2537 
√w_offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
) +

2538 
vÆue_offs_shi·
;

2539 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
√w_offs
);

2543 
	`memmove
(
to
, 
‰om
, 
n
);

2544 
	}
}

2549 
	$pxt4_x©å_move_to_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2550 
pxt4_öode
 *
øw_öode
,

2551 
pxt4_x©å_íåy
 *
íåy
)

2553 
pxt4_x©å_ibody_föd
 *
is
 = 
NULL
;

2554 
pxt4_x©å_block_föd
 *
bs
 = 
NULL
;

2555 *
buf„r
 = 
NULL
, *
b_íåy_«me
 = NULL;

2556 
size_t
 
vÆue_size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

2557 
pxt4_x©å_öfo
 
i
 = {

2558 .
vÆue
 = 
NULL
,

2559 .
vÆue_Àn
 = 0,

2560 .
«me_ödex
 = 
íåy
->
e_«me_ödex
,

2561 .
ö_öode
 = !!
íåy
->
e_vÆue_öum
,

2563 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2564 
îr‹
;

2566 
is
 = 
	`kzÆloc
((
pxt4_x©å_ibody_föd
), 
GFP_NOFS
);

2567 
bs
 = 
	`kzÆloc
((
pxt4_x©å_block_föd
), 
GFP_NOFS
);

2568 
buf„r
 = 
	`kmÆloc
(
vÆue_size
, 
GFP_NOFS
);

2569 
b_íåy_«me
 = 
	`kmÆloc
(
íåy
->
e_«me_Àn
 + 1, 
GFP_NOFS
);

2570 i‡(!
is
 || !
bs
 || !
buf„r
 || !
b_íåy_«me
) {

2571 
îr‹
 = -
ENOMEM
;

2572 
out
;

2575 
is
->
s
.
nŸ_found
 = -
ENODATA
;

2576 
bs
->
s
.
nŸ_found
 = -
ENODATA
;

2577 
is
->
ûoc
.
bh
 = 
NULL
;

2578 
bs
->
bh
 = 
NULL
;

2581 i‡(
íåy
->
e_vÆue_öum
) {

2582 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
, 
vÆue_size
);

2583 i‡(
îr‹
)

2584 
out
;

2586 
size_t
 
vÆue_offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

2587 
	`mem˝y
(
buf„r
, (*)
	`IFIRST
(
hódî
Ë+ 
vÆue_offs
, 
vÆue_size
);

2590 
	`mem˝y
(
b_íåy_«me
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

2591 
b_íåy_«me
[
íåy
->
e_«me_Àn
] = '\0';

2592 
i
.
«me
 = 
b_íåy_«me
;

2594 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
->
ûoc
);

2595 i‡(
îr‹
)

2596 
out
;

2598 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, 
is
);

2599 i‡(
îr‹
)

2600 
out
;

2603 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, 
is
);

2604 i‡(
îr‹
)

2605 
out
;

2607 
i
.
vÆue
 = 
buf„r
;

2608 
i
.
vÆue_Àn
 = 
vÆue_size
;

2609 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, 
bs
);

2610 i‡(
îr‹
)

2611 
out
;

2614 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, 
bs
);

2615 i‡(
îr‹
)

2616 
out
;

2617 
îr‹
 = 0;

2618 
out
:

2619 
	`k‰ì
(
b_íåy_«me
);

2620 
	`k‰ì
(
buf„r
);

2621 i‡(
is
)

2622 
	`bªl£
(
is
->
ûoc
.
bh
);

2623 i‡(
bs
)

2624 
	`bªl£
(
bs
->
bh
);

2625 
	`k‰ì
(
is
);

2626 
	`k‰ì
(
bs
);

2628  
îr‹
;

2629 
	}
}

2631 
	$pxt4_x©å_make_öode_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2632 
pxt4_öode
 *
øw_öode
,

2633 
isize_diff
, 
size_t
 
i‰ì
,

2634 
size_t
 
b‰ì
, *
tŸÆ_öo
)

2636 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2637 
pxt4_x©å_íåy
 *
smÆl_íåy
;

2638 
pxt4_x©å_íåy
 *
íåy
;

2639 
pxt4_x©å_íåy
 *
œ°
;

2640 
íåy_size
;

2641 
tŸÆ_size
;

2642 
mö_tŸÆ_size
;

2643 
îr‹
;

2645 
isize_diff
 > 
i‰ì
) {

2646 
íåy
 = 
NULL
;

2647 
smÆl_íåy
 = 
NULL
;

2648 
mö_tŸÆ_size
 = ~0U;

2649 
œ°
 = 
	`IFIRST
(
hódî
);

2651 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2653 i‡((
œ°
->
e_«me_Àn
 == 4) &&

2654 (
œ°
->
e_«me_ödex
 =
PXT4_XATTR_INDEX_SYSTEM
) &&

2655 !
	`memcmp
(
œ°
->
e_«me
, "data", 4))

2657 
tŸÆ_size
 = 
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

2658 i‡(!
œ°
->
e_vÆue_öum
)

2659 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2660 
	`À32_to_˝u
(
œ°
->
e_vÆue_size
));

2661 i‡(
tŸÆ_size
 <
b‰ì
 &&

2662 
tŸÆ_size
 < 
mö_tŸÆ_size
) {

2663 i‡(
tŸÆ_size
 + 
i‰ì
 < 
isize_diff
) {

2664 
smÆl_íåy
 = 
œ°
;

2666 
íåy
 = 
œ°
;

2667 
mö_tŸÆ_size
 = 
tŸÆ_size
;

2672 i‡(
íåy
 =
NULL
) {

2673 i‡(
smÆl_íåy
 =
NULL
)

2674  -
ENOSPC
;

2675 
íåy
 = 
smÆl_íåy
;

2678 
íåy_size
 = 
	`PXT4_XATTR_LEN
(
íåy
->
e_«me_Àn
);

2679 
tŸÆ_size
 = 
íåy_size
;

2680 i‡(!
íåy
->
e_vÆue_öum
)

2681 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2682 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2683 
îr‹
 = 
	`pxt4_x©å_move_to_block
(
h™dÀ
, 
öode
, 
øw_öode
,

2684 
íåy
);

2685 i‡(
îr‹
)

2686  
îr‹
;

2688 *
tŸÆ_öo
 -
íåy_size
;

2689 
i‰ì
 +
tŸÆ_size
;

2690 
b‰ì
 -
tŸÆ_size
;

2694 
	}
}

2700 
	$pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

2701 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
)

2703 
pxt4_x©å_ibody_hódî
 *
hódî
;

2704 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2705 
m¡_cou¡
;

2706 
size_t
 
mö_offs
;

2707 
size_t
 
i‰ì
, 
b‰ì
;

2708 
tŸÆ_öo
;

2709 *
ba£
, *
íd
;

2710 
îr‹
 = 0, 
åõd_mö_exåa_isize
 = 0;

2711 
s_mö_exåa_isize
 = 
	`À16_to_˝u
(
sbi
->
s_es
->s_min_extra_isize);

2712 
isize_diff
;

2714 
ªåy
:

2715 
isize_diff
 = 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

2716 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 >
√w_exåa_isize
)

2719 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2726 
ba£
 = 
	`IFIRST
(
hódî
);

2727 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2728 
mö_offs
 = 
íd
 - 
ba£
;

2729 
tŸÆ_öo
 = (
pxt4_x©å_ibody_hódî
Ë+ (
u32
);

2731 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

2732 i‡(
îr‹
)

2733 
˛ónup
;

2735 
i‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
ba£
, &
mö_offs
, ba£, &
tŸÆ_öo
);

2736 i‡(
i‰ì
 >
isize_diff
)

2737 
shi·
;

2743 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2744 
buf„r_hód
 *
bh
;

2746 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2747 i‡(
	`IS_ERR
(
bh
)) {

2748 
îr‹
 = 
	`PTR_ERR
(
bh
);

2749 
˛ónup
;

2751 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2752 i‡(
îr‹
) {

2753 
	`bªl£
(
bh
);

2754 
˛ónup
;

2756 
ba£
 = 
	`BHDR
(
bh
);

2757 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

2758 
mö_offs
 = 
íd
 - 
ba£
;

2759 
b‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
	`BFIRST
(
bh
), &
mö_offs
, 
ba£
,

2760 
NULL
);

2761 
	`bªl£
(
bh
);

2762 i‡(
b‰ì
 + 
i‰ì
 < 
isize_diff
) {

2763 i‡(!
åõd_mö_exåa_isize
 && 
s_mö_exåa_isize
) {

2764 
åõd_mö_exåa_isize
++;

2765 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2766 
ªåy
;

2768 
îr‹
 = -
ENOSPC
;

2769 
˛ónup
;

2772 
b‰ì
 = 
öode
->
i_sb
->
s_blocksize
;

2775 
îr‹
 = 
	`pxt4_x©å_make_öode_•a˚
(
h™dÀ
, 
öode
, 
øw_öode
,

2776 
isize_diff
, 
i‰ì
, 
b‰ì
,

2777 &
tŸÆ_öo
);

2778 i‡(
îr‹
) {

2779 i‡(
îr‹
 =-
ENOSPC
 && !
åõd_mö_exåa_isize
 &&

2780 
s_mö_exåa_isize
) {

2781 
åõd_mö_exåa_isize
++;

2782 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2783 
ªåy
;

2785 
˛ónup
;

2787 
shi·
:

2789 
	`pxt4_x©å_shi·_íåõs
(
	`IFIRST
(
hódî
), 
	`PXT4_I
(
öode
)->
i_exåa_isize


2790 - 
√w_exåa_isize
, (*)
øw_öode
 +

2791 
PXT4_GOOD_OLD_INODE_SIZE
 + 
√w_exåa_isize
,

2792 (*)
hódî
, 
tŸÆ_öo
);

2793 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

2795 
˛ónup
:

2796 i‡(
îr‹
 && (
m¡_cou¡
 !
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
))) {

2797 
	`pxt4_w¨nög
(
öode
->
i_sb
, "UnableÅoÉxpand inode %lu. Delete some EAs orÑunÉ2fsck.",

2798 
öode
->
i_öo
);

2799 
m¡_cou¡
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
);

2801  
îr‹
;

2802 
	}
}

2804 
	#EIA_INCR
 16

	)

2805 
	#EIA_MASK
 (
EIA_INCR
 - 1)

	)

2812 
	$pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2813 
öode
 *inode)

2815 i‡(*
ó_öode_¨øy
 =
NULL
) {

2820 (*
ó_öode_¨øy
) =

2821 
	`kmÆloc
(
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2822 
öodes
[
EIA_MASK
]),

2823 
GFP_NOFS
);

2824 i‡(*
ó_öode_¨øy
 =
NULL
)

2825  -
ENOMEM
;

2826 (*
ó_öode_¨øy
)->
cou¡
 = 0;

2827 } i‡(((*
ó_öode_¨øy
)->
cou¡
 & 
EIA_MASK
) == EIA_MASK) {

2829 
pxt4_x©å_öode_¨øy
 *
√w_¨øy
 = 
NULL
;

2830 
cou¡
 = (*
ó_öode_¨øy
)->count;

2833 
√w_¨øy
 = 
	`kmÆloc
(

2834 
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2835 
öodes
[
cou¡
 + 
EIA_INCR
]),

2836 
GFP_NOFS
);

2837 i‡(
√w_¨øy
 =
NULL
)

2838  -
ENOMEM
;

2839 
	`mem˝y
(
√w_¨øy
, *
ó_öode_¨øy
,

2840 
	`off£tof
(
pxt4_x©å_öode_¨øy
, 
öodes
[
cou¡
]));

2841 
	`k‰ì
(*
ó_öode_¨øy
);

2842 *
ó_öode_¨øy
 = 
√w_¨øy
;

2844 (*
ó_öode_¨øy
)->
öodes
[(*ó_öode_¨øy)->
cou¡
++] = 
öode
;

2846 
	}
}

2857 
	$pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2858 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2859 
exåa_¸edôs
)

2861 
buf„r_hód
 *
bh
 = 
NULL
;

2862 
pxt4_x©å_ibody_hódî
 *
hódî
;

2863 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

2864 
pxt4_x©å_íåy
 *
íåy
;

2865 
öode
 *
ó_öode
;

2866 
îr‹
;

2868 
îr‹
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
öode
, 
exåa_¸edôs
,

2869 
NULL
 ,

2870 
Ál£
 ,

2871 
Ál£
 );

2872 i‡(
îr‹
) {

2873 
	`PXT4_ERROR_INODE
(
öode
, "ísuª cªdô†”º‹ %d)", 
îr‹
);

2874 
˛ónup
;

2877 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2878 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2880 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2881 i‡(
îr‹
) {

2882 
	`PXT4_ERROR_INODE
(
öode
, "öodêlo¯”º‹ %d)", 
îr‹
);

2883 
˛ónup
;

2886 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

2887 i‡(
îr‹
) {

2888 
	`PXT4_ERROR_INODE
(
öode
, "writeáccess (error %d)",

2889 
îr‹
);

2890 
˛ónup
;

2893 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
ûoc
));

2894 i‡(
hódî
->
h_magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
))

2895 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
ûoc
.
bh
,

2896 
	`IFIRST
(
hódî
),

2897 
Ál£
 ,

2898 
ó_öode_¨øy
,

2899 
exåa_¸edôs
,

2900 
Ál£
 );

2903 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2904 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2905 i‡(
	`IS_ERR
(
bh
)) {

2906 
îr‹
 = 
	`PTR_ERR
(
bh
);

2907 i‡(
îr‹
 =-
EIO
)

2908 
	`PXT4_ERROR_INODE
(
öode
, "block %lluÑeadÉrror",

2909 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2910 
bh
 = 
NULL
;

2911 
˛ónup
;

2913 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2914 i‡(
îr‹
)

2915 
˛ónup
;

2917 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
)) {

2918 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

2919 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

2920 i‡(!
íåy
->
e_vÆue_öum
)

2922 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
,

2923 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

2924 
	`À32_to_˝u
(
íåy
->
e_hash
),

2925 &
ó_öode
);

2926 i‡(
îr‹
)

2928 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2929 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2930 
	`ùut
(
ó_öode
);

2935 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bh
, 
ó_öode_¨øy
,

2936 
exåa_¸edôs
);

2941 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 0;

2942 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2943 i‡(
îr‹
) {

2944 
	`PXT4_ERROR_INODE
(
öode
, "mark inode dirty (error %d)",

2945 
îr‹
);

2946 
˛ónup
;

2949 
îr‹
 = 0;

2950 
˛ónup
:

2951 
	`bªl£
(
ûoc
.
bh
);

2952 
	`bªl£
(
bh
);

2953  
îr‹
;

2954 
	}
}

2956 
	$pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
)

2958 
idx
;

2960 i‡(
ó_öode_¨øy
 =
NULL
)

2963 
idx
 = 0; idx < 
ó_öode_¨øy
->
cou¡
; ++idx)

2964 
	`ùut
(
ó_öode_¨øy
->
öodes
[
idx
]);

2965 
	`k‰ì
(
ó_öode_¨øy
);

2966 
	}
}

2977 
	$pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *
ó_block_ˇche
,

2978 
buf„r_hód
 *
bh
)

2980 
pxt4_x©å_hódî
 *
hódî
 = 
	`BHDR
(
bh
);

2981 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

2982 
ªußbÀ
 = 
	`À32_to_˝u
(
hódî
->
h_ªfcou¡
) <

2983 
PXT4_XATTR_REFCOUNT_MAX
;

2984 
îr‹
;

2986 i‡(!
ó_block_ˇche
)

2988 
îr‹
 = 
	`mb_ˇche_íåy_¸óã
(
ó_block_ˇche
, 
GFP_NOFS
, 
hash
,

2989 
bh
->
b_blockƒ
, 
ªußbÀ
);

2990 i‡(
îr‹
) {

2991 i‡(
îr‹
 =-
EBUSY
)

2992 
	`ó_bdebug
(
bh
, "already in cache");

2994 
	`ó_bdebug
(
bh
, "ö£πög [%x]", ()
hash
);

2995 
	}
}

3006 
	$pxt4_x©å_cmp
(
pxt4_x©å_hódî
 *
hódî1
,

3007 
pxt4_x©å_hódî
 *
hódî2
)

3009 
pxt4_x©å_íåy
 *
íåy1
, *
íåy2
;

3011 
íåy1
 = 
	`ENTRY
(
hódî1
+1);

3012 
íåy2
 = 
	`ENTRY
(
hódî2
+1);

3013 !
	`IS_LAST_ENTRY
(
íåy1
)) {

3014 i‡(
	`IS_LAST_ENTRY
(
íåy2
))

3016 i‡(
íåy1
->
e_hash
 !
íåy2
->e_hash ||

3017 
íåy1
->
e_«me_ödex
 !
íåy2
->e_name_index ||

3018 
íåy1
->
e_«me_Àn
 !
íåy2
->e_name_len ||

3019 
íåy1
->
e_vÆue_size
 !
íåy2
->e_value_size ||

3020 
íåy1
->
e_vÆue_öum
 !
íåy2
->e_value_inum ||

3021 
	`memcmp
(
íåy1
->
e_«me
, 
íåy2
->e_«me,É¡ry1->
e_«me_Àn
))

3023 i‡(!
íåy1
->
e_vÆue_öum
 &&

3024 
	`memcmp
((*)
hódî1
 + 
	`À16_to_˝u
(
íåy1
->
e_vÆue_offs
),

3025 (*)
hódî2
 + 
	`À16_to_˝u
(
íåy2
->
e_vÆue_offs
),

3026 
	`À32_to_˝u
(
íåy1
->
e_vÆue_size
)))

3029 
íåy1
 = 
	`PXT4_XATTR_NEXT
(entry1);

3030 
íåy2
 = 
	`PXT4_XATTR_NEXT
(entry2);

3032 i‡(!
	`IS_LAST_ENTRY
(
íåy2
))

3035 
	}
}

3045 
buf„r_hód
 *

3046 
	$pxt4_x©å_block_ˇche_föd
(
öode
 *inode,

3047 
pxt4_x©å_hódî
 *
hódî
,

3048 
mb_ˇche_íåy
 **
p˚
)

3050 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

3051 
mb_ˇche_íåy
 *
˚
;

3052 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

3054 i‡(!
ó_block_ˇche
)

3055  
NULL
;

3056 i‡(!
hódî
->
h_hash
)

3057  
NULL
;

3058 
	`ó_idebug
(
öode
, "lookög f‹ cached block†[%x]", ()
hash
);

3059 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_block_ˇche
, 
hash
);

3060 
˚
) {

3061 
buf„r_hód
 *
bh
;

3063 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
˚
->
e_vÆue
, 
REQ_PRIO
);

3064 i‡(
	`IS_ERR
(
bh
)) {

3065 i‡(
	`PTR_ERR
(
bh
Ë=-
ENOMEM
)

3066  
NULL
;

3067 
bh
 = 
NULL
;

3068 
	`PXT4_ERROR_INODE
(
öode
, "block %luÑeadÉrror",

3069 ()
˚
->
e_vÆue
);

3070 } i‡(
	`pxt4_x©å_cmp
(
hódî
, 
	`BHDR
(
bh
)) == 0) {

3071 *
p˚
 = 
˚
;

3072  
bh
;

3074 
	`bªl£
(
bh
);

3075 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_block_ˇche
, ce);

3077  
NULL
;

3078 
	}
}

3080 
	#NAME_HASH_SHIFT
 5

	)

3081 
	#VALUE_HASH_SHIFT
 16

	)

3088 
__À32
 
	$pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, 
__À32
 *
vÆue
,

3089 
size_t
 
vÆue_cou¡
)

3091 
__u32
 
hash
 = 0;

3093 
«me_Àn
--) {

3094 
hash
 = (hash << 
NAME_HASH_SHIFT
) ^

3095 (
hash
 >> (8*(hashË- 
NAME_HASH_SHIFT
)) ^

3096 *
«me
++;

3098 
vÆue_cou¡
--) {

3099 
hash
 = (hash << 
VALUE_HASH_SHIFT
) ^

3100 (
hash
 >> (8*(hashË- 
VALUE_HASH_SHIFT
)) ^

3101 
	`À32_to_˝u
(*
vÆue
++);

3103  
	`˝u_to_À32
(
hash
);

3104 
	}
}

3106 #unde‡
NAME_HASH_SHIFT


3107 #unde‡
VALUE_HASH_SHIFT


3109 
	#BLOCK_HASH_SHIFT
 16

	)

3116 
	$pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *
hódî
)

3118 
pxt4_x©å_íåy
 *
hîe
;

3119 
__u32
 
hash
 = 0;

3121 
hîe
 = 
	`ENTRY
(
hódî
+1);

3122 !
	`IS_LAST_ENTRY
(
hîe
)) {

3123 i‡(!
hîe
->
e_hash
) {

3125 
hash
 = 0;

3128 
hash
 = (hash << 
BLOCK_HASH_SHIFT
) ^

3129 (
hash
 >> (8*(hashË- 
BLOCK_HASH_SHIFT
)) ^

3130 
	`À32_to_˝u
(
hîe
->
e_hash
);

3131 
hîe
 = 
	`PXT4_XATTR_NEXT
(here);

3133 
hódî
->
h_hash
 = 
	`˝u_to_À32
(
hash
);

3134 
	}
}

3136 #unde‡
BLOCK_HASH_SHIFT


3138 
	#HASH_BUCKET_BITS
 10

	)

3140 
mb_ˇche
 *

3141 
	$pxt4_x©å_¸óã_ˇche
()

3143  
	`mb_ˇche_¸óã
(
HASH_BUCKET_BITS
);

3144 
	}
}

3146 
	$pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *
ˇche
)

3148 i‡(
ˇche
)

3149 
	`mb_ˇche_de°roy
(
ˇche
);

3150 
	}
}

	@xattr.h

10 
	~<löux/x©å.h
>

13 
	#PXT4_XATTR_MAGIC
 0xEA020000

	)

16 
	#PXT4_XATTR_REFCOUNT_MAX
 1024

	)

19 
	#PXT4_XATTR_INDEX_USER
 1

	)

20 
	#PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

21 
	#PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

22 
	#PXT4_XATTR_INDEX_TRUSTED
 4

	)

23 
	#PXT4_XATTR_INDEX_LUSTRE
 5

	)

24 
	#PXT4_XATTR_INDEX_SECURITY
 6

	)

25 
	#PXT4_XATTR_INDEX_SYSTEM
 7

	)

26 
	#PXT4_XATTR_INDEX_RICHACL
 8

	)

27 
	#PXT4_XATTR_INDEX_ENCRYPTION
 9

	)

28 
	#PXT4_XATTR_INDEX_HURD
 10

	)

30 
	spxt4_x©å_hódî
 {

31 
__À32
 
	mh_magic
;

32 
__À32
 
	mh_ªfcou¡
;

33 
__À32
 
	mh_blocks
;

34 
__À32
 
	mh_hash
;

35 
__À32
 
	mh_checksum
;

37 
__u32
 
	mh_ª£rved
[3];

40 
	spxt4_x©å_ibody_hódî
 {

41 
__À32
 
	mh_magic
;

44 
	spxt4_x©å_íåy
 {

45 
__u8
 
	me_«me_Àn
;

46 
__u8
 
	me_«me_ödex
;

47 
__À16
 
	me_vÆue_offs
;

48 
__À32
 
	me_vÆue_öum
;

49 
__À32
 
	me_vÆue_size
;

50 
__À32
 
	me_hash
;

51 
	me_«me
[0];

54 
	#PXT4_XATTR_PAD_BITS
 2

	)

55 
	#PXT4_XATTR_PAD
 (1<<
PXT4_XATTR_PAD_BITS
)

	)

56 
	#PXT4_XATTR_ROUND
 (
PXT4_XATTR_PAD
-1)

	)

57 
	#PXT4_XATTR_LEN
(
«me_Àn
) \

58 (((
«me_Àn
Ë+ 
PXT4_XATTR_ROUND
 + \

59 (
pxt4_x©å_íåy
)Ë& ~
PXT4_XATTR_ROUND
)

	)

60 
	#PXT4_XATTR_NEXT
(
íåy
) \

61 ((
pxt4_x©å_íåy
 *)( \

62 (*)(
íåy
Ë+ 
	`PXT4_XATTR_LEN
(”¡ry)->
e_«me_Àn
)))

	)

63 
	#PXT4_XATTR_SIZE
(
size
) \

64 (((
size
Ë+ 
PXT4_XATTR_ROUND
Ë& ~PXT4_XATTR_ROUND)

	)

66 
	#IHDR
(
öode
, 
øw_öode
) \

67 ((
pxt4_x©å_ibody_hódî
 *) \

68 ((*)
øw_öode
 + \

69 
PXT4_GOOD_OLD_INODE_SIZE
 + \

70 
	`PXT4_I
(
öode
)->
i_exåa_isize
))

	)

71 
	#IFIRST
(
hdr
Ë((
pxt4_x©å_íåy
 *)((hdr)+1))

	)

82 
	#PXT4_XATTR_SIZE_MAX
 (1 << 24)

	)

88 
	#PXT4_XATTR_MIN_LARGE_EA_SIZE
(
b
) \

89 ((
b
Ë- 
	`PXT4_XATTR_LEN
(3Ë- (
pxt4_x©å_hódî
Ë- 4)

	)

91 
	#BHDR
(
bh
Ë((
pxt4_x©å_hódî
 *)((bh)->
b_d©a
))

	)

92 
	#ENTRY
(
±r
Ë((
pxt4_x©å_íåy
 *)’å))

	)

93 
	#BFIRST
(
bh
Ë
	`ENTRY
(
	`BHDR
(bh)+1)

	)

94 
	#IS_LAST_ENTRY
(
íåy
Ë(*(
__u32
 *)”¡ryË=0)

	)

96 
	#PXT4_ZERO_XATTR_VALUE
 ((*)-1)

	)

98 
	spxt4_x©å_öfo
 {

99 c⁄° *
	m«me
;

100 c⁄° *
	mvÆue
;

101 
size_t
 
	mvÆue_Àn
;

102 
	m«me_ödex
;

103 
	mö_öode
;

106 
	spxt4_x©å_£¨ch
 {

107 
pxt4_x©å_íåy
 *
	mfú°
;

108 *
	mba£
;

109 *
	míd
;

110 
pxt4_x©å_íåy
 *
	mhîe
;

111 
	mnŸ_found
;

114 
	spxt4_x©å_ibody_föd
 {

115 
pxt4_x©å_£¨ch
 
	ms
;

116 
pxt4_ûoc
 
	mûoc
;

119 
	spxt4_x©å_öode_¨øy
 {

120 
	mcou¡
;

121 
öode
 *
	möodes
[0];

124 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_u£r_h™dÀr
;

125 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_åu°ed_h™dÀr
;

126 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_£curôy_h™dÀr
;

128 
	#PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

139 
ölöe
 
	$pxt4_wrôe_lock_x©å
(
öode
 *öode, *
ßve
)

141 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

142 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

143 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

144 
	}
}

146 
ölöe
 
	$pxt4_wrôe_åylock_x©å
(
öode
 *öode, *
ßve
)

148 i‡(
	`down_wrôe_åylock
(&
	`PXT4_I
(
öode
)->
x©å_£m
) == 0)

150 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

151 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

153 
	}
}

155 
ölöe
 
	$pxt4_wrôe_u∆ock_x©å
(
öode
 *öode, *
ßve
)

157 i‡(*
ßve
 == 0)

158 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

159 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

160 
	}
}

162 
ssize_t
 
pxt4_li°x©å
(
díåy
 *, *, 
size_t
);

164 
pxt4_x©å_gë
(
öode
 *, , c⁄° *, *, 
size_t
);

165 
pxt4_x©å_£t
(
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

166 
pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *, 
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

167 
pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

168 
boﬁ
 
is_¸óã
, *
¸edôs
);

169 
__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

170 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

171 
boﬁ
 
is_¸óã
);

173 
pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

174 
pxt4_x©å_öode_¨øy
 **
¨øy
,

175 
exåa_¸edôs
);

176 
pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
¨øy
);

178 
pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

179 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
);

181 c⁄° 
x©å_h™dÀr
 *
pxt4_x©å_h™dÀrs
[];

183 
pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

184 
pxt4_x©å_ibody_föd
 *
is
);

185 
pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
,

186 c⁄° *
«me
,

187 *
buf„r
, 
size_t
 
buf„r_size
);

188 
pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

189 
pxt4_x©å_öfo
 *
i
,

190 
pxt4_x©å_ibody_föd
 *
is
);

192 
mb_ˇche
 *
pxt4_x©å_¸óã_ˇche
();

193 
pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *);

195 #ifde‡
CONFIG_PXT4_FS_SECURITY


196 
pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

197 
öode
 *
dú
, c⁄° 
q°r
 *qstr);

199 
ölöe
 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

200 
öode
 *
dú
, c⁄° 
q°r
 *qstr)

203 
	}
}

206 #ifde‡
CONFIG_LOCKDEP


207 
pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
);

209 
ölöe
 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
Ë{ 
	}
}

212 
pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
);

	@xattr_security.c

7 
	~<löux/°rög.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/£curôy.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

16 
	$pxt4_x©å_£curôy_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

17 
díåy
 *
unu£d
, 
öode
 *inode,

18 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

20  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

21 
«me
, 
buf„r
, 
size
);

22 
	}
}

25 
	$pxt4_x©å_£curôy_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

26 
díåy
 *
unu£d
, 
öode
 *inode,

27 c⁄° *
«me
, c⁄° *
vÆue
,

28 
size_t
 
size
, 
Êags
)

30  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

31 
«me
, 
vÆue
, 
size
, 
Êags
);

32 
	}
}

35 
	$pxt4_öôx©ås
(
öode
 *öode, c⁄° 
x©å
 *
x©å_¨øy
,

36 *
fs_öfo
)

38 c⁄° 
x©å
 *xattr;

39 
h™dÀ_t
 *
h™dÀ
 = 
fs_öfo
;

40 
îr
 = 0;

42 
x©å
 = 
x©å_¨øy
; x©å->
«me
 !
NULL
; xattr++) {

43 
îr
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

44 
PXT4_XATTR_INDEX_SECURITY
,

45 
x©å
->
«me
, x©å->
vÆue
,

46 
x©å
->
vÆue_Àn
, 
XATTR_CREATE
);

47 i‡(
îr
 < 0)

50  
îr
;

51 
	}
}

54 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
,

55 c⁄° 
q°r
 *qstr)

57  
	`£curôy_öode_öô_£curôy
(
öode
, 
dú
, 
q°r
,

58 &
pxt4_öôx©ås
, 
h™dÀ
);

59 
	}
}

61 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_£curôy_h™dÀr
 = {

62 .
¥efix
 = 
XATTR_SECURITY_PREFIX
,

63 .
	ggë
 = 
pxt4_x©å_£curôy_gë
,

64 .
	g£t
 = 
pxt4_x©å_£curôy_£t
,

	@xattr_trusted.c

9 
	~<löux/°rög.h
>

10 
	~<löux/ˇ∑bûôy.h
>

11 
	~<löux/fs.h
>

12 
	~"pxt4_jbd3.h
"

13 
	~"pxt4.h
"

14 
	~"x©å.h
"

16 
boﬁ


17 
	$pxt4_x©å_åu°ed_li°
(
díåy
 *dentry)

19  
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
);

20 
	}
}

23 
	$pxt4_x©å_åu°ed_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

24 
díåy
 *
unu£d
, 
öode
 *inode,

25 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

27  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

28 
«me
, 
buf„r
, 
size
);

29 
	}
}

32 
	$pxt4_x©å_åu°ed_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

33 
díåy
 *
unu£d
, 
öode
 *inode,

34 c⁄° *
«me
, c⁄° *
vÆue
,

35 
size_t
 
size
, 
Êags
)

37  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

38 
«me
, 
vÆue
, 
size
, 
Êags
);

39 
	}
}

41 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_åu°ed_h™dÀr
 = {

42 .
¥efix
 = 
XATTR_TRUSTED_PREFIX
,

43 .
	gli°
 = 
pxt4_x©å_åu°ed_li°
,

44 .
	ggë
 = 
pxt4_x©å_åu°ed_gë
,

45 .
	g£t
 = 
pxt4_x©å_åu°ed_£t
,

	@xattr_user.c

9 
	~<löux/°rög.h
>

10 
	~<löux/fs.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

15 
boﬁ


16 
	$pxt4_x©å_u£r_li°
(
díåy
 *dentry)

18  
	`ã°_›t
(
díåy
->
d_sb
, 
XATTR_USER
);

19 
	}
}

22 
	$pxt4_x©å_u£r_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

23 
díåy
 *
unu£d
, 
öode
 *inode,

24 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

26 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

27  -
EOPNOTSUPP
;

28  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_USER
,

29 
«me
, 
buf„r
, 
size
);

30 
	}
}

33 
	$pxt4_x©å_u£r_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

34 
díåy
 *
unu£d
, 
öode
 *inode,

35 c⁄° *
«me
, c⁄° *
vÆue
,

36 
size_t
 
size
, 
Êags
)

38 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

39  -
EOPNOTSUPP
;

40  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_USER
,

41 
«me
, 
vÆue
, 
size
, 
Êags
);

42 
	}
}

44 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_u£r_h™dÀr
 = {

45 .
¥efix
 = 
XATTR_USER_PREFIX
,

46 .
	gli°
 = 
pxt4_x©å_u£r_li°
,

47 .
	ggë
 = 
pxt4_x©å_u£r_gë
,

48 .
	g£t
 = 
pxt4_x©å_u£r_£t
,

	@/usr/include/linux/capability.h

14 #i‚de‡
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<löux/ty≥s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ˇp_hódî_°ru˘
 {

40 
__u32
 
	mvîsi⁄
;

41 
	mpid
;

42 } *
	tˇp_u£r_hódî_t
;

44 
	s__u£r_ˇp_d©a_°ru˘
 {

45 
__u32
 
	mef„˘ive
;

46 
__u32
 
	m≥rmôãd
;

47 
__u32
 
	möhîôabÀ
;

48 } *
	tˇp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__À32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ˇp_d©a
 {

73 
__À32
 
	mmagic_ëc
;

75 
__À32
 
	m≥rmôãd
;

76 
__À32
 
	möhîôabÀ
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ˇp_d©a
 {

84 
__À32
 
	mmagic_ëc
;

86 
__À32
 
	m≥rmôãd
;

87 
__À32
 
	möhîôabÀ
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__À32
 
	mroŸid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

289 
	#CAP_SYS_NICE
 23

	)

303 
	#CAP_SYS_RESOURCE
 24

	)

309 
	#CAP_SYS_TIME
 25

	)

314 
	#CAP_SYS_TTY_CONFIG
 26

	)

318 
	#CAP_MKNOD
 27

	)

322 
	#CAP_LEASE
 28

	)

326 
	#CAP_AUDIT_WRITE
 29

	)

330 
	#CAP_AUDIT_CONTROL
 30

	)

332 
	#CAP_SETFCAP
 31

	)

340 
	#CAP_MAC_OVERRIDE
 32

	)

349 
	#CAP_MAC_ADMIN
 33

	)

353 
	#CAP_SYSLOG
 34

	)

357 
	#CAP_WAKE_ALARM
 35

	)

361 
	#CAP_BLOCK_SUSPEND
 36

	)

365 
	#CAP_AUDIT_READ
 37

	)

368 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

370 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

376 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

377 
	#CAP_TO_MASK
(
x
Ë(1 << ((xË& 31)Ë

	)

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/falloc.h

2 #i‚de‡
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fcntl.h

2 #i‚de‡
_LINUX_FCNTL_H


3 
	#_LINUX_FCNTL_H


	)

5 
	~<asm/f˙é.h
>

7 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

8 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

14 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

17 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

23 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

28 
	#F_SETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 7)

	)

29 
	#F_GETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 8)

	)

34 
	#F_ADD_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 9)

	)

35 
	#F_GET_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 10)

	)

40 
	#F_SEAL_SEAL
 0x0001

	)

41 
	#F_SEAL_SHRINK
 0x0002

	)

42 
	#F_SEAL_GROW
 0x0004

	)

43 
	#F_SEAL_WRITE
 0x0008

	)

44 
	#F_SEAL_FUTURE_WRITE
 0x0010

	)

52 
	#F_GET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 11)

	)

53 
	#F_SET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 12)

	)

54 
	#F_GET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 13)

	)

55 
	#F_SET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 14)

	)

61 
	#RWF_WRITE_LIFE_NOT_SET
 0

	)

62 
	#RWH_WRITE_LIFE_NONE
 1

	)

63 
	#RWH_WRITE_LIFE_SHORT
 2

	)

64 
	#RWH_WRITE_LIFE_MEDIUM
 3

	)

65 
	#RWH_WRITE_LIFE_LONG
 4

	)

66 
	#RWH_WRITE_LIFE_EXTREME
 5

	)

71 
	#DN_ACCESS
 0x00000001

	)

72 
	#DN_MODIFY
 0x00000002

	)

73 
	#DN_CREATE
 0x00000004

	)

74 
	#DN_DELETE
 0x00000008

	)

75 
	#DN_RENAME
 0x00000010

	)

76 
	#DN_ATTRIB
 0x00000020

	)

77 
	#DN_MULTISHOT
 0x80000000

	)

79 
	#AT_FDCWD
 -100

	)

82 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

83 
	#AT_REMOVEDIR
 0x200

	)

85 
	#AT_SYMLINK_FOLLOW
 0x400

	)

86 
	#AT_NO_AUTOMOUNT
 0x800

	)

87 
	#AT_EMPTY_PATH
 0x1000

	)

89 
	#AT_STATX_SYNC_TYPE
 0x6000

	)

90 
	#AT_STATX_SYNC_AS_STAT
 0x0000

	)

91 
	#AT_STATX_FORCE_SYNC
 0x2000

	)

92 
	#AT_STATX_DONT_SYNC
 0x4000

	)

94 
	#AT_RECURSIVE
 0x8000

	)

	@/usr/include/linux/fiemap.h

12 #i‚de‡
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<löux/ty≥s.h
>

17 
	sfõm≠_exã¡
 {

18 
__u64
 
	m„_logiˇl
;

20 
__u64
 
	m„_physiˇl
;

22 
__u64
 
	m„_Àngth
;

23 
__u64
 
	m„_ª£rved64
[2];

24 
__u32
 
	m„_Êags
;

25 
__u32
 
	m„_ª£rved
[3];

28 
	sfõm≠
 {

29 
__u64
 
	mfm_°¨t
;

31 
__u64
 
	mfm_Àngth
;

33 
__u32
 
	mfm_Êags
;

34 
__u32
 
	mfm_m≠≥d_exã¡s
;

35 
__u32
 
	mfm_exã¡_cou¡
;

36 
__u32
 
	mfm_ª£rved
;

37 
fõm≠_exã¡
 
	mfm_exã¡s
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/fs¸y±.h
>

19 
	~<löux/mou¡.h
>

32 #unde‡
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

47 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

48 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

50 
	sfûe_˛⁄e_ønge
 {

51 
__s64
 
	m§c_fd
;

52 
__u64
 
	m§c_off£t
;

53 
__u64
 
	m§c_Àngth
;

54 
__u64
 
	mde°_off£t
;

57 
	sf°rim_ønge
 {

58 
__u64
 
	m°¨t
;

59 
__u64
 
	mÀn
;

60 
__u64
 
	mmöÀn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfûe_dedu≥_ønge_öfo
 {

69 
__s64
 
	mde°_fd
;

70 
__u64
 
	mde°_off£t
;

71 
__u64
 
	mbyãs_dedu≥d
;

78 
__s32
 
	m°©us
;

79 
__u32
 
	mª£rved
;

83 
	sfûe_dedu≥_ønge
 {

84 
__u64
 
	m§c_off£t
;

85 
__u64
 
	m§c_Àngth
;

86 
__u16
 
	mde°_cou¡
;

87 
__u16
 
	mª£rved1
;

88 
__u32
 
	mª£rved2
;

89 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

93 
	sfûes_°©_°ru˘
 {

94 
	mƒ_fûes
;

95 
	mƒ_‰ì_fûes
;

96 
	mmax_fûes
;

99 
	söodes_°©_t
 {

100 
	mƒ_öodes
;

101 
	mƒ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©å
 {

112 
__u32
 
	mfsx_xÊags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_√xã¡s
;

115 
__u32
 
	mfsx_¥ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_∑d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

188 
	#BMAP_IOCTL
 1

	)

189 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

190 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

191 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

192 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

193 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

194 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

195 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

196 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

198 
	#FSLABEL_MAX
 256

	)

200 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

201 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

202 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

203 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

204 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

205 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

206 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

207 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

208 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

209 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©å
)

	)

210 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©å
)

	)

211 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

212 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

234 
	#FS_SECRM_FL
 0x00000001

	)

235 
	#FS_UNRM_FL
 0x00000002

	)

236 
	#FS_COMPR_FL
 0x00000004

	)

237 
	#FS_SYNC_FL
 0x00000008

	)

238 
	#FS_IMMUTABLE_FL
 0x00000010

	)

239 
	#FS_APPEND_FL
 0x00000020

	)

240 
	#FS_NODUMP_FL
 0x00000040

	)

241 
	#FS_NOATIME_FL
 0x00000080

	)

243 
	#FS_DIRTY_FL
 0x00000100

	)

244 
	#FS_COMPRBLK_FL
 0x00000200

	)

245 
	#FS_NOCOMP_FL
 0x00000400

	)

247 
	#FS_ENCRYPT_FL
 0x00000800

	)

248 
	#FS_BTREE_FL
 0x00001000

	)

249 
	#FS_INDEX_FL
 0x00001000

	)

250 
	#FS_IMAGIC_FL
 0x00002000

	)

251 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

252 
	#FS_NOTAIL_FL
 0x00008000

	)

253 
	#FS_DIRSYNC_FL
 0x00010000

	)

254 
	#FS_TOPDIR_FL
 0x00020000

	)

255 
	#FS_HUGE_FILE_FL
 0x00040000

	)

256 
	#FS_EXTENT_FL
 0x00080000

	)

257 
	#FS_VERITY_FL
 0x00100000

	)

258 
	#FS_EA_INODE_FL
 0x00200000

	)

259 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

260 
	#FS_NOCOW_FL
 0x00800000

	)

261 
	#FS_INLINE_DATA_FL
 0x10000000

	)

262 
	#FS_PROJINHERIT_FL
 0x20000000

	)

263 
	#FS_CASEFOLD_FL
 0x40000000

	)

264 
	#FS_RESERVED_FL
 0x80000000

	)

266 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

267 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

270 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

271 
	#SYNC_FILE_RANGE_WRITE
 2

	)

272 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

273 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

274 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

275 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

281 
	t__bôwi£
 
	t__kî√l_rwf_t
;

284 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

287 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

290 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

293 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

296 
	#RWF_APPEND
 ((
__kî√l_rwf_t
)0x00000010)

	)

299 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

300 
RWF_APPEND
)

	)

	@/usr/include/linux/fscrypt.h

8 #i‚de‡
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<löux/ty≥s.h
>

14 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

15 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

20 
	#FSCRYPT_POLICY_FLAGS_VALID
 0x07

	)

23 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

24 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

25 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

26 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

27 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

28 
	#__FSCRYPT_MODE_MAX
 9

	)

36 
	#FSCRYPT_POLICY_V1
 0

	)

37 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

38 
	sfs¸y±_pﬁicy_v1
 {

39 
__u8
 
	mvîsi⁄
;

40 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

41 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

42 
__u8
 
	mÊags
;

43 
__u8
 
	mma°î_key_des¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

45 
	#fs¸y±_pﬁicy
 
fs¸y±_pﬁicy_v1


	)

51 
	#FSCRYPT_KEY_DESC_PREFIX
 "fs¸y±:"

	)

52 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

53 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

54 
	sfs¸y±_key
 {

55 
__u32
 
	mmode
;

56 
__u8
 
	møw
[
FSCRYPT_MAX_KEY_SIZE
];

57 
__u32
 
	msize
;

63 
	#FSCRYPT_POLICY_V2
 2

	)

64 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

65 
	sfs¸y±_pﬁicy_v2
 {

66 
__u8
 
	mvîsi⁄
;

67 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

68 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

69 
__u8
 
	mÊags
;

70 
__u8
 
	m__ª£rved
[4];

71 
__u8
 
	mma°î_key_idítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

75 
	sfs¸y±_gë_pﬁicy_ex_¨g
 {

76 
__u64
 
	mpﬁicy_size
;

78 
__u8
 
	mvîsi⁄
;

79 
fs¸y±_pﬁicy_v1
 
	mv1
;

80 
fs¸y±_pﬁicy_v2
 
	mv2
;

81 } 
	mpﬁicy
;

88 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

95 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

101 
	sfs¸y±_key_•ecifõr
 {

102 
__u32
 
	mty≥
;

103 
__u32
 
	m__ª£rved
;

105 
__u8
 
	m__ª£rved
[32];

106 
__u8
 
	mdes¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

107 
__u8
 
	midítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

108 } 
	mu
;

112 
	sfs¸y±_add_key_¨g
 {

113 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

114 
__u32
 
	møw_size
;

115 
__u32
 
	m__ª£rved
[9];

116 
__u8
 
	møw
[];

120 
	sfs¸y±_ªmove_key_¨g
 {

121 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

122 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

123 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

124 
__u32
 
	mªmovÆ_°©us_Êags
;

125 
__u32
 
	m__ª£rved
[5];

129 
	sfs¸y±_gë_key_°©us_¨g
 {

131 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

132 
__u32
 
	m__ª£rved
[6];

135 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

136 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

137 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

138 
__u32
 
	m°©us
;

139 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

140 
__u32
 
	m°©us_Êags
;

141 
__u32
 
	mu£r_cou¡
;

142 
__u32
 
	m__out_ª£rved
[13];

145 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy
)

	)

146 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

147 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy
)

	)

148 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]Ë

	)

149 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fs¸y±_add_key_¨g
)

	)

150 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fs¸y±_ªmove_key_¨g
)

	)

151 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fs¸y±_ªmove_key_¨g
)

	)

152 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fs¸y±_gë_key_°©us_¨g
)

	)

157 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

158 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

159 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

160 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

161 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

162 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

163 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

164 
	#FS_POLICY_FLAGS_VALID
 
FSCRYPT_POLICY_FLAGS_VALID


	)

165 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

166 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

167 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

168 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

169 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

170 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

171 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

172 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

173 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

174 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

175 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

176 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

177 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/fsmap.h

9 #i‚de‡
_LINUX_FSMAP_H


10 
	#_LINUX_FSMAP_H


	)

12 
	~<löux/ty≥s.h
>

50 
	sfsm≠
 {

51 
__u32
 
	mfmr_devi˚
;

52 
__u32
 
	mfmr_Êags
;

53 
__u64
 
	mfmr_physiˇl
;

54 
__u64
 
	mfmr_ow√r
;

55 
__u64
 
	mfmr_off£t
;

56 
__u64
 
	mfmr_Àngth
;

57 
__u64
 
	mfmr_ª£rved
[3];

60 
	sfsm≠_hód
 {

61 
__u32
 
	mfmh_iÊags
;

62 
__u32
 
	mfmh_oÊags
;

63 
__u32
 
	mfmh_cou¡
;

64 
__u32
 
	mfmh_íåõs
;

65 
__u64
 
	mfmh_ª£rved
[6];

67 
fsm≠
 
	mfmh_keys
[2];

68 
fsm≠
 
	mfmh_ªcs
[];

72 
__ölöe__
 
size_t


73 
	$fsm≠_sizeof
(

74 
ƒ
)

76  (
fsm≠_hód
Ë+ 
ƒ
 * (
fsm≠
);

77 
	}
}

80 
__ölöe__
 

81 
	$fsm≠_adv™˚
(

82 
fsm≠_hód
 *
hód
)

84 
hód
->
fmh_keys
[0] = hód->
fmh_ªcs
[hód->
fmh_íåõs
 - 1];

85 
	}
}

89 
	#FMH_IF_VALID
 0

	)

92 
	#FMH_OF_DEV_T
 0x1

	)

95 
	#FMR_OF_PREALLOC
 0x1

	)

96 
	#FMR_OF_ATTR_FORK
 0x2

	)

97 
	#FMR_OF_EXTENT_MAP
 0x4

	)

98 
	#FMR_OF_SHARED
 0x8

	)

99 
	#FMR_OF_SPECIAL_OWNER
 0x10

	)

100 
	#FMR_OF_LAST
 0x20

	)

103 
	#FMR_OWNER
(
ty≥
, 
code
Ë(((
__u64
)type << 32) | \

104 ((
__u64
)
code
 & 0xFFFFFFFFULL))

	)

105 
	#FMR_OWNER_TYPE
(
ow√r
Ë((
__u32
)((
__u64
)ow√∏>> 32))

	)

106 
	#FMR_OWNER_CODE
(
ow√r
Ë((
__u32
)(((
__u64
)ow√∏& 0xFFFFFFFFULL)))

	)

107 
	#FMR_OWN_FREE
 
	`FMR_OWNER
(0, 1Ë

	)

108 
	#FMR_OWN_UNKNOWN
 
	`FMR_OWNER
(0, 2Ë

	)

109 
	#FMR_OWN_METADATA
 
	`FMR_OWNER
(0, 3Ë

	)

111 
	#FS_IOC_GETFSMAP
 
	`_IOWR
('X', 59, 
fsm≠_hód
)

	)

	@/usr/include/linux/fsverity.h

10 #i‚de‡
_LINUX_FSVERITY_H


11 
	#_LINUX_FSVERITY_H


	)

13 
	~<löux/io˘l.h
>

14 
	~<löux/ty≥s.h
>

16 
	#FS_VERITY_HASH_ALG_SHA256
 1

	)

17 
	#FS_VERITY_HASH_ALG_SHA512
 2

	)

19 
	sfsvîôy_íabÀ_¨g
 {

20 
__u32
 
	mvîsi⁄
;

21 
__u32
 
	mhash_Æg‹ôhm
;

22 
__u32
 
	mblock_size
;

23 
__u32
 
	mß…_size
;

24 
__u64
 
	mß…_±r
;

25 
__u32
 
	msig_size
;

26 
__u32
 
	m__ª£rved1
;

27 
__u64
 
	msig_±r
;

28 
__u64
 
	m__ª£rved2
[11];

31 
	sfsvîôy_dige°
 {

32 
__u16
 
	mdige°_Æg‹ôhm
;

33 
__u16
 
	mdige°_size
;

34 
__u8
 
	mdige°
[];

37 
	#FS_IOC_ENABLE_VERITY
 
	`_IOW
('f', 133, 
fsvîôy_íabÀ_¨g
)

	)

38 
	#FS_IOC_MEASURE_VERITY
 
	`_IOWR
('f', 134, 
fsvîôy_dige°
)

	)

	@/usr/include/linux/kdev_t.h

2 #i‚de‡
_LINUX_KDEV_T_H


3 
	#_LINUX_KDEV_T_H


	)

9 
	#MAJOR
(
dev
Ë((dev)>>8)

	)

10 
	#MINOR
(
dev
Ë((devË& 0xff)

	)

11 
	#MKDEV
(
ma
,
mi
Ë((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

2 #i‚de‡
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<löux/sysöfo.h
>

10 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

11 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

13 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/magic.h

2 #i‚de‡
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EROFS_SUPER_MAGIC_V1
 0xE0F5E1E2

	)

23 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

24 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

25 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

26 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

27 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

28 
	#NILFS_SUPER_MAGIC
 0x3434

	)

29 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

30 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

31 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

32 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

33 
	#XFS_SUPER_MAGIC
 0x58465342

	)

34 
	#PSTOREFS_MAGIC
 0x6165676C

	)

35 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

36 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

37 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

39 
	#MINIX_SUPER_MAGIC
 0x137F

	)

40 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

41 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

42 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

43 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

45 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

46 
	#NCP_SUPER_MAGIC
 0x564¯

	)

47 
	#NFS_SUPER_MAGIC
 0x6969

	)

48 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

49 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

50 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

51 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

52 
	#AFS_FS_MAGIC
 0x6B414653

	)

54 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

57 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

58 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

59 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

61 
	#SMB_SUPER_MAGIC
 0x517B

	)

62 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

63 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

65 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

67 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

69 
	#TRACEFS_MAGIC
 0x74726163

	)

71 
	#V9FS_MAGIC
 0x01021997

	)

73 
	#BDEVFS_MAGIC
 0x62646576

	)

74 
	#DAXFS_MAGIC
 0x64646178

	)

75 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

76 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

77 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

78 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

79 
	#PIPEFS_MAGIC
 0x50495045

	)

80 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

81 
	#SOCKFS_MAGIC
 0x534F434B

	)

82 
	#SYSFS_MAGIC
 0x62656572

	)

83 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

84 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

85 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

86 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

87 
	#NSFS_MAGIC
 0x6e736673

	)

88 
	#BPF_FS_MAGIC
 0xˇ„4a11

	)

89 
	#AAFS_MAGIC
 0x5a3c69f0

	)

92 
	#UDF_SUPER_MAGIC
 0x15013346

	)

93 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

94 
	#ZSMALLOC_MAGIC
 0x58295829

	)

95 
	#DMA_BUF_MAGIC
 0x444d4142

	)

96 
	#DEVMEM_MAGIC
 0x454d444d

	)

97 
	#Z3FOLD_MAGIC
 0x33

	)

99 
	#SHIFTFS_MAGIC
 0x6a656a62

	)

	@/usr/include/linux/mman.h

2 #i‚de‡
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mm™.h
>

6 
	~<asm-gíîic/hugëlb_ícode.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

11 
	#OVERCOMMIT_GUESS
 0

	)

12 
	#OVERCOMMIT_ALWAYS
 1

	)

13 
	#OVERCOMMIT_NEVER
 2

	)

15 
	#MAP_SHARED
 0x01

	)

16 
	#MAP_PRIVATE
 0x02

	)

17 
	#MAP_SHARED_VALIDATE
 0x03

	)

26 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

27 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

29 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

30 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

31 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

32 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

33 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

34 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

35 
	#MAP_HUGE_32MB
 
HUGETLB_FLAG_ENCODE_32MB


	)

36 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

37 
	#MAP_HUGE_512MB
 
HUGETLB_FLAG_ENCODE_512MB


	)

38 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

39 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

40 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #i‚de‡
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

11 
	#MS_RDONLY
 1

	)

12 
	#MS_NOSUID
 2

	)

13 
	#MS_NODEV
 4

	)

14 
	#MS_NOEXEC
 8

	)

15 
	#MS_SYNCHRONOUS
 16

	)

16 
	#MS_REMOUNT
 32

	)

17 
	#MS_MANDLOCK
 64

	)

18 
	#MS_DIRSYNC
 128

	)

19 
	#MS_NOATIME
 1024

	)

20 
	#MS_NODIRATIME
 2048

	)

21 
	#MS_BIND
 4096

	)

22 
	#MS_MOVE
 8192

	)

23 
	#MS_REC
 16384

	)

24 
	#MS_VERBOSE
 32768

	)

26 
	#MS_SILENT
 32768

	)

27 
	#MS_POSIXACL
 (1<<16Ë

	)

28 
	#MS_UNBINDABLE
 (1<<17Ë

	)

29 
	#MS_PRIVATE
 (1<<18Ë

	)

30 
	#MS_SLAVE
 (1<<19Ë

	)

31 
	#MS_SHARED
 (1<<20Ë

	)

32 
	#MS_RELATIME
 (1<<21Ë

	)

33 
	#MS_KERNMOUNT
 (1<<22Ë

	)

34 
	#MS_I_VERSION
 (1<<23Ë

	)

35 
	#MS_STRICTATIME
 (1<<24Ë

	)

36 
	#MS_LAZYTIME
 (1<<25Ë

	)

39 
	#MS_SUBMOUNT
 (1<<26)

	)

40 
	#MS_NOREMOTELOCK
 (1<<27)

	)

41 
	#MS_NOSEC
 (1<<28)

	)

42 
	#MS_BORN
 (1<<29)

	)

43 
	#MS_ACTIVE
 (1<<30)

	)

44 
	#MS_NOUSER
 (1<<31)

	)

49 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

50 
MS_LAZYTIME
)

	)

55 
	#MS_MGC_VAL
 0xC0ED0000

	)

56 
	#MS_MGC_MSK
 0xffff0000

	)

61 
	#OPEN_TREE_CLONE
 1

	)

62 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

67 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

68 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

69 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

70 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

71 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

72 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

73 
	#MOVE_MOUNT__MASK
 0x00000077

	)

78 
	#FSOPEN_CLOEXEC
 0x00000001

	)

83 
	#FSPICK_CLOEXEC
 0x00000001

	)

84 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

85 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

86 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

91 
	efsc⁄fig_comm™d
 {

92 
	mFSCONFIG_SET_FLAG
 = 0,

93 
	mFSCONFIG_SET_STRING
 = 1,

94 
	mFSCONFIG_SET_BINARY
 = 2,

95 
	mFSCONFIG_SET_PATH
 = 3,

96 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

97 
	mFSCONFIG_SET_FD
 = 5,

98 
	mFSCONFIG_CMD_CREATE
 = 6,

99 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

105 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

110 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

111 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

112 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

113 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

114 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

115 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

116 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

117 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

118 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #i‚de‡
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<löux/ty≥s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_a˛_x©å_íåy
 {

30 
__À16
 
	me_èg
;

31 
__À16
 
	me_≥rm
;

32 
__À32
 
	me_id
;

35 
	sposix_a˛_x©å_hódî
 {

36 
__À32
 
	ma_vîsi⁄
;

	@/usr/include/linux/quota.h

33 #i‚de‡
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<löux/ty≥s.h
>

38 
	#__DQUOT_VERSION__
 "dquŸ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty≥
Ë(((cmdË<< 
SUBCMDSHIFT
Ë| (—y≥Ë& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¨dlimô
;

112 
__u64
 
	mdqb_bso·limô
;

113 
__u64
 
	mdqb_cur•a˚
;

114 
__u64
 
	mdqb_ih¨dlimô
;

115 
__u64
 
	mdqb_iso·limô
;

116 
__u64
 
	mdqb_curöodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_ôime
;

119 
__u32
 
	mdqb_vÆid
;

122 
	sif_√xtdqblk
 {

123 
__u64
 
	mdqb_bh¨dlimô
;

124 
__u64
 
	mdqb_bso·limô
;

125 
__u64
 
	mdqb_cur•a˚
;

126 
__u64
 
	mdqb_ih¨dlimô
;

127 
__u64
 
	mdqb_iso·limô
;

128 
__u64
 
	mdqb_curöodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_ôime
;

131 
__u32
 
	mdqb_vÆid
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqöfo
 {

157 
__u64
 
	mdqi_bgø˚
;

158 
__u64
 
	mdqi_igø˚
;

159 
__u32
 
	mdqi_Êags
;

160 
__u32
 
	mdqi_vÆid
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #i‚de‡
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<löux/ty≥s.h
>

12 
	~<löux/io˘l.h
>

13 
	~<löux/úqƒ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
–'R', 0x07 )

	)

41 
	sønd_poﬁ_öfo
 {

42 
	míå›y_cou¡
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #i‚de‡
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<löux/ty≥s.h
>

10 
	#CSIGNAL
 0x000000f‡

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

36 #i‚de‡
__ASSEMBLY__


66 
	s˛⁄e_¨gs
 {

67 
__Æig√d_u64
 
	mÊags
;

68 
__Æig√d_u64
 
	mpidfd
;

69 
__Æig√d_u64
 
	mchûd_tid
;

70 
__Æig√d_u64
 
	m∑ª¡_tid
;

71 
__Æig√d_u64
 
	mexô_sig«l
;

72 
__Æig√d_u64
 
	m°ack
;

73 
__Æig√d_u64
 
	m°ack_size
;

74 
__Æig√d_u64
 
	més
;

78 
	#CLONE_ARGS_SIZE_VER0
 64

	)

83 
	#SCHED_NORMAL
 0

	)

84 
	#SCHED_FIFO
 1

	)

85 
	#SCHED_RR
 2

	)

86 
	#SCHED_BATCH
 3

	)

88 
	#SCHED_IDLE
 5

	)

89 
	#SCHED_DEADLINE
 6

	)

92 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

97 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

98 
	#SCHED_FLAG_RECLAIM
 0x02

	)

99 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

100 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

101 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

102 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

103 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

105 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

106 
SCHED_FLAG_KEEP_PARAMS
)

	)

108 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

109 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

111 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

112 
SCHED_FLAG_RECLAIM
 | \

113 
SCHED_FLAG_DL_OVERRUN
 | \

114 
SCHED_FLAG_KEEP_ALL
 | \

115 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/stat.h

2 #i‚de‡
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<löux/ty≥s.h
>

7 #i‡
deföed
(
__KERNEL__
Ë|| !deföed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s°©x_time°amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__ª£rved
;

99 
	s°©x
 {

101 
__u32
 
	m°x_mask
;

102 
__u32
 
	m°x_blksize
;

103 
__u64
 
	m°x_©åibuãs
;

105 
__u32
 
	m°x_∆ök
;

106 
__u32
 
	m°x_uid
;

107 
__u32
 
	m°x_gid
;

108 
__u16
 
	m°x_mode
;

109 
__u16
 
	m__•¨e0
[1];

111 
__u64
 
	m°x_öo
;

112 
__u64
 
	m°x_size
;

113 
__u64
 
	m°x_blocks
;

114 
__u64
 
	m°x_©åibuãs_mask
;

116 
°©x_time°amp
 
	m°x_©ime
;

117 
°©x_time°amp
 
	m°x_btime
;

118 
°©x_time°amp
 
	m°x_˘ime
;

119 
°©x_time°amp
 
	m°x_mtime
;

121 
__u32
 
	m°x_rdev_maj‹
;

122 
__u32
 
	m°x_rdev_mö‹
;

123 
__u32
 
	m°x_dev_maj‹
;

124 
__u32
 
	m°x_dev_mö‹
;

126 
__u64
 
	m__•¨e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/string.h

2 #i‚de‡
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<°rög.h
>

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/time_ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	stimez⁄e
 {

22 
	mtz_möuãswe°
;

23 
	mtz_d°time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	sôimî•ec
 {

35 
time•ec
 
	mô_öãrvÆ
;

36 
time•ec
 
	mô_vÆue
;

39 
	sôimîvÆ
 {

40 
timevÆ
 
	mô_öãrvÆ
;

41 
timevÆ
 
	mô_vÆue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	t__bôwi£
 
	t__pﬁl_t
;

	@/usr/include/linux/uio.h

10 #i‚de‡
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<löux/ty≥s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__kî√l_size_t
 
	miov_Àn
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/utsname.h

2 #i‚de‡
_LINUX_UTSNAME_H


3 
	#_LINUX_UTSNAME_H


	)

5 
	#__OLD_UTS_LEN
 8

	)

7 
	sﬁdﬁd_ut¢ame
 {

8 
	msy¢ame
[9];

9 
	mnodíame
[9];

10 
	mªÀa£
[9];

11 
	mvîsi⁄
[9];

12 
	mmachöe
[9];

15 
	#__NEW_UTS_LEN
 64

	)

17 
	sﬁd_ut¢ame
 {

18 
	msy¢ame
[65];

19 
	mnodíame
[65];

20 
	mªÀa£
[65];

21 
	mvîsi⁄
[65];

22 
	mmachöe
[65];

25 
	s√w_ut¢ame
 {

26 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

27 
	mnodíame
[
__NEW_UTS_LEN
 + 1];

28 
	mªÀa£
[
__NEW_UTS_LEN
 + 1];

29 
	mvîsi⁄
[
__NEW_UTS_LEN
 + 1];

30 
	mmachöe
[
__NEW_UTS_LEN
 + 1];

31 
	mdomaö«me
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/linux/uuid.h

18 #i‚de‡
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<löux/ty≥s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
Ë}})

	)

35 
guid_t
 
	tuuid_À
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 328769

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ (c))

	)

	@/usr/include/linux/wait.h

2 #i‚de‡
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

20 
	#P_PIDFD
 3

	)

	@/usr/include/linux/xattr.h

12 
	~<löux/libc-com∑t.h
>

14 #i‚de‡
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #i‡
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
Ë- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
Ë- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "båfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
Ë- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£curôy."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
Ë- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy°em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
Ë- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "åu°ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
Ë- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
Ë- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£löux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "≠∑rm‹"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ˇ∑bûôy"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_a˛_ac˚ss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_a˛_deÁu…"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #i‚de‡
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_64KB
 (16 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_512KB
 (19 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_1MB
 (20 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_2MB
 (21 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_8MB
 (23 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_16MB
 (24 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_32MB
 (25 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_256MB
 (28 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_512MB
 (29 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_1GB
 (30 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

33 
	#HUGETLB_FLAG_ENCODE_2GB
 (31 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

34 
	#HUGETLB_FLAG_ENCODE_16GB
 (34 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #i‚de‡
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #i‡
deföed
(
__GLIBC__
)

56 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #i‡
deföed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #i‡
deföed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #i‡
deföed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #i‚de‡
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #i‚de‡
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #i‚de‡
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #i‚de‡
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #i‚de‡
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #i‚de‡
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #i‚de‡
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #i‚de‡
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #i‚de‡
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #i‚de‡
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #i‚de‡
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #i‚de‡
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #i‚de‡
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #i‚de‡
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #i‚de‡
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #i‚de‡
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #i‚de‡
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #i‚de‡
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #i‚de‡
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #i‚de‡
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #i‚de‡
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #i‚de‡
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

2 #i‚de‡
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysöfo
 {

9 
__kî√l_l⁄g_t
 
	mu±ime
;

10 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

11 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

12 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

13 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

14 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

15 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

16 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

17 
__u16
 
	m¥ocs
;

18 
__u16
 
	m∑d
;

19 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

20 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

21 
__u32
 
	mmem_unô
;

22 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/linux/time_types.h

2 #i‚de‡
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<löux/ty≥s.h
>

7 
	s__kî√l_time•ec
 {

8 
__kî√l_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__kî√l_ôimî•ec
 {

13 
__kî√l_time•ec
 
	mô_öãrvÆ
;

14 
__kî√l_time•ec
 
	mô_vÆue
;

24 #i‚de‡
__kî√l_ﬁd_timevÆ


25 
	s__kî√l_ﬁd_timevÆ
 {

26 
__kî√l_l⁄g_t
 
	mtv_£c
;

27 
__kî√l_l⁄g_t
 
	mtv_u£c
;

31 
	s__kî√l_sock_timevÆ
 {

32 
__s64
 
	mtv_£c
;

33 
__s64
 
	mtv_u£c
;

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_˛™g_¥îeq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

44 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

47 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

48 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

64 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

68 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


71 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

72 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

74 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

76 #ifde‡
__OPTIMIZE__


77 
__exã∫_Æways_ölöe
 *

78 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


80  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

83 
__exã∫_Æways_ölöe
 const *

84 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


86  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

89 
	}
}

91 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

92 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

95 #ifde‡
__USE_GNU


98 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


99 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

100 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

104 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

105 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

109 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


110 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

111 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

112 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

115 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

122 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

123 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

125 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

126 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

127 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

130 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

131 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

133 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

134 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

137 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

138 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

140 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

141 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

144 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

148 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

149 
__THROW
 
	`__n⁄nuŒ
 ((2));

151 #ifde‡
__USE_XOPEN2K8


153 
	~<bôs/ty≥s/loˇÀ_t.h
>

156 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__l
)

157 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

160 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

161 
loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

164 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

165 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| 
	$__GLIBC_USE
 (
ISOC2X
))

167 *
	$°rdup
 (c⁄° *
__s
)

168 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

174 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| __GLIBC_USE (
ISOC2X
)

175 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

176 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

179 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


181 
	#°rdu∑
(
s
) \

182 (
__exãnsi⁄__
 \

184 c⁄° *
__ﬁd
 = (
s
); \

185 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

186 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

187 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

188 
	}
}))

	)

191 
	#°∫du∑
(
s
, 
n
) \

192 (
__exãnsi⁄__
 \

194 c⁄° *
__ﬁd
 = (
s
); \

195 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

196 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

197 
__√w
[
__Àn
] = '\0'; \

198 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

199 }))

	)

203 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


206 *
°rchr
 (*
__s
, 
__c
)

207 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

208 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

209 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

211 #ifde‡
__OPTIMIZE__


212 
__exã∫_Æways_ölöe
 *

213 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


215  
__buûtö_°rchr
 (
__s
, 
__c
);

218 
__exã∫_Æways_ölöe
 const *

219 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


221  
__buûtö_°rchr
 (
__s
, 
__c
);

226 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

227 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

230 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


233 *
	`°ºchr
 (*
__s
, 
__c
)

234 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

235 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

236 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

238 #ifde‡
__OPTIMIZE__


239 
__exã∫_Æways_ölöe
 *

240 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


242  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

245 
__exã∫_Æways_ölöe
 const *

246 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


248  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

251 
	}
}

253 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

254 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

257 #ifde‡
__USE_GNU


260 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


261 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

262 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

263 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

264 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

266 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

267 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

273 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

274 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

277 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

278 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

280 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


283 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

284 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

285 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

286 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

288 #ifde‡
__OPTIMIZE__


289 
__exã∫_Æways_ölöe
 *

290 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


292  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

295 
__exã∫_Æways_ölöe
 const *

296 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


298  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

301 
	}
}

303 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

304 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

307 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


310 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

311 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

312 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

313 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

315 #ifde‡
__OPTIMIZE__


316 
__exã∫_Æways_ölöe
 *

317 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


319  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

322 
__exã∫_Æways_ölöe
 const *

323 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


325  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

328 
	}
}

330 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

331 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

336 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

337 
__THROW
 
	`__n⁄nuŒ
 ((2));

341 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

342 c⁄° *
__ª°ri˘
 
__dñim
,

343 **
__ª°ri˘
 
__ßve_±r
)

344 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

345 #ifde‡
__USE_POSIX


346 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

347 **
__ª°ri˘
 
__ßve_±r
)

348 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

351 #ifde‡
__USE_GNU


353 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


354 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

355 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

356 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

357 c⁄° *
__√edÀ
)

358 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

360 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

361 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

365 #ifde‡
__USE_GNU


369 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

370 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

371 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

375 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

376 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

377 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

378 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

379 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

380 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

385 
size_t
 
	$°æí
 (c⁄° *
__s
)

386 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

388 #ifdef 
__USE_XOPEN2K8


391 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

392 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

397 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

398 #ifde‡
__USE_XOPEN2K


406 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


409 #ifde‡
__REDIRECT_NTH


410 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

411 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

412 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

414 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

415 
__THROW
 
	`__n⁄nuŒ
 ((2));

416 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

421 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

422 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

426 #ifde‡
__USE_XOPEN2K8


428 *
	$°ªº‹_l
 (
__î∫um
, 
loˇÀ_t
 
__l
Ë
__THROW
;

431 #ifde‡
__USE_MISC


432 
	~<°rögs.h
>

436 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

440 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

441 c⁄° *
__ª°ri˘
 
__dñim
)

442 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

445 #ifdef 
__USE_XOPEN2K8


447 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

450 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

451 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

452 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

453 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

457 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

458 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

459 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

460 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

461 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

462 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

465 #ifdef 
__USE_GNU


467 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

468 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

471 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

474 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

476 #i‚de‡
ba£«me


481 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


482 "C++" *
	$ba£«me
 (*
__fûíame
)

483 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

484 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

485 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

487 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

492 #i‡
	`__GNUC_PREREQ
 (3,4)

493 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


495 
	~<bôs/°rög_f‹tifõd.h
>

499 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #i‚de‡
__Æways_ölöe


5 
	#__Æways_ölöe
 
__ölöe__


	)

	@/usr/include/strings.h

18 #i‚def 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<„©uªs.h
>

22 
	#__√ed_size_t


	)

23 
	~<°ddef.h
>

26 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


34 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

38 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

39 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

42 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

45 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`ödex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

50 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

53 #i‡
deföed
 
__OPTIMIZE__


54 
__exã∫_Æways_ölöe
 *

55 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


57  
	`__buûtö_ödex
 (
__s
, 
__c
);

60 
__exã∫_Æways_ölöe
 const *

61 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


63  
	`__buûtö_ödex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$ödex
 (c⁄° *
__s
, 
__c
)

69 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`rödex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #i‡
deföed
 
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


85  
	`__buûtö_rödex
 (
__s
, 
__c
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


91  
	`__buûtö_rödex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$rödex
 (c⁄° *
__s
, 
__c
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8
 || deföed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
Ë
__THROW
 
__©åibuã_c⁄°__
;

109 #ifdef 
__USE_MISC


110 
	$ff¶
 (
__l
Ë
__THROW
 
__©åibuã_c⁄°__
;

111 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

112 
__THROW
 
__©åibuã_c⁄°__
;

116 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

117 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

120 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<bôs/ty≥s/loˇÀ_t.h
>

128 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__loc
)

129 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

133 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

134 
size_t
 
__n
, 
loˇÀ_t
 
__loc
)

135 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

138 
__END_DECLS


140 #i‡
	`__GNUC_PREREQ
 (3,4Ë&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
deföed
 
__f‹tify_fun˘i⁄


143 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


144 
	~<bôs/°rögs_f‹tifõd.h
>

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

120 #unde‡
__USE_ISOC11


121 #unde‡
__USE_ISOC99


122 #unde‡
__USE_ISOC95


123 #unde‡
__USE_ISOCXX11


124 #unde‡
__USE_POSIX


125 #unde‡
__USE_POSIX2


126 #unde‡
__USE_POSIX199309


127 #unde‡
__USE_POSIX199506


128 #unde‡
__USE_XOPEN


129 #unde‡
__USE_XOPEN_EXTENDED


130 #unde‡
__USE_UNIX98


131 #unde‡
__USE_XOPEN2K


132 #unde‡
__USE_XOPEN2KXSI


133 #unde‡
__USE_XOPEN2K8


134 #unde‡
__USE_XOPEN2K8XSI


135 #unde‡
__USE_LARGEFILE


136 #unde‡
__USE_LARGEFILE64


137 #unde‡
__USE_FILE_OFFSET64


138 #unde‡
__USE_MISC


139 #unde‡
__USE_ATFILE


140 #unde‡
__USE_GNU


141 #unde‡
__USE_FORTIFY_LEVEL


142 #unde‡
__KERNEL_STRICT_NAMES


143 #unde‡
__GLIBC_USE_ISOC2X


144 #unde‡
__GLIBC_USE_DEPRECATED_GETS


145 #unde‡
__GLIBC_USE_DEPRECATED_SCANF


149 #i‚de‡
_LOOSE_KERNEL_NAMES


150 
	#__KERNEL_STRICT_NAMES


	)

160 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


161 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

162 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

164 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

171 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


172 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

173 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

175 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

179 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

185 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

186 && !
deföed
 
	g_DEFAULT_SOURCE


188 #unde‡
_DEFAULT_SOURCE


189 
	#_DEFAULT_SOURCE
 1

	)

193 #ifde‡
_GNU_SOURCE


194 #unde‡
_ISOC95_SOURCE


195 
	#_ISOC95_SOURCE
 1

	)

196 #unde‡
_ISOC99_SOURCE


197 
	#_ISOC99_SOURCE
 1

	)

198 #unde‡
_ISOC11_SOURCE


199 
	#_ISOC11_SOURCE
 1

	)

200 #unde‡
_ISOC2X_SOURCE


201 
	#_ISOC2X_SOURCE
 1

	)

202 #unde‡
_POSIX_SOURCE


203 
	#_POSIX_SOURCE
 1

	)

204 #unde‡
_POSIX_C_SOURCE


205 
	#_POSIX_C_SOURCE
 200809L

	)

206 #unde‡
_XOPEN_SOURCE


207 
	#_XOPEN_SOURCE
 700

	)

208 #unde‡
_XOPEN_SOURCE_EXTENDED


209 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

210 #unde‡
_LARGEFILE64_SOURCE


211 
	#_LARGEFILE64_SOURCE
 1

	)

212 #unde‡
_DEFAULT_SOURCE


213 
	#_DEFAULT_SOURCE
 1

	)

214 #unde‡
_ATFILE_SOURCE


215 
	#_ATFILE_SOURCE
 1

	)

220 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

221 || (!
deföed
 
	g__STRICT_ANSI__
 \

222 && !
deföed
 
	g_ISOC99_SOURCE
 && !deföed 
	g_ISOC11_SOURCE
 \

223 && !
deföed
 
	g_ISOC2X_SOURCE
 \

224 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

225 && !
deföed
 
	g_XOPEN_SOURCE
))

226 #unde‡
_DEFAULT_SOURCE


227 
	#_DEFAULT_SOURCE
 1

	)

231 #i‡(
deföed
 
_ISOC2X_SOURCE
 \

232 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

233 
	#__GLIBC_USE_ISOC2X
 1

	)

235 
	#__GLIBC_USE_ISOC2X
 0

	)

239 #i‡(
deföed
 
_ISOC11_SOURCE
 || deföed 
_ISOC2X_SOURCE
 \

240 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

241 
	#__USE_ISOC11
 1

	)

245 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

246 || 
deföed
 
_ISOC2X_SOURCE
 \

247 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

248 
	#__USE_ISOC99
 1

	)

252 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

253 || 
deföed
 
_ISOC2X_SOURCE
 \

254 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

255 
	#__USE_ISOC95
 1

	)

258 #ifde‡
__˝lu•lus


260 #i‡
__˝lu•lus
 >= 201703L

261 
	#__USE_ISOC11
 1

	)

265 #i‡
__˝lu•lus
 >201103L || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__


266 
	#__USE_ISOCXX11
 1

	)

267 
	#__USE_ISOC99
 1

	)

274 #ifde‡
_DEFAULT_SOURCE


275 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


276 
	#__USE_POSIX_IMPLICITLY
 1

	)

278 #unde‡
_POSIX_SOURCE


279 
	#_POSIX_SOURCE
 1

	)

280 #unde‡
_POSIX_C_SOURCE


281 
	#_POSIX_C_SOURCE
 200809L

	)

284 #i‡((!
deföed
 
__STRICT_ANSI__
 \

285 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

286 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

287 
	#_POSIX_SOURCE
 1

	)

288 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

289 
	#_POSIX_C_SOURCE
 2

	)

290 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

291 
	#_POSIX_C_SOURCE
 199506L

	)

292 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

293 
	#_POSIX_C_SOURCE
 200112L

	)

295 
	#_POSIX_C_SOURCE
 200809L

	)

297 
	#__USE_POSIX_IMPLICITLY
 1

	)

306 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

307 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

308 
	#_POSIX_SOURCE
 1

	)

309 #unde‡
_POSIX_C_SOURCE


310 
	#_POSIX_C_SOURCE
 199506L

	)

313 #i‡(
deföed
 
_POSIX_SOURCE
 \

314 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

315 || 
deföed
 
_XOPEN_SOURCE
)

316 
	#__USE_POSIX
 1

	)

319 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


320 
	#__USE_POSIX2
 1

	)

323 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

324 
	#__USE_POSIX199309
 1

	)

327 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

328 
	#__USE_POSIX199506
 1

	)

331 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

332 
	#__USE_XOPEN2K
 1

	)

333 #unde‡
__USE_ISOC95


334 
	#__USE_ISOC95
 1

	)

335 #unde‡
__USE_ISOC99


336 
	#__USE_ISOC99
 1

	)

339 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

340 
	#__USE_XOPEN2K8
 1

	)

341 #unde‡
_ATFILE_SOURCE


342 
	#_ATFILE_SOURCE
 1

	)

345 #ifdef 
_XOPEN_SOURCE


346 
	#__USE_XOPEN
 1

	)

347 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

348 
	#__USE_XOPEN_EXTENDED
 1

	)

349 
	#__USE_UNIX98
 1

	)

350 #unde‡
_LARGEFILE_SOURCE


351 
	#_LARGEFILE_SOURCE
 1

	)

352 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

353 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

354 
	#__USE_XOPEN2K8
 1

	)

355 
	#__USE_XOPEN2K8XSI
 1

	)

357 
	#__USE_XOPEN2K
 1

	)

358 
	#__USE_XOPEN2KXSI
 1

	)

359 #unde‡
__USE_ISOC95


360 
	#__USE_ISOC95
 1

	)

361 #unde‡
__USE_ISOC99


362 
	#__USE_ISOC99
 1

	)

365 #ifde‡
_XOPEN_SOURCE_EXTENDED


366 
	#__USE_XOPEN_EXTENDED
 1

	)

371 #ifde‡
_LARGEFILE_SOURCE


372 
	#__USE_LARGEFILE
 1

	)

375 #ifde‡
_LARGEFILE64_SOURCE


376 
	#__USE_LARGEFILE64
 1

	)

379 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

380 
	#__USE_FILE_OFFSET64
 1

	)

383 #i‡
deföed
 
_DEFAULT_SOURCE


384 
	#__USE_MISC
 1

	)

387 #ifdef 
_ATFILE_SOURCE


388 
	#__USE_ATFILE
 1

	)

391 #ifdef 
_GNU_SOURCE


392 
	#__USE_GNU
 1

	)

395 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

396 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

397 #i‡
_FORTIFY_SOURCE
 > 1

398 
	#__USE_FORTIFY_LEVEL
 2

	)

400 
	#__USE_FORTIFY_LEVEL
 1

	)

403 
	#__USE_FORTIFY_LEVEL
 0

	)

410 #i‡
deföed
 
__˝lu•lus
 ? __˝lu•lu†>201402L : deföed 
__USE_ISOC11


411 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

413 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

428 #i‡(
deföed
 
__USE_GNU
 \

429 && (
deföed
 
	g__˝lu•lus
 \

430 ? (
	g__˝lu•lus
 < 201103L && !
deföed
 
	g__GXX_EXPERIMENTAL_CXX0X__
) \

431 : (!
deföed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

432 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

434 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

439 
	~<°dc-¥edef.h
>

447 #unde‡
__GNU_LIBRARY__


448 
	#__GNU_LIBRARY__
 6

	)

452 
	#__GLIBC__
 2

	)

453 
	#__GLIBC_MINOR__
 31

	)

455 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

456 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

459 #i‚de‡
__ASSEMBLER__


460 #i‚de‡
_SYS_CDEFS_H


461 
	~<sys/cdefs.h
>

466 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


467 
	#__USE_LARGEFILE
 1

	)

468 
	#__USE_LARGEFILE64
 1

	)

474 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

475 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

476 && 
deföed
 
	g__exã∫_ölöe


477 
	#__USE_EXTERN_INLINES
 1

	)

485 
	~<gnu/°ubs.h
>

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
84
1601
acl.c
acl.h
balloc.c
bitmap.c
block_validity.c
dir.c
ext4.h
ext4_extents.h
ext4_jbd2.c
ext4_jbd2.h
extents.c
extents_status.c
extents_status.h
file.c
fsmap.c
fsmap.h
fsync.c
hash.c
ialloc.c
indirect.c
inline.c
inode.c
ioctl.c
mballoc.c
mballoc.h
migrate.c
mmp.c
move_extent.c
namei.c
page-io.c
readpage.c
resize.c
super.c
symlink.c
sysfs.c
truncate.h
verity.c
xattr.c
xattr.h
xattr_security.c
xattr_trusted.c
xattr_user.c
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/falloc.h
/usr/include/linux/fcntl.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fscrypt.h
/usr/include/linux/fsmap.h
/usr/include/linux/fsverity.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/utsname.h
/usr/include/linux/uuid.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/linux/time_types.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/stdc-predef.h
